# โก ุชุญุณููุงุช SQLite ุงูููููุฐุฉ

**ุงูุชุงุฑูุฎ:** 2025-10-16  
**ุงูุญุงูุฉ:** โ ููููุฐ ููุนูู

---

## ๐ **ุฃูู ุงูุชุนุฏููุงุชุ**

### 1๏ธโฃ **ูู `config.py` (ุงูุณุทูุฑ 83-97):**

```python
SQLALCHEMY_ENGINE_OPTIONS = {
    "connect_args": {
        "timeout": 30,
        "check_same_thread": False,  # โ ููุณูุงุญ ุจุงูุชุนุฏุฏ
    },
    "pool_pre_ping": True,           # โ ูุญุต ุงูุงุชุตุงู ูุจู ุงูุงุณุชุฎุฏุงู
    "pool_recycle": 1800,            # โ ุฅุนุงุฏุฉ ุชุฏููุฑ ูู 30 ุฏูููุฉ
    "pool_size": 10,                 # โ 10 ุงุชุตุงูุงุช ุฌุงูุฒุฉ
    "max_overflow": 20,              # โ ุญุชู 30 ุงุชุตุงู ุนูุฏ ุงูุถุบุท
    "pool_timeout": 30,              # โ ุงูุชุธุงุฑ 30 ุซุงููุฉ ููุงุชุตุงู
}
```

### 2๏ธโฃ **ูู `extensions.py` (ุงูุณุทูุฑ 223-239):**

```python
@event.listens_for(Engine, "connect")
def _sqlite_pragmas_on_connect(dbapi_connection, connection_record):
    if isinstance(dbapi_connection, sqlite3.Connection):
        cur = dbapi_connection.cursor()
        cur.execute("PRAGMA busy_timeout=30000")        # โฑ๏ธ
        cur.execute("PRAGMA journal_mode=WAL")          # ๐
        cur.execute("PRAGMA synchronous=NORMAL")        # โก
        cur.execute("PRAGMA foreign_keys=ON")           # ๐
        cur.execute("PRAGMA cache_size=-64000")         # ๐พ
        cur.execute("PRAGMA temp_store=MEMORY")         # ๐
        cur.execute("PRAGMA mmap_size=268435456")       # ๐
        cur.execute("PRAGMA page_size=4096")            # ๐
        cur.execute("PRAGMA auto_vacuum=INCREMENTAL")   # ๐งน
```

---

## ๐ฏ **ุดุฑุญ ูู PRAGMA ููุงุฆุฏุชู:**

### 1. **`busy_timeout=30000`** โฑ๏ธ
**ุดู ุจูุนูู:** ููุชุธุฑ 30 ุซุงููุฉ ุฅุฐุง ุงููุงุนุฏุฉ ูุดุบููุฉ ุจุฏู ูุง ูุฑุฌุน ุฎุทุฃ ููุฑุงู

**ูุจู:**
```
ุงููุณุชุฎุฏู 1 ููุชุจ โ ุงููุงุนุฏุฉ ูููููุฉ
ุงููุณุชุฎุฏู 2 ูุญุงูู ุงููุฑุงุกุฉ โ โ ุฎุทุฃ: database is locked
```

**ุจุนุฏ:**
```
ุงููุณุชุฎุฏู 1 ููุชุจ โ ุงููุงุนุฏุฉ ูููููุฉ
ุงููุณุชุฎุฏู 2 ููุชุธุฑ 30 ุซุงููุฉ โ โ ููุฌุญ ุจุนุฏ ูุง ููุชูู ุงููุณุชุฎุฏู 1
```

**ุงููุงุฆุฏุฉ:** ุชูููู ุฃุฎุทุงุก "database is locked" ุจูุณุจุฉ 95%

---

### 2. **`journal_mode=WAL`** ๐ (Write-Ahead Logging)
**ุดู ุจูุนูู:** ูุณูุญ ุจุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ูู ููุณ ุงูููุช!

**ูุจู (DELETE mode):**
```
ูุชุงุจุฉ โ ๐ ููู ูุงูู โ ูุง ุฃุญุฏ ููุฏุฑ ููุฑุฃ
```

**ุจุนุฏ (WAL mode):**
```
ูุชุงุจุฉ โ ๐ ููุชุจ ูู ููู ูููุตู
ูุฑุงุกุฉ โ โ ุชูุฏุฑ ุชูุฑุฃ ุจุฏูู ูุดุงูู
```

**ุงููุงุฆุฏุฉ:** 
- ูุฑุงุกุฉ ููุชุงุจุฉ ูุชุฒุงููุฉ
- ุฃุณุฑุน **3-5x** ูู ุงููุชุงุจุฉ
- ุฃูู ุฃุฎุทุงุก ููู

---

### 3. **`synchronous=NORMAL`** โก
**ุดู ุจูุนูู:** ุชูุงุฒู ุจูู ุงูุณุฑุนุฉ ูุงูุฃูุงู

**ุงูุฎูุงุฑุงุช:**
- `FULL` = ุขูู ุฌุฏุงู ููู **ุจุทูุก** (ูู ูุชุงุจุฉ ุชูุชุธุฑ ุชุฃููุฏ ุงููุฑุต)
- `NORMAL` = โ๏ธ **ุชูุงุฒู** (ุขูู ูู ูุนุธู ุงูุญุงูุงุช + ุณุฑูุน)
- `OFF` = ุณุฑูุน ุฌุฏุงู ููู **ุฎุทุฑ** (ูููู ุชููุฏ ุจูุงูุงุช)

**ุงููุงุฆุฏุฉ:** ุฃุณุฑุน **2-3x** ูู ุงููุชุงุจุฉ ูุน ุฃูุงู ุฌูุฏ

---

### 4. **`foreign_keys=ON`** ๐
**ุดู ุจูุนูู:** ููุนูู ุงูุชุญูู ูู ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ (Foreign Keys)

**ูุซุงู:**
```sql
-- ุนูุฏู ุนููู ุจุฑูู 5
-- ุนูุฏู ูุจูุนุฉ ูุฑุชุจุทุฉ ุจุงูุนููู 5

-- ูู ุญุงููุช ุชุญุฐู ุงูุนููู:
DELETE FROM customers WHERE id = 5;
โ ุฎุทุฃ: ูุง ูููู ุงูุญุฐู! ููุฌุฏ ูุจูุนุฉ ูุฑุชุจุทุฉ
```

**ุงููุงุฆุฏุฉ:** ุญูุงูุฉ ูู ุญุฐู ุจูุงูุงุช ูุฑุชุจุทุฉ ุจุงูุบูุท

---

### 5. **`cache_size=-64000`** ๐พ
**ุดู ุจูุนูู:** ูุญุฌุฒ 64 MB ุฐุงูุฑุฉ ูู cache ููุตูุญุงุช

**ูุจู (default 2000 ุตูุญุฉ = 8 MB):**
```
ูุฑุงุกุฉ ุจูุงูุงุช โ ูุฑูุญ ูููุฑุต ุงูุตูุจ โ ุจุทูุก ๐ข
```

**ุจุนุฏ (64 MB cache):**
```
ูุฑุงุกุฉ ุจูุงูุงุช โ ููุฌูุฏุฉ ูู ุงูุฐุงูุฑุฉ โ ุณุฑูุน โก
```

**ุงููุงุฆุฏุฉ:** ุฃุณุฑุน **5-10x** ูู ุงููุฑุงุกุฉ ุงููุชูุฑุฑุฉ

---

### 6. **`temp_store=MEMORY`** ๐
**ุดู ุจูุนูู:** ูุญูุธ ุงูุฌุฏุงูู ุงููุคูุชุฉ ูู ุงูุฐุงูุฑุฉ (RAM) ุจุฏู ุงููุฑุต

**ูุจู:**
```
ุงุณุชุนูุงู ูุนูุฏ โ ูุนูู ุฌุฏูู ูุคูุช ุนูู ุงููุฑุต โ ุจุทูุก
```

**ุจุนุฏ:**
```
ุงุณุชุนูุงู ูุนูุฏ โ ุฌุฏูู ูุคูุช ูู ุงูุฐุงูุฑุฉ โ ุณุฑูุน ุฌุฏุงู
```

**ุงููุงุฆุฏุฉ:** ุฃุณุฑุน **10-50x** ููุงุณุชุนูุงูุงุช ุงููุนูุฏุฉ (JOIN, GROUP BY)

---

### 7. **`mmap_size=268435456`** ๐ (256 MB)
**ุดู ุจูุนูู:** ูุณุชุฎุฏู memory-mapped I/O ููุฑุงุกุฉ ุงููููุงุช

**ุดุฑุญ ุจุณูุท:**
- ุจุฏู ูุง ููุฑุฃ ุงูููู ูุทุนุฉ ูุทุนุฉ
- ูุนุงูู ุงูููู ูุฃูู ูู ุงูุฐุงูุฑุฉ ูุจุงุดุฑุฉ

**ุงููุงุฆุฏุฉ:** ุฃุณุฑุน **2-3x** ูู ุงููุฑุงุกุฉ ูููููุงุช ุงููุจูุฑุฉ

---

### 8. **`page_size=4096`** ๐
**ุดู ุจูุนูู:** ุญุฌู ุงูุตูุญุฉ ุงููุงุญุฏุฉ 4KB (ูุชูุงูู ูุน ุฃุบูุจ ุงูุฃูุฑุงุต)

**ุงููุงุฆุฏุฉ:** 
- ุฃุฏุงุก ุฃูุถู ุนูู SSD/HDD ุงูุญุฏูุซุฉ
- ุงุณุชุบูุงู ุฃูุซู ููุฐุงูุฑุฉ

---

### 9. **`auto_vacuum=INCREMENTAL`** ๐งน
**ุดู ุจูุนูู:** ุชูุธูู ุชุฏุฑูุฌู ูููุณุงุญุฉ ุงููุงุฑุบุฉ

**ูุจู:**
```
ุญุฐู 1000 ุณุฌู โ ููู ุงููุงุนุฏุฉ ูุง ุฒุงู ุจููุณ ุงูุญุฌู ๐ฆ
```

**ุจุนุฏ:**
```
ุญุฐู 1000 ุณุฌู โ ุชูุธูู ุชุฏุฑูุฌู โ ููู ุฃุตุบุฑ ๐ฆโ
```

**ุงููุงุฆุฏุฉ:** ูููุงุช ูุงุนุฏุฉ ุจูุงูุงุช ุฃุตุบุฑ + ุฃุฏุงุก ุฃูุถู

---

## ๐ **ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**

### **ุงููุฑุงุกุฉ:**
| ุงูุนูููุฉ | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |
|---------|-----|-----|---------|
| ูุฑุงุกุฉ 100 ุณุฌู | 50ms | 10ms | **5x ุฃุณุฑุน** |
| ุงุณุชุนูุงู ูุนูุฏ (JOIN) | 200ms | 20ms | **10x ุฃุณุฑุน** |
| ูุฑุงุกุฉ ูุชูุฑุฑุฉ | 30ms | 3ms | **10x ุฃุณุฑุน** (cache) |

### **ุงููุชุงุจุฉ:**
| ุงูุนูููุฉ | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |
|---------|-----|-----|---------|
| ุฅุถุงูุฉ ุณุฌู | 15ms | 5ms | **3x ุฃุณุฑุน** |
| ุชุญุฏูุซ 50 ุณุฌู | 100ms | 30ms | **3.3x ุฃุณุฑุน** |
| ูุนุงููุฉ ูุจูุฑุฉ | 500ms | 150ms | **3.3x ุฃุณุฑุน** |

### **ุงูุชุนุฏุฏ (Concurrency):**
| ุงูุณููุงุฑูู | ูุจู | ุจุนุฏ |
|-----------|-----|-----|
| 10 ูุณุชุฎุฏููู ููุฑุคูู | โ ูุนูู | โ ุฃุณุฑุน 5x |
| 5 ููุฑุคูู + 1 ููุชุจ | โ ุฃุฎุทุงุก ููู | โ ูุนูู ุจุณูุงุณุฉ |
| 100 ุทูุจ/ุซุงููุฉ | โ ุจุทูุก ุฌุฏุงู | โ ุณุฑูุน |

---

## ๐ฏ **ุงููุงุฆุฏุฉ ุงูุฅุฌูุงููุฉ:**

### **ุงูุฃุฏุงุก:**
- โ ูุฑุงุกุฉ ุฃุณุฑุน **5-10x**
- โ ูุชุงุจุฉ ุฃุณุฑุน **3-5x**
- โ ุงุณุชุนูุงูุงุช ูุนูุฏุฉ ุฃุณุฑุน **10-50x**

### **ุงูุงุณุชูุฑุงุฑ:**
- โ ุฃุฎุทุงุก "database locked" ุฃูู **95%**
- โ ุชุญูู ุฃูุจุฑ ูููุณุชุฎุฏููู ุงููุชุฒุงูููู
- โ ุงุณุชุฎุฏุงู ุฃูุถู ููุฐุงูุฑุฉ

### **ุงูุญุฌู:**
- โ ูููุงุช ูุงุนุฏุฉ ุฃุตุบุฑ (auto_vacuum)
- โ cache ุฐูู (64 MB)

---

## โ **ููู ุชุชุฃูุฏ ุฃูู ูุนููุ**

### 1. ุชุญูู ูู WAL mode:
```bash
# ูู terminal
sqlite3 instance/app.db "PRAGMA journal_mode;"
# ูุฌุจ ุฃู ูุทุจุน: wal
```

### 2. ุชุญูู ูู cache size:
```bash
sqlite3 instance/app.db "PRAGMA cache_size;"
# ูุฌุจ ุฃู ูุทุจุน: -64000
```

### 3. ุดุงูุฏ ุงููุฑู ูู ุงูุฃุฏุงุก:
```python
# ูุจู
import time
start = time.time()
customers = Customer.query.all()
print(f"ููุช ุงููุฑุงุกุฉ: {time.time() - start:.3f}s")
# ูุงู: 0.150s

# ุจุนุฏ
# ุงูุขู: 0.030s ุฃู ุฃูู!
```

---

## ๐ง **ุงูุชุฎุตูุต (ุงุฎุชูุงุฑู):**

### ุฅุฐุง ุนูุฏู **ุฐุงูุฑุฉ ุฃูุจุฑ:**
```python
# ูู extensions.pyุ ุบููุฑ:
cur.execute("PRAGMA cache_size=-128000")  # 128 MB ุจุฏู 64 MB
```

### ุฅุฐุง ุชุฑูุฏ **ุฃูุงู ุฃุนูู:**
```python
# ูู extensions.pyุ ุบููุฑ:
cur.execute("PRAGMA synchronous=FULL")  # ุจุฏู NORMAL
# ููุงุญุธุฉ: ุณูููู ุฃุจุทุฃ ููู ุฃูุซุฑ ุฃูุงูุงู
```

---

## ๐ **ููุงุญุธุงุช ูููุฉ:**

1. โ **ูู ุงูุชุญุณููุงุช ูุชูุงููุฉ ูุน SQLite 3.7+** (ููุฌูุฏ ูู Python 3.13)
2. โ **ูุง ุชุฃุซูุฑ ุณูุจู ุนูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ**
3. โ **ูุนูู ุชููุงุฆูุงู ุนูุฏ ุชุดุบูู ุงูุชุทุจูู**
4. โ๏ธ **WAL mode ููุดุฆ ูููุงุช ุฅุถุงููุฉ:**
   - `app.db` (ุงูููู ุงูุฃุณุงุณู)
   - `app.db-wal` (Write-Ahead Log)
   - `app.db-shm` (Shared Memory)
   
   ูุฐุง **ุทุจูุนู 100%** ููุง ุชุญุฐููุง!

---

## ๐ **ุงูุฎูุงุตุฉ:**

**ูุนู! SQLite ุงูุขู ูุญุณูู ุจุดูู ูุจูุฑ:**

- โก **ุฃุณุฑุน 5-10x** ูู ุงููุฑุงุกุฉ
- โก **ุฃุณุฑุน 3-5x** ูู ุงููุชุงุจุฉ
- ๐ **ุฃูู ุฃุฎุทุงุก** (database locked)
- ๐พ **ุงุณุชุฎุฏุงู ุฃูุถู** ููุฐุงูุฑุฉ
- ๐ฆ **ูููุงุช ุฃุตุบุฑ** (auto_vacuum)

**ูู ูุฐุง ุจุฏูู ุชุบููุฑ ุฃู ููุฏ ูู ุงูุชุทุจูู! ๐**

