"""
ðŸ’¬ AI Conversation Manager - Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ÙˆØ¸ÙŠÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù:
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ­Ø§Ø¯Ø«ÙŠØ© (Conversation Memory)
- ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚ (Context Tracking)
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Session Management)
- Ø§Ù„Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ (Local Smart Responses)

Refactored: 2025-11-01
"""

from datetime import datetime
from typing import Dict, List, Any, Optional
import json
import os


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ§  CONVERSATION MEMORY - Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ­Ø§Ø¯Ø«ÙŠØ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_conversation_memory = {}


def get_or_create_session_memory(session_id: str) -> Dict[str, Any]:
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡Ù‡Ø§
    
    Args:
        session_id: Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø© (Ù…Ø«Ù„: user_123)
    
    Returns:
        Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    """
    global _conversation_memory
    
    if session_id not in _conversation_memory:
        _conversation_memory[session_id] = {
            'session_id': session_id,
            'created_at': datetime.now().isoformat(),
            'messages': [],
            'context': {},
            'last_entities': []
        }
    
    return _conversation_memory[session_id]


def add_to_memory(session_id: str, role: str, content: str):
    """
    Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø°Ø§ÙƒØ±Ø©
    
    Args:
        session_id: Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©
        role: 'user' Ø£Ùˆ 'assistant'
        content: Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    """
    memory = get_or_create_session_memory(session_id)
    
    memory['messages'].append({
        'role': role,
        'content': content,
        'timestamp': datetime.now().isoformat()
    })
    
    # Ø­ÙØ¸ Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· (ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©)
    if len(memory['messages']) > 50:
        memory['messages'] = memory['messages'][-50:]


def clear_session_memory(session_id: str):
    """Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø¬Ù„Ø³Ø© Ù…Ø¹ÙŠÙ†Ø©"""
    global _conversation_memory
    
    if session_id in _conversation_memory:
        del _conversation_memory[session_id]


def get_conversation_context(session_id: str) -> Dict[str, Any]:
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    
    Returns:
        {
            'last_topic': 'customers',
            'last_entities': ['customer_123'],
            'message_count': 10
        }
    """
    memory = get_or_create_session_memory(session_id)
    
    return {
        'message_count': len(memory['messages']),
        'last_entities': memory.get('last_entities', []),
        'context': memory.get('context', {})
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸŽ¯ LOCAL SMART RESPONSES - Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_local_faq_responses() -> Dict[str, str]:
    """
    Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© - Ø±Ø¯ÙˆØ¯ ÙÙˆØ±ÙŠØ© Ù…Ø­Ù„ÙŠØ© Ø¨Ø¯ÙˆÙ† AI
    
    Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ„Ø§ ØªØ­ØªØ§Ø¬ Groq API
    """
    return {
        'Ù…Ù† Ø£Ù†Øª': """ðŸ¤– Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„Ù…Ø­ØªØ±Ù ÙÙŠ Ù†Ø¸Ø§Ù… Ø£Ø²Ø§Ø¯.

ðŸ“Œ Ù‚Ø¯Ø±Ø§ØªÙŠ:
â€¢ Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (87 Ø¬Ø¯ÙˆÙ„)
â€¢ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø§Ù„ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© (VATØŒ Ø¶Ø±Ø§Ø¦Ø¨ØŒ Ø¹Ù…Ù„Ø§Øª)
â€¢ Ù…Ø¹Ø±ÙØ© Ø´Ø§Ù…Ù„Ø© Ø¨Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ø¹Ø§Ù… (GL)
â€¢ ØªØ­Ù„ÙŠÙ„ Ø¹Ù…ÙŠÙ‚ Ù„Ø£ÙŠ Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
â€¢ Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (ÙÙ„Ø³Ø·ÙŠÙ† + Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„)

ðŸ¢ Ø§Ù„Ù†Ø¸Ø§Ù…:
â€¢ Ø§Ù„Ø´Ø±ÙƒØ©: Ø£Ø²Ø§Ø¯ Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø°ÙƒÙŠØ©
â€¢ Ø§Ù„Ù…Ø·ÙˆØ±: Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø£Ø­Ù…Ø¯ ØºÙ†Ø§Ù…
â€¢ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† ðŸ‡µðŸ‡¸""",
        
        'Ù…Ø§ Ù‚Ø¯Ø±Ø§ØªÙƒ': """ðŸ§  Ù‚Ø¯Ø±Ø§ØªÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙƒÙ…Ø­Ø§Ø³Ø¨ Ù…Ø­ØªØ±Ù:

1. ðŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ:
   â€¢ Ø´Ø±Ø­ Ø£ÙŠ Ø±Ù‚Ù… Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ù…Ù† Ø£ÙŠÙ†ØŸ ÙƒÙŠÙØŸ Ù„Ù…Ø§Ø°Ø§ØŸ)
   â€¢ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ù†Ù‡Ø§ÙŠØ©
   â€¢ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© (GL Entries)
   â€¢ ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©

2. ðŸ’° Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:
   â€¢ Ø­Ø³Ø§Ø¨ VAT (16% ÙÙ„Ø³Ø·ÙŠÙ† / 17% Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„)
   â€¢ Ø­Ø³Ø§Ø¨ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ø®Ù„
   â€¢ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
   â€¢ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±

3. ðŸ“ˆ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©:
   â€¢ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ (Income Statement)
   â€¢ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ© (Balance Sheet)
   â€¢ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
   â€¢ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Trial Balance)

4. ðŸ” Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ:
   â€¢ ÙØ­Øµ ØªÙˆØ§Ø²Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯
   â€¢ ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
   â€¢ Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª

5. ðŸ§­ Ø§Ù„ØªÙ†Ù‚Ù„:
   â€¢ Ù…Ø¹Ø±ÙØ© ÙƒÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (197 ØµÙØ­Ø©)
   â€¢ ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙˆØ­Ø¯Ø§Øª""",
        
        'ÙƒÙŠÙ Ø£Ø¶ÙŠÙ Ø¹Ù…ÙŠÙ„': """ðŸ“ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:

1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: `/customers/add`
2. Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
   â€¢ Ø§Ù„Ø§Ø³Ù…
   â€¢ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
   â€¢ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
   â€¢ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
3. Ø§Ø¶ØºØ· Ø­ÙØ¸

ðŸ”— Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: /customers/add""",
        
        'Ø§Ø´Ø±Ø­ Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„': """ðŸ“Š **Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ÙƒØ§Ù…Ù„:**

ðŸ§® **Ø§Ù„ØµÙŠØºØ©:**
Ø§Ù„Ø±ØµÙŠØ¯ = (Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª + Ø§Ù„ÙÙˆØ§ØªÙŠØ± + Ø§Ù„Ø®Ø¯Ù…Ø§Øª) - (Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© IN)

ðŸ“ **Ø§Ù„Ù…Ø¹Ù†Ù‰:**
â€¢ Ø±ØµÙŠØ¯ Ø³Ø§Ù„Ø¨ (-) = ðŸ”´ Ø£Ø­Ù…Ø± = Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„ÙŠÙ‡ ÙŠØ¯ÙØ¹
â€¢ Ø±ØµÙŠØ¯ Ù…ÙˆØ¬Ø¨ (+) = ðŸŸ¢ Ø£Ø®Ø¶Ø± = Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø±ØµÙŠØ¯ Ø¹Ù†Ø¯Ù†Ø§ (Ø¯ÙØ¹ Ø²ÙŠØ§Ø¯Ø©)
â€¢ Ø±ØµÙŠØ¯ ØµÙØ± (0) = âšª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„

ðŸ’¡ **Ù…Ø«Ø§Ù„:**
Ø¹Ù…ÙŠÙ„ Ø§Ø´ØªØ±Ù‰ Ø¨Ù€ 1000 â‚ª ÙˆØ¯ÙØ¹ 600 â‚ª
Ø§Ù„Ø±ØµÙŠØ¯ = (1000) - (600) = -400 â‚ª
Ø§Ù„Ù…Ø¹Ù†Ù‰: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø³Ù‡ Ø¹Ù„ÙŠÙ‡ 400 â‚ª

ðŸ“Š **Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©:**
â€¢ Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹: Ù…Ø¯ÙŠÙ† AR (ÙŠØ²ÙŠØ¯ Ø§Ù„Ø¯ÙŠÙ†)
â€¢ Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹: Ø¯Ø§Ø¦Ù† AR (ÙŠÙ†Ù‚Øµ Ø§Ù„Ø¯ÙŠÙ†)""",
        
        'ÙƒÙŠÙ Ø£Ø­Ø³Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©': """ðŸ§¾ **Ø­Ø³Ø§Ø¨ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©:**

ðŸ‡µðŸ‡¸ **ÙÙ„Ø³Ø·ÙŠÙ† (16%):**
â€¢ Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©:
  Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© = Ø§Ù„Ù…Ø¨Ù„Øº Ã— 0.16
  Ù…Ø«Ø§Ù„: 1000 Ã— 0.16 = 160 â‚ª

â€¢ Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:
  Ø§Ù„ØµØ§ÙÙŠ = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ã· 1.16
  Ù…Ø«Ø§Ù„: 1160 Ã· 1.16 = 1000 â‚ª

ðŸ‡®ðŸ‡± **Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„ (17%):**
â€¢ Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©: Ø§Ù„Ù…Ø¨Ù„Øº Ã— 0.17
â€¢ Ø´Ø§Ù…Ù„: Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ã· 1.17

ðŸ“Š **Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ:**
Ù…Ø¯ÙŠÙ†: AR (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ)
Ø¯Ø§Ø¦Ù†: SALES (Ø§Ù„ØµØ§ÙÙŠ)
Ø¯Ø§Ø¦Ù†: VAT_PAYABLE (Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"""
    }


def get_local_quick_answers() -> Dict[str, Any]:
    """
    Ø¥Ø¬Ø§Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ø£Ø³Ø¦Ù„Ø© Ø´Ø§Ø¦Ø¹Ø©
    
    ØªÙØ³ØªØ®Ø¯Ù… Ù„Ù„Ø±Ø¯ Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù€ Groq
    """
    return {
        'greetings': {
            'patterns': ['Ù…Ø±Ø­Ø¨Ø§', 'Ù‡Ù„Ø§', 'Ø§Ù„Ø³Ù„Ø§Ù…', 'ØµØ¨Ø§Ø­', 'Ù…Ø³Ø§Ø¡', 'hello', 'hi'],
            'responses': [
                'ðŸ¤– Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„Ù…Ø­ØªØ±Ù. ÙƒÙŠÙ Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ',
                'ðŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø£Ùˆ Ù…Ø§Ù„ÙŠ.',
                'ðŸŒŸ Ø­ÙŠØ§Ùƒ Ø§Ù„Ù„Ù‡! Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….'
            ]
        },
        
        'thanks': {
            'patterns': ['Ø´ÙƒØ±Ø§', 'Ù…Ø´ÙƒÙˆØ±', 'thanks', 'thank you'],
            'responses': [
                'ðŸ˜Š Ø§Ù„Ø¹ÙÙˆ! Ø³Ø¹ÙŠØ¯ Ø¨Ø®Ø¯Ù…ØªÙƒ.',
                'ðŸ™ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø­Ø¨ ÙˆØ§Ù„Ø³Ø¹Ø©!',
                'âœ¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©!'
            ]
        },
        
        'help': {
            'patterns': ['Ù…Ø³Ø§Ø¹Ø¯Ø©', 'help', 'Ø³Ø§Ø¹Ø¯Ù†ÙŠ'],
            'responses': [
                """ðŸ¤ **ÙƒÙŠÙ Ø£Ø³Ø§Ø¹Ø¯ÙƒØŸ**

ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:
â€¢ Ø´Ø±Ø­ Ø£ÙŠ Ø±Ù‚Ù… Ø£Ùˆ Ø±ØµÙŠØ¯
â€¢ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
â€¢ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
â€¢ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©
â€¢ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ
â€¢ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù…

Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡! ðŸ’¬"""
            ]
        }
    }


def match_local_response(message: str) -> Optional[str]:
    """
    Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø±Ø¯ Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹
    
    Args:
        message: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    
    Returns:
        Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£Ùˆ None
    """
    message_lower = message.lower().strip()
    
    # 1. Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© (FAQ)
    faqs = get_local_faq_responses()
    for question, answer in faqs.items():
        if question.lower() in message_lower:
            return answer
    
    # 2. Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    quick = get_local_quick_answers()
    
    import random
    
    for category, data in quick.items():
        patterns = data['patterns']
        for pattern in patterns:
            if pattern in message_lower:
                return random.choice(data['responses'])
    
    return None


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“Š CONVERSATION ANALYTICS - ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_conversation_stats() -> Dict[str, Any]:
    """Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª"""
    global _conversation_memory
    
    total_sessions = len(_conversation_memory)
    total_messages = sum(
        len(session['messages'])
        for session in _conversation_memory.values()
    )
    
    return {
        'total_sessions': total_sessions,
        'total_messages': total_messages,
        'active_sessions': total_sessions
    }


__all__ = [
    'get_or_create_session_memory',
    'add_to_memory',
    'clear_session_memory',
    'get_conversation_context',
    'get_local_faq_responses',
    'match_local_response',
    'get_conversation_stats'
]

