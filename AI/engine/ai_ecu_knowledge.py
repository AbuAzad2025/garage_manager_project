"""
AI ECU Knowledge - معرفة كمبيوترات المعدات
ECU، OBD، التشخيص الإلكتروني
"""

# ====================================================================
# كمبيوترات السيارات ECU
# ====================================================================

ECU_KNOWLEDGE = {
    'basics': {
        'name': 'ECU - وحدة التحكم الإلكترونية',
        'full_name': 'Engine Control Unit',
        'function': 'الكمبيوتر الرئيسي الذي يتحكم في المحرك',
        'what_it_controls': [
            'كمية الوقود المحقون',
            'توقيت الاشتعال',
            'نسبة الهواء/الوقود (AFR)',
            'سرعة الدوران الخاملة (Idle)',
            'مروحة التبريد',
            'ناقل الحركة (في بعض السيارات)'
        ],
        'inputs': [
            'حساس الأكسجين (O2 Sensor)',
            'حساس موضع عمود الكرنك (CKP)',
            'حساس موضع عمود الكامات (CMP)',
            'حساس درجة حرارة المحرك (ECT)',
            'حساس تدفق الهواء (MAF/MAP)',
            'حساس موضع الثروتل (TPS)'
        ],
        'outputs': [
            'البخاخات (Injectors)',
            'الكويلات (Ignition Coils)',
            'مروحة التبريد',
            'مضخة الوقود'
        ]
    },
    
    'obd_systems': {
        'name': 'OBD - نظام التشخيص الذاتي',
        'versions': {
            'OBD-I': 'قديم - سيارات ما قبل 1996 - كل شركة لها نظام',
            'OBD-II': 'موحد - 1996+ - جميع السيارات في أمريكا وأوروبا',
            'EOBD': 'أوروبي - مشابه لـ OBD-II'
        },
        'connector_location': [
            'عادة تحت لوحة القيادة',
            'قرب عمود القيادة',
            '16 pin connector (OBD-II)'
        ],
        'what_it_does': [
            'يراقب جميع الحساسات',
            'يكتشف الأعطال تلقائياً',
            'يخزن أكواد الأعطال (DTCs)',
            'يضيء لمبة Check Engine عند وجود عطل'
        ]
    },
    
    'dtc_codes': {
        'name': 'أكواد الأعطال (DTCs)',
        'format': 'P0XXX, P1XXX, P2XXX, P3XXX',
        'categories': {
            'P0': 'أكواد موحدة (جميع السيارات)',
            'P1': 'أكواد خاصة بالشركة المصنعة',
            'P2': 'أكواد وقود وهواء',
            'P3': 'أكواد الاشتعال'
        },
        'common_codes': {
            'P0300': {
                'description': 'Random/Multiple Cylinder Misfire',
                'ar': 'تقطيع عشوائي في المحرك',
                'causes': ['بواجي', 'كويلات', 'وقود', 'ضغط'],
                'severity': 'عالية'
            },
            'P0420': {
                'description': 'Catalyst System Efficiency Below Threshold',
                'ar': 'كفاءة المحول الحفاز منخفضة',
                'causes': ['محول حفاز تالف', 'حساس أكسجين'],
                'severity': 'متوسطة - لا يؤثر على القيادة'
            },
            'P0171': {
                'description': 'System Too Lean',
                'ar': 'خليط فقير (هواء أكثر من الوقود)',
                'causes': ['تسرب هواء', 'فلتر وقود', 'ضغط وقود منخفض'],
                'severity': 'متوسطة'
            },
            'P0128': {
                'description': 'Coolant Thermostat',
                'ar': 'ثرموستات لا يصل لدرجة الحرارة',
                'causes': ['ثرموستات مفتوح دائماً'],
                'severity': 'منخفضة - زيادة استهلاك'
            }
        }
    },
    
    'scan_tools': {
        'name': 'أدوات المسح والتشخيص',
        'types': {
            'basic_code_reader': {
                'name': 'قارئ أكواد بسيط',
                'price': '100-300₪',
                'features': ['يقرأ الأكواد', 'يمسح الأكواد'],
                'limitations': 'لا يعرض بيانات حية (Live Data)'
            },
            'advanced_scanner': {
                'name': 'ماسح متقدم',
                'price': '500-2,000₪',
                'features': [
                    'يقرأ الأكواد',
                    'يعرض البيانات الحية (Live Data)',
                    'يفعّل/يوقف الأنظمة (Actuator Tests)',
                    'يبرمج بعض الأنظمة'
                ],
                'brands': ['Launch', 'Autel', 'Snap-on']
            },
            'professional': {
                'name': 'نظام تشخيص احترافي',
                'price': '3,000-10,000₪+',
                'features': [
                    'كل ميزات المتقدم',
                    'دعم جميع السيارات',
                    'برمجة ECU',
                    'ضبط الأنظمة (Calibration)',
                    'رسوم بيانية'
                ],
                'brands': ['Bosch KTS', 'Snap-on MODIS', 'Autel MaxiSys']
            }
        },
        'how_to_use': [
            '1. أوصل الماسح بمنفذ OBD',
            '2. شغّل المفتاح (لا تدر المحرك)',
            '3. اختر نوع السيارة',
            '4. اقرأ الأكواد (Read Codes)',
            '5. ابحث عن معنى الكود',
            '6. افحص البيانات الحية',
            '7. امسح الأكواد بعد الإصلاح',
            '8. test drive وتأكد من عدم عودة الكود'
        ]
    },
    
    'heavy_equipment_ecu': {
        'name': 'كمبيوترات المعدات الثقيلة',
        'brands': {
            'CAT': {
                'name': 'Caterpillar',
                'tool': 'CAT ET (Electronic Technician)',
                'connector': 'خاص 6-pin أو 9-pin',
                'features': [
                    'قراءة أكواد الأعطال',
                    'معايرة الأنظمة',
                    'برمجة ECU',
                    'تحديث السوفتوير'
                ],
                'price': 'غالٍ جداً - للوكلاء عادةً'
            },
            'Komatsu': {
                'name': 'كوماتسو',
                'tool': 'KOMTRAX',
                'features': [
                    'تشخيص عن بعد',
                    'تتبع المعدة GPS',
                    'تقارير الصيانة'
                ]
            },
            'JCB': {
                'name': 'JCB',
                'tool': 'JCB Service Master',
                'note': 'يحتاج جهاز خاص'
            }
        },
        'general_note': '⚠️ معدات ثقيلة تحتاج أدوات تشخيص خاصة ومكلفة - أو زيارة للوكيل'
    }
}


# ====================================================================
# دوال التشخيص الإلكتروني
# ====================================================================

def explain_dtc_code(code: str) -> str:
    """شرح كود عطل DTC"""
    code_upper = code.upper().strip()
    
    common_codes = ECU_KNOWLEDGE['dtc_codes']['common_codes']
    
    if code_upper in common_codes:
        code_info = common_codes[code_upper]
        
        return f"""🔍 **كود العطل: {code_upper}**

📝 **الوصف بالإنجليزية:**
{code_info['description']}

📝 **الوصف بالعربية:**
{code_info['ar']}

🔧 **الأسباب المحتملة:**
""" + '\n'.join([f"  • {cause}" for cause in code_info['causes']]) + f"""

⚠️ **مستوى الخطورة:** {code_info['severity']}

💡 **توصيتي:**
ابدأ بفحص الأسباب الأرخص أولاً (الحساسات عادة)
"""
    else:
        return f"""❓ **كود غير شائع: {code_upper}**

💡 ابحث عن الكود في:
  • Google: "{code_upper} + نوع السيارة"
  • موقع الشركة المصنعة
  • منتديات السيارات

🔧 أو استخدم ماسح متقدم لعرض تفاصيل أكثر
"""


def ecu_connection_guide(vehicle_brand: str) -> str:
    """دليل توصيل جهاز التشخيص"""
    
    return f"""🔌 **دليل توصيل جهاز التشخيص:**

📍 **موقع منفذ OBD-II:**
• عادة تحت لوحة القيادة
• قرب عمود القيادة
• قد يكون مغطى بغطاء بلاستيك

🔧 **خطوات التوصيل:**
1. أطفئ المحرك
2. ابحث عن منفذ OBD (16 pin عادةً)
3. أوصل الماسح بإحكام
4. شغّل المفتاح (ON - لا تدر المحرك)
5. انتظر 5-10 ثواني
6. ابدأ القراءة من الجهاز

⚠️ **ملاحظات:**
• لا تفصل الجهاز والمفتاح ON
• المعدات الثقيلة قد تحتاج موصل خاص
• استشر دليل المعدة إذا لم تجد المنفذ

💡 **لقراءة الأكواد بدون جهاز (بعض السيارات):**
• Toyota/Nissan: جسر طرفي TE1-E1 وشاهد وميض لمبة Check Engine
• الوميض = الكود (مثلاً: 2 ومضات، توقف، 3 ومضات = كود 23)
"""

