"""
ูุนุฑูุฉ ุฏูุชุฑ ุงูุฃุณุชุงุฐ ูููุณุงุนุฏ ุงูุฐูู
GL Knowledge Base for AI Assistant

๐ฏ ุงููุฏู: ุฌุนู ุงููุณุงุนุฏ ุงูุฐูู ุฎุจูุฑุงู ูู:
- ูุธุงู ุฏูุชุฑ ุงูุฃุณุชุงุฐ (GL)
- ุงููููุฏ ุงููุญุงุณุจูุฉ
- ุงูุชุญููู ุงููุงูู
- ุญู ุงููุดุงูู ุงููุญุงุณุจูุฉ
"""

from decimal import Decimal
from datetime import datetime
from typing import Dict, List, Any, Optional


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ GL System Knowledge - ูุนุฑูุฉ ูุธุงู ุฏูุชุฑ ุงูุฃุณุชุงุฐ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

GL_SYSTEM_KNOWLEDGE = {
    "description": """
    ๐ฆ **ูุธุงู ุฏูุชุฑ ุงูุฃุณุชุงุฐ (GL) ูู ูุธุงู ุฃุฒุงุฏ:**
    
    ูุธุงู ูุญุงุณุจู ูุชูุงูู ุจูุนุงููุฑ Enterprise-Grade ูุชุจุน Double-Entry Bookkeeping.
    ูู ูุนุงููุฉ ุชูุณุฌูู ุชููุงุฆูุงู ูู ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุนุจุฑ Event Listeners.
    """,
    
    "models": {
        "GLBatch": {
            "description": "ูุฌููุนุฉ ูููุฏ ูุญุงุณุจูุฉ (Batch of GL Entries)",
            "fields": {
                "id": "ุงููุนุฑูู ุงููุฑูุฏ",
                "batch_date": "ุชุงุฑูุฎ ุงููุฌููุนุฉ",
                "source_type": "ููุน ุงููุตุฏุฑ (SALE, PAYMENT, EXPENSE, etc.)",
                "source_id": "ูุนุฑูู ุงููุตุฏุฑ",
                "purpose": "ุงูุบุฑุถ (REVENUE, OPENING_BALANCE, EXPENSE, etc.)",
                "currency": "ุงูุนููุฉ",
                "memo": "ุงููุตู",
                "reference": "ุงููุฑุฌุน ุงูุฎุงุฑุฌู",
                "entity_type": "ููุน ุงูููุงู",
                "entity_id": "ูุนุฑูู ุงูููุงู",
                "total_debit": "ุฅุฌูุงูู ุงููุฏูู",
                "total_credit": "ุฅุฌูุงูู ุงูุฏุงุฆู",
            },
            "relationships": {
                "entries": "ุงููููุฏ ุงููุญุงุณุจูุฉ (GLEntry) - ุนูุงูุฉ 1:N"
            }
        },
        
        "GLEntry": {
            "description": "ููุฏ ูุญุงุณุจู ูุงุญุฏ (Single GL Entry)",
            "fields": {
                "id": "ุงููุนุฑูู",
                "gl_batch_id": "ูุนุฑูู ุงููุฌููุนุฉ",
                "account_code": "ุฑูุฒ ุงูุญุณุงุจ (1000_CASH, 4000_SALES, etc.)",
                "debit_amount": "ุงููุจูุบ ุงููุฏูู",
                "credit_amount": "ุงููุจูุบ ุงูุฏุงุฆู",
                "description": "ุงููุตู",
                "entity_type": "ููุน ุงูููุงู ุงููุฑุชุจุท",
                "entity_id": "ูุนุฑูู ุงูููุงู ุงููุฑุชุจุท",
            }
        }
    },
    
    "accounts": {
        "description": "ุฏููู ุงูุญุณุงุจุงุช (Chart of Accounts)",
        "structure": {
            "1xxx": "ุฃุตูู (Assets)",
            "2xxx": "ุฎุตูู (Liabilities)",
            "3xxx": "ุญููู ุงูููููุฉ (Equity)",
            "4xxx": "ุฅูุฑุงุฏุงุช (Revenue)",
            "5xxx": "ูุตุฑููุงุช (Expenses)",
        },
        
        "main_accounts": {
            "1000_CASH": "ุงูููุฏูุฉ",
            "1010_BANK": "ุงูุจูู",
            "1020_CARD_CLEARING": "ููุงุตุฉ ุงูุจุทุงูุงุช",
            "1100_AR": "ุงูุนููุงุก (Accounts Receivable)",
            "1200_INVENTORY": "ุงููุฎุฒูู",
            "1300_CHECKS_RECEIVABLE": "ุดููุงุช ุชุญุช ุงูุชุญุตูู",
            
            "2000_AP": "ุงูููุฑุฏูู (Accounts Payable)",
            "2100_CHECKS_PAYABLE": "ุดููุงุช ุชุญุช ุงูุฏูุน",
            
            "3000_EQUITY": "ุฑุฃุณ ุงููุงู",
            "3100_RETAINED_EARNINGS": "ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ",
            
            "4000_SALES": "ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช",
            "4100_SERVICE_REVENUE": "ุฅูุฑุงุฏุงุช ุงูุฎุฏูุงุช",
            
            "5000_EXPENSES": "ุงููุตุงุฑูู ุงูุนุงูุฉ",
            "5100_COGS": "ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (Cost of Goods Sold)",
        }
    },
    
    "auto_gl_creation": {
        "description": "ุฅูุดุงุก GL ุชููุงุฆู ุนุจุฑ Event Listeners",
        "modules": [
            {
                "module": "Customer Opening Balance",
                "listener": "_customer_opening_balance_gl",
                "trigger": "after_insert, after_update",
                "entries": "AR โ Equity"
            },
            {
                "module": "Supplier Opening Balance",
                "listener": "_supplier_opening_balance_gl",
                "trigger": "after_insert, after_update",
                "entries": "AP โ Equity"
            },
            {
                "module": "Partner Opening Balance",
                "listener": "_partner_opening_balance_gl",
                "trigger": "after_insert, after_update",
                "entries": "AP โ Equity"
            },
            {
                "module": "Sale",
                "listener": "_sale_gl_batch_upsert",
                "trigger": "after_insert, after_update (CONFIRMED)",
                "entries": "AR (debit) โ Revenue (credit) + Partner AP + COGS"
            },
            {
                "module": "Payment",
                "listener": "_payment_gl_batch_upsert",
                "trigger": "after_insert, after_update (COMPLETED)",
                "entries": "Cash/Bank โ AR/AP (depends on direction)"
            },
            {
                "module": "Expense",
                "listener": "_expense_gl_batch_upsert",
                "trigger": "after_insert, after_update",
                "entries": "Expense (debit) โ Cash/Bank (credit)"
            },
            {
                "module": "Check",
                "listener": "create_gl_entry_for_check",
                "trigger": "status change",
                "entries": "Complex lifecycle accounting"
            },
            {
                "module": "Shipment",
                "listener": "_shipment_gl_*",
                "trigger": "arrival",
                "entries": "Inventory (debit) โ AP (credit) + COGS"
            },
            {
                "module": "Service",
                "listener": "_service_gl_*",
                "trigger": "completion",
                "entries": "AR (debit) โ Service Revenue (credit)"
            },
        ]
    }
}


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ก GL Business Rules - ููุงุนุฏ ุงูุนูู ุงููุญุงุณุจูุฉ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

GL_BUSINESS_RULES = {
    "double_entry": {
        "rule": "ูู ููุฏ ูุฌุจ ุฃู ูููู ูุชูุงุฒู (Total Debit = Total Credit)",
        "example": "ุนูุฏ ุจูุน ุจูุจูุบ 1000:\n- ูุฏูู: AR 1000\n- ุฏุงุฆู: Sales 1000"
    },
    
    "opening_balance": {
        "rule": "ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู ููุณุฌูู ูู GL ุนุจุฑ listener",
        "customer": {
            "positive": "ูู ุนูููุง โ AR (credit) + Equity (debit)",
            "negative": "ุนููู ููุง โ AR (debit) + Equity (credit)"
        },
        "supplier": {
            "positive": "ูู ุนูููุง โ AP (credit) + Equity (debit)",
            "negative": "ุนููู ููุง โ AP (debit) + Equity (credit)"
        }
    },
    
    "sale_accounting": {
        "rule": "ุงููุจูุนุงุช ุชูุณุฌูู ุนูุฏ CONFIRMED",
        "basic": "AR (debit) โ Revenue (credit)",
        "with_partners": "Revenue ูููุณูู ุญุณุจ ูุณุจ ุงูุดุฑูุงุก",
        "with_exchange": "COGS (debit) + AP Supplier (credit)",
        "complex": """
        1. AR ููุนููู (ูุฏูู)
        2. Revenue ููุดุฑูุฉ (ุฏุงุฆู) - ุญุณุจ warehouse type
        3. AP ููุดุฑูู (ุฏุงุฆู) - ุฅุฐุง ูุงู partner warehouse
        4. COGS + AP ููููุฑุฏ - ุฅุฐุง ูุงู exchange warehouse
        """
    },
    
    "payment_accounting": {
        "rule": "ุงูุฏูุนุงุช ุชูุณุฌูู ุนูุฏ COMPLETED",
        "incoming": "Cash/Bank (debit) โ AR (credit)",
        "outgoing": "AP (debit) โ Cash/Bank (credit)",
        "multi_entity": "Payment ูููู ุฃู ูุฑุชุจุท ุจู 10 ููุงูุงุช ูุฎุชููุฉ"
    },
    
    "check_lifecycle": {
        "incoming_received": "Checks Receivable (debit) โ AR (credit)",
        "incoming_cashed": "Bank (debit) โ Checks Receivable (credit)",
        "incoming_returned": "AR (debit) โ Checks Receivable (credit)",
        
        "outgoing_issued": "AP (debit) โ Checks Payable (credit)",
        "outgoing_cashed": "Checks Payable (debit) โ Bank (credit)",
        "outgoing_returned": "Checks Payable (debit) โ AP (credit)",
    }
}


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ GL Analysis Functions - ุฏูุงู ุชุญููู ุฏูุชุฑ ุงูุฃุณุชุงุฐ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

def explain_gl_entry(gl_entry_data: Dict) -> str:
    """
    ุดุฑุญ ููุฏ ูุญุงุณุจู ุจุทุฑููุฉ ูููููุฉ
    
    Args:
        gl_entry_data: ุจูุงูุงุช ุงูููุฏ (account_code, debit, credit, description)
    
    Returns:
        ุดุฑุญ ูุงุถุญ ุจุงูุนุฑุจูุฉ
    """
    account_code = gl_entry_data.get('account_code', '')
    debit = float(gl_entry_data.get('debit_amount', 0))
    credit = float(gl_entry_data.get('credit_amount', 0))
    description = gl_entry_data.get('description', '')
    
    # ุดุฑุญ ุงูุญุณุงุจ
    account_name = GL_SYSTEM_KNOWLEDGE['accounts']['main_accounts'].get(
        account_code, account_code
    )
    
    # ุชุญุฏูุฏ ุงูููุน
    entry_type = "ูุฏูู" if debit > 0 else "ุฏุงุฆู"
    amount = debit if debit > 0 else credit
    
    # ุดุฑุญ ุงูุฃุซุฑ
    effect = _explain_account_effect(account_code, entry_type, amount)
    
    explanation = f"""
๐ **ููุฏ ูุญุงุณุจู:**
- ุงูุญุณุงุจ: {account_name} ({account_code})
- ุงูููุน: {entry_type}
- ุงููุจูุบ: {amount:,.2f} ุดููู
- ุงููุตู: {description}

๐ก **ุงูุฃุซุฑ:**
{effect}
"""
    
    return explanation.strip()


def _explain_account_effect(account_code: str, entry_type: str, amount: float) -> str:
    """ุดุฑุญ ุฃุซุฑ ุงูููุฏ ุนูู ุงูุญุณุงุจ"""
    
    account_category = account_code[:1]  # First digit
    
    effects = {
        "1": {  # Assets
            "ูุฏูู": f"ุฒูุงุฏุฉ ูู ุงูุฃุตูู ุจูุจูุบ {amount:,.2f} ุดููู โ",
            "ุฏุงุฆู": f"ููุต ูู ุงูุฃุตูู ุจูุจูุบ {amount:,.2f} ุดููู โฌ๏ธ"
        },
        "2": {  # Liabilities
            "ูุฏูู": f"ููุต ูู ุงูุฎุตูู (ุชุณุฏูุฏ ุงูุชุฒุงู) ุจูุจูุบ {amount:,.2f} ุดููู โฌ๏ธ",
            "ุฏุงุฆู": f"ุฒูุงุฏุฉ ูู ุงูุฎุตูู (ุงูุชุฒุงู ุฌุฏูุฏ) ุจูุจูุบ {amount:,.2f} ุดููู โฌ๏ธ"
        },
        "3": {  # Equity
            "ูุฏูู": f"ููุต ูู ุฑุฃุณ ุงููุงู ุจูุจูุบ {amount:,.2f} ุดููู โฌ๏ธ",
            "ุฏุงุฆู": f"ุฒูุงุฏุฉ ูู ุฑุฃุณ ุงููุงู ุจูุจูุบ {amount:,.2f} ุดููู โฌ๏ธ"
        },
        "4": {  # Revenue
            "ูุฏูู": f"ุชุฎููุถ ุฅูุฑุงุฏุงุช ุจูุจูุบ {amount:,.2f} ุดููู (ูุฑุชุฌุนุงุช) โฌ๏ธ",
            "ุฏุงุฆู": f"ุฅูุฑุงุฏุงุช ุฌุฏูุฏุฉ ุจูุจูุบ {amount:,.2f} ุดููู ๐ฐ"
        },
        "5": {  # Expenses
            "ูุฏูู": f"ูุตุฑูู ุฌุฏูุฏ ุจูุจูุบ {amount:,.2f} ุดููู ๐ธ",
            "ุฏุงุฆู": f"ุชุฎููุถ ูุตุฑูู (ุฅูุบุงุก) ุจูุจูุบ {amount:,.2f} ุดููู โ"
        }
    }
    
    return effects.get(account_category, {}).get(entry_type, "ุชุฃุซูุฑ ุบูุฑ ูุนุฑูู")


def analyze_gl_batch(gl_batch_data: Dict) -> Dict[str, Any]:
    """
    ุชุญููู ุดุงูู ููุฌููุนุฉ ูููุฏ
    
    Args:
        gl_batch_data: ุจูุงูุงุช GLBatch ูุน entries
    
    Returns:
        ุชุญููู ุดุงูู
    """
    total_debit = sum(float(e.get('debit_amount', 0)) for e in gl_batch_data.get('entries', []))
    total_credit = sum(float(e.get('credit_amount', 0)) for e in gl_batch_data.get('entries', []))
    
    is_balanced = abs(total_debit - total_credit) < 0.01
    
    analysis = {
        "balanced": is_balanced,
        "total_debit": total_debit,
        "total_credit": total_credit,
        "difference": total_debit - total_credit,
        "entries_count": len(gl_batch_data.get('entries', [])),
        "source_type": gl_batch_data.get('source_type'),
        "purpose": gl_batch_data.get('purpose'),
        "explanation": _explain_gl_batch_purpose(gl_batch_data)
    }
    
    if not is_balanced:
        analysis["warning"] = f"โ๏ธ ุงูููุฏ ุบูุฑ ูุชูุงุฒู! ุงููุฑู: {analysis['difference']:,.2f} ุดููู"
    
    return analysis


def _explain_gl_batch_purpose(gl_batch_data: Dict) -> str:
    """ุดุฑุญ ุบุฑุถ ูุฌููุนุฉ ุงููููุฏ"""
    
    source_type = gl_batch_data.get('source_type', '')
    purpose = gl_batch_data.get('purpose', '')
    memo = gl_batch_data.get('memo', '')
    
    explanations = {
        "SALE_REVENUE": "ููุฏ ุฅูุฑุงุฏุงุช ูุจูุนุงุช - ุชุณุฌูู ูุงุชูุฑุฉ ูุจูุนุงุช",
        "OPENING_BALANCE": "ููุฏ ุฑุตูุฏ ุงูุชุชุงุญู - ุชุณุฌูู ุงูุฑุตูุฏ ุงููุจุฏุฆู",
        "PAYMENT": "ููุฏ ุฏูุนุฉ - ุชุณุฌูู ุฏูุนุฉ ูุงููุฉ",
        "EXPENSE": "ููุฏ ูุตุฑูู - ุชุณุฌูู ูุตุฑูู",
        "CHECK": "ููุฏ ุดูู - ุฅุฏุงุฑุฉ ุฏูุฑุฉ ุญูุงุฉ ุงูุดูู",
        "SHIPMENT": "ููุฏ ุดุญูุฉ - ุงุณุชูุงู ุจุถุงุนุฉ",
        "SERVICE": "ููุฏ ุฎุฏูุฉ - ุชุณุฌูู ุฎุฏูุฉ ุตูุงูุฉ",
    }
    
    key = f"{source_type}_{purpose}".upper()
    
    return explanations.get(key, explanations.get(purpose, memo or "ููุฏ ูุญุงุณุจู ุนุงู"))


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ GL Reports Knowledge - ูุนุฑูุฉ ุชูุงุฑูุฑ ุฏูุชุฑ ุงูุฃุณุชุงุฐ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

GL_REPORTS_KNOWLEDGE = {
    "trial_balance": {
        "name_ar": "ููุฒุงู ุงููุฑุงุฌุนุฉ",
        "name_en": "Trial Balance",
        "description": "ูุงุฆูุฉ ุจุฌููุน ุงูุญุณุงุจุงุช ูุน ุฃุฑุตุฏุชูุง ุงููุฏููุฉ ูุงูุฏุงุฆูุฉ",
        "purpose": "ุงูุชุญูู ูู ุชูุงุฒู ุงููููุฏ ุงููุญุงุณุจูุฉ",
        "formula": "ุฅุฌูุงูู ุงููุฏูู = ุฅุฌูุงูู ุงูุฏุงุฆู",
        "columns": ["ุฑูุฒ ุงูุญุณุงุจ", "ุงุณู ุงูุญุณุงุจ", "ุงููุฏูู", "ุงูุฏุงุฆู", "ุงูุฑุตูุฏ"]
    },
    
    "balance_sheet": {
        "name_ar": "ุงูููุฒุงููุฉ ุงูุนููููุฉ",
        "name_en": "Balance Sheet",
        "description": "ุจูุงู ุงููุฑูุฒ ุงููุงูู ูู ุชุงุฑูุฎ ูุนูู",
        "formula": "ุงูุฃุตูู = ุงูุฎุตูู + ุญููู ุงูููููุฉ",
        "sections": {
            "assets": "ุงูุฃุตูู (Assets)",
            "liabilities": "ุงูุฎุตูู (Liabilities)",
            "equity": "ุญููู ุงูููููุฉ (Equity)"
        }
    },
    
    "income_statement": {
        "name_ar": "ูุงุฆูุฉ ุงูุฏุฎู",
        "name_en": "Income Statement",
        "description": "ุจูุงู ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ ุนู ูุชุฑุฉ ูุนููุฉ",
        "formula": "ุตุงูู ุงูุฑุจุญ = ุงูุฅูุฑุงุฏุงุช - ุงููุตุฑููุงุช",
        "sections": {
            "revenue": "ุงูุฅูุฑุงุฏุงุช (Revenue)",
            "cogs": "ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (COGS)",
            "gross_profit": "ุฅุฌูุงูู ุงูุฑุจุญ (Gross Profit)",
            "expenses": "ุงููุตุฑููุงุช (Operating Expenses)",
            "net_profit": "ุตุงูู ุงูุฑุจุญ (Net Profit)"
        }
    },
    
    "cash_flow": {
        "name_ar": "ูุงุฆูุฉ ุงูุชุฏููุงุช ุงูููุฏูุฉ",
        "name_en": "Cash Flow Statement",
        "description": "ุจูุงู ุญุฑูุฉ ุงูููุฏ ุฎูุงู ูุชุฑุฉ ูุนููุฉ",
        "sections": {
            "operating": "ุงูุฃูุดุทุฉ ุงูุชุดุบูููุฉ",
            "investing": "ุงูุฃูุดุทุฉ ุงูุงุณุชุซูุงุฑูุฉ",
            "financing": "ุงูุฃูุดุทุฉ ุงูุชูููููุฉ"
        }
    }
}


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ฏ AI Helper Functions - ุฏูุงู ูุณุงุนุฏุฉ ููุฐูุงุก ุงูุงุตุทูุงุนู
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

def get_gl_knowledge_for_ai() -> Dict[str, Any]:
    """
    ุงูุญุตูู ุนูู ุฌููุน ูุนุงุฑู GL ูููุณุงุนุฏ ุงูุฐูู
    
    Returns:
        ูุงุนุฏุฉ ูุนุฑูุฉ ุดุงููุฉ
    """
    return {
        "system_knowledge": GL_SYSTEM_KNOWLEDGE,
        "business_rules": GL_BUSINESS_RULES,
        "reports_knowledge": GL_REPORTS_KNOWLEDGE,
        
        "capabilities": [
            "ููู ูุธุงู ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุจุงููุงูู",
            "ุดุฑุญ ุงููููุฏ ุงููุญุงุณุจูุฉ",
            "ุชุญููู GLBatch",
            "ูุดู ุงูุฃุฎุทุงุก ุงููุญุงุณุจูุฉ",
            "ุดุฑุญ ุงูุชูุงุฑูุฑ ุงููุงููุฉ",
            "ุชุชุจุน ุงููุนุงููุงุช ูู ุงููุตุฏุฑ ููู GL",
        ],
        
        "can_answer": [
            "ูุง ูู ุฏูุชุฑ ุงูุฃุณุชุงุฐุ",
            "ููู ูุชู ุฅูุดุงุก GL ุชููุงุฆูุงูุ",
            "ูุง ูู ุงููููุฏ ุงููุญุงุณุจูุฉ ูููุจูุนุงุชุ",
            "ูุณูุฑ ูู ูุฐุง ุงูููุฏ",
            "ููุงุฐุง ุงูุฑุตูุฏ ุบูุฑ ูุชูุงุฒูุ",
            "ูุง ูู ููุฒุงู ุงููุฑุงุฌุนุฉุ",
            "ููู ุฃูุฑุฃ ุงูููุฒุงููุฉ ุงูุนููููุฉุ",
            "ูุง ุงููุฑู ุจูู AR ู APุ",
        ]
    }


def detect_gl_error(gl_batch_data: Dict) -> Optional[Dict[str, str]]:
    """
    ูุดู ุงูุฃุฎุทุงุก ูู ุงููููุฏ ุงููุญุงุณุจูุฉ
    
    Args:
        gl_batch_data: ุจูุงูุงุช GLBatch
    
    Returns:
        ูุนูููุงุช ุงูุฎุทุฃ ุฅุฐุง ููุฌุฏ
    """
    entries = gl_batch_data.get('entries', [])
    
    if not entries:
        return {
            "error": "empty_batch",
            "message": "โ๏ธ ูุง ุชูุฌุฏ ูููุฏ ูู ูุฐู ุงููุฌููุนุฉ",
            "solution": "ุชุฃูุฏ ูู ุฅุถุงูุฉ ูููุฏ ูุญุงุณุจูุฉ"
        }
    
    # ูุญุต ุงูุชูุงุฒู
    total_debit = sum(float(e.get('debit_amount', 0)) for e in entries)
    total_credit = sum(float(e.get('credit_amount', 0)) for e in entries)
    
    if abs(total_debit - total_credit) > 0.01:
        return {
            "error": "unbalanced",
            "message": f"โ๏ธ ุงูููุฏ ุบูุฑ ูุชูุงุฒู!\nุงููุฏูู: {total_debit:,.2f}\nุงูุฏุงุฆู: {total_credit:,.2f}\nุงููุฑู: {total_debit - total_credit:,.2f}",
            "solution": "ุฑุงุฌุน ุงููููุฏ ูุชุฃูุฏ ุฃู ุฅุฌูุงูู ุงููุฏูู = ุฅุฌูุงูู ุงูุฏุงุฆู"
        }
    
    # ูุญุต ุงููููุฏ ุงููุงุฑุบุฉ
    for i, entry in enumerate(entries):
        debit = float(entry.get('debit_amount', 0))
        credit = float(entry.get('credit_amount', 0))
        
        if debit == 0 and credit == 0:
            return {
                "error": "zero_entry",
                "message": f"โ๏ธ ุงูููุฏ ุฑูู {i+1} ูุงุฑุบ (ูุง ูุฏูู ููุง ุฏุงุฆู)",
                "solution": "ุงุญุฐู ุงูููุฏ ุงููุงุฑุบ ุฃู ุฃุถู ูุจูุบ"
            }
        
        if debit > 0 and credit > 0:
            return {
                "error": "double_entry",
                "message": f"โ๏ธ ุงูููุฏ ุฑูู {i+1} ูุญุชูู ุนูู ูุฏูู ูุฏุงุฆู ูุนุงู!",
                "solution": "ูู ููุฏ ูุฌุจ ุฃู ูููู ุฅูุง ูุฏูู ุฃู ุฏุงุฆู ููุท"
            }
    
    # ูุง ุชูุฌุฏ ุฃุฎุทุงุก
    return None


def suggest_gl_correction(error_info: Dict) -> str:
    """ุงูุชุฑุงุญ ุชุตุญูุญ ููุฎุทุฃ ุงููุญุงุณุจู"""
    
    error_type = error_info.get('error', '')
    
    suggestions = {
        "unbalanced": """
๐ก **ุฎุทูุงุช ุงูุชุตุญูุญ:**
1. ุงุญุณุจ ุงููุฑู ุจูู ุงููุฏูู ูุงูุฏุงุฆู
2. ุงุจุญุซ ุนู ุงูููุฏ ุงูุฎุงุทุฆ (ูุจูุบ ููููุฏ ุฃู ูุถุงุนู)
3. ุชุญูู ูู ุฃู ูู ูุนุงููุฉ ููุง ุทุฑููู ูุชุณุงูููู
4. ุฅุฐุง ูุงู ุงููุฑู ุตุบูุฑ (< 1)ุ ูุฏ ูููู ุฎุทุฃ ุชูุฑูุจ
""",
        "empty_batch": """
๐ก **ุฎุทูุงุช ุงูุชุตุญูุญ:**
1. ุชุญูู ูู ุฃู ุงููุนุงููุฉ ุชู ุญูุธูุง ุจูุฌุงุญ
2. ุฑุงุฌุน Event Listener ุงููุณุคูู
3. ุชุฃูุฏ ูู ุฃู ุงูุดุฑูุท ูุณุชููุงุฉ (ูุซู: status = CONFIRMED)
""",
        "zero_entry": """
๐ก **ุฎุทูุงุช ุงูุชุตุญูุญ:**
1. ุงุญุฐู ุงูููุฏ ุงููุงุฑุบ
2. ุฃู ุฃุถู ุงููุจูุบ ุงูุตุญูุญ (ุฅูุง ูุฏูู ุฃู ุฏุงุฆู)
""",
        "double_entry": """
๐ก **ุฎุทูุงุช ุงูุชุตุญูุญ:**
1. ุญุฏุฏ ุฅุฐุง ูุงู ุงูููุฏ ูุฏูู ุฃู ุฏุงุฆู
2. ุงุฌุนู ุงูุขุฎุฑ = 0
3. ูุง ูููู ุฃู ูููู ุงูููุฏ ุงููุงุญุฏ ูุฏูู ูุฏุงุฆู ูุนุงู!
"""
    }
    
    return suggestions.get(error_type, "ุฑุงุฌุน ุงูุจูุงูุงุช ูุชูุงุตู ูุน ุงูุฏุนู ุงูููู")


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ Export ููุงุณุชุฎุฏุงู ูู AI Service
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

__all__ = [
    'GL_SYSTEM_KNOWLEDGE',
    'GL_BUSINESS_RULES',
    'GL_REPORTS_KNOWLEDGE',
    'get_gl_knowledge_for_ai',
    'explain_gl_entry',
    'analyze_gl_batch',
    'detect_gl_error',
    'suggest_gl_correction',
    'explain_any_number',
    'trace_transaction_flow'
]


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ DEEP FINANCIAL ANALYZER - ูุญูู ูุงูู ุนููู
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

def explain_any_number(number_value: float, context: str) -> str:
    """
    ุชูุณูุฑ ุฃู ุฑูู ูู ุงููุธุงู ุจุงูุชูุตูู ุงููุงูู
    
    ุงููุณุงุนุฏ ูุฌุจ ุฃู ูุนุฑู ูุดุฑุญ ุฃู ุฑูู:
    - ูุง ููุ
    - ูู ุฃูู ุฃุชูุ
    - ููู ุชู ุญุณุงุจูุ
    - ููุงุฐุง ุจูุฐุง ุงูุดููุ
    - ุงูุจููุฏ ุงูููููุฉ ูู
    - ุงุญุชูุงูุงุช ุงูุฎุทุฃ
    
    Args:
        number_value: ุงููููุฉ ุงูุฑูููุฉ
        context: ุงูุณูุงู (customer_balance, sales_total, etc.)
    
    Returns:
        ุดุฑุญ ุชูุตููู ูุงูู
    """
    
    explanations = {
        "customer_balance": lambda val: f"""
๐ **ุฑุตูุฏ ุงูุนููู: {val:,.2f} โช**

๐ **ูุง ููุ**
ุงูุฑุตูุฏ ุงูุญุงูู ููุนููู ูู ุฏูุงุชุฑูุง

๐ฅ **ูู ุฃูู ุฃุชูุ**
- ุงููุจูุนุงุช ุงูุขุฌูุฉ ููุนููู (+)
- ุงูููุงุชูุฑ ุงูุตุงุฏุฑุฉ ูู (+)
- ุงูุฎุฏูุงุช ุงูููุฏูุฉ ูู (+)
- ุงูุฏูุนุงุช ุงููุณุชููุฉ ููู (-)
- ุงูุฏูุนุงุช ุงููุฏููุนุฉ ูู (-) [ูุงุฏุฑุฉ]

๐งฎ **ููู ุชู ุญุณุงุจูุ**
ุงูุฑุตูุฏ = (ุงููุจูุนุงุช + ุงูููุงุชูุฑ + ุงูุฎุฏูุงุช) - (ุงูุฏูุนุงุช ุงููุงุฑุฏุฉ IN)

{'๐ด **ุงููุนูู:** ุงูุนููู ุนููู ูุฏูุน ' + str(abs(val)) + ' โช' if val < 0 else '๐ข **ุงููุนูู:** ููุนููู ุฑุตูุฏ ุนูุฏูุง ' + str(val) + ' โช (ุฏูุน ุฒูุงุฏุฉ)' if val > 0 else 'โช **ุงููุนูู:** ุงูุญุณุงุจ ูุณุฏุฏ ุจุงููุงูู'}

๐ก **ููุงุฐุง ุจูุฐุง ุงูุดููุ**
ูุธุงู ุงูููุฏ ุงููุฒุฏูุฌ: ูู ูุนุงููุฉ ุชูุณุฌู ูู ุฏูุชุฑ ุงูุฃุณุชุงุฐ
- ุจูุน โ ูุฏูู AR (ูุฒูุฏ ุงูุฏูู)
- ุฏูุน โ ุฏุงุฆู AR (ูููุต ุงูุฏูู)

โ๏ธ **ุงุญุชูุงูุงุช ุงูุฎุทุฃ:**
1. ุฏูุนุฉ ูู ุชูุณุฌู (ูุธูุฑ ุงูุฑุตูุฏ ุฃูุจุฑ ูู ุงููุงูุน)
2. ุฏูุนุฉ ูุณุฌูุฉ ูุฑุชูู (ูุธูุฑ ุงูุฑุตูุฏ ุฃูู)
3. ูุจูุนุฉ ููุบุงุฉ ูู ูุชู ุนูุณ ููุฏูุง
4. ุฎุทุฃ ูู ุฑุจุท ุงูุฏูุนุฉ ุจุงูุนููู
""",
        
        "total_sales": lambda val: f"""
๐ฐ **ุฅุฌูุงูู ุงููุจูุนุงุช: {val:,.2f} โช**

๐ **ูุง ููุ**
ูุฌููุน ุฌููุน ุนูููุงุช ุงูุจูุน ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ

๐ฅ **ูู ุฃูู ุฃุชูุ**
- ุฌุฏูู Sales โ ุฌูุน sale_total
- ุงูุญุงูุฉ: CONFIRMED ููุท
- ุงูุชุงุฑูุฎ: ุถูู ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉ

๐งฎ **ููู ุชู ุญุณุงุจูุ**
```sql
SELECT SUM(sale_total) 
FROM sales 
WHERE status = 'CONFIRMED' 
AND sale_date BETWEEN start_date AND end_date
```

๐ก **ุงูุชูุตูู:**
- ุณุนุฑ ุงููุทุนุฉ ร ุงููููุฉ = ุงููุฌููุน ุงููุฑุนู
- ุงููุฌููุน ุงููุฑุนู - ุงูุฎุตู = ุงูุตุงูู
- ุงูุตุงูู + ุงูุถุฑูุจุฉ (VAT) = ุงูุฅุฌูุงูู

๐ **ุงูููุฏ ุงููุญุงุณุจู:**
- ูุฏูู: 1100_AR (ุฐูู ุงูุนููุงุก) {val:,.2f} โช
- ุฏุงุฆู: 4000_SALES (ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช) {val / 1.16:,.2f} โช
- ุฏุงุฆู: 2100_VAT_PAYABLE (ุถุฑูุจุฉ) {val - (val / 1.16):,.2f} โช

โ๏ธ **ุงุญุชูุงูุงุช ุงูุฎุทุฃ:**
1. ูุจูุนุงุช ุจุญุงูุฉ PENDING ูู ุชูุคูุฏ
2. ูุจูุนุงุช ููุบุงุฉ ูู ูุชู ุชุบููุฑ ุญุงูุชูุง
3. ุชูุฑุงุฑ ูู ุงูุชุณุฌูู
4. ุฎุทุฃ ูู ุญุณุงุจ ุงูุถุฑูุจุฉ
""",
        
        "vat_payable": lambda val: f"""
๐งพ **ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุณุชุญูุฉ: {val:,.2f} โช**

๐ **ูุง ููุ**
ุงูุถุฑูุจุฉ ุงููุงุฌุจ ุชูุฑูุฏูุง ููุญูููุฉ

๐ฅ **ูู ุฃูู ุฃุชุชุ**
ุถุฑูุจุฉ ุงููุฎุฑุฌุงุช - ุถุฑูุจุฉ ุงููุฏุฎูุงุช

๐งฎ **ููู ุชู ุญุณุงุจูุงุ**
1. **ุถุฑูุจุฉ ุงููุฎุฑุฌุงุช (ุนูู ุงููุจูุนุงุช):**
   - ุงููุจูุนุงุช ุงูุฎุงุถุนุฉ ููุถุฑูุจุฉ ร 16%
   
2. **ุถุฑูุจุฉ ุงููุฏุฎูุงุช (ุนูู ุงููุดุชุฑูุงุช):**
   - ุงููุดุชุฑูุงุช ุงูุฎุงุถุนุฉ ููุถุฑูุจุฉ ร 16%
   
3. **ุงูุตุงูู:**
   ุถุฑูุจุฉ ุงููุฎุฑุฌุงุช - ุถุฑูุจุฉ ุงููุฏุฎูุงุช = {val:,.2f} โช

{'๐ด **ุงููุนูู:** ุนูููุง ูุฏูุน ' + str(abs(val)) + ' โช ููุญูููุฉ' if val > 0 else '๐ข **ุงููุนูู:** ููุง ุฑุตูุฏ ' + str(abs(val)) + ' โช ูููู ุงุณุชุฑุฏุงุฏู'}

๐ **ุงูููุฏ ุงููุญุงุณุจู:**
- ุนูุฏ ุงูุจูุน: ุฏุงุฆู VAT_PAYABLE (ุชุฒูุฏ ุงูุถุฑูุจุฉ ุงููุณุชุญูุฉ)
- ุนูุฏ ุงูุดุฑุงุก: ูุฏูู VAT_PAYABLE (ุชููุต ุงูุถุฑูุจุฉ ุงููุณุชุญูุฉ)
- ุนูุฏ ุงูุชูุฑูุฏ: ูุฏูู VAT_PAYABLE | ุฏุงุฆู BANK

โ๏ธ **ุงุญุชูุงูุงุช ุงูุฎุทุฃ:**
1. ุนูููุงุช ูุนูุงุฉ ุชู ุงุญุชุณุงุจ ุถุฑูุจุฉ ุนูููุง
2. ุฎุทุฃ ูู ุงููุณุจุฉ (16% vs 17%)
3. ุถุฑูุจุฉ ูุฏุฎูุงุช ุบูุฑ ูุงุจูุฉ ููุฎุตู ุชู ุฎุตููุง
4. ุนุฏู ุฑุจุท ุงูููุงุชูุฑ ุจุงูุถุฑูุจุฉ
"""
    }
    
    handler = explanations.get(context)
    if handler:
        return handler(number_value)
    else:
        return f"""
๐ **ุงููููุฉ: {number_value:,.2f} โช**

๐ ุงูุณูุงู: {context}

๐ก ูุฑุฌู ุชุญุฏูุฏ ููุน ุงูุฑูู ููุญุตูู ุนูู ุดุฑุญ ุชูุตููู:
- customer_balance (ุฑุตูุฏ ุนููู)
- total_sales (ุฅุฌูุงูู ูุจูุนุงุช)
- vat_payable (ุถุฑูุจุฉ ูุณุชุญูุฉ)
- net_profit (ุตุงูู ุฑุจุญ)
- inventory_value (ูููุฉ ูุฎุฒูู)
"""


def trace_transaction_flow(transaction_type: str, transaction_id: int) -> Dict[str, Any]:
    """
    ุชุชุจุน ูุณุงุฑ ูุนุงููุฉ ูู ุงูุจุฏุงูุฉ ููููุงูุฉ
    
    ูุดุฑุญ ูู ุฎุทูุฉ ูู ุฑุญูุฉ ุงููุนุงููุฉ:
    1. ุงูุชุณุฌูู ุงูุฃููู
    2. ุงููููุฏ ุงููุญุงุณุจูุฉ
    3. ุชุฃุซูุฑูุง ุนูู ุงูุฃุฑุตุฏุฉ
    4. ุชุฃุซูุฑูุง ุนูู ุงูููุงุฆู ุงููุงููุฉ
    
    Args:
        transaction_type: ููุน ุงููุนุงููุฉ (sale, payment, expense, etc.)
        transaction_id: ุฑูู ุงููุนุงููุฉ
    
    Returns:
        ุชูุตูู ูุงูู ูููุณุงุฑ
    """
    
    flows = {
        "sale": {
            "step_1": {
                "title": "1๏ธโฃ ุชุณุฌูู ุนูููุฉ ุงูุจูุน",
                "table": "Sales",
                "action": "ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ ูุน SaleLines",
                "data": ["ุงูุนููู", "ุงูููุชุฌุงุช", "ุงููููุงุช", "ุงูุฃุณุนุงุฑ", "ุงูุฎุตู", "ุงูุฅุฌูุงูู"]
            },
            "step_2": {
                "title": "2๏ธโฃ ุชุญุฏูุซ ุงููุฎุฒูู",
                "table": "StockLevel",
                "action": "ููุต ุงููููุงุช ูู ุงููุณุชูุฏุน",
                "formula": "ุงููููุฉ ุงูุฌุฏูุฏุฉ = ุงููููุฉ ุงูุณุงุจูุฉ - ุงููููุฉ ุงููุจุงุนุฉ"
            },
            "step_3": {
                "title": "3๏ธโฃ ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู (GL)",
                "table": "GLBatch + GLEntry",
                "entries": [
                    {"account": "1100_AR", "debit": "ุงููุจูุบ ุงูุฅุฌูุงูู", "credit": 0},
                    {"account": "4000_SALES", "debit": 0, "credit": "ุงููุจูุบ ุจุฏูู ุถุฑูุจุฉ"},
                    {"account": "2100_VAT", "debit": 0, "credit": "ุงูุถุฑูุจุฉ 16%"}
                ]
            },
            "step_4": {
                "title": "4๏ธโฃ ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู",
                "calculation": "ุฑุตูุฏ ุงูุนููู = ุงูุฑุตูุฏ ุงูุณุงุจู + ูุจูุบ ุงูุจูุน (ูุฒูุฏ ุงูุฏูู ุนููู)"
            },
            "step_5": {
                "title": "5๏ธโฃ ุงูุชุฃุซูุฑ ุนูู ุงูููุงุฆู ุงููุงููุฉ",
                "income_statement": "+ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช",
                "balance_sheet": "+ุฐูู ุงูุนููุงุก (AR), +ุถุฑูุจุฉ ูุณุชุญูุฉ (VAT)",
                "cash_flow": "ูุง ุชุฃุซูุฑ (ุจูุน ุขุฌู)"
            }
        },
        
        "payment_in": {
            "step_1": {
                "title": "1๏ธโฃ ุชุณุฌูู ุงูุฏูุนุฉ",
                "table": "Payment",
                "data": ["ุงูุนููู", "ุงููุจูุบ", "ุทุฑููุฉ ุงูุฏูุน", "ุงูุชุงุฑูุฎ"]
            },
            "step_2": {
                "title": "2๏ธโฃ ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู",
                "entries": [
                    {"account": "1000_CASH ุฃู 1010_BANK", "debit": "ุงููุจูุบ", "credit": 0},
                    {"account": "1100_AR", "debit": 0, "credit": "ุงููุจูุบ"}
                ]
            },
            "step_3": {
                "title": "3๏ธโฃ ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู",
                "calculation": "ุฑุตูุฏ ุงูุนููู = ุงูุฑุตูุฏ ุงูุณุงุจู - ุงููุจูุบ ุงููุฏููุน (ูููุต ุงูุฏูู)"
            },
            "step_4": {
                "title": "4๏ธโฃ ุงูุชุฃุซูุฑ ุนูู ุงูููุงุฆู ุงููุงููุฉ",
                "balance_sheet": "+ุงูููุฏูุฉ/ุงูุจูู, -ุฐูู ุงูุนููุงุก",
                "cash_flow": "+ุชุฏูู ููุฏู ูู ุงูุฃูุดุทุฉ ุงูุชุดุบูููุฉ"
            }
        }
    }
    
    return flows.get(transaction_type, {
        "error": f"ููุน ุงููุนุงููุฉ '{transaction_type}' ุบูุฑ ูุนุฑูู",
        "available": list(flows.keys())
    })

