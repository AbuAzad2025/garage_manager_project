{% extends 'warehouses/base.html' %}

{% block title %}معاينة المخزون{% endblock %}
{% block page_title %}معاينة مخزون: {{ warehouse.name }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/warehouses.css') }}">
  <style>
    .cell-saving{opacity:.6}
    td input.form-control{min-width:110px}
    td input.qty{max-width:90px;text-align:center}
    td input.price{max-width:110px}
    td input.text{max-width:180px}
    .expanded-col{display:none}
    .expanded-on .expanded-col{display:table-cell}
    .edited{outline:2px solid rgba(255,193,7,.6)}
    #pendingCount.badge{font-size:.85rem}
  </style>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <div class="d-flex align-items-center gap-3">
        <div class="fw-bold">إجمالي الأصناف: {{ rows|length }}</div>
        <span class="badge bg-warning" id="pendingCount" style="display:none">0 تغييرات</span>
        <span class="badge bg-success" id="savedBadge" style="display:none">تم الحفظ</span>
      </div>
      <div class="d-flex gap-2">
        <button id="btnCompact"  class="btn btn-outline-secondary">نسخة مبسطة</button>
        <button id="btnExpanded" class="btn btn-outline-secondary">نسخة موسعة</button>
        <button id="btnSave" class="btn btn-primary">حفظ التغييرات</button>
        <a href="{{ url_for('warehouse_bp.list') }}" class="btn btn-light">رجوع</a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle" id="inventory-table" style="width:100%">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>SKU</th>
            <th>رقم القطعة</th>
            <th>الاسم</th>
            <th>الماركة</th>
            <th class="text-center">الكمية</th>
            <th class="text-end">سعر الشراء</th>
            <th class="text-end">سعر البيع</th>
            <th class="text-end">القيمة</th>
            <th>بطاقة</th>

            <th class="expanded-col">الاسم التجاري</th>
            <th class="expanded-col">رقم الشاصي</th>
            <th class="expanded-col">التسلسلي</th>
            <th class="expanded-col">الباركود</th>
            <th class="expanded-col">الوحدة</th>
            <th class="expanded-col">اسم الفئة</th>
            <th class="expanded-col text-end">السعر</th>
            <th class="expanded-col text-end">تكلفة قبل الشحن</th>
            <th class="expanded-col text-end">تكلفة بعد الشحن</th>
            <th class="expanded-col text-end">سعر وحدة قبل الضريبة</th>
            <th class="expanded-col text-end">السعر الأدنى</th>
            <th class="expanded-col text-end">السعر الأعلى</th>
            <th class="expanded-col text-end">نسبة الضريبة</th>
            <th class="expanded-col text-end">حد أدنى</th>
            <th class="expanded-col text-end">نقطة إعادة الطلب</th>
            <th class="expanded-col">الحالة</th>
            <th class="expanded-col">بلد المنشأ</th>
            <th class="expanded-col text-end">مدة الضمان</th>
            <th class="expanded-col text-end">الوزن</th>
            <th class="expanded-col">الأبعاد</th>
            <th class="expanded-col">صورة</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr data-product="{{ r.product_id }}">
            <td>{{ loop.index }}</td>

            <td data-field="sku">
              <input class="form-control form-control-sm text" type="text" value="{{ r.sku or '' }}">
            </td>

            <td data-field="part_number">
              <input class="form-control form-control-sm text" type="text" value="{{ r.part_number or '' }}">
            </td>

            <td data-field="name">
              <input class="form-control form-control-sm text" type="text" value="{{ r.name or '' }}">
            </td>

            <td data-field="brand">
              <input class="form-control form-control-sm text" type="text" value="{{ r.brand or '' }}">
            </td>

            <td class="text-center" data-field="quantity">
              <input class="form-control form-control-sm qty" type="number" step="1" min="0" value="{{ r.quantity or 0 }}">
            </td>

            <td class="text-end" data-field="purchase_price">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.purchase_price or 0) }}">
            </td>

            <td class="text-end" data-field="selling_price">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.selling_price or 0) }}">
            </td>

            <td class="text-end fw-bold" data-field="row_total">
              {{ format_currency((r.selling_price or 0) * (r.quantity or 0)) }}
            </td>

            <td>
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('warehouse_bp.goto_product_card') }}?id={{ r.product_id }}">بطاقة</a>
            </td>

            <td class="expanded-col" data-field="commercial_name">
              <input class="form-control form-control-sm text" type="text" value="{{ r.commercial_name or '' }}">
            </td>

            <td class="expanded-col" data-field="chassis_number">
              <input class="form-control form-control-sm text" type="text" value="{{ r.chassis_number or '' }}">
            </td>

            <td class="expanded-col" data-field="serial_no">
              <input class="form-control form-control-sm text" type="text" value="{{ r.serial_no or '' }}">
            </td>

            <td class="expanded-col" data-field="barcode">
              <input class="form-control form-control-sm text" type="text" value="{{ r.barcode or '' }}">
            </td>

            <td class="expanded-col" data-field="unit">
              <input class="form-control form-control-sm text" type="text" value="{{ r.unit or '' }}">
            </td>

            <td class="expanded-col" data-field="category_name">
              <input class="form-control form-control-sm text" type="text" value="{{ r.category_name or '' }}">
            </td>

            <td class="expanded-col text-end" data-field="price">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.price or 0) }}">
            </td>

            <td class="expanded-col text-end" data-field="cost_before_shipping">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.cost_before_shipping or 0) }}">
            </td>

            <td class="expanded-col text-end" data-field="cost_after_shipping">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.cost_after_shipping or 0) }}">
            </td>

            <td class="expanded-col text-end" data-field="unit_price_before_tax">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.unit_price_before_tax or 0) }}">
            </td>

            <td class="expanded-col text-end" data-field="min_price">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.min_price or 0) }}">
            </td>

            <td class="expanded-col text-end" data-field="max_price">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.max_price or 0) }}">
            </td>

            <td class="expanded-col text-end" data-field="tax_rate">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.tax_rate or 0) }}">
            </td>

            <td class="expanded-col text-end" data-field="min_qty">
              <input class="form-control form-control-sm qty" type="number" step="1" min="0" value="{{ r.min_qty or 0 }}">
            </td>

            <td class="expanded-col text-end" data-field="reorder_point">
              <input class="form-control form-control-sm qty" type="number" step="1" min="0" value="{{ r.reorder_point or 0 }}">
            </td>

            <td class="expanded-col" data-field="condition">
              <input class="form-control form-control-sm text" type="text" value="{{ r.condition or '' }}">
            </td>

            <td class="expanded-col" data-field="origin_country">
              <input class="form-control form-control-sm text" type="text" value="{{ r.origin_country or '' }}">
            </td>

            <td class="expanded-col text-end" data-field="warranty_period">
              <input class="form-control form-control-sm qty" type="number" step="1" min="0" value="{{ r.warranty_period or 0 }}">
            </td>

            <td class="expanded-col text-end" data-field="weight">
              <input class="form-control form-control-sm price" type="number" step="0.01" min="0" value="{{ (r.weight or 0) }}">
            </td>

            <td class="expanded-col" data-field="dimensions">
              <input class="form-control form-control-sm text" type="text" value="{{ r.dimensions or '' }}">
            </td>

            <td class="expanded-col" data-field="image">
              <input class="form-control form-control-sm text" type="text" value="{{ r.image or '' }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const csrfToken = "{{ csrf_token() }}";
      const updateUrl = "{{ url_for('warehouse_bp.preview_update', warehouse_id=warehouse.id) }}";
      const tableEl = document.getElementById('inventory-table');
      const btnCompact = document.getElementById('btnCompact');
      const btnExpanded = document.getElementById('btnExpanded');
      const btnSave = document.getElementById('btnSave');
      const savedBadge = document.getElementById('savedBadge');
      const pendingBadge = document.getElementById('pendingCount');
      const VIEW_KEY = 'inv_preview_view';

      const pending = new Map();

      function setPending(pid, field, value, inputEl){
        if(!pending.has(pid)) pending.set(pid, new Map());
        pending.get(pid).set(field, value);
        inputEl.closest('td').classList.add('edited');
        updatePendingBadge();
      }

      function clearPendingFor(pid, field){
        if(!pending.has(pid)) return;
        const m = pending.get(pid);
        m.delete(field);
        if(m.size === 0) pending.delete(pid);
        updatePendingBadge();
      }

      function clearAllPendingVisual(){
        tableEl.querySelectorAll('td.edited').forEach(td=>td.classList.remove('edited'));
      }

      function updatePendingBadge(){
        let cnt = 0;
        pending.forEach(m=>cnt += m.size);
        if(cnt>0){
          pendingBadge.textContent = cnt + " تغييرات";
          pendingBadge.style.display = 'inline-block';
        }else{
          pendingBadge.style.display = 'none';
        }
      }

      function showSaved(){
        savedBadge.style.display = 'inline-block';
        clearTimeout(showSaved._t);
        showSaved._t = setTimeout(()=>{ savedBadge.style.display = 'none'; }, 1200);
      }

      function recalcRowTotal(row){
        const q = parseInt((row.querySelector('td[data-field="quantity"] input')?.value || '0'), 10) || 0;
        const sp = parseFloat((row.querySelector('td[data-field="selling_price"] input')?.value || '0')) || 0;
        const td = row.querySelector('td[data-field="row_total"]');
        if(td){
          td.textContent = (sp*q).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        }
      }

      function applyView(mode){
        const wrapper = tableEl.closest('.table-responsive');
        const isExpanded = (mode === 'expanded');
        tableEl.classList.toggle('expanded-on', isExpanded);
        localStorage.setItem(VIEW_KEY, isExpanded ? 'expanded' : 'compact');

        if (window.jQuery && window.jQuery.fn && jQuery.fn.DataTable && jQuery.fn.DataTable.isDataTable('#inventory-table')) {
          jQuery('#inventory-table').DataTable().columns.adjust().draw(false);
        }
        if (wrapper) wrapper.scrollLeft = 0;

        btnExpanded.classList.toggle('btn-secondary', isExpanded);
        btnExpanded.classList.toggle('btn-outline-secondary', !isExpanded);
        btnCompact.classList.toggle('btn-secondary', !isExpanded);
        btnCompact.classList.toggle('btn-outline-secondary', isExpanded);
        btnExpanded.setAttribute('aria-pressed', isExpanded ? 'true' : 'false');
        btnCompact.setAttribute('aria-pressed', isExpanded ? 'false' : 'true');
      }

      tableEl.addEventListener('input', function(e){
        const input = e.target;
        if (!(input instanceof HTMLInputElement)) return;
        const cell = input.closest('td[data-field]');
        const row  = input.closest('tr[data-product]');
        if (!cell || !row) return;
        const pid = Number(row.dataset.product);
        const field = cell.dataset.field;
        let value = input.value;
        if (field === 'quantity'){
          value = String(Math.max(0, parseInt(value || '0', 10) || 0));
        }
        if (['purchase_price','selling_price','price','cost_before_shipping','cost_after_shipping','unit_price_before_tax','min_price','max_price','tax_rate','weight'].includes(field)){
          value = String(parseFloat(value || '0') || 0);
        }
        setPending(pid, field, value, input);
        if (field === 'quantity' || field === 'selling_price') recalcRowTotal(row);
      });

      btnCompact.addEventListener('click', function(e){ e.preventDefault(); applyView('compact'); });
      btnExpanded.addEventListener('click', function(e){ e.preventDefault(); applyView('expanded'); });

      async function sendUpdate(pid, field, value){
        const row = tableEl.querySelector(`tr[data-product="${pid}"]`);
        const cell = row ? row.querySelector(`td[data-field="${field}"]`) : null;
        if (cell) cell.classList.add('cell-saving');
        try{
          const res = await fetch(updateUrl, {
            method: 'POST',
            headers: {'Content-Type':'application/json','X-CSRFToken': csrfToken},
            body: JSON.stringify({product_id: pid, field: field, value: value})
          });
          const data = await res.json();
          if (!res.ok || !data.ok) throw new Error(data.message || 'error');
          if (cell) {
            cell.classList.remove('edited');
            clearPendingFor(pid, field);
          }
          if (row && (field === 'quantity' || field === 'selling_price')){
            recalcRowTotal(row);
          }
        } finally {
          if (cell) cell.classList.remove('cell-saving');
        }
      }

      btnSave.addEventListener('click', async function(){
        btnSave.disabled = true;
        try{
          const tasks = [];
          pending.forEach((fields, pid)=>{
            fields.forEach((val, field)=>{
              tasks.push({pid, field, val});
            });
          });
          for (const t of tasks){
            await sendUpdate(t.pid, t.field, t.val);
          }
          showSaved();
          clearAllPendingVisual();
        } catch(e){
          alert('تعذر الحفظ');
        } finally {
          btnSave.disabled = false;
        }
      });

if (window.jQuery && $.fn.DataTable) {
  const dt = $('#inventory-table').DataTable({
    pageLength: 50,
    order: [[3, 'asc']],
    scrollX: true,
    scrollCollapse: true,
    autoWidth: false,
    orderMulti: false,
    orderCellsTop: true,
    language: { url: '{{ url_for("static", filename="datatables/Arabic.json") }}' }
  });

  // حدّث الأعمدة بعد التبديل بين مبسطة/موسعة
  document.getElementById('btnCompact')?.addEventListener('click', () => {
    document.getElementById('inventory-table').classList.remove('expanded-on');
    dt.columns.adjust().draw(false);
  });
  document.getElementById('btnExpanded')?.addEventListener('click', () => {
    document.getElementById('inventory-table').classList.add('expanded-on');
    dt.columns.adjust().draw(false);
  });
}

      const initial = localStorage.getItem(VIEW_KEY) || 'compact';
      applyView(initial === 'expanded' ? 'expanded' : 'compact');
    })();
  </script>
{% endblock %}
