{% extends 'shop/base.html' %}

{% block title %}{{ 'تعديل منتج' if product else 'إضافة منتج' }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">
<style>
  .card{border-radius:1rem;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  .card-body{padding:2rem}
  .form-label{font-weight:600;color:#1a237e}
  .form-control,.form-select{border-radius:0.6rem}
  .btn-primary{background:linear-gradient(135deg,#1a237e,#311b92);border:none;font-weight:bold}
  .btn-primary:hover{background:linear-gradient(135deg,#283593,#4527a0)}
  .badge-status{font-size:.85rem;padding:.35em .75em;border-radius:.65rem}
  .badge-active{background:linear-gradient(135deg,#43cea2,#185a9d);color:#fff}
  .badge-inactive{background:#ccc;color:#333}
  .btn-ghost{border:1px solid #e0e0e0;background:#fafafa}
  .btn-ghost:hover{background:#f0f0f0}
  .small-muted{font-size:.85rem;color:#6b7280}
  .online-thumb{width:88px;height:88px;object-fit:cover;border-radius:.75rem;border:1px solid #e5e7eb;background:#fff}
  .inline-spinner{display:inline-flex;align-items:center;gap:.5rem}
  .inline-spinner i{animation:spin 1s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">
    {{ 'تعديل منتج' if product else 'إضافة منتج' }}
    {% if product %}
      {% if product.is_active %}
        <span id="prod-status-badge" class="badge badge-status badge-active">مفعل</span>
      {% else %}
        <span id="prod-status-badge" class="badge badge-status badge-inactive">غير مفعل</span>
      {% endif %}
    {% endif %}
  </h1>
  <div class="d-flex align-items-center gap-2 ms-auto">
    {% if has_any('manage_shop','manage_inventory') and product %}
      <button id="toggle-active-btn"
              type="button"
              class="btn btn-ghost"
              data-toggle-url="{{ url_for('shop.admin_product_toggle_active', pid=product.id) }}">
        {% if product.is_active %}<i class="fas fa-pause me-1"></i> تعطيل{% else %}<i class="fas fa-play me-1"></i> تفعيل{% endif %}
      </button>
    {% endif %}
    {% if has_any('manage_shop','manage_inventory') %}
      <a href="{{ url_for('shop.admin_products') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right me-1"></i> الرجوع لإدارة المنتجات
      </a>
    {% endif %}
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-lg-8">

    {% if has_any('manage_shop','manage_inventory') and product %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <label class="form-label">تعديل سريع: الاسم</label>
            <input id="quick-name" type="text" class="form-control" value="{{ product.name or '' }}" autocomplete="off" maxlength="255">
          </div>
          <div class="col-md-4">
            <label class="form-label">تعديل سريع: السعر</label>
            <input id="quick-price" type="text" class="form-control" inputmode="decimal" pattern="[0-9]+([.,٫][0-9]{1,2})?" value="{{ '{:.2f}'.format(product.price or 0) }}">
            <div class="small-muted mt-1">استخدم فاصلة أو نقطة. سيتم التحويل تلقائيًا.</div>
          </div>
          <div class="col-md-2 d-grid">
            <button id="quick-update-btn"
                    type="button"
                    class="btn btn-primary"
                    data-update-url="{{ url_for('shop.admin_product_update_fields', pid=product.id) }}">
              <i class="fas fa-bolt me-1"></i> تحديث
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card">
      <div class="card-body">
        <form id="product-form" method="POST" novalidate>
          {{ form.hidden_tag() }}
          
          <!-- حقول الصور المخفية -->
          {{ form.image(style="display: none;") }}
          {{ form.online_image(style="display: none;") }}

          <div class="mb-3">
            <label for="{{ form.name.id }}" class="form-label">اسم المنتج</label>
            {{ form.name(class="form-control", placeholder="اسم واضح ومختصر") }}
            {% if form.name.errors %}
              <div class="text-danger small mt-1">{{ form.name.errors | join(', ') }}</div>
            {% endif %}
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="{{ form.price.id }}" class="form-label">السعر (شيكل)</label>
              {{ form.price(class="form-control", id=form.price.id, inputmode="decimal", autocomplete="off", pattern="[0-9]+([.,٫][0-9]{1,2})?", step="0.01", min="0") }}
              {% if form.price.errors %}
                <div class="text-danger small mt-1">{{ form.price.errors | join(', ') }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ form.condition.id }}" class="form-label">الحالة</label>
              {{ form.condition(class="form-select", id=form.condition.id) }}
              {% if form.condition.errors %}
                <div class="text-danger small mt-1">{{ form.condition.errors | join(', ') }}</div>
              {% endif %}
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label for="{{ form.category_id.id }}" class="form-label">الفئة</label>
            <div class="input-group">
              {{ form.category_id(class="form-control", id=form.category_id.id, required=True) }}
              <button type="button"
                      class="btn btn-outline-primary"
                      id="btn-add-category"
                      data-bs-toggle="modal"
                      data-bs-target="#quickCategoryModal">+</button>
            </div>
            {% if form.category_id.errors %}
              <div class="text-danger small mt-1">{{ form.category_id.errors | join(', ') }}</div>
            {% endif %}
          </div>

          <div class="mb-3 form-check">
            {{ form.is_active(class="form-check-input", id="is_active") }}
            <label class="form-check-label" for="is_active">مفعل</label>
          </div>

          {% if has_any('manage_shop','manage_inventory') %}
        <div class="mb-3">
          <label class="form-label d-block">صورة المنتج الرئيسية</label>
          <div class="d-flex align-items-center gap-3">
            {% if product and product.image %}
              {% set main_img_src = product.image if product.image.startswith('http') or product.image.startswith('/') else url_for('static', filename=product.image) %}
              <img id="main-thumb" class="online-thumb" src="{{ main_img_src }}" alt="preview"
                   onerror="this.onerror=null;this.src='{{ url_for('static', filename='products/default.png') }}'">
            {% else %}
              <img id="main-thumb" class="online-thumb" src="{{ url_for('static', filename='products/default.png') }}" alt="preview">
            {% endif %}
            <div class="d-grid gap-2 flex-grow-1">
              <input id="main-file" type="file" accept="image/*" style="display: none;">
              <button id="btn-upload-main" type="button" class="btn btn-primary btn-lg">
                <i class="fas fa-cloud-upload-alt me-2"></i> رفع صورة المنتج
              </button>
              <div class="small text-muted" id="main-image-url" dir="ltr" style="max-width:260px;word-break:break-all;">
                {{ product.image or 'لم يتم رفع صورة بعد' }}
              </div>
            </div>
          </div>
        </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary py-2">
              <i class="fas fa-save me-1"></i> حفظ
            </button>
          </div>
          {% endif %}
        </form>
      </div>
    </div>

    {% if product and has_any('manage_shop','manage_inventory') %}
    {% set _img = product.online_image or product.image %}
    {% set _img_is_abs = _img and (_img.startswith('http') or _img.startswith('/')) %}
    {% if _img %}
      {% if _img_is_abs %}
        {% set _img_src = _img %}
      {% else %}
        {% set _img_src = url_for('static', filename=_img) %}
      {% endif %}
    {% else %}
      {% set _img_src = url_for('static', filename='products/default.png') %}
    {% endif %}

    <div class="card mt-3" id="online-panel"
         data-pid="{{ product.id }}"
         data-list-url="{{ url_for('warehouse_bp.list') }}?type=ONLINE&format=json"
         data-products-url-template="/warehouses/PLACEHOLDER/products?format=json"
         data-upload-url="{{ url_for('warehouse_bp.api_upload_product_image') }}"
         data-update-inline-url-template="/warehouses/PLACEHOLDER1/products/PLACEHOLDER2/update">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0"><i class="fas fa-globe me-2"></i> إدارة الأونلاين</h2>
          <span id="online-warehouse-badge" class="badge bg-secondary">...</span>
        </div>

        <div id="online-alert" class="alert alert-warning d-none">
          لا يوجد مستودع أونلاين. أنشئ واحدًا من
          <a href="{{ url_for('warehouse_bp.list') }}" class="alert-link">قائمة المستودعات</a>.
        </div>

        <div id="online-form" class="row g-3 align-items-center">
          <div class="col-12 col-md-4">
            <label class="form-label">سعر الأونلاين (شيكل)</label>
            <input id="online-price" type="text" class="form-control" inputmode="decimal" pattern="[0-9]+([.,٫][0-9]{1,2})?" placeholder="0.00">
            <div class="small-muted mt-1">إن لم تُدخل قيمة، لن نغيّر السعر.</div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">كمية مستودع الأونلاين</label>
            <input id="online-qty" type="number" min="0" step="1" class="form-control" placeholder="0">
            <div class="small-muted mt-1">القيمة تُحفظ كقيمة مطلقة (Set).</div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label d-block">صورة الأونلاين</label>
            <div class="d-flex align-items-center gap-3">
              <img id="online-thumb" class="online-thumb" src="{{ _img_src }}" alt="preview"
                   onerror="this.onerror=null;this.src='{{ url_for('static', filename='products/default.png') }}'">
              <div class="d-grid gap-2 flex-grow-1">
                <input id="online-file" type="file" accept="image/*" style="display: none;">
                <button id="btn-upload-online" type="button" class="btn btn-info btn-lg">
                  <i class="fas fa-cloud-upload-alt me-2"></i> رفع صورة الأونلاين
                </button>
                <div class="small text-muted" id="online-image-url" dir="ltr" style="max-width:260px;word-break:break-all;">
                  {{ product.online_image or 'لم يتم رفع صورة بعد' }}
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="d-flex gap-2">
              <button id="btn-save-online" type="button" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> حفظ إعدادات الأونلاين
              </button>
              <div id="online-status" class="small text-muted"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if product %}
    <div class="alert alert-info mt-3 shadow-sm">
      <i class="fas fa-info-circle me-2"></i>
      <strong>ملاحظة:</strong> أي تعديل يتم حفظه بعد الضغط على "حفظ".
      <hr>
      <div class="small text-muted">المعرف: {{ product.id }}</div>
      <div class="small text-muted">أُنشئ في: {{ product.created_at.strftime('%Y-%m-%d %H:%M') if product.created_at else '-' }}</div>
    </div>
    {% endif %}

  </div>
</div>

<div class="modal fade" id="quickCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="quick-category-form"
          class="modal-content"
          method="post"
          action="{{ url_for('shop.admin_categories_quick_create') }}"
          data-url="{{ url_for('shop.admin_categories_quick_create') }}">
      <div class="modal-header">
        <h5 class="modal-title">إضافة فئة</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
          <label class="form-label">اسم الفئة *</label>
          <input type="text" name="name" id="qc-name" class="form-control" required>
        </div>
        <div class="text-muted small">سيتم اختيار الفئة تلقائيًا بعد إنشائها.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="submit" class="btn btn-primary">حفظ وإختيار</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}
