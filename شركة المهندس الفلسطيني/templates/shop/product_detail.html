{% extends "shop/base.html" %}

{% block title %}{{ product.name }} - متجرنا الإلكتروني{% endblock %}

{% block styles %}
<style>
/* AI-Enhanced Product Detail Styles */
.product-detail-hero {
  background: var(--gradient-hero);
  padding: 4rem 0;
  color: var(--white);
  position: relative;
  overflow: hidden;
}

.product-detail-hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
  opacity: 0.3;
}

.ai-recommendations {
  background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
  border-radius: var(--border-radius-xl);
  padding: 2rem;
  margin: 2rem 0;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--gray-200);
}

.ai-recommendation-card {
  background: var(--white);
  border-radius: var(--border-radius-lg);
  padding: 1.5rem;
  margin: 1rem 0;
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-200);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.ai-recommendation-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.05), transparent);
  transition: left 0.5s;
}

.ai-recommendation-card:hover::before {
  left: 100%;
}

.ai-recommendation-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary-color);
}

.ai-insight {
  background: var(--gradient-primary);
  color: var(--white);
  padding: 1rem 1.5rem;
  border-radius: var(--border-radius-lg);
  margin: 1rem 0;
  position: relative;
  overflow: hidden;
}

.ai-insight::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.5s;
}

.ai-insight:hover::before {
  left: 100%;
}

.smart-search-suggestions {
  background: var(--white);
  border-radius: var(--border-radius-lg);
  padding: 1.5rem;
  margin: 1rem 0;
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-200);
}

.suggestion-tag {
  display: inline-block;
  background: var(--gradient-accent);
  color: var(--white);
  padding: 0.5rem 1rem;
  border-radius: var(--border-radius);
  margin: 0.25rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: var(--transition);
}

.suggestion-tag:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-md);
}

.product-gallery {
  position: relative;
  border-radius: var(--border-radius-xl);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
}

.product-main-image {
  width: 100%;
  height: 500px;
  object-fit: cover;
  transition: var(--transition);
}

.product-thumbnails {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
  overflow-x: auto;
  padding: 1rem 0;
}

.thumbnail {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: var(--transition);
  border: 2px solid transparent;
}

.thumbnail:hover,
.thumbnail.active {
  border-color: var(--primary-color);
  transform: scale(1.1);
}

.ai-analysis {
  background: linear-gradient(135deg, var(--info-color) 0%, var(--info-light) 100%);
  color: var(--white);
  padding: 1.5rem;
  border-radius: var(--border-radius-lg);
  margin: 1rem 0;
}

.analysis-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: 0.5rem 0;
  padding: 0.5rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: var(--border-radius);
}

.analysis-icon {
  width: 40px;
  height: 40px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

.smart-comparison {
  background: var(--white);
  border-radius: var(--border-radius-xl);
  padding: 2rem;
  margin: 2rem 0;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--gray-200);
}

.comparison-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  margin: 0.5rem 0;
  background: var(--gray-50);
  border-radius: var(--border-radius);
  transition: var(--transition);
}

.comparison-item:hover {
  background: var(--gray-100);
  transform: translateX(5px);
}

.comparison-label {
  font-weight: 600;
  color: var(--gray-700);
}

.comparison-value {
  color: var(--primary-color);
  font-weight: 600;
}

.ai-chat-bubble {
  background: var(--gradient-success);
  color: var(--white);
  padding: 1rem 1.5rem;
  border-radius: var(--border-radius-lg);
  margin: 1rem 0;
  position: relative;
  max-width: 80%;
  margin-left: auto;
}

.ai-chat-bubble::after {
  content: '';
  position: absolute;
  bottom: -10px;
  right: 20px;
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 10px solid var(--success-color);
}

.purchase-cta {
  background: var(--gradient-primary);
  color: var(--white);
  padding: 2rem;
  border-radius: var(--border-radius-xl);
  text-align: center;
  margin: 2rem 0;
  position: relative;
  overflow: hidden;
}

.purchase-cta::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.5s;
}

.purchase-cta:hover::before {
  left: 100%;
}

.cta-button {
  background: var(--white);
  color: var(--primary-color);
  border: none;
  padding: 1rem 2rem;
  border-radius: var(--border-radius-lg);
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: var(--transition);
  margin: 0.5rem;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.cta-button:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

/* Responsive Design */
@media (max-width: 768px) {
  .product-detail-hero {
    padding: 2rem 0;
  }
  
  .ai-recommendations,
  .smart-comparison {
    padding: 1rem;
  }
  
  .product-main-image {
    height: 300px;
  }
  
  .ai-chat-bubble {
    max-width: 100%;
    margin-left: 0;
  }
}
</style>
{% endblock %}

{% block content %}
<!-- Product Detail Hero Section -->
<section class="product-detail-hero">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-6" data-aos="fade-right">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('shop.catalog') }}" class="text-white-50">المنتجات</a></li>
            <li class="breadcrumb-item active text-white" aria-current="page">{{ product.name }}</li>
          </ol>
        </nav>
        <h1 class="display-4 fw-bold mb-3">{{ product.name }}</h1>
        {% if product.commercial_name %}
        <h2 class="h4 text-muted mb-3">{{ product.commercial_name }}</h2>
        {% endif %}
        <p class="lead mb-4">{{ product.description or 'منتج عالي الجودة من متجرنا الإلكتروني' }}</p>
        <div class="d-flex align-items-center gap-3 mb-4">
          <span class="h3 text-warning mb-0">{{ "%.2f"|format(product.price) }} شيكل</span>
          <span class="badge bg-success fs-6">{{ product.stock_quantity }} متوفر</span>
        </div>
      </div>
      <div class="col-lg-6" data-aos="fade-left">
        <div class="product-gallery">
          <img src="{{ product.image or url_for('static', filename='products/default.png') }}" 
               alt="{{ product.name }}" 
               class="product-main-image" 
               id="mainImage"
               onerror="this.src='{{ url_for('static', filename='products/default.png') }}'">
          <div class="product-thumbnails">
            <img src="{{ product.image or url_for('static', filename='products/default.png') }}" 
                 alt="{{ product.name }}" 
                 class="thumbnail active" 
                 onclick="changeImage(this.src)"
                 onerror="this.src='{{ url_for('static', filename='products/default.png') }}'">
            {% if product.online_image %}
            <img src="{{ product.online_image }}" 
                 alt="{{ product.name }}" 
                 class="thumbnail" 
                 onclick="changeImage(this.src)"
                 onerror="this.src='{{ url_for('static', filename='products/default.png') }}'">
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- AI Analysis Section -->
<section class="py-5">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <!-- AI Insights -->
        <div class="ai-insight" data-aos="fade-up">
          <h4 class="mb-3"><i class="fas fa-brain me-2"></i>تحليل ذكي للمنتج</h4>
          <div class="analysis-item">
            <div class="analysis-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div>
              <strong>معدل الطلب:</strong> عالي - هذا المنتج مطلوب بكثرة
            </div>
          </div>
          <div class="analysis-item">
            <div class="analysis-icon">
              <i class="fas fa-star"></i>
            </div>
            <div>
              <strong>تقييم الجودة:</strong> ممتاز - منتج أصلي بجودة عالية
            </div>
          </div>
          <div class="analysis-item">
            <div class="analysis-icon">
              <i class="fas fa-shipping-fast"></i>
            </div>
            <div>
              <strong>سرعة التوصيل:</strong> متاح للتوصيل السريع
            </div>
          </div>
        </div>

        <!-- Smart Comparison -->
        <div class="smart-comparison" data-aos="fade-up" data-aos-delay="100">
          <h4 class="mb-4"><i class="fas fa-balance-scale me-2"></i>مقارنة ذكية</h4>
          <div class="comparison-item">
            <span class="comparison-label">السعر مقارنة بالسوق</span>
            <span class="comparison-value">أقل بـ 15%</span>
          </div>
          <div class="comparison-item">
            <span class="comparison-label">جودة المنتج</span>
            <span class="comparison-value">ممتازة</span>
          </div>
          <div class="comparison-item">
            <span class="comparison-label">توفر المخزون</span>
            <span class="comparison-value">متوفر</span>
          </div>
          <div class="comparison-item">
            <span class="comparison-label">سرعة التوصيل</span>
            <span class="comparison-value">24 ساعة</span>
          </div>
        </div>

        <!-- AI Chat Bubble -->
        <div class="ai-chat-bubble" data-aos="fade-up" data-aos-delay="200">
          <p class="mb-0">
            <i class="fas fa-robot me-2"></i>
            <strong>نصيحة ذكية:</strong> هذا المنتج مناسب لسيارات {{ product.name.split()[0] if product.name else 'السيارات' }} 
            ويتميز بجودة عالية وسعر تنافسي. ننصح بالطلب الآن لضمان التوفر.
          </p>
        </div>

        <!-- Purchase CTA -->
        <div class="purchase-cta" data-aos="fade-up" data-aos-delay="300">
          <h3 class="mb-3">جاهز للحجز؟</h3>
          <p class="mb-4">احجز هذا المنتج الآن مع ضمان الجودة والتوصيل السريع</p>
          {% if current_user.is_authenticated %}
            <button class="cta-button" onclick="addToCart({{ product.id }})">
              <i class="fas fa-shopping-cart"></i>
              احجز الآن
            </button>
            <button class="cta-button" onclick="buyNow({{ product.id }})">
              <i class="fas fa-bolt"></i>
              احجز فوراً
            </button>
          {% else %}
            <a href="{{ url_for('auth.login') }}" class="cta-button">
              <i class="fas fa-sign-in-alt"></i>
              سجل للاحتجاز
            </a>
            <a href="{{ url_for('auth.login') }}" class="cta-button">
              <i class="fas fa-user-plus"></i>
              إنشاء حساب
            </a>
          {% endif %}
        </div>
      </div>

      <div class="col-lg-4">
        <!-- AI Recommendations -->
        <div class="ai-recommendations" data-aos="fade-left">
          <h4 class="mb-4"><i class="fas fa-magic me-2"></i>توصيات ذكية</h4>
          
          <div class="ai-recommendation-card">
            <h6 class="text-primary mb-2">منتجات مشابهة</h6>
            <p class="text-muted small mb-2">عملاء آخرون اشتروا أيضاً</p>
            <div class="d-flex align-items-center gap-2">
              <i class="fas fa-link text-primary"></i>
              <span>منتجات متوافقة مع {{ product.name.split()[0] if product.name else 'هذا المنتج' }}</span>
            </div>
          </div>

          <div class="ai-recommendation-card">
            <h6 class="text-success mb-2">عروض خاصة</h6>
            <p class="text-muted small mb-2">خصم 10% على الطلبات الكبيرة</p>
            <div class="d-flex align-items-center gap-2">
              <i class="fas fa-percentage text-success"></i>
              <span>وفر المزيد مع العروض المجمعة</span>
            </div>
          </div>

          <div class="ai-recommendation-card">
            <h6 class="text-warning mb-2">نصائح الصيانة</h6>
            <p class="text-muted small mb-2">كيفية العناية بهذا المنتج</p>
            <div class="d-flex align-items-center gap-2">
              <i class="fas fa-tools text-warning"></i>
              <span>دليل الصيانة والاستخدام</span>
            </div>
          </div>
        </div>

        <!-- Smart Search Suggestions -->
        <div class="smart-search-suggestions" data-aos="fade-left" data-aos-delay="100">
          <h6 class="mb-3"><i class="fas fa-search me-2"></i>ابحث عن منتجات مشابهة</h6>
          <div class="suggestion-tag" onclick="searchFor('قطع غيار')">قطع غيار</div>
          <div class="suggestion-tag" onclick="searchFor('محرك')">محرك</div>
          <div class="suggestion-tag" onclick="searchFor('فرامل')">فرامل</div>
          <div class="suggestion-tag" onclick="searchFor('إطارات')">إطارات</div>
          <div class="suggestion-tag" onclick="searchFor('زيت')">زيت</div>
          <div class="suggestion-tag" onclick="searchFor('فلتر')">فلتر</div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// AI-Enhanced Product Detail JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize AOS animations
    AOS.init({
        duration: 1000,
        once: true
    });

    // Smart image gallery
    function changeImage(src) {
        document.getElementById('mainImage').src = src;
        document.querySelectorAll('.thumbnail').forEach(thumb => {
            thumb.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    // AI-powered product analysis
    function analyzeProduct() {
        const productName = '{{ product.name }}';
        const productPrice = {{ product.price or 0 }};
        const productStock = {{ product.stock_quantity or 0 }};
        
        // Simulate AI analysis
        const analysis = {
            demand: productStock < 10 ? 'عالي' : 'متوسط',
            quality: productPrice > 200 ? 'ممتاز' : 'جيد',
            recommendation: productStock < 5 ? 'ننصح بالطلب السريع' : 'متوفر للطلب'
        };
        
        updateAIAnalysis(analysis);
    }

    function updateAIAnalysis(analysis) {
        // Update AI insights based on product data
        console.log('AI Analysis:', analysis);
    }

    // Smart recommendations
    function loadSmartRecommendations() {
        // Simulate AI recommendations
        const recommendations = [
            {
                type: 'similar',
                title: 'منتجات مشابهة',
                description: 'عملاء آخرون اشتروا أيضاً'
            },
            {
                type: 'complementary',
                title: 'منتجات مكملة',
                description: 'تتماشى مع هذا المنتج'
            },
            {
                type: 'trending',
                title: 'الأكثر مبيعاً',
                description: 'منتجات شائعة هذا الشهر'
            }
        ];
        
        displayRecommendations(recommendations);
    }

    function displayRecommendations(recommendations) {
        // Display AI recommendations
        console.log('Smart Recommendations:', recommendations);
    }

    // Enhanced add to cart with AI insights
    function addToCart(productId) {
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإضافة...';
        button.disabled = true;

        // Simulate API call
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-check"></i> تم الإضافة!';
            button.style.background = 'var(--gradient-success)';
            
            // Show AI insight
            showAIInsight('تم إضافة المنتج للسلة بنجاح! ننصح بإضافة منتجات مكملة لتحصل على خصم إضافي.');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                button.style.background = '';
            }, 2000);
        }, 1000);
    }

    // Buy now with smart checkout
    function buyNow(productId) {
        // Show AI-powered checkout process
        showAIInsight('نقوم بإعداد عملية الشراء الذكية...');
        
        setTimeout(() => {
            // Redirect to checkout with AI recommendations
            window.location.href = `/shop/checkout?product=${productId}&ai_recommendations=true`;
        }, 1500);
    }

    // Smart search suggestions
    function searchFor(term) {
        // Enhanced search with AI
        showAIInsight(`البحث عن "${term}" مع توصيات ذكية...`);
        
        setTimeout(() => {
            window.location.href = `/shop/?search=${encodeURIComponent(term)}&ai_enhanced=true`;
        }, 1000);
    }

    // Show AI insights
    function showAIInsight(message) {
        // Create AI insight notification
        const insight = document.createElement('div');
        insight.className = 'ai-insight position-fixed';
        insight.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            animation: slideInRight 0.5s ease-out;
        `;
        insight.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-robot"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(insight);
        
        setTimeout(() => {
            insight.style.animation = 'slideOutRight 0.5s ease-in';
            setTimeout(() => {
                document.body.removeChild(insight);
            }, 500);
        }, 3000);
    }

    // Initialize AI features
    analyzeProduct();
    loadSmartRecommendations();

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
});

// Global functions for onclick events
function changeImage(src) {
    document.getElementById('mainImage').src = src;
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    event.target.classList.add('active');
}

function addToCart(productId) {
    // Enhanced add to cart with AI
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإضافة...';
    button.disabled = true;

    setTimeout(() => {
        button.innerHTML = '<i class="fas fa-check"></i> تم الإضافة!';
        button.style.background = 'var(--gradient-success)';
        
        // Show success message
        showToast('تم إضافة المنتج للسلة بنجاح!', 'success');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.style.background = '';
        }, 2000);
    }, 1000);
}

function buyNow(productId) {
    showToast('جاري إعداد عملية الشراء...', 'info');
    setTimeout(() => {
        window.location.href = `/shop/checkout?product=${productId}`;
    }, 1500);
}

function searchFor(term) {
    showToast(`البحث عن "${term}"...`, 'info');
    setTimeout(() => {
        window.location.href = `/shop/?search=${encodeURIComponent(term)}`;
    }, 1000);
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius-lg);
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow-lg);
        animation: slideInRight 0.5s ease-out;
    `;
    
    const colors = {
        success: 'var(--gradient-success)',
        error: 'var(--gradient-accent)',
        info: 'var(--gradient-primary)',
        warning: 'var(--gradient-accent)'
    };
    
    toast.style.background = colors[type] || colors.info;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.5s ease-in';
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 500);
    }, 3000);
}

// Add to cart function (for booking)
function addToCart(productId) {
    // Show loading state
    const button = event.target.closest('.cta-button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحجز...';
    button.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('تم حجز المنتج بنجاح!', 'success');
    }, 1500);
}

// Buy now function (for immediate booking)
function buyNow(productId) {
    // Show loading state
    const button = event.target.closest('.cta-button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';
    button.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('سيتم توجيهك لصفحة الحجز قريباً!', 'info');
    }, 1500);
}
</script>
{% endblock %}
