<form id="noteForm" method="post"
      action="{{ url_for('notes_bp.create_note') if mode != 'edit' else url_for('notes_bp.update_note', note_id=note_id) }}"
      novalidate autocomplete="off">

  {{ form.hidden_tag() }}
  {% if form.entity_type is defined %}{{ form.entity_type(type="hidden") }}{% endif %}
  {% if form.entity_id   is defined %}{{ form.entity_id(type="hidden") }}{% endif %}

  <div class="mb-3">
    <label class="form-label d-flex justify-content-between align-items-center">
      <span>{{ form.content.label.text }}</span>
      <small class="text-muted"><span id="charCount">0</span>/1000</small>
    </label>
    {{ form.content(class="form-control autosize", rows=3, placeholder="أضف ملاحظة…", dir="auto", maxlength="1000") }}
    {% for e in form.content.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.priority.label(class="form-label") }}
      {{ form.priority(class="custom-select") }}
      {% for e in form.priority.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-6 mb-3 d-flex align-items-center">
      <div class="form-check">
        {{ form.is_pinned(class="form-check-input", id="isPinned") }}
        <label class="form-check-label ms-2" for="isPinned">{{ form.is_pinned.label.text }}</label>
        {% for e in form.is_pinned.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
    </div>
  </div>

  <!-- حقول جديدة للمستهدفين والإشعارات -->
  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.target_type.label(class="form-label") }}
      {{ form.target_type(class="custom-select") }}
      {% for e in form.target_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.target_ids.label(class="form-label") }}
      {{ form.target_ids(class="form-control") }}
      {% for e in form.target_ids.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.notification_type.label(class="form-label") }}
      {{ form.notification_type(class="custom-select") }}
      {% for e in form.notification_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.notification_date.label(class="form-label") }}
      {{ form.notification_date(class="form-control") }}
      {% for e in form.notification_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
  </div>

  <div class="d-flex justify-content-center gap-2 mt-2">
    {{ form.submit(class="btn btn-primary px-4") }}
    <button type="button" class="btn btn-outline-secondary px-4" data-dismiss="modal">إلغاء</button>
  </div>
</form>

<script>
(function () {
  var ta = document.querySelector('#noteForm textarea[name="content"]');
  var cnt = document.getElementById('charCount');
  if (!ta || !cnt) return;
  function update() { cnt.textContent = ta.value.length; }
  function resize() { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; }
  ta.addEventListener('input', update);
  ta.addEventListener('input', resize);
  ta.addEventListener('change', resize);
  update(); setTimeout(resize, 0);
})();
</script>
