{% extends "base.html" %}

{% block title %}Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©{% endblock %}
{% block page_header %}Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item">
    <a href="{{ url_for('main.dashboard') }}">
      <i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </a>
  </li>
  <li class="breadcrumb-item active">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</li>
{% endblock %}

{% block content %}
<div class="content">

  {% set PRIORITY_LABELS = {
    'LOW':'Ù…Ù†Ø®ÙØ¶Ø©','MEDIUM':'Ù…ØªÙˆØ³Ø·Ø©','HIGH':'Ø¹Ø§Ù„ÙŠØ©','URGENT':'Ø¹Ø§Ø¬Ù„Ø©'
  } %}
  {% set STATUS_LABELS = {
    'PENDING':'Ù…Ø¹Ù„Ù‘Ù‚','DIAGNOSIS':'ØªØ´Ø®ÙŠØµ','IN_PROGRESS':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
    'COMPLETED':'Ù…ÙƒØªÙ…Ù„','CANCELLED':'Ù…Ù„ØºÙŠ','ON_HOLD':'Ù…Ø¤Ø¬Ù‘Ù„'
  } %}
  {% set PRIORITY_COLORS = {
    'LOW':'info','MEDIUM':'warning','HIGH':'danger','URGENT':'dark'
  } %}
  {% set STATUS_COLORS = {
    'PENDING':'secondary','DIAGNOSIS':'info','IN_PROGRESS':'primary',
    'COMPLETED':'success','CANCELLED':'danger','ON_HOLD':'warning'
  } %}

  {% if current_user.has_permission('manage_service') %}
  <div class="card border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card-body text-white">
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="d-flex gap-2">
          <a href="{{ url_for('service.create_request') }}" class="btn btn-light fw-bold">
            <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯
          </a>
          <button id="bulkArchive" class="btn btn-outline-light" disabled title="Ù‚Ø§Ø¯Ù…">
            <i class="fas fa-archive"></i> Ø£Ø±Ø´ÙØ© Ø¬Ù…Ø§Ø¹ÙŠ
          </button>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button id="exportCsv" class="btn btn-outline-light">
            <i class="fas fa-file-csv"></i> ØªØµØ¯ÙŠØ± CSV
          </button>
      </div>
    </div>
  </div>
  {% endif %}

  {% if stats %}
  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ù…Ø­Ø³Ù‘Ù†Ø© -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø©</h6>
              <h3 class="mb-0 fw-bold">{{ stats.pending }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-clock fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</h6>
              <h3 class="mb-0 fw-bold">{{ stats.high_priority }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-bolt fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h6>
              <h3 class="mb-0 fw-bold">{{ stats.in_progress }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-tools fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">Ù…ÙƒØªÙ…Ù„Ø©</h6>
              <h3 class="mb-0 fw-bold">{{ stats.completed }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card card-outline card-secondary mb-3">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
      <div class="card-tools">
        <button class="btn btn-tool" data-card-widget="collapse">
          <i class="fas fa-minus"></i>
        </button>
      </div>
    </div>

    <div class="card-body">
      <form class="row g-3 align-items-end" method="get" action="{{ url_for('service.list_requests') }}">

        <div class="col-12">
          <div class="row g-3">
            <div class="col-md-6">
              <fieldset class="chip-fieldset">
                <legend><i class="fas fa-traffic-light"></i> Ø§Ù„Ø­Ø§Ù„Ø©</legend>
                {% set selected_status = filter_values.status or [] %}
                {% set status_opts = ['PENDING','DIAGNOSIS','IN_PROGRESS','COMPLETED','CANCELLED','ON_HOLD'] %}
                <div class="chip-group">
                  {% for st in status_opts %}
                    <input class="btn-check" type="checkbox" name="status" id="st_{{st}}" value="{{st}}" {% if st in selected_status %}checked{% endif %}>
                    <label class="btn btn-sm btn-outline-{{ STATUS_COLORS.get(st,'secondary') }} {% if st in selected_status %}active{% endif %}" for="st_{{st}}">
                      {{ STATUS_LABELS.get(st, st) }}
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
            </div>

            <div class="col-md-6">
              <fieldset class="chip-fieldset">
                <legend><i class="fas fa-bolt"></i> Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</legend>
                {% set selected_pri = filter_values.priority or [] %}
                {% set pri_opts = ['LOW','MEDIUM','HIGH','URGENT'] %}
                <div class="chip-group">
                  {% for pr in pri_opts %}
                    <input class="btn-check" type="checkbox" name="priority" id="pr_{{pr}}" value="{{pr}}" {% if pr in selected_pri %}checked{% endif %}>
                    <label class="btn btn-sm btn-outline-{{ PRIORITY_COLORS.get(pr,'secondary') }} {% if pr in selected_pri %}active{% endif %}" for="pr_{{pr}}">
                      {{ PRIORITY_LABELS.get(pr, pr) }}
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6 col-xl-4">
          <label for="customer" class="form-label"><i class="fas fa-user"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø³Ù…/Ø¬ÙˆØ§Ù„)</label>
          <input id="customer" name="customer" class="form-control" value="{{ filter_values.customer or '' }}" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡Ù‹Ø§ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„">
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="mechanic" class="form-label"><i class="fas fa-user-cog"></i> Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ</label>
          <select id="mechanic" name="mechanic" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for m in mechanics %}
              <option value="{{ m.username }}" {% if filter_values.mechanic==m.username %}selected{% endif %}>{{ m.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="vrn" class="form-label"><i class="fas fa-car"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
          <input id="vrn" name="vrn" class="form-control" value="{{ filter_values.vrn or '' }}" placeholder="VRN">
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="date" class="form-label"><i class="fas fa-calendar-day"></i> Ø§Ù„Ø²Ù…Ù†</label>
          <select id="date" name="date" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="today" {% if filter_values.date=='today' %}selected{% endif %}>Ø§Ù„ÙŠÙˆÙ…</option>
            <option value="week"  {% if filter_values.date=='week' %}selected{% endif %}>Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
            <option value="month" {% if filter_values.date=='month' %}selected{% endif %}>Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="sort" class="form-label"><i class="fas fa-sort-amount-down"></i> ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
          <select id="sort" name="sort" class="form-select">
            <option value="received_at" {% if filter_values.sort=='received_at' or not filter_values.sort %}selected{% endif %}>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
            <option value="priority" {% if filter_values.sort=='priority' %}selected{% endif %}>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</option>
            <option value="status" {% if filter_values.sort=='status' %}selected{% endif %}>Ø§Ù„Ø­Ø§Ù„Ø©</option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="order" class="form-label"><i class="fas fa-exchange-alt"></i> Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label>
          <select id="order" name="order" class="form-select">
            <option value="desc" {% if filter_values.order=='desc' or not filter_values.order %}selected{% endif %}>ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="asc" {% if filter_values.order=='asc' %}selected{% endif %}>ØªØµØ§Ø¹Ø¯ÙŠ</option>
          </select>
        </div>

        <div class="col-12 col-xl-2">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search"></i> ØªØµÙÙŠØ©
          </button>
        </div>

      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-list"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        <span class="badge bg-primary ms-2">{{ pagination.total }} Ø·Ù„Ø¨</span>
      </h3>
    </div>
    <div class="card-body table-responsive p-0">
      <table id="servicesTable" class="table table-hover table-striped mb-0">
        <thead class="table-light">
          <tr>
            {% if current_user.has_permission('manage_service') %}
              <th style="width:42px"><input type="checkbox" id="selectAll"></th>
            {% endif %}
            <th><i class="fas fa-hashtag"></i> Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
            <th><i class="fas fa-user"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th><i class="fas fa-id-card"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th>
            <th><i class="fas fa-bolt"></i> Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th>
            <th><i class="fas fa-traffic-light"></i> Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th style="width:260px"><i class="fas fa-ellipsis-h"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% if requests %}
            {% for s in requests %}
            <tr>
              {% if current_user.has_permission('manage_service') %}
                <td><input type="checkbox" class="row-select" value="{{ s.id }}"></td>
              {% endif %}
              <td class="text-nowrap"><i class="fas fa-receipt text-muted"></i> {{ s.service_number }}</td>
              <td>{{ s.customer.name if s.customer else (s.name or 'â€”') }}</td>
              <td class="text-nowrap">{{ s.vehicle_vrn or 'â€”' }}</td>
              <td>
                {% set p = (s.priority.value if s.priority is not string else s.priority)|upper %}
                <span class="badge badge-status bg-{{ priority_colors.get(p, 'secondary') }}">
                  {{ priority_labels.get(p, p) }}
                </span>
              </td>
              <td>
                {% set st = (s.status.value if s.status is not string else s.status)|upper %}
                {% set STATUS_COLORS = {
                  'PENDING':'secondary','DIAGNOSIS':'info','IN_PROGRESS':'primary',
                  'COMPLETED':'success','CANCELLED':'danger','ON_HOLD':'warning'
                } %}
                <span class="badge badge-status bg-{{ STATUS_COLORS.get(st,'secondary') }}">
                  {{ status_labels.get(st, st) }}
                </span>
              </td>
              <td class="d-flex flex-wrap gap-1">
                <a href="{{ url_for('service.view_request', rid=s.id) }}" class="btn btn-info btn-sm">
                  <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                </a>
                <a href="{{ url_for('service.view_receipt', rid=s.id) }}" class="btn btn-outline-secondary btn-sm" target="_blank">
                  <i class="fas fa-print"></i> Ø¥ÙŠØµØ§Ù„
                </a>
                {% if s.is_archived %}
                <button type="button" class="btn btn-success btn-sm" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø©" onclick="console.log('ğŸ”˜ [TEMPLATE] ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø±Ù‚Ù…: {{ s.id }}'); restoreService({{ s.id }})">
                  <i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                </button>
                {% else %}
                <button type="button" class="btn btn-warning btn-sm" title="Ø£Ø±Ø´ÙØ©" onclick="console.log('ğŸ”˜ [TEMPLATE] ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø£Ø±Ø´ÙØ© Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø±Ù‚Ù…: {{ s.id }}'); archiveService({{ s.id }})">
                  <i class="fas fa-archive"></i> Ø£Ø±Ø´ÙØ©
                </button>
                {% endif %}
                {% if current_user.has_permission('manage_service') %}
                <a href="{{ url_for('hard_delete_bp.hard_delete_service', service_id=s.id) }}" class="btn btn-danger btn-sm" title="Ø­Ø°Ù Ù‚ÙˆÙŠ">
                  <i class="fas fa-trash-alt"></i>
                </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØµÙŠØ§Ù†Ø©
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    
    {% if pagination and pagination.pages > 1 %}
    <div class="card-footer">
      <nav aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('service.list_requests', page=pagination.prev_num, **filter_values) if pagination.has_prev else '#' }}">
              <i class="fas fa-chevron-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
            </a>
          </li>
          
          {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('service.list_requests', page=p, **filter_values) }}">{{ p }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
          {% endfor %}
          
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('service.list_requests', page=pagination.next_num, **filter_values) if pagination.has_next else '#' }}">
              Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-chevron-left"></i>
            </a>
          </li>
        </ul>
      </nav>
      <div class="text-center text-muted mt-2">
        <small>Ø¹Ø±Ø¶ {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - {{ min(pagination.page * pagination.per_page, pagination.total) }} Ù…Ù† {{ pagination.total }}</small>
      </div>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- DataTables Ù…Ø¹Ø·Ù‘Ù„ Ù„Ø£Ù† Ù„Ø¯ÙŠÙ†Ø§ Pagination server-side -->
  <!-- <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script> -->
  <script src="{{ url_for('static', filename='js/service.js') }}"></script>
  <script>
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø±Ø´ÙØ© Ù…ØªÙˆÙØ±Ø© Ø§Ù„Ø¢Ù† ÙÙŠ archive.js
    console.log('ğŸ“‹ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© - ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø±Ø´ÙØ© Ù…ØªÙˆÙØ±Ø©');
  </script>
{% endblock %}
