{% extends 'base.html' %}
{% block title %}ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù…{% endblock %}
{% block page_title %}ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù… (Format){% endblock %}

{% block extra_css %}
<style>
  .cleanup-section {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    background: #f8f9fa;
  }
  .cleanup-section-header {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
  }
  .table-checkbox {
    padding: 12px;
    border-radius: 8px;
    transition: all 0.3s;
    border: 1px solid transparent;
  }
  .table-checkbox:hover {
    background: #fff;
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
  }
  .table-checkbox input:checked ~ label {
    font-weight: bold;
    color: #dc3545;
  }
  .stats-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 20px;
  }
  .stats-box h3 {
    font-size: 2.5rem;
    margin: 0;
  }
  .stats-box p {
    margin: 5px 0 0 0;
    opacity: 0.9;
  }
  .confirm-box {
    background: #fff3cd;
    border: 3px solid #ffc107;
    padding: 25px;
    border-radius: 10px;
    margin: 20px 0;
  }
  .danger-zone {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .action-buttons {
    position: sticky;
    bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    z-index: 100;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <!-- ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ± -->
  <div class="danger-zone">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle fa-3x me-3"></i>
      <div>
        <h4 class="mb-1">âš ï¸ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ± Ø¬Ø¯Ø§Ù‹!</h4>
        <p class="mb-0">Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§! ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.</p>
      </div>
    </div>
  </div>

  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h3 id="selected-count">0</h3>
        <p>Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø¯Ø¯</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h3>{{ tables|length }}</h3>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
        <h3 id="high-danger-count">0</h3>
        <p>Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
        <h3>âš ï¸</h3>
        <p>ØªØ­Ø°ÙŠØ± Ù†Ø´Ø·</p>
      </div>
    </div>
  </div>

  <div class="card shadow">
    <div class="card-header bg-gradient-danger text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-broom me-2"></i>
          ØªÙ†Ø¸ÙŠÙ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
        </h5>
        <div>
          <button type="button" class="btn btn-light btn-sm" onclick="selectAll()">
            <i class="fas fa-check-double"></i> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" onclick="deselectAll()">
            <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
          </button>
          <button type="button" class="btn btn-warning btn-sm" onclick="selectHighDanger()">
            <i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø®Ø·Ø±Ø© ÙÙ‚Ø·
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <form method="POST" id="cleanup-form" onsubmit="return confirmCleanup();">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        {% set tables_by_group = {} %}
        {% for table in tables %}
          {% set group = table.get('group', 'Ø£Ø®Ø±Ù‰') %}
          {% if group not in tables_by_group %}
            {% set _ = tables_by_group.update({group: []}) %}
          {% endif %}
          {% set _ = tables_by_group[group].append(table) %}
        {% endfor %}

        <!-- Ø¹Ø±Ø¶ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ -->
        {% set current_group = None %}
        {% set group_index = 0 %}
        
        {% for table in tables %}
          {% set table_group = '' %}
          
          {# ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ #}
          {% if loop.index0 < 3 %}
            {% set table_group = 'users' %}
            {% set group_title = 'ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø±' %}
            {% set group_icon = 'fas fa-users text-primary' %}
          {% elif loop.index0 < 11 %}
            {% set table_group = 'logs' %}
            {% set group_title = 'ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' %}
            {% set group_icon = 'fas fa-clipboard-list text-info' %}
          {% elif loop.index0 < 17 %}
            {% set table_group = 'financial' %}
            {% set group_title = 'ğŸ’° Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©' %}
            {% set group_icon = 'fas fa-money-bill-wave text-success' %}
          {% elif loop.index0 < 22 %}
            {% set table_group = 'sales' %}
            {% set group_title = 'ğŸ›ï¸ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©' %}
            {% set group_icon = 'fas fa-shopping-cart text-warning' %}
          {% elif loop.index0 < 25 %}
            {% set table_group = 'stock' %}
            {% set group_title = 'ğŸ“Š Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„ØªØ¨Ø§Ø¯Ù„Ø§Øª' %}
            {% set group_icon = 'fas fa-boxes text-primary' %}
          {% elif loop.index0 < 27 %}
            {% set table_group = 'preorders' %}
            {% set group_title = 'ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª' %}
            {% set group_icon = 'fas fa-calendar-check text-info' %}
          {% elif loop.index0 < 30 %}
            {% set table_group = 'shipments' %}
            {% set group_title = 'ğŸšš Ø§Ù„Ø´Ø­Ù†Ø§Øª ÙˆØ§Ù„ØªØ³ÙˆÙŠØ§Øª' %}
            {% set group_icon = 'fas fa-truck text-secondary' %}
          {% elif loop.index0 < 33 %}
            {% set table_group = 'entities' %}
            {% set group_title = 'ğŸ‘¥ Ø§Ù„Ø¬Ù‡Ø§Øª (Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹!)' %}
            {% set group_icon = 'fas fa-user-friends text-danger' %}
          {% elif loop.index0 < 36 %}
            {% set table_group = 'warehouses' %}
            {% set group_title = 'ğŸª Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª' %}
            {% set group_icon = 'fas fa-warehouse text-danger' %}
          {% elif loop.index0 < 38 %}
            {% set table_group = 'loans' %}
            {% set group_title = 'ğŸ’³ Ø§Ù„Ù‚Ø±ÙˆØ¶' %}
            {% set group_icon = 'fas fa-handshake text-warning' %}
          {% elif loop.index0 < 40 %}
            {% set table_group = 'invoices' %}
            {% set group_title = 'ğŸ“„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±' %}
            {% set group_icon = 'fas fa-file-invoice text-primary' %}
          {% elif loop.index0 < 42 %}
            {% set table_group = 'relations' %}
            {% set group_title = 'ğŸ”— Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª' %}
            {% set group_icon = 'fas fa-link text-secondary' %}
          {% elif loop.index0 < 45 %}
            {% set table_group = 'settings' %}
            {% set group_title = 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚' %}
            {% set group_icon = 'fas fa-cog text-info' %}
          {% elif loop.index0 < 47 %}
            {% set table_group = 'accounting' %}
            {% set group_title = 'ğŸ“š Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©' %}
            {% set group_icon = 'fas fa-book text-success' %}
          {% else %}
            {% set table_group = 'other' %}
            {% set group_title = 'ğŸ“ Ø£Ø®Ø±Ù‰' %}
            {% set group_icon = 'fas fa-folder text-muted' %}
          {% endif %}
          
          {# ÙØªØ­ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© #}
          {% if table_group != current_group %}
            {% if current_group %}
              </div> {# Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© #}
            {% endif %}
            
            {% set current_group = table_group %}
            {% set is_danger_zone = table_group in ['entities', 'warehouses'] %}
            
            <div class="cleanup-section {% if is_danger_zone %}border-danger{% endif %}" 
                 {% if is_danger_zone %}style="border-color: #dc3545; background: #fff5f5;"{% endif %}>
              <div class="cleanup-section-header {% if is_danger_zone %}text-danger{% endif %}">
                <i class="{{ group_icon }}"></i> {{ group_title }}
              </div>
              {% if is_danger_zone %}
              <div class="alert alert-danger mb-3">
                <i class="fas fa-skull-crossbones me-2"></i>
                <strong>Ø§Ù†ØªØ¨Ù‡!</strong> Ù‡Ø°Ù‡ Ù…Ù†Ø·Ù‚Ø© Ø®Ø·Ø±Ø© Ø¬Ø¯Ø§Ù‹ - Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ù‡Ù†Ø§ Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!
              </div>
              {% endif %}
          {% endif %}
          
          {# Ø¹Ø±Ø¶ checkbox Ø§Ù„Ø¬Ø¯ÙˆÙ„ #}
          <div class="form-check table-checkbox">
            <input class="form-check-input table-item" type="checkbox" name="tables" 
                   value="{{ table.name }}" id="table_{{ loop.index }}" 
                   data-danger="{{ table.danger }}">
            <label class="form-check-label w-100" for="table_{{ loop.index }}">
              <span class="me-2">{{ table.display }}</span>
              {% if table.danger == 'high' %}
                <span class="badge bg-danger">Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ ğŸ”´</span>
              {% elif table.danger == 'medium' %}
                <span class="badge bg-warning text-dark">Ø®Ø·Ø± Ù…ØªÙˆØ³Ø· ğŸŸ¡</span>
              {% else %}
                <span class="badge bg-success">Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶ ğŸŸ¢</span>
              {% endif %}
            </label>
          </div>
          
          {# Ø¥ØºÙ„Ø§Ù‚ Ø¢Ø®Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© #}
          {% if loop.last %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
        <div class="confirm-box">
          <h5 class="text-warning mb-3">
            <i class="fas fa-shield-alt me-2"></i>
            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
          </h5>
          
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-keyboard me-1"></i>
              Ø§ÙƒØªØ¨ <code class="text-danger fs-5">FORMAT_SYSTEM</code> Ù„Ù„ØªØ£ÙƒÙŠØ¯ *
            </label>
            <input type="text" name="confirm" id="confirm-input" class="form-control form-control-lg" 
                   placeholder="FORMAT_SYSTEM" required autocomplete="off">
            <small class="text-muted">ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­</small>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="double-confirm" required>
            <label class="form-check-label fw-bold" for="double-confirm">
              <i class="fas fa-check-circle me-1"></i>
              Ø£Ø¤ÙƒØ¯ Ø£Ù†Ù†ÙŠ Ù‚Ù…Øª Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙˆØ£ØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
            </label>
          </div>

          <div id="preview-box" class="alert alert-info" style="display: none;">
            <h6><i class="fas fa-eye me-2"></i>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</h6>
            <div id="preview-content"></div>
          </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="action-buttons">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <button type="submit" class="btn btn-danger btn-lg" id="submit-btn" disabled>
                <i class="fas fa-trash-alt me-2"></i>
                ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
              </button>
              <a href="{{ url_for('security.index') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-right me-2"></i>
                Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©
              </a>
            </div>
            <div class="text-end">
              <small class="text-muted d-block">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ now().strftime('%Y-%m-%d %H:%M') }}</small>
              <small class="text-danger d-block">âš ï¸ Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ Ø±Ø¬Ø¹Ø© ÙÙŠÙ‡Ø§</small>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>

</div>

<script>
// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
function updateCounters() {
  const checked = document.querySelectorAll('.table-item:checked');
  const highDanger = Array.from(checked).filter(cb => cb.dataset.danger === 'high');
  
  document.getElementById('selected-count').textContent = checked.length;
  document.getElementById('high-danger-count').textContent = highDanger.length;
  
  // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  const confirmInput = document.getElementById('confirm-input').value;
  const doubleConfirm = document.getElementById('double-confirm').checked;
  const submitBtn = document.getElementById('submit-btn');
  
  if (checked.length > 0 && confirmInput === 'FORMAT_SYSTEM' && doubleConfirm) {
    submitBtn.disabled = false;
  } else {
    submitBtn.disabled = true;
  }
  
  // Ù…Ø¹Ø§ÙŠÙ†Ø©
  if (checked.length > 0) {
    const preview = Array.from(checked).map(cb => {
      const label = document.querySelector(`label[for="${cb.id}"]`);
      return `<li>${label.textContent.trim()}</li>`;
    }).join('');
    document.getElementById('preview-content').innerHTML = `<ul class="mb-0">${preview}</ul>`;
    document.getElementById('preview-box').style.display = 'block';
  } else {
    document.getElementById('preview-box').style.display = 'none';
  }
}

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„
function selectAll() {
  document.querySelectorAll('.table-item').forEach(cb => cb.checked = true);
  updateCounters();
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
function deselectAll() {
  document.querySelectorAll('.table-item').forEach(cb => cb.checked = false);
  updateCounters();
}

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·Ø±Ø© ÙÙ‚Ø·
function selectHighDanger() {
  document.querySelectorAll('.table-item').forEach(cb => {
    cb.checked = cb.dataset.danger === 'high';
  });
  updateCounters();
}

// ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
function confirmCleanup() {
  const checked = document.querySelectorAll('.table-item:checked');
  const count = checked.length;
  
  if (count === 0) {
    alert('âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!');
    return false;
  }
  
  const confirmText = document.getElementById('confirm-input').value;
  if (confirmText !== 'FORMAT_SYSTEM') {
    alert('âŒ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© "FORMAT_SYSTEM" Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ù„ØªØ£ÙƒÙŠØ¯!');
    return false;
  }
  
  const message = `âš ï¸ ØªØ­Ø°ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ!\n\nØ£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø­Ø°Ù ${count} Ø¬Ø¯ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ 100%ØŸ`;
  return confirm(message);
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.table-item').forEach(cb => {
    cb.addEventListener('change', updateCounters);
  });
  
  document.getElementById('confirm-input').addEventListener('input', updateCounters);
  document.getElementById('double-confirm').addEventListener('change', updateCounters);
  
  updateCounters();
});
</script>

{% endblock %}
