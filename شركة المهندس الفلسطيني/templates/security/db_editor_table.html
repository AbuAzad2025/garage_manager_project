{% extends 'base.html' %}
{% block title %}ØªØ­Ø±ÙŠØ± {{ table_name }}{% endblock %}
{% block page_title %}âœï¸ ØªØ­Ø±ÙŠØ± Ø¬Ø¯ÙˆÙ„: {{ table_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <div class="alert alert-warning border-0 shadow-sm">
    <i class="fas fa-exclamation-triangle"></i> <strong>ØªØ­Ø°ÙŠØ±:</strong> ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ <code>{{ table_name }}</code> - ÙƒÙ† Ø­Ø°Ø±Ø§Ù‹!
  </div>
  
  <div class="mb-3">
    <a href="{{ url_for('security.db_editor') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Ø±Ø¬ÙˆØ¹
    </a>
    <button class="btn btn-action-add" data-bs-toggle="modal" data-bs-target="#addColumnModal">
      <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯
    </button>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRowModal">
      <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ
    </button>
    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
      <i class="fas fa-edit"></i> ØªØ­Ø¯ÙŠØ« Ø¬Ù…Ø§Ø¹ÙŠ
    </button>
    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#fillMissingModal">
      <i class="fas fa-fill"></i> Ù…Ù„Ø¡ Ù†Ø§Ù‚Øµ
    </button>
    <a href="{{ url_for('security.db_schema_editor', table_name=table_name) }}" class="btn btn-dark">
      <i class="fas fa-cogs"></i> Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    </a>
  </div>

  <div class="card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ({{ data|length }} ØµÙ)</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive" style="max-height:600px; overflow:auto;">
        <table class="table table-sm table-bordered table-hover" id="dataTable">
          <thead class="table-dark sticky-top">
            <tr>
              {% for col in columns %}
              <th>
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ col }}</span>
                  {% if col not in ['id', 'created_at', 'updated_at'] %}
                  <button type="button" class="btn btn-danger btn-sm" 
                          onclick="deleteColumn('{{ col }}')" 
                          title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯"
                          style="padding: 2px 6px; font-size: 10px;">
                    <i class="fas fa-times"></i>
                  </button>
                  {% endif %}
                </div>
              </th>
              {% endfor %}
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØµÙ</th>
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
            <tr>
              {% for col in columns %}
              <td class="editable-td{% if col != 'id' %} can-edit{% endif %}" 
                  data-row-id="{{ row.get('id', '') or row.get('code', '') or row.get('name', '') }}" 
                  data-column="{{ col }}"
                  data-value="{{ row[col] }}"
                  ondblclick="makeEditable(this)"
                  title="{% if col != 'id' %}Ø§Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„{% endif %}"
                  style="{% if col != 'id' %}cursor: pointer; {% endif %}position: relative;">
                <small>{{ row[col] }}</small>
                {% if col != 'id' %}
                <i class="fas fa-edit text-muted" style="font-size: 10px; opacity: 0.3; position: absolute; top: 2px; left: 2px;"></i>
                {% endif %}
              </td>
              {% endfor %}
              <td>
                <div class="btn-group btn-group-sm">
                  {% set row_key = row.get('id', '') or row.get('code', '') or row.get('name', '') %}
                  <button class="btn btn-warning" onclick="editRow('{{ row_key }}', {{ row|tojson }})">
                    <i class="fas fa-edit"></i>
                  </button>
                  <form method="POST" action="{{ url_for('security.db_delete_row', table_name=table_name, row_id=row_key) }}" style="display:inline;" onsubmit="return confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal: Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ -->
<div class="modal fade" id="addColumnModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('security.db_add_column', table_name=table_name) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</label>
            <input type="text" name="column_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
            <select name="column_type" class="form-select">
              <option value="TEXT">TEXT</option>
              <option value="INTEGER">INTEGER</option>
              <option value="REAL">REAL</option>
              <option value="BOOLEAN">BOOLEAN</option>
              <option value="DATETIME">DATETIME</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
            <input type="text" name="default_value" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-success">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Ø¥Ø¶Ø§ÙØ© ØµÙ -->
<div class="modal fade" id="addRowModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('security.db_add_row', table_name=table_name) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {% for col in columns %}
          {% if col != 'id' %}
          <div class="mb-3">
            <label class="form-label">{{ col }}</label>
            <input type="text" name="{{ col }}" class="form-control">
          </div>
          {% endif %}
          {% endfor %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: ØªØ­Ø¯ÙŠØ« Ø¬Ù…Ø§Ø¹ÙŠ -->
<div class="modal fade" id="bulkUpdateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('security.db_bulk_update', table_name=table_name) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">ØªØ­Ø¯ÙŠØ« Ø¬Ù…Ø§Ø¹ÙŠ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¹Ù…ÙˆØ¯</label>
            <select name="column" class="form-select" required>
              {% for col in columns %}
              <option value="{{ col }}">{{ col }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ÙØ§Ø±Øº = NULL)</label>
            <input type="text" name="old_value" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
            <input type="text" name="new_value" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-warning">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Ù…Ù„Ø¡ Ù†Ø§Ù‚Øµ -->
<div class="modal fade" id="fillMissingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('security.db_fill_missing', table_name=table_name) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¹Ù…ÙˆØ¯</label>
            <select name="column" class="form-select" required>
              {% for col in columns %}
              <option value="{{ col }}">{{ col }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ù„Ù…Ù„Ø¡</label>
            <input type="text" name="fill_value" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-info">Ù…Ù„Ø¡</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: ØªØ¹Ø¯ÙŠÙ„ ØµÙ -->
<div class="modal fade" id="editRowModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" id="editRowForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ ØµÙ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="editRowBody">
          <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-warning">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ©
function makeEditable(cell) {
  const rowId = cell.dataset.rowId;
  const column = cell.dataset.column;
  const currentValue = cell.dataset.value || cell.textContent.trim();
  
  console.log('Double click detected:', {rowId, column, currentValue});
  
  if (column === 'id') {
    console.log('Cannot edit ID column');
    return;
  }
  
  if (!rowId) {
    console.log('No row identifier found, trying alternative approach...');
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ù†ÙØ³Ù‡Ø§ ÙƒÙ…ÙØªØ§Ø­
    const alternativeId = currentValue;
    cell.dataset.rowId = alternativeId;
  }
  
  console.log('Making cell editable...');
  
  // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  cell.dataset.originalValue = currentValue;
  
  // Ø¥Ù†Ø´Ø§Ø¡ input
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentValue;
  input.className = 'form-control form-control-sm';
  input.style.width = '100%';
  
  // Ù…Ø³Ø­ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ù„ÙŠØ©
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  input.select();
  
  // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ø£Ùˆ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²
  const saveEdit = async () => {
    const newValue = input.value;
    
    if (newValue === cell.dataset.originalValue) {
      // Ù„Ø§ ØªØºÙŠÙŠØ± - Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ
      restoreCell(cell, currentValue);
      return;
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ±ÙØ±
    try {
      const response = await fetch(`/security/db-editor/update-cell/{{ table_name }}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
          row_id: rowId,
          column: column,
          value: newValue
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        cell.dataset.value = newValue;
        restoreCell(cell, newValue);
        cell.style.backgroundColor = '#d4edda';
        setTimeout(() => {
          cell.style.backgroundColor = '';
        }, 1000);
      } else {
        // ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        alert('Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'));
        restoreCell(cell, currentValue);
      }
    } catch (error) {
      console.error('Error updating cell:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      restoreCell(cell, currentValue);
    }
  };
  
  input.addEventListener('blur', saveEdit);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      saveEdit();
    } else if (e.key === 'Escape') {
      restoreCell(cell, currentValue);
    }
  });
}

function restoreCell(cell, value) {
  const column = cell.dataset.column;
  const rowId = cell.dataset.rowId;
  
  cell.innerHTML = `<small>${value}</small>`;
  if (column !== 'id' && rowId) {
    cell.innerHTML += `<i class="fas fa-edit text-muted" style="font-size: 10px; opacity: 0.3; position: absolute; top: 2px; left: 2px;"></i>`;
  }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¨Ø± Modal (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
function editRow(rowId, rowData) {
  const form = document.getElementById('editRowForm');
  form.action = `/security/db-editor/edit-row/{{ table_name }}/${rowId}`;
  
  const body = document.getElementById('editRowBody');
  body.innerHTML = '';
  
  {% for col in columns %}
  const div{{ loop.index }} = document.createElement('div');
  div{{ loop.index }}.className = 'mb-3';
  div{{ loop.index }}.innerHTML = `
    <label class="form-label">{{ col }}</label>
    <input type="text" name="{{ col }}" class="form-control" value="${rowData['{{ col }}'] || ''}" ${'{{ col }}' === 'id' ? 'readonly' : ''}>
  `;
  body.appendChild(div{{ loop.index }});
  {% endfor %}
  
  new bootstrap.Modal(document.getElementById('editRowModal')).show();
}

// Ø­Ø°Ù Ø¹Ù…ÙˆØ¯ ÙƒØ§Ù…Ù„
function deleteColumn(columnName) {
  if (confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±!\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ "${columnName}" Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!\n\nØ§Ø¶ØºØ· OK Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ùˆ Cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡.`)) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/security/db-editor/delete-column/{{ table_name }}`;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    
    const columnInput = document.createElement('input');
    columnInput.type = 'hidden';
    columnInput.name = 'column_name';
    columnInput.value = columnName;
    
    form.appendChild(csrfInput);
    form.appendChild(columnInput);
    document.body.appendChild(form);
    form.submit();
  }
}

// ØªÙ„Ù…ÙŠØ­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
document.addEventListener('DOMContentLoaded', function() {
  const editableCells = document.querySelectorAll('.editable-td[ondblclick]');
  if (editableCells.length > 0) {
    console.log(`âœ… ${editableCells.length} Ø®Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„. Ø§Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ù„ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„!`);
  }
  
  // Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù…ÙŠØ­ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©
  console.log('ğŸ’¡ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± (X) ÙÙŠ header Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù„Ø­Ø°ÙÙ‡');
  console.log('ğŸ’¡ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø£Ø­Ù…Ø± ÙÙŠ Ø§Ù„ØµÙ Ù„Ø­Ø°Ù Ø§Ù„ØµÙ ÙƒØ§Ù…Ù„Ø§Ù‹');
});
</script>
{% endblock %}

