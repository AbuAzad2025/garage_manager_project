{% extends "base.html" %}

{% block title %}كشف مفصل للشريك - {{ partner.name }}{% endblock %}

{% block content %}
<div class="content-wrapper py-4 px-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-handshake text-primary me-2"></i>
            كشف مفصل للشريك: {{ partner.name }}
        </h2>
        <div class="btn-group">
            <a href="{{ url_for('reports_bp.partners_report') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-1"></i>
                العودة للقائمة
            </a>
            <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="fas fa-print me-1"></i>
                طباعة
            </button>
        </div>
    </div>

    <!-- معلومات الشريك -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>معلومات الشريك</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>الاسم:</strong> {{ partner.name }}<br>
                            <strong>الهاتف:</strong> {{ partner.phone or 'غير محدد' }}<br>
                            <strong>البريد الإلكتروني:</strong> {{ partner.email or 'غير محدد' }}
                        </div>
                        <div class="col-sm-6">
                            <strong>الرصيد الحالي:</strong> 
                            <span class="badge {% if current_balance >= 0 %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                {{ current_balance|format_currency }}
                            </span><br>
                            <strong>نسبة المشاركة:</strong> {{ partner.share_percentage or 0 }}%<br>
                            <strong>العنوان:</strong> {{ partner.address or 'غير محدد' }}<br>
                            <strong>القطع المتاحة:</strong> {{ partner.available_items_count or 0 }} قطعة
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ملخص الإجماليات</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <div class="border-end">
                                <strong class="text-danger">إجمالي المدفوعات</strong><br>
                                <span class="fs-5">{{ total_payments|format_currency }}</span>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <strong class="text-success">إجمالي الطلبات المسبقة</strong><br>
                            <span class="fs-5">{{ total_preorders|format_currency }}</span>
                        </div>
                        <div class="col-6">
                            <strong class="text-warning">إجمالي قطع الغيار</strong><br>
                            <span class="fs-5">{{ total_service_parts|format_currency }}</span>
                        </div>
                        <div class="col-6">
                            <strong class="text-info">إجمالي المصاريف</strong><br>
                            <span class="fs-5">{{ total_expenses|format_currency }}</span>
                        </div>
                        <div class="col-6">
                            <strong class="text-primary">حصة الشريك</strong><br>
                            <span class="fs-5">{{ partner_share|format_currency }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فلتر التاريخ -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="start" class="form-label">من تاريخ</label>
                    <input type="date" class="form-control" id="start" name="start" value="{{ start_date }}">
                </div>
                <div class="col-md-4">
                    <label for="end" class="form-label">إلى تاريخ</label>
                    <input type="date" class="form-control" id="end" name="end" value="{{ end_date }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>تصفية
                    </button>
                    <a href="{{ url_for('reports_bp.partner_detail_report', partner_id=partner.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>إلغاء
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- المدفوعات -->
    {% if payments %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="fas fa-credit-card me-2"></i>
                المدفوعات للشريك ({{ payments|length }} دفعة)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>رقم الدفعة</th>
                            <th>التاريخ</th>
                            <th>البيان</th>
                            <th>المبلغ</th>
                            <th>الحالة</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.id }}</td>
                            <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else 'غير محدد' }}</td>
                            <td>سداد {{ payment.method or 'نقداً' }} للشريك</td>
                            <td>{{ payment.total_amount|format_currency }}</td>
                            <td>
                                <span class="badge bg-{% if payment.status == 'COMPLETED' %}success{% elif payment.status == 'PENDING' %}warning{% else %}danger{% endif %}">
                                    {{ payment.status }}
                                </span>
                            </td>
                            <td>{{ payment.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- الطلبات المسبقة -->
    {% if preorders %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-shopping-bag me-2"></i>
                الطلبات المسبقة ({{ preorders|length }} طلب)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>رقم الطلب</th>
                            <th>التاريخ</th>
                            <th>البيان</th>
                            <th>الكمية</th>
                            <th>المبلغ</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for preorder in preorders %}
                        <tr>
                            <td>{{ preorder.id }}</td>
                            <td>{{ preorder.created_at.strftime('%Y-%m-%d') if preorder.created_at else 'غير محدد' }}</td>
                            <td>حصة شريك في حجز: {{ preorder.product.name if preorder.product else 'منتج' }} - عميل: {{ preorder.customer.name if preorder.customer else 'غير محدد' }}</td>
                            <td>{{ preorder.quantity }}</td>
                            <td>{{ preorder.total_amount|format_currency }}</td>
                            <td>
                                <span class="badge bg-{% if preorder.status == 'CONFIRMED' %}success{% elif preorder.status == 'PENDING' %}warning{% else %}secondary{% endif %}">
                                    {{ preorder.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- قطع الغيار في طلبات الصيانة -->
    {% if service_parts %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-cogs me-2"></i>
                قطع الغيار في طلبات الصيانة ({{ service_parts|length }} قطعة)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>رقم الطلب</th>
                            <th>التاريخ</th>
                            <th>البيان</th>
                            <th>الكمية</th>
                            <th>المجموع</th>
                            <th>نسبة المشاركة</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sp in service_parts %}
                        <tr>
                            <td>{{ sp.service_id }}</td>
                            <td>{{ sp.created_at.strftime('%Y-%m-%d') if sp.created_at else 'غير محدد' }}</td>
                            <td>حصة شريك في قطعة: {{ sp.part.name if sp.part else 'غير محدد' }} - صيانة رقم {{ sp.service_id }}</td>
                            <td>{{ sp.quantity }}</td>
                            <td>{{ (sp.quantity * sp.unit_price)|format_currency }}</td>
                            <td><span class="badge bg-primary">{{ sp.share_percentage or 0 }}%</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- المصاريف -->
    {% if expenses %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-receipt me-2"></i>
                المصاريف ({{ expenses|length }} مصروف)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>رقم المصروف</th>
                            <th>التاريخ</th>
                            <th>البيان</th>
                            <th>المبلغ</th>
                            <th>الوصف</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in expenses %}
                        <tr>
                            <td>{{ expense.id }}</td>
                            <td>{{ expense.date.strftime('%Y-%m-%d') if expense.date else 'غير محدد' }}</td>
                            <td>مصروف شريك: {{ expense.category or 'عام' }} - {{ expense.description[:50] if expense.description else 'بدون وصف' }}</td>
                            <td>{{ expense.amount|format_currency }}</td>
                            <td>{{ expense.description or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- قسم القطع والحركات -->
    {% if partner_items %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>القطع والحركات</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>القيمة</th>
                            <th>المستودع</th>
                            <th>آخر حركة</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in partner_items %}
                        <tr>
                            <td>
                                <strong>{{ item.product_name }}</strong>
                                {% if item.product_sku %}
                                <br><small class="text-muted">SKU: {{ item.product_sku }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ item.quantity or 0 }}</span>
                            </td>
                            <td>{{ item.unit_price|format_currency }}</td>
                            <td>{{ item.total_value|format_currency }}</td>
                            <td>{{ item.warehouse_name or 'غير محدد' }}</td>
                            <td>{{ item.last_movement_date.strftime('%Y-%m-%d') if item.last_movement_date else 'غير محدد' }}</td>
                            <td>{{ item.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- رسالة في حالة عدم وجود بيانات -->
    {% if not payments and not preorders and not service_parts and not expenses and not partner_items %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">لا توجد معاملات في الفترة المحددة</h5>
            <p class="text-muted">لم يتم العثور على أي معاملات للشريك في الفترة المحددة.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
