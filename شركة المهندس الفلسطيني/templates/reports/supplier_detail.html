{% extends "base.html" %}

{% block title %}كشف مفصل للمورد - {{ supplier.name }}{% endblock %}

{% block content %}
<div class="content-wrapper py-4 px-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-truck text-primary me-2"></i>
            كشف مفصل للمورد: {{ supplier.name }}
        </h2>
        <div class="btn-group">
            <a href="{{ url_for('reports_bp.suppliers_report') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-1"></i>
                العودة للقائمة
            </a>
            <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="fas fa-print me-1"></i>
                طباعة
            </button>
        </div>
    </div>

    <!-- معلومات المورد -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>معلومات المورد</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>الاسم:</strong> {{ supplier.name }}<br>
                            <strong>الهاتف:</strong> {{ supplier.phone or 'غير محدد' }}<br>
                            <strong>البريد الإلكتروني:</strong> {{ supplier.email or 'غير محدد' }}
                        </div>
                        <div class="col-sm-6">
                            <strong>الرصيد الحالي:</strong> 
                            <span class="badge {% if current_balance >= 0 %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                {{ current_balance|format_currency }}
                            </span><br>
                            <strong>العنوان:</strong> {{ supplier.address or 'غير محدد' }}<br>
                            <strong>ملاحظات:</strong> {{ supplier.notes or 'لا توجد' }}<br>
                            <strong>القطع المتاحة:</strong> {{ supplier.available_items_count or 0 }} قطعة
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ملخص الإجماليات</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <div class="border-end">
                                <strong class="text-danger">إجمالي المدفوعات</strong><br>
                                <span class="fs-5">{{ total_payments|format_currency }}</span>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <strong class="text-primary">إجمالي الشحنات</strong><br>
                            <span class="fs-5">{{ total_shipments|format_currency }}</span>
                        </div>
                        <div class="col-6">
                            <strong class="text-warning">إجمالي المصاريف</strong><br>
                            <span class="fs-5">{{ total_expenses|format_currency }}</span>
                        </div>
                        <div class="col-6">
                            <strong class="text-success">الرصيد الحالي</strong><br>
                            <span class="fs-5">{{ current_balance|format_currency }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فلتر التاريخ -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="start" class="form-label">من تاريخ</label>
                    <input type="date" class="form-control" id="start" name="start" value="{{ start_date }}">
                </div>
                <div class="col-md-4">
                    <label for="end" class="form-label">إلى تاريخ</label>
                    <input type="date" class="form-control" id="end" name="end" value="{{ end_date }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>تصفية
                    </button>
                    <a href="{{ url_for('reports_bp.supplier_detail_report', supplier_id=supplier.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>إلغاء
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- المدفوعات -->
    {% if payments %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="fas fa-credit-card me-2"></i>
                المدفوعات للمورد ({{ payments|length }} دفعة)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>رقم الدفعة</th>
                            <th>التاريخ</th>
                            <th>طريقة الدفع</th>
                            <th>المبلغ</th>
                            <th>الحالة</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.id }}</td>
                            <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else 'غير محدد' }}</td>
                            <td>{{ payment.method or 'غير محدد' }}</td>
                            <td>{{ payment.total_amount|format_currency }}</td>
                            <td>
                                <span class="badge bg-{% if payment.status == 'COMPLETED' %}success{% elif payment.status == 'PENDING' %}warning{% else %}danger{% endif %}">
                                    {{ payment.status }}
                                </span>
                            </td>
                            <td>{{ payment.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- الشحنات -->
    {% if shipments %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-shipping-fast me-2"></i>
                الشحنات ({{ shipments|length }} شحنة)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>رقم الشحنة</th>
                            <th>التاريخ</th>
                            <th>المنشأ</th>
                            <th>الوجهة</th>
                            <th>الناقل</th>
                            <th>القيمة</th>
                            <th>رقم التتبع</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for shipment in shipments %}
                        <tr>
                            <td>{{ shipment.number or shipment.id }}</td>
                            <td>{{ shipment.shipment_date.strftime('%Y-%m-%d') if shipment.shipment_date else 'غير محدد' }}</td>
                            <td>{{ shipment.origin or 'غير محدد' }}</td>
                            <td>{{ shipment.destination or 'غير محدد' }}</td>
                            <td>{{ shipment.carrier or 'غير محدد' }}</td>
                            <td>{{ shipment.total_value|format_currency }}</td>
                            <td>{{ shipment.tracking or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- المصاريف -->
    {% if expenses %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-receipt me-2"></i>
                المصاريف ({{ expenses|length }} مصروف)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>رقم المصروف</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>الموظف</th>
                            <th>المبلغ</th>
                            <th>الوصف</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in expenses %}
                        <tr>
                            <td>{{ expense.id }}</td>
                            <td>{{ expense.date.strftime('%Y-%m-%d') if expense.date else 'غير محدد' }}</td>
                            <td>{{ expense.type_id or 'غير محدد' }}</td>
                            <td>{{ expense.employee_id or 'غير محدد' }}</td>
                            <td>{{ expense.amount|format_currency }}</td>
                            <td>{{ expense.desc or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- قسم القطع والحركات -->
    {% if supplier_items %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>القطع والحركات</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>القيمة</th>
                            <th>المستودع</th>
                            <th>آخر حركة</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in supplier_items %}
                        <tr>
                            <td>
                                <strong>{{ item.product_name }}</strong>
                                {% if item.product_sku %}
                                <br><small class="text-muted">SKU: {{ item.product_sku }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ item.quantity or 0 }}</span>
                            </td>
                            <td>{{ item.unit_price|format_currency }}</td>
                            <td>{{ item.total_value|format_currency }}</td>
                            <td>{{ item.warehouse_name or 'غير محدد' }}</td>
                            <td>{{ item.last_movement_date.strftime('%Y-%m-%d') if item.last_movement_date else 'غير محدد' }}</td>
                            <td>{{ item.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- رسالة في حالة عدم وجود بيانات -->
    {% if not payments and not shipments and not expenses and not supplier_items %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">لا توجد معاملات في الفترة المحددة</h5>
            <p class="text-muted">لم يتم العثور على أي معاملات للمورد في الفترة المحددة.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
