{% extends 'warehouses/base.html' %}
{% block title %}بطاقة القطعة – {{ part.name }}{% endblock %}
{% block page_title %}بطاقة القطعة{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-lg-5">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">بيانات القطعة</div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>الاسم:</strong> {{ part.name }}</li>
          <li class="list-group-item"><strong>رقم القطعة:</strong> {{ part.part_number or '—' }}</li>
          <li class="list-group-item">
            <strong>الحالة:</strong>
            {% set CONDITION_MAP = {'NEW':'جديد','USED':'مستعمل','REFURBISHED':'مجدّد'} %}
            {% set c = part.condition %}
            {% set cval = (c.value if (c is not string and c is not none) else c) %}
            {{ CONDITION_MAP.get(cval, cval or '—') }}
          </li>
          <li class="list-group-item"><strong>بلد المنشأ:</strong> {{ part.origin_country or '—' }}</li>
          <li class="list-group-item">
            <strong>السعر الافتراضي:</strong>
            {% if part.price is not none %}{{ '%.2f'|format(part.price|float) }}{% else %}—{% endif %}
          </li>
          <li class="list-group-item"><strong>الحد الأدنى للتوفر:</strong> {{ part.min_qty or 0 }}</li>
        </ul>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">المخزون في المخازن</div>
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr class="text-center">
                <th>المخزن</th>
                <th class="text-end">متوفر</th>
                <th class="text-end">محجوز</th>
                <th class="text-end">المتاح الفعلي</th>
                <th>الحالة</th>
              </tr>
            </thead>
            <tbody>
              {% for st in stock or [] %}
                {% set va = (st.virtual_available or 0) %}
                {% set minq = (part.min_qty or 0) %}
                {% set css = (va < minq) and 'table-danger' or ((va < (minq * 1.2)) and 'table-warning') or '' %}
                <tr class="{{ css }}">
                  <td>{{ st.warehouse.name }}</td>
                  <td class="text-end">{{ st.on_hand or 0 }}</td>
                  <td class="text-end">{{ st.reserved or 0 }}</td>
                  <td class="text-end">{{ st.virtual_available or 0 }}</td>
                  <td>
                    {% if va < minq %}منخفض
                    {% elif va < (minq * 1.2) %}قريب من الحد
                    {% else %}طبيعي{% endif %}
                  </td>
                </tr>
              {% else %}
                <tr><td colspan="5" class="text-center text-muted">لا يوجد مخزون مسجّل</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">حركات التحويل</div>
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0" id="movements-table">
            <thead class="table-light">
              <tr class="text-center">
                <th>التاريخ</th>
                <th>من</th>
                <th>إلى</th>
                <th class="text-end">الكمية</th>
                <th>ملاحظات</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transfers or [] %}
                <tr>
                  <td class="text-center">{{ t.transfer_date and t.transfer_date.strftime('%Y-%m-%d %H:%M') or '—' }}</td>
                  <td class="text-center">{{ t.source_warehouse and t.source_warehouse.name or '—' }}</td>
                  <td class="text-center">{{ t.destination_warehouse and t.destination_warehouse.name or '—' }}</td>
                  <td class="text-end">{{ t.quantity }}</td>
                  <td>{{ t.notes or '—' }}</td>
                </tr>
              {% else %}
                <tr><td colspan="5" class="text-center text-muted">لا توجد تحويلات</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">تبادلات مع الشركاء/التجّار</div>
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr class="text-center">
                <th>التاريخ</th>
                <th>الاتجاه</th>
                <th>الشريك/التاجر</th>
                <th class="text-end">الكمية</th>
                <th class="text-end">تكلفة للوحدة</th>
                <th>مُسعَّر؟</th>
                <th>ملاحظات</th>
              </tr>
            </thead>
            <tbody>
              {% for e in exchanges or [] %}
                <tr>
                  <td class="text-center">{{ e.created_at and e.created_at.strftime('%Y-%m-%d %H:%M') or '—' }}</td>
                  <td class="text-center">
                    {% if e.direction == 'IN' %}وارد
                    {% elif e.direction == 'OUT' %}صادر
                    {% else %}—{% endif %}
                  </td>
                  <td class="text-center">{{ e.partner and e.partner.name or '—' }}</td>
                  <td class="text-end">{{ e.quantity }}</td>
                  <td class="text-end">
                    {% set uc = e.unit_cost|default(None, true) %}
                    {{ uc is not none and ('%.2f'|format(uc|float)) or '—' }}
                  </td>
                  <td class="text-center">{{ (e.is_priced|default(false, true)) and 'نعم' or 'لا' }}</td>
                  <td>{{ e.notes or '—' }}</td>
                </tr>
              {% else %}
                <tr><td colspan="7" class="text-center text-muted">لا توجد تبادلات</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-secondary text-white">الشحنات</div>
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr class="text-center">
                <th>شحنة #</th>
                <th>الوصول</th>
                <th>المستودع</th>
                <th class="text-end">الكمية</th>
                <th>شركاء</th>
              </tr>
            </thead>
            <tbody>
              {% for si in shipments or [] %}
                {% set sh = si.shipment %}
                {% set arr = (sh and (sh.actual_arrival|default(None, true) or sh.expected_arrival|default(None, true) or sh.shipment_date|default(None, true))) %}
                <tr>
                  <td class="text-center">{{ sh and (sh.shipment_number or sh.id) or '—' }}</td>
                  <td class="text-center">{{ arr and arr.strftime('%Y-%m-%d') or '—' }}</td>
                  <td class="text-center">{{ si.warehouse and si.warehouse.name or '—' }}</td>
                  <td class="text-end">{{ si.quantity or 0 }}</td>
                  <td>
                    {% for link in (sh and sh.partner_links) or [] %}
                      {{ link.partner and link.partner.name or '—' }} ({{ link.share_percentage or 0 }}%)<br>
                    {% endfor %}
                  </td>
                </tr>
              {% else %}
                <tr><td colspan="5" class="text-center text-muted">لا توجد شحنات</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      if (window.jQuery && $.fn.DataTable) {
        $('#movements-table').DataTable({
          pageLength: 25,
          language: { url: "{{ url_for('static', filename='datatables/Arabic.json') }}" }
        });
      }
    })();
  </script>
{% endblock %}
