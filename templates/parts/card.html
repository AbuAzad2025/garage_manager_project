{% extends 'base.html' %}
{% block title %}بطاقة القطعة – {{ part.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- بيانات القطعة -->
    <div class="col-lg-5">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">بيانات القطعة</div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>الاسم:</strong> {{ part.name }}</li>
          <li class="list-group-item"><strong>رقم القطعة:</strong> {{ part.part_number or '–' }}</li>
          <li class="list-group-item"><strong>الحالة:</strong> {{ part.condition }}</li>
          <li class="list-group-item"><strong>بلد المنشأ:</strong> {{ part.origin_country or '–' }}</li>
          <li class="list-group-item"><strong>السعر:</strong> {{ "%.2f"|format(part.price) }} {{ part.currency or '' }}</li>
          <li class="list-group-item"><strong>الحد الأدنى:</strong> {{ part.min_qty }}</li>
        </ul>
        <div class="card-body">
          <button id="scan-barcode-btn" class="btn btn-outline-light w-100">
            <i class="fas fa-barcode"></i> مسح باركود
          </button>
          <div id="barcode-scanner" class="mt-3"></div>
        </div>
      </div>
    </div>

    <!-- جداول المخزون وحركات القطعة -->
    <div class="col-lg-7">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">المخزون في المخازن</div>
        <div class="table-responsive">
          <table class="table table-bordered mb-0">
            <thead class="thead-light">
              <tr><th>المخزن</th><th>متاح</th><th>محجوز</th><th>ظاهرية</th><th>حالة</th></tr>
            </thead>
            <tbody>
            {% for st in stock %}
              {% set css = st.virtual_available < part.min_qty
                 and 'table-danger'
                 or (st.virtual_available < part.min_qty * 1.2 and 'table-warning') or '' %}
              <tr class="{{ css }}">
                <td>{{ st.warehouse.name }}</td>
                <td>{{ st.on_hand }}</td>
                <td>{{ st.reserved }}</td>
                <td>{{ st.virtual_available }}</td>
                <td>
                  {% if st.virtual_available < part.min_qty %}منخفض
                  {% elif st.virtual_available < part.min_qty * 1.2 %}قريب من الحد
                  {% else %}طبيعي{% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <span>حركات القطعة</span>
          <button class="btn btn-sm btn-light" data-toggle="collapse" data-target="#filterPanel">
            <i class="fas fa-filter"></i> فلترة
          </button>
        </div>
        <div id="filterPanel" class="collapse p-3 bg-white">
          <form class="form-inline">
            <label class="mr-2">من</label>
            <input type="date" id="from-date" class="form-control mr-3">
            <label class="mr-2">إلى</label>
            <input type="date" id="to-date" class="form-control mr-3">
            <label class="mr-2">النوع</label>
            <select id="type-filter" class="form-control mr-3">
              <option value="">الكل</option>
              <option value="transfer">تحويل</option>
              <option value="exchange">تبادل</option>
            </select>
            <button type="button" id="apply-filter" class="btn btn-primary">تطبيق</button>
          </form>
        </div>
        <div class="table-responsive">
          <table id="movements-table" class="table table-striped mb-0">
            <thead><tr>
              <th>التاريخ</th><th>النوع</th><th>الكمية</th><th>من → إلى / تاجر</th><th>السعر</th>
            </tr></thead>
            <tbody>
            {% for m in movements %}
              <tr data-date="{{ m.timestamp.strftime('%Y-%m-%d') }}" data-type="{{ m.type }}">
                <td>{{ m.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ m.type }}</td>
                <td>{{ m.quantity }}</td>
                <td>
                  {% if m.type=='transfer' %}
                    {{ Warehouse.query.get(m.src).name }} &rarr; {{ Warehouse.query.get(m.dst).name }}
                  {% else %}
                    {{ Supplier.query.get(m.trader_id).name }}
                  {% endif %}
                </td>
                <td>{{ m.unit_cost or '–' }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- تبادلات وتفاصيل الشحنات أسفل -->
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">تبادلات مع التجار</div>
        <div class="table-responsive">
          <table class="table mb-0">
            <thead><tr><th>التاجر</th><th>كمية</th><th>سعر</th><th>مؤمن؟</th></tr></thead>
            <tbody>
            {% for e in exchanges %}
              <tr>
                <td>{{ e.trader.name }}</td>
                <td>{{ e.quantity }}</td>
                <td>{{ "%.2f"|format(e.unit_cost or 0) }}</td>
                <td>{{ e.is_priced and 'نعم' or 'لا' }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">الشحنات</div>
        <div class="table-responsive">
          <table class="table mb-0">
            <thead><tr><th>شحنة #</th><th>الوصول</th><th>التكلفة</th><th>شركاء</th></tr></thead>
            <tbody>
            {% for si in shipments %}
              <tr>
                <td>{{ si.shipment.id }}</td>
                <td>{{ si.shipment.arrival_date and si.shipment.arrival_date.strftime('%Y-%m-%d') or '–' }}</td>
                <td>{{ "%.2f"|format(si.shipment.computed_total or 0) }}</td>
                <td>
                  {% for link in si.shipment.partner_links %}
                    {{ link.partner.name }} ({{ link.share_percentage }}%)<br>
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
  $(function(){
    $('#movements-table').DataTable({
      responsive:true,
      dom:'Bfrtip',
      buttons:['excel','pdf'],
      language:{ url:'//cdn.datatables.net/plug-ins/1.10.21/i18n/Arabic.json' }
    });
    $('#apply-filter').click(()=>{
      let from = $('#from-date').val(), to = $('#to-date').val(), type = $('#type-filter').val();
      $('#movements-table tbody tr').each(function(){
        let row=$(this), d=row.data('date'), t=row.data('type');
        row.toggle((!from||d>=from)&&(!to||d<=to)&&(!type||t===type));
      });
    });
    $('#scan-barcode-btn').click(()=>{
      Quagga.init({
        inputStream:{target:'#barcode-scanner',type:'LiveStream'},
        decoder:{readers:['code_128_reader','ean_reader']}
      },err=>!err&&Quagga.start());
      Quagga.onDetected(data=>{
        Quagga.stop();
        alert('تم المسح: '+data.codeResult.code);
      });
    });
  });
</script>
{% endblock %}
