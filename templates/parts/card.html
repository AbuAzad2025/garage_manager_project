{% extends 'base.html' %}
{% block title %}بطاقة القطعة – {{ part.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-lg-5">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">بيانات القطعة</div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>الاسم:</strong> {{ part.name }}</li>
          <li class="list-group-item"><strong>رقم القطعة:</strong> {{ part.part_number or '–' }}</li>
          <li class="list-group-item"><strong>الحالة:</strong> {{ part.condition or '–' }}</li>
          <li class="list-group-item"><strong>بلد المنشأ:</strong> {{ part.origin_country or '–' }}</li>
          <li class="list-group-item"><strong>السعر الافتراضي:</strong> {{ part.price is not none and ("%.2f"|format(part.price)) or '–' }} {{ part.currency or '' }}</li>
          <li class="list-group-item"><strong>الحد الأدنى:</strong> {{ part.min_qty or 0 }}</li>
        </ul>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">المخزون في المخازن</div>
        <div class="table-responsive">
          <table class="table table-bordered mb-0">
            <thead class="thead-light">
              <tr><th>المخزن</th><th>متاح</th><th>محجوز</th><th>ظاهرية</th><th>حالة</th></tr>
            </thead>
            <tbody>
            {% for st in stock or [] %}
              {% set va = (st.virtual_available or 0) %}
              {% set minq = (part.min_qty or 0) %}
              {% set css = (va < minq) and 'table-danger' or ((va < minq * 1.2) and 'table-warning') or '' %}
              <tr class="{{ css }}">
                <td>{{ st.warehouse.name }}</td>
                <td>{{ st.on_hand or 0 }}</td>
                <td>{{ st.reserved or 0 }}</td>
                <td>{{ st.virtual_available or 0 }}</td>
                <td>
                  {% if va < minq %}منخفض
                  {% elif va < minq * 1.2 %}قريب من الحد
                  {% else %}طبيعي{% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">حركات التحويل</div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead><tr><th>التاريخ</th><th>من</th><th>إلى</th><th>الكمية</th><th>ملاحظات</th></tr></thead>
            <tbody>
            {% for t in transfers or [] %}
              <tr>
                <td>{{ t.transfer_date and t.transfer_date.strftime('%Y-%m-%d %H:%M') or '–' }}</td>
                <td>{{ t.source_warehouse and t.source_warehouse.name or '–' }}</td>
                <td>{{ t.destination_warehouse and t.destination_warehouse.name or '–' }}</td>
                <td>{{ t.quantity }}</td>
                <td>{{ t.notes or '–' }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card shadow-sm mt-4">
        <div class="card-header bg-warning text-dark">تبادلات مع الشركاء/التجّار</div>
        <div class="table-responsive">
          <table class="table mb-0">
            <thead><tr><th>التاريخ</th><th>الاتجاه</th><th>شريك/تاجر</th><th>كمية</th><th>تكلفة للوحدة</th><th>مُسعّر؟</th><th>ملاحظات</th></tr></thead>
            <tbody>
            {% for e in exchanges or [] %}
              <tr>
                <td>{{ e.created_at and e.created_at.strftime('%Y-%m-%d %H:%M') or '–' }}</td>
                <td>{{ e.direction }}</td>
                <td>{{ e.partner and e.partner.name or '–' }}</td>
                <td>{{ e.quantity }}</td>
                <td>
                  {% set uc = e.unit_cost|default(None, true) %}
                  {{ uc is not none and ("%.2f"|format(uc)) or '–' }}
                </td>
                <td>{{ (e.is_priced|default(false, true)) and 'نعم' or 'لا' }}</td>
                <td>{{ e.notes or '–' }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card shadow-sm mt-4">
        <div class="card-header bg-secondary text-white">الشحنات</div>
        <div class="table-responsive">
          <table class="table mb-0">
            <thead><tr><th>شحنة #</th><th>الوصول</th><th>شركاء</th></tr></thead>
            <tbody>
            {% for si in shipments or [] %}
              {% set sh = si.shipment %}
              {% set arr = (sh and (sh.actual_arrival|default(None, true) or sh.expected_arrival|default(None, true) or sh.shipment_date|default(None, true))) %}
              <tr>
                <td>{{ sh and sh.id or '–' }}</td>
                <td>{{ arr and arr.strftime('%Y-%m-%d') or '–' }}</td>
                <td>
                  {% for link in (sh and sh.partner_links) or [] %}
                    {{ link.partner and link.partner.name or '–' }} ({{ link.share_percentage or 0 }}%)<br>
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/warehouses.js') }}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    $(function(){
      $('#movements-table').DataTable && $('#movements-table').DataTable({
        responsive:true,
        dom:'Bfrtip',
        buttons:['excel','pdf'],
        language:{ url:'//cdn.datatables.net/plug-ins/1.10.21/i18n/Arabic.json' }
      });
      $('#scan-barcode-btn').on('click', function(){
        if(!window.Quagga){ return; }
        Quagga.init({
          inputStream:{target:document.querySelector('#barcode-scanner'),type:'LiveStream'},
          decoder:{readers:['code_128_reader','ean_reader']}
        }, function(err){ if(!err){ Quagga.start(); }});
        Quagga.onDetected(function(data){
          Quagga.stop();
          alert('تم المسح: ' + (data && data.codeResult && data.codeResult.code));
        });
      });
    });
  </script>
{% endblock %}
