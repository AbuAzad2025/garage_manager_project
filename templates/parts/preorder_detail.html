{% extends 'warehouses/base.html' %}
{% block title %}تفاصيل الحجز{% endblock %}
{% block page_title %}تفاصيل الحجز{% endblock %}

{% block content %}
{% set status_map = {'PENDING':'معلّق','CONFIRMED':'مؤكّد','FULFILLED':'منفّذ','CANCELLED':'ملغي'} %}
{% set method_map = {'cash':'نقدي','card':'بطاقة','bank':'تحويل','cheque':'شيك'} %}

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h5 class="mb-1">قسيمة حجز {{ preorder.reference or ('PR-' ~ preorder.id) }}</h5>
        <div class="text-muted small">
          أُنشئ: {{ preorder.created_at.strftime('%Y-%m-%d %H:%M') if preorder.created_at else '—' }} |
          تاريخ الحجز: {{ preorder.preorder_date.strftime('%Y-%m-%d %H:%M') if preorder.preorder_date else '—' }} |
          التسليم المتوقع: {{ preorder.expected_date.strftime('%Y-%m-%d %H:%M') if preorder.expected_date else '—' }}
        </div>
      </div>
      <span class="badge 
        {% if preorder.status=='FULFILLED' %} bg-success
        {% elif preorder.status=='CONFIRMED' %} bg-primary
        {% elif preorder.status=='CANCELLED' %} bg-secondary
        {% else %} bg-warning text-dark {% endif %}">
        {{ status_map.get(preorder.status, preorder.status) }}
      </span>
    </div>

    {% set qty = (preorder.quantity or 0)|int %}
    {% set unit_price = (preorder.product and preorder.product.price or 0)|float %}
    {% set tax = (preorder.tax_rate or 0)|float %}
    {% set prepaid = (preorder.prepaid_amount or 0)|float %}
    {% set currency = preorder.currency or 'ILS' %}
    {% set total_before = qty * unit_price %}
    {% set total_with_tax = total_before * (1 + tax/100) %}
    {% set balance = (total_with_tax - prepaid) if (total_with_tax - prepaid) > 0 else 0 %}
    {% set entity_name = preorder.customer and preorder.customer.name
                         or preorder.supplier and preorder.supplier.name
                         or preorder.partner and preorder.partner.name
                         or 'غير محدد' %}

    <dl class="row">
      <dt class="col-sm-3">الجهة</dt>
      <dd class="col-sm-9">{{ entity_name }}</dd>

      <dt class="col-sm-3">القطعة</dt>
      <dd class="col-sm-9">{{ preorder.product.name if preorder.product else '—' }}</dd>

      <dt class="col-sm-3">المستودع</dt>
      <dd class="col-sm-9">{{ preorder.warehouse.name if preorder.warehouse else '—' }}</dd>

      <dt class="col-sm-3">الكمية</dt>
      <dd class="col-sm-9">{{ qty }}</dd>

      <dt class="col-sm-3">سعر الوحدة</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(unit_price) }} {{ currency }}</dd>

      <dt class="col-sm-3">الإجمالي قبل الضريبة</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(total_before) }} {{ currency }}</dd>

      <dt class="col-sm-3">نسبة الضريبة</dt>
      <dd class="col-sm-9">{{ tax }}%</dd>

      <dt class="col-sm-3">الإجمالي بعد الضريبة</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(total_with_tax) }} {{ currency }}</dd>

      <dt class="col-sm-3">مدفوع (عربون)</dt>
      <dd class="col-sm-9">
        {{ '%.2f'|format(prepaid) }} {{ currency }}
        {% if preorder.payment_method %} — طريقة الدفع: {{ method_map.get(preorder.payment_method, preorder.payment_method) }}{% endif %}
      </dd>

      <dt class="col-sm-3">المتبقي</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(balance) }} {{ currency }}</dd>

      <dt class="col-sm-3">ملاحظات</dt>
      <dd class="col-sm-9">{{ preorder.notes or '—' }}</dd>
    </dl>

    {% set _p = preorder.payments if preorder.payments is not none else [] %}
    {% if _p|length %}
    <h6 class="mt-4">الدفعات</h6>
    <div class="table-responsive">
      <table class="table table-sm table-bordered">
        <thead class="thead-light">
          <tr>
            <th>التاريخ</th>
            <th>المبلغ</th>
            <th>العملة</th>
            <th>الطريقة</th>
            <th>الحالة</th>
            <th>مرجع</th>
          </tr>
        </thead>
        <tbody>
          {% for pay in _p %}
          <tr>
            <td>{{ pay.payment_date.strftime('%Y-%m-%d %H:%M') if pay.payment_date else '—' }}</td>
            <td>{{ '%.2f'|format(pay.total_amount or 0) }}</td>
            <td>{{ pay.currency or currency }}</td>
            <td>{{ method_map.get(pay.method, pay.method or '—') }}</td>
            <td>{{ pay.status or '—' }}</td>
            <td>{{ pay.reference or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <div class="mt-3 d-flex gap-2 flex-wrap">
      {% if preorder.status not in ('CANCELLED', 'FULFILLED') %}
        
        {# زر دفع عربون - يظهر دائماً للحجوزات النشطة #}
        {% if current_user.has_permission('create_payment') %}
        <a class="btn btn-primary"
           href="{{ url_for('payments.create_payment', 
                           entity_type='PREORDER', 
                           entity_id=preorder.id, 
                           amount=total_with_tax if balance == total_with_tax else balance,
                           currency=currency,
                           reference='دفع حجز مسبق ' ~ (preorder.reference or ('PR-' ~ preorder.id)),
                           customer_id=preorder.customer_id if preorder.customer_id else None,
                           supplier_id=preorder.supplier_id if preorder.supplier_id else None,
                           partner_id=preorder.partner_id if preorder.partner_id else None) }}">
          <i class="fas fa-money-bill-wave me-1"></i> 
          {% if prepaid > 0 %}
            دفع المتبقي ({{ '%.2f'|format(balance) }} {{ currency }})
          {% else %}
            دفع عربون
          {% endif %}
        </a>
        {% endif %}

        {# زر تسليم المنتج المحجوز - يحول الحجز لمبيعة #}
        {% if current_user.has_permission('create_sale') and prepaid > 0 %}
        <form method="post" action="{{ url_for('warehouse_bp.preorder_convert_to_sale', preorder_id=preorder.id) }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-success" onclick="return confirm('تحويل الحجز إلى مبيعة؟\n\nسيتم:\n• إنشاء فاتورة مبيع\n• المبلغ المتبقي: {{ \"%.2f\"|format(balance) }} {{ currency }}\n• شحن الكمية من المستودع');">
            <i class="fas fa-truck me-1"></i> تسليم المنتج المحجوز
          </button>
        </form>
        {% endif %}

        {# زر إلغاء الحجز #}
        {% if current_user.has_permission('delete_preorder') %}
        <form method="post" action="{{ url_for('warehouse_bp.preorder_cancel', preorder_id=preorder.id) }}" class="d-inline" onsubmit="return confirm('إلغاء الحجز؟');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-danger"><i class="fas fa-times me-1"></i> إلغاء</button>
        </form>
        {% endif %}

      {% endif %}
      <a class="btn btn-secondary" href="{{ url_for('warehouse_bp.preorders_list') }}"><i class="fas fa-arrow-right me-1"></i> رجوع</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/warehouses.js') }}"></script>
{% endblock %}
