{% extends 'warehouses/base.html' %}
{% block title %}تفاصيل الحجز{% endblock %}
{% block page_title %}تفاصيل الحجز{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h5 class="mb-3">قسيمة حجز {{ preorder.reference or 'PR-' ~ preorder.id }}</h5>

    {% set qty = preorder.quantity|int %}
    {% set unit_price = (preorder.product.price or 0)|float %}
    {% set tax = (preorder.tax_rate or 0)|float %}
    {% set prepaid = (preorder.prepaid_amount or 0)|float %}
    {% set total_before = qty * unit_price %}
    {% set total_with_tax = total_before * (1 + tax/100) %}
    {% set balance = total_with_tax - prepaid %}

    <dl class="row">
      <dt class="col-sm-3">الجهة</dt>
      <dd class="col-sm-9">
        {{ preorder.customer.name if preorder.customer else
           preorder.supplier.name if preorder.supplier else
           preorder.partner.name if preorder.partner else 'غير محدد' }}
      </dd>

      <dt class="col-sm-3">القطعة</dt>
      <dd class="col-sm-9">{{ preorder.product.name or '-' }}</dd>

      <dt class="col-sm-3">المستودع</dt>
      <dd class="col-sm-9">{{ preorder.warehouse.name or '-' }}</dd>

      <dt class="col-sm-3">الكمية</dt>
      <dd class="col-sm-9">{{ qty }}</dd>

      <dt class="col-sm-3">السعر للوحدة</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(unit_price) }}</dd>

      <dt class="col-sm-3">الإجمالي قبل الضريبة</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(total_before) }}</dd>

      <dt class="col-sm-3">نسبة الضريبة</dt>
      <dd class="col-sm-9">{{ tax }}%</dd>

      <dt class="col-sm-3">الإجمالي بعد الضريبة</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(total_with_tax) }}</dd>

      <dt class="col-sm-3">مدفوع (عربون)</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(prepaid) }}</dd>

      <dt class="col-sm-3">المتبقي</dt>
      <dd class="col-sm-9">{{ '%.2f'|format(balance) }}</dd>
    </dl>

    <div class="mt-3">
      {% if preorder.status not in ('CANCELLED', 'FULFILLED') %}
        <form method="post" action="{{ url_for('warehouse_bp.preorder_fulfill', preorder_id=preorder.id) }}" class="d-inline">
          {{ csrf_token() }}
          <button class="btn btn-success">تنفيذ</button>
        </form>
        <form method="post" action="{{ url_for('warehouse_bp.preorder_cancel', preorder_id=preorder.id) }}"
              class="d-inline" onsubmit="return confirm('إلغاء الحجز؟');">
          {{ csrf_token() }}
          <button class="btn btn-danger">إلغاء</button>
        </form>
        <a class="btn btn-outline-primary"
           href="{{ url_for('payments.create_payment', entity_type='PREORDER', entity_id=preorder.id, amount=balance) }}">
          إضافة دفعة
        </a>
      {% endif %}
      <a class="btn btn-secondary" href="{{ url_for('warehouse_bp.preorders_list') }}">رجوع</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/warehouses.js') }}"></script>
{% endblock %}
