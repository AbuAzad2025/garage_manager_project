{# templates/parts/preorder_form.html #}
{% extends 'warehouses/base.html' %}
{% set edit_mode = form._obj is defined %}
{% block title %}{{ edit_mode and 'تعديل حجز مسبق' or 'إنشاء حجز مسبق' }}{% endblock %}
{% block page_title %}{{ edit_mode and 'تعديل حجز مسبق' or 'إنشاء حجز مسبق' }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('warehouse_bp.preorders_list') }}">الحجوزات المسبقة</a></li>
<li class="breadcrumb-item active">{{ edit_mode and 'تعديل' or 'جديد' }}</li>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">{{ edit_mode and 'تعديل' or 'إضافة' }} حجز مسبق</h2>

  <form method="POST" id="preorderForm" autocomplete="off" action="{{ url_for('warehouse_bp.preorder_create') }}">
    {{ form.hidden_tag() }}

    <div class="row mb-3">
      <div class="col-md-4">
        {{ form.reference.label(class="form-label") }}
        {{ form.reference(class="form-control", placeholder="اختياري") }}
        {% for e in form.reference.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        {{ form.preorder_date.label(class="form-label") }}
        {{ form.preorder_date(class="form-control dtp", id="preorder_date", autocomplete="off") }}
      </div>
      <div class="col-md-4">
        {{ form.expected_date.label(class="form-label") }}
        {{ form.expected_date(class="form-control dtp", id="expected_date", autocomplete="off") }}
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        {{ form.status.label(class="form-label") }}
        {{ form.status(class="form-select") }}
      </div>
      <div class="col-md-9">
        {{ form.customer_id.label(class="form-label") }}
        <div class="input-group">
          {{ form.customer_id(class="form-select select2", id="customerSelect", data_endpoint=url_for('api.search_customers')) }}
          <a href="{{ url_for('customers_bp.create_form', return_to=url_for('warehouse_bp.preorder_create')) }}" 
             class="btn btn-outline-primary" title="إضافة عميل جديد" target="_blank">
            <i class="fa fa-user-plus"></i>
          </a>
        </div>
        {% for e in form.customer_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        <div class="form-text">اختر عميلًا أو أنشئ عميلًا جديدًا من زر (+).</div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        {{ form.product_id.label(class="form-label") }}
        {{ form.product_id(class="form-select select2", data_endpoint=url_for('api.products'), data_placeholder="اختر القطعة") }}
      </div>
      <div class="col-md-6">
        {{ form.warehouse_id.label(class="form-label") }}
        {{ form.warehouse_id(class="form-select select2", data_endpoint=url_for('api.api_warehouses'), data_placeholder="اختر المخزن") }}
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        {{ form.quantity.label(class="form-label") }}
        {{ form.quantity(class="form-control", min="1", step="1", inputmode="numeric") }}
      </div>
      <div class="col-md-3">
        {{ form.prepaid_amount.label(class="form-label") }}
        {{ form.prepaid_amount(class="form-control", min="0", step="0.01", inputmode="decimal") }}
      </div>
      <div class="col-md-3">
        {{ form.payment_method.label(class="form-label") }}
        {{ form.payment_method(class="form-select") }}
      </div>
      <div class="col-md-3">
        {{ form.tax_rate.label(class="form-label") }}
        {{ form.tax_rate(class="form-control", min="0", max="100", step="0.01", inputmode="decimal") }}
      </div>
    </div>

    <div class="mb-3">
      {{ form.notes.label(class="form-label") }}
      {{ form.notes(class="form-control", rows="2") }}
    </div>

    <button type="submit" class="btn btn-primary">{{ edit_mode and 'تحديث' or 'تأكيد الحجز' }}</button>
    <a href="{{ url_for('warehouse_bp.preorders_list') }}" class="btn btn-secondary ms-2">رجوع</a>
  </form>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
  <script>
    $(function () {
      $('.select2').each(function(){
        const ep = $(this).data('endpoint');
        if (ep) {
          $(this).select2({
            width: '100%',
            theme: 'bootstrap4',
            ajax: {
              url: ep, dataType: 'json', delay: 250,
              data: params => ({ q: params.term || '', limit: 20 }),
              processResults: data => ({ results: Array.isArray(data) ? data : (data.results || []) })
            },
            placeholder: $(this).data('placeholder') || 'اختر...'
          });
        } else {
          $(this).select2({ width: '100%', theme: 'bootstrap4', placeholder: 'اختر...' });
        }
      });

      const fpOpts = { enableTime:true, time_24hr:true, dateFormat:"Y-m-d H:i", altInput:true, altFormat:"d-m-Y H:i", locale:flatpickr.l10ns.ar };
      if (window.flatpickr) {
        flatpickr("#preorder_date", fpOpts);
        flatpickr("#expected_date", fpOpts);
      }
    });
  </script>
{% endblock %}
