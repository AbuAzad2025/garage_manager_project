{% extends 'warehouses/base.html' %}
{% block title %}إنشاء حجز{% endblock %}
{% block page_title %}إنشاء حجز مسبق{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
{% endblock %}

{% block content %}
<form method="POST" novalidate>
  {{ form.hidden_tag() }}

  <div class="row">
    <div class="col-md-4 mb-2">{{ form.reference.label }} {{ form.reference(class="form-control") }}</div>
    <div class="col-md-4 mb-2">{{ form.preorder_date.label }} {{ form.preorder_date(class="form-control") }}</div>
    <div class="col-md-4 mb-2">{{ form.expected_date.label }} {{ form.expected_date(class="form-control") }}</div>
  </div>

  <div class="row">
    <div class="col-md-4 mb-2">{{ form.status.label }} {{ form.status(class="form-control") }}</div>
    <div class="col-md-4 mb-2">{{ form.entity_type.label }} {{ form.entity_type(class="form-control", id="entity_type") }}</div>
    <div class="col-md-4 mb-2">
      <div class="entity-group" id="customer_group">{{ form.customer_id.label }} {{ form.customer_id(class="form-control select2") }}</div>
      <div class="entity-group d-none" id="supplier_group">{{ form.supplier_id.label }} {{ form.supplier_id(class="form-control select2") }}</div>
      <div class="entity-group d-none" id="partner_group">{{ form.partner_id.label }} {{ form.partner_id(class="form-control select2") }}</div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-2">{{ form.product_id.label }} {{ form.product_id(class="form-control select2") }}</div>
    <div class="col-md-6 mb-2">{{ form.warehouse_id.label }} {{ form.warehouse_id(class="form-control select2") }}</div>
  </div>

  <div class="row">
    <div class="col-md-3 mb-2">{{ form.quantity.label }} {{ form.quantity(class="form-control") }}</div>
    <div class="col-md-3 mb-2">{{ form.prepaid_amount.label }} {{ form.prepaid_amount(class="form-control") }}</div>
    <div class="col-md-3 mb-2">{{ form.payment_method.label }} {{ form.payment_method(class="form-control") }}</div>
    <div class="col-md-3 mb-2">{{ form.tax_rate.label }} {{ form.tax_rate(class="form-control") }}</div>
  </div>

  <div class="mb-2">{{ form.notes.label }} {{ form.notes(class="form-control") }}</div>

  <button class="btn btn-primary">{{ form.submit.label.text or 'حفظ' }}</button>
  <a class="btn btn-secondary" href="{{ url_for('warehouse_bp.preorders_list') }}">رجوع</a>
</form>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/warehouses.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    (function(){
      if (window.jQuery) {
        $('.select2').select2({ width: '100%' });
      }

      function toggleEntityGroups() {
        const t = document.getElementById('entity_type').value;
        ['customer', 'supplier', 'partner'].forEach(function(type){
          const el = document.getElementById(type + '_group');
          if (el) el.classList.toggle('d-none', type !== t);
        });
      }

      document.getElementById('entity_type').addEventListener('change', toggleEntityGroups);
      toggleEntityGroups();
    })();
  </script>
{% endblock %}
