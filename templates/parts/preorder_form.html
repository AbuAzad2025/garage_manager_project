{# templates/parts/preorder_form.html #}
{% extends 'warehouses/base.html' %}
{% set edit_mode = form._obj is defined %}
{% block title %}{{ edit_mode and 'تعديل حجز مسبق' or 'إنشاء حجز مسبق' }}{% endblock %}
{% block page_title %}{{ edit_mode and 'تعديل حجز مسبق' or 'إنشاء حجز مسبق' }}{% endblock %}

{% block head_extra %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('warehouse_bp.preorders_list') }}">الحجوزات المسبقة</a></li>
<li class="breadcrumb-item active">{{ edit_mode and 'تعديل' or 'جديد' }}</li>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="mb-4">{{ edit_mode and 'تعديل' or 'إضافة' }} حجز مسبق</h4>

      <form method="POST" id="preorderForm" action="{{ url_for('warehouse_bp.preorder_create') }}" autocomplete="off" novalidate>
        {{ form.hidden_tag() }}

        <div class="row g-3">
          <div class="col-md-4">
            {{ form.reference.label(class="form-label") }}
            {{ form.reference(class="form-control", placeholder="اختياري") }}
            {% for e in form.reference.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            {{ form.preorder_date.label(class="form-label") }}
            {{ form.preorder_date(class="form-control dtp", id="preorder_date", inputmode="text", autocomplete="off") }}
            {% for e in form.preorder_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            {{ form.expected_date.label(class="form-label") }}
            {{ form.expected_date(class="form-control dtp", id="expected_date", inputmode="text", autocomplete="off") }}
            {% for e in form.expected_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-3">
            {{ form.status.label(class="form-label") }}
            {{ form.status(class="form-select") }}
            {% for e in form.status.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-9">
            {{ form.customer_id.label(class="form-label d-block") }}
            <div class="input-group">
              {{ form.customer_id(class="form-select select2", id="customerSelect", data_endpoint=url_for('api.search_customers'), data_placeholder="اختر العميل") }}
              <a href="{{ url_for('customers_bp.create_form', return_to=url_for('warehouse_bp.preorder_create')) }}"
                 class="btn btn-outline-primary" title="إضافة عميل جديد" target="_blank">
                <i class="fa fa-user-plus"></i>
              </a>
            </div>
            {% for e in form.customer_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            <div class="form-text">اختر عميلًا أو أنشئ عميلًا جديدًا من زر (+).</div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-6">
            {{ form.product_id.label(class="form-label") }}
            {{ form.product_id(class="form-select select2", id="productSelect", data_endpoint_by_warehouse="/api/warehouses/0/products", data_placeholder="اختر القطعة") }}
            {% for e in form.product_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            <div id="prodAvail" class="form-text text-muted"></div>
          </div>
          <div class="col-md-6">
            {{ form.warehouse_id.label(class="form-label") }}
            {{ form.warehouse_id(class="form-select select2", id="warehouseSelect", data_endpoint=url_for('api.warehouses'), data_placeholder="اختر المخزن") }}
            {% for e in form.warehouse_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-3">
            {{ form.quantity.label(class="form-label") }}
            {{ form.quantity(class="form-control", min="1", step="1", inputmode="numeric", placeholder="1") }}
            {% for e in form.quantity.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-3">
            {{ form.prepaid_amount.label(class="form-label") }}
            {{ form.prepaid_amount(class="form-control", min="0", step="0.01", inputmode="decimal", placeholder="0.00") }}
            {% for e in form.prepaid_amount.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-3">
            {{ form.payment_method.label(class="form-label") }}
            {{ form.payment_method(class="form-select") }}
            {% for e in form.payment_method.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-3">
            {{ form.tax_rate.label(class="form-label") }}
            {{ form.tax_rate(class="form-control", min="0", max="100", step="0.01", inputmode="decimal", placeholder="0") }}
            {% for e in form.tax_rate.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
        </div>

        <div class="mt-3">
          {{ form.notes.label(class="form-label") }}
          {{ form.notes(class="form-control", rows="2", placeholder="ملاحظات إضافية") }}
          {% for e in form.notes.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">{{ edit_mode and 'تحديث' or 'تأكيد الحجز' }}</button>
          <a href="{{ url_for('warehouse_bp.preorders_list') }}" class="btn btn-secondary ms-2">رجوع</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
<script>
(function () {
  function initSelect2($el) {
    var ep = $el.data('endpoint');
    var epByWh = $el.data('endpoint_by_warehouse');
    var opts = {
      width: '100%',
      theme: 'bootstrap4',
      placeholder: $el.data('placeholder') || 'اختر...',
      allowClear: true
    };
    if (epByWh) {
      // Dynamic per-request URL bound to current warehouse selection
      opts.ajax = {
        transport: function (params, success, failure) {
          var term = (params && params.data && params.data.q) || '';
          var wid = $('#warehouseSelect').val() || '0';
          var url = String(epByWh).replace(/\/warehouses\/(?:0|\d+)\/products/i, '/warehouses/' + String(wid) + '/products');
          if (!wid || wid === '0') { url = '/api/products'; }
          return $.ajax({
            url: url,
            dataType: 'json',
            data: { q: term, limit: 20 },
          }).then(success).fail(failure);
        },
        processResults: function (data) {
          var arr = Array.isArray(data) ? data : (data.results || data.data || []);
          return { results: (arr || []).map(function (r) {
            if (r.text) return r;
            var t = r.name || r.text || '';
            if (r.sku) t += ' • SKU: ' + r.sku;
            if (r.part_number) t += ' • Part: ' + r.part_number;
            if (r.barcode) t += ' • Barcode: ' + r.barcode;
            return { id: r.id, text: t };
          })};
        }
      };
    } else if (ep) {
      opts.ajax = {
        url: ep,
        dataType: 'json',
        delay: 250,
        data: function (params) { return { q: params.term || '', limit: 20 }; },
        processResults: function (data) {
          var arr = Array.isArray(data) ? data : (data.results || data.data || []);
          return { results: (arr || []).map(function (r) {
            if (r.text) return r;
            var t = r.name || r.text || '';
            if (r.sku) t += ' • SKU: ' + r.sku;
            if (r.part_number) t += ' • Part: ' + r.part_number;
            if (r.barcode) t += ' • Barcode: ' + r.barcode;
            return { id: r.id, text: t };
          })};
        }
      };
    }
    $el.select2(opts);
  }

  $(function () {
    $('.select2').each(function(){ initSelect2($(this)); });

    function buildByWarehouseUrl(tpl, wid) {
      if (!tpl) return '';
      var w = String(wid || '0');
      // Expected template: /api/warehouses/0/products
      return String(tpl).replace(/\/warehouses\/(?:0|\d+)\/products/i, '/warehouses/' + w + '/products');
    }

    function reinitProductsForWarehouse(wid) {
      var $prod = $('#productSelect');
      if (!$prod.length) return;
      if ($prod.data('select2')) { $prod.select2('destroy'); }
      $prod.val(null).trigger('change');
      // Keep endpoint_by_warehouse; initSelect2 will use dynamic transport
      initSelect2($prod);
    }

    $('#warehouseSelect').on('change', function(){
      var wid = $(this).val();
      reinitProductsForWarehouse(wid);
    });

    var initialWid = $('#warehouseSelect').val();
    if (initialWid) { reinitProductsForWarehouse(initialWid); }

    // عرض المتاح والسعر كما في الفاتورة
    async function fetchProductInfo(pid, wid){
      if(!(pid && wid)) return {};
      try{
        const res = await fetch(`/api/products/${pid}/info?warehouse_id=${wid}`, { headers: { 'Accept': 'application/json' } });
        return await res.json();
      }catch(_){ return {}; }
    }

    $('#productSelect').on('select2:select', async function(){
      var pid = $(this).val();
      var wid = $('#warehouseSelect').val();
      var info = await fetchProductInfo(pid, wid);
      var avail = (typeof info.available !== 'undefined') ? info.available : null;
      var price = (typeof info.price !== 'undefined') ? info.price : null;
      var parts = [];
      if (avail !== null) parts.push('متاح: ' + avail);
      if (price !== null) parts.push('سعر: ' + Number(price).toFixed(2));
      $('#prodAvail').text(parts.join(' | '));
    });

    if (window.flatpickr) {
      var opts = {
        enableTime: true,
        time_24hr: true,
        dateFormat: "Y-m-d H:i",
        altInput: true,
        altFormat: "d-m-Y H:i",
        allowInput: true,
        locale: flatpickr.l10ns.ar
      };
      flatpickr("#preorder_date", opts);
      flatpickr("#expected_date", opts);
    }
  });
})();
</script>
{% endblock %}
