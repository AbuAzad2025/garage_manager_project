{% extends 'base.html' %}
{% block title %}{{ payment and 'تعديل دفعة' or 'إضافة دفعة' }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>{{ payment and 'تعديل دفعة' or 'إضافة دفعة' }}</h2>

  <form method="post" novalidate>
    {{ form.hidden_tag() }}

    <div class="form-row">
      <div class="col-md-3 form-group">
        {{ form.entity_type.label }}
        {{ form.entity_type(class="form-control") }}
      </div>
      <div class="col-md-3 form-group" id="customer-group">
        {{ form.customer_id.label }}
        {{ form.customer_id(class="form-control") }}
      </div>
      <div class="col-md-3 form-group d-none" id="supplier-group">
        {{ form.supplier_id.label }}
        {{ form.supplier_id(class="form-control") }}
      </div>
      <div class="col-md-3 form-group d-none" id="partner-group">
        {{ form.partner_id.label }}
        {{ form.partner_id(class="form-control") }}
      </div>
    </div>

    <div class="form-row">
      <div class="col-md-3 form-group">
        {{ form.amount.label }}
        {{ form.amount(class="form-control", min=0, step="0.01") }}
      </div>
      <div class="col-md-3 form-group">
        {{ form.currency.label }}
        {{ form.currency(class="form-control") }}
      </div>
      <div class="col-md-6 form-group">
        {{ form.note.label }}
        {{ form.note(class="form-control") }}
      </div>
    </div>

    <h5>طرق الدفع</h5>
    <div id="split-methods-container">
      {% for sm in form.split_methods %}
      <div class="form-row split-method-entry mb-2">
        <div class="col-md-4">
          {{ sm.method.label }} {{ sm.method(class="form-control") }}
        </div>
        <div class="col-md-4">
          {{ sm.amount.label }} {{ sm.amount(class="form-control", min=0, step="0.01") }}
        </div>
        <div class="col-md-4">
          <button type="button" class="btn btn-danger btn-sm remove-split-method">حذف</button>
        </div>
      </div>
      {% endfor %}
    </div>
    <button type="button" class="btn btn-secondary mb-3" id="add-split-method-btn">إضافة طريقة دفع</button>

    {# כפתור שמירה מוגן בהרשאה #}
    {% if (not payment and current_user.has_permission('add_payment'))
          or (payment and current_user.has_permission('edit_payment')) %}
      <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    {% endif %}

    <a href="{{ url_for('parts.preorders_list') }}" class="btn btn-secondary ml-2">إلغاء</a>
  </form>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- سكربتات الدفع المطلوبة للاختبارات والإنتاج -->
  <script src="{{ url_for('static', filename='js/payment_form.js') }}"></script>
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    function toggleEntityGroups() {
      const type = document.querySelector('select[name="entity_type"]').value;
      document.getElementById('customer-group').classList.toggle('d-none', type !== 'customer');
      document.getElementById('supplier-group').classList.toggle('d-none', type !== 'supplier');
      document.getElementById('partner-group').classList.toggle('d-none', type !== 'partner');
    }
    document.querySelector('select[name="entity_type"]').addEventListener('change', toggleEntityGroups);
    toggleEntityGroups();

    const container = document.getElementById('split-methods-container');
    document.getElementById('add-split-method-btn').addEventListener('click', () => {
      const index = container.children.length;
      const html = `
        <div class="form-row split-method-entry mb-2">
          <div class="col-md-4">
            <select name="split_methods-${index}-method" class="form-control" required>
              <option value="cash">نقداً</option>
              <option value="card">بطاقة بنكية</option>
              <option value="bank">تحويل بنكي</option>
              <option value="cheque">شيك</option>
              <option value="installment">تقسيط</option>
              <option value="credit">ذمم</option>
            </select>
          </div>
          <div class="col-md-4">
            <input type="number" name="split_methods-${index}-amount" class="form-control" min="0" step="0.01" required>
          </div>
          <div class="col-md-4">
            <button type="button" class="btn btn-danger btn-sm remove-split-method">حذف</button>
          </div>
        </div>`;
      container.insertAdjacentHTML('beforeend', html);
    });

    container.addEventListener('click', (e) => {
      if(e.target.classList.contains('remove-split-method')){
        e.target.closest('.split-method-entry').remove();
      }
    });
  });
  </script>
{% endblock %}
