{% extends 'base.html' %}
{% block title %}ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
<style>
  .trend-up {
    color: #dc3545;
  }
  .trend-down {
    color: #28a745;
  }
  .trend-stable {
    color: #ffc107;
  }
  .chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 20px;
  }
</style>
{% endblock %}
{% block page_title %}ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-chart-line text-info"></i> 
                    ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-left">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('advanced.accounting_control') }}"><i class="fas fa-sliders-h"></i> Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('cost_centers.index') }}">Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</a></li>
                    <li class="breadcrumb-item active">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
<div class="container-fluid">
  
  <div class="row mb-3 no-print">
    <div class="col-md-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <form method="GET" class="form-inline">
            <div class="form-group mx-2">
              <label class="mr-2">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©:</label>
              <select name="cost_center" class="form-control">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Ø£ÙˆÙ„ 10)</option>
                {% for center in cost_centers %}
                <option value="{{ center.id }}" {% if selected_center == center.id %}selected{% endif %}>
                  {{ center.code }} - {{ center.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group mx-2">
              <label class="mr-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±:</label>
              <select name="months" class="form-control">
                <option value="6" {% if months == 6 %}selected{% endif %}>6 Ø£Ø´Ù‡Ø±</option>
                <option value="12" {% if months == 12 %}selected{% endif %}>12 Ø´Ù‡Ø±</option>
                <option value="18" {% if months == 18 %}selected{% endif %}>18 Ø´Ù‡Ø±</option>
                <option value="24" {% if months == 24 %}selected{% endif %}>24 Ø´Ù‡Ø±</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary mx-2">
              <i class="fas fa-search"></i> Ø¹Ø±Ø¶
            </button>
            <a href="{{ url_for('cost_centers_advanced.report_trends') }}" class="btn btn-secondary mx-2">
              <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            </a>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3 no-print">
    <div class="col-12">
      <div class="btn-group">
        <a href="{{ url_for('cost_centers.index') }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø±Ø§ÙƒØ²
        </a>
        <button class="btn btn-secondary" onclick="window.print()">
          <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
        </button>
      </div>
    </div>
  </div>

  {% for item in trends_data %}
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-gradient-info text-white">
      <h4 class="card-title mb-0">
        <i class="fas fa-building"></i> {{ item.center.code }} - {{ item.center.name }}
        {% if item.trend == 'up' %}
          <span class="badge badge-danger float-left"><i class="fas fa-arrow-up"></i> Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯</span>
        {% elif item.trend == 'down' %}
          <span class="badge badge-success float-left"><i class="fas fa-arrow-down"></i> Ø§ØªØ¬Ø§Ù‡ Ù†Ø§Ø²Ù„</span>
        {% else %}
          <span class="badge badge-warning float-left"><i class="fas fa-arrows-alt-h"></i> Ù…Ø³ØªÙ‚Ø±</span>
        {% endif %}
      </h4>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="info-box bg-light">
            <span class="info-box-icon bg-info"><i class="fas fa-calculator"></i></span>
            <div class="info-box-content">
              <span class="info-box-text">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</span>
              <span class="info-box-number">{{ "{:,.2f}".format(item.avg_monthly) }} â‚ª</span>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-box bg-light">
            <span class="info-box-icon {% if item.trend == 'up' %}bg-danger{% elif item.trend == 'down' %}bg-success{% else %}bg-warning{% endif %}">
              <i class="fas fa-chart-line"></i>
            </span>
            <div class="info-box-content">
              <span class="info-box-text">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</span>
              <span class="info-box-number">
                {% if item.trend == 'up' %}
                  <span class="trend-up"><i class="fas fa-arrow-up"></i> ØµØ§Ø¹Ø¯</span>
                {% elif item.trend == 'down' %}
                  <span class="trend-down"><i class="fas fa-arrow-down"></i> Ù†Ø§Ø²Ù„</span>
                {% else %}
                  <span class="trend-stable"><i class="fas fa-arrows-alt-h"></i> Ù…Ø³ØªÙ‚Ø±</span>
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="trendChart{{ loop.index }}"></canvas>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead class="table-light">
            <tr>
              <th>Ø§Ù„Ø´Ù‡Ø±</th>
              <th class="text-end">Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
              <th>Ø§Ù„Ù…Ø¤Ø´Ø±</th>
            </tr>
          </thead>
          <tbody>
            {% for month in item.monthly_data %}
            <tr>
              <td>{{ month.month_name }}</td>
              <td class="text-end">{{ "{:,.2f}".format(month.amount) }} â‚ª</td>
              <td>
                <div class="progress" style="height: 20px;">
                  {% set max_amount = item.monthly_data|map(attribute='amount')|max %}
                  {% set percentage = (month.amount / max_amount * 100) if max_amount > 0 else 0 %}
                  <div class="progress-bar bg-info" role="progressbar" style="width: {{ percentage }}%">
                    {{ "{:.0f}".format(percentage) }}%
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-secondary">
            <tr>
              <th>Ø§Ù„Ù…ØªÙˆØ³Ø·</th>
              <th class="text-end">{{ "{:,.2f}".format(item.avg_monthly) }} â‚ª</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="card border-0 shadow-sm">
    <div class="card-body text-center text-muted py-5">
      <i class="fas fa-chart-line fa-4x mb-3"></i>
      <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</h4>
      <p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ© Ø£Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ®ØµÙŠØµØ§Øª</p>
    </div>
  </div>
  {% endfor %}

  <div class="row mt-3 no-print">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> ØªÙˆØ¶ÙŠØ­Ø§Øª</h5>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li><strong><span class="trend-up">Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯ â†‘:</span></strong> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£Ø®ÙŠØ± Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ Ù‚Ø¨Ù„Ù‡</li>
            <li><strong><span class="trend-down">Ø§ØªØ¬Ø§Ù‡ Ù†Ø§Ø²Ù„ â†“:</span></strong> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£Ø®ÙŠØ± Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ Ù‚Ø¨Ù„Ù‡</li>
            <li><strong><span class="trend-stable">Ù…Ø³ØªÙ‚Ø± â†’:</span></strong> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ø³Ø§ÙˆÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ Ù‚Ø¨Ù„Ù‡</li>
            <li><strong>Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ:</strong> Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</li>
            <li><strong>Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ:</strong> ÙŠÙˆØ¶Ø­ ØªØºÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ø¨Ø± Ø§Ù„Ø£Ø´Ù‡Ø±</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/print.js') }}"></script>
<script>
{% for item in trends_data %}
(function() {
    const ctx = document.getElementById('trendChart{{ loop.index }}');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ item.monthly_data|map(attribute='month_name')|list|tojson }},
                datasets: [{
                    label: 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ (â‚ª)',
                    data: {{ item.monthly_data|map(attribute='amount')|list|tojson }},
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Ø§Ù„Ù…ØªÙˆØ³Ø· (â‚ª)',
                    data: Array({{ item.monthly_data|length }}).fill({{ item.avg_monthly }}),
                    borderColor: '#ffc107',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += new Intl.NumberFormat('ar-ILS', { 
                                    style: 'currency', 
                                    currency: 'ILS' 
                                }).format(context.parsed.y);
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('ar-ILS').format(value) + ' â‚ª';
                            }
                        }
                    }
                }
            }
        });
    }
})();
{% endfor %}

function exportToExcel() {
    window.print();
}
</script>
{% endblock %}


