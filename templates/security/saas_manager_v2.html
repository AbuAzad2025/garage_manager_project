{% extends 'base.html' %}
{% block title %}🚀 إدارة SaaS{% endblock %}
{% block page_title %}🚀 إدارة SaaS المتقدمة{% endblock %}

{% block head_extra %}
<style>
.saas-card {
  border-radius: 16px;
  border: none;
  transition: all 0.3s ease;
}

.saas-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
}

.plan-card {
  border-radius: 16px;
  border: 3px solid transparent;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.plan-card.recommended {
  border-color: #f5576c;
  box-shadow: 0 0 30px rgba(245, 87, 108, 0.3);
}

.plan-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 2rem;
  text-align: center;
  border-radius: 13px 13px 0 0;
}

.plan-header.gold {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.plan-header.silver {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.plan-price {
  font-size: 3rem;
  font-weight: 800;
  margin: 1rem 0;
}

.plan-price small {
  font-size: 1rem;
  opacity: 0.8;
}

.plan-feature {
  padding: 0.8rem;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.plan-feature i {
  color: #28a745;
}

.status-badge {
  padding: 0.4rem 1rem;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.85rem;
}

.status-active {background: #d4edda; color: #155724;}
.status-expired {background: #f8d7da; color: #721c24;}
.status-trial {background: #fff3cd; color: #856404;}
.status-cancelled {background: #f0f0f0; color: #666;}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

  <div class="row mb-4">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('security.dashboard') }}"><i class="fas fa-shield-alt"></i> Security</a></li>
          <li class="breadcrumb-item active">SaaS Manager</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <i class="fas fa-users fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.total_subscribers }}</h3>
        <small>إجمالي المشتركين</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
        <i class="fas fa-check-circle fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.active_subscribers }}</h3>
        <small>مشتركين نشطين</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <i class="fas fa-dollar-sign fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.monthly_revenue }}</h3>
        <small>الإيرادات الشهرية</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
        <i class="fas fa-clock fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.trial_users }}</h3>
        <small>تجريبي</small>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills nav-fill mb-4" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="pill" href="#plans">
        <i class="fas fa-box me-1"></i> الباقات
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="pill" href="#subscribers">
        <i class="fas fa-users me-1"></i> المشتركين ({{ subscriptions|length }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="pill" href="#billing">
        <i class="fas fa-file-invoice-dollar me-1"></i> الفواتير ({{ invoices|length }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="pill" href="#analytics">
        <i class="fas fa-chart-line me-1"></i> التحليلات
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="pill" href="#settings">
        <i class="fas fa-cog me-1"></i> الإعدادات
      </a>
    </li>
  </ul>

  <div class="tab-content">
    
    <div id="plans" class="tab-pane fade show active">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-layer-group me-2"></i>باقات الاشتراك ({{ plans|length }})</h5>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newPlanModal">
          <i class="fas fa-plus me-1"></i> باقة جديدة
        </button>
      </div>

      <div class="row g-4">
        {% if plans %}
          {% for plan in plans %}
          <div class="col-lg-4 col-md-6">
            <div class="plan-card shadow {% if plan.is_popular %}recommended{% endif %}">
              <div class="plan-header {% if plan.is_popular %}gold{% elif loop.index == 1 %}{% else %}silver{% endif %}">
                {% if plan.is_popular %}<span class="badge bg-white text-dark mb-2">⭐ الأكثر شعبية</span>{% endif %}
                <h4>{{ plan.name }}</h4>
                <div class="plan-price">${{ "%.0f"|format(plan.price_monthly) }}<small>/شهر</small></div>
                {% if plan.price_yearly %}
                <small class="opacity-75">${{ "%.0f"|format(plan.price_yearly) }}/سنة (وفّر {{ "%.0f"|format((plan.price_monthly * 12) - plan.price_yearly) }}$)</small>
                {% endif %}
                <p class="mb-0 mt-2">{{ plan.description or '' }}</p>
              </div>
              <div class="p-3">
                {% if plan.max_users %}
                  <div class="plan-feature">
                    <i class="fas fa-check"></i> 
                    {% if plan.max_users == -1 %}
                      <strong>مستخدمين غير محدود</strong>
                    {% else %}
                      {{ plan.max_users }} مستخدم
                    {% endif %}
                  </div>
                {% endif %}
                {% if plan.max_invoices %}
                  <div class="plan-feature">
                    <i class="fas fa-check"></i> 
                    {% if plan.max_invoices == -1 %}
                      <strong>فواتير غير محدودة</strong>
                    {% else %}
                      {{ plan.max_invoices }} فاتورة/شهر
                    {% endif %}
                  </div>
                {% endif %}
                {% if plan.storage_gb %}
                  <div class="plan-feature">
                    <i class="fas fa-check"></i> 
                    {% if plan.storage_gb == -1 %}
                      <strong>تخزين غير محدود</strong>
                    {% else %}
                      {{ plan.storage_gb }} GB تخزين
                    {% endif %}
                  </div>
                {% endif %}
                {% if plan.features %}
                  {% for feature in plan.features.split('\n') %}
                    {% if feature.strip() %}
                    <div class="plan-feature"><i class="fas fa-check"></i> {{ feature.strip() }}</div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                <div class="d-grid gap-2 mt-3">
                  <button class="btn {% if plan.is_popular %}btn-danger{% else %}btn-outline-primary{% endif %}" onclick="editPlan({{ plan.id }})">
                    <i class="fas fa-edit me-1"></i> تعديل
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              لا توجد باقات. اضغط "باقة جديدة" لإنشاء أول باقة.
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div id="subscribers" class="tab-pane fade">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-users me-2"></i>قائمة المشتركين ({{ subscriptions|length }})</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary"><i class="fas fa-filter"></i> فلترة</button>
          <button class="btn btn-sm btn-outline-success"><i class="fas fa-download"></i> تصدير</button>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newSubscriberModal">
            <i class="fas fa-plus me-1"></i> مشترك جديد
          </button>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>العميل</th>
                  <th>الباقة</th>
                  <th>الحالة</th>
                  <th>بدء الاشتراك</th>
                  <th>انتهاء الاشتراك</th>
                  <th class="text-center">الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% if subscriptions %}
                  {% for sub in subscriptions %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                          {{ sub.customer.name[0]|upper if sub.customer else '?' }}
                        </div>
                        <div>
                          <strong>{{ sub.customer.name if sub.customer else 'N/A' }}</strong><br>
                          <small class="text-muted">{{ sub.customer.email if sub.customer else '' }}</small>
                        </div>
                      </div>
                    </td>
                    <td><span class="badge bg-{% if sub.status == 'active' %}success{% elif sub.status == 'trial' %}warning text-dark{% else %}secondary{% endif %}">{{ sub.plan.name if sub.plan else 'N/A' }}</span></td>
                    <td>
                      <span class="status-badge status-{{ sub.status }}">
                        {% if sub.status == 'active' %}✓ نشط
                        {% elif sub.status == 'trial' %}⏱ تجريبي
                        {% elif sub.status == 'expired' %}✗ منتهي
                        {% elif sub.status == 'cancelled' %}🚫 ملغي
                        {% else %}{{ sub.status }}{% endif %}
                      </span>
                    </td>
                    <td>{{ sub.start_date.strftime('%Y-%m-%d') if sub.start_date else 'N/A' }}</td>
                    <td>
                      {% if sub.end_date %}
                        {{ sub.end_date.strftime('%Y-%m-%d') }}
                        {% set days_left = (sub.end_date - now()).days if sub.end_date > now() else 0 %}
                        {% if days_left > 0 and days_left <= 7 %}
                          <span class="badge bg-warning text-dark">{{ days_left }} يوم متبقي</span>
                        {% endif %}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewSubscription({{ sub.id }})" title="عرض"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-outline-warning" onclick="editSubscription({{ sub.id }})" title="تعديل"><i class="fas fa-edit"></i></button>
                        {% if sub.status == 'active' %}
                        <button class="btn btn-outline-danger" onclick="cancelSubscription({{ sub.id }})" title="إلغاء"><i class="fas fa-ban"></i></button>
                        {% elif sub.status == 'expired' %}
                        <button class="btn btn-outline-success" onclick="renewSubscription({{ sub.id }})" title="تجديد"><i class="fas fa-redo"></i></button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                      <i class="fas fa-users fa-3x mb-3 d-block opacity-50"></i>
                      <h5>لا يوجد مشتركين حالياً</h5>
                      <p>ابدأ بإضافة أول مشترك</p>
                      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSubscriberModal">
                        <i class="fas fa-plus me-1"></i> إضافة مشترك
                      </button>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="billing" class="tab-pane fade">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-file-invoice-dollar me-2"></i>الفواتير والمدفوعات ({{ invoices|length }})</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary"><i class="fas fa-filter"></i> فلترة</button>
          <button class="btn btn-sm btn-outline-success"><i class="fas fa-download"></i> تصدير</button>
          <button class="btn btn-sm btn-primary" onclick="createInvoice()">
            <i class="fas fa-plus me-1"></i> فاتورة جديدة
          </button>
        </div>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>رقم الفاتورة</th>
                  <th>العميل</th>
                  <th>المبلغ</th>
                  <th>التاريخ</th>
                  <th>الاستحقاق</th>
                  <th>الحالة</th>
                  <th class="text-center">الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% if invoices %}
                  {% for inv in invoices %}
                  <tr>
                    <td><strong>{{ inv.invoice_number }}</strong></td>
                    <td>{{ inv.subscription.customer.name if inv.subscription and inv.subscription.customer else 'N/A' }}</td>
                    <td><strong>{{ inv.currency }}{{ "%.2f"|format(inv.amount) }}</strong></td>
                    <td>{{ inv.created_at.strftime('%Y-%m-%d') if inv.created_at else 'N/A' }}</td>
                    <td>
                      {% if inv.due_date %}
                        {{ inv.due_date.strftime('%Y-%m-%d') }}
                        {% set overdue = (now() - inv.due_date).days if inv.due_date < now() and inv.status != 'paid' else 0 %}
                        {% if overdue > 0 %}
                          <span class="badge bg-danger">متأخرة {{ overdue }} يوم</span>
                        {% endif %}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge bg-{% if inv.status == 'paid' %}success{% elif inv.status == 'pending' %}warning text-dark{% elif inv.status == 'overdue' %}danger{% else %}secondary{% endif %}">
                        {% if inv.status == 'paid' %}✓ مدفوعة
                        {% elif inv.status == 'pending' %}⏱ معلقة
                        {% elif inv.status == 'overdue' %}⚠️ متأخرة
                        {% elif inv.status == 'cancelled' %}✗ ملغاة
                        {% else %}{{ inv.status }}{% endif %}
                      </span>
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="downloadInvoice({{ inv.id }})" title="PDF"><i class="fas fa-file-pdf"></i></button>
                        {% if inv.status == 'pending' or inv.status == 'overdue' %}
                        <button class="btn btn-outline-success" onclick="markPaid({{ inv.id }})" title="تأكيد الدفع"><i class="fas fa-check"></i></button>
                        <button class="btn btn-outline-info" onclick="sendReminder({{ inv.id }})" title="إرسال تذكير"><i class="fas fa-envelope"></i></button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                      <i class="fas fa-file-invoice fa-3x mb-3 d-block opacity-50"></i>
                      <h5>لا توجد فواتير حالياً</h5>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="analytics" class="tab-pane fade">
      <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>تحليلات SaaS المتقدمة</h5>
      
      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body text-center">
              <i class="fas fa-dollar-sign fa-3x mb-3 opacity-75"></i>
              <h6>الإيرادات الشهرية</h6>
              <h2 class="mb-0">{{ stats.monthly_revenue }}</h2>
              <small class="opacity-75"><i class="fas fa-arrow-up"></i> MRR</small>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="card shadow-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
            <div class="card-body text-center">
              <i class="fas fa-chart-line fa-3x mb-3 opacity-75"></i>
              <h6>معدل النمو</h6>
              <h2 class="mb-0">+23%</h2>
              <small class="opacity-75">مقارنة بالشهر الماضي</small>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="card shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <div class="card-body text-center">
              <i class="fas fa-percent fa-3x mb-3 opacity-75"></i>
              <h6>معدل التحويل</h6>
              <h2 class="mb-0">65%</h2>
              <small class="opacity-75">Trial → Paid</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>توزيع الباقات</h6>
              <div style="height: 300px; display: flex; align-items: center; justify-content: center; color: #999;">
                <div class="text-center">
                  <i class="fas fa-chart-pie fa-4x mb-3"></i>
                  <p>Chart.js سيتم دمجه قريباً</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>نمو المشتركين (آخر 12 شهر)</h6>
              <div style="height: 300px; display: flex; align-items: center; justify-content: center; color: #999;">
                <div class="text-center">
                  <i class="fas fa-chart-line fa-4x mb-3"></i>
                  <p>Chart.js سيتم دمجه قريباً</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3"><i class="fas fa-table me-2"></i>ملخص الأداء</h6>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>المقياس</th>
                      <th>القيمة</th>
                      <th>الهدف</th>
                      <th>الحالة</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><i class="fas fa-users me-2"></i>إجمالي المشتركين</td>
                      <td><strong>{{ stats.total_subscribers }}</strong></td>
                      <td>100</td>
                      <td><span class="badge bg-{% if stats.total_subscribers >= 100 %}success{% else %}warning{% endif %}">{{ "%.0f"|format((stats.total_subscribers / 100) * 100) }}%</span></td>
                    </tr>
                    <tr>
                      <td><i class="fas fa-dollar-sign me-2"></i>الإيرادات الشهرية</td>
                      <td><strong>{{ stats.monthly_revenue }}</strong></td>
                      <td>$10,000</td>
                      <td><span class="badge bg-info">قيد التقدم</span></td>
                    </tr>
                    <tr>
                      <td><i class="fas fa-chart-line me-2"></i>معدل التحويل</td>
                      <td><strong>65%</strong></td>
                      <td>75%</td>
                      <td><span class="badge bg-warning text-dark">يحتاج تحسين</span></td>
                    </tr>
                    <tr>
                      <td><i class="fas fa-redo me-2"></i>معدل التجديد</td>
                      <td><strong>92%</strong></td>
                      <td>90%</td>
                      <td><span class="badge bg-success">ممتاز</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="settings" class="tab-pane fade">
      <h5 class="mb-3"><i class="fas fa-cog me-2"></i>إعدادات SaaS</h5>
      
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>إعدادات الدفع</h6>
            </div>
            <div class="card-body">
              <form>
                <div class="mb-3">
                  <label class="form-label">طريقة الدفع الافتراضية</label>
                  <select class="form-select">
                    <option selected>Stripe</option>
                    <option>PayPal</option>
                    <option>Bank Transfer</option>
                    <option>Credit Card</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">العملة الافتراضية</label>
                  <select class="form-select">
                    <option selected>USD - Dollar</option>
                    <option>ILS - Shekel</option>
                    <option>EUR - Euro</option>
                    <option>JOD - Dinar</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Stripe Secret Key</label>
                  <input type="password" class="form-control" placeholder="sk_test_...">
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-1"></i> حفظ إعدادات الدفع
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0"><i class="fas fa-clock me-2"></i>إعدادات الاشتراك</h6>
            </div>
            <div class="card-body">
              <form>
                <div class="mb-3">
                  <label class="form-label">مدة التجربة (أيام)</label>
                  <input type="number" class="form-control" value="14">
                  <small class="text-muted">المدة الافتراضية للفترة التجريبية</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">التجديد التلقائي</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" checked id="autoRenew">
                    <label class="form-check-label" for="autoRenew">
                      تفعيل التجديد التلقائي للاشتراكات
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">تنبيه قبل الانتهاء (أيام)</label>
                  <input type="number" class="form-control" value="7">
                  <small class="text-muted">إرسال تنبيه للعميل قبل انتهاء الاشتراك</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">Grace Period (أيام)</label>
                  <input type="number" class="form-control" value="3">
                  <small class="text-muted">مهلة إضافية بعد انتهاء الاشتراك</small>
                </div>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-save me-1"></i> حفظ إعدادات الاشتراك
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0"><i class="fas fa-envelope me-2"></i>إعدادات البريد الإلكتروني</h6>
            </div>
            <div class="card-body">
              <form>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">البريد المُرسل</label>
                    <input type="email" class="form-control" placeholder="billing@company.com">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">اسم المُرسل</label>
                    <input type="text" class="form-control" placeholder="Company Billing">
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" checked id="sendWelcome">
                      <label class="form-check-label" for="sendWelcome">
                        إرسال بريد ترحيبي للمشتركين الجدد
                      </label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" checked id="sendInvoice">
                      <label class="form-check-label" for="sendInvoice">
                        إرسال الفواتير تلقائياً عبر البريد
                      </label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" checked id="sendReminder">
                      <label class="form-check-label" for="sendReminder">
                        إرسال تذكير قبل انتهاء الاشتراك
                      </label>
                    </div>
                  </div>
                  <div class="col-12">
                    <button type="submit" class="btn btn-warning text-dark">
                      <i class="fas fa-save me-1"></i> حفظ إعدادات البريد
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<div class="modal fade" id="newPlanModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-plus me-2"></i>باقة جديدة</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newPlanForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">اسم الباقة *</label>
              <input type="text" class="form-control" name="name" placeholder="مثال: Premium" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">الوصف</label>
              <input type="text" class="form-control" name="description" placeholder="للشركات المتوسطة">
            </div>
            <div class="col-md-4">
              <label class="form-label">السعر الشهري ($) *</label>
              <input type="number" step="0.01" class="form-control" name="price_monthly" placeholder="99.00" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">السعر السنوي ($)</label>
              <input type="number" step="0.01" class="form-control" name="price_yearly" placeholder="990.00">
            </div>
            <div class="col-md-4">
              <label class="form-label">العملة</label>
              <select class="form-select" name="currency">
                <option selected>USD</option>
                <option>ILS</option>
                <option>EUR</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">عدد المستخدمين</label>
              <input type="number" class="form-control" name="max_users" placeholder="10 (-1 = غير محدود)">
            </div>
            <div class="col-md-4">
              <label class="form-label">عدد الفواتير/شهر</label>
              <input type="number" class="form-control" name="max_invoices" placeholder="100 (-1 = غير محدود)">
            </div>
            <div class="col-md-4">
              <label class="form-label">التخزين (GB)</label>
              <input type="number" class="form-control" name="storage_gb" placeholder="50 (-1 = غير محدود)">
            </div>
            <div class="col-12">
              <label class="form-label">المميزات (كل سطر = مميزة)</label>
              <textarea class="form-control" name="features" rows="4" placeholder="دعم فني متقدم
API Access
تقارير مخصصة"></textarea>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_popular" id="isPop">
                <label class="form-check-label" for="isPop">
                  <strong>الباقة الأكثر شعبية</strong> (ستظهر بتصميم مميز)
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-primary" onclick="savePlan()">
          <i class="fas fa-save me-1"></i> حفظ
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="newSubscriberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>مشترك جديد</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newSubscriberForm">
          <div class="mb-3">
            <label class="form-label">العميل *</label>
            <select class="form-select" name="customer_id" required>
              <option value="">اختر عميل...</option>
            </select>
            <small class="text-muted">سيتم جلب العملاء من قاعدة البيانات</small>
          </div>
          <div class="mb-3">
            <label class="form-label">الباقة *</label>
            <select class="form-select" name="plan_id" required>
              {% for plan in plans %}
              <option value="{{ plan.id }}">{{ plan.name }} - ${{ "%.0f"|format(plan.price_monthly) }}/شهر</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">تاريخ البدء *</label>
            <input type="date" class="form-control" name="start_date" required>
          </div>
          <div class="mb-3">
            <label class="form-label">الحالة</label>
            <select class="form-select" name="status">
              <option value="trial">تجريبي</option>
              <option value="active" selected>نشط</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-success" onclick="saveSubscriber()">
          <i class="fas fa-save me-1"></i> حفظ
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function csrfToken(){
  const meta = document.querySelector('meta[name="csrf-token"]');
  if (meta?.content) return meta.content;
  const input = document.querySelector('input[name="csrf_token"]');
  if (input?.value) return input.value;
  const cookie = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
  return cookie ? decodeURIComponent(cookie[1]) : null;
}

function notify(message, type = 'info') {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  alert.innerHTML = `<strong>${message}</strong><button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 5000);
}

async function savePlan() {
  const form = document.getElementById('newPlanForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  
  notify('جاري الحفظ...', 'info');
  
  try {
    const res = await fetch('/api/saas/plans', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken()
      },
      body: JSON.stringify(data)
    });
    
    if (res.ok) {
      notify('✓ تم حفظ الباقة بنجاح!', 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      notify('✗ فشل الحفظ', 'danger');
    }
  } catch (e) {
    notify('سيتم إضافة API قريباً', 'warning');
  }
}

async function saveSubscriber() {
  notify('سيتم إضافة API قريباً', 'info');
}

async function editPlan(planId) {
  notify('قريباً...', 'info');
}

async function viewSubscription(subId) {
  notify('قريباً...', 'info');
}

async function editSubscription(subId) {
  notify('قريباً...', 'info');
}

async function cancelSubscription(subId) {
  if (!confirm('هل أنت متأكد من إلغاء هذا الاشتراك؟')) return;
  notify('قريباً...', 'warning');
}

async function renewSubscription(subId) {
  if (!confirm('تجديد الاشتراك؟')) return;
  notify('قريباً...', 'info');
}

async function downloadInvoice(invId) {
  notify('جاري التحميل...', 'info');
}

async function markPaid(invId) {
  if (!confirm('تأكيد الدفع؟')) return;
  notify('قريباً...', 'success');
}

async function sendReminder(invId) {
  if (!confirm('إرسال تذكير للعميل؟')) return;
  notify('سيتم الإرسال...', 'info');
}

async function createInvoice() {
  notify('قريباً...', 'info');
}
</script>
{% endblock %}

