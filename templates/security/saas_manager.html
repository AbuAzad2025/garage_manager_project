{% extends 'base.html' %}
{% block title %}ğŸš€ Ø¥Ø¯Ø§Ø±Ø© SaaS{% endblock %}
{% block page_title %}ğŸš€ Ø¥Ø¯Ø§Ø±Ø© SaaS Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.saas-card {
  border-radius: 16px;
  border: none;
  transition: all 0.3s ease;
}

.saas-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
}

.plan-card {
  border-radius: 16px;
  border: 3px solid transparent;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.plan-card.recommended {
  border-color: #f5576c;
  box-shadow: 0 0 30px rgba(245, 87, 108, 0.3);
}

.plan-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 2rem;
  text-align: center;
  border-radius: 13px 13px 0 0;
}

.plan-header.gold {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.plan-header.silver {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.plan-price {
  font-size: 3rem;
  font-weight: 800;
  margin: 1rem 0;
}

.plan-price small {
  font-size: 1rem;
  opacity: 0.8;
}

.plan-feature {
  padding: 0.8rem;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.plan-feature i {
  color: #28a745;
}

.status-badge {
  padding: 0.4rem 1rem;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.85rem;
}

.status-active {background: #d4edda; color: #155724;}
.status-expired {background: #f8d7da; color: #721c24;}
.status-trial {background: #fff3cd; color: #856404;}
.status-cancelled {background: #f0f0f0; color: #666;}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

  <div class="row mb-3">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('security.dashboard') }}"><i class="fas fa-shield-alt"></i> Security</a></li>
          <li class="breadcrumb-item active">SaaS Manager</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹ ÙˆÙˆØ§Ø¶Ø­ -->
  <div class="alert alert-primary border-0 shadow-sm mb-4">
    <div class="row align-items-center">
      <div class="col-md-8">
        <div class="d-flex align-items-start">
          <i class="fas fa-graduation-cap fa-3x me-3 text-primary"></i>
          <div>
            <h5 class="mb-2"><i class="fas fa-rocket"></i> Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ SaaS Manager - ØµØ¯ÙŠÙ‚Ùƒ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª!</h5>
            <p class="mb-1"><strong>Ù…Ø§ Ù‡Ùˆ SaaSØŸ</strong> Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¨ÙŠØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ØªØ¤Ø¬Ø±Ù‡ Ø´Ù‡Ø±ÙŠØ§Ù‹ = <span class="badge bg-success">ğŸ’° Ø¯Ø®Ù„ Ø«Ø§Ø¨Øª ÙˆÙ…Ø³ØªÙ…Ø±</span></p>
            <p class="mb-0 small text-muted">
              <i class="fas fa-info-circle"></i> <strong>3 Ø£Ø´ÙŠØ§Ø¡ Ø±Ø¦ÙŠØ³ÙŠØ©:</strong> 
              ğŸ“¦ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø§Ù„Ø®Ø·Ø·) â€¢ 
              ğŸ« Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡) â€¢ 
              ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª)
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-4 text-end">
        <button class="btn btn-light btn-lg shadow-sm" data-toggle="modal" data-target="#helpModal">
          <i class="fas fa-book-open"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„
        </button>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" 
           data-toggle="tooltip" data-placement="top" title="Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙŠ Ø®Ø¯Ù…ØªÙƒ (Ù†Ø´Ø· + ØªØ¬Ø±ÙŠØ¨ÙŠ + Ù…Ù†ØªÙ‡ÙŠ + Ù…Ù„ØºÙŠ)">
        <i class="fas fa-users fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.total_subscribers }}</h3>
        <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;"
           data-toggle="tooltip" data-placement="top" title="Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø§Ù„Ù„ÙŠ ÙŠØ¯ÙØ¹ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹">
        <i class="fas fa-check-circle fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.active_subscribers }}</h3>
        <small>Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;"
           data-toggle="tooltip" data-placement="top" title="Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù†Ø´Ø·Ø© (MRR = Monthly Recurring Revenue)">
        <i class="fas fa-dollar-sign fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.monthly_revenue }}</h3>
        <small>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="saas-card shadow-sm p-3" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;"
           data-toggle="tooltip" data-placement="top" title="Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙŠ ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©">
        <i class="fas fa-clock fa-2x mb-2"></i>
        <h3 class="mb-0">{{ stats.trial_users }}</h3>
        <small>ØªØ¬Ø±ÙŠØ¨ÙŠ</small>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills nav-fill mb-4" id="saasTabsList" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="plans-tab" data-toggle="tab" data-target="#plans" type="button" role="tab">
        <i class="fas fa-box me-1"></i> Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="subscribers-tab" data-toggle="tab" data-target="#subscribers" type="button" role="tab">
        <i class="fas fa-users me-1"></i> Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ({{ subscriptions|length }})
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="billing-tab" data-toggle="tab" data-target="#billing" type="button" role="tab">
        <i class="fas fa-file-invoice-dollar me-1"></i> Ø§Ù„ÙÙˆØ§ØªÙŠØ± ({{ invoices|length }})
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="analytics-tab" data-toggle="tab" data-target="#analytics" type="button" role="tab">
        <i class="fas fa-chart-line me-1"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="settings-tab" data-toggle="tab" data-target="#settings" type="button" role="tab">
        <i class="fas fa-cog me-1"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      </button>
    </li>
  </ul>

  <div class="tab-content">
    
    <div id="plans" class="tab-pane fade show active" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-layer-group me-2"></i>Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ({{ plans|length }})</h5>
        <button class="btn btn-primary" data-toggle="modal" data-target="#newPlanModal">
          <i class="fas fa-plus me-1"></i> Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
      </div>

      <div class="row g-4">
        {% if plans %}
          {% for plan in plans %}
          <div class="col-lg-4 col-md-6">
            <div class="plan-card shadow {% if plan.is_popular %}recommended{% endif %}">
              <div class="plan-header {% if plan.is_popular %}gold{% elif loop.index == 1 %}{% else %}silver{% endif %}">
                {% if plan.is_popular %}<span class="badge bg-white text-dark mb-2">â­ Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ©</span>{% endif %}
                <h4>{{ plan.name }}</h4>
                <div class="plan-price">${{ "%.0f"|format(plan.price_monthly) }}<small>/Ø´Ù‡Ø±</small></div>
                {% if plan.price_yearly %}
                <small class="opacity-75">${{ "%.0f"|format(plan.price_yearly) }}/Ø³Ù†Ø© (ÙˆÙÙ‘Ø± {{ "%.0f"|format((plan.price_monthly * 12) - plan.price_yearly) }}$)</small>
                {% endif %}
                <p class="mb-0 mt-2">{{ plan.description or '' }}</p>
              </div>
              <div class="p-3">
                {% if plan.max_users %}
                  <div class="plan-feature">
                    <i class="fas fa-check"></i> 
                    {% if plan.max_users == -1 %}
                      <strong>Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</strong>
                    {% else %}
                      {{ plan.max_users }} Ù…Ø³ØªØ®Ø¯Ù…
                    {% endif %}
                  </div>
                {% endif %}
                {% if plan.max_invoices %}
                  <div class="plan-feature">
                    <i class="fas fa-check"></i> 
                    {% if plan.max_invoices == -1 %}
                      <strong>ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</strong>
                    {% else %}
                      {{ plan.max_invoices }} ÙØ§ØªÙˆØ±Ø©/Ø´Ù‡Ø±
                    {% endif %}
                  </div>
                {% endif %}
                {% if plan.storage_gb %}
                  <div class="plan-feature">
                    <i class="fas fa-check"></i> 
                    {% if plan.storage_gb == -1 %}
                      <strong>ØªØ®Ø²ÙŠÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</strong>
                    {% else %}
                      {{ plan.storage_gb }} GB ØªØ®Ø²ÙŠÙ†
                    {% endif %}
                  </div>
                {% endif %}
                {% if plan.features %}
                  {% for feature in plan.features.split('\n') %}
                    {% if feature.strip() %}
                    <div class="plan-feature"><i class="fas fa-check"></i> {{ feature.strip() }}</div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                <div class="d-grid gap-2 mt-3">
                  <button class="btn {% if plan.is_popular %}btn-danger{% else %}btn-outline-primary{% endif %}" onclick="editPlan({{ plan.id }})">
                    <i class="fas fa-edit me-1"></i> ØªØ¹Ø¯ÙŠÙ„
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª. Ø§Ø¶ØºØ· "Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø¨Ø§Ù‚Ø©.
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div id="subscribers" class="tab-pane fade" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-users me-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ({{ subscriptions|length }})</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary"><i class="fas fa-filter"></i> ÙÙ„ØªØ±Ø©</button>
          <button class="btn btn-sm btn-outline-success"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±</button>
          <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#newSubscriberModal">
            <i class="fas fa-plus me-1"></i> Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
          </button>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                  <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                  <th>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                  <th class="text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                {% if subscriptions %}
                  {% for sub in subscriptions %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                          {{ sub.customer.name[0]|upper if sub.customer else '?' }}
                        </div>
                        <div>
                          <strong>{{ sub.customer.name if sub.customer else 'N/A' }}</strong><br>
                          <small class="text-muted">{{ sub.customer.email if sub.customer else '' }}</small>
                        </div>
                      </div>
                    </td>
                    <td><span class="badge bg-{% if sub.status == 'active' %}success{% elif sub.status == 'trial' %}warning text-dark{% else %}secondary{% endif %}">{{ sub.plan.name if sub.plan else 'N/A' }}</span></td>
                    <td>
                      <span class="status-badge status-{{ sub.status }}">
                        {% if sub.status == 'active' %}âœ“ Ù†Ø´Ø·
                        {% elif sub.status == 'trial' %}â± ØªØ¬Ø±ÙŠØ¨ÙŠ
                        {% elif sub.status == 'expired' %}âœ— Ù…Ù†ØªÙ‡ÙŠ
                        {% elif sub.status == 'cancelled' %}ğŸš« Ù…Ù„ØºÙŠ
                        {% else %}{{ sub.status }}{% endif %}
                      </span>
                    </td>
                    <td>{{ sub.start_date.strftime('%Y-%m-%d') if sub.start_date else 'N/A' }}</td>
                    <td>
                      {% if sub.end_date %}
                        {{ sub.end_date.strftime('%Y-%m-%d') }}
                        {% set days_left = (sub.end_date - now()).days if sub.end_date > now() else 0 %}
                        {% if days_left > 0 and days_left <= 7 %}
                          <span class="badge bg-warning text-dark">{{ days_left }} ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ</span>
                        {% endif %}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewSubscription({{ sub.id }})" title="Ø¹Ø±Ø¶"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-outline-warning" onclick="editSubscription({{ sub.id }})" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button>
                        {% if sub.status == 'active' %}
                        <button class="btn btn-outline-danger" onclick="cancelSubscription({{ sub.id }})" title="Ø¥Ù„ØºØ§Ø¡"><i class="fas fa-ban"></i></button>
                        {% elif sub.status == 'expired' %}
                        <button class="btn btn-outline-success" onclick="renewSubscription({{ sub.id }})" title="ØªØ¬Ø¯ÙŠØ¯"><i class="fas fa-redo"></i></button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                      <i class="fas fa-users fa-3x mb-3 d-block opacity-50"></i>
                      <h5>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</h5>
                      <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø´ØªØ±Ùƒ</p>
                      <button class="btn btn-primary" data-toggle="modal" data-target="#newSubscriberModal">
                        <i class="fas fa-plus me-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ
                      </button>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="billing" class="tab-pane fade" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-file-invoice-dollar me-2"></i>Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ({{ invoices|length }})</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary"><i class="fas fa-filter"></i> ÙÙ„ØªØ±Ø©</button>
          <button class="btn btn-sm btn-outline-success"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±</button>
          <button class="btn btn-sm btn-primary" onclick="createInvoice()">
            <i class="fas fa-plus me-1"></i> ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
          </button>
        </div>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th class="text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                {% if invoices %}
                  {% for inv in invoices %}
                  <tr>
                    <td><strong>{{ inv.invoice_number }}</strong></td>
                    <td>{{ inv.subscription.customer.name if inv.subscription and inv.subscription.customer else 'N/A' }}</td>
                    <td><strong>{{ inv.currency }}{{ "%.2f"|format(inv.amount) }}</strong></td>
                    <td>{{ inv.created_at.strftime('%Y-%m-%d') if inv.created_at else 'N/A' }}</td>
                    <td>
                      {% if inv.due_date %}
                        {{ inv.due_date.strftime('%Y-%m-%d') }}
                        {% set overdue = (now() - inv.due_date).days if inv.due_date < now() and inv.status != 'paid' else 0 %}
                        {% if overdue > 0 %}
                          <span class="badge bg-danger">Ù…ØªØ£Ø®Ø±Ø© {{ overdue }} ÙŠÙˆÙ…</span>
                        {% endif %}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge bg-{% if inv.status == 'paid' %}success{% elif inv.status == 'pending' %}warning text-dark{% elif inv.status == 'overdue' %}danger{% else %}secondary{% endif %}">
                        {% if inv.status == 'paid' %}âœ“ Ù…Ø¯ÙÙˆØ¹Ø©
                        {% elif inv.status == 'pending' %}â± Ù…Ø¹Ù„Ù‚Ø©
                        {% elif inv.status == 'overdue' %}âš ï¸ Ù…ØªØ£Ø®Ø±Ø©
                        {% elif inv.status == 'cancelled' %}âœ— Ù…Ù„ØºØ§Ø©
                        {% else %}{{ inv.status }}{% endif %}
                      </span>
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="downloadInvoice({{ inv.id }})" title="PDF"><i class="fas fa-file-pdf"></i></button>
                        {% if inv.status == 'pending' or inv.status == 'overdue' %}
                        <button class="btn btn-outline-success" onclick="markPaid({{ inv.id }})" title="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹"><i class="fas fa-check"></i></button>
                        <button class="btn btn-outline-info" onclick="sendReminder({{ inv.id }})" title="Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±"><i class="fas fa-envelope"></i></button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                      <i class="fas fa-file-invoice fa-3x mb-3 d-block opacity-50"></i>
                      <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹</h5>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="analytics" class="tab-pane fade" role="tabpanel">
      <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>ØªØ­Ù„ÙŠÙ„Ø§Øª SaaS Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h5>
      
      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body text-center">
              <i class="fas fa-dollar-sign fa-3x mb-3 opacity-75"></i>
              <h6>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h6>
              <h2 class="mb-0">{{ stats.monthly_revenue }}</h2>
              <small class="opacity-75"><i class="fas fa-arrow-up"></i> MRR</small>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="card shadow-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
            <div class="card-body text-center">
              <i class="fas fa-chart-line fa-3x mb-3 opacity-75"></i>
              <h6>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ</h6>
              <h2 class="mb-0">+23%</h2>
              <small class="opacity-75">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ</small>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="card shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <div class="card-body text-center">
              <i class="fas fa-percent fa-3x mb-3 opacity-75"></i>
              <h6>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</h6>
              <h2 class="mb-0">65%</h2>
              <small class="opacity-75">Trial â†’ Paid</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</h6>
              <canvas id="plansChart" height="250"></canvas>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Ù†Ù…Ùˆ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† (Ø¢Ø®Ø± 12 Ø´Ù‡Ø±)</h6>
              <canvas id="growthChart" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3"><i class="fas fa-table me-2"></i>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</h6>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</th>
                      <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                      <th>Ø§Ù„Ù‡Ø¯Ù</th>
                      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><i class="fas fa-users me-2"></i>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</td>
                      <td><strong>{{ stats.total_subscribers }}</strong></td>
                      <td>100</td>
                      <td><span class="badge bg-{% if stats.total_subscribers >= 100 %}success{% else %}warning{% endif %}">{{ "%.0f"|format((stats.total_subscribers / 100) * 100) }}%</span></td>
                    </tr>
                    <tr>
                      <td><i class="fas fa-dollar-sign me-2"></i>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</td>
                      <td><strong>{{ stats.monthly_revenue }}</strong></td>
                      <td>$10,000</td>
                      <td><span class="badge bg-info">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…</span></td>
                    </tr>
                    <tr>
                      <td><i class="fas fa-chart-line me-2"></i>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</td>
                      <td><strong>65%</strong></td>
                      <td>75%</td>
                      <td><span class="badge bg-warning text-dark">ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†</span></td>
                    </tr>
                    <tr>
                      <td><i class="fas fa-redo me-2"></i>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</td>
                      <td><strong>92%</strong></td>
                      <td>90%</td>
                      <td><span class="badge bg-success">Ù…Ù…ØªØ§Ø²</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="settings" class="tab-pane fade" role="tabpanel">
      <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SaaS</h5>
      
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙØ¹</h6>
            </div>
            <div class="card-body">
              <form>
                <div class="mb-3">
                  <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
                  <select class="form-select">
                    <option selected>Stripe</option>
                    <option>PayPal</option>
                    <option>Bank Transfer</option>
                    <option>Credit Card</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
                  <select class="form-select">
                    <option selected>USD - Dollar</option>
                    <option>ILS - Shekel</option>
                    <option>EUR - Euro</option>
                    <option>JOD - Dinar</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Stripe Secret Key</label>
                  <input type="password" class="form-control" placeholder="sk_test_...">
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-1"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙØ¹
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h6>
            </div>
            <div class="card-body">
              <form>
                <div class="mb-3">
                  <label class="form-label">Ù…Ø¯Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø© (Ø£ÙŠØ§Ù…)</label>
                  <input type="number" class="form-control" value="14">
                  <small class="text-muted">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" checked id="autoRenew">
                    <label class="form-check-label" for="autoRenew">
                      ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø£ÙŠØ§Ù…)</label>
                  <input type="number" class="form-control" value="7">
                  <small class="text-muted">Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">Grace Period (Ø£ÙŠØ§Ù…)</label>
                  <input type="number" class="form-control" value="3">
                  <small class="text-muted">Ù…Ù‡Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</small>
                </div>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-save me-1"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0"><i class="fas fa-envelope me-2"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h6>
            </div>
            <div class="card-body">
              <form>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…ÙØ±Ø³Ù„</label>
                    <input type="email" class="form-control" placeholder="billing@company.com">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙØ±Ø³Ù„</label>
                    <input type="text" class="form-control" placeholder="Company Billing">
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" checked id="sendWelcome">
                      <label class="form-check-label" for="sendWelcome">
                        Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ ØªØ±Ø­ÙŠØ¨ÙŠ Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
                      </label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" checked id="sendInvoice">
                      <label class="form-check-label" for="sendInvoice">
                        Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯
                      </label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" checked id="sendReminder">
                      <label class="form-check-label" for="sendReminder">
                        Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                      </label>
                    </div>
                  </div>
                  <div class="col-12">
                    <button type="submit" class="btn btn-warning text-dark">
                      <i class="fas fa-save me-1"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<div class="modal fade" id="newPlanModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <form id="newPlanForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø© *</label>
              <input type="text" class="form-control" name="name" placeholder="Ù…Ø«Ø§Ù„: Premium" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
              <input type="text" class="form-control" name="description" placeholder="Ù„Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ ($) *</label>
              <input type="number" step="0.01" class="form-control" name="price_monthly" placeholder="99.00" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ ($)</label>
              <input type="number" step="0.01" class="form-control" name="price_yearly" placeholder="990.00">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
              <select class="form-select" name="currency">
                <option selected>USD</option>
                <option>ILS</option>
                <option>EUR</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
              <input type="number" class="form-control" name="max_users" placeholder="10 (-1 = ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±/Ø´Ù‡Ø±</label>
              <input type="number" class="form-control" name="max_invoices" placeholder="100 (-1 = ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„ØªØ®Ø²ÙŠÙ† (GB)</label>
              <input type="number" class="form-control" name="storage_gb" placeholder="50 (-1 = ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)">
            </div>
            <div class="col-12">
              <label class="form-label">Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª (ÙƒÙ„ Ø³Ø·Ø± = Ù…Ù…ÙŠØ²Ø©)</label>
              <textarea class="form-control" name="features" rows="4" placeholder="Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªÙ‚Ø¯Ù…
API Access
ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø®ØµØµØ©"></textarea>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_popular" id="isPop">
                <label class="form-check-label" for="isPop">
                  <strong>Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ©</strong> (Ø³ØªØ¸Ù‡Ø± Ø¨ØªØµÙ…ÙŠÙ… Ù…Ù…ÙŠØ²)
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-primary" onclick="savePlan()">
          <i class="fas fa-save me-1"></i> Ø­ÙØ¸
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù‚Ø© -->
<div class="modal fade" id="editPlanModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù‚Ø©</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <form id="editPlanForm">
          <input type="hidden" id="edit_plan_id" name="plan_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø© *</label>
              <input type="text" class="form-control" id="edit_name" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
              <input type="text" class="form-control" id="edit_description" name="description">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ * ($)</label>
              <input type="number" step="0.01" class="form-control" id="edit_price_monthly" name="price_monthly" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ ($)</label>
              <input type="number" step="0.01" class="form-control" id="edit_price_yearly" name="price_yearly">
              <small class="text-muted">Ø¹Ø§Ø¯Ø© = Ø´Ù‡Ø±ÙŠ Ã— 10</small>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
              <select class="form-select" id="edit_currency" name="currency">
                <option value="USD">USD ($)</option>
                <option value="ILS">ILS (â‚ª)</option>
                <option value="JOD">JOD</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
              <input type="number" class="form-control" id="edit_max_users" name="max_users" placeholder="-1 Ù„Ù„ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„ÙÙˆØ§ØªÙŠØ±/Ø´Ù‡Ø±</label>
              <input type="number" class="form-control" id="edit_max_invoices" name="max_invoices" placeholder="-1 Ù„Ù„ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ø§Ù„ØªØ®Ø²ÙŠÙ† (GB)</label>
              <input type="number" class="form-control" id="edit_storage_gb" name="storage_gb" placeholder="-1 Ù„Ù„ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯">
            </div>
            <div class="col-12">
              <label class="form-label">Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</label>
              <textarea class="form-control" id="edit_features" name="features" rows="3" placeholder="ÙƒÙ„ Ù…ÙŠØ²Ø© ÙÙŠ Ø³Ø·Ø±"></textarea>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit_is_popular" name="is_popular">
                <label class="form-check-label" for="edit_is_popular">
                  <strong>Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ©</strong>
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-warning" onclick="saveEditedPlan()">
          <i class="fas fa-save me-1"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯ -->
<div class="modal fade" id="newSubscriberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <form id="newSubscriberForm">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
            <select class="form-select" name="customer_id" id="customer_select" required>
              <option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„...</option>
            </select>
            <small class="text-muted">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¨Ø§Ù‚Ø© *</label>
            <select class="form-select" name="plan_id" required>
              {% for plan in plans %}
              <option value="{{ plan.id }}">{{ plan.name }} - ${{ "%.0f"|format(plan.price_monthly) }}/Ø´Ù‡Ø±</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ *</label>
            <input type="date" class="form-control" name="start_date" value="{{ today }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select class="form-select" name="status">
              <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ù…Ø¬Ø§Ù†Ø§Ù‹)</option>
              <option value="active" selected>Ù†Ø´Ø· (Ù…Ø¯ÙÙˆØ¹)</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-success" onclick="saveSubscriber()">
          <i class="fas fa-save me-1"></i> Ø­ÙØ¸
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© -->
<div class="modal fade" id="createInvoiceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <form id="newInvoiceForm">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ *</label>
            <select class="form-select" name="subscription_id" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ø´ØªØ±Ø§Ùƒ...</option>
              {% for sub in subscriptions %}
              <option value="{{ sub.id }}">{{ sub.customer_id }} - {{ sub.plan.name if sub.plan else 'Ø¨Ø§Ù‚Ø© Ù…Ø­Ø°ÙˆÙØ©' }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº *</label>
            <input type="number" step="0.01" class="form-control" name="amount" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
            <select class="form-select" name="currency">
              <option value="USD">USD ($)</option>
              <option value="ILS">ILS (â‚ª)</option>
              <option value="JOD">JOD</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input type="date" class="form-control" name="due_date">
            <small class="text-muted">Ø¥Ø°Ø§ ØªØ±ÙƒØª ÙØ§Ø±ØºØ§Ù‹ØŒ Ø³ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ 7 Ø£ÙŠØ§Ù…</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-info" onclick="saveNewInvoice()">
          <i class="fas fa-save me-1"></i> Ø¥Ù†Ø´Ø§Ø¡
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function notify(message, type = 'info') {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  alert.innerHTML = `<strong>${message}</strong><button type="button" class="close" data-dismiss="alert"></button>`;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 5000);
}

window.savePlan = async function() {
  const form = document.getElementById('newPlanForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  
  data.is_popular = form.querySelector('[name="is_popular"]').checked;
  data.price_monthly = parseFloat(data.price_monthly);
  data.price_yearly = data.price_yearly ? parseFloat(data.price_yearly) : null;
  data.max_users = data.max_users ? parseInt(data.max_users) : null;
  data.max_invoices = data.max_invoices ? parseInt(data.max_invoices) : null;
  data.storage_gb = data.storage_gb ? parseInt(data.storage_gb) : null;
  
  notify('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'info');
  
  try {
    const res = await fetch('/security/api/saas/plans', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.success) {
      notify('âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      notify('âœ— ' + (result.error || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'), 'danger');
    }
  } catch (e) {
    notify('âœ— Ø®Ø·Ø£: ' + e.message, 'danger');
  }
}

window.saveSubscriber = async function() {
  const form = document.getElementById('newSubscriberForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  
  if (!data.customer_id || !data.plan_id || !data.start_date) {
    notify('âœ— ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
    return;
  }
  
  notify('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'info');
  
  try {
    const res = await fetch('/security/api/saas/subscriptions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.success) {
      notify('âœ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      notify('âœ— ' + (result.error || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'), 'danger');
    }
  } catch (e) {
    notify('âœ— Ø®Ø·Ø£: ' + e.message, 'danger');
  }
}

window.editPlan = function(planId) {
  const plan = plans.find(p => p.id === planId);
  if (!plan) {
    alert('Ø¨Ø§Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    return;
  }
  
  // Ù…Ù„Ø¡ Ø§Ù„ÙÙˆØ±Ù… Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  document.getElementById('edit_plan_id').value = plan.id;
  document.getElementById('edit_name').value = plan.name;
  document.getElementById('edit_description').value = plan.description || '';
  document.getElementById('edit_price_monthly').value = plan.price_monthly;
  document.getElementById('edit_price_yearly').value = plan.price_yearly || '';
  document.getElementById('edit_currency').value = plan.currency || 'USD';
  document.getElementById('edit_max_users').value = plan.max_users === -1 ? '-1' : (plan.max_users || '');
  document.getElementById('edit_max_invoices').value = plan.max_invoices === -1 ? '-1' : (plan.max_invoices || '');
  document.getElementById('edit_storage_gb').value = plan.storage_gb === -1 ? '-1' : (plan.storage_gb || '');
  document.getElementById('edit_features').value = plan.features || '';
  document.getElementById('edit_is_popular').checked = plan.is_popular;
  
  // ÙØªØ­ Ø§Ù„Ù€ Modal Ø¨Ø¯ÙˆÙ† backdrop
  const modalEl = document.getElementById('editPlanModal');
  $(modalEl).modal({backdrop: false});
  $(modalEl).modal('show');
}

window.saveEditedPlan = async function() {
  const planId = document.getElementById('edit_plan_id').value;
  const form = document.getElementById('editPlanForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  
  data.is_popular = form.querySelector('[name="is_popular"]').checked;
  data.price_monthly = parseFloat(data.price_monthly);
  data.price_yearly = data.price_yearly ? parseFloat(data.price_yearly) : null;
  data.max_users = data.max_users ? parseInt(data.max_users) : null;
  data.max_invoices = data.max_invoices ? parseInt(data.max_invoices) : null;
  data.storage_gb = data.storage_gb ? parseInt(data.storage_gb) : null;
  
  notify('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'info');
  
  try {
    const res = await fetch(`/security/api/saas/plans/${planId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.success) {
      notify('âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      notify('âœ— ' + (result.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'), 'danger');
    }
  } catch (e) {
    notify('âœ— Ø®Ø·Ø£: ' + e.message, 'danger');
  }
}

window.viewSubscription = async function(subId) {
  try {
    const res = await fetch(`/security/api/saas/subscriptions/${subId}`);
    const data = await res.json();
    
    if (data.success) {
      const sub = data.subscription;
      alert(`ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ\n\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${sub.customer_name}\nØ§Ù„Ø¨Ø§Ù‚Ø©: ${sub.plan_name}\nØ§Ù„Ø­Ø§Ù„Ø©: ${sub.status}\nØ§Ù„Ø³Ø¹Ø±: $${sub.price}/Ø´Ù‡Ø±\nØ§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${sub.start_date}\nØ§Ù„Ù†Ù‡Ø§ÙŠØ©: ${sub.end_date}\nØ§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${sub.days_left}`);
    } else {
      alert('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  } catch (e) {
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

window.editSubscription = async function(subId) {
  const newDate = prompt('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (YYYY-MM-DD):');
  if (!newDate) return;
  
  try {
    const res = await fetch(`/security/api/saas/subscriptions/${subId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ end_date: newDate })
    });
    
    const data = await res.json();
    if (data.success) {
      alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('Ø®Ø·Ø£: ' + (data.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'));
    }
  } catch (e) {
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

window.cancelSubscription = async function(subId) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ')) return;
  
  try {
    const res = await fetch(`/security/api/saas/subscriptions/${subId}/cancel`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ reason: 'Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ' })
    });
    
    const result = await res.json();
    
    if (result.success) {
      alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('Ø®Ø·Ø£: ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
    }
  } catch (e) {
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

window.renewSubscription = async function(subId) {
  if (!confirm('ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…ØŸ')) return;
  
  try {
    const res = await fetch(`/security/api/saas/subscriptions/${subId}/renew`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      }
    });
    
    const result = await res.json();
    
    if (result.success) {
      alert('ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯'));
    }
  } catch (e) {
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

window.downloadInvoice = async function(invId) {
  notify('â¬‡ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©...', 'info');
  
  try {
    window.open(`/security/api/saas/invoices/${invId}/pdf`, '_blank');
    notify('âœ“ ØªÙ… ÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§ Ø£Ùˆ Ø­ÙØ¸Ù‡Ø§', 'success');
  } catch (e) {
    notify('âœ— Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + e.message, 'danger');
  }
}

window.markPaid = async function(invId) {
  if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ØŸ')) return;
  
  try {
    const res = await fetch(`/security/api/saas/invoices/${invId}/mark-paid`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token() }}'
      }
    });
    
    const result = await res.json();
    
    if (result.success) {
      alert('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('Ø®Ø·Ø£: ÙØ´Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯');
    }
  } catch (e) {
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

window.sendReminder = async function(invId) {
  if (!confirm('Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
  
  try {
    const res = await fetch(`/security/api/saas/invoices/${invId}/send-reminder`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token() }}'
      }
    });
    
    const result = await res.json();
    
    if (result.success) {
      alert(result.message || 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
    } else {
      alert('Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'));
    }
  } catch (e) {
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

window.createInvoice = function() {
  const modal = document.getElementById('createInvoiceModal');
  if (!modal) {
    alert('Ø®Ø·Ø£: Modal ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    return;
  }
  
  $(modal).modal({backdrop: false});
  $(modal).modal('show');
}

window.saveNewInvoice = async function() {
  const form = document.getElementById('newInvoiceForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  
  if (!data.subscription_id || !data.amount) {
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
    return;
  }
  
  try {
    const res = await fetch('/security/api/saas/invoices', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.success) {
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'));
    }
  } catch (e) {
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

// ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ JavaScript
const plans = [
  {% for plan in plans %}
  {
    id: {{ plan.id }},
    name: {{ plan.name|tojson }},
    description: {{ (plan.description or '')|tojson }},
    price_monthly: {{ plan.price_monthly }},
    price_yearly: {{ plan.price_yearly or 'null' }},
    currency: {{ plan.currency|tojson }},
    max_users: {{ plan.max_users or 'null' }},
    max_invoices: {{ plan.max_invoices or 'null' }},
    storage_gb: {{ plan.storage_gb or 'null' }},
    features: {{ (plan.features or '')|tojson }},
    is_popular: {{ 'true' if plan.is_popular else 'false' }}
  }{{ ',' if not loop.last else '' }}
  {% endfor %}
];

// ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù†Ø¯ ÙØªØ­ Modal
async function loadCustomers() {
  try {
    const res = await fetch('/api/customers');
    const customers = await res.json();
    const select = document.getElementById('customer_select');
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„...</option>';
    customers.forEach(c => {
      const option = document.createElement('option');
      option.value = c.id;
      option.textContent = `${c.name} - ${c.email || c.phone || ''}`;
      select.appendChild(option);
    });
  } catch (e) {
    console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', e);
    notify('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹', 'warning');
  }
}

// Ø¹Ù†Ø¯ ÙØªØ­ modal Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
const newSubModal = document.getElementById('newSubscriberModal');
if (newSubModal) {
  newSubModal.addEventListener('show.bs.modal', loadCustomers);
}

// Ù…Ù„Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('input[type="date"][name="start_date"]').forEach(input => {
    if (!input.value) input.value = today;
  });
  
  // ØªÙØ¹ÙŠÙ„ tooltips
  $('[data-toggle="tooltip"]').tooltip();
  
  // Ø±Ø³Ù… Charts
  initCharts();
});

function initCharts() {
  // Chart 1: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
  const plansCtx = document.getElementById('plansChart');
  if (plansCtx && typeof Chart !== 'undefined') {
    new Chart(plansCtx, {
      type: 'doughnut',
      data: {
        labels: plans.map(p => p.name),
        datasets: [{
          data: plans.map(p => 1),
          backgroundColor: ['#667eea', '#f093fb', '#4facfe'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
  
  // Chart 2: Ù†Ù…Ùˆ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
  const growthCtx = document.getElementById('growthChart');
  if (growthCtx && typeof Chart !== 'undefined') {
    const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    const currentMonth = new Date().getMonth();
    const last12Months = [];
    for (let i = 11; i >= 0; i--) {
      const monthIndex = (currentMonth - i + 12) % 12;
      last12Months.push(months[monthIndex]);
    }
    
    new Chart(growthCtx, {
      type: 'line',
      data: {
        labels: last12Months,
        datasets: [{
          label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†',
          data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, {{ stats.total_subscribers }}],
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }
}
</script>

<!-- Modal: Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„ -->
<div class="modal fade" id="helpModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h4 class="modal-title">
          <i class="fas fa-book-open"></i> Ø¯Ù„ÙŠÙ„ SaaS Manager - ØµØ¯ÙŠÙ‚Ùƒ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
        </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        
        <!-- Ø§Ù„Ù‚Ø³Ù… 1: Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© -->
        <div class="alert alert-success">
          <h5><i class="fas fa-rocket"></i> Ù…Ø§ Ù‡Ùˆ SaaSØŸ</h5>
          <p class="mb-2"><strong>SaaS = Software as a Service</strong> (Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙƒØ®Ø¯Ù…Ø©)</p>
          <p class="mb-0">Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¨ÙŠØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ù€$5000ØŒ ØªØ¤Ø¬Ø±Ù‡ Ø´Ù‡Ø±ÙŠØ§Ù‹ Ø¨Ù€$79 = Ø¯Ø®Ù„ Ø«Ø§Ø¨Øª ÙˆÙ…Ø³ØªÙ…Ø±</p>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… 2: Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© -->
        <h5 class="mb-3"><i class="fas fa-cubes"></i> Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (3 Ø£Ø´ÙŠØ§Ø¡ ÙÙ‚Ø·):</h5>
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-primary">
              <div class="card-body">
                <h6 class="card-title text-primary">ğŸ“¦ 1. Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Plans)</h6>
                <p class="small mb-2">Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ù„ÙŠ ØªØ¹Ø±Ø¶Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                <div class="bg-light p-2 rounded small">
                  <strong>Ù…Ø«Ø§Ù„:</strong><br>
                  Ø¨Ø§Ù‚Ø© Pro = $79/Ø´Ù‡Ø±<br>
                  - 20 Ù…Ø³ØªØ®Ø¯Ù…<br>
                  - ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©<br>
                  - 100GB ØªØ®Ø²ÙŠÙ†
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-success">
              <div class="card-body">
                <h6 class="card-title text-success">ğŸ« 2. Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (Subscriptions)</h6>
                <p class="small mb-2">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¹Ù†Ø¯Ùƒ</p>
                <div class="bg-light p-2 rounded small">
                  <strong>Ù…Ø«Ø§Ù„:</strong><br>
                  Ø´Ø±ÙƒØ© ABC<br>
                  - Ø¨Ø§Ù‚Ø©: Pro<br>
                  - Ø¨Ø¯Ø£: 15-01-2025<br>
                  - ÙŠÙ†ØªÙ‡ÙŠ: 15-02-2025
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-body">
                <h6 class="card-title text-warning">ğŸ§¾ 3. Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Invoices)</h6>
                <p class="small mb-2">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù„ÙŠ ØªØ±Ø³Ù„Ù‡Ø§ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                <div class="bg-light p-2 rounded small">
                  <strong>Ù…Ø«Ø§Ù„:</strong><br>
                  ÙØ§ØªÙˆØ±Ø© #001<br>
                  - Ø§Ù„Ù…Ø¨Ù„Øº: $79<br>
                  - Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: 01-02-2025<br>
                  - Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø¹Ù„Ù‚Ø©
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… 3: Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© -->
        <h5 class="mb-3"><i class="fas fa-list-ol"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©):</h5>
        
        <div class="accordion" id="guideAccordion">
          <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-toggle="collapse" data-target="#step1">
                <strong>Ø§Ù„Ø®Ø·ÙˆØ© 1:</strong> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
              </button>
            </h2>
            <div id="step1" class="accordion-collapse collapse show" data-parent="#guideAccordion">
              <div class="accordion-body">
                <ol class="mb-3">
                  <li>Ø§Ø¶ØºØ· Ø²Ø± <span class="badge bg-primary">Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</span></li>
                  <li>Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
                    <ul>
                      <li><strong>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©:</strong> Ù…Ø«Ù„ "Basic" Ø£Ùˆ "Pro"</li>
                      <li><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ:</strong> Ù…Ø«Ù„ 29</li>
                      <li><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ:</strong> Ø¹Ø§Ø¯Ø© = Ø´Ù‡Ø±ÙŠ Ã— 10 (Ø´Ù‡Ø±ÙŠÙ† Ù…Ø¬Ø§Ù†Ø§Ù‹)</li>
                      <li><strong>Ø§Ù„Ø­Ø¯ÙˆØ¯:</strong> Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ Ø§Ù„ØªØ®Ø²ÙŠÙ†</li>
                    </ul>
                  </li>
                  <li>Ø§Ø¶ØºØ· <span class="badge bg-success">Ø­ÙØ¸</span></li>
                </ol>
                <div class="alert alert-info mb-0">
                  <strong>ğŸ’¡ Ù†ØµÙŠØ­Ø©:</strong> Ø¶Ø¹ -1 Ù„Ø£ÙŠ Ø­Ø¯ ØªØ±ÙŠØ¯Ù‡ "ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯"
                </div>
              </div>
            </div>
          </div>

          <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-toggle="collapse" data-target="#step2">
                <strong>Ø§Ù„Ø®Ø·ÙˆØ© 2:</strong> Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ
              </button>
            </h2>
            <div id="step2" class="accordion-collapse collapse" data-parent="#guideAccordion">
              <div class="accordion-body">
                <ol class="mb-3">
                  <li>Ø§Ø°Ù‡Ø¨ Ù„ØªØ¨ÙˆÙŠØ¨ <span class="badge bg-primary">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</span></li>
                  <li>Ø§Ø¶ØºØ· <span class="badge bg-success">Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</span></li>
                  <li>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</li>
                  <li>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©</li>
                  <li>Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</li>
                  <li>Ø§Ø¶ØºØ· <span class="badge bg-success">Ø­ÙØ¸</span></li>
                </ol>
                <div class="alert alert-warning mb-0">
                  <strong>âš ï¸ Ù…Ù‡Ù…:</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
                </div>
              </div>
            </div>
          </div>

          <!-- Ø§Ù„Ø®Ø·ÙˆØ© 3 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-toggle="collapse" data-target="#step3">
                <strong>Ø§Ù„Ø®Ø·ÙˆØ© 3:</strong> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
              </button>
            </h2>
            <div id="step3" class="accordion-collapse collapse" data-parent="#guideAccordion">
              <div class="accordion-body">
                <h6>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹:</h6>
                <ol class="mb-3">
                  <li>ØªØ¨ÙˆÙŠØ¨ <span class="badge bg-primary">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span></li>
                  <li>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</li>
                  <li>Ø§Ø¶ØºØ· Ø²Ø± <span class="badge bg-success">âœ“</span></li>
                  <li>âœ… Ø§Ù„Ø­Ø§Ù„Ø© ØªØªØ­ÙˆÙ„ Ù„Ù€ "Ù…Ø¯ÙÙˆØ¹Ø©"</li>
                </ol>
                
                <h6>Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±:</h6>
                <ol class="mb-3">
                  <li>Ø§Ø¶ØºØ· Ø²Ø± <span class="badge bg-info">âœ‰</span></li>
                  <li>ØªØ£ÙƒÙŠØ¯</li>
                  <li>âœ… ÙŠØ±Ø³Ù„ ØªØ°ÙƒÙŠØ± Ù„Ù„Ø¹Ù…ÙŠÙ„</li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Ø§Ù„Ø®Ø·ÙˆØ© 4 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-toggle="collapse" data-target="#step4">
                <strong>Ø§Ù„Ø®Ø·ÙˆØ© 4:</strong> Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
              </button>
            </h2>
            <div id="step4" class="accordion-collapse collapse" data-parent="#guideAccordion">
              <div class="accordion-body">
                <h6>ØªØ¬Ø¯ÙŠØ¯ Ø§Ø´ØªØ±Ø§Ùƒ:</h6>
                <p class="small">ÙŠØ¶ÙŠÙ 30 ÙŠÙˆÙ… Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                
                <h6>Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ:</h6>
                <p class="small">ÙŠÙˆÙ‚Ù Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                
                <h6>ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù‚Ø©:</h6>
                <p class="small">ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… 4: Ø±Ù…ÙˆØ² Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
        <h5 class="mt-4 mb-3"><i class="fas fa-palette"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</h5>
        <div class="row">
          <div class="col-md-3">
            <div class="p-2 bg-success text-white rounded mb-2">
              <strong>ğŸŸ¢ Ø£Ø®Ø¶Ø±</strong><br>
              <small>Ù†Ø´Ø·ØŒ Ù…Ø¯ÙÙˆØ¹ØŒ ØªÙ…Ø§Ù…</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="p-2 bg-danger text-white rounded mb-2">
              <strong>ğŸ”´ Ø£Ø­Ù…Ø±</strong><br>
              <small>Ù…Ù†ØªÙ‡ÙŠØŒ Ù…ØªØ£Ø®Ø±ØŒ Ø¥Ù„ØºØ§Ø¡</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="p-2 bg-warning text-dark rounded mb-2">
              <strong>ğŸŸ¡ Ø£ØµÙØ±</strong><br>
              <small>ØªØ¬Ø±ÙŠØ¨ÙŠØŒ Ù…Ø¹Ù„Ù‚ØŒ ØªØ­Ø°ÙŠØ±</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="p-2 bg-secondary text-white rounded mb-2">
              <strong>âš« Ø±Ù…Ø§Ø¯ÙŠ</strong><br>
              <small>Ù…Ù„ØºÙŠØŒ Ù…Ø¹Ø·Ù„</small>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… 5: Ù†ØµØ§Ø¦Ø­ Ø§Ø­ØªØ±Ø§ÙÙŠØ© -->
        <div class="alert alert-success mt-4">
          <h5><i class="fas fa-lightbulb"></i> Ù†ØµØ§Ø¦Ø­ Ø§Ø­ØªØ±Ø§ÙÙŠØ©:</h5>
          <ul class="mb-0">
            <li><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ:</strong> Ø¹Ø§Ø¯Ø© = Ø´Ù‡Ø±ÙŠ Ã— 10 (Ø®ØµÙ… Ø´Ù‡Ø±ÙŠÙ†)</li>
            <li><strong>Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©:</strong> Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© (Ø£Ø¹Ù„Ù‰ Ù…Ø¨ÙŠØ¹Ø§Øª)</li>
            <li><strong>Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:</strong> 7-14 ÙŠÙˆÙ… Ù…Ø«Ø§Ù„ÙŠ</li>
            <li><strong>Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª:</strong> Ø£Ø±Ø³Ù„ Ù‚Ø¨Ù„ 3 Ø£ÙŠØ§Ù… Ù…Ù† Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</li>
          </ul>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… 6: Ø§Ù„Ø£Ù…Ø§Ù† -->
        <div class="alert alert-info">
          <h5><i class="fas fa-shield-alt"></i> Ø§Ù„Ø£Ù…Ø§Ù†:</h5>
          <p class="mb-2"><strong>Ù…Ø§Ø°Ø§ Ù†Ø·Ø¨Ù‚ Ù„Ø­Ù…Ø§ÙŠØªÙƒ:</strong></p>
          <ul class="mb-0 small">
            <li>âœ… CSRF Protection - Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªØ²ÙˆÙŠØ±</li>
            <li>âœ… Owner Only - ÙÙ‚Ø· Ø£Ù†Øª ØªÙ‚Ø¯Ø± ØªØ¯Ø®Ù„</li>
            <li>âœ… Input Validation - ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</li>
            <li>âœ… SQL Injection Prevention - Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚</li>
            <li>âœ… Audit Trail - ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</li>
          </ul>
        </div>

      </div>
      <div class="modal-footer">
        <a href="/static/SAAS_COMPLETE_GUIDE.md" class="btn btn-primary" download>
          <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
        </a>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

