{% extends 'base.html' %}
{% block title %}ğŸ‘‘ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†{% endblock %}
{% block page_title %}ğŸ‘‘ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Owner's Control Panel{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  {% if session.get('impersonating') %}
  <div class="alert alert-warning border-0 shadow-sm animate__animated animate__pulse">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>ğŸ•µï¸ ØªØ­Ø°ÙŠØ±:</strong> Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØªØµÙØ­ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±!
        <br><small>Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠ: <strong>{{ session.get('original_username', 'Owner') }}</strong></small>
      </div>
      <form method="POST" action="{{ url_for('security.stop_impersonate') }}" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-sm btn-danger">
          <i class="fas fa-undo"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ
        </button>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="alert alert-danger border-0 shadow-sm">
    <i class="fas fa-crown"></i> <strong>ØµÙ„Ø§Ø­ÙŠØ§Øª Ø®Ø§Ø±Ù‚Ø©:</strong> Ø³ÙŠØ·Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!
    <div class="mt-2 small">
      <span class="badge bg-light text-dark">Ø§Ù„Ø§Ù†ØªØ­Ø§Ù„</span>
      <span class="badge bg-light text-dark">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</span>
      <span class="badge bg-light text-dark">Ø§Ù„Ø­Ø°Ù</span>
      <span class="badge bg-light text-dark">Ø¹Ù…Ù„ÙŠØ§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©</span>
      <span class="badge bg-light text-dark">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</span>
    </div>
  </div>

  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
  <div class="row g-3 mb-4">
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="small-box bg-primary">
        <div class="inner">
          <h3>{{ stats.total_users }}</h3>
          <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
        </div>
        <div class="icon"><i class="fas fa-users"></i></div>
      </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ stats.active_users }}</h3>
          <p>Ù†Ø´Ø·ÙŠÙ†</p>
        </div>
        <div class="icon"><i class="fas fa-user-check"></i></div>
      </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="small-box bg-danger">
        <div class="inner">
          <h3>{{ stats.inactive_users }}</h3>
          <p>Ù…Ø¹Ø·Ù„ÙŠÙ†</p>
        </div>
        <div class="icon"><i class="fas fa-user-times"></i></div>
      </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ stats.online_users }}</h3>
          <p>Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
        </div>
        <div class="icon"><i class="fas fa-circle text-success"></i></div>
      </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ stats.system_accounts }}</h3>
          <p>Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</p>
        </div>
        <div class="icon"><i class="fas fa-cog"></i></div>
      </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="small-box bg-secondary">
        <div class="inner">
          <h3>{{ stats.total_operations|default(0) }}</h3>
          <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
        </div>
        <div class="icon"><i class="fas fa-tasks"></i></div>
      </div>
    </div>
  </div>

  <!-- Filters & Search -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select name="filter" class="form-select" onchange="this.form.submit()">
            <option value="all" {{ current_filter == 'all' and 'selected' or '' }}>Ø§Ù„ÙƒÙ„</option>
            <option value="active" {{ current_filter == 'active' and 'selected' or '' }}>Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø·</option>
            <option value="inactive" {{ current_filter == 'inactive' and 'selected' or '' }}>Ù…Ø¹Ø·Ù„ÙŠÙ† ÙÙ‚Ø·</option>
            <option value="online" {{ current_filter == 'online' and 'selected' or '' }}>Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</option>
            <option value="system" {{ current_filter == 'system' and 'selected' or '' }}>Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</option>
          </select>
        </div>
        
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
          <select name="role" class="form-select" onchange="this.form.submit()">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>
            {% for role in all_roles %}
            <option value="{{ role.name }}" {{ current_role == role.name and 'selected' or '' }}>
              {{ role.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label">Ø¨Ø­Ø«</label>
          <input type="text" name="search" class="form-control" 
                 placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." 
                 value="{{ search_query }}">
        </div>
        
        <div class="col-md-2">
          <label class="form-label">&nbsp;</label>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i> Ø¨Ø­Ø«
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù‘Ù† -->
  <div class="card shadow-lg">
    <div class="card-header bg-gradient-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users-cog"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - {{ stats.total_users }} Ù…Ø³ØªØ®Ø¯Ù…</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-primary" onclick="showCreateUser()">
            <i class="fas fa-user-plus"></i> Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
          </button>
          <button class="btn btn-sm btn-light" onclick="exportUsers()">
            <i class="fas fa-download"></i> Export
          </button>
          <button class="btn btn-sm btn-success" onclick="bulkActivate()">
            <i class="fas fa-check-circle"></i> ØªÙØ¹ÙŠÙ„
          </button>
          <button class="btn btn-sm btn-warning" onclick="bulkDeactivate()">
            <i class="fas fa-ban"></i> ØªØ¹Ø·ÙŠÙ„
          </button>
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0" id="usersTable">
          <thead class="table-dark">
            <tr>
              <th style="width: 30px;">
                <input type="checkbox" id="selectAll" onchange="toggleAll(this)">
              </th>
              <th style="width: 50px;">ID</th>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ù…ØªØµÙ„</th>
              <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
              <th>Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
              <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</th>
              <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
              <th style="width: 250px;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø®Ø§Ø±Ù‚Ø©</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr class="{{ user.is_system_account and 'table-warning' or '' }} {{ user.is_online and 'table-success' or '' }}">
              <td>
                <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
              </td>
              <td>
                <strong>{{ user.id }}</strong>
                {% if user.is_system_account %}
                <span class="badge bg-warning text-dark" title="Ø­Ø³Ø§Ø¨ Ù†Ø¸Ø§Ù… Ù…Ø­Ù…ÙŠ">
                  <i class="fas fa-lock"></i>
                </span>
                {% endif %}
              </td>
              <td>
                <div>
                  <strong>{{ user.username }}</strong>
                  {% if user.username == '__OWNER__' %}
                  <span class="badge bg-danger ms-1">Ø§Ù„Ù…Ø§Ù„Ùƒ</span>
                  {% endif %}
                </div>
                <small class="text-muted">
                  Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„: {{ user.login_count|default(0) }}
                </small>
              </td>
              <td>
                <small>{{ user.email or 'N/A' }}</small>
                {% if user.last_login_ip %}
                <br><small class="text-muted">IP: {{ user.last_login_ip }}</small>
                {% endif %}
              </td>
              <td>
                {% if user.role %}
                <span class="badge bg-info">{{ user.role.name }}</span>
                {% else %}
                <span class="badge bg-secondary">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
                {% endif %}
              </td>
              <td>
                {% if user.is_active %}
                <span class="badge bg-success">
                  <i class="fas fa-check-circle"></i> Ù†Ø´Ø·
                </span>
                {% else %}
                <span class="badge bg-danger">
                  <i class="fas fa-times-circle"></i> Ù…Ø¹Ø·Ù„
                </span>
                {% endif %}
              </td>
              <td>
                {% if user.is_online %}
                <span class="badge bg-success">
                  <i class="fas fa-circle"></i> Online
                </span>
                {% else %}
                <span class="badge bg-secondary">
                  <i class="far fa-circle"></i> Offline
                </span>
                {% endif %}
              </td>
              <td>
                <div>
                  <strong>{{ user.sales_count|default(0) }}</strong>
                </div>
                <small class="text-success">
                  {{ "{:,.2f}".format(user.sales_total|default(0)) }} â‚ª
                </small>
              </td>
              <td>
                <strong>{{ user.services_count|default(0) }}</strong>
              </td>
              <td>
                <strong>{{ user.payments_count|default(0) }}</strong>
              </td>
              <td>
                {% if user.last_activity_time %}
                <small title="{{ user.last_activity_time }}">
                  {{ user.last_activity_time.strftime('%Y-%m-%d %H:%M') }}
                </small>
                <br><small class="text-muted">{{ user.last_activity_desc[:30] }}</small>
                {% else %}
                <small class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</small>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
                  <button class="btn btn-primary" onclick="viewUserDetails({{ user.id }})" title="Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©">
                    <i class="fas fa-eye"></i>
                  </button>
                  
                  <!-- Ø§Ù†ØªØ­Ø§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© -->
                  {% if user.id != current_user.id %}
                  <form method="POST" action="{{ url_for('security.impersonate_user', user_id=user.id) }}" 
                        style="display:inline;" 
                        onsubmit="return confirm('ğŸ•µï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ€ {{ user.username }}ØŸ\n\nØ³ØªØªÙ…ÙƒÙ† Ù…Ù† Ø±Ø¤ÙŠØ© ÙƒÙ„ Ø´ÙŠØ¡ ÙƒÙ…Ø§ ÙŠØ±Ø§Ù‡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning" title="Ø§Ù†ØªØ­Ø§Ù„ Ø´Ø®ØµÙŠØ© {{ user.username }}">
                      <i class="fas fa-user-secret"></i>
                    </button>
                  </form>
                  {% endif %}
                  
                  <!-- Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
                  <button class="btn btn-info" onclick="resetPassword({{ user.id }}, '{{ user.username }}')" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <i class="fas fa-key"></i>
                  </button>
                  
                  <!-- ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ -->
                  {% if user.id != current_user.id %}
                  <form method="POST" action="{{ url_for('security.toggle_user_status', user_id=user.id) }}" 
                        style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-{{ user.is_active and 'danger' or 'success' }}" 
                            title="{{ user.is_active and 'ØªØ¹Ø·ÙŠÙ„' or 'ØªÙØ¹ÙŠÙ„' }}">
                      <i class="fas fa-power-off"></i>
                    </button>
                  </form>
                  {% endif %}
                  
                  <!-- Ø­Ø°Ù -->
                  {% if user.id != current_user.id and not user.is_system_account %}
                  <button class="btn btn-dark" onclick="deleteUser({{ user.id }}, '{{ user.username }}')" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-user"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="userDetailsContent">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" id="resetPasswordForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-warning">
          <h5 class="modal-title"><i class="fas fa-key"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          </div>
          <p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong id="resetUsername"></strong></p>
          <div class="mb-3">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
            <div class="input-group">
              <input type="text" name="new_password" id="newPassword" class="form-control" value="" required>
              <button type="button" class="btn btn-outline-secondary" onclick="generatePassword()">
                <i class="fas fa-random"></i> ØªÙˆÙ„ÙŠØ¯
              </button>
            </div>
            <small class="text-muted">Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø®ØµØµØ©</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-warning">
            <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" id="deleteUserForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> <strong>ØªØ­Ø°ÙŠØ±:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø®Ø·ÙŠØ± ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!
          </div>
          <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong id="deleteUsername"></strong>ØŸ</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
            <label class="form-check-label" for="confirmDelete">
              Ù†Ø¹Ù…ØŒ Ø£Ù†Ø§ Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
<div class="modal fade" id="createUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('security.create_user') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="text-danger">*</span></label>
            <input type="text" name="username" class="form-control" required 
                   pattern="[a-zA-Z0-9_]{3,50}" 
                   title="3-50 Ø­Ø±Ù (Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… Ùˆ _ ÙÙ‚Ø·)">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ <span class="text-danger">*</span></label>
            <input type="email" name="email" class="form-control" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="input-group">
              <input type="text" name="password" id="createPassword" class="form-control" 
                     value="" placeholder="Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù€ 123456">
              <button type="button" class="btn btn-outline-secondary" onclick="generateCreatePassword()">
                <i class="fas fa-random"></i> ØªÙˆÙ„ÙŠØ¯
              </button>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
            <select name="role_id" class="form-select">
              <option value="">Ø¨Ø¯ÙˆÙ† Ø¯ÙˆØ±</option>
              {% for role in all_roles %}
              <option value="{{ role.id }}">{{ role.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_active" value="1" id="createActive" checked>
            <label class="form-check-label" for="createActive">
              ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙˆØ±Ø§Ù‹
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// ØªÙØ¹ÙŠÙ„ DataTable
$(document).ready(function() {
  $('#usersTable').DataTable({
    order: [[1, 'asc']],
    pageLength: 25,
    language: {
      url: '/static/datatables/Arabic.json'
    },
    dom: 'Bfrtip',
    buttons: [
      'copy', 'csv', 'excel', 'pdf', 'print'
    ]
  });
});

// Toggle All Checkboxes
function toggleAll(source) {
  const checkboxes = document.querySelectorAll('.user-checkbox');
  checkboxes.forEach(cb => cb.checked = source.checked);
}

// Export Users
function exportUsers() {
  const table = $('#usersTable').DataTable();
  table.button('.buttons-csv').trigger();
}

// Bulk Activate
function bulkActivate() {
  const selected = getSelectedUsers();
  if (selected.length === 0) {
    alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }
  if (confirm(`âœ… ØªÙØ¹ÙŠÙ„ ${selected.length} Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) {
    bulkOperation('activate', selected);
  }
}

// Bulk Deactivate
function bulkDeactivate() {
  const selected = getSelectedUsers();
  if (selected.length === 0) {
    alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }
  if (confirm(`âŒ ØªØ¹Ø·ÙŠÙ„ ${selected.length} Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) {
    bulkOperation('deactivate', selected);
  }
}

// Get Selected Users
function getSelectedUsers() {
  const checkboxes = document.querySelectorAll('.user-checkbox:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

// Bulk Operation
function bulkOperation(operation, userIds) {
  fetch('/security/api/users/bulk-operation', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify({
      operation: operation,
      user_ids: userIds
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`âœ… ${data.message}`);
      location.reload();
    } else {
      alert(`âŒ ${data.error}`);
    }
  })
  .catch(err => alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err));
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function viewUserDetails(userId) {
  const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
  modal.show();
  
  fetch(`/security/api/users/${userId}/details`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('userDetailsContent').innerHTML = renderUserDetails(data.user);
      } else {
        document.getElementById('userDetailsContent').innerHTML = `
          <div class="alert alert-danger">âŒ ${data.error}</div>
        `;
      }
    })
    .catch(err => {
      document.getElementById('userDetailsContent').innerHTML = `
        <div class="alert alert-danger">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${err}</div>
      `;
    });
}

// Render User Details
function renderUserDetails(user) {
  return `
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
          </div>
          <div class="card-body">
            <table class="table table-sm">
              <tr><th>ID:</th><td>${user.id}</td></tr>
              <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</th><td><strong>${user.username}</strong></td></tr>
              <tr><th>Ø§Ù„Ø¨Ø±ÙŠØ¯:</th><td>${user.email || 'N/A'}</td></tr>
              <tr><th>Ø§Ù„Ø¯ÙˆØ±:</th><td><span class="badge bg-info">${user.role || 'N/A'}</span></td></tr>
              <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©:</th><td>${user.is_active ? '<span class="badge bg-success">Ù†Ø´Ø·</span>' : '<span class="badge bg-danger">Ù…Ø¹Ø·Ù„</span>'}</td></tr>
              <tr><th>Ø­Ø³Ø§Ø¨ Ù†Ø¸Ø§Ù…:</th><td>${user.is_system_account ? '<span class="badge bg-warning">Ù†Ø¹Ù…</span>' : 'Ù„Ø§'}</td></tr>
            </table>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-success text-white">
            <i class="fas fa-chart-line"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
          </div>
          <div class="card-body">
            <table class="table table-sm">
              <tr><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</th><td><strong>${user.sales_count}</strong></td></tr>
              <tr><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</th><td><strong class="text-success">${parseFloat(user.sales_total).toLocaleString('en-US', {minimumFractionDigits: 2})} â‚ª</strong></td></tr>
              <tr><th>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©:</th><td>${user.services_count}</td></tr>
              <tr><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙÙ†Ø´Ø£Ø©:</th><td>${user.payments_count}</td></tr>
              <tr><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</th><td><strong>${user.sales_count + user.services_count + user.payments_count}</strong></td></tr>
            </table>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-info text-white">
            <i class="fas fa-clock"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          </div>
          <div class="card-body">
            <table class="table table-sm">
              <tr><th>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„:</th><td>${user.last_login || 'N/A'}</td></tr>
              <tr><th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·:</th><td>${user.last_seen || 'N/A'}</td></tr>
              <tr><th>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:</th><td>${user.login_count}</td></tr>
              <tr><th>Ø¢Ø®Ø± IP:</th><td><code>${user.last_login_ip || 'N/A'}</code></td></tr>
            </table>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-warning text-dark">
            <i class="fas fa-history"></i> Ø¢Ø®Ø± Ø§Ù„Ø£Ù†Ø´Ø·Ø© (10)
          </div>
          <div class="card-body">
            <div id="recentActivities" style="max-height: 200px; overflow-y: auto;">
              <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                <span class="ms-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function resetPassword(userId, username) {
  document.getElementById('resetUsername').textContent = username;
  document.getElementById('resetPasswordForm').action = `/security/force-reset-password/${userId}`;
  document.getElementById('newPassword').value = generateRandomPassword();
  new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

// ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
function generatePassword() {
  document.getElementById('newPassword').value = generateRandomPassword();
}

function generateRandomPassword() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$%';
  let password = '';
  for (let i = 0; i < 12; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return password;
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…
function showCreateUser() {
  document.getElementById('createPassword').value = generateRandomPassword();
  new bootstrap.Modal(document.getElementById('createUserModal')).show();
}

// ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…
function generateCreatePassword() {
  document.getElementById('createPassword').value = generateRandomPassword();
}

// Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…
function deleteUser(userId, username) {
  document.getElementById('deleteUsername').textContent = username;
  document.getElementById('deleteUserForm').action = `/security/delete-user/${userId}`;
  document.getElementById('confirmDelete').checked = false;
  new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
}
</script>

<style>
.table-success {
  background-color: rgba(25, 135, 84, 0.1) !important;
}
.table-warning {
  background-color: rgba(255, 193, 7, 0.1) !important;
}
</style>

{% endblock %}
