{% extends 'base.html' %}
{% block title %}تنظيف النظام{% endblock %}
{% block page_title %}🧹 تنظيف النظام (Format){% endblock %}

{% block extra_css %}
<style>
  .cleanup-section {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    background: #f8f9fa;
  }
  .cleanup-section-header {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
  }
  .table-checkbox {
    padding: 12px;
    border-radius: 8px;
    transition: all 0.3s;
    border: 1px solid transparent;
  }
  .table-checkbox:hover {
    background: #fff;
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
  }
  .table-checkbox input:checked ~ label {
    font-weight: bold;
    color: #dc3545;
  }
  .stats-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 20px;
  }
  .stats-box h3 {
    font-size: 2.5rem;
    margin: 0;
  }
  .stats-box p {
    margin: 5px 0 0 0;
    opacity: 0.9;
  }
  .confirm-box {
    background: #fff3cd;
    border: 3px solid #ffc107;
    padding: 25px;
    border-radius: 10px;
    margin: 20px 0;
  }
  .danger-zone {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .action-buttons {
    position: sticky;
    bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    z-index: 100;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <!-- تحذير خطير -->
  <div class="danger-zone">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle fa-3x me-3"></i>
      <div>
        <h4 class="mb-1">⚠️ تحذير خطير جداً!</h4>
        <p class="mb-0">هذه العملية ستحذف البيانات بشكل نهائي ولا يمكن التراجع عنها! تأكد من عمل نسخة احتياطية أولاً.</p>
      </div>
    </div>
  </div>

  <!-- إحصائيات -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h3 id="selected-count">0</h3>
        <p>جدول محدد</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h3>{{ tables|length }}</h3>
        <p>إجمالي الجداول</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
        <h3 id="high-danger-count">0</h3>
        <p>خطر عالي</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
        <h3>⚠️</h3>
        <p>تحذير نشط</p>
      </div>
    </div>
  </div>

  <div class="card shadow">
    <div class="card-header bg-gradient-danger text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-broom me-2"></i>
          تنظيف جداول النظام
        </h5>
        <div>
          <button type="button" class="btn btn-light btn-sm" onclick="selectAll()">
            <i class="fas fa-check-double"></i> اختيار الكل
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" onclick="deselectAll()">
            <i class="fas fa-times"></i> إلغاء الكل
          </button>
          <button type="button" class="btn btn-warning btn-sm" onclick="selectHighDanger()">
            <i class="fas fa-exclamation-triangle"></i> الخطرة فقط
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <form method="POST" id="cleanup-form" onsubmit="return confirmCleanup();">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        {% set tables_by_group = {} %}
        {% for table in tables %}
          {% set group = table.get('group', 'أخرى') %}
          {% if group not in tables_by_group %}
            {% set _ = tables_by_group.update({group: []}) %}
          {% endif %}
          {% set _ = tables_by_group[group].append(table) %}
        {% endfor %}

        <!-- عرض ديناميكي لجميع الجداول -->
        {% set current_group = None %}
        {% set group_index = 0 %}
        
        {% for table in tables %}
          {% set table_group = '' %}
          
          {# تحديد المجموعة بناءً على الترتيب #}
          {% if loop.index0 < 3 %}
            {% set table_group = 'users' %}
            {% set group_title = '👤 المستخدمين والأدوار' %}
            {% set group_icon = 'fas fa-users text-primary' %}
          {% elif loop.index0 < 11 %}
            {% set table_group = 'logs' %}
            {% set group_title = '📋 السجلات والملاحظات والإشعارات' %}
            {% set group_icon = 'fas fa-clipboard-list text-info' %}
          {% elif loop.index0 < 17 %}
            {% set table_group = 'financial' %}
            {% set group_title = '💰 العمليات المالية' %}
            {% set group_icon = 'fas fa-money-bill-wave text-success' %}
          {% elif loop.index0 < 22 %}
            {% set table_group = 'sales' %}
            {% set group_title = '🛍️ المبيعات والصيانة' %}
            {% set group_icon = 'fas fa-shopping-cart text-warning' %}
          {% elif loop.index0 < 25 %}
            {% set table_group = 'stock' %}
            {% set group_title = '📊 المخزون والتبادلات' %}
            {% set group_icon = 'fas fa-boxes text-primary' %}
          {% elif loop.index0 < 27 %}
            {% set table_group = 'preorders' %}
            {% set group_title = '📅 الحجوزات' %}
            {% set group_icon = 'fas fa-calendar-check text-info' %}
          {% elif loop.index0 < 30 %}
            {% set table_group = 'shipments' %}
            {% set group_title = '🚚 الشحنات والتسويات' %}
            {% set group_icon = 'fas fa-truck text-secondary' %}
          {% elif loop.index0 < 33 %}
            {% set table_group = 'entities' %}
            {% set group_title = '👥 الجهات (خطر عالي جداً!)' %}
            {% set group_icon = 'fas fa-user-friends text-danger' %}
          {% elif loop.index0 < 36 %}
            {% set table_group = 'warehouses' %}
            {% set group_title = '🏪 المخازن والمنتجات' %}
            {% set group_icon = 'fas fa-warehouse text-danger' %}
          {% elif loop.index0 < 38 %}
            {% set table_group = 'loans' %}
            {% set group_title = '💳 القروض' %}
            {% set group_icon = 'fas fa-handshake text-warning' %}
          {% elif loop.index0 < 40 %}
            {% set table_group = 'invoices' %}
            {% set group_title = '📄 الفواتير' %}
            {% set group_icon = 'fas fa-file-invoice text-primary' %}
          {% elif loop.index0 < 42 %}
            {% set table_group = 'relations' %}
            {% set group_title = '🔗 العلاقات والارتباطات' %}
            {% set group_icon = 'fas fa-link text-secondary' %}
          {% elif loop.index0 < 45 %}
            {% set table_group = 'settings' %}
            {% set group_title = '⚙️ الإعدادات والمرافق' %}
            {% set group_icon = 'fas fa-cog text-info' %}
          {% elif loop.index0 < 47 %}
            {% set table_group = 'accounting' %}
            {% set group_title = '📚 العمليات المحاسبية' %}
            {% set group_icon = 'fas fa-book text-success' %}
          {% else %}
            {% set table_group = 'other' %}
            {% set group_title = '📁 أخرى' %}
            {% set group_icon = 'fas fa-folder text-muted' %}
          {% endif %}
          
          {# فتح مجموعة جديدة #}
          {% if table_group != current_group %}
            {% if current_group %}
              </div> {# إغلاق المجموعة السابقة #}
            {% endif %}
            
            {% set current_group = table_group %}
            {% set is_danger_zone = table_group in ['entities', 'warehouses'] %}
            
            <div class="cleanup-section {% if is_danger_zone %}border-danger{% endif %}" 
                 {% if is_danger_zone %}style="border-color: #dc3545; background: #fff5f5;"{% endif %}>
              <div class="cleanup-section-header {% if is_danger_zone %}text-danger{% endif %}">
                <i class="{{ group_icon }}"></i> {{ group_title }}
              </div>
              {% if is_danger_zone %}
              <div class="alert alert-danger mb-3">
                <i class="fas fa-skull-crossbones me-2"></i>
                <strong>انتبه!</strong> هذه منطقة خطرة جداً - التنظيف هنا سيؤثر على النظام بالكامل!
              </div>
              {% endif %}
          {% endif %}
          
          {# عرض checkbox الجدول #}
          <div class="form-check table-checkbox">
            <input class="form-check-input table-item" type="checkbox" name="tables" 
                   value="{{ table.name }}" id="table_{{ loop.index }}" 
                   data-danger="{{ table.danger }}">
            <label class="form-check-label w-100" for="table_{{ loop.index }}">
              <span class="me-2">{{ table.display }}</span>
              {% if table.danger == 'high' %}
                <span class="badge bg-danger">خطر عالي 🔴</span>
              {% elif table.danger == 'medium' %}
                <span class="badge bg-warning text-dark">خطر متوسط 🟡</span>
              {% else %}
                <span class="badge bg-success">خطر منخفض 🟢</span>
              {% endif %}
            </label>
          </div>
          
          {# إغلاق آخر مجموعة #}
          {% if loop.last %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- صندوق التأكيد -->
        <div class="confirm-box">
          <h5 class="text-warning mb-3">
            <i class="fas fa-shield-alt me-2"></i>
            تأكيد العملية
          </h5>
          
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-keyboard me-1"></i>
              اكتب <code class="text-danger fs-5">FORMAT_SYSTEM</code> للتأكيد *
            </label>
            <input type="text" name="confirm" id="confirm-input" class="form-control form-control-lg" 
                   placeholder="FORMAT_SYSTEM" required autocomplete="off">
            <small class="text-muted">يجب كتابة النص بالضبط كما هو موضح</small>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="double-confirm" required>
            <label class="form-check-label fw-bold" for="double-confirm">
              <i class="fas fa-check-circle me-1"></i>
              أؤكد أنني قمت بعمل نسخة احتياطية وأتحمل المسؤولية الكاملة
            </label>
          </div>

          <div id="preview-box" class="alert alert-info" style="display: none;">
            <h6><i class="fas fa-eye me-2"></i>معاينة العملية:</h6>
            <div id="preview-content"></div>
          </div>
        </div>

        <!-- أزرار الإجراءات -->
        <div class="action-buttons">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <button type="submit" class="btn btn-danger btn-lg" id="submit-btn" disabled>
                <i class="fas fa-trash-alt me-2"></i>
                تنظيف الجداول المحددة
              </button>
              <a href="{{ url_for('security.index') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-right me-2"></i>
                إلغاء والعودة
              </a>
            </div>
            <div class="text-end">
              <small class="text-muted d-block">آخر تحديث: {{ now().strftime('%Y-%m-%d %H:%M') }}</small>
              <small class="text-danger d-block">⚠️ عملية لا رجعة فيها</small>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>

</div>

<script>
// تحديث العدادات
function updateCounters() {
  const checked = document.querySelectorAll('.table-item:checked');
  const highDanger = Array.from(checked).filter(cb => cb.dataset.danger === 'high');
  
  document.getElementById('selected-count').textContent = checked.length;
  document.getElementById('high-danger-count').textContent = highDanger.length;
  
  // تفعيل/تعطيل زر الإرسال
  const confirmInput = document.getElementById('confirm-input').value;
  const doubleConfirm = document.getElementById('double-confirm').checked;
  const submitBtn = document.getElementById('submit-btn');
  
  if (checked.length > 0 && confirmInput === 'FORMAT_SYSTEM' && doubleConfirm) {
    submitBtn.disabled = false;
  } else {
    submitBtn.disabled = true;
  }
  
  // معاينة
  if (checked.length > 0) {
    const preview = Array.from(checked).map(cb => {
      const label = document.querySelector(`label[for="${cb.id}"]`);
      return `<li>${label.textContent.trim()}</li>`;
    }).join('');
    document.getElementById('preview-content').innerHTML = `<ul class="mb-0">${preview}</ul>`;
    document.getElementById('preview-box').style.display = 'block';
  } else {
    document.getElementById('preview-box').style.display = 'none';
  }
}

// اختيار الكل
function selectAll() {
  document.querySelectorAll('.table-item').forEach(cb => cb.checked = true);
  updateCounters();
}

// إلغاء الكل
function deselectAll() {
  document.querySelectorAll('.table-item').forEach(cb => cb.checked = false);
  updateCounters();
}

// اختيار الخطرة فقط
function selectHighDanger() {
  document.querySelectorAll('.table-item').forEach(cb => {
    cb.checked = cb.dataset.danger === 'high';
  });
  updateCounters();
}

// تأكيد قبل الإرسال
function confirmCleanup() {
  const checked = document.querySelectorAll('.table-item:checked');
  const count = checked.length;
  
  if (count === 0) {
    alert('❌ يجب اختيار جدول واحد على الأقل!');
    return false;
  }
  
  const confirmText = document.getElementById('confirm-input').value;
  if (confirmText !== 'FORMAT_SYSTEM') {
    alert('❌ يجب كتابة "FORMAT_SYSTEM" بالضبط للتأكيد!');
    return false;
  }
  
  const message = `⚠️ تحذير نهائي!\n\nأنت على وشك حذف ${count} جدول بشكل نهائي.\n\nهل أنت متأكد 100%؟`;
  return confirm(message);
}

// مراقبة التغييرات
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.table-item').forEach(cb => {
    cb.addEventListener('change', updateCounters);
  });
  
  document.getElementById('confirm-input').addEventListener('input', updateCounters);
  document.getElementById('double-confirm').addEventListener('change', updateCounters);
  
  updateCounters();
});
</script>

{% endblock %}
