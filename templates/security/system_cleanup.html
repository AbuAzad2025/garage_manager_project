{% extends 'security/base_security.html' %}
{% block tour_name %}system_cleanup{% endblock %}
{% block security_title %}System Cleanup{% endblock %}
{% block security_icon %}<i class="fas fa-broom"></i>{% endblock %}
{% block security_description %}ØªÙ†Ø¸ÙŠÙ Ø¢Ù…Ù† Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡{% endblock %}
{% block security_breadcrumb %}<li class="breadcrumb-item active">System Cleanup</li>{% endblock %}

{% block extra_css %}
<style>
  .cleanup-section {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    background: #f8f9fa;
  }
  .cleanup-section-header {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
  }
  .table-checkbox {
    padding: 12px;
    border-radius: 8px;
    transition: all 0.3s;
    border: 1px solid transparent;
  }
  .table-checkbox:hover {
    background: #fff;
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
  }
  .table-checkbox input:checked ~ label {
    font-weight: bold;
    color: #dc3545;
  }
  .stats-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 20px;
  }
  .stats-box h3 {
    font-size: 2.5rem;
    margin: 0;
  }
  .stats-box p {
    margin: 5px 0 0 0;
    opacity: 0.9;
  }
  .confirm-box {
    background: #fff3cd;
    border: 3px solid #ffc107;
    padding: 25px;
    border-radius: 10px;
    margin: 20px 0;
  }
  .danger-zone {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .action-buttons {
    position: sticky;
    bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    z-index: 100;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <!-- ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ± -->
  <div class="danger-zone">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle fa-3x ml-3"></i>
      <div>
        <h4 class="mb-1">âš ï¸ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ± Ø¬Ø¯Ø§Ù‹!</h4>
        <p class="mb-0">Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§! ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.</p>
      </div>
    </div>
  </div>

  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h3 id="selected-count">0</h3>
        <p>Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø¯Ø¯</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h3>{{ stats.total_tables if stats else tables|length }}</h3>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
        <h3 id="high-danger-count">{{ stats.high_danger_tables if stats else 0 }}</h3>
        <p>Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-box" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
        <h3>{{ stats.medium_danger_tables if stats else 'âš ï¸' }}</h3>
        <p>Ø¬Ø¯Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©</p>
      </div>
    </div>
  </div>

  <div class="card shadow">
    <div class="card-header bg-gradient-danger text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-broom ml-2"></i>
          ØªÙ†Ø¸ÙŠÙ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
        </h5>
        <div>
          <button type="button" class="btn btn-light btn-sm" onclick="selectAll()">
            <i class="fas fa-check-double"></i> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" onclick="deselectAll()">
            <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
          </button>
          <button type="button" class="btn btn-warning btn-sm" onclick="selectHighDanger()">
            <i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø®Ø·Ø±Ø© ÙÙ‚Ø·
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <form method="POST" id="cleanup-form" onsubmit="return confirmCleanup();">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        {% if categories is defined and categories %}
          {% set category_list = categories %}
        {% else %}
          {% set fallback_high = tables | selectattr('danger', 'equalto', 'high') | list | length %}
          {% set category_list = [{
            'name': 'Ø£Ø®Ø±Ù‰',
            'tables': tables,
            'icon': 'fas fa-folder text-muted',
            'danger_zone': False,
            'description': '',
            'total': tables|length,
            'high_danger': fallback_high
          }] %}
        {% endif %}
        {% for category in category_list %}
          {% set outer_index = loop.index0 %}
          <div class="cleanup-section {% if category.danger_zone %}border-danger{% endif %}" {% if category.danger_zone %}style="border-color:#dc3545;background:#fff5f5;"{% endif %}>
            <div class="cleanup-section-header d-flex justify-content-between align-items-center {% if category.danger_zone %}text-danger{% endif %}">
              <div>
                <i class="{{ category.icon }}"></i>
                {{ category.name }}
                <small class="text-muted">({{ category.total }} Ø¬Ø¯ÙˆÙ„)</small>
              </div>
              {% if category.high_danger %}
                <span class="badge bg-danger">âš ï¸ {{ category.high_danger }} Ø¬Ø¯Ø§ÙˆÙ„ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ±Ø©</span>
              {% endif %}
            </div>
            {% if category.description %}
            <p class="text-muted small">{{ category.description }}</p>
            {% endif %}
            {% if category.danger_zone %}
            <div class="alert alert-danger mb-3">
              <i class="fas fa-skull-crossbones ml-2"></i>
              <strong>Ù…Ù†Ø·Ù‚Ø© Ø®Ø·Ø±Ø©:</strong> Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ ÙŠØ¹Ø·Ù„ ÙƒØ§Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù….
            </div>
            {% endif %}
            <div class="row gx-3 gy-2">
              {% for table in category.tables %}
              <div class="col-lg-6">
                <div class="form-check table-checkbox h-100">
                  {% set checkbox_id = 'table_' ~ outer_index ~ '_' ~ loop.index0 %}
                  <input class="form-check-input table-item" type="checkbox" name="tables"
                         value="{{ table.name }}" id="{{ checkbox_id }}"
                         data-danger="{{ table.danger }}" data-category="{{ category.name }}"
                         data-display="{{ table.display }}">
                  <label class="form-check-label w-100" for="{{ checkbox_id }}">
                    <span class="ml-2">{{ table.display }}</span>
                    {% if table.danger == 'high' %}
                      <span class="badge bg-danger">Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ ğŸ”´</span>
                    {% elif table.danger == 'medium' %}
                      <span class="badge bg-warning text-dark">Ø®Ø·Ø± Ù…ØªÙˆØ³Ø· ğŸŸ¡</span>
                    {% else %}
                      <span class="badge bg-success">Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶ ğŸŸ¢</span>
                    {% endif %}
                  </label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}

        <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
        <div class="confirm-box">
          <h5 class="text-warning mb-3">
            <i class="fas fa-shield-alt ml-2"></i>
            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
          </h5>
          
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-keyboard ml-1"></i>
              Ø§ÙƒØªØ¨ <code class="text-danger fs-5">FORMAT_SYSTEM</code> Ù„Ù„ØªØ£ÙƒÙŠØ¯ *
            </label>
            <input type="text" name="confirm" id="confirm-input" class="form-control form-control-lg" 
                   placeholder="FORMAT_SYSTEM" required autocomplete="off">
            <small class="text-muted">ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­</small>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="double-confirm" required>
            <label class="form-check-label fw-bold" for="double-confirm">
              <i class="fas fa-check-circle ml-1"></i>
              Ø£Ø¤ÙƒØ¯ Ø£Ù†Ù†ÙŠ Ù‚Ù…Øª Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙˆØ£ØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
            </label>
          </div>

          <div id="preview-box" class="alert alert-info" style="display: none;">
            <h6><i class="fas fa-eye ml-2"></i>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</h6>
            <div id="preview-content"></div>
          </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="action-buttons">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <button type="submit" class="btn btn-danger btn-lg" id="submit-btn" disabled>
                <i class="fas fa-trash-alt ml-2"></i>
                ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
              </button>
              <a href="{{ url_for('security.index') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-right ml-2"></i>
                Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©
              </a>
            </div>
            <div class="text-end">
              <small class="text-muted d-block">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ now().strftime('%Y-%m-%d %H:%M') }}</small>
              <small class="text-danger d-block">âš ï¸ Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ Ø±Ø¬Ø¹Ø© ÙÙŠÙ‡Ø§</small>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>

</div>

<script>
// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
function updateCounters() {
  const checked = document.querySelectorAll('.table-item:checked');
  const highDanger = Array.from(checked).filter(cb => cb.dataset.danger === 'high');
  
  document.getElementById('selected-count').textContent = checked.length;
  document.getElementById('high-danger-count').textContent = highDanger.length;
  
  // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  const confirmInput = document.getElementById('confirm-input').value;
  const doubleConfirm = document.getElementById('double-confirm').checked;
  const submitBtn = document.getElementById('submit-btn');
  
  if (checked.length > 0 && confirmInput === 'FORMAT_SYSTEM' && doubleConfirm) {
    submitBtn.disabled = false;
  } else {
    submitBtn.disabled = true;
  }
  
  // Ù…Ø¹Ø§ÙŠÙ†Ø©
  if (checked.length > 0) {
    const preview = Array.from(checked).map(cb => {
      const name = cb.dataset.display || cb.value;
      const category = cb.dataset.category ? ` <small class="text-muted">(${cb.dataset.category})</small>` : '';
      return `<li>${name}${category}</li>`;
    }).join('');
    document.getElementById('preview-content').innerHTML = `<ul class="mb-0">${preview}</ul>`;
    document.getElementById('preview-box').style.display = 'block';
  } else {
    document.getElementById('preview-box').style.display = 'none';
  }
}

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„
function selectAll() {
  document.querySelectorAll('.table-item').forEach(cb => cb.checked = true);
  updateCounters();
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
function deselectAll() {
  document.querySelectorAll('.table-item').forEach(cb => cb.checked = false);
  updateCounters();
}

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·Ø±Ø© ÙÙ‚Ø·
function selectHighDanger() {
  document.querySelectorAll('.table-item').forEach(cb => {
    cb.checked = cb.dataset.danger === 'high';
  });
  updateCounters();
}

// ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
function confirmCleanup() {
  const checked = document.querySelectorAll('.table-item:checked');
  const count = checked.length;
  
  if (count === 0) {
    alert('âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!');
    return false;
  }
  
  const confirmText = document.getElementById('confirm-input').value;
  if (confirmText !== 'FORMAT_SYSTEM') {
    alert('âŒ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© "FORMAT_SYSTEM" Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ù„ØªØ£ÙƒÙŠØ¯!');
    return false;
  }
  
  const message = `âš ï¸ ØªØ­Ø°ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ!\n\nØ£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø­Ø°Ù ${count} Ø¬Ø¯ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ 100%ØŸ`;
  return confirm(message);
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.table-item').forEach(cb => {
    cb.addEventListener('change', updateCounters);
  });
  
  document.getElementById('confirm-input').addEventListener('input', updateCounters);
  document.getElementById('double-confirm').addEventListener('change', updateCounters);
  
  updateCounters();
});
</script>

{% endblock %}
