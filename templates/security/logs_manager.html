{% extends 'base.html' %}
{% block title %}ูุฏูุฑ ุงูุณุฌูุงุช ุงูููุญุฏ{% endblock %}
{% block page_title %}๐ ูุฏูุฑ ุงูุณุฌูุงุช ุงูููุญุฏ{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <div class="alert alert-info border-0 shadow-sm">
    <i class="fas fa-clipboard-list"></i>
    <strong>ูุฏูุฑ ุงูุณุฌูุงุช ุงูููุญุฏ:</strong> ุณุฌูุงุช ุงูุชุฏููู + ุณุฌูุงุช ุงููุธุงู + ุชุชุจุน ุงูุฃุฎุทุงุก ูู ููุงู ูุงุญุฏ
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> ุณุฌูุงุช ุงููุธุงู</h5>
    </div>
    
    <div class="card-body">
      
      <!-- Nav tabs -->
      <ul class="nav nav-tabs nav-fill mb-4" id="logsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_tab == 'audit' %}active{% endif %}" 
                  id="audit-tab" 
                  data-toggle="tab" 
                  data-target="#audit" 
                  type="button" 
                  role="tab">
            <i class="fas fa-search"></i> ุณุฌู ุงูุชุฏููู
            <span class="badge bg-danger ms-1">{{ audit_count }}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_tab == 'system' %}active{% endif %}" 
                  id="system-tab" 
                  data-toggle="tab" 
                  data-target="#system" 
                  type="button" 
                  role="tab">
            <i class="fas fa-server"></i> ุณุฌูุงุช ุงููุธุงู
            <span class="badge bg-warning text-dark ms-1">{{ system_logs_count }}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_tab == 'errors' %}active{% endif %}" 
                  id="errors-tab" 
                  data-toggle="tab" 
                  data-target="#errors" 
                  type="button" 
                  role="tab">
            <i class="fas fa-exclamation-triangle"></i> ุชุชุจุน ุงูุฃุฎุทุงุก
            <span class="badge bg-danger ms-1">{{ errors_count }}</span>
          </button>
        </li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content" id="logsTabContent">
        
        <!-- ุชุจููุจ 1: ุณุฌู ุงูุชุฏููู -->
        <div class="tab-pane fade {% if active_tab == 'audit' %}show active{% endif %}" 
             id="audit" 
             role="tabpanel">
          
          <div class="mb-3">
            <form method="GET" class="row g-2">
              <input type="hidden" name="tab" value="audit">
              <div class="col-md-3">
                <select name="action" class="form-control">
                  <option value="">-- ูู ุงูุฅุฌุฑุงุกุงุช --</option>
                  <option value="login" {% if filter_action == 'login' %}selected{% endif %}>ุชุณุฌูู ุฏุฎูู</option>
                  <option value="create" {% if filter_action == 'create' %}selected{% endif %}>ุฅูุดุงุก</option>
                  <option value="update" {% if filter_action == 'update' %}selected{% endif %}>ุชุนุฏูู</option>
                  <option value="delete" {% if filter_action == 'delete' %}selected{% endif %}>ุญุฐู</option>
                </select>
              </div>
              <div class="col-md-3">
                <select name="user_id" class="form-control">
                  <option value="">-- ูู ุงููุณุชุฎุฏููู --</option>
                  {% for user in all_users %}
                  <option value="{{ user.id }}" {% if filter_user == user.id|string %}selected{% endif %}>{{ user.username }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <input type="date" name="date" class="form-control" value="{{ filter_date }}">
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-filter"></i> ููุชุฑุฉ
                </button>
              </div>
              <div class="col-md-2">
                <a href="{{ url_for('security.logs_manager', tab='audit') }}" class="btn btn-secondary w-100">
                  <i class="fas fa-redo"></i> ุฅุนุงุฏุฉ ุชุนููู
                </a>
              </div>
            </form>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
                <tr>
                  <th>ุงูุชุงุฑูุฎ</th>
                  <th>ุงููุณุชุฎุฏู</th>
                  <th>ุงูุฅุฌุฑุงุก</th>
                  <th>ุงูุชูุงุตูู</th>
                  <th>IP</th>
                  <th>ุงูุญุงูุฉ</th>
                </tr>
              </thead>
              <tbody>
                {% for log in audit_logs %}
                <tr>
                  <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td>
                    <span class="badge bg-info">{{ log.user.username if log.user else 'N/A' }}</span>
                  </td>
                  <td>
                    <i class="fas fa-{{ _get_action_icon(log.action) }}"></i>
                    {{ log.action }}
                  </td>
                  <td>{{ log.details or '-' }}</td>
                  <td><code>{{ log.ip_address or '-' }}</code></td>
                  <td>
                    {% if log.action in ['login', 'create', 'update'] %}
                    <span class="badge bg-success">ูุฌุญ</span>
                    {% elif 'failed' in (log.action or '').lower() %}
                    <span class="badge bg-danger">ูุดู</span>
                    {% else %}
                    <span class="badge bg-secondary">ุนุงุฏู</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if audit_logs|length == 0 %}
          <div class="alert alert-info text-center">
            <i class="fas fa-inbox"></i> ูุง ุชูุฌุฏ ุณุฌูุงุช
          </div>
          {% endif %}
          
        </div>
        
        <!-- ุชุจููุจ 2: ุณุฌูุงุช ุงููุธุงู -->
        <div class="tab-pane fade {% if active_tab == 'system' %}show active{% endif %}" 
             id="system" 
             role="tabpanel">
          
          <div class="alert alert-secondary">
            <i class="fas fa-server"></i> <strong>ุณุฌูุงุช ุงููุธุงู:</strong> ุขุฎุฑ 500 ุณุทุฑ ูู ููู ุงูุณุฌูุงุช
          </div>
          
          <div class="card bg-dark text-light">
            <div class="card-body">
              <pre style="max-height: 600px; overflow-y: auto; font-size: 12px;">{{ system_logs }}</pre>
            </div>
          </div>
          
          <div class="mt-3">
            <form method="POST" action="{{ url_for('security.clear_logs') }}">
              <button type="submit" class="btn btn-danger" onclick="return confirm('ุญุฐู ุฌููุน ุงูุณุฌูุงุชุ')">
                <i class="fas fa-trash"></i> ูุณุญ ุงูุณุฌูุงุช
              </button>
            </form>
          </div>
          
        </div>
        
        <!-- ุชุจููุจ 3: ุชุชุจุน ุงูุฃุฎุทุงุก -->
        <div class="tab-pane fade {% if active_tab == 'errors' %}show active{% endif %}" 
             id="errors" 
             role="tabpanel">
          
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> <strong>ุชุชุจุน ุงูุฃุฎุทุงุก:</strong> ุงูุฃุฎุทุงุก ุงูุชู ุญุฏุซุช ูู ุงููุธุงู
          </div>
          
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="card border-danger">
                <div class="card-body text-center">
                  <h3 class="text-danger">{{ errors_today }}</h3>
                  <p class="mb-0">ุฃุฎุทุงุก ุงูููู</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-body text-center">
                  <h3 class="text-warning">{{ errors_week }}</h3>
                  <p class="mb-0">ุฃุฎุทุงุก ูุฐุง ุงูุฃุณุจูุน</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-info">
                <div class="card-body text-center">
                  <h3 class="text-info">{{ errors_month }}</h3>
                  <p class="mb-0">ุฃุฎุทุงุก ูุฐุง ุงูุดูุฑ</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-secondary">
                <div class="card-body text-center">
                  <h3 class="text-secondary">{{ errors_total }}</h3>
                  <p class="mb-0">ุฅุฌูุงูู ุงูุฃุฎุทุงุก</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-danger">
                <tr>
                  <th>ุงูุชุงุฑูุฎ</th>
                  <th>ุงูููุน</th>
                  <th>ุงูุฑุณุงูุฉ</th>
                  <th>ุงูููู</th>
                  <th>ุงูุณุทุฑ</th>
                  <th>ุงููุณุชุฎุฏู</th>
                </tr>
              </thead>
              <tbody>
                {% for error in error_logs %}
                <tr>
                  <td>{{ error.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td>
                    <span class="badge bg-danger">{{ error.error_type }}</span>
                  </td>
                  <td>
                    <small>{{ error.message[:100] }}...</small>
                  </td>
                  <td><code>{{ error.file or '-' }}</code></td>
                  <td>{{ error.line or '-' }}</td>
                  <td>{{ error.user.username if error.user else '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if error_logs|length == 0 %}
          <div class="alert alert-success text-center">
            <i class="fas fa-check-circle"></i> ูุง ุชูุฌุฏ ุฃุฎุทุงุก - ุงููุธุงู ูุนูู ุจุดูู ููุชุงุฒ!
          </div>
          {% endif %}
          
        </div>
        
      </div>
      
    </div>
  </div>

</div>

<script>
// ุชูุนูู ุงูุชุจููุจ ูู URL
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');
  if (tab) {
    const tabButton = document.getElementById(tab + '-tab');
    if (tabButton) {
      $(tabButton).tab('show');
    }
  }
});
</script>

{% endblock %}

