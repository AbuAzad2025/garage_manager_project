{% extends 'base.html' %}
{% block title %}AI Security Assistant{% endblock %}
{% block page_title %}ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ -->
  <div class="alert alert-info mb-3">
    <div class="row align-items-center">
      <div class="col-md-8">
        <i class="fas fa-info-circle"></i> <strong>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù…ØªØµÙ„ Ø¨Ù€ Groq API (Llama 3.3 70B)</strong>
        <br><small>ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙØªØ§Ø­ ÙÙŠ <a href="{{ url_for('security.ai_config') }}" class="alert-link">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</a></small>
      </div>
      <div class="col-md-4 text-end">
        <a href="{{ url_for('security.ai_config') }}" class="btn btn-sm btn-outline-primary">
          <i class="fas fa-key"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        </a>
      </div>
    </div>
  </div>
  
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-robot"></i> Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ AI</h5>
        </div>
        <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatContainer">
          <div class="chat-messages" id="chatMessages">
            <div class="alert alert-info">
              <strong>Ù…Ø±Ø­Ø¨Ø§Ù‹!</strong> Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø£Ù…Ø§Ù† Ø§Ù„Ù†Ø¸Ø§Ù….
            </div>
          </div>
        </div>
        <div class="card-footer">
          <form id="chatForm">
            <div class="input-group">
              <input type="text" class="form-control" id="chatInput" placeholder="Ø§Ø³Ø£Ù„ AI...">
              <button class="btn btn-primary" type="submit">
                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø°ÙƒÙŠØ©</h5>
        </div>
        <div class="card-body">
          {% if suggestions %}
            {% for sug in suggestions %}
            <div class="alert alert-{{ sug.type }} alert-sm">
              <strong>{{ sug.title }}</strong><br>
              <small>{{ sug.action }}</small>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          {% endif %}
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h5>
        </div>
        <div class="card-body">
          <a href="{{ url_for('security.database_browser') }}" class="btn btn-sm btn-outline-primary w-100 mb-2">
            <i class="fas fa-database"></i> Ù…ØªØµÙØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          </a>
          <a href="{{ url_for('security.decrypt_tool') }}" class="btn btn-sm btn-outline-warning w-100 mb-2">
            <i class="fas fa-key"></i> ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
          </a>
          <a href="{{ url_for('security.ai_analytics') }}" class="btn btn-sm btn-outline-success w-100 mb-2">
            <i class="fas fa-brain"></i> ØªØ­Ù„ÙŠÙ„Ø§Øª AI
          </a>
          <a href="{{ url_for('security.pattern_detection') }}" class="btn btn-sm btn-outline-danger w-100">
            <i class="fas fa-search"></i> ÙƒØ´Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø·
          </a>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// CSRF Token
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

document.getElementById('chatForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML += `
    <div class="alert alert-secondary mb-2">
      <strong><i class="fas fa-user"></i> Ø£Ù†Øª:</strong> ${message}
    </div>`;
  input.value = '';
  
  // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
  const loadingId = 'loading-' + Date.now();
  chatMessages.innerHTML += `
    <div class="alert alert-info mb-2" id="${loadingId}">
      <i class="fas fa-spinner fa-spin"></i> <strong>AI ÙŠÙÙƒØ±...</strong>
    </div>`;
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ AI
  try {
    const response = await fetch('{{ url_for("security.ai_chat") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      credentials: 'same-origin',
      body: JSON.stringify({message})
    });
    
    // Ø­Ø°Ù Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.getElementById(loadingId)?.remove();
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Ø¹Ø±Ø¶ Ø±Ø¯ AI
    chatMessages.innerHTML += `
      <div class="alert alert-success mb-2">
        <strong><i class="fas fa-robot"></i> AI:</strong> ${data.response}
      </div>`;
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
  } catch (err) {
    // Ø­Ø°Ù Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.getElementById(loadingId)?.remove();
    
    chatMessages.innerHTML += `
      <div class="alert alert-danger mb-2">
        <strong><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£:</strong> 
        ${err.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ AI'}
        <br><small>ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙØªØ§Ø­ ÙÙŠ <a href="{{ url_for('security.ai_config') }}" class="alert-link">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</a></small>
      </div>`;
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    console.error('AI Error:', err);
  }
});
</script>
{% endblock %}

