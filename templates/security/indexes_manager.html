{% extends 'base.html' %}

{% block title %}إدارة الفهارس - 89 فهرس احترافي{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}
.stats-card h3 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
}
.stats-card p {
    margin: 5px 0 0 0;
    opacity: 0.9;
}
.table-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s;
}
.table-card:hover {
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}
.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
}
.table-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2c3e50;
}
.table-stats {
    font-size: 0.85rem;
    color: #6c757d;
}
.badge-custom {
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.85rem;
    font-weight: 600;
}
.columns-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}
.column-item {
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 5px;
    font-size: 0.9rem;
    border-left: 3px solid #007bff;
}
.column-indexed {
    border-left-color: #28a745;
    background: #d4edda;
}
.indexes-list {
    margin-top: 15px;
}
.index-item {
    background: #fff3cd;
    padding: 10px 15px;
    border-radius: 5px;
    margin-bottom: 8px;
    border-left: 4px solid #ffc107;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.index-unique {
    border-left-color: #17a2b8;
    background: #d1ecf1;
}
.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.btn-action {
    padding: 8px 16px;
    border-radius: 5px;
    font-size: 0.9rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
}
.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.quick-actions {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.quick-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s;
}
.quick-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}
.search-box {
    margin-bottom: 20px;
}
.search-box input {
    border-radius: 25px;
    padding: 12px 20px;
    border: 2px solid #e9ecef;
    font-size: 1rem;
}
.search-box input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}
.priority-high { color: #dc3545; font-weight: 700; }
.priority-medium { color: #ffc107; font-weight: 600; }
.priority-low { color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 20px;">
    
    {% include 'security/_navigation.html' %}
    
    <div class="alert alert-success border-0 shadow-sm mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-bolt"></i>
                <strong>نظام الفهارس الاحترافي:</strong>
                <span class="badge bg-white text-success ms-2">89 فهرس</span>
                <span class="badge bg-white text-info ms-1">18 جدول</span>
                <span class="badge bg-white text-warning ms-1">تسريع 10x</span>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="fas fa-database"></i> إدارة الفهارس <span class="badge bg-success">89 فهرس</span>
                <small class="text-muted">Indexes Manager</small>
            </h2>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h3>{{ stats.total_tables }}</h3>
                <p>إجمالي الجداول</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3>{{ stats.total_indexes }}</h3>
                <p>إجمالي الفهارس</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h3>{{ stats.avg_indexes_per_table }}</h3>
                <p>متوسط الفهارس/جدول</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <h3>{{ stats.total_columns }}</h3>
                <p>إجمالي الأعمدة</p>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="search-box">
                <input type="text" class="form-control" id="searchTables" placeholder="🔍 ابحث عن جدول...">
            </div>
        </div>
    </div>

    <div class="row" id="tablesContainer">
        {% for table in tables %}
        <div class="col-md-6 col-lg-4 table-item" data-table="{{ table.name }}">
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">
                        <i class="fas fa-table"></i> {{ table.name }}
                    </div>
                    <div class="table-stats">
                        <span class="badge badge-primary badge-custom">{{ table.columns_count }} عمود</span>
                        <span class="badge badge-success badge-custom">{{ table.indexes_count }} فهرس</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-sm btn-primary btn-action" onclick="viewTableDetails('{{ table.name }}')">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                    <button class="btn btn-sm btn-info btn-action" onclick="analyzeTable('{{ table.name }}')">
                        <i class="fas fa-chart-line"></i> تحليل
                    </button>
                    <button class="btn btn-sm btn-success btn-action" onclick="createIndexModal('{{ table.name }}')">
                        <i class="fas fa-plus"></i> فهرس
                    </button>
                </div>

                {% if table.indexes %}
                <div class="indexes-list">
                    <strong>الفهارس الحالية:</strong>
                    {% for idx in table.indexes[:3] %}
                    <div class="index-item {% if idx.unique %}index-unique{% endif %}">
                        <div>
                            <strong>{{ idx.name }}</strong>
                            <br>
                            <small>{{ idx.columns|join(', ') }}</small>
                            {% if idx.unique %}
                            <span class="badge badge-info">UNIQUE</span>
                            {% endif %}
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="dropIndex('{{ idx.name }}', '{{ table.name }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                    {% if table.indexes|length > 3 %}
                    <small class="text-muted">+ {{ table.indexes|length - 3 }} فهرس آخر...</small>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-warning mt-3 mb-0" style="font-size: 0.85rem;">
                    ⚠️ لا توجد فهارس على هذا الجدول
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="quick-actions">
        <button class="quick-btn bg-success" onclick="autoOptimize()" title="تحسين تلقائي">
            <i class="fas fa-magic"></i>
        </button>
        <button class="quick-btn bg-warning" onclick="cleanAndRebuild()" title="تنظيف وإعادة بناء">
            <i class="fas fa-recycle"></i>
        </button>
        <button class="quick-btn bg-primary" onclick="exportIndexes()" title="تصدير الفهارس">
            <i class="fas fa-download"></i>
        </button>
    </div>
</div>

<div class="modal fade" id="tableDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-table"></i> تفاصيل الجدول: <span id="modalTableName"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="tableDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createIndexModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> إنشاء فهرس جديد
                </h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createIndexForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" id="createTableName" name="table">
                    
                    <div class="form-group">
                        <label>اسم الفهرس</label>
                        <input type="text" class="form-control" id="indexName" name="index_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>الأعمدة</label>
                        <select class="form-control" id="indexColumns" name="columns" multiple required>
                        </select>
                        <small class="form-text text-muted">اضغط Ctrl لاختيار أكثر من عمود</small>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="indexUnique" name="unique">
                            <label class="custom-control-label" for="indexUnique">
                                فهرس فريد (UNIQUE)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateIndex()">
                    <i class="fas fa-plus"></i> إنشاء الفهرس
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="analyzeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line"></i> تحليل واقتراحات: <span id="analyzeTableName"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="analyzeContent">
                <div class="text-center">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const tablesData = {{ tables|tojson }};

function viewTableDetails(tableName) {
    const table = tablesData.find(t => t.name === tableName);
    if (!table) return;
    
    $('#modalTableName').text(tableName);
    
    let html = '<div class="row">';
    
    html += '<div class="col-md-6"><h5><i class="fas fa-columns"></i> الأعمدة</h5><div class="columns-list">';
    const indexedCols = new Set();
    table.indexes.forEach(idx => idx.columns.forEach(c => indexedCols.add(c)));
    
    table.columns.forEach(col => {
        const isIndexed = indexedCols.has(col.name);
        html += `<div class="column-item ${isIndexed ? 'column-indexed' : ''}">
            <strong>${col.name}</strong>
            <br><small class="text-muted">${col.type}</small>
            ${isIndexed ? '<br><span class="badge badge-success badge-sm">مفهرس</span>' : ''}
        </div>`;
    });
    html += '</div></div>';
    
    html += '<div class="col-md-6"><h5><i class="fas fa-list"></i> الفهارس</h5>';
    if (table.indexes.length > 0) {
        table.indexes.forEach(idx => {
            html += `<div class="index-item ${idx.unique ? 'index-unique' : ''}">
                <div>
                    <strong>${idx.name}</strong>
                    <br><small>${idx.columns.join(', ')}</small>
                    ${idx.unique ? '<span class="badge badge-info">UNIQUE</span>' : ''}
                </div>
                <button class="btn btn-sm btn-danger" onclick="dropIndex('${idx.name}', '${tableName}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>`;
        });
    } else {
        html += '<div class="alert alert-warning">⚠️ لا توجد فهارس على هذا الجدول</div>';
    }
    html += '</div>';
    
    html += '</div>';
    
    $('#tableDetailsContent').html(html);
    $('#tableDetailsModal').modal('show');
}

function createIndexModal(tableName) {
    const table = tablesData.find(t => t.name === tableName);
    if (!table) return;
    
    $('#createTableName').val(tableName);
    $('#indexName').val('ix_' + tableName + '_');
    
    let options = '';
    table.columns.forEach(col => {
        options += `<option value="${col.name}">${col.name} (${col.type})</option>`;
    });
    $('#indexColumns').html(options);
    
    $('#createIndexModal').modal('show');
}

function submitCreateIndex() {
    const formData = {
        table: $('#createTableName').val(),
        index_name: $('#indexName').val(),
        columns: $('#indexColumns').val(),
        unique: $('#indexUnique').is(':checked')
    };
    
    if (!formData.columns || formData.columns.length === 0) {
        Swal.fire('خطأ', 'يجب اختيار عمود واحد على الأقل', 'error');
        return;
    }
    
    $.ajax({
        url: '{{ url_for("security.api_create_index") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            Swal.fire('نجح!', response.message, 'success').then(() => location.reload());
        },
        error: function(xhr) {
            const msg = xhr.responseJSON?.message || 'حدث خطأ';
            Swal.fire('خطأ', msg, 'error');
        }
    });
}

function dropIndex(indexName, tableName) {
    Swal.fire({
        title: 'تأكيد الحذف',
        text: `هل تريد حذف الفهرس "${indexName}"؟`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: '{{ url_for("security.api_drop_index") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ index_name: indexName, table: tableName }),
                success: function(response) {
                    Swal.fire('نجح!', response.message, 'success').then(() => location.reload());
                },
                error: function(xhr) {
                    const msg = xhr.responseJSON?.message || 'حدث خطأ';
                    Swal.fire('خطأ', msg, 'error');
                }
            });
        }
    });
}

function autoOptimize() {
    Swal.fire({
        title: 'تحسين تلقائي',
        text: 'سيتم إضافة فهارس محترفة على الجداول المهمة',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، حسّن',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'جاري التحسين...',
                text: 'الرجاء الانتظار',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            $.ajax({
                url: '{{ url_for("security.api_auto_optimize_indexes") }}',
                method: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'نجح!',
                        html: `<p>${response.message}</p>
                               <p>تم إنشاء: ${response.created.length}</p>
                               <p>موجود مسبقاً: ${response.skipped}</p>`,
                        confirmButtonText: 'تحديث الصفحة'
                    }).then(() => location.reload());
                },
                error: function(xhr) {
                    const msg = xhr.responseJSON?.message || 'حدث خطأ';
                    Swal.fire('خطأ', msg, 'error');
                }
            });
        }
    });
}

function cleanAndRebuild() {
    Swal.fire({
        title: 'تنظيف وإعادة بناء',
        html: '<p><strong>⚠️ تحذير:</strong></p><p>سيتم حذف جميع الفهارس وإعادة إنشائها</p><p>هذا آمن لكن قد يأخذ وقتاً</p>',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، نظّف وأعد البناء',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'جاري التنظيف...',
                text: 'الرجاء الانتظار',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            $.ajax({
                url: '{{ url_for("security.api_clean_rebuild_indexes") }}',
                method: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'نجح!',
                        html: `<p>${response.message}</p>
                               <p>تم حذف: ${response.dropped} فهرس</p>
                               <p>تم إنشاء: ${response.created} فهرس</p>`,
                        confirmButtonText: 'تحديث الصفحة'
                    }).then(() => location.reload());
                },
                error: function(xhr) {
                    const msg = xhr.responseJSON?.message || 'حدث خطأ';
                    Swal.fire('خطأ', msg, 'error');
                }
            });
        }
    });
}

function analyzeTable(tableName) {
    Swal.fire({
        title: 'جاري التحليل...',
        text: 'الرجاء الانتظار',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    $.ajax({
        url: '{{ url_for("security.api_analyze_table") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ table: tableName }),
        success: function(response) {
            $('#analyzeTableName').text(tableName);
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4>${response.total_columns}</h4>
                                <p>إجمالي الأعمدة</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4>${response.indexed_columns}</h4>
                                <p>أعمدة مفهرسة</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4>${response.suggestions.length}</h4>
                                <p>اقتراحات</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h5><i class="fas fa-lightbulb"></i> اقتراحات الفهارس:</h5>
            `;
            
            if (response.suggestions.length > 0) {
                html += '<div class="list-group">';
                response.suggestions.forEach(sug => {
                    const priorityClass = sug.priority === 'high' ? 'priority-high' : 
                                        sug.priority === 'medium' ? 'priority-medium' : 'priority-low';
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="${priorityClass}">${sug.column}</strong>
                                <span class="text-muted">(${sug.type})</span>
                                <br>
                                <small>${sug.reason}</small>
                            </div>
                            <div>
                                <span class="badge badge-${sug.priority === 'high' ? 'danger' : sug.priority === 'medium' ? 'warning' : 'secondary'}">
                                    ${sug.priority === 'high' ? 'عالي' : sug.priority === 'medium' ? 'متوسط' : 'منخفض'}
                                </span>
                                <button class="btn btn-sm btn-success ml-2" onclick="quickCreateIndex('${tableName}', '${sug.column}', '${sug.index_name}')">
                                    <i class="fas fa-plus"></i> إضافة
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                html += '<div class="mt-3">';
                html += '<button class="btn btn-primary btn-block" onclick="createAllSuggested(\'' + tableName + '\')">';
                html += '<i class="fas fa-magic"></i> إضافة جميع الاقتراحات ذات الأولوية العالية';
                html += '</button>';
                html += '</div>';
            } else {
                html += '<div class="alert alert-success">✅ الجدول محسّن بالكامل - لا توجد اقتراحات</div>';
            }
            
            $('#analyzeContent').html(html);
            Swal.close();
            $('#analyzeModal').modal('show');
        },
        error: function(xhr) {
            const msg = xhr.responseJSON?.message || 'حدث خطأ';
            Swal.fire('خطأ', msg, 'error');
        }
    });
}

function quickCreateIndex(tableName, columnName, indexName) {
    $.ajax({
        url: '{{ url_for("security.api_create_index") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            table: tableName,
            index_name: indexName,
            columns: [columnName],
            unique: false
        }),
        success: function(response) {
            Swal.fire('نجح!', response.message, 'success').then(() => {
                $('#analyzeModal').modal('hide');
                location.reload();
            });
        },
        error: function(xhr) {
            const msg = xhr.responseJSON?.message || 'حدث خطأ';
            Swal.fire('خطأ', msg, 'error');
        }
    });
}

function createAllSuggested(tableName) {
    analyzeTable(tableName);
}

function exportIndexes() {
    const data = tablesData.map(t => ({
        table: t.name,
        indexes: t.indexes
    }));
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'indexes_export_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    
    Swal.fire('نجح!', 'تم تصدير الفهارس بنجاح', 'success');
}

$('#searchTables').on('keyup', function() {
    const searchTerm = $(this).val().toLowerCase();
    $('.table-item').each(function() {
        const tableName = $(this).data('table').toLowerCase();
        if (tableName.includes(searchTerm)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
});

$('#indexColumns').on('change', function() {
    const selected = $(this).val();
    const tableName = $('#createTableName').val();
    if (selected && selected.length > 0) {
        const suffix = selected.length === 1 ? selected[0] : selected.join('_');
        $('#indexName').val('ix_' + tableName + '_' + suffix);
    }
});
</script>
{% endblock %}

