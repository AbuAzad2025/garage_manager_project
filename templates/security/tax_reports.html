{% extends 'base.html' %}

{% block title %}ğŸ’° ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨{% endblock %}

{% block content %}
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">ğŸ’° ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ <small class="badge badge-success">Tax Reports</small></h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li class="breadcrumb-item"><a href="/security/"><i class="fas fa-shield-alt"></i> Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ©</a></li>
          <li class="breadcrumb-item active">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">
    
    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø© -->
    <div class="row">
      <div class="col-md-12">
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-calendar"></i> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø©</h3>
          </div>
          <div class="card-body">
            <form method="GET" class="form-inline">
              <div class="form-group mx-sm-3 mb-2">
                <label for="period" class="mr-2">Ø§Ù„ÙØªØ±Ø©:</label>
                <input type="month" name="period" id="period" class="form-control" 
                       value="{{ period }}" onchange="this.form.submit()">
              </div>
              <button type="submit" class="btn btn-primary mb-2">
                <i class="fas fa-search"></i> Ø¹Ø±Ø¶
              </button>
              <a href="{{ url_for('security.export_tax_report', period=period) }}" 
                 class="btn btn-success mb-2 ml-2">
                <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±
              </a>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Ù…Ù„Ø®Øµ VAT -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-gradient-primary">
            <h3 class="card-title"><i class="fas fa-calculator"></i> Ù…Ù„Ø®Øµ VAT - {{ period }}</h3>
          </div>
          <div class="card-body">
            {% if summary.success %}
            <div class="row">
              <div class="col-md-3">
                <div class="info-box bg-info">
                  <span class="info-box-icon"><i class="fas fa-arrow-down"></i></span>
                  <div class="info-box-content">
                    <span class="info-box-text">INPUT VAT</span>
                    <span class="info-box-number">{{ "%.2f"|format(summary.input_vat) }} â‚ª</span>
                    <small>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</small>
                  </div>
                </div>
              </div>
              
              <div class="col-md-3">
                <div class="info-box bg-success">
                  <span class="info-box-icon"><i class="fas fa-arrow-up"></i></span>
                  <div class="info-box-content">
                    <span class="info-box-text">OUTPUT VAT</span>
                    <span class="info-box-number">{{ "%.2f"|format(summary.output_vat) }} â‚ª</span>
                    <small>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</small>
                  </div>
                </div>
              </div>
              
              <div class="col-md-3">
                <div class="info-box {{ 'bg-warning' if summary.net_vat > 0 else 'bg-secondary' }}">
                  <span class="info-box-icon"><i class="fas fa-balance-scale"></i></span>
                  <div class="info-box-content">
                    <span class="info-box-text">NET VAT</span>
                    <span class="info-box-number">{{ "%.2f"|format(summary.net_vat) }} â‚ª</span>
                    <small>{{ 'Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ø­ÙƒÙˆÙ…Ø©' if summary.net_vat > 0 else 'Ù…Ø³ØªØ±Ø¯ Ù…Ù† Ø§Ù„Ø­ÙƒÙˆÙ…Ø©' }}</small>
                  </div>
                </div>
              </div>
              
              <div class="col-md-3">
                <div class="info-box bg-danger">
                  <span class="info-box-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                  <div class="info-box-content">
                    <span class="info-box-text">Income Tax</span>
                    <span class="info-box-number">{{ "%.2f"|format(summary.income_tax) }} â‚ª</span>
                    <small>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ø®Ù„</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© -->
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              <strong>Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©:</strong> 
              NET VAT = OUTPUT VAT ({{ "%.2f"|format(summary.output_vat) }}) - INPUT VAT ({{ "%.2f"|format(summary.input_vat) }})
              = <strong>{{ "%.2f"|format(summary.net_vat) }} â‚ª</strong>
            </div>
            {% else %}
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i> {{ summary.error }}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-list"></i> Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (Ø¢Ø®Ø± 100)</h3>
          </div>
          <div class="card-body table-responsive p-0" style="max-height: 500px;">
            <table class="table table-sm table-striped table-head-fixed">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                  <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                  <th>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in entries %}
                <tr>
                  <td>{{ entry.id }}</td>
                  <td>
                    {% if entry.entry_type == 'OUTPUT_VAT' %}
                      <span class="badge badge-success">OUT</span>
                    {% elif entry.entry_type == 'INPUT_VAT' %}
                      <span class="badge badge-info">IN</span>
                    {% elif entry.entry_type == 'INCOME_TAX' %}
                      <span class="badge badge-danger">TAX</span>
                    {% else %}
                      <span class="badge badge-secondary">{{ entry.entry_type }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <small>{{ entry.transaction_type }}</small><br>
                    <small class="text-muted">#{{ entry.transaction_reference or entry.transaction_id }}</small>
                  </td>
                  <td>{{ "%.2f"|format(entry.base_amount) }} {{ entry.currency }}</td>
                  <td>{{ "%.1f"|format(entry.tax_rate) }}%</td>
                  <td><strong>{{ "%.2f"|format(entry.tax_amount) }}</strong></td>
                  <td>{{ "%.2f"|format(entry.total_amount) }}</td>
                  <td><small>{{ entry.created_at.strftime('%Y-%m-%d') if entry.created_at else '-' }}</small></td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="8" class="text-center text-muted">
                    <i class="fas fa-inbox"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¶Ø±ÙŠØ¨ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ù†ÙˆÙŠØ© -->
    {% if yearly_data %}
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-line"></i> Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³Ù†Ø© {{ current_year }}</h3>
          </div>
          <div class="card-body">
            <canvas id="yearlyChart" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    
  </div>
</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
<script>
$(document).ready(function() {
    {% if yearly_data %}
    // Yearly trend chart
    const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
    const yearlyData = {{ yearly_data|tojson }};
    
    const periods = Object.keys(yearlyData).sort();
    const outputVat = periods.map(p => yearlyData[p]['OUTPUT_VAT'] || 0);
    const inputVat = periods.map(p => yearlyData[p]['INPUT_VAT'] || 0);
    const netVat = periods.map((p, i) => outputVat[i] - inputVat[i]);
    
    new Chart(yearlyCtx, {
        type: 'line',
        data: {
            labels: periods,
            datasets: [
                {
                    label: 'OUTPUT VAT',
                    data: outputVat,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'INPUT VAT',
                    data: inputVat,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'NET VAT',
                    data: netVat,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(0) + ' â‚ª';
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}

