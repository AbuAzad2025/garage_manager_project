{% extends 'base.html' %}
{% block title %}مدير قاعدة البيانات الموحد{% endblock %}
{% block page_title %}🗄️ مدير قاعدة البيانات الموحد{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active"><i class="fas fa-database"></i> Database Manager</li>
{% if active_tab %}
<li class="breadcrumb-item active">{{ active_tab|title }}</li>
{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <div class="alert alert-success border-0 shadow-sm">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <i class="fas fa-database"></i>
        <strong>مركز التحكم الشامل:</strong>
        <span class="badge bg-white text-success ms-2">{{ tables|length }} جدول</span>
        {% if indexes_stats %}
        <span class="badge bg-white text-info ms-1">{{ indexes_stats.total_indexes }} فهرس</span>
        {% endif %}
      </div>
      <small class="text-muted">11 أداة في مكان واحد</small>
    </div>
  </div>

  <div class="card shadow">
    <div class="card-header bg-gradient-primary text-white">
      <h5 class="mb-0"><i class="fas fa-terminal"></i> Database Control Center</h5>
    </div>
    
    <div class="card-body p-0">
      
      <ul class="nav nav-tabs nav-fill" id="dbTabs" role="tablist" style="border-bottom: 2px solid #dee2e6;">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'browse' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='browse') }}">
            <i class="fas fa-search"></i> تصفح
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'edit' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='edit') }}">
            <i class="fas fa-edit"></i> تحرير
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'schema' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='schema') }}">
            <i class="fas fa-sitemap"></i> هيكل
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'indexes' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='indexes') }}">
            <i class="fas fa-bolt"></i> فهارس
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'logs' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='logs') }}">
            <i class="fas fa-file-alt"></i> سجلات
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'sql' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='sql') }}">
            <i class="fas fa-code"></i> SQL
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'python' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='python') }}">
            <i class="fab fa-python"></i> Python
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'maintenance' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='maintenance') }}">
            <i class="fas fa-tools"></i> صيانة
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'restore' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='restore') }}">
            <i class="fas fa-upload"></i> استعادة
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'tools' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='tools') }}">
            <i class="fas fa-wrench"></i> أدوات
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'archive' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='archive') }}">
            <i class="fas fa-archive"></i> الأرشيفات
          </a>
        </li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content" id="dbTabContent">
        
        <!-- تبويب 1: تصفح الجداول -->
        <div class="tab-pane fade {% if active_tab == 'browse' %}show active{% endif %}" 
             id="browse" 
             role="tabpanel">
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                  <strong><i class="fas fa-list"></i> الجداول ({{ tables|length }})</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='browse', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                      <span class="badge bg-secondary float-end">{{ table_counts.get(table, 0) }}</span>
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table %}
              <div class="card">
                <div class="card-header bg-light">
                  <h6 class="mb-0">
                    <i class="fas fa-table"></i> {{ selected_table }}
                    <span class="badge bg-info ms-2">{{ data|length }} صف</span>
                    <span class="badge bg-success ms-1">{{ columns|length }} عمود</span>
                  </h6>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive" style="max-height: 600px;">
                    <table class="table table-sm table-hover mb-0">
                      <thead class="table-dark sticky-top">
                        <tr>
                          {% for col in columns %}
                          <th>{{ col }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in data %}
                        <tr>
                          {% for col in columns %}
                          <td>{{ row.get(col, '') }}</td>
                          {% endfor %}
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> اختر جدولاً من القائمة
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- تبويب 2: تحرير البيانات -->
        <div class="tab-pane fade {% if active_tab == 'edit' %}show active{% endif %}" 
             id="edit" 
             role="tabpanel">
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-success">
                <div class="card-header bg-success text-white">
                  <strong><i class="fas fa-list"></i> الجداول</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='edit', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table %}
              <div class="alert alert-success">
                <i class="fas fa-edit"></i> <strong>تحرير جدول:</strong> {{ selected_table }}
              </div>
              
              <!-- أزرار الإجراءات -->
              <div class="btn-group mb-3" role="group">
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addColumnModal">
                  <i class="fas fa-plus"></i> إضافة عمود
                </button>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addRowModal">
                  <i class="fas fa-plus-circle"></i> إضافة صف
                </button>
                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#renameTableModal">
                  <i class="fas fa-i-cursor"></i> إعادة تسمية
                </button>
              </div>
              
              <!-- جدول البيانات -->
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead class="table-dark">
                    <tr>
                      {% for col in columns %}
                      <th>
                        {{ col }}
                        <div class="btn-group btn-group-sm float-end">
                          <button class="btn btn-sm btn-warning" title="تعديل العمود">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-sm btn-danger" title="حذف العمود" 
                                  onclick="if(confirm('حذف العمود {{ col }}؟')) { 
                                    const formData = new FormData();
                                    formData.append('column', '{{ col }}');
                                    formData.append('csrf_token', getCsrfToken());
                                    fetch('/security/db-editor/delete-column/{{ selected_table }}', {
                                      method: 'POST',
                                      body: formData
                                    }).then(() => location.reload());
                                  }">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </th>
                      {% endfor %}
                      <th>إجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in data[:50] %}
                    <tr>
                      {% for col in columns %}
                      <td contenteditable="true" class="editable-cell" 
                          data-row-id="{{ row.id }}" 
                          data-column="{{ col }}">
                        {{ row.get(col, '') }}
                      </td>
                      {% endfor %}
                      <td>
                        <button class="btn btn-sm btn-danger" title="حذف"
                                onclick="if(confirm('حذف هذا السجل؟')) {
                                  fetch('/security/db-editor/delete-row/{{ selected_table }}/{{ row.id }}', {
                                    method: 'POST',
                                    headers: {
                                      'Content-Type': 'application/x-www-form-urlencoded',
                                      'X-CSRFToken': getCsrfToken()
                                    }
                                  }).then(() => location.reload());
                                }">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              {% if data|length > 50 %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> عرض أول 50 سجل من {{ data|length }} سجل
              </div>
              {% endif %}
              
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> اختر جدولاً للتحرير
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- تبويب 3: هيكل الجدول -->
        <div class="tab-pane fade {% if active_tab == 'schema' %}show active{% endif %}" 
             id="schema" 
             role="tabpanel">
          
          <div class="mb-3">
            <button class="btn btn-primary" onclick="showVisualSchema()">
              <i class="fas fa-project-diagram"></i> عرض المخطط البصري (ER Diagram)
            </button>
          </div>
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                  <strong><i class="fas fa-list"></i> الجداول</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='schema', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table and table_info %}
              <div class="card">
                <div class="card-header bg-warning text-dark">
                  <h6 class="mb-0">
                    <i class="fas fa-sitemap"></i> هيكل جدول: {{ selected_table }}
                  </h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-dark">
                        <tr>
                          <th>اسم العمود</th>
                          <th>النوع</th>
                          <th>NULL</th>
                          <th>Key</th>
                          <th>Default</th>
                          <th>Extra</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for col in table_info %}
                        <tr>
                          <td><strong>{{ col.name }}</strong></td>
                          <td><span class="badge bg-primary">{{ col.type }}</span></td>
                          <td>
                            {% if col.nullable %}
                            <span class="badge bg-success">YES</span>
                            {% else %}
                            <span class="badge bg-danger">NO</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if col.primary_key %}
                            <span class="badge bg-warning text-dark">PRI</span>
                            {% elif col.foreign_keys %}
                            <span class="badge bg-info">FOR</span>
                            {% endif %}
                          </td>
                          <td>{{ col.default or '-' }}</td>
                          <td>
                            {% if col.autoincrement %}
                            <span class="badge bg-success">auto_increment</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> اختر جدولاً لعرض هيكله
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        {% if active_tab == 'indexes' %}
        <div class="alert alert-info">
          <i class="fas fa-bolt"></i> <strong>إدارة الفهارس:</strong> 
          {{ indexes_stats.total_indexes }} فهرس على {{ indexes_stats.total_tables }} جدول
        </div>
        <div class="row">
          {% for table in indexes_data %}
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header bg-light d-flex justify-content-between">
                <strong><i class="fas fa-table"></i> {{ table.name }}</strong>
                <span class="badge bg-primary">{{ table.indexes_count }} فهرس</span>
              </div>
              <div class="card-body">
                {% if table.indexes %}
                <ul class="list-group list-group-flush">
                  {% for idx in table.indexes %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                      <i class="fas fa-key"></i> {{ idx.name }}
                      <small class="text-muted">({{ idx.columns|join(', ') }})</small>
                    </span>
                    <div>
                      {% if idx.unique %}<span class="badge bg-success me-1">UNIQUE</span>{% endif %}
                      <button class="btn btn-sm btn-outline-primary" onclick="analyzeIndex('{{ idx.name }}')">
                        <i class="fas fa-chart-line"></i> تحليل
                      </button>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">لا توجد فهارس</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        {% if active_tab == 'logs' %}
        
        <!-- Logs Filters -->
        <div data-logs-filters></div>
        <div data-logs-actions class="mb-3"></div>
        
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <a class="nav-link {% if log_type == 'audit' %}active{% endif %}" 
               href="{{ url_for('security.database_manager', tab='logs', log_type='audit') }}">
              <i class="fas fa-clipboard-check"></i> تدقيق
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if log_type == 'system' %}active{% endif %}" 
               href="{{ url_for('security.database_manager', tab='logs', log_type='system') }}">
              <i class="fas fa-server"></i> نظام
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if log_type == 'errors' %}active{% endif %}" 
               href="{{ url_for('security.database_manager', tab='logs', log_type='errors') }}">
              <i class="fas fa-exclamation-triangle"></i> أخطاء
            </a>
          </li>
        </ul>
        
        {% if log_type == 'audit' %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>المستخدم</th>
                <th>الإجراء</th>
                <th>التفاصيل</th>
                <th>التاريخ</th>
              </tr>
            </thead>
            <tbody>
              {% for log in audit_logs %}
              <tr>
                <td>{{ log.user.username if log.user else 'N/A' }}</td>
                <td>{{ log.action }}</td>
                <td><small>{{ log.details or '-' }}</small></td>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% elif log_type == 'system' %}
        <div class="card">
          <div class="card-body">
            <pre style="max-height: 600px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">{{ system_logs or 'لا توجد سجلات' }}</pre>
          </div>
        </div>
        {% elif log_type == 'errors' %}
        <div class="row">
          <div class="col-md-3">
            <div class="card text-white bg-danger">
              <div class="card-body">
                <h5>{{ error_logs|length }}</h5>
                <small>أخطاء محفوظة</small>
              </div>
            </div>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>الإجراء</th>
                <th>التفاصيل</th>
                <th>التاريخ</th>
              </tr>
            </thead>
            <tbody>
              {% for log in error_logs %}
              <tr>
                <td>{{ log.action }}</td>
                <td>{{ log.details or '-' }}</td>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        {% endif %}
        
        {% if active_tab == 'sql' %}
        <form method="POST" action="{{ url_for('security.database_manager', tab='sql') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-code"></i> <strong>SQL Console</strong></label>
            <textarea name="sql_query" class="form-control" rows="10" 
                      style="font-family: 'Courier New', monospace; background: #f8f9fa;"
                      placeholder="SELECT * FROM customers LIMIT 10;"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-play"></i> تنفيذ
          </button>
        </form>
        
        {% if sql_result %}
        <div class="alert alert-success mt-3">
          <i class="fas fa-check-circle"></i> 
          {% if sql_result.message %}
            {{ sql_result.message }}
          {% else %}
            تم الاستعلام بنجاح - {{ sql_result.count }} صف
          {% endif %}
        </div>
        {% if sql_result.columns %}
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="table-dark">
              <tr>
                {% for col in sql_result.columns %}
                <th>{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in sql_result.rows %}
              <tr>
                {% for cell in row %}
                <td>{{ cell }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        {% endif %}
        
        {% if sql_error %}
        <div class="alert alert-danger mt-3">
          <i class="fas fa-times-circle"></i> <strong>خطأ:</strong> {{ sql_error }}
        </div>
        {% endif %}
        {% endif %}
        
        {% if active_tab == 'python' %}
        <form method="POST" action="{{ url_for('security.database_manager', tab='python') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label"><i class="fab fa-python"></i> <strong>Python Console</strong></label>
            <textarea name="python_code" class="form-control" rows="10" 
                      style="font-family: 'Courier New', monospace; background: #f8f9fa;"
                      placeholder="# مثال&#10;from models import Customer&#10;customers = Customer.query.limit(5).all()&#10;output = f'عدد العملاء: {len(customers)}'"></textarea>
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-play"></i> تنفيذ
          </button>
        </form>
        
        {% if python_result %}
        <div class="alert alert-success mt-3">
          <i class="fas fa-check-circle"></i> <strong>النتيجة:</strong> {{ python_result }}
        </div>
        {% endif %}
        
        {% if python_error %}
        <div class="alert alert-danger mt-3">
          <i class="fas fa-times-circle"></i> <strong>خطأ:</strong> {{ python_error }}
        </div>
        {% endif %}
        {% endif %}
        
        {% if active_tab == 'maintenance' %}
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-header bg-warning text-white">
                <h5><i class="fas fa-broom"></i> VACUUM</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">تنظيف قاعدة البيانات وتحرير المساحة</p>
                <button class="btn btn-warning btn-lg" onclick="executeVacuum()">
                  <i class="fas fa-play"></i> تنفيذ VACUUM
                </button>
                <div id="vacuum-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h5><i class="fas fa-chart-line"></i> ANALYZE</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">تحليل الإحصائيات وتحسين الأداء</p>
                <button class="btn btn-info btn-lg" onclick="executeAnalyze()">
                  <i class="fas fa-play"></i> تنفيذ ANALYZE
                </button>
                <div id="analyze-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h5><i class="fas fa-save"></i> Backup</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">إنشاء نسخة احتياطية من قاعدة البيانات</p>
                <a href="/backup_db" class="btn btn-success btn-lg">
                  <i class="fas fa-download"></i> إنشاء نسخة
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-sync"></i> Checkpoint</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">دمج WAL files مع قاعدة البيانات الرئيسية</p>
                <button class="btn btn-dark" onclick="executeCheckpoint()">
                  <i class="fas fa-sync-alt"></i> تنفيذ Checkpoint
                </button>
                <div id="checkpoint-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-database"></i> معلومات قاعدة البيانات</h5>
              </div>
              <div class="card-body">
                <p><strong>عدد الجداول:</strong> {{ tables|length }}</p>
                <p><strong>عدد الفهارس:</strong> {% if indexes_stats %}{{ indexes_stats.total_indexes }}{% else %}N/A{% endif %}</p>
                <button class="btn btn-primary btn-sm" onclick="getDBInfo()">
                  <i class="fas fa-info-circle"></i> تفاصيل أكثر
                </button>
                <div id="db-info-result" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if active_tab == 'restore' %}
        <div class="container-fluid p-4">
          <div class="row g-3 mb-4">
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-danger text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">تحذير عالي</h6>
                      <h3 class="mb-0 fw-bold"><i class="fas fa-exclamation-triangle"></i></h3>
                      <small class="opacity-75">عملية حساسة</small>
                    </div>
                    <i class="fas fa-shield-alt fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-warning text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">صلاحية مطلوبة</h6>
                      <h3 class="mb-0 fw-bold">Super Admin</h3>
                      <small class="opacity-75">فقط</small>
                    </div>
                    <i class="fas fa-user-shield fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-info text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">أنواع الملفات</h6>
                      <h3 class="mb-0 fw-bold">.db, .sqlite</h3>
                      <small class="opacity-75">المدعومة</small>
                    </div>
                    <i class="fas fa-file-archive fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-secondary text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">نسخة احتياطية</h6>
                      <h3 class="mb-0 fw-bold">مطلوبة</h3>
                      <small class="opacity-75">قبل الاستعادة</small>
                    </div>
                    <i class="fas fa-database fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card shadow-lg border-0">
            <div class="card-header bg-danger text-white d-flex align-items-center">
              <i class="fas fa-database me-2"></i>
              <h5 class="mb-0">استعادة قاعدة البيانات</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-lg me-2"></i>
                <div><strong>تحذير:</strong> سيؤدي المتابعة إلى استبدال جميع البيانات الحالية بالملف المحدد.</div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">نسخة .db</label>
                <input type="file" class="form-control" id="restore-file" accept=".db,.sqlite,.sqlite3,application/x-sqlite3">
              </div>
              <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-danger btn-lg" onclick="restoreDatabase()">
                  <i class="fas fa-upload"></i> استعادة الآن
                </button>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-lg">
                  <i class="fas fa-times"></i> إلغاء
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <script>
        function restoreDatabase() {
          const fileInput = document.getElementById('restore-file');
          if (!fileInput.files.length) {
            alert('الرجاء اختيار ملف قاعدة بيانات');
            return;
          }
          
          if (!confirm('هل أنت متأكد؟ سيتم استبدال جميع البيانات الحالية!')) {
            return;
          }
          
          const formData = new FormData();
          formData.append('db_file', fileInput.files[0]);
          formData.append('csrf_token', '{{ csrf_token() }}');
          
          fetch('{{ url_for("main.restore_db") }}', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('تم استعادة قاعدة البيانات بنجاح!');
              window.location.reload();
            } else {
              alert('خطأ: ' + (data.message || 'فشل الاستعادة'));
            }
          })
          .catch(error => {
            alert('حدث خطأ: ' + error);
          });
        }
        </script>
        {% endif %}
        
        {% if active_tab == 'tools' %}
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h5><i class="fas fa-lock-open"></i> فك التشفير</h5>
              </div>
              <div class="card-body">
                <form method="POST" action="{{ url_for('security.database_manager', tab='tools') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="mb-3">
                    <label>النص المشفر:</label>
                    <textarea name="encrypted_data" class="form-control" rows="4"></textarea>
                  </div>
                  <div class="mb-3">
                    <label>نوع التشفير:</label>
                    <select name="decrypt_type" class="form-select">
                      <option value="auto">تلقائي</option>
                      <option value="base64">Base64</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">فك التشفير</button>
                </form>
                
                {% if decrypt_result %}
                <div class="alert alert-{{ 'success' if decrypt_result.success else 'danger' }} mt-3">
                  {% if decrypt_result.success %}
                  <strong>النتيجة:</strong> {{ decrypt_result.decrypted }}
                  {% else %}
                  <strong>خطأ:</strong> {{ decrypt_result.error }}
                  {% endif %}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-bug"></i> تتبع الأخطاء</h5>
              </div>
              <div class="card-body">
                {% if error_stats %}
                <div class="row">
                  <div class="col-6">
                    <h3>{{ error_stats.total_errors }}</h3>
                    <small>إجمالي الأخطاء</small>
                  </div>
                  <div class="col-6">
                    <h3>{{ error_stats.critical_errors }}</h3>
                    <small>أخطاء حرجة</small>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if active_tab == 'archive' %}
        <div class="container-fluid p-4">
          <div class="card border-success">
            <div class="card-header bg-success text-white">
              <i class="fas fa-archive"></i> إدارة الأرشيفات - Archived Data
            </div>
            <div class="card-body text-center">
              <a href="{{ url_for('archive.index') }}" class="btn btn-success btn-lg" target="_blank">
                <i class="fas fa-external-link-alt"></i> فتح الأرشيفات
              </a>
            </div>
          </div>
        </div>
        {% endif %}
        
      </div>
      
    </div>
  </div>

</div>

<script>
function getCsrfToken() {
  const tokenMeta = document.querySelector('meta[name="csrf-token"]');
  if (tokenMeta) return tokenMeta.getAttribute('content');
  const tokenInput = document.querySelector('input[name="csrf_token"]');
  if (tokenInput) return tokenInput.value;
  return '';
}

// تفعيل التبويب من URL
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');
  if (tab) {
    const tabButton = document.getElementById(tab + '-tab');
    if (tabButton) {
      $(tabButton).tab('show');
    }
  }
  
  // حفظ التعديلات عند تغيير الخلايا
  document.querySelectorAll('.editable-cell').forEach(cell => {
    const originalValue = cell.textContent.trim();
    cell.dataset.originalValue = originalValue;
    
    cell.addEventListener('blur', function() {
      const rowId = this.dataset.rowId;
      const column = this.dataset.column;
      const newValue = this.textContent.trim();
      
      if (newValue === this.dataset.originalValue) {
        return;
      }
      
      // حفظ التعديل
      fetch('/security/db-editor/update-cell/{{ selected_table }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
          row_id: rowId,
          column: column,
          value: newValue
        })
      }).then(response => response.json()).then(data => {
        if (data.success) {
          this.style.backgroundColor = '#d4edda';
          this.dataset.originalValue = newValue;
          setTimeout(() => {
            this.style.backgroundColor = '';
          }, 1000);
        } else {
          this.style.backgroundColor = '#f8d7da';
          alert('فشل الحفظ: ' + (data.error || 'خطأ غير معروف'));
          this.textContent = this.dataset.originalValue;
          setTimeout(() => {
            this.style.backgroundColor = '';
          }, 1000);
        }
      }).catch(err => {
        this.style.backgroundColor = '#f8d7da';
        alert('خطأ: ' + err.message);
        this.textContent = this.dataset.originalValue;
        setTimeout(() => {
          this.style.backgroundColor = '';
        }, 1000);
      });
    });
  });
});

function executeVacuum() {
  if (!confirm('تنفيذ VACUUM؟ قد يستغرق بعض الوقت.')) return;
  document.getElementById('vacuum-result').innerHTML = '<div class="spinner-border text-warning"></div>';
  fetch('/security/api/maintenance/vacuum', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('vacuum-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function executeAnalyze() {
  document.getElementById('analyze-result').innerHTML = '<div class="spinner-border text-info"></div>';
  fetch('/security/api/maintenance/analyze', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('analyze-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function executeCheckpoint() {
  document.getElementById('checkpoint-result').innerHTML = '<div class="spinner-border"></div>';
  fetch('/security/api/maintenance/checkpoint', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('checkpoint-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function getDBInfo() {
  document.getElementById('db-info-result').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
  fetch('/security/api/maintenance/db-info')
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('db-info-result');
    div.innerHTML = `<div class="mt-2"><small><strong>حجم DB:</strong> ${data.db_size || 'N/A'}</small><br><small><strong>WAL:</strong> ${data.wal_mode ? '✅' : '❌'}</small><br><small><strong>Page size:</strong> ${data.page_size || 'N/A'}</small></div>`;
  });
}
</script>

<!-- SQL Editor محسّن -->
<script src="{{ url_for('static', filename='js/sql_editor_enhanced.js') }}"></script>

{% endblock %}

