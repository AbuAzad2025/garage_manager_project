{% extends 'base.html' %}
{% block title %}Ù…Ø¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯{% endblock %}
{% block page_title %}ğŸ—„ï¸ Ù…Ø¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active"><i class="fas fa-database"></i> Database Manager</li>
{% if active_tab %}
<li class="breadcrumb-item active">{{ active_tab|title }}</li>
{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'security/_navigation.html' %}
  
  <div class="alert alert-success border-0 shadow-sm">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <i class="fas fa-database"></i>
        <strong>Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„:</strong>
        <span class="badge bg-white text-success ms-2">{{ tables|length }} Ø¬Ø¯ÙˆÙ„</span>
        {% if indexes_stats %}
        <span class="badge bg-white text-info ms-1">{{ indexes_stats.total_indexes }} ÙÙ‡Ø±Ø³</span>
        {% endif %}
      </div>
      <small class="text-muted">11 Ø£Ø¯Ø§Ø© ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</small>
    </div>
  </div>

  <div class="card shadow">
    <div class="card-header bg-gradient-primary text-white">
      <h5 class="mb-0"><i class="fas fa-terminal"></i> Database Control Center</h5>
    </div>
    
    <div class="card-body p-0">
      
      <ul class="nav nav-tabs nav-fill" id="dbTabs" role="tablist" style="border-bottom: 2px solid #dee2e6;">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'browse' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='browse') }}">
            <i class="fas fa-search"></i> ØªØµÙØ­
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'edit' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='edit') }}">
            <i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ±
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'schema' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='schema') }}">
            <i class="fas fa-sitemap"></i> Ù‡ÙŠÙƒÙ„
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'indexes' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='indexes') }}">
            <i class="fas fa-bolt"></i> ÙÙ‡Ø§Ø±Ø³
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'logs' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='logs') }}">
            <i class="fas fa-file-alt"></i> Ø³Ø¬Ù„Ø§Øª
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'sql' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='sql') }}">
            <i class="fas fa-code"></i> SQL
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'python' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='python') }}">
            <i class="fab fa-python"></i> Python
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'maintenance' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='maintenance') }}">
            <i class="fas fa-tools"></i> ØµÙŠØ§Ù†Ø©
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'restore' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='restore') }}">
            <i class="fas fa-upload"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'tools' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='tools') }}">
            <i class="fas fa-wrench"></i> Ø£Ø¯ÙˆØ§Øª
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'archive' %}active{% endif %}" 
             href="{{ url_for('security.database_manager', tab='archive') }}">
            <i class="fas fa-archive"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª
          </a>
        </li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content" id="dbTabContent">
        
        <!-- ØªØ¨ÙˆÙŠØ¨ 1: ØªØµÙØ­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ -->
        <div class="tab-pane fade {% if active_tab == 'browse' %}show active{% endif %}" 
             id="browse" 
             role="tabpanel">
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                  <strong><i class="fas fa-list"></i> Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ({{ tables|length }})</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='browse', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                      <span class="badge bg-secondary float-end">{{ table_counts.get(table, 0) }}</span>
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table %}
              <div class="card">
                <div class="card-header bg-light">
                  <h6 class="mb-0">
                    <i class="fas fa-table"></i> {{ selected_table }}
                    <span class="badge bg-info ms-2">{{ data|length }} ØµÙ</span>
                    <span class="badge bg-success ms-1">{{ columns|length }} Ø¹Ù…ÙˆØ¯</span>
                  </h6>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive" style="max-height: 600px;">
                    <table class="table table-sm table-hover mb-0">
                      <thead class="table-dark sticky-top">
                        <tr>
                          {% for col in columns %}
                          <th>{{ col }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in data %}
                        <tr>
                          {% for col in columns %}
                          <td>{{ row.get(col, '') }}</td>
                          {% endfor %}
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> Ø§Ø®ØªØ± Ø¬Ø¯ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- ØªØ¨ÙˆÙŠØ¨ 2: ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="tab-pane fade {% if active_tab == 'edit' %}show active{% endif %}" 
             id="edit" 
             role="tabpanel">
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-success">
                <div class="card-header bg-success text-white">
                  <strong><i class="fas fa-list"></i> Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='edit', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table %}
              <div class="alert alert-success">
                <i class="fas fa-edit"></i> <strong>ØªØ­Ø±ÙŠØ± Ø¬Ø¯ÙˆÙ„:</strong> {{ selected_table }}
              </div>
              
              <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
              <div class="btn-group mb-3" role="group">
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addColumnModal">
                  <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯
                </button>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addRowModal">
                  <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ
                </button>
                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#renameTableModal">
                  <i class="fas fa-i-cursor"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©
                </button>
              </div>
              
              <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead class="table-dark">
                    <tr>
                      {% for col in columns %}
                      <th>
                        {{ col }}
                        <div class="btn-group btn-group-sm float-end">
                          <button class="btn btn-sm btn-warning" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-sm btn-danger" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯" 
                                  onclick="if(confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ {{ col }}ØŸ')) { 
                                    const formData = new FormData();
                                    formData.append('column', '{{ col }}');
                                    formData.append('csrf_token', getCsrfToken());
                                    fetch('/security/db-editor/delete-column/{{ selected_table }}', {
                                      method: 'POST',
                                      body: formData
                                    }).then(() => location.reload());
                                  }">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </th>
                      {% endfor %}
                      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in data[:50] %}
                    <tr>
                      {% for col in columns %}
                      <td contenteditable="true" class="editable-cell" 
                          data-row-id="{{ row.id }}" 
                          data-column="{{ col }}">
                        {{ row.get(col, '') }}
                      </td>
                      {% endfor %}
                      <td>
                        <button class="btn btn-sm btn-danger" title="Ø­Ø°Ù"
                                onclick="if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                                  fetch('/security/db-editor/delete-row/{{ selected_table }}/{{ row.id }}', {
                                    method: 'POST',
                                    headers: {
                                      'Content-Type': 'application/x-www-form-urlencoded',
                                      'X-CSRFToken': getCsrfToken()
                                    }
                                  }).then(() => location.reload());
                                }">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              {% if data|length > 50 %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 50 Ø³Ø¬Ù„ Ù…Ù† {{ data|length }} Ø³Ø¬Ù„
              </div>
              {% endif %}
              
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> Ø§Ø®ØªØ± Ø¬Ø¯ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ­Ø±ÙŠØ±
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- ØªØ¨ÙˆÙŠØ¨ 3: Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <div class="tab-pane fade {% if active_tab == 'schema' %}show active{% endif %}" 
             id="schema" 
             role="tabpanel">
          
          <div class="mb-3">
            <button class="btn btn-primary" onclick="showVisualSchema()">
              <i class="fas fa-project-diagram"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ØµØ±ÙŠ (ER Diagram)
            </button>
          </div>
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                  <strong><i class="fas fa-list"></i> Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='schema', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table and table_info %}
              <div class="card">
                <div class="card-header bg-warning text-dark">
                  <h6 class="mb-0">
                    <i class="fas fa-sitemap"></i> Ù‡ÙŠÙƒÙ„ Ø¬Ø¯ÙˆÙ„: {{ selected_table }}
                  </h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-dark">
                        <tr>
                          <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</th>
                          <th>Ø§Ù„Ù†ÙˆØ¹</th>
                          <th>NULL</th>
                          <th>Key</th>
                          <th>Default</th>
                          <th>Extra</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for col in table_info %}
                        <tr>
                          <td><strong>{{ col.name }}</strong></td>
                          <td><span class="badge bg-primary">{{ col.type }}</span></td>
                          <td>
                            {% if col.nullable %}
                            <span class="badge bg-success">YES</span>
                            {% else %}
                            <span class="badge bg-danger">NO</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if col.primary_key %}
                            <span class="badge bg-warning text-dark">PRI</span>
                            {% elif col.foreign_keys %}
                            <span class="badge bg-info">FOR</span>
                            {% endif %}
                          </td>
                          <td>{{ col.default or '-' }}</td>
                          <td>
                            {% if col.autoincrement %}
                            <span class="badge bg-success">auto_increment</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> Ø§Ø®ØªØ± Ø¬Ø¯ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ù‡ÙŠÙƒÙ„Ù‡
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        {% if active_tab == 'indexes' %}
        <div class="alert alert-info">
          <i class="fas fa-bolt"></i> <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ‡Ø§Ø±Ø³:</strong> 
          {{ indexes_stats.total_indexes }} ÙÙ‡Ø±Ø³ Ø¹Ù„Ù‰ {{ indexes_stats.total_tables }} Ø¬Ø¯ÙˆÙ„
        </div>
        <div class="row">
          {% for table in indexes_data %}
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header bg-light d-flex justify-content-between">
                <strong><i class="fas fa-table"></i> {{ table.name }}</strong>
                <span class="badge bg-primary">{{ table.indexes_count }} ÙÙ‡Ø±Ø³</span>
              </div>
              <div class="card-body">
                {% if table.indexes %}
                <ul class="list-group list-group-flush">
                  {% for idx in table.indexes %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                      <i class="fas fa-key"></i> {{ idx.name }}
                      <small class="text-muted">({{ idx.columns|join(', ') }})</small>
                    </span>
                    <div>
                      {% if idx.unique %}<span class="badge bg-success me-1">UNIQUE</span>{% endif %}
                      <button class="btn btn-sm btn-outline-primary" onclick="analyzeIndex('{{ idx.name }}')">
                        <i class="fas fa-chart-line"></i> ØªØ­Ù„ÙŠÙ„
                      </button>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ‡Ø§Ø±Ø³</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        {% if active_tab == 'logs' %}
        
        <!-- Logs Filters -->
        <div data-logs-filters></div>
        <div data-logs-actions class="mb-3"></div>
        
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <a class="nav-link {% if log_type == 'audit' %}active{% endif %}" 
               href="{{ url_for('security.database_manager', tab='logs', log_type='audit') }}">
              <i class="fas fa-clipboard-check"></i> ØªØ¯Ù‚ÙŠÙ‚
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if log_type == 'system' %}active{% endif %}" 
               href="{{ url_for('security.database_manager', tab='logs', log_type='system') }}">
              <i class="fas fa-server"></i> Ù†Ø¸Ø§Ù…
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if log_type == 'errors' %}active{% endif %}" 
               href="{{ url_for('security.database_manager', tab='logs', log_type='errors') }}">
              <i class="fas fa-exclamation-triangle"></i> Ø£Ø®Ø·Ø§Ø¡
            </a>
          </li>
        </ul>
        
        {% if log_type == 'audit' %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              </tr>
            </thead>
            <tbody>
              {% for log in audit_logs %}
              <tr>
                <td>{{ log.user.username if log.user else 'N/A' }}</td>
                <td>{{ log.action }}</td>
                <td><small>{{ log.details or '-' }}</small></td>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% elif log_type == 'system' %}
        <div class="card">
          <div class="card-body">
            <pre style="max-height: 600px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">{{ system_logs or 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª' }}</pre>
          </div>
        </div>
        {% elif log_type == 'errors' %}
        <div class="row">
          <div class="col-md-3">
            <div class="card text-white bg-danger">
              <div class="card-body">
                <h5>{{ error_logs|length }}</h5>
                <small>Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­ÙÙˆØ¸Ø©</small>
              </div>
            </div>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              </tr>
            </thead>
            <tbody>
              {% for log in error_logs %}
              <tr>
                <td>{{ log.action }}</td>
                <td>{{ log.details or '-' }}</td>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        {% endif %}
        
        {% if active_tab == 'sql' %}
        <form method="POST" action="{{ url_for('security.database_manager', tab='sql') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-code"></i> <strong>SQL Console</strong></label>
            <textarea name="sql_query" class="form-control" rows="10" 
                      style="font-family: 'Courier New', monospace; background: #f8f9fa;"
                      placeholder="SELECT * FROM customers LIMIT 10;"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-play"></i> ØªÙ†ÙÙŠØ°
          </button>
        </form>
        
        {% if sql_result %}
        <div class="alert alert-success mt-3">
          <i class="fas fa-check-circle"></i> 
          {% if sql_result.message %}
            {{ sql_result.message }}
          {% else %}
            ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ - {{ sql_result.count }} ØµÙ
          {% endif %}
        </div>
        {% if sql_result.columns %}
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="table-dark">
              <tr>
                {% for col in sql_result.columns %}
                <th>{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in sql_result.rows %}
              <tr>
                {% for cell in row %}
                <td>{{ cell }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        {% endif %}
        
        {% if sql_error %}
        <div class="alert alert-danger mt-3">
          <i class="fas fa-times-circle"></i> <strong>Ø®Ø·Ø£:</strong> {{ sql_error }}
        </div>
        {% endif %}
        {% endif %}
        
        {% if active_tab == 'python' %}
        <form method="POST" action="{{ url_for('security.database_manager', tab='python') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label"><i class="fab fa-python"></i> <strong>Python Console</strong></label>
            <textarea name="python_code" class="form-control" rows="10" 
                      style="font-family: 'Courier New', monospace; background: #f8f9fa;"
                      placeholder="# Ù…Ø«Ø§Ù„&#10;from models import Customer&#10;customers = Customer.query.limit(5).all()&#10;output = f'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: {len(customers)}'"></textarea>
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-play"></i> ØªÙ†ÙÙŠØ°
          </button>
        </form>
        
        {% if python_result %}
        <div class="alert alert-success mt-3">
          <i class="fas fa-check-circle"></i> <strong>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> {{ python_result }}
        </div>
        {% endif %}
        
        {% if python_error %}
        <div class="alert alert-danger mt-3">
          <i class="fas fa-times-circle"></i> <strong>Ø®Ø·Ø£:</strong> {{ python_error }}
        </div>
        {% endif %}
        {% endif %}
        
        {% if active_tab == 'maintenance' %}
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-header bg-warning text-white">
                <h5><i class="fas fa-broom"></i> VACUUM</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©</p>
                <button class="btn btn-warning btn-lg" onclick="executeVacuum()">
                  <i class="fas fa-play"></i> ØªÙ†ÙÙŠØ° VACUUM
                </button>
                <div id="vacuum-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h5><i class="fas fa-chart-line"></i> ANALYZE</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡</p>
                <button class="btn btn-info btn-lg" onclick="executeAnalyze()">
                  <i class="fas fa-play"></i> ØªÙ†ÙÙŠØ° ANALYZE
                </button>
                <div id="analyze-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h5><i class="fas fa-save"></i> Backup</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                <a href="/backup_db" class="btn btn-success btn-lg">
                  <i class="fas fa-download"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø©
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-sync"></i> Checkpoint</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">Ø¯Ù…Ø¬ WAL files Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
                <button class="btn btn-dark" onclick="executeCheckpoint()">
                  <i class="fas fa-sync-alt"></i> ØªÙ†ÙÙŠØ° Checkpoint
                </button>
                <div id="checkpoint-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-database"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
              </div>
              <div class="card-body">
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„:</strong> {{ tables|length }}</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ‡Ø§Ø±Ø³:</strong> {% if indexes_stats %}{{ indexes_stats.total_indexes }}{% else %}N/A{% endif %}</p>
                <button class="btn btn-primary btn-sm" onclick="getDBInfo()">
                  <i class="fas fa-info-circle"></i> ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±
                </button>
                <div id="db-info-result" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if active_tab == 'restore' %}
        <div class="container-fluid p-4">
          <div class="row g-3 mb-4">
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-danger text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">ØªØ­Ø°ÙŠØ± Ø¹Ø§Ù„ÙŠ</h6>
                      <h3 class="mb-0 fw-bold"><i class="fas fa-exclamation-triangle"></i></h3>
                      <small class="opacity-75">Ø¹Ù…Ù„ÙŠØ© Ø­Ø³Ø§Ø³Ø©</small>
                    </div>
                    <i class="fas fa-shield-alt fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-warning text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©</h6>
                      <h3 class="mb-0 fw-bold">Super Admin</h3>
                      <small class="opacity-75">ÙÙ‚Ø·</small>
                    </div>
                    <i class="fas fa-user-shield fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-info text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª</h6>
                      <h3 class="mb-0 fw-bold">.db, .sqlite</h3>
                      <small class="opacity-75">Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©</small>
                    </div>
                    <i class="fas fa-file-archive fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-secondary text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h6>
                      <h3 class="mb-0 fw-bold">Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
                      <small class="opacity-75">Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</small>
                    </div>
                    <i class="fas fa-database fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card shadow-lg border-0">
            <div class="card-header bg-danger text-white d-flex align-items-center">
              <i class="fas fa-database me-2"></i>
              <h5 class="mb-0">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-lg me-2"></i>
                <div><strong>ØªØ­Ø°ÙŠØ±:</strong> Ø³ÙŠØ¤Ø¯ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯.</div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Ù†Ø³Ø®Ø© .db</label>
                <input type="file" class="form-control" id="restore-file" accept=".db,.sqlite,.sqlite3,application/x-sqlite3">
              </div>
              <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-danger btn-lg" onclick="restoreDatabase()">
                  <i class="fas fa-upload"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¢Ù†
                </button>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-lg">
                  <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <script>
        function restoreDatabase() {
          const fileInput = document.getElementById('restore-file');
          if (!fileInput.files.length) {
            alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª');
            return;
          }
          
          if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©!')) {
            return;
          }
          
          const formData = new FormData();
          formData.append('db_file', fileInput.files[0]);
          formData.append('csrf_token', '{{ csrf_token() }}');
          
          fetch('{{ url_for("main.restore_db") }}', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
              window.location.reload();
            } else {
              alert('Ø®Ø·Ø£: ' + (data.message || 'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'));
            }
          })
          .catch(error => {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error);
          });
        }
        </script>
        {% endif %}
        
        {% if active_tab == 'tools' %}
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h5><i class="fas fa-lock-open"></i> ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±</h5>
              </div>
              <div class="card-body">
                <form method="POST" action="{{ url_for('security.database_manager', tab='tools') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="mb-3">
                    <label>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø´ÙØ±:</label>
                    <textarea name="encrypted_data" class="form-control" rows="4"></textarea>
                  </div>
                  <div class="mb-3">
                    <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ´ÙÙŠØ±:</label>
                    <select name="decrypt_type" class="form-select">
                      <option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                      <option value="base64">Base64</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±</button>
                </form>
                
                {% if decrypt_result %}
                <div class="alert alert-{{ 'success' if decrypt_result.success else 'danger' }} mt-3">
                  {% if decrypt_result.success %}
                  <strong>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> {{ decrypt_result.decrypted }}
                  {% else %}
                  <strong>Ø®Ø·Ø£:</strong> {{ decrypt_result.error }}
                  {% endif %}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-bug"></i> ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h5>
              </div>
              <div class="card-body">
                {% if error_stats %}
                <div class="row">
                  <div class="col-6">
                    <h3>{{ error_stats.total_errors }}</h3>
                    <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</small>
                  </div>
                  <div class="col-6">
                    <h3>{{ error_stats.critical_errors }}</h3>
                    <small>Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø©</small>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if active_tab == 'archive' %}
        <div class="container-fluid p-4">
          <div class="card border-success">
            <div class="card-header bg-success text-white">
              <i class="fas fa-archive"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª - Archived Data
            </div>
            <div class="card-body text-center">
              <a href="{{ url_for('archive.index') }}" class="btn btn-success btn-lg" target="_blank">
                <i class="fas fa-external-link-alt"></i> ÙØªØ­ Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª
              </a>
            </div>
          </div>
        </div>
        {% endif %}
        
      </div>
      
    </div>
  </div>

</div>

<script>
function getCsrfToken() {
  const tokenMeta = document.querySelector('meta[name="csrf-token"]');
  if (tokenMeta) return tokenMeta.getAttribute('content');
  const tokenInput = document.querySelector('input[name="csrf_token"]');
  if (tokenInput) return tokenInput.value;
  return '';
}

// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù…Ù† URL
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');
  if (tab) {
    const tabButton = document.getElementById(tab + '-tab');
    if (tabButton) {
      $(tabButton).tab('show');
    }
  }
  
  // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„Ø§ÙŠØ§
  document.querySelectorAll('.editable-cell').forEach(cell => {
    const originalValue = cell.textContent.trim();
    cell.dataset.originalValue = originalValue;
    
    cell.addEventListener('blur', function() {
      const rowId = this.dataset.rowId;
      const column = this.dataset.column;
      const newValue = this.textContent.trim();
      
      if (newValue === this.dataset.originalValue) {
        return;
      }
      
      // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      fetch('/security/db-editor/update-cell/{{ selected_table }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
          row_id: rowId,
          column: column,
          value: newValue
        })
      }).then(response => response.json()).then(data => {
        if (data.success) {
          this.style.backgroundColor = '#d4edda';
          this.dataset.originalValue = newValue;
          setTimeout(() => {
            this.style.backgroundColor = '';
          }, 1000);
        } else {
          this.style.backgroundColor = '#f8d7da';
          alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
          this.textContent = this.dataset.originalValue;
          setTimeout(() => {
            this.style.backgroundColor = '';
          }, 1000);
        }
      }).catch(err => {
        this.style.backgroundColor = '#f8d7da';
        alert('Ø®Ø·Ø£: ' + err.message);
        this.textContent = this.dataset.originalValue;
        setTimeout(() => {
          this.style.backgroundColor = '';
        }, 1000);
      });
    });
  });
});

function executeVacuum() {
  if (!confirm('ØªÙ†ÙÙŠØ° VACUUMØŸ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.')) return;
  document.getElementById('vacuum-result').innerHTML = '<div class="spinner-border text-warning"></div>';
  fetch('/security/api/maintenance/vacuum', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('vacuum-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function executeAnalyze() {
  document.getElementById('analyze-result').innerHTML = '<div class="spinner-border text-info"></div>';
  fetch('/security/api/maintenance/analyze', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('analyze-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function executeCheckpoint() {
  document.getElementById('checkpoint-result').innerHTML = '<div class="spinner-border"></div>';
  fetch('/security/api/maintenance/checkpoint', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('checkpoint-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function getDBInfo() {
  document.getElementById('db-info-result').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
  fetch('/security/api/maintenance/db-info')
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('db-info-result');
    div.innerHTML = `<div class="mt-2"><small><strong>Ø­Ø¬Ù… DB:</strong> ${data.db_size || 'N/A'}</small><br><small><strong>WAL:</strong> ${data.wal_mode ? 'âœ…' : 'âŒ'}</small><br><small><strong>Page size:</strong> ${data.page_size || 'N/A'}</small></div>`;
  });
}
</script>

<!-- SQL Editor Ù…Ø­Ø³Ù‘Ù† -->
<script src="{{ url_for('static', filename='js/sql_editor_enhanced.js') }}"></script>

{% endblock %}

