{% extends 'security/base_security.html' %}

{% block tour_name %}database_manager{% endblock %}

{% block security_title %}Database Control Center{% endblock %}
{% block security_icon %}<i class="fas fa-database"></i>{% endblock %}
{% block security_description %}مركز التحكم الشامل بقاعدة البيانات - 11 أداة في مكان واحد{% endblock %}

{% block security_breadcrumb %}
<li class="breadcrumb-item active">Database Manager</li>
{% if active_tab %}
<li class="breadcrumb-item active">{{ active_tab|title }}</li>
{% endif %}
{% endblock %}

{% block security_actions %}
<div class="d-flex gap-2">
  <span class="badge bg-success fs-6">{{ tables|length }} جدول</span>
  {% if indexes_stats %}
  <span class="badge bg-info fs-6">{{ indexes_stats.total_indexes }} فهرس</span>
  {% endif %}
</div>
{% endblock %}

{% block security_content %}

  <div class="card shadow-lg border-0">
    <div class="card-body p-0">
      
      <ul class="nav nav-tabs nav-fill" id="dbTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'browse' %}active{% endif %}" 
             id="tab-trigger-browse"
             data-tab="browse"
             data-toggle="tab"
             href="#browse"
             role="tab"
             aria-controls="browse"
             aria-selected="{% if active_tab == 'browse' %}true{% else %}false{% endif %}"
             title="تصفح جميع الجداول والبيانات">
            تصفح
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'edit' %}active{% endif %}" 
             id="tab-trigger-edit"
             data-tab="edit"
             data-toggle="tab"
             href="#edit"
             role="tab"
             aria-controls="edit"
             aria-selected="{% if active_tab == 'edit' %}true{% else %}false{% endif %}"
             title="تحرير البيانات مباشرة">
            تحرير
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'schema' %}active{% endif %}" 
             id="tab-trigger-schema"
             data-tab="schema"
             data-toggle="tab"
             href="#schema"
             role="tab"
             aria-controls="schema"
             aria-selected="{% if active_tab == 'schema' %}true{% else %}false{% endif %}"
             title="عرض هيكل قاعدة البيانات والعلاقات">
            هيكل
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'indexes' %}active{% endif %}" 
             id="tab-trigger-indexes"
             data-tab="indexes"
             data-toggle="tab"
             href="#indexes"
             role="tab"
             aria-controls="indexes"
             aria-selected="{% if active_tab == 'indexes' %}true{% else %}false{% endif %}"
             title="إدارة الفهارس لتسريع الأداء">
            فهارس
            {% if indexes_stats and indexes_stats.total_indexes %}
            <span data-tab-count="indexes" data-count="{{ indexes_stats.total_indexes }}"></span>
            {% endif %}
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'logs' %}active{% endif %}" 
             id="tab-trigger-logs"
             data-tab="logs"
             data-toggle="tab"
             href="#logs"
             role="tab"
             aria-controls="logs"
             aria-selected="{% if active_tab == 'logs' %}true{% else %}false{% endif %}"
             title="عرض سجلات النظام والأخطاء">
            سجلات
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'sql' %}active{% endif %}" 
             id="tab-trigger-sql"
             data-tab="sql"
             data-toggle="tab"
             href="#sql"
             role="tab"
             aria-controls="sql"
             aria-selected="{% if active_tab == 'sql' %}true{% else %}false{% endif %}"
             title="محرر SQL احترافي مع Autocomplete">
            SQL
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'python' %}active{% endif %}" 
             id="tab-trigger-python"
             data-tab="python"
             data-toggle="tab"
             href="#python"
             role="tab"
             aria-controls="python"
             aria-selected="{% if active_tab == 'python' %}true{% else %}false{% endif %}"
             title="تنفيذ أكواد Python مباشرة">
            Python
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'maintenance' %}active{% endif %}" 
             id="tab-trigger-maintenance"
             data-tab="maintenance"
             data-toggle="tab"
             href="#maintenance"
             role="tab"
             aria-controls="maintenance"
             aria-selected="{% if active_tab == 'maintenance' %}true{% else %}false{% endif %}"
             title="صيانة وتحسين قاعدة البيانات">
            صيانة
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'restore' %}active{% endif %}" 
             id="tab-trigger-restore"
             data-tab="restore"
             data-toggle="tab"
             href="#restore"
             role="tab"
             aria-controls="restore"
             aria-selected="{% if active_tab == 'restore' %}true{% else %}false{% endif %}"
             title="استعادة النسخ الاحتياطية">
            استعادة
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'tools' %}active{% endif %}" 
             id="tab-trigger-tools"
             data-tab="tools"
             data-toggle="tab"
             href="#tools"
             role="tab"
             aria-controls="tools"
             aria-selected="{% if active_tab == 'tools' %}true{% else %}false{% endif %}"
             title="أدوات إضافية متقدمة">
            أدوات
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'archive' %}active{% endif %}" 
             id="tab-trigger-archive"
             data-tab="archive"
             data-toggle="tab"
             href="#archive"
             role="tab"
             aria-controls="archive"
             aria-selected="{% if active_tab == 'archive' %}true{% else %}false{% endif %}"
             title="الجداول المؤرشفة المحذوفة">
            أرشيفات
          </a>
        </li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content" id="dbTabContent">
        
        <!-- تبويب 1: تصفح الجداول -->
        <div class="tab-pane fade {% if active_tab == 'browse' %}show active{% endif %}" 
             id="browse" 
             role="tabpanel" aria-labelledby="tab-trigger-browse">
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                  <strong><i class="fas fa-list"></i> الجداول ({{ tables|length }})</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='browse', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                      <span class="badge bg-secondary float-end">{{ table_counts.get(table, 0) }}</span>
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table %}
              <div class="card">
                <div class="card-header bg-light">
                  <h6 class="mb-0">
                    <i class="fas fa-table"></i> {{ selected_table }}
                    <span class="badge bg-info ms-2">{{ data|length }} صف</span>
                    <span class="badge bg-success ms-1">{{ columns|length }} عمود</span>
                  </h6>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive" style="max-height: 600px;">
                    <table class="table table-sm table-hover mb-0">
                      <thead class="table-dark sticky-top">
                        <tr>
                          {% for col in columns %}
                          <th>{{ col }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in data %}
                        <tr>
                          {% for col in columns %}
                          <td>{{ row.get(col, '') }}</td>
                          {% endfor %}
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> اختر جدولاً من القائمة
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- تبويب 2: تحرير البيانات -->
        <div class="tab-pane fade {% if active_tab == 'edit' %}show active{% endif %}" 
             id="edit" 
             role="tabpanel" aria-labelledby="tab-trigger-edit">
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-success">
                <div class="card-header bg-success text-white">
                  <strong><i class="fas fa-list"></i> الجداول</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='edit', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table %}
              <div class="alert alert-success">
                <i class="fas fa-edit"></i> <strong>تحرير جدول:</strong> {{ selected_table }}
              </div>
              
              <!-- أزرار الإجراءات -->
              <div class="btn-group mb-3" role="group">
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addColumnModal">
                  <i class="fas fa-plus"></i> إضافة عمود
                </button>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addRowModal">
                  <i class="fas fa-plus-circle"></i> إضافة صف
                </button>
                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#renameTableModal">
                  <i class="fas fa-i-cursor"></i> إعادة تسمية
                </button>
              </div>
              
              <!-- جدول البيانات -->
              <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table id="db-edit-table" class="table table-bordered table-hover">
                  <thead class="table-dark sticky-top">
                    <tr>
                      <th>#</th>
                      {% for col in columns %}
                      <th>{{ col }}</th>
                      {% endfor %}
                      <th>إجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in data %}
                    <tr data-row-index="{{ loop.index0 }}">
                      <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary row-marker" data-row-index="{{ loop.index0 }}">{{ loop.index }}</button>
                      </td>
                      {% for col in columns %}
                      <td contenteditable="true" class="editable-cell" 
                          data-row-primary-key="{{ row.get(primary_key_column) or row.get('id') or row.get(columns[0]) or '' }}" 
                          data-column="{{ col }}"
                          data-table="{{ selected_table }}">
                        {{ row.get(col, '') }}
                      </td>
                      {% endfor %}
                      <td>
                        <button class="btn btn-sm btn-success save-row-btn" 
                                title="حفظ التعديلات"
                                data-row-index="{{ loop.index0 }}"
                                style="display: none;"
                                onclick="saveRow(this)">
                          <i class="fas fa-save"></i> حفظ
                        </button>
                        <button class="btn btn-sm btn-secondary cancel-row-btn" 
                                title="إلغاء التعديلات"
                                data-row-index="{{ loop.index0 }}"
                                style="display: none;"
                                onclick="cancelRowEdit(this)">
                          <i class="fas fa-times"></i> إلغاء
                        </button>
                        <button class="btn btn-sm btn-danger" title="حذف"
                                onclick="if(confirm('حذف هذا السجل؟')) {
                                  const row = this.closest('tr');
                                  const firstCell = row.querySelector('.editable-cell');
                                  const primaryKey = firstCell ? firstCell.dataset.rowPrimaryKey : '';
                                  fetch('/security/db-editor/delete-row/{{ selected_table }}/' + encodeURIComponent(primaryKey), {
                                    method: 'POST',
                                    headers: {
                                      'Content-Type': 'application/x-www-form-urlencoded',
                                      'X-CSRFToken': getCsrfToken()
                                    }
                                  }).then(() => location.reload());
                                }">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              
              
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> اختر جدولاً للتحرير
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- تبويب 3: هيكل الجدول -->
        <div class="tab-pane fade {% if active_tab == 'schema' %}show active{% endif %}" 
             id="schema" 
             role="tabpanel" aria-labelledby="tab-trigger-schema">
          
          <div class="mb-3">
            <button class="btn btn-primary" onclick="showVisualSchema()">
              <i class="fas fa-project-diagram"></i> عرض المخطط البصري (ER Diagram)
            </button>
          </div>
          
          <div class="row">
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                  <strong><i class="fas fa-list"></i> الجداول</strong>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    {% for table in tables %}
                    <a href="{{ url_for('security.database_manager', tab='schema', table=table) }}" 
                       class="list-group-item list-group-item-action {% if selected_table == table %}active{% endif %}">
                      <i class="fas fa-table"></i> {{ table }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-9">
              {% if selected_table and table_info %}
              <div class="card">
                <div class="card-header bg-warning text-dark">
                  <h6 class="mb-0">
                    <i class="fas fa-sitemap"></i> هيكل جدول: {{ selected_table }}
                  </h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-dark">
                        <tr>
                          <th>اسم العمود</th>
                          <th>النوع</th>
                          <th>NULL</th>
                          <th>Key</th>
                          <th>Default</th>
                          <th>Extra</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for col in table_info %}
                        <tr>
                          <td><strong>{{ col.name }}</strong></td>
                          <td><span class="badge bg-primary">{{ col.type }}</span></td>
                          <td>
                            {% if col.nullable %}
                            <span class="badge bg-success">YES</span>
                            {% else %}
                            <span class="badge bg-danger">NO</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if col.primary_key %}
                            <span class="badge bg-warning text-dark">PRI</span>
                            {% elif col.foreign_keys %}
                            <span class="badge bg-info">FOR</span>
                            {% endif %}
                          </td>
                          <td>{{ col.default or '-' }}</td>
                          <td>
                            {% if col.autoincrement %}
                            <span class="badge bg-success">auto_increment</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-arrow-left"></i> اختر جدولاً لعرض هيكله
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- تبويب 4: الفهارس -->
        <div class="tab-pane fade {% if active_tab == 'indexes' %}show active{% endif %}" 
             id="indexes" 
             role="tabpanel" aria-labelledby="tab-trigger-indexes">
        <div class="container-fluid p-4">
          {% if indexes_stats %}
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card border-primary">
                <div class="card-body text-center">
                  <i class="fas fa-key fa-2x text-primary mb-2"></i>
                  <h4 class="mb-0">{{ indexes_stats.total_indexes }}</h4>
                  <small class="text-muted">إجمالي الفهارس</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-success">
                <div class="card-body text-center">
                  <i class="fas fa-table fa-2x text-success mb-2"></i>
                  <h4 class="mb-0">{{ indexes_stats.total_tables }}</h4>
                  <small class="text-muted">عدد الجداول</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-info">
                <div class="card-body text-center">
                  <i class="fas fa-columns fa-2x text-info mb-2"></i>
                  <h4 class="mb-0">{{ indexes_stats.total_columns }}</h4>
                  <small class="text-muted">إجمالي الأعمدة</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-body text-center">
                  <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                  <h4 class="mb-0">{{ indexes_stats.tables_without_indexes }}</h4>
                  <small class="text-muted">جداول بدون فهارس</small>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          {% if indexes_data and indexes_data|length > 0 %}
          <div class="row">
            {% for table in indexes_data %}
            <div class="col-md-6 mb-3">
              <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <strong><i class="fas fa-table text-primary"></i> {{ table.name }}</strong>
                  <div>
                    <span class="badge bg-primary me-1">{{ table.indexes_count }} فهرس</span>
                    <span class="badge bg-info">{{ table.columns_count }} عمود</span>
                    {% if table.fk_count > 0 %}
                    <span class="badge bg-success">{{ table.fk_count }} علاقة</span>
                    {% endif %}
                  </div>
                </div>
                <div class="card-body">
                  {% if table.indexes and table.indexes|length > 0 %}
                  <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                      <thead>
                        <tr>
                          <th>اسم الفهرس</th>
                          <th>الأعمدة</th>
                          <th>النوع</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for idx in table.indexes %}
                        <tr>
                          <td>
                            {% if idx.name == 'PRIMARY KEY' %}
                            <i class="fas fa-key text-danger"></i> <strong class="text-danger">{{ idx.name }}</strong>
                            {% else %}
                            <i class="fas fa-key text-warning"></i> <strong>{{ idx.name }}</strong>
                            {% endif %}
                          </td>
                          <td>
                            {% if idx.columns %}
                            {% for col in idx.columns %}
                            <code class="me-1">{{ col }}</code>
                            {% if not loop.last %},{% endif %}
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if idx.unique %}
                            <span class="badge bg-success">UNIQUE</span>
                            {% else %}
                            <span class="badge bg-secondary">INDEX</span>
                            {% endif %}
                            {% if idx.name == 'PRIMARY KEY' %}
                            <span class="badge bg-danger ms-1">PK</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle"></i> لا توجد فهارس على هذا الجدول
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% elif indexes_data|length == 0 %}
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> <strong>تحميل البيانات...</strong>
            <p class="mb-0 mt-2">جاري تحميل معلومات الفهارس من قاعدة البيانات. إذا استمرت المشكلة، جرب تحديث الصفحة.</p>
          </div>
          {% else %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> لا توجد جداول في قاعدة البيانات لعرض فهارسها
          </div>
          {% endif %}
        </div>
        </div>
        
        <!-- تبويب 5: السجلات -->
        <div class="tab-pane fade {% if active_tab == 'logs' %}show active{% endif %}" 
             id="logs" 
             role="tabpanel" aria-labelledby="tab-trigger-logs">
        <div class="container-fluid p-4">
          <ul class="nav nav-pills mb-4" role="tablist">
            <li class="nav-item">
              <a class="nav-link log-type-tab {% if log_type == 'audit' or not log_type %}active{% endif %}" 
                 id="log-type-trigger-audit"
                 data-log-type="audit"
                 data-toggle="pill"
                 href="#log-audit"
                 role="tab" aria-controls="log-audit"
                 aria-selected="{% if log_type == 'audit' or not log_type %}true{% else %}false{% endif %}">
                <i class="fas fa-clipboard-check"></i> تدقيق
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link log-type-tab {% if log_type == 'system' %}active{% endif %}" 
                 id="log-type-trigger-system"
                 data-log-type="system"
                 data-toggle="pill"
                 href="#log-system"
                 role="tab" aria-controls="log-system"
                 aria-selected="{% if log_type == 'system' %}true{% else %}false{% endif %}">
                <i class="fas fa-server"></i> نظام
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link log-type-tab {% if log_type == 'errors' %}active{% endif %}" 
                 id="log-type-trigger-errors"
                 data-log-type="errors"
                 data-toggle="pill"
                 href="#log-errors"
                 role="tab" aria-controls="log-errors"
                 aria-selected="{% if log_type == 'errors' %}true{% else %}false{% endif %}">
                <i class="fas fa-exclamation-triangle"></i> أخطاء
              </a>
            </li>
          </ul>
          
          <div class="log-content">
            <div class="log-pane fade {% if log_type == 'audit' or not log_type %}show active{% endif %}" id="log-audit" role="tabpanel" aria-labelledby="log-type-trigger-audit">
              {% if audit_logs and audit_logs|length > 0 %}
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>المستخدم</th>
                      <th>الإجراء</th>
                      <th>التفاصيل</th>
                      <th>IP</th>
                      <th>التاريخ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for log in audit_logs %}
                    <tr>
                      <td>
                        {% if log.user %}
                        <i class="fas fa-user"></i> {{ log.user.username }}
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                      </td>
                      <td><span class="badge bg-info">{{ log.action or '-' }}</span></td>
                      <td><small>{{ log.details or log.note or '-' }}</small></td>
                      <td><code>{{ log.ip_address or '-' }}</code></td>
                      <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') if log.created_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> لا توجد سجلات تدقيق
              </div>
              {% endif %}
            </div>
            
            <div class="log-pane fade {% if log_type == 'system' %}show active{% endif %}" id="log-system" role="tabpanel" aria-labelledby="log-type-trigger-system">
              <div class="card">
                <div class="card-header bg-dark text-white">
                  <i class="fas fa-server"></i> سجلات النظام
                </div>
                <div class="card-body p-0">
                  <pre style="max-height: 600px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; margin: 0; font-family: 'Courier New', monospace; font-size: 12px;">{{ system_logs or 'لا توجد سجلات نظام' }}</pre>
                </div>
              </div>
            </div>
            
            <div class="log-pane fade {% if log_type == 'errors' %}show active{% endif %}" id="log-errors" role="tabpanel" aria-labelledby="log-type-trigger-errors">
              {% if error_logs and error_logs|length > 0 %}
              <div class="row mb-3">
                <div class="col-md-4">
                  <div class="card text-white bg-danger">
                    <div class="card-body text-center">
                      <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                      <h3>{{ error_logs|length }}</h3>
                      <small>إجمالي الأخطاء</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                      <i class="fas fa-clock fa-2x mb-2"></i>
                      <h3>{{ (error_logs|selectattr('created_at')|list|length) }}</h3>
                      <small>أخطاء موثقة</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>المستخدم</th>
                      <th>الإجراء</th>
                      <th>التفاصيل</th>
                      <th>IP</th>
                      <th>التاريخ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for log in error_logs %}
                    <tr class="table-danger">
                      <td>
                        {% if log.user %}
                        <i class="fas fa-user"></i> {{ log.user.username }}
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                      </td>
                      <td><span class="badge bg-danger">{{ log.action or '-' }}</span></td>
                      <td><small>{{ log.details or log.note or '-' }}</small></td>
                      <td><code>{{ log.ip_address or '-' }}</code></td>
                      <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') if log.created_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> لا توجد أخطاء مسجلة
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        </div>
        
        <!-- تبويب 6: SQL Console -->
        <div class="tab-pane fade {% if active_tab == 'sql' %}show active{% endif %}" 
             id="sql" 
             role="tabpanel" aria-labelledby="tab-trigger-sql">
        <form method="POST" action="{{ url_for('security.database_manager', tab='sql') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-code"></i> <strong>SQL Console</strong></label>
            <textarea name="sql_query" class="form-control" rows="10" 
                      style="font-family: 'Courier New', monospace; background: #f8f9fa;"
                      placeholder="SELECT * FROM customers LIMIT 10;"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-play"></i> تنفيذ
          </button>
        </form>
        
        {% if sql_result %}
        <div class="alert alert-success mt-3">
          <i class="fas fa-check-circle"></i> 
          {% if sql_result.message %}
            {{ sql_result.message }}
          {% else %}
            تم الاستعلام بنجاح - {{ sql_result.count }} صف
          {% endif %}
        </div>
        {% if sql_result.columns %}
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="table-dark">
              <tr>
                {% for col in sql_result.columns %}
                <th>{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in sql_result.rows %}
              <tr>
                {% for cell in row %}
                <td>{{ cell }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        
        {% if sql_error %}
        <div class="alert alert-danger mt-3">
          <i class="fas fa-times-circle"></i> <strong>خطأ:</strong> {{ sql_error }}
        </div>
        {% endif %}
        </div>
        
        <!-- تبويب 7: Python Console -->
        <div class="tab-pane fade {% if active_tab == 'python' %}show active{% endif %}" 
             id="python" 
             role="tabpanel" aria-labelledby="tab-trigger-python">
        <form method="POST" action="{{ url_for('security.database_manager', tab='python') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label"><i class="fab fa-python"></i> <strong>Python Console</strong></label>
            <textarea name="python_code" class="form-control" rows="10" 
                      style="font-family: 'Courier New', monospace; background: #f8f9fa;"
                      placeholder="# مثال&#10;from models import Customer&#10;customers = Customer.query.limit(5).all()&#10;output = f'عدد العملاء: {len(customers)}'"></textarea>
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-play"></i> تنفيذ
          </button>
        </form>
        
        {% if python_result %}
        <div class="alert alert-success mt-3">
          <i class="fas fa-check-circle"></i> <strong>النتيجة:</strong> {{ python_result }}
        </div>
        {% endif %}
        
        {% if python_error %}
        <div class="alert alert-danger mt-3">
          <i class="fas fa-times-circle"></i> <strong>خطأ:</strong> {{ python_error }}
        </div>
        {% endif %}
        {% endif %}
        </div>
        
        <!-- تبويب 8: الصيانة -->
        <div class="tab-pane fade {% if active_tab == 'maintenance' %}show active{% endif %}" 
             id="maintenance" 
             role="tabpanel" aria-labelledby="tab-trigger-maintenance">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-header bg-warning text-white">
                <h5><i class="fas fa-broom"></i> VACUUM</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">تنظيف قاعدة البيانات وتحرير المساحة</p>
                <button class="btn btn-warning btn-lg" onclick="executeVacuum()">
                  <i class="fas fa-play"></i> تنفيذ VACUUM
                </button>
                <div id="vacuum-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h5><i class="fas fa-chart-line"></i> ANALYZE</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">تحليل الإحصائيات وتحسين الأداء</p>
                <button class="btn btn-info btn-lg" onclick="executeAnalyze()">
                  <i class="fas fa-play"></i> تنفيذ ANALYZE
                </button>
                <div id="analyze-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h5><i class="fas fa-save"></i> Backup</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">إنشاء نسخة احتياطية من قاعدة البيانات</p>
                <a href="/backup_db" class="btn btn-success btn-lg">
                  <i class="fas fa-download"></i> إنشاء نسخة
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-sync"></i> Checkpoint</h5>
              </div>
              <div class="card-body text-center">
                <p class="text-muted">دمج WAL files مع قاعدة البيانات الرئيسية</p>
                <button class="btn btn-dark" onclick="executeCheckpoint()">
                  <i class="fas fa-sync-alt"></i> تنفيذ Checkpoint
                </button>
                <div id="checkpoint-result" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-database"></i> معلومات قاعدة البيانات</h5>
              </div>
              <div class="card-body">
                <p><strong>عدد الجداول:</strong> {{ tables|length }}</p>
                <p><strong>عدد الفهارس:</strong> {% if indexes_stats %}{{ indexes_stats.total_indexes }}{% else %}N/A{% endif %}</p>
                <button class="btn btn-primary btn-sm" onclick="getDBInfo()">
                  <i class="fas fa-info-circle"></i> تفاصيل أكثر
                </button>
                <div id="db-info-result" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
        </div>
        
        <!-- تبويب 9: استعادة قاعدة البيانات -->
        <div class="tab-pane fade {% if active_tab == 'restore' %}show active{% endif %}" 
             id="restore" 
             role="tabpanel" aria-labelledby="tab-trigger-restore">
        <div class="container-fluid p-4">
          <div class="row g-3 mb-4">
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-danger text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">تحذير عالي</h6>
                      <h3 class="mb-0 fw-bold"><i class="fas fa-exclamation-triangle"></i></h3>
                      <small class="opacity-75">عملية حساسة</small>
                    </div>
                    <i class="fas fa-shield-alt fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-warning text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">صلاحية مطلوبة</h6>
                      <h3 class="mb-0 fw-bold">Super Admin</h3>
                      <small class="opacity-75">فقط</small>
                    </div>
                    <i class="fas fa-user-shield fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-info text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">أنواع الملفات</h6>
                      <h3 class="mb-0 fw-bold">.db, .sqlite</h3>
                      <small class="opacity-75">المدعومة</small>
                    </div>
                    <i class="fas fa-file-archive fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <div class="card border-0 shadow-sm bg-secondary text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="text-white-50 mb-1">نسخة احتياطية</h6>
                      <h3 class="mb-0 fw-bold">مطلوبة</h3>
                      <small class="opacity-75">قبل الاستعادة</small>
                    </div>
                    <i class="fas fa-database fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card shadow-lg border-0">
            <div class="card-header bg-danger text-white d-flex align-items-center">
              <i class="fas fa-database ml-2"></i>
              <h5 class="mb-0">استعادة قاعدة البيانات</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-lg ml-2"></i>
                <div><strong>تحذير:</strong> سيؤدي المتابعة إلى استبدال جميع البيانات الحالية بالملف المحدد.</div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">نسخة .db</label>
                <input type="file" class="form-control" id="restore-file" accept=".db,.sqlite,.sqlite3,application/x-sqlite3">
              </div>
              <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-danger btn-lg" onclick="restoreDatabase()">
                  <i class="fas fa-upload"></i> استعادة الآن
                </button>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-lg">
                  <i class="fas fa-times"></i> إلغاء
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <script>
        function restoreDatabase() {
          const fileInput = document.getElementById('restore-file');
          if (!fileInput.files.length) {
            alert('الرجاء اختيار ملف قاعدة بيانات');
            return;
          }
          
          if (!confirm('هل أنت متأكد؟ سيتم استبدال جميع البيانات الحالية!')) {
            return;
          }
          
          const formData = new FormData();
          formData.append('db_file', fileInput.files[0]);
          formData.append('csrf_token', '{{ csrf_token() }}');
          
          fetch('{{ url_for("main.restore_db") }}', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('تم استعادة قاعدة البيانات بنجاح!');
              window.location.reload();
            } else {
              alert('خطأ: ' + (data.message || 'فشل الاستعادة'));
            }
          })
          .catch(error => {
            alert('حدث خطأ: ' + error);
          });
        }
        </script>
        </div>
        
        <!-- تبويب 10: الأدوات -->
        <div class="tab-pane fade {% if active_tab == 'tools' %}show active{% endif %}" 
             id="tools" 
             role="tabpanel" aria-labelledby="tab-trigger-tools">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h5><i class="fas fa-lock-open"></i> فك التشفير</h5>
              </div>
              <div class="card-body">
                <form method="POST" action="{{ url_for('security.database_manager', tab='tools') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="mb-3">
                    <label>النص المشفر:</label>
                    <textarea name="encrypted_data" class="form-control" rows="4"></textarea>
                  </div>
                  <div class="mb-3">
                    <label>نوع التشفير:</label>
                    <select name="decrypt_type" class="custom-select">
                      <option value="auto">تلقائي</option>
                      <option value="base64">Base64</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">فك التشفير</button>
                </form>
                
                {% if decrypt_result %}
                <div class="alert alert-{{ 'success' if decrypt_result.success else 'danger' }} mt-3">
                  {% if decrypt_result.success %}
                  <strong>النتيجة:</strong> {{ decrypt_result.decrypted }}
                  {% else %}
                  <strong>خطأ:</strong> {{ decrypt_result.error }}
                  {% endif %}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-bug"></i> تتبع الأخطاء</h5>
              </div>
              <div class="card-body">
                {% if error_stats %}
                <div class="row">
                  <div class="col-6">
                    <h3>{{ error_stats.total_errors }}</h3>
                    <small>إجمالي الأخطاء</small>
                  </div>
                  <div class="col-6">
                    <h3>{{ error_stats.critical_errors }}</h3>
                    <small>أخطاء حرجة</small>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        </div>
        
        <!-- تبويب 11: الأرشيفات -->
        <div class="tab-pane fade {% if active_tab == 'archive' %}show active{% endif %}" 
             id="archive" 
             role="tabpanel" aria-labelledby="tab-trigger-archive">
        <div class="container-fluid p-4">
          <div class="card border-success">
            <div class="card-header bg-success text-white">
              <i class="fas fa-archive"></i> إدارة الأرشيفات - Archived Data
            </div>
            <div class="card-body text-center">
              <a href="{{ url_for('archive.index') }}" class="btn btn-success btn-lg" target="_blank">
                <i class="fas fa-external-link-alt"></i> فتح الأرشيفات
              </a>
            </div>
          </div>
        </div>
        </div>
        
      </div>
      
    </div>
  </div>

</div>

<script>
function getCsrfToken() {
  const tokenMeta = document.querySelector('meta[name="csrf-token"]');
  if (tokenMeta) return tokenMeta.getAttribute('content');
  const tokenInput = document.querySelector('input[name="csrf_token"]');
  if (tokenInput) return tokenInput.value;
  return '';
}

// تفعيل التبويب من URL
document.addEventListener('DOMContentLoaded', function() {
  function switchTab(tabName) {
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
      if (link.dataset.tab === tabName) {
        link.classList.add('active');
      }
    });
    
    document.querySelectorAll('.tab-pane').forEach(pane => {
      pane.classList.remove('show', 'active');
      if (pane.id === tabName) {
        pane.classList.add('show', 'active');
      }
    });
  }
  
  const urlParams = new URLSearchParams(window.location.search);
  let tab = urlParams.get('tab');
  if (!tab) {
    tab = 'browse';
  }
  switchTab(tab);
  
  document.querySelectorAll('a[data-tab]').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetTab = this.dataset.tab;
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('tab', targetTab);
      if (targetTab === 'logs') {
        newUrl.searchParams.delete('log_type');
      }
      window.location.href = newUrl.toString();
    });
  });
  
  const rowChanges = new Map();
  
  document.querySelectorAll('.editable-cell').forEach(cell => {
    const originalValue = cell.textContent.trim();
    cell.dataset.originalValue = originalValue;
    
    cell.addEventListener('input', function() {
      const row = this.closest('tr');
      const rowIndex = row.dataset.rowIndex;
      const saveBtn = row.querySelector('.save-row-btn');
      const cancelBtn = row.querySelector('.cancel-row-btn');
      
      if (saveBtn) saveBtn.style.display = 'inline-block';
      if (cancelBtn) cancelBtn.style.display = 'inline-block';
      
      this.style.backgroundColor = '#fff3cd';
    });
    
    cell.addEventListener('blur', function() {
      const row = this.closest('tr');
      const rowIndex = row.dataset.rowIndex;
      const newValue = this.textContent.trim();
      
      if (newValue !== this.dataset.originalValue) {
        if (!rowChanges.has(rowIndex)) {
          rowChanges.set(rowIndex, {});
        }
        rowChanges.get(rowIndex)[this.dataset.column] = {
          oldValue: this.dataset.originalValue,
          newValue: newValue,
          cell: this
        };
      } else {
        if (rowChanges.has(rowIndex)) {
          delete rowChanges.get(rowIndex)[this.dataset.column];
          if (Object.keys(rowChanges.get(rowIndex)).length === 0) {
            rowChanges.delete(rowIndex);
            const saveBtn = row.querySelector('.save-row-btn');
            const cancelBtn = row.querySelector('.cancel-row-btn');
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
          }
        }
      }
    });
  });
  
  window.saveRow = function(btn) {
    const row = btn.closest('tr');
    const rowIndex = row.dataset.rowIndex;
    const firstCell = row.querySelector('.editable-cell');
    const rowPrimaryKey = firstCell.dataset.rowPrimaryKey;
    const table = firstCell.dataset.table;
    
    if (!rowChanges.has(rowIndex) || Object.keys(rowChanges.get(rowIndex)).length === 0) {
      alert('لا توجد تعديلات للحفظ');
      return;
    }
    
    const changes = rowChanges.get(rowIndex);
    let allSaved = true;
    let savedCount = 0;
    const totalChanges = Object.keys(changes).length;
    
    Object.entries(changes).forEach(([column, change]) => {
      fetch('/security/db-editor/update-cell/' + table, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
          row_id: rowPrimaryKey,
          column: column,
          value: change.newValue
        })
      }).then(response => response.json()).then(data => {
        savedCount++;
        if (data.success) {
          change.cell.dataset.originalValue = change.newValue;
          change.cell.style.backgroundColor = '#d4edda';
          setTimeout(() => {
            change.cell.style.backgroundColor = '';
          }, 2000);
        } else {
          allSaved = false;
          change.cell.style.backgroundColor = '#f8d7da';
        }
        
        if (savedCount === totalChanges) {
          if (allSaved) {
            rowChanges.delete(rowIndex);
            btn.style.display = 'none';
            row.querySelector('.cancel-row-btn').style.display = 'none';
            alert('تم حفظ جميع التعديلات بنجاح');
          } else {
            alert('حدث خطأ في حفظ بعض التعديلات');
          }
        }
      }).catch(err => {
        allSaved = false;
        savedCount++;
        alert('خطأ: ' + err.message);
        if (savedCount === totalChanges) {
          rowChanges.delete(rowIndex);
          btn.style.display = 'none';
          row.querySelector('.cancel-row-btn').style.display = 'none';
        }
      });
    });
  };
  
  window.cancelRowEdit = function(btn) {
    const row = btn.closest('tr');
    const rowIndex = row.dataset.rowIndex;
    
    if (rowChanges.has(rowIndex)) {
      const changes = rowChanges.get(rowIndex);
      Object.values(changes).forEach(change => {
        change.cell.textContent = change.oldValue;
        change.cell.style.backgroundColor = '';
      });
      rowChanges.delete(rowIndex);
    }
    
    btn.style.display = 'none';
    row.querySelector('.save-row-btn').style.display = 'none';
  };
  
  document.querySelectorAll('.log-type-tab').forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      const logType = this.dataset.logType;
      
      document.querySelectorAll('.log-type-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.log-pane').forEach(p => {
        p.classList.remove('show', 'active');
      });
      
      this.classList.add('active');
      const targetPane = document.getElementById('log-' + logType);
      if (targetPane) {
        targetPane.classList.add('show', 'active');
      }
      
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('tab', 'logs');
      newUrl.searchParams.set('log_type', logType);
      window.history.pushState({}, '', newUrl);
    });
  });

  // ترقيم الصفحات 10 صفوف باستخدام DataTables مع تحميل ديناميكي للمكتبة إن لزم
  function loadScriptOnce(src, id, onload) {
    if (document.getElementById(id)) { onload && onload(); return; }
    var s = document.createElement('script');
    s.src = src; s.id = id; s.async = false;
    s.onload = function(){ onload && onload(); };
    document.body.appendChild(s);
  }
  function ensureDataTables(onready) {
    if (window.jQuery && $.fn && $.fn.DataTable) { onready && onready(); return; }
    if (window.jQuery && !($.fn && $.fn.DataTable)) {
      loadScriptOnce('{{ url_for('static', filename='adminlte/plugins/datatables/jquery.dataTables.min.js') }}', 'dt-core', onready);
    } else {
      window.addEventListener('load', function(){
        if (window.jQuery && $.fn && $.fn.DataTable) { onready && onready(); }
        else {
          loadScriptOnce('{{ url_for('static', filename='adminlte/plugins/datatables/jquery.dataTables.min.js') }}', 'dt-core', onready);
        }
      });
    }
  }
  ensureDataTables(function(){
    const $tbl = $('#db-edit-table');
    if ($tbl.length) {
      try {
        $tbl.DataTable({
          pageLength: 15,
          paging: true,
          lengthChange: true,
          ordering: false,
          info: true,
          searching: true,
          autoWidth: false,
          scrollX: true,
          pagingType: 'simple_numbers',
          lengthMenu: [[15, 25, 50, -1], [15, 25, 50, 'الكل']],
          dom: "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
               "<'row'<'col-sm-12'tr>>" +
               "<'row'<'col-sm-6'i><'col-sm-6'p>>",
          language: { url: "{{ url_for('static', filename='datatables/Arabic.json') }}" }
        });
      } catch (e) {
        console.warn('DataTables init failed:', e);
      }
    }
  });
  
  document.querySelectorAll('.row-marker').forEach(btn => {
    btn.addEventListener('click', function(){
      document.querySelectorAll('#db-edit-table tbody tr').forEach(r => r.classList.remove('table-warning'));
      const row = this.closest('tr');
      if (row) { row.classList.add('table-warning'); }
    });
  });

  const logContentStyle = document.createElement('style');
  logContentStyle.textContent = `
    .log-pane {
      display: none;
    }
    .log-pane.show {
      display: block;
    }
  `;
  document.head.appendChild(logContentStyle);
});

function executeVacuum() {
  if (!confirm('تنفيذ VACUUM؟ قد يستغرق بعض الوقت.')) return;
  document.getElementById('vacuum-result').innerHTML = '<div class="spinner-border text-warning"></div>';
  fetch('/security/api/maintenance/vacuum', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('vacuum-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function executeAnalyze() {
  document.getElementById('analyze-result').innerHTML = '<div class="spinner-border text-info"></div>';
  fetch('/security/api/maintenance/analyze', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('analyze-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function executeCheckpoint() {
  document.getElementById('checkpoint-result').innerHTML = '<div class="spinner-border"></div>';
  fetch('/security/api/maintenance/checkpoint', {
    method: 'POST',
    headers: {'X-CSRFToken': getCsrfToken()}
  })
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('checkpoint-result');
    div.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}"><i class="fas fa-${data.success ? 'check' : 'times'}"></i> ${data.message}</div>`;
  });
}

function getDBInfo() {
  document.getElementById('db-info-result').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
  fetch('/security/api/maintenance/db-info')
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById('db-info-result');
    div.innerHTML = `<div class="mt-2"><small><strong>حجم DB:</strong> ${data.db_size || 'N/A'}</small><br><small><strong>WAL:</strong> ${data.wal_mode ? '✅' : '❌'}</small><br><small><strong>Page size:</strong> ${data.page_size || 'N/A'}</small></div>`;
  });
}
</script>

<!-- SQL Editor محسّن -->
<script src="{{ url_for('static', filename='js/sql_editor_enhanced.js') }}"></script>

{% endblock %}

