{% extends 'security/base_security.html' %}
{% block tour_name %}ledger_control{% endblock %}
{% block security_title %}Ledger Control{% endblock %}
{% block security_icon %}<i class="fas fa-book"></i>{% endblock %}
{% block security_description %}Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯{% endblock %}
{% block security_breadcrumb %}<li class="breadcrumb-item active">Ledger Control</li>{% endblock %}
{% block security_content %}
    <div class="card shadow-lg border-0">
        <div class="card-body p-0">
        
        <div class="card-body p-0">
            <ul class="nav nav-pills nav-fill border-bottom" id="controlTabs" style="background: #f8f9fa;">
                        <li class="nav-item">
                            <a class="nav-link active" href="#tab-accounts">
                                <i class="fas fa-list ml-1"></i>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-entries">
                                <i class="fas fa-file ml-1"></i>Ø§Ù„Ù‚ÙŠÙˆØ¯
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-batches">
                                <i class="fas fa-edit ml-1"></i>ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙˆØ¯
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-operations">
                                <i class="fas fa-cogs ml-1"></i>Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ…
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-editor">
                                <i class="fas fa-edit ml-1"></i>Ù…Ø­Ø±Ø± Ø§Ù„Ù‚ÙŠÙˆØ¯
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-tools">
                                <i class="fas fa-tools ml-1"></i>Ø§Ù„Ø£Ø¯ÙˆØ§Øª
                            </a>
                        </li>
            </ul>
            
            <div class="p-3">
                        <!-- Tab 1: Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
                        <div id="tab-accounts" style="display: block;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© <span class="badge bg-primary" id="accountsCount">0</span></h5>
                                <div>
                                    <button class="btn btn-info ml-2" onclick="showAccountsTree()">
                                        <i class="fas fa-sitemap"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¬Ø±Ø©
                                    </button>
                                    <button class="btn btn-success" onclick="showAddAccountModal()">
                                        <i class="fas fa-plus ml-1"></i>Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                                    </button>
                                </div>
                            </div>
                            <div style="height: 600px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 5px; padding: 10px; background: white;">
                                <table class="table table-striped table-hover table-bordered" id="accountsTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th style="width: 12%;">Ø§Ù„ÙƒÙˆØ¯</th>
                                            <th style="width: 30%;">Ø§Ù„Ø§Ø³Ù…</th>
                                            <th style="width: 18%;">Ø§Ù„Ù†ÙˆØ¹</th>
                                            <th style="width: 12%;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th style="width: 28%;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody style="background: white;"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab 2: Ø§Ù„Ù‚ÙŠÙˆØ¯ -->
                        <div id="tab-entries" style="display: none;">
                            <h5 class="mb-3">Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© <span class="badge bg-success" id="entriesCount">0</span></h5>
                            <div style="height: 600px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 5px; padding: 10px; background: white;">
                                <table class="table table-striped table-hover table-bordered" id="entriesTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                            <th>Ø§Ù„ÙˆØµÙ</th>
                                            <th>Ø§Ù„Ù‚ÙŠÙˆØ¯</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody style="background: white;"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab 3: ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙˆØ¯ -->
                        <div id="tab-batches" style="display: none;">
                            <h5 class="mb-3">ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙˆØ¯ <span class="badge bg-warning" id="batchesCount">0</span></h5>
                            <div style="height: 600px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 5px; padding: 10px; background: white;">
                                <table class="table table-striped table-hover table-bordered" id="batchesTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                                            <th>Ù…Ø¯ÙŠÙ†</th>
                                            <th>Ø¯Ø§Ø¦Ù†</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody style="background: white;"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab 4: Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… -->
                        <div id="tab-operations" style="display: none;">
                            <h5 class="mb-3"><i class="fas fa-cogs ml-2"></i>Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h5>
                            
                            <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© -->
                            <ul class="nav nav-tabs mb-3" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active" data-toggle="tab" data-target="#ops-periods">
                                        <i class="fas fa-calendar-alt"></i> Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-toggle="tab" data-target="#ops-closing">
                                        <i class="fas fa-lock"></i> Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-toggle="tab" data-target="#ops-approval">
                                        <i class="fas fa-check-circle"></i> Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-toggle="tab" data-target="#ops-reverse">
                                        <i class="fas fa-undo"></i> Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¹ÙƒØ³ÙŠØ©
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <!-- Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© -->
                                <div class="tab-pane fade show active" id="ops-periods">
                                    <div id="fiscal-periods-list">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary"></div>
                                            <p class="mt-2">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØªØ±Ø§Øª...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ -->
                                <div class="tab-pane fade" id="ops-closing">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„:</strong> ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¥Ù‚ÙØ§Ù„ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©:</label>
                                                    <input type="date" id="closing-date" class="form-control">
                                                </div>
                                                <div class="col-md-6">
                                                    <label>&nbsp;</label>
                                                    <button class="btn btn-primary d-block w-100" onclick="generateClosingEntries()">
                                                        <i class="fas fa-calculator"></i> Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="closing-results" style="display:none;" class="mt-3"></div>
                                </div>
                                
                                <!-- Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª -->
                                <div class="tab-pane fade" id="ops-approval">
                                    <h6>Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h6>
                                    <div id="pending-batches-list">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary"></div>
                                            <p class="mt-2">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¹ÙƒØ³ÙŠØ© -->
                                <div class="tab-pane fade" id="ops-reverse">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="fas fa-undo"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ø¹ÙƒØ³ÙŠ</h6>
                                            <p>Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ØŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹ÙƒØ³Ù‡:</p>
                                            <div class="input-group">
                                                <input type="number" id="reverse-batch-id" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯">
                                                <button class="btn btn-warning" onclick="reverseBatch()">
                                                    <i class="fas fa-undo"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ø¹ÙƒØ³ÙŠ
                                                </button>
                                            </div>
                                            <div id="reverse-result" class="mt-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 5: Ù…Ø­Ø±Ø± Ø§Ù„Ù‚ÙŠÙˆØ¯ -->
                        <div id="tab-editor" style="display: none;">
                            <h5 class="mb-3"><i class="fas fa-edit ml-2"></i>Ù…Ø­Ø±Ø± Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h5>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ -->
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Ø§Ø®ØªØ± Ù‚ÙŠØ¯Ø§Ù‹ Ù„Ù„ØªØ­Ø±ÙŠØ±</h6>
                                        </div>
                                        <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
                                            <input type="text" id="batch-search" class="form-control mb-2" placeholder="Ø¨Ø­Ø«...">
                                            <div id="batches-list-editor">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border spinner-border-sm"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ­Ø±ÙŠØ± -->
                                    <div id="editor-form" style="display:none;">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <h6 class="mb-0">ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠØ¯: <span id="edit-batch-code"></span></h6>
                                            </div>
                                            <div class="card-body">
                                                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© -->
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label>Ø§Ù„ØºØ±Ø¶:</label>
                                                        <input type="text" id="edit-purpose" class="form-control">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                                                        <input type="datetime-local" id="edit-posted-at" class="form-control">
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                                                    <textarea id="edit-memo" class="form-control" rows="2"></textarea>
                                                </div>
                                                
                                                <!-- Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø© -->
                                                <div class="card mb-3 border-warning">
                                                    <div class="card-header bg-warning">
                                                        <h6 class="mb-0">ğŸ”— Ø±Ø¨Ø· Ø§Ù„Ù‚ÙŠØ¯ Ø¨Ø¬Ù‡Ø©</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©:</label>
                                                                <select id="edit-entity-type" class="form-control" onchange="loadEntityOptions()">
                                                                    <option value="">-- Ø§Ø®ØªØ± --</option>
                                                                    <option value="CUSTOMER">Ø¹Ù…ÙŠÙ„</option>
                                                                    <option value="SUPPLIER">Ù…ÙˆØ±Ø¯</option>
                                                                    <option value="PARTNER">Ø´Ø±ÙŠÙƒ</option>
                                                                    <option value="EMPLOYEE">Ù…ÙˆØ¸Ù</option>
                                                                    <option value="BRANCH">ÙØ±Ø¹</option>
                                                                    <option value="USER">Ù…Ø³ØªØ®Ø¯Ù…</option>
                                                                    <option value="OTHER">Ø£Ø®Ø±Ù‰</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label>Ø§Ù„Ø¬Ù‡Ø©:</label>
                                                                <input type="text" id="entity-search" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø©..." oninput="searchEntity()">
                                                                <div id="entity-results" class="list-group mt-1" style="max-height: 200px; overflow-y: auto; display:none;"></div>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>&nbsp;</label>
                                                                <button class="btn btn-warning d-block w-100" onclick="linkCurrentEntity()">
                                                                    <i class="fas fa-link"></i> Ø±Ø¨Ø·
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div id="current-entity-display" class="mt-2"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Ø§Ù„Ø³Ø·ÙˆØ± -->
                                                <h6>Ø§Ù„Ø³Ø·ÙˆØ± Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©:</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered">
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                                                <th>Ù…Ø¯ÙŠÙ†</th>
                                                                <th>Ø¯Ø§Ø¦Ù†</th>
                                                                <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="edit-entries-table">
                                                        </tbody>
                                                        <tfoot class="fw-bold">
                                                            <tr>
                                                                <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                                                <td id="edit-total-debit">0.00</td>
                                                                <td id="edit-total-credit">0.00</td>
                                                                <td></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                                
                                                <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                                                <div class="mt-3 text-end">
                                                    <button class="btn btn-secondary" onclick="cancelEdit()">
                                                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                                                    </button>
                                                    <button class="btn btn-success" onclick="saveBatch()">
                                                        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="editor-placeholder" class="text-center text-muted py-5">
                                        <i class="fas fa-hand-pointer fa-3x mb-3"></i>
                                        <p>Ø§Ø®ØªØ± Ù‚ÙŠØ¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„ØªØ­Ø±ÙŠØ±</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 6: Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
                        <div id="tab-tools" style="display: none;">
                            <h5 class="mb-3">Ø£Ø¯ÙˆØ§Øª Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h5>
                            
                            <div class="mb-3">
                                <button class="btn btn-primary ml-2" onclick="generateFinancialStatements()">
                                    <i class="fas fa-file-invoice-dollar"></i> Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                                </button>
                                <button class="btn btn-outline-info" onclick="alert('Trial Balance Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±')">
                                    <i class="fas fa-balance-scale"></i> Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                                </button>
                            </div>
                            
                            <div class="row">
                                <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„ÙØ­Øµ -->
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-cogs ml-2"></i>Ø£Ø¯ÙˆØ§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-primary w-100 mb-2" onclick="doBackup()">
                                                <i class="fas fa-download ml-2"></i>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                                            </button>
                                            <button class="btn btn-success w-100 mb-2" onclick="doValidate()">
                                                <i class="fas fa-check ml-2"></i>ÙØ­Øµ Ø§Ù„ØªÙˆØ§Ø²Ù†
                                            </button>
                                            <button class="btn btn-warning w-100 mb-2" onclick="openTrialBalance()">
                                                <i class="fas fa-balance-scale ml-2"></i>Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                                            </button>
                                            <button class="btn btn-danger w-100" onclick="doCleanup()">
                                                <i class="fas fa-trash ml-2"></i>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ù„ØºØ§Ø©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙ‚Ø¯Ù…Ø© -->
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0"><i class="fas fa-rocket ml-2"></i>ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙ‚Ø¯Ù…Ø©</h6>
                                        </div>
                                        <div class="card-body">
                                            <a href="{{ url_for('security.data_quality_center') }}" class="btn btn-gradient w-100 mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                                                <i class="fas fa-chart-line ml-2"></i>Ù…Ø±ÙƒØ² Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                            </a>
                                            <button class="btn btn-info w-100 mb-2" onclick="recalculateBalances()">
                                                <i class="fas fa-calculator ml-2"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø©
                                            </button>
                                            <button class="btn btn-primary w-100 mb-2" onclick="syncChecks()">
                                                <i class="fas fa-sync ml-2"></i>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´ÙŠÙƒØ§Øª
                                            </button>
                                            <a href="{{ url_for('security.advanced_check_linking') }}" class="btn btn-warning w-100 mb-2">
                                                <i class="fas fa-link ml-2"></i>Ø±Ø¨Ø· Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø´ÙŠÙƒØ§Øª
                                            </a>
                                            <button class="btn btn-success w-100 mb-2" onclick="loadStats()">
                                                <i class="fas fa-chart-bar ml-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="fas fa-chart-line ml-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h6>
                                        </div>
                                        <div class="card-body" id="statsContainer">
                                            <p class="text-muted text-center">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙƒÙˆØ¯ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù†ÙˆØ¹ <span class="text-danger">*</span></label>
                        <select class="custom-select" name="type" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹...</option>
                            <option value="ASSET">Ø£ØµÙˆÙ„ (ASSET)</option>
                            <option value="LIABILITY">Ø®ØµÙˆÙ… (LIABILITY)</option>
                            <option value="EQUITY">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (EQUITY)</option>
                            <option value="REVENUE">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (REVENUE)</option>
                            <option value="EXPENSE">Ù…ØµØ±ÙˆÙØ§Øª (EXPENSE)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" checked>
                            <label class="form-check-label">Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" onclick="saveNewAccount()">
                    <i class="fas fa-save ml-1"></i>Ø­ÙØ¸
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <input type="hidden" name="account_id" id="edit_account_id">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙƒÙˆØ¯</label>
                        <input type="text" class="form-control" name="code" id="edit_code" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" id="edit_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select class="custom-select" name="type" id="edit_type" disabled>
                            <option value="ASSET">Ø£ØµÙˆÙ„ (ASSET)</option>
                            <option value="LIABILITY">Ø®ØµÙˆÙ… (LIABILITY)</option>
                            <option value="EQUITY">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (EQUITY)</option>
                            <option value="REVENUE">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (REVENUE)</option>
                            <option value="EXPENSE">Ù…ØµØ±ÙˆÙØ§Øª (EXPENSE)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="edit_is_active">
                            <label class="form-check-label">Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="saveEditAccount()">
                    <i class="fas fa-save ml-1"></i>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
function loadAccounts() {
    console.log('ğŸ”„ Loading accounts...');
    var tbody = document.querySelector('#accountsTable tbody');
    if (!tbody) {
        console.error('âŒ tbody not found');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
    
    fetch('/security/ledger-control/accounts')
        .then(function(r) { 
            console.log('ğŸ“¡ Response status:', r.status);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json(); 
        })
        .then(function(data) {
            console.log('ğŸ“Š Accounts data:', data);
            tbody.innerHTML = '';
            
            if (data.success && data.accounts && data.accounts.length > 0) {
                console.log('âœ… Found ' + data.accounts.length + ' accounts');
                
                var html = '';
                data.accounts.forEach(function(acc) {
                    var status = acc.is_active ? '<span class="badge bg-success">Ù†Ø´Ø·</span>' : '<span class="badge bg-secondary">ØºÙŠØ± Ù†Ø´Ø·</span>';
                    var isActiveVal = acc.is_active ? 'true' : 'false';
                    html += '<tr>';
                    html += '<td>' + acc.code + '</td>';
                    html += '<td>' + acc.name + '</td>';
                    html += '<td>' + acc.type + '</td>';
                    html += '<td>' + status + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-sm btn-primary ml-1" onclick="showEditAccountModal(' + acc.id + ', \'' + acc.code + '\', \'' + acc.name + '\', \'' + acc.type + '\', ' + isActiveVal + ')"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>';
                    html += '<button class="btn btn-sm btn-danger" onclick="deleteAcc(' + acc.id + ')"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>';
                    html += '</td>';
                    html += '</tr>';
                });
                
                tbody.innerHTML = html;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                var countBadge = document.getElementById('accountsCount');
                if (countBadge) countBadge.textContent = data.accounts.length;
                
                console.log('âœ… Loaded ' + data.accounts.length + ' accounts');
            } else {
                console.warn('âš ï¸ No accounts found');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</td></tr>';
            }
        })
        .catch(function(e) { 
            console.error('âŒ Error loading accounts:', e); 
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£: ' + e.message + '</td></tr>';
        });
}

function loadEntries() {
    console.log('ğŸ”„ Loading entries...');
    var tbody = document.querySelector('#entriesTable tbody');
    if (!tbody) {
        console.error('âŒ entries tbody not found');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
    
    fetch('/security/ledger-control/entries')
        .then(function(r) { 
            console.log('ğŸ“¡ Entries response status:', r.status);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json(); 
        })
        .then(function(data) {
            console.log('ğŸ“Š Entries data:', data);
            tbody.innerHTML = '';
            
            if (data.success && data.batches && data.batches.length > 0) {
                console.log('âœ… Found ' + data.batches.length + ' entries');
                
                var html = '';
                data.batches.forEach(function(b) {
                    var date = b.posted_at ? new Date(b.posted_at).toLocaleDateString('ar-SA') : '-';
                    var statusBadge = '<span class="badge bg-' + (b.status === 'POSTED' ? 'success' : b.status === 'VOID' ? 'danger' : 'warning') + '">' + b.status + '</span>';
                    html += '<tr><td>' + date + '</td><td>' + (b.code || b.id) + '</td><td>' + (b.memo || '-') + '</td><td>' + (b.entries_count || 0) + '</td><td>' + statusBadge + '</td><td><button class="btn btn-sm btn-danger" onclick="voidBatch(' + b.id + ')"><i class="fas fa-ban"></i></button></td></tr>';
                });
                tbody.innerHTML = html;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                var countBadge = document.getElementById('entriesCount');
                if (countBadge) countBadge.textContent = data.batches.length;
                
                console.log('âœ… Entries table updated with ' + data.batches.length + ' rows');
            } else {
                console.warn('âš ï¸ No entries found');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯</td></tr>';
            }
        })
        .catch(function(e) { 
            console.error('âŒ Error loading entries:', e); 
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£: ' + e.message + '</td></tr>';
        });
}

function loadBatches() {
    console.log('ğŸ”„ Loading batches...');
    var tbody = document.querySelector('#batchesTable tbody');
    if (!tbody) {
        console.error('âŒ batches tbody not found');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
    
    fetch('/security/ledger-control/batches/all')
        .then(function(r) { 
            console.log('ğŸ“¡ Batches response status:', r.status);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json(); 
        })
        .then(function(data) {
            console.log('ğŸ“Š Batches data:', data);
            tbody.innerHTML = '';
            
            if (data.success && data.batches && data.batches.length > 0) {
                console.log('âœ… Found ' + data.batches.length + ' batches');
                
                var html = '';
                data.batches.forEach(function(b) {
                    var date = b.posted_at ? new Date(b.posted_at).toLocaleDateString('ar-SA') : '-';
                    var debit = parseFloat(b.total_debit || 0).toFixed(2);
                    var credit = parseFloat(b.total_credit || 0).toFixed(2);
                    var balanced = debit === credit ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    html += '<tr><td>' + (b.code || b.id) + '</td><td>' + date + '</td><td>' + b.source_type + '</td><td>' + debit + '</td><td>' + credit + '</td><td>' + balanced + ' <button class="btn btn-sm btn-primary" onclick="editBatch(' + b.id + ')"><i class="fas fa-edit"></i></button></td></tr>';
                });
                tbody.innerHTML = html;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                var countBadge = document.getElementById('batchesCount');
                if (countBadge) countBadge.textContent = data.batches.length;
                
                console.log('âœ… Batches table updated with ' + data.batches.length + ' rows');
            } else {
                console.warn('âš ï¸ No batches found');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯</td></tr>';
            }
        })
        .catch(function(e) { 
            console.error('âŒ Error loading batches:', e); 
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£: ' + e.message + '</td></tr>';
        });
}

// Ø§Ù„Ø£Ø¯ÙˆØ§Øª
function doBackup() {
    if (!confirm('Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ')) return;
    fetch('/security/ledger-control/backup', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®: ' + data.filename);
            } else {
                alert('ÙØ´Ù„: ' + data.error);
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function doValidate() {
    fetch('/security/ledger-control/validate')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                if (data.imbalanced_batches && data.imbalanced_batches.length > 0) {
                    alert('ÙˆÙØ¬Ø¯ ' + data.imbalanced_batches.length + ' Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†!');
                } else {
                    alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù…ØªÙˆØ§Ø²Ù†Ø©');
                }
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£'); });
}

function openTrialBalance() {
    window.open('/ledger/', '_blank');
}

function doCleanup() {
    if (!confirm('Ø­Ø°Ù Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ù„ØºØ§Ø©ØŸ')) return;
    fetch('/security/ledger-control/cleanup', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('ØªÙ… Ø­Ø°Ù ' + data.deleted_count + ' Ù‚ÙŠØ¯');
            } else {
                alert('ÙØ´Ù„');
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£'); });
}

function deleteAcc(id) {
    if (!confirm('Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) return;
    fetch('/security/ledger-control/accounts/' + id + '/delete', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                loadAccounts();
            } else {
                alert(data.error || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
            }
        });
}

function voidBatch(id) {
    if (!confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ØŸ')) return;
    fetch('/security/ledger-control/entries/' + id + '/void', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                loadEntries();
            } else {
                alert(data.error || 'ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
            }
        });
}

function editBatch(id) {
    alert('ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠØ¯ #' + id + ' (Ù‚Ø±ÙŠØ¨Ø§Ù‹)');
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
function showAddAccountModal() {
    document.getElementById('addAccountForm').reset();
    $('#addAccountModal').modal('show');
}

function saveNewAccount() {
    var form = document.getElementById('addAccountForm');
    var formData = new FormData(form);
    
    var data = {
        code: formData.get('code'),
        name: formData.get('name'),
        type: formData.get('type'),
        is_active: formData.get('is_active') ? true : false
    };
    
    fetch('/security/ledger-control/accounts/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            $('#addAccountModal').modal('hide');
            loadAccounts();
        } else {
            alert('âŒ ÙØ´Ù„: ' + result.error);
        }
    })
    .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function showEditAccountModal(id, code, name, type, isActive) {
    document.getElementById('edit_account_id').value = id;
    document.getElementById('edit_code').value = code;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_type').value = type;
    document.getElementById('edit_is_active').checked = isActive;
    
    $('#editAccountModal').modal('show');
}

function saveEditAccount() {
    var id = document.getElementById('edit_account_id').value;
    var name = document.getElementById('edit_name').value;
    var isActive = document.getElementById('edit_is_active').checked;
    
    var data = {
        name: name,
        is_active: isActive
    };
    
    fetch('/security/ledger-control/accounts/' + id + '/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            $('#editAccountModal').modal('hide');
            loadAccounts();
        } else {
            alert('âŒ ÙØ´Ù„: ' + result.error);
        }
    })
    .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

// ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙ‚Ø¯Ù…Ø©
function recalculateBalances() {
    if (!confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±ØµØ¯Ø©ØŸ\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹...')) return;
    
    fetch('/security/ledger-control/recalculate-balances', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('âœ… ' + data.message);
            } else {
                alert('âŒ ÙØ´Ù„: ' + data.error);
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function syncChecks() {
    if (!confirm('Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù…Ø¹ Ø§Ù„Ø´ÙŠÙƒØ§ØªØŸ')) return;
    
    fetch('/security/ledger-control/sync-checks', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('âœ… ' + data.message);
            } else {
                alert('âŒ ÙØ´Ù„: ' + data.error);
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function loadStats() {
    var container = document.getElementById('statsContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
    
    fetch('/security/ledger-control/statistics')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var html = '<div class="row">';
                
                // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                html += '<div class="col-md-3"><div class="card bg-primary text-white"><div class="card-body text-center">';
                html += '<h3>' + data.accounts.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</small>';
                html += '<hr><p class="mb-0">' + data.accounts.active + ' Ù†Ø´Ø·</p></div></div></div>';
                
                // Ø§Ù„Ù‚ÙŠÙˆØ¯
                html += '<div class="col-md-3"><div class="card bg-success text-white"><div class="card-body text-center">';
                html += '<h3>' + data.batches.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙˆØ¯</small>';
                html += '<hr><p class="mb-0">' + data.batches.posted + ' Ù…Ù†Ø´ÙˆØ±</p></div></div></div>';
                
                // Ø§Ù„Ø¯ÙØ¹Ø§Øª
                html += '<div class="col-md-3"><div class="card bg-info text-white"><div class="card-body text-center">';
                html += '<h3>' + data.payments.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª</small>';
                html += '<hr><p class="mb-0">' + data.payments.completed + ' Ù…ÙƒØªÙ…Ù„Ø©</p></div></div></div>';
                
                // Ø§Ù„Ø´ÙŠÙƒØ§Øª
                html += '<div class="col-md-3"><div class="card bg-warning text-white"><div class="card-body text-center">';
                html += '<h3>' + data.checks.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙŠÙƒØ§Øª</small>';
                html += '<hr><p class="mb-0">' + data.checks.pending + ' Ù…Ø¹Ù„Ù‚Ø©</p></div></div></div>';
                
                html += '</div>';
                
                // Ø§Ù„Ù‚ÙŠÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†Ø©
                if (data.health.imbalanced_entries > 0) {
                    html += '<div class="alert alert-warning mt-3"><i class="fas fa-exclamation-triangle ml-2"></i>';
                    html += '<strong>ØªØ­Ø°ÙŠØ±:</strong> ÙŠÙˆØ¬Ø¯ ' + data.health.imbalanced_entries + ' Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†!</div>';
                } else {
                    html += '<div class="alert alert-success mt-3"><i class="fas fa-check-circle ml-2"></i>';
                    html += '<strong>Ù…Ù…ØªØ§Ø²:</strong> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù…ØªÙˆØ§Ø²Ù†Ø©!</div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£: ' + data.error + '</div>';
            }
        })
        .catch(function(e) { 
            container.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£: ' + e.message + '</div>';
        });
}

// Ø§Ù„ØªØ§Ø¨Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… DOM loaded - initializing ledger-control');
    
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£ÙˆÙ„
    document.getElementById('tab-accounts').style.display = 'block';
    document.getElementById('tab-entries').style.display = 'none';
    document.getElementById('tab-batches').style.display = 'none';
    document.getElementById('tab-operations').style.display = 'none';
    document.getElementById('tab-editor').style.display = 'none';
    document.getElementById('tab-tools').style.display = 'none';
    
    // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ ØªØ§Ø¨ ÙÙˆØ±Ø§Ù‹
    console.log('â³ Loading first tab (accounts)...');
    setTimeout(function() {
        loadAccounts();
    }, 100);
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
    var tabs = document.querySelectorAll('#controlTabs .nav-link');
    console.log('ğŸ“‘ Found ' + tabs.length + ' tabs');
    
    tabs.forEach(function(tab) {
        console.log('ğŸ”— Attaching event to tab:', tab.getAttribute('href'));
        
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            var target = this.getAttribute('href');
            console.log('ğŸ“ Tab clicked:', target);
            
            // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.querySelectorAll('#controlTabs .nav-link').forEach(function(link) {
                link.classList.remove('active');
            });
            this.classList.add('active');
            
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.getElementById('tab-accounts').style.display = 'none';
            document.getElementById('tab-entries').style.display = 'none';
            document.getElementById('tab-batches').style.display = 'none';
            document.getElementById('tab-operations').style.display = 'none';
            document.getElementById('tab-editor').style.display = 'none';
            document.getElementById('tab-tools').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            var targetId = target.replace('#', '');
            var activePane = document.getElementById(targetId);
            if (activePane) {
                activePane.style.display = 'block';
                console.log('âœ… Showing pane:', target);
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (target === '#tab-accounts') {
                loadAccounts();
            } else if (target === '#tab-entries') {
                loadEntries();
            } else if (target === '#tab-batches') {
                loadBatches();
            } else if (target === '#tab-operations') {
                loadFiscalPeriods();
            } else if (target === '#tab-editor') {
                loadBatchesForEditor();
            }
        });
    });
    
    console.log('âœ… Event listeners attached');
});

// ========== ÙˆØ¸Ø§Ø¦Ù Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ==========

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
async function loadFiscalPeriods() {
    try {
        const response = await fetch('/security/ledger-control/operations/fiscal-periods/api');
        const data = await response.json();
        
        if (data.success) {
            const html = data.periods.map(p => `
                <div class="period-item ${p.is_closed ? 'period-closed' : ''} ${p.is_current ? 'period-current' : ''}" style="border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6>${p.name_ar}</h6>
                            <small class="text-muted">${p.start_date} Ø¥Ù„Ù‰ ${p.end_date}</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <strong>${p.batches_count}</strong> Ù‚ÙŠØ¯
                        </div>
                        <div class="col-md-2 text-center">
                            <small>Ù…Ø¯ÙŠÙ†: ${p.total_debit.toLocaleString()} â‚ª</small><br>
                            <small>Ø¯Ø§Ø¦Ù†: ${p.total_credit.toLocaleString()} â‚ª</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="badge ${p.is_closed ? 'bg-danger' : 'bg-success'}">
                                ${p.is_closed ? 'ğŸ”’ Ù…Ù‚ÙÙ„' : 'ğŸ”“ Ù…ÙØªÙˆØ­'}
                            </span>
                        </div>
                        <div class="col-md-3 text-end">
                            ${p.is_current ? '<span class="badge bg-info">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('fiscal-periods-list').innerHTML = html || '<p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØªØ±Ø§Øª</p>';
        }
    } catch (error) {
        document.getElementById('fiscal-periods-list').innerHTML = `
            <div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØªØ±Ø§Øª: ${error.message}</div>
        `;
    }
}

// Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
async function generateClosingEntries() {
    const date = document.getElementById('closing-date').value;
    if (!date) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚ÙØ§Ù„');
        return;
    }
    
    try {
        const response = await fetch('/security/ledger-control/operations/closing-entries/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({period_end: date})
        });
        const data = await response.json();
        
        if (data.success) {
            const html = `
                <div class="alert alert-success">
                    <h6>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø³Ø§Ø¨:</h6>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${data.total_revenue.toLocaleString()} â‚ª</p>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${data.total_expenses.toLocaleString()} â‚ª</p>
                    <p><strong>ØµØ§ÙÙŠ Ø§Ù„Ø¯Ø®Ù„: ${data.net_income.toLocaleString()} â‚ª</strong></p>
                </div>
                
                <div class="card mt-3">
                    <div class="card-body">
                        <h6>Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</h6>
                        ${data.closing_entries.map((entry, idx) => `
                            <div class="mb-3">
                                <strong>${entry.description}</strong>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                            <th class="text-end">Ù…Ø¯ÙŠÙ†</th>
                                            <th class="text-end">Ø¯Ø§Ø¦Ù†</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${entry.entries.map(e => `
                                            <tr>
                                                <td><code>${e.account}</code></td>
                                                <td class="text-end">${e.debit.toLocaleString()} â‚ª</td>
                                                <td class="text-end">${e.credit.toLocaleString()} â‚ª</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('')}
                        
                        <button class="btn btn-success w-100 mt-3" onclick='postClosingEntries("${date}", ${JSON.stringify(data.closing_entries)})'>
                            <i class="fas fa-check"></i> ØªØ±Ø­ÙŠÙ„ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('closing-results').innerHTML = html;
            document.getElementById('closing-results').style.display = 'block';
        } else {
            alert('Ø®Ø·Ø£: ' + data.error);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£: ' + error.message);
    }
}

// ØªØ±Ø­ÙŠÙ„ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
async function postClosingEntries(date, entries) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±Ø­ÙŠÙ„ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ØŸ')) return;
    
    try {
        const response = await fetch('/security/ledger-control/operations/closing-entries/post', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({period_end: date, entries: entries})
        });
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            document.getElementById('closing-results').style.display = 'none';
            loadFiscalPeriods();
        } else {
            alert('Ø®Ø·Ø£: ' + data.error);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£: ' + error.message);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
async function loadPendingBatches() {
    try {
        const response = await fetch('/security/ledger-control/operations/review-queue');
        const data = await response.json();
        
        if (data.success) {
            if (data.pending_count === 0) {
                document.getElementById('pending-batches-list').innerHTML = '<p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ Ù…Ø¹Ù„Ù‚Ø©</p>';
                return;
            }
            
            const html = data.batches.map(b => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>${b.code} - ${b.purpose}</h6>
                                <small>${b.memo}</small>
                                <br>
                                <span class="badge ${b.is_balanced ? 'bg-success' : 'bg-danger'}">
                                    ${b.is_balanced ? 'âœ“ Ù…ØªÙˆØ§Ø²Ù†' : 'âœ— ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†'}
                                </span>
                                <span class="badge bg-secondary">${b.entries_count} Ø³Ø·ÙˆØ±</span>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-success btn-sm" onclick="approveBatch(${b.id})">
                                    <i class="fas fa-check"></i> Ù…ÙˆØ§ÙÙ‚Ø©
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="rejectBatch(${b.id})">
                                    <i class="fas fa-times"></i> Ø±ÙØ¶
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('pending-batches-list').innerHTML = html;
        }
    } catch (error) {
        document.getElementById('pending-batches-list').innerHTML = `
            <div class="alert alert-danger">Ø®Ø·Ø£: ${error.message}</div>
        `;
    }
}

// Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‚ÙŠØ¯
async function approveBatch(batchId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯ØŸ')) return;
    
    try {
        const response = await fetch(`/security/ledger-control/operations/approve-batch/${batchId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            loadPendingBatches();
        } else {
            alert('Ø®Ø·Ø£: ' + data.error);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£: ' + error.message);
    }
}

// Ø±ÙØ¶ Ù‚ÙŠØ¯
async function rejectBatch(batchId) {
    const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:');
    if (!reason) return;
    
    try {
        const response = await fetch(`/security/ledger-control/operations/reject-batch/${batchId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reason: reason})
        });
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            loadPendingBatches();
        } else {
            alert('Ø®Ø·Ø£: ' + data.error);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£: ' + error.message);
    }
}

// Ø¹ÙƒØ³ Ù‚ÙŠØ¯
async function reverseBatch() {
    const batchId = document.getElementById('reverse-batch-id').value;
    if (!batchId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯');
        return;
    }
    
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ø¹ÙƒØ³ÙŠ Ù„Ù„Ù‚ÙŠØ¯ Ø±Ù‚Ù… ${batchId}ØŸ`)) return;
    
    try {
        const response = await fetch(`/security/ledger-control/operations/reverse-entry/${batchId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('reverse-result').innerHTML = `
                <div class="alert alert-success">
                    ${data.message}<br>
                    <strong>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¹ÙƒØ³ÙŠ:</strong> ${data.reversal_batch_id}
                </div>
            `;
            document.getElementById('reverse-batch-id').value = '';
        } else {
            document.getElementById('reverse-result').innerHTML = `
                <div class="alert alert-danger">Ø®Ø·Ø£: ${data.error}</div>
            `;
        }
    } catch (error) {
        document.getElementById('reverse-result').innerHTML = `
            <div class="alert alert-danger">Ø®Ø·Ø£: ${error.message}</div>
        `;
    }
}

// Ø§Ù„ØªØ§Ø¨Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… DOM loaded - initializing ledger-control');
    
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£ÙˆÙ„
    document.getElementById('tab-accounts').style.display = 'block';
    document.getElementById('tab-entries').style.display = 'none';
    document.getElementById('tab-batches').style.display = 'none';
    document.getElementById('tab-operations').style.display = 'none';
    document.getElementById('tab-tools').style.display = 'none';

    
    // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ ØªØ§Ø¨ ÙÙˆØ±Ø§Ù‹
    console.log('â³ Loading first tab (accounts)...');
    setTimeout(function() {
        loadAccounts();
    }, 100);
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    var tabs = document.querySelectorAll('#controlTabs .nav-link');
    console.log('ğŸ“‘ Found ' + tabs.length + ' tabs');
    
    tabs.forEach(function(tab) {
        console.log('ğŸ”— Attaching event to tab:', tab.getAttribute('href'));
        
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            var target = this.getAttribute('href');
            console.log('ğŸ“ Tab clicked:', target);
            
            // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.querySelectorAll('#controlTabs .nav-link').forEach(function(link) {
                link.classList.remove('active');
            });
            this.classList.add('active');
            
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.getElementById('tab-accounts').style.display = 'none';
            document.getElementById('tab-entries').style.display = 'none';
            document.getElementById('tab-batches').style.display = 'none';
            document.getElementById('tab-operations').style.display = 'none';
            document.getElementById('tab-tools').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            var targetId = target.replace('#', '');
            var activePane = document.getElementById(targetId);
            if (activePane) {
                activePane.style.display = 'block';
                console.log('âœ… Showing pane:', target);
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (target === '#tab-accounts') {
                loadAccounts();
            } else if (target === '#tab-entries') {
                loadEntries();
            } else if (target === '#tab-batches') {
                loadBatches();
            } else if (target === '#tab-operations') {
                loadFiscalPeriods();
            }
        });
    });
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª
    const approvalTab = document.querySelector('[data-target="#ops-approval"]');
    if (approvalTab) {
        approvalTab.addEventListener('click', function() {
            setTimeout(() => loadPendingBatches(), 100);
        });
    }
    
    console.log('âœ… Event listeners attached');
});

// ========== Ù…Ø­Ø±Ø± Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ==========

let currentBatchId = null;
let currentEntityId = null;
let currentEntityType = null;

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù„Ù„Ù…Ø­Ø±Ø±
async function loadBatchesForEditor() {
    try {
        const response = await fetch('/security/ledger-control/batches/all');
        const data = await response.json();
        
        if (data.success) {
            const html = data.batches.map(b => `
                <div class="card mb-2 batch-item" style="cursor:pointer;" onclick="editBatch(${b.id})">
                    <div class="card-body p-2">
                        <small><strong>${b.code}</strong></small><br>
                        <small class="text-muted">${b.purpose || 'N/A'}</small><br>
                        <span class="badge badge-sm ${b.entity_type ? 'bg-success' : 'bg-warning'}">
                            ${b.entity_type ? b.entity_type : 'ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·'}
                        </span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('batches-list-editor').innerHTML = html;
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// ÙØªØ­ Ù‚ÙŠØ¯ Ù„Ù„ØªØ­Ø±ÙŠØ±
async function editBatch(batchId) {
    try {
        const response = await fetch(`/security/ledger-control/operations/batch/${batchId}/edit`);
        const data = await response.json();
        
        if (data.success) {
            currentBatchId = batchId;
            const batch = data.batch;
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('edit-batch-code').textContent = batch.code;
            document.getElementById('edit-purpose').value = batch.purpose || '';
            document.getElementById('edit-memo').value = batch.memo || '';
            document.getElementById('edit-entity-type').value = batch.entity_type || '';
            
            if (batch.posted_at) {
                const dt = new Date(batch.posted_at);
                document.getElementById('edit-posted-at').value = dt.toISOString().slice(0, 16);
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (batch.entity_name) {
                document.getElementById('current-entity-display').innerHTML = `
                    <div class="alert alert-info">
                        <strong>Ù…Ø±Ø¨ÙˆØ· Ø¨Ù€:</strong> ${batch.entity_type} - ${batch.entity_name} (ID: ${batch.entity_id})
                    </div>
                `;
                currentEntityId = batch.entity_id;
                currentEntityType = batch.entity_type;
            } else {
                document.getElementById('current-entity-display').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ· Ø¨Ø¬Ù‡Ø©</strong>
                    </div>
                `;
                currentEntityId = null;
                currentEntityType = null;
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø·ÙˆØ±
            let totalDebit = 0;
            let totalCredit = 0;
            
            const entriesHtml = batch.entries.map(e => {
                totalDebit += e.debit;
                totalCredit += e.credit;
                return `
                    <tr>
                        <td><code>${e.account}</code></td>
                        <td class="text-end">${e.debit.toFixed(2)}</td>
                        <td class="text-end">${e.credit.toFixed(2)}</td>
                        <td><small>${e.ref || ''}</small></td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('edit-entries-table').innerHTML = entriesHtml;
            document.getElementById('edit-total-debit').textContent = totalDebit.toFixed(2);
            document.getElementById('edit-total-credit').textContent = totalCredit.toFixed(2);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('editor-placeholder').style.display = 'none';
            document.getElementById('editor-form').style.display = 'block';
        }
    } catch (error) {
        alert('Ø®Ø·Ø£: ' + error.message);
    }
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù‡Ø§Øª
let searchTimeout;
async function searchEntity() {
    clearTimeout(searchTimeout);
    
    const entityType = document.getElementById('edit-entity-type').value;
    const searchTerm = document.getElementById('entity-search').value;
    
    if (!entityType || searchTerm.length < 2) {
        document.getElementById('entity-results').style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/security/ledger-control/operations/entities/search?type=${entityType}&q=${searchTerm}`);
            const data = await response.json();
            
            if (data.success && data.results.length > 0) {
                const html = data.results.map(e => `
                    <a href="#" class="list-group-item list-group-item-action" onclick="selectEntity(${e.id}, '${e.name}', '${e.type}'); return false;">
                        ${e.name} <small class="text-muted">(${e.type})</small>
                    </a>
                `).join('');
                
                document.getElementById('entity-results').innerHTML = html;
                document.getElementById('entity-results').style.display = 'block';
            } else {
                document.getElementById('entity-results').style.display = 'none';
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
}

// Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø© Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function selectEntity(entityId, entityName, entityType) {
    currentEntityId = entityId;
    currentEntityType = entityType;
    
    document.getElementById('entity-search').value = entityName;
    document.getElementById('entity-results').style.display = 'none';
    
    document.getElementById('current-entity-display').innerHTML = `
        <div class="alert alert-success">
            <strong>Ù…Ø­Ø¯Ø¯:</strong> ${entityType} - ${entityName} (ID: ${entityId})
        </div>
    `;
}

// Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø© Ø¨Ø§Ù„Ù‚ÙŠØ¯
async function linkCurrentEntity() {
    if (!currentBatchId) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù‚ÙŠØ¯');
        return;
    }
    
    if (!currentEntityType || !currentEntityId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø©');
        return;
    }
    
    if (!confirm(`Ø±Ø¨Ø· Ø§Ù„Ù‚ÙŠØ¯ Ø¨Ù€ ${currentEntityType} #${currentEntityId}?`)) return;
    
    try {
        const response = await fetch(`/security/ledger-control/operations/batch/${currentBatchId}/link-entity`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                entity_type: currentEntityType,
                entity_id: currentEntityId
            })
        });
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            loadBatchesForEditor();
        } else {
            alert('Ø®Ø·Ø£: ' + data.error);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£: ' + error.message);
    }
}

// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
async function saveBatch() {
    if (!currentBatchId) return;
    
    if (!confirm('Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§ØªØŸ')) return;
    
    try {
        const response = await fetch(`/security/ledger-control/operations/batch/${currentBatchId}/update-full`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                purpose: document.getElementById('edit-purpose').value,
                memo: document.getElementById('edit-memo').value,
                entity_type: document.getElementById('edit-entity-type').value,
                entity_id: currentEntityId,
                posted_at: document.getElementById('edit-posted-at').value
            })
        });
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            cancelEdit();
            loadBatchesForEditor();
        } else {
            alert('Ø®Ø·Ø£: ' + data.error);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£: ' + error.message);
    }
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ±
function cancelEdit() {
    document.getElementById('editor-form').style.display = 'none';
    document.getElementById('editor-placeholder').style.display = 'block';
    currentBatchId = null;
    currentEntityId = null;
    currentEntityType = null;
}

</script>
{% endblock %}

