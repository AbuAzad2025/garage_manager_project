{% extends 'base.html' %}
{% block title %}ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <div class="card shadow">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0"><i class="fas fa-university me-2"></i>ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø© - Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</h4>
                    <small>Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</small>
                </div>
                <div>
                    <button class="btn btn-light btn-sm" onclick="window.location.href='/security/'">
                        <i class="fas fa-arrow-right me-1"></i>Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            <ul class="nav nav-pills nav-fill border-bottom" id="controlTabs" style="background: #f8f9fa;">
                        <li class="nav-item">
                            <a class="nav-link active" href="#tab-accounts">
                                <i class="fas fa-list me-1"></i>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-entries">
                                <i class="fas fa-file me-1"></i>Ø§Ù„Ù‚ÙŠÙˆØ¯
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-batches">
                                <i class="fas fa-edit me-1"></i>ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙˆØ¯
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab-tools">
                                <i class="fas fa-tools me-1"></i>Ø§Ù„Ø£Ø¯ÙˆØ§Øª
                            </a>
                        </li>
            </ul>
            
            <div class="p-3">
                        <!-- Tab 1: Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
                        <div id="tab-accounts" style="display: block;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© <span class="badge bg-primary" id="accountsCount">0</span></h5>
                                <button class="btn btn-success" onclick="showAddAccountModal()">
                                    <i class="fas fa-plus me-1"></i>Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                            <div style="height: 600px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 5px; padding: 10px; background: white;">
                                <table class="table table-striped table-hover table-bordered" id="accountsTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th style="width: 12%;">Ø§Ù„ÙƒÙˆØ¯</th>
                                            <th style="width: 30%;">Ø§Ù„Ø§Ø³Ù…</th>
                                            <th style="width: 18%;">Ø§Ù„Ù†ÙˆØ¹</th>
                                            <th style="width: 12%;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th style="width: 28%;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody style="background: white;"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab 2: Ø§Ù„Ù‚ÙŠÙˆØ¯ -->
                        <div id="tab-entries" style="display: none;">
                            <h5 class="mb-3">Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© <span class="badge bg-success" id="entriesCount">0</span></h5>
                            <div style="height: 600px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 5px; padding: 10px; background: white;">
                                <table class="table table-striped table-hover table-bordered" id="entriesTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                            <th>Ø§Ù„ÙˆØµÙ</th>
                                            <th>Ø§Ù„Ù‚ÙŠÙˆØ¯</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody style="background: white;"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab 3: ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙˆØ¯ -->
                        <div id="tab-batches" style="display: none;">
                            <h5 class="mb-3">ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙˆØ¯ <span class="badge bg-warning" id="batchesCount">0</span></h5>
                            <div style="height: 600px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 5px; padding: 10px; background: white;">
                                <table class="table table-striped table-hover table-bordered" id="batchesTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                                            <th>Ù…Ø¯ÙŠÙ†</th>
                                            <th>Ø¯Ø§Ø¦Ù†</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody style="background: white;"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab 4: Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
                        <div id="tab-tools" style="display: none;">
                            <h5 class="mb-3">Ø£Ø¯ÙˆØ§Øª Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h5>
                            
                            <div class="row">
                                <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„ÙØ­Øµ -->
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Ø£Ø¯ÙˆØ§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-primary w-100 mb-2" onclick="doBackup()">
                                                <i class="fas fa-download me-2"></i>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                                            </button>
                                            <button class="btn btn-success w-100 mb-2" onclick="doValidate()">
                                                <i class="fas fa-check me-2"></i>ÙØ­Øµ Ø§Ù„ØªÙˆØ§Ø²Ù†
                                            </button>
                                            <button class="btn btn-warning w-100 mb-2" onclick="openTrialBalance()">
                                                <i class="fas fa-balance-scale me-2"></i>Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                                            </button>
                                            <button class="btn btn-danger w-100" onclick="doCleanup()">
                                                <i class="fas fa-trash me-2"></i>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ù„ØºØ§Ø©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙ‚Ø¯Ù…Ø© -->
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0"><i class="fas fa-rocket me-2"></i>ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙ‚Ø¯Ù…Ø©</h6>
                                        </div>
                                        <div class="card-body">
                                            <a href="{{ url_for('security.data_quality_center') }}" class="btn btn-gradient w-100 mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                                                <i class="fas fa-chart-line me-2"></i>Ù…Ø±ÙƒØ² Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                            </a>
                                            <button class="btn btn-info w-100 mb-2" onclick="recalculateBalances()">
                                                <i class="fas fa-calculator me-2"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø©
                                            </button>
                                            <button class="btn btn-primary w-100 mb-2" onclick="syncChecks()">
                                                <i class="fas fa-sync me-2"></i>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´ÙŠÙƒØ§Øª
                                            </button>
                                            <a href="{{ url_for('security.advanced_check_linking') }}" class="btn btn-warning w-100 mb-2">
                                                <i class="fas fa-link me-2"></i>Ø±Ø¨Ø· Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø´ÙŠÙƒØ§Øª
                                            </a>
                                            <button class="btn btn-success w-100 mb-2" onclick="loadStats()">
                                                <i class="fas fa-chart-bar me-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h6>
                                        </div>
                                        <div class="card-body" id="statsContainer">
                                            <p class="text-muted text-center">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙƒÙˆØ¯ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù†ÙˆØ¹ <span class="text-danger">*</span></label>
                        <select class="form-select" name="type" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹...</option>
                            <option value="ASSET">Ø£ØµÙˆÙ„ (ASSET)</option>
                            <option value="LIABILITY">Ø®ØµÙˆÙ… (LIABILITY)</option>
                            <option value="EQUITY">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (EQUITY)</option>
                            <option value="REVENUE">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (REVENUE)</option>
                            <option value="EXPENSE">Ù…ØµØ±ÙˆÙØ§Øª (EXPENSE)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" checked>
                            <label class="form-check-label">Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" onclick="saveNewAccount()">
                    <i class="fas fa-save me-1"></i>Ø­ÙØ¸
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <input type="hidden" name="account_id" id="edit_account_id">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙƒÙˆØ¯</label>
                        <input type="text" class="form-control" name="code" id="edit_code" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" id="edit_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select class="form-select" name="type" id="edit_type" disabled>
                            <option value="ASSET">Ø£ØµÙˆÙ„ (ASSET)</option>
                            <option value="LIABILITY">Ø®ØµÙˆÙ… (LIABILITY)</option>
                            <option value="EQUITY">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (EQUITY)</option>
                            <option value="REVENUE">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (REVENUE)</option>
                            <option value="EXPENSE">Ù…ØµØ±ÙˆÙØ§Øª (EXPENSE)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="edit_is_active">
                            <label class="form-check-label">Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="saveEditAccount()">
                    <i class="fas fa-save me-1"></i>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
function loadAccounts() {
    console.log('ğŸ”„ Loading accounts...');
    var tbody = document.querySelector('#accountsTable tbody');
    if (!tbody) {
        console.error('âŒ tbody not found');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
    
    fetch('/security/ledger-control/accounts')
        .then(function(r) { 
            console.log('ğŸ“¡ Response status:', r.status);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json(); 
        })
        .then(function(data) {
            console.log('ğŸ“Š Accounts data:', data);
            tbody.innerHTML = '';
            
            if (data.success && data.accounts && data.accounts.length > 0) {
                console.log('âœ… Found ' + data.accounts.length + ' accounts');
                
                var html = '';
                data.accounts.forEach(function(acc) {
                    var status = acc.is_active ? '<span class="badge bg-success">Ù†Ø´Ø·</span>' : '<span class="badge bg-secondary">ØºÙŠØ± Ù†Ø´Ø·</span>';
                    var isActiveVal = acc.is_active ? 'true' : 'false';
                    html += '<tr>';
                    html += '<td>' + acc.code + '</td>';
                    html += '<td>' + acc.name + '</td>';
                    html += '<td>' + acc.type + '</td>';
                    html += '<td>' + status + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-sm btn-primary me-1" onclick="showEditAccountModal(' + acc.id + ', \'' + acc.code + '\', \'' + acc.name + '\', \'' + acc.type + '\', ' + isActiveVal + ')"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>';
                    html += '<button class="btn btn-sm btn-danger" onclick="deleteAcc(' + acc.id + ')"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>';
                    html += '</td>';
                    html += '</tr>';
                });
                
                tbody.innerHTML = html;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                var countBadge = document.getElementById('accountsCount');
                if (countBadge) countBadge.textContent = data.accounts.length;
                
                console.log('âœ… Loaded ' + data.accounts.length + ' accounts');
            } else {
                console.warn('âš ï¸ No accounts found');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</td></tr>';
            }
        })
        .catch(function(e) { 
            console.error('âŒ Error loading accounts:', e); 
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£: ' + e.message + '</td></tr>';
        });
}

function loadEntries() {
    console.log('ğŸ”„ Loading entries...');
    var tbody = document.querySelector('#entriesTable tbody');
    if (!tbody) {
        console.error('âŒ entries tbody not found');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
    
    fetch('/security/ledger-control/entries')
        .then(function(r) { 
            console.log('ğŸ“¡ Entries response status:', r.status);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json(); 
        })
        .then(function(data) {
            console.log('ğŸ“Š Entries data:', data);
            tbody.innerHTML = '';
            
            if (data.success && data.batches && data.batches.length > 0) {
                console.log('âœ… Found ' + data.batches.length + ' entries');
                
                var html = '';
                data.batches.forEach(function(b) {
                    var date = b.posted_at ? new Date(b.posted_at).toLocaleDateString('ar-SA') : '-';
                    var statusBadge = '<span class="badge bg-' + (b.status === 'POSTED' ? 'success' : b.status === 'VOID' ? 'danger' : 'warning') + '">' + b.status + '</span>';
                    html += '<tr><td>' + date + '</td><td>' + (b.code || b.id) + '</td><td>' + (b.memo || '-') + '</td><td>' + (b.entries_count || 0) + '</td><td>' + statusBadge + '</td><td><button class="btn btn-sm btn-danger" onclick="voidBatch(' + b.id + ')"><i class="fas fa-ban"></i></button></td></tr>';
                });
                tbody.innerHTML = html;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                var countBadge = document.getElementById('entriesCount');
                if (countBadge) countBadge.textContent = data.batches.length;
                
                console.log('âœ… Entries table updated with ' + data.batches.length + ' rows');
            } else {
                console.warn('âš ï¸ No entries found');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯</td></tr>';
            }
        })
        .catch(function(e) { 
            console.error('âŒ Error loading entries:', e); 
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£: ' + e.message + '</td></tr>';
        });
}

function loadBatches() {
    console.log('ğŸ”„ Loading batches...');
    var tbody = document.querySelector('#batchesTable tbody');
    if (!tbody) {
        console.error('âŒ batches tbody not found');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
    
    fetch('/security/ledger-control/batches/all')
        .then(function(r) { 
            console.log('ğŸ“¡ Batches response status:', r.status);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json(); 
        })
        .then(function(data) {
            console.log('ğŸ“Š Batches data:', data);
            tbody.innerHTML = '';
            
            if (data.success && data.batches && data.batches.length > 0) {
                console.log('âœ… Found ' + data.batches.length + ' batches');
                
                var html = '';
                data.batches.forEach(function(b) {
                    var date = b.posted_at ? new Date(b.posted_at).toLocaleDateString('ar-SA') : '-';
                    var debit = parseFloat(b.total_debit || 0).toFixed(2);
                    var credit = parseFloat(b.total_credit || 0).toFixed(2);
                    var balanced = debit === credit ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    html += '<tr><td>' + (b.code || b.id) + '</td><td>' + date + '</td><td>' + b.source_type + '</td><td>' + debit + '</td><td>' + credit + '</td><td>' + balanced + ' <button class="btn btn-sm btn-primary" onclick="editBatch(' + b.id + ')"><i class="fas fa-edit"></i></button></td></tr>';
                });
                tbody.innerHTML = html;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                var countBadge = document.getElementById('batchesCount');
                if (countBadge) countBadge.textContent = data.batches.length;
                
                console.log('âœ… Batches table updated with ' + data.batches.length + ' rows');
            } else {
                console.warn('âš ï¸ No batches found');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯</td></tr>';
            }
        })
        .catch(function(e) { 
            console.error('âŒ Error loading batches:', e); 
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£: ' + e.message + '</td></tr>';
        });
}

// Ø§Ù„Ø£Ø¯ÙˆØ§Øª
function doBackup() {
    if (!confirm('Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ')) return;
    fetch('/security/ledger-control/backup', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®: ' + data.filename);
            } else {
                alert('ÙØ´Ù„: ' + data.error);
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function doValidate() {
    fetch('/security/ledger-control/validate')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                if (data.imbalanced_batches && data.imbalanced_batches.length > 0) {
                    alert('ÙˆÙØ¬Ø¯ ' + data.imbalanced_batches.length + ' Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†!');
                } else {
                    alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù…ØªÙˆØ§Ø²Ù†Ø©');
                }
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£'); });
}

function openTrialBalance() {
    window.open('/ledger/', '_blank');
}

function doCleanup() {
    if (!confirm('Ø­Ø°Ù Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ù„ØºØ§Ø©ØŸ')) return;
    fetch('/security/ledger-control/cleanup', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('ØªÙ… Ø­Ø°Ù ' + data.deleted_count + ' Ù‚ÙŠØ¯');
            } else {
                alert('ÙØ´Ù„');
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£'); });
}

function deleteAcc(id) {
    if (!confirm('Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) return;
    fetch('/security/ledger-control/accounts/' + id + '/delete', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                loadAccounts();
            } else {
                alert(data.error || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
            }
        });
}

function voidBatch(id) {
    if (!confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ØŸ')) return;
    fetch('/security/ledger-control/entries/' + id + '/void', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                loadEntries();
            } else {
                alert(data.error || 'ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
            }
        });
}

function editBatch(id) {
    alert('ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠØ¯ #' + id + ' (Ù‚Ø±ÙŠØ¨Ø§Ù‹)');
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
function showAddAccountModal() {
    var modal = new bootstrap.Modal(document.getElementById('addAccountModal'));
    document.getElementById('addAccountForm').reset();
    modal.show();
}

function saveNewAccount() {
    var form = document.getElementById('addAccountForm');
    var formData = new FormData(form);
    
    var data = {
        code: formData.get('code'),
        name: formData.get('name'),
        type: formData.get('type'),
        is_active: formData.get('is_active') ? true : false
    };
    
    fetch('/security/ledger-control/accounts/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
            loadAccounts();
        } else {
            alert('âŒ ÙØ´Ù„: ' + result.error);
        }
    })
    .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function showEditAccountModal(id, code, name, type, isActive) {
    document.getElementById('edit_account_id').value = id;
    document.getElementById('edit_code').value = code;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_type').value = type;
    document.getElementById('edit_is_active').checked = isActive;
    
    var modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
    modal.show();
}

function saveEditAccount() {
    var id = document.getElementById('edit_account_id').value;
    var name = document.getElementById('edit_name').value;
    var isActive = document.getElementById('edit_is_active').checked;
    
    var data = {
        name: name,
        is_active: isActive
    };
    
    fetch('/security/ledger-control/accounts/' + id + '/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            bootstrap.Modal.getInstance(document.getElementById('editAccountModal')).hide();
            loadAccounts();
        } else {
            alert('âŒ ÙØ´Ù„: ' + result.error);
        }
    })
    .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

// ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙ‚Ø¯Ù…Ø©
function recalculateBalances() {
    if (!confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±ØµØ¯Ø©ØŸ\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹...')) return;
    
    fetch('/security/ledger-control/recalculate-balances', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('âœ… ' + data.message);
            } else {
                alert('âŒ ÙØ´Ù„: ' + data.error);
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function syncChecks() {
    if (!confirm('Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù…Ø¹ Ø§Ù„Ø´ÙŠÙƒØ§ØªØŸ')) return;
    
    fetch('/security/ledger-control/sync-checks', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('âœ… ' + data.message);
            } else {
                alert('âŒ ÙØ´Ù„: ' + data.error);
            }
        })
        .catch(function(e) { alert('Ø®Ø·Ø£: ' + e.message); });
}

function loadStats() {
    var container = document.getElementById('statsContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
    
    fetch('/security/ledger-control/statistics')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var html = '<div class="row">';
                
                // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                html += '<div class="col-md-3"><div class="card bg-primary text-white"><div class="card-body text-center">';
                html += '<h3>' + data.accounts.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</small>';
                html += '<hr><p class="mb-0">' + data.accounts.active + ' Ù†Ø´Ø·</p></div></div></div>';
                
                // Ø§Ù„Ù‚ÙŠÙˆØ¯
                html += '<div class="col-md-3"><div class="card bg-success text-white"><div class="card-body text-center">';
                html += '<h3>' + data.batches.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙˆØ¯</small>';
                html += '<hr><p class="mb-0">' + data.batches.posted + ' Ù…Ù†Ø´ÙˆØ±</p></div></div></div>';
                
                // Ø§Ù„Ø¯ÙØ¹Ø§Øª
                html += '<div class="col-md-3"><div class="card bg-info text-white"><div class="card-body text-center">';
                html += '<h3>' + data.payments.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª</small>';
                html += '<hr><p class="mb-0">' + data.payments.completed + ' Ù…ÙƒØªÙ…Ù„Ø©</p></div></div></div>';
                
                // Ø§Ù„Ø´ÙŠÙƒØ§Øª
                html += '<div class="col-md-3"><div class="card bg-warning text-white"><div class="card-body text-center">';
                html += '<h3>' + data.checks.total + '</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙŠÙƒØ§Øª</small>';
                html += '<hr><p class="mb-0">' + data.checks.pending + ' Ù…Ø¹Ù„Ù‚Ø©</p></div></div></div>';
                
                html += '</div>';
                
                // Ø§Ù„Ù‚ÙŠÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†Ø©
                if (data.health.imbalanced_entries > 0) {
                    html += '<div class="alert alert-warning mt-3"><i class="fas fa-exclamation-triangle me-2"></i>';
                    html += '<strong>ØªØ­Ø°ÙŠØ±:</strong> ÙŠÙˆØ¬Ø¯ ' + data.health.imbalanced_entries + ' Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†!</div>';
                } else {
                    html += '<div class="alert alert-success mt-3"><i class="fas fa-check-circle me-2"></i>';
                    html += '<strong>Ù…Ù…ØªØ§Ø²:</strong> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù…ØªÙˆØ§Ø²Ù†Ø©!</div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£: ' + data.error + '</div>';
            }
        })
        .catch(function(e) { 
            container.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£: ' + e.message + '</div>';
        });
}

// Ø§Ù„ØªØ§Ø¨Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… DOM loaded - initializing ledger-control');
    
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£ÙˆÙ„
    document.getElementById('tab-accounts').style.display = 'block';
    document.getElementById('tab-entries').style.display = 'none';
    document.getElementById('tab-batches').style.display = 'none';
    document.getElementById('tab-tools').style.display = 'none';
    
    // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ ØªØ§Ø¨ ÙÙˆØ±Ø§Ù‹
    console.log('â³ Loading first tab (accounts)...');
    setTimeout(function() {
        loadAccounts();
    }, 100);
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
    var tabs = document.querySelectorAll('#controlTabs .nav-link');
    console.log('ğŸ“‘ Found ' + tabs.length + ' tabs');
    
    tabs.forEach(function(tab) {
        console.log('ğŸ”— Attaching event to tab:', tab.getAttribute('href'));
        
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            var target = this.getAttribute('href');
            console.log('ğŸ“ Tab clicked:', target);
            
            // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.querySelectorAll('#controlTabs .nav-link').forEach(function(link) {
                link.classList.remove('active');
            });
            this.classList.add('active');
            
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.getElementById('tab-accounts').style.display = 'none';
            document.getElementById('tab-entries').style.display = 'none';
            document.getElementById('tab-batches').style.display = 'none';
            document.getElementById('tab-tools').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            var targetId = target.replace('#', '');
            var activePane = document.getElementById(targetId);
            if (activePane) {
                activePane.style.display = 'block';
                console.log('âœ… Showing pane:', target);
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (target === '#tab-accounts') {
                loadAccounts();
            } else if (target === '#tab-entries') {
                loadEntries();
            } else if (target === '#tab-batches') {
                loadBatches();
            }
        });
    });
    
    console.log('âœ… Event listeners attached');
});
</script>
{% endblock %}
