{% extends 'warehouses/base.html' %}
{% set is_edit = shipment is not none %}
{% block page_title %}{{ is_edit and 'ØªØ¹Ø¯ÙŠÙ„ Ø´Ø­Ù†Ø©' or 'Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©' }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shipments.css') }}">
  <style>
    .is-valid { border-color: #28a745 !important; }
    .is-invalid { border-color: #dc3545 !important; }
    .invalid-feedback { display:block; font-size:0.85rem; }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Tabs */
    .nav-tabs .nav-link {
      border-radius: 10px 10px 0 0;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
      background: #f8f9fa;
    }
    
    .tab-content {
      border: 2px solid #e9ecef;
      border-radius: 0 15px 15px 15px;
      padding: 20px;
      background: white;
      min-height: 300px;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .stat-card-mini {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .stat-card-mini h3 {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }
    
    .stat-card-mini p {
      font-size: 0.85rem;
      margin: 0;
      opacity: 0.9;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ù†ÙˆØ¯ */
    .shipment-item {
      background: #f8f9fa;
      border-left: 4px solid #667eea !important;
      transition: all 0.3s ease;
    }
    
    .shipment-item:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transform: translateX(5px);
    }
    
    .shipment-partner {
      background: #fff9e6;
      border-left: 4px solid #ffc107 !important;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
    }
    
    .required-field::after {
      content: " *";
      color: #dc3545;
      font-weight: bold;
    }
  </style>
{% endblock %}

{% macro render_field(field, kwargs={}) -%}
  {{ field(**kwargs) }}
  {% if field.errors %}
    <div class="invalid-feedback d-block">{{ field.errors|join(', ') }}</div>
  {% endif %}
{%- endmacro %}

{% macro item_row(sf, idx) -%}
<div class="shipment-item border rounded p-2 mb-2" data-index="{{ idx }}">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      {{ sf.product_id.label(class="form-label") }}
      {{ render_field(sf.product_id, {
        'id': sf.product_id.id,
        'class': 'select2 form-control select2-ajax',
        'data-url': url_for('api.products'),
        'data-placeholder': 'Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù'
      }) }}
      <small class="text-muted">Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø´Ø­Ù†Ù‡Ø§</small>
    </div>
    <div class="col-md-3">
      {{ sf.warehouse_id.label(class="form-label") }}
      {{ render_field(sf.warehouse_id, {
        'id': sf.warehouse_id.id,
        'class': 'select2 form-control select2-ajax',
        'data-url': url_for('api.search_warehouses'),
        'data-placeholder': 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù†',
        'data-params': '{"active_only":"1"}'
      }) }}
      <small class="text-muted">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ³ØªÙ„Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯</small>
    </div>
    <div class="col-md-2">
      {{ sf.quantity.label(class="form-label") }}
      {{ render_field(sf.quantity, {
        'id': sf.quantity.id,
        'class': 'form-control item-qty',
        'type': 'number', 'min': '1', 'required': True,
        'placeholder': 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'
      }) }}
      <small class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</small>
    </div>
    <div class="col-md-2">
      {{ sf.unit_cost.label(class="form-label") }}
      {{ render_field(sf.unit_cost, {
        'id': sf.unit_cost.id,
        'class': 'form-control item-cost',
        'type': 'number', 'step': '0.01', 'required': True,
        'placeholder': 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©'
      }) }}
      <small class="text-muted">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©</small>
    </div>
    <div class="col-md-1 text-end">
      <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item">Ø­Ø°Ù</button>
    </div>
    <div class="col-12 mt-1">
      {{ sf.declared_value.label(class="form-label") }}
      {{ render_field(sf.declared_value, {
        'id': sf.declared_value.id,
        'class': 'form-control item-declared',
        'type': 'number', 'step': '0.01',
        'placeholder': 'Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¥ÙØµØ§Ø­'
      }) }}
      <small class="text-muted">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ù„Ù†Ø© Ù„Ù„Ø¬Ù…Ø§Ø±Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ = Ø§Ù„ÙƒÙ…ÙŠØ© Ã— Ø§Ù„Ø³Ø¹Ø±)</small>
    </div>
    {% if sf.notes is defined %}
    <div class="col-12 mt-1">
      {{ sf.notes.label(class="form-label") }}
      {{ render_field(sf.notes, {'id': sf.notes.id, 'class': 'form-control', 'placeholder': 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¨Ù†Ø¯'}) }}
      <small class="text-muted">Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
    </div>
    {% endif %}
  </div>
</div>
{%- endmacro %}

{% macro partner_row(pf, idx) -%}
<div class="shipment-partner border rounded p-2 mb-2" data-index="{{ idx }}">
  <div class="row g-2">
    <div class="col-md-4">
      {{ pf.partner_id.label(class="form-label") }}
      {{ render_field(pf.partner_id, {
        'id': pf.partner_id.id,
        'class': 'select2 form-control select2-ajax',
        'data-url': url_for('api.search_partners'),
        'data-placeholder': 'Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙŠÙƒ',
        'data-new-url': url_for('vendors_bp.partners_create'),
        'data-init-id': pf.partner_id.data.id if pf.partner_id.data is not string and pf.partner_id.data and pf.partner_id.data.id is defined else (pf.partner_id.data if pf.partner_id.data else ''),
        'data-init-text': pf.partner_id.data.name if pf.partner_id.data is not string and pf.partner_id.data and pf.partner_id.data.name is defined else ''
      }) }}
      <small class="text-muted">Ø§Ù„Ø´Ø±ÙŠÙƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø­Ù†Ø©</small>
    </div>
    <div class="col-md-2">
      {{ pf.share_percentage.label(class="form-label") }}
      {{ render_field(pf.share_percentage, {
        'id': pf.share_percentage.id, 'class': 'form-control',
        'type': 'number', 'step': '0.01',
        'placeholder': 'Ù†Ø³Ø¨Ø© Ù…Ù† 100'
      }) }}
      <small class="text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø©</small>
    </div>
    <div class="col-md-2">
      {{ pf.share_amount.label(class="form-label") }}
      {{ render_field(pf.share_amount, {
        'id': pf.share_amount.id, 'class': 'form-control',
        'type': 'number', 'step': '0.01',
        'placeholder': 'Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª'
      }) }}
      <small class="text-muted">Ø£Ùˆ Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø³Ø¨Ø©</small>
    </div>
    <div class="col-md-4 text-end">
      <a href="{{ url_for('vendors_bp.partners_create') }}" target="_blank" class="btn btn-sm btn-outline-secondary">+ Ø´Ø±ÙŠÙƒ Ø¬Ø¯ÙŠØ¯</a>
      <button type="button" class="btn btn-sm btn-outline-danger btn-remove-partner">Ø­Ø°Ù</button>
    </div>

    {% if pf.identity_number is defined %}
    <div class="col-md-4 mt-2">
      {{ pf.identity_number.label(class="form-label") }}
      {{ render_field(pf.identity_number, {'id': pf.identity_number.id, 'class': 'form-control', 'placeholder': 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©'}) }}
      <small class="text-muted">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</small>
    </div>
    {% endif %}
    {% if pf.phone_number is defined %}
    <div class="col-md-4 mt-2">
      {{ pf.phone_number.label(class="form-label") }}
      {{ render_field(pf.phone_number, {'id': pf.phone_number.id, 'class': 'form-control', 'placeholder': 'Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø±ÙŠÙƒ'}) }}
      <small class="text-muted">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø´Ø±ÙŠÙƒ Ù„Ù„ØªÙˆØ§ØµÙ„</small>
    </div>
    {% endif %}
    {% if pf.address is defined %}
    <div class="col-md-4 mt-2">
      {{ pf.address.label(class="form-label") }}
      {{ render_field(pf.address, {'id': pf.address.id, 'class': 'form-control', 'placeholder': 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'}) }}
      <small class="text-muted">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙƒÙ† Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„</small>
    </div>
    {% endif %}
    {% if pf.unit_price_before_tax is defined %}
    <div class="col-md-4 mt-2">
      {{ pf.unit_price_before_tax.label(class="form-label") }}
      {{ render_field(pf.unit_price_before_tax, {
        'id': pf.unit_price_before_tax.id, 'class': 'form-control',
        'type': 'number', 'step': '0.01', 'placeholder': 'Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©'
      }) }}
      <small class="text-muted">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</small>
    </div>
    {% endif %}
    {% if pf.expiry_date is defined %}
    <div class="col-md-4 mt-2">
      {{ pf.expiry_date.label(class="form-label") }}
      {{ render_field(pf.expiry_date, {
        'id': pf.expiry_date.id, 'class': 'form-control',
        'type': 'date', 'dir': 'ltr', 'placeholder': 'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡'
      }) }}
      <small class="text-muted">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
    </div>
    {% endif %}
    {% if pf.notes is defined %}
    <div class="col-md-4 mt-2">
      {{ pf.notes.label(class="form-label") }}
      {{ render_field(pf.notes, {'id': pf.notes.id, 'class': 'form-control', 'placeholder': 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ'}) }}
      <small class="text-muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø´Ø±ÙŠÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
    </div>
    {% endif %}
  </div>
</div>
{%- endmacro %}

{% block content %}
<form method="POST" id="shipment-form" novalidate autocomplete="off">
  {{ form.hidden_tag() }}

  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
  <div class="row mb-3">
    <div class="col-md-3">
      <div class="stat-card-mini">
        <h3 id="summary-items-count">0</h3>
        <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card-mini">
        <h3 id="summary-items-qty">0</h3>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card-mini">
        <h3 id="summary-items-value">0.00</h3>
        <p>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card-mini">
        <h3 id="summary-total-value">0.00</h3>
        <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs" id="shipmentTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info-panel" role="tab">
        <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø©
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="items-tab" data-toggle="tab" href="#items-panel" role="tab">
        <i class="fas fa-boxes"></i> Ø§Ù„Ø¨Ù†ÙˆØ¯ <span class="badge badge-primary" id="items-badge">0</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="costs-tab" data-toggle="tab" href="#costs-panel" role="tab">
        <i class="fas fa-dollar-sign"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆØ§Ù„Ø¶Ø±Ø§Ø¦Ø¨
      </a>
    </li>
    <li class="nav-item" id="partners-tab-item" style="display:none;">
      <a class="nav-link" id="partners-tab" data-toggle="tab" href="#partners-panel" role="tab">
        <i class="fas fa-handshake"></i> Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ <span class="badge badge-warning" id="partners-badge">0</span>
      </a>
    </li>
  </ul>

  <!-- Tabs Content -->
  <div class="tab-content" id="shipmentTabsContent">
    
    <!-- Tab 1: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø© -->
    <div class="tab-pane fade show active" id="info-panel" role="tabpanel">
      <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle"></i>
        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©:</strong> Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø© ÙŠØªÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹. Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙˆØ¬Ù‡Ø© ÙˆØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†Ø©.
      </div>
      
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label required-field">Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø©</label>
          {{ render_field(form.shipment_number, {'id': form.shipment_number.id, 'class': 'form-control', 'placeholder': 'ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ'}) }}
          <small class="text-muted">Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</small>
        </div>
        <div class="col-md-3">
          <label class="form-label required-field">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</label>
          {{ render_field(form.shipment_date, {'id': form.shipment_date.id, 'class': 'form-control dtp', 'dir': 'ltr'}) }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</label>
          {{ render_field(form.expected_arrival, {'id': form.expected_arrival.id, 'class': 'form-control dtp', 'dir': 'ltr'}) }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ</label>
          {{ render_field(form.actual_arrival, {'id': form.actual_arrival.id, 'class': 'form-control dtp', 'dir': 'ltr'}) }}
        </div>
        
        <div class="col-md-4">
          <label class="form-label">Ø§Ù„Ù…Ù†Ø´Ø£</label>
          {{ render_field(form.origin, {'id': form.origin.id, 'class': 'form-control', 'placeholder': 'Ø¨Ù„Ø¯ Ø£Ùˆ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø´Ø£'}) }}
          <small class="text-muted">Ù…Ù† Ø£ÙŠÙ† ØªØ£ØªÙŠ Ø§Ù„Ø´Ø­Ù†Ø©ØŸ</small>
        </div>
        <div class="col-md-4">
          <label class="form-label required-field">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙˆØ¬Ù‡Ø©</label>
          {{ render_field(form.destination_id, {
            'id': form.destination_id.id,
            'class': 'select2 form-control select2-ajax',
            'data-url': url_for('api.search_warehouses'),
            'data-placeholder': 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…',
            'data-params': '{"active_only":"1"}'
          }) }}
          <small class="text-muted">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙŠ Ø³ØªØµÙ„ Ø¥Ù„ÙŠÙ‡ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù†Ø©</label>
          {{ render_field(form.status, {'id': form.status.id, 'class': 'form-select'}) }}
        </div>
        
        <div class="col-md-3">
          <label class="form-label">Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„</label>
          {{ render_field(form.carrier, {'id': form.carrier.id, 'class': 'form-control', 'placeholder': 'Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ù‚Ù„'}) }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹</label>
          {{ render_field(form.tracking_number, {'id': form.tracking_number.id, 'class': 'form-control', 'placeholder': 'Tracking Number', 'dir': 'ltr'}) }}
        </div>
        {% if form.currency is defined %}
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          {{ render_field(form.currency, {'id': form.currency.id, 'class': 'form-select'}) }}
        </div>
        {% endif %}
        
        <div class="col-12">
          <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          {{ render_field(form.notes, {'id': form.notes.id, 'class': 'form-control', 'rows': '3', 'placeholder': 'Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ù† Ø§Ù„Ø´Ø­Ù†Ø©'}) }}
        </div>
      </div>
    </div>

    <!-- Tab 2: Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ø­Ù†Ø© -->
    <div class="tab-pane fade" id="items-panel" role="tabpanel">
      <div class="alert alert-info mb-3">
        <i class="fas fa-boxes"></i>
        <strong>Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ø­Ù†Ø©:</strong> Ø£Ø¶Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ø§Ù„ÙƒÙ…ÙŠØ§ØªØŒ ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©.
      </div>
      
      <div class="d-flex gap-2 mb-3">
        <input type="text" id="barcode-input" class="form-control" placeholder="ğŸ” Ø³ÙƒØ§Ù† Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¨Ø§Ù„Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" style="max-width: 400px;">
        <button type="button" class="btn btn-primary" id="add-item">
          <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯
        </button>
      </div>
      
      <div id="items-wrapper"
           data-index="{{ form.items|length }}"
           data-url-products="{{ url_for('api.products') }}"
           data-url-warehouses="{{ url_for('api.search_warehouses') }}">
        {% for sf in form.items %}
          {{ item_row(sf, loop.index0) }}
        {% else %}
          <div class="text-center text-muted py-5" id="no-items-msg">
            <i class="fas fa-box-open fa-3x mb-3"></i>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡.</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Tab 3: Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆØ§Ù„Ø¶Ø±Ø§Ø¦Ø¨ -->
    <div class="tab-pane fade" id="costs-panel" role="tabpanel">
      <div class="alert alert-info mb-3">
        <i class="fas fa-calculator"></i>
        <strong>Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ:</strong> Ø£Ø¯Ø®Ù„ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©. Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
      </div>
      
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
          {{ render_field(form.value_before, {'id': form.value_before.id, 'class': 'form-control', 'type': 'number', 'step': '0.01', 'readonly': True}) }}
          <small class="text-muted">Ù…Ø¬Ù…ÙˆØ¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø¶Ø§ÙØ©</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†</label>
          {{ render_field(form.shipping_cost, {'id': form.shipping_cost.id, 'class': 'form-control cost-field', 'type': 'number', 'step': '0.01', 'placeholder': '0.00'}) }}
          <small class="text-muted">ØªÙƒÙ„ÙØ© Ù†Ù‚Ù„ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ</label>
          {{ render_field(form.customs, {'id': form.customs.id, 'class': 'form-control cost-field', 'type': 'number', 'step': '0.01', 'placeholder': '0.00'}) }}
          <small class="text-muted">Ø±Ø³ÙˆÙ… Ø¬Ù…Ø±ÙƒÙŠØ©</small>
        </div>
        
        <div class="col-md-4">
          <label class="form-label">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (VAT)</label>
          {{ render_field(form.vat, {'id': form.vat.id, 'class': 'form-control cost-field', 'type': 'number', 'step': '0.01', 'placeholder': '0.00'}) }}
          <small class="text-muted">Ø¶Ø±ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ø§Ù„ØªØ£Ù…ÙŠÙ†</label>
          {{ render_field(form.insurance, {'id': form.insurance.id, 'class': 'form-control cost-field', 'type': 'number', 'step': '0.01', 'placeholder': '0.00'}) }}
          <small class="text-muted">ØªØ£Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø­Ù†Ø©</small>
        </div>
        <div class="col-md-4">
          <label class="form-label"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</strong></label>
          {{ render_field(form.total_value, {'id': form.total_value.id, 'class': 'form-control', 'type': 'number', 'step': '0.01', 'readonly': True, 'style': 'font-weight: bold; font-size: 1.1rem; background: #e9ecef;'}) }}
          <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø© Ø´Ø§Ù…Ù„Ø§Ù‹ ÙƒÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</small>
        </div>
      </div>
      
      <div class="alert alert-warning mt-3">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø­Ù†Ø© (ARRIVED)ØŒ Ø³ØªÙˆØ²Ø¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¨Ù†Ø³Ø¨Ø© Ù‚ÙŠÙ…ØªÙ‡Ø§.
      </div>
    </div>

    <!-- Tab 4: Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ -->
    <div class="tab-pane fade" id="partners-panel" role="tabpanel">
      <div class="alert alert-warning mb-3">
        <i class="fas fa-handshake"></i>
        <strong>Ø´Ø±ÙƒØ§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø©:</strong> ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù…Ù† Ù†ÙˆØ¹ "Ø´Ø±ÙŠÙƒ". Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ 100%.
      </div>
      
      <div class="mb-3">
        <button type="button" class="btn btn-warning" id="add-partner">
          <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠÙƒ
        </button>
        <div class="float-end">
          <span class="badge badge-info" id="partners-total-pct">0%</span>
          <span class="text-muted">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨</span>
        </div>
      </div>
      
      <div id="partners-wrapper"
           data-index="{{ form.partners|length }}"
           data-url-partners="{{ url_for('api.search_partners') }}"
           data-new-url-partners="{{ url_for('vendors_bp.partners_create') }}">
        {% for pf in form.partners %}
          {{ partner_row(pf, loop.index0) }}
        {% else %}
          <div class="text-center text-muted py-5" id="no-partners-msg">
            <i class="fas fa-users fa-3x mb-3"></i>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Ø¡ Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø´Ø±ÙŠÙƒØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø­Ù†Ø© Ù…Ø´ØªØ±ÙƒØ©.</p>
          </div>
        {% endfor %}
      </div>
      
      <div class="alert alert-danger mt-3" id="partners-validation-alert" style="display: none;">
        <i class="fas fa-times-circle"></i>
        <strong>Ø®Ø·Ø£:</strong> <span id="partners-validation-msg"></span>
      </div>
    </div>
    
  </div>

  <div class="mt-3">
    <button class="btn btn-primary">{{ is_edit and 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø­Ù†Ø©' or 'Ø­ÙØ¸ Ø§Ù„Ø´Ø­Ù†Ø©' }}</button>
    <a class="btn btn-secondary" href="{{ url_for('shipments_bp.list_shipments') }}">Ø¹ÙˆØ¯Ø©</a>
  </div>
</form>

<template id="item-row-template">
  <div class="shipment-item border rounded p-2 mb-2" data-index="__INDEX__">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label" for="items-__INDEX__-product_id">Ø§Ù„ØµÙ†Ù</label>
        <select name="items-__INDEX__-product_id" id="items-__INDEX__-product_id"
                class="select2 form-control select2-ajax" data-placeholder="Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù"></select>
        <small class="text-muted">Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø´Ø­Ù†Ù‡Ø§</small>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="items-__INDEX__-warehouse_id">Ø§Ù„Ù…Ø®Ø²Ù†</label>
        <select name="items-__INDEX__-warehouse_id" id="items-__INDEX__-warehouse_id"
                class="select2 form-control select2-ajax" data-placeholder="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù†"
                data-params='{"active_only":"1"}'></select>
        <small class="text-muted">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ³ØªÙ„Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯</small>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="items-__INDEX__-quantity">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input type="number" min="1" required name="items-__INDEX__-quantity"
               id="items-__INDEX__-quantity" class="form-control item-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">
        <small class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</small>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="items-__INDEX__-unit_cost">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <input type="number" step="0.01" required name="items-__INDEX__-unit_cost"
               id="items-__INDEX__-unit_cost" class="form-control item-cost" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©">
        <small class="text-muted">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©</small>
      </div>
      <div class="col-md-1 text-end">
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item">Ø­Ø°Ù</button>
      </div>
      <div class="col-12 mt-1">
        <label class="form-label" for="items-__INDEX__-declared_value">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ù„Ù†Ø©</label>
        <input type="number" step="0.01" name="items-__INDEX__-declared_value"
               id="items-__INDEX__-declared_value" class="form-control item-declared" placeholder="Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¥ÙØµØ§Ø­">
        <small class="text-muted">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ù„Ù†Ø© Ù„Ù„Ø¬Ù…Ø§Ø±Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ = Ø§Ù„ÙƒÙ…ÙŠØ© Ã— Ø§Ù„Ø³Ø¹Ø±)</small>
      </div>
    </div>
  </div>
</template>

<template id="partner-row-template">
  <div class="shipment-partner border rounded p-2 mb-2" data-index="__INDEX__">
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label" for="partners-__INDEX__-partner_id">Ø§Ù„Ø´Ø±ÙŠÙƒ</label>
        <select name="partners-__INDEX__-partner_id"
                id="partners-__INDEX__-partner_id"
                class="select2 form-control select2-ajax"
                data-placeholder="Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙŠÙƒ"
                data-url="{{ url_for('api.search_partners') }}"
                data-new-url="{{ url_for('vendors_bp.partners_create') }}"></select>
        <small class="text-muted">Ø§Ù„Ø´Ø±ÙŠÙƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø­Ù†Ø©</small>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="partners-__INDEX__-share_percentage">Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ %</label>
        <input type="number" step="0.01"
               name="partners-__INDEX__-share_percentage"
               id="partners-__INDEX__-share_percentage"
               class="form-control" placeholder="Ù†Ø³Ø¨Ø© Ù…Ù† 100">
        <small class="text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø©</small>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="partners-__INDEX__-share_amount">Ø­ØµØ© Ø§Ù„Ø´Ø±ÙŠÙƒ</label>
        <input type="number" step="0.01"
               name="partners-__INDEX__-share_amount"
               id="partners-__INDEX__-share_amount"
               class="form-control" placeholder="Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª">
        <small class="text-muted">Ø£Ùˆ Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø³Ø¨Ø©</small>
      </div>
      <div class="col-md-4 text-end">
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-partner">Ø­Ø°Ù</button>
      </div>

      <div class="col-md-4 mt-2">
        <label class="form-label" for="partners-__INDEX__-identity_number">Ø§Ù„Ù‡ÙˆÙŠØ©</label>
        <input type="text"
               name="partners-__INDEX__-identity_number"
               id="partners-__INDEX__-identity_number"
               class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©">
        <small class="text-muted">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</small>
      </div>
      <div class="col-md-4 mt-2">
        <label class="form-label" for="partners-__INDEX__-phone_number">Ø§Ù„Ø¬ÙˆØ§Ù„</label>
        <input type="text"
               name="partners-__INDEX__-phone_number"
               id="partners-__INDEX__-phone_number"
               class="form-control" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø±ÙŠÙƒ">
        <small class="text-muted">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø´Ø±ÙŠÙƒ Ù„Ù„ØªÙˆØ§ØµÙ„</small>
      </div>
      <div class="col-md-4 mt-2">
        <label class="form-label" for="partners-__INDEX__-address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input type="text"
               name="partners-__INDEX__-address"
               id="partners-__INDEX__-address"
               class="form-control" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <small class="text-muted">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙƒÙ† Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„</small>
      </div>
      <div class="col-md-4 mt-2">
        <label class="form-label" for="partners-__INDEX__-unit_price_before_tax">Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
        <input type="number" step="0.01"
               name="partners-__INDEX__-unit_price_before_tax"
               id="partners-__INDEX__-unit_price_before_tax"
               class="form-control" placeholder="Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©">
        <small class="text-muted">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</small>
      </div>
      <div class="col-md-4 mt-2">
        <label class="form-label" for="partners-__INDEX__-expiry_date">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡</label>
        <input type="date" dir="ltr"
               name="partners-__INDEX__-expiry_date"
               id="partners-__INDEX__-expiry_date"
               class="form-control" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡">
        <small class="text-muted">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
      </div>
      <div class="col-md-4 mt-2">
        <label class="form-label" for="partners-__INDEX__-notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <input type="text"
               name="partners-__INDEX__-notes"
               id="partners-__INDEX__-notes"
               class="form-control" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ">
        <small class="text-muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø´Ø±ÙŠÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
      </div>
    </div>
  </div>
</template>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
  <script src="{{ url_for('static', filename='js/shipments.js') }}"></script>

  <div class="modal fade" id="partnerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <form id="partnerForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠÙƒ Ø¬Ø¯ÙŠØ¯</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="partner-name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙŠÙƒ</label>
              <input type="text" class="form-control" name="name" id="partner-name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙŠÙƒ">
            </div>
            <div class="mb-3">
              <label for="partner-phone" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
              <input type="text" class="form-control" name="phone" id="partner-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
            </div>
            <div class="mb-3">
              <label for="partner-identity" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
              <input type="text" class="form-control" name="identity_number" id="partner-identity" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="productModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <form id="productForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="product-name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
              <input type="text" class="form-control" name="name" id="product-name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            </div>
            <div class="mb-3">
              <label for="product-barcode" class="form-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
              <input type="text" class="form-control" name="barcode" id="product-barcode" placeholder="Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="warehouseModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <form id="warehouseForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="warehouse-name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†</label>
              <input type="text" class="form-control" name="name" id="warehouse-name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†">
            </div>
            <div class="mb-3">
              <label for="warehouse-location" class="form-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
              <input type="text" class="form-control" name="location" id="warehouse-location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const $ = window.jQuery;
    
    // === Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ===
    function parseNum(v) {
      v = (v ?? '').toString().trim().replace(',', '.');
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }
    
    function fmt2(n) {
      return (Number(n || 0)).toFixed(2);
    }
    
    // === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ===
    function updateSummaryStats() {
      const itemsWrap = document.getElementById('items-wrapper');
      const rows = itemsWrap ? itemsWrap.querySelectorAll('.shipment-item') : [];
      
      let cnt = 0, qty = 0, itemsValue = 0;
      rows.forEach(r => {
        const q = parseNum(r.querySelector('.item-qty')?.value || '0');
        const c = parseNum(r.querySelector('.item-cost')?.value || '0');
        if (q > 0) {
          cnt += 1;
          qty += q;
          itemsValue += q * c;
        }
      });
      
      // Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
      const shipping = parseNum(document.getElementById('shipping_cost')?.value || 0);
      const customs = parseNum(document.getElementById('customs')?.value || 0);
      const vat = parseNum(document.getElementById('vat')?.value || 0);
      const insurance = parseNum(document.getElementById('insurance')?.value || 0);
      const totalValue = itemsValue + shipping + customs + vat + insurance;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
      document.getElementById('summary-items-count').textContent = cnt;
      document.getElementById('summary-items-qty').textContent = qty;
      document.getElementById('summary-items-value').textContent = fmt2(itemsValue);
      document.getElementById('summary-total-value').textContent = fmt2(totalValue);
      
      // ØªØ­Ø¯ÙŠØ« Badges
      document.getElementById('items-badge').textContent = cnt;
    }
    
    // === ØªØ­Ø¯ÙŠØ« badges Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ ===
    function updatePartnersBadge() {
      const partnersWrap = document.getElementById('partners-wrapper');
      const partnerRows = partnersWrap ? partnersWrap.querySelectorAll('.shipment-partner') : [];
      let partnerCnt = 0;
      partnerRows.forEach(r => {
        const pid = $(r).find('[name$="-partner_id"]').val();
        if (pid) partnerCnt++;
      });
      document.getElementById('partners-badge').textContent = partnerCnt;
    }
    
    // === Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ù†Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ ===
    function calculatePartnersTotal() {
      let sum = 0;
      document.querySelectorAll('#partners-wrapper [name$="-share_percentage"]').forEach(el => {
        sum += parseNum(el.value);
      });
      return sum;
    }
    
    // === ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù†Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ ===
    function updatePartnersValidation() {
      const sum = calculatePartnersTotal();
      const badge = document.getElementById('partners-total-pct');
      const alert = document.getElementById('partners-validation-alert');
      const msg = document.getElementById('partners-validation-msg');
      
      if (badge) {
        badge.textContent = fmt2(sum) + '%';
        badge.classList.remove('badge-info', 'badge-success', 'badge-danger');
        if (sum > 100) {
          badge.classList.add('badge-danger');
        } else if (sum === 100) {
          badge.classList.add('badge-success');
        } else {
          badge.classList.add('badge-info');
        }
      }
      
      if (sum > 100) {
        alert.style.display = 'block';
        msg.textContent = `Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ${fmt2(sum)}% ÙŠØªØ¬Ø§ÙˆØ² 100%. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.`;
      } else if (sum > 0 && sum < 100) {
        alert.style.display = 'block';
        msg.textContent = `Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ${fmt2(sum)}% Ø£Ù‚Ù„ Ù…Ù† 100%. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fmt2(100 - sum)}%`;
        alert.classList.remove('alert-danger');
        alert.classList.add('alert-warning');
      } else {
        alert.style.display = 'none';
        alert.classList.remove('alert-warning');
        alert.classList.add('alert-danger');
      }
    }
    
    // === Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ tab Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ===
    async function updatePartnersTabVisibility() {
      const destField = document.getElementById('destination_id') || document.querySelector('[name="destination_id"]');
      const warehouseId = $(destField).val() || destField?.value;
      
      const partnersTabItem = document.getElementById('partners-tab-item');
      
      if (!warehouseId) {
        partnersTabItem.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(`/api/warehouses/${warehouseId}/info`);
        if (!response.ok) {
          partnersTabItem.style.display = 'none';
          return;
        }
        
        const data = await response.json();
        const warehouseType = data.warehouse_type || data.type;
        
        if (warehouseType === 'PARTNER') {
          partnersTabItem.style.display = 'block';
        } else {
          partnersTabItem.style.display = 'none';
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ tab Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ØŒ Ù†Ù‚Ù„Ù‡ Ù„Ù„Ù€ tab Ø§Ù„Ø£ÙˆÙ„
          const activeTab = document.querySelector('#shipmentTabs .nav-link.active');
          if (activeTab && activeTab.id === 'partners-tab') {
            document.getElementById('info-tab').click();
          }
        }
      } catch (err) {
        console.error('Error checking warehouse type:', err);
        partnersTabItem.style.display = 'none';
      }
    }
    
    // === Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ shipments.js ===
    
    // Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯
    const itemsWrapper = document.getElementById('items-wrapper');
    if (itemsWrapper) {
      const observer = new MutationObserver(() => {
        updateSummaryStats();
      });
      observer.observe(itemsWrapper, { childList: true, subtree: true });
      
      itemsWrapper.addEventListener('input', () => {
        updateSummaryStats();
      });
    }
    
    // Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡
    const partnersWrapper = document.getElementById('partners-wrapper');
    if (partnersWrapper) {
      const observer = new MutationObserver(() => {
        updatePartnersBadge();
        updatePartnersValidation();
      });
      observer.observe(partnersWrapper, { childList: true, subtree: true });
      
      partnersWrapper.addEventListener('input', (e) => {
        if (e.target && e.target.name && e.target.name.endsWith('-share_percentage')) {
          updatePartnersValidation();
        }
        updatePartnersBadge();
      });
      
      $(partnersWrapper).on('select2:select select2:clear', '[name$="-partner_id"]', function() {
        updatePartnersBadge();
      });
    }
    
    // Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
    document.querySelectorAll('.cost-field').forEach(field => {
      field.addEventListener('input', () => {
        updateSummaryStats();
      });
    });
    
    // Ù†Ø±Ø§Ù‚Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙˆØ¬Ù‡Ø©
    const destField = document.getElementById('destination_id') || document.querySelector('[name="destination_id"]');
    if (destField) {
      $(destField).on('change select2:select', () => {
        updatePartnersTabVisibility();
      });
    }
    
    // === Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ===
    updateSummaryStats();
    updatePartnersBadge();
    updatePartnersValidation();
    updatePartnersTabVisibility();
    
    // === ØªØ­Ø³ÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ===
    const form = document.getElementById('shipment-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const sum = calculatePartnersTotal();
        const partnersWrap = document.getElementById('partners-wrapper');
        const partnerRows = partnersWrap ? partnersWrap.querySelectorAll('.shipment-partner') : [];
        let hasPartners = false;
        partnerRows.forEach(r => {
          const pid = $(r).find('[name$="-partner_id"]').val();
          if (pid) hasPartners = true;
        });
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø´Ø±ÙƒØ§Ø¡ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø³Ø¨
        if (hasPartners && sum > 100.000001) {
          e.preventDefault();
          updatePartnersValidation();
          
          // Ù†Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ tab Ø§Ù„Ø´Ø±ÙƒØ§Ø¡
          document.getElementById('partners-tab').click();
          
          // Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
          if (window.Swal) {
            Swal.fire({
              icon: 'error',
              title: 'Ø®Ø·Ø£ ÙÙŠ Ù†Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡',
              text: `Ù…Ø¬Ù…ÙˆØ¹ Ù†Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ ${fmt2(sum)}% ÙŠØªØ¬Ø§ÙˆØ² 100%. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.`,
              confirmButtonText: 'ÙÙ‡Ù…Øª'
            });
          } else {
            alert(`Ù…Ø¬Ù…ÙˆØ¹ Ù†Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ ${fmt2(sum)}% ÙŠØªØ¬Ø§ÙˆØ² 100%. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.`);
          }
          return false;
        }
      });
    }
  });
  </script>
{% endblock %}
