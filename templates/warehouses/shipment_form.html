{# templates/warehouses/shipment_form.html #}
{% extends 'warehouses/base.html' %}
{% block title %}شحنة جديدة{% endblock %}
{% block page_title %}شحنة جديدة{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shipments.css') }}">
{% endblock %}

{% macro item_row(sf, idx) -%}
<div class="shipment-item border rounded p-2 mb-2" data-index="{{ idx }}">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      {{ sf.product_id.label }} {{ sf.product_id(class_="select2 form-control") }}
    </div>
    <div class="col-md-3">
      {{ sf.warehouse_id.label }} {{ sf.warehouse_id(class_="select2 form-control") }}
    </div>
    <div class="col-md-2">
      {{ sf.quantity.label }} {{ sf.quantity(class="form-control item-qty", min="1") }}
    </div>
    <div class="col-md-2">
      {{ sf.unit_cost.label }} {{ sf.unit_cost(class="form-control item-cost", step="0.01") }}
    </div>
    <div class="col-md-1 text-end">
      <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item">حذف</button>
    </div>
    <div class="col-12 mt-1">
      {{ sf.declared_value.label }} {{ sf.declared_value(class="form-control item-declared", step="0.01") }}
    </div>
  </div>
</div>
{%- endmacro %}

{% macro partner_row(pf, idx) -%}
<div class="shipment-partner border rounded p-2 mb-2" data-index="{{ idx }}">
  <div class="row g-2">
    <div class="col-md-4">
      {{ pf.partner_id.label }} {{ pf.partner_id(class_="select2 form-control") }}
    </div>
    <div class="col-md-2">
      {{ pf.share_percentage.label }} {{ pf.share_percentage(class="form-control", step="0.01") }}
    </div>
    <div class="col-md-2">
      {{ pf.share_amount.label }} {{ pf.share_amount(class="form-control", step="0.01") }}
    </div>
    <div class="col-md-4 text-end">
      <a href="{{ url_for('vendors_bp.partners_create') }}" target="_blank" class="btn btn-sm btn-outline-secondary">+ شريك جديد</a>
      <button type="button" class="btn btn-sm btn-outline-danger btn-remove-partner">حذف</button>
    </div>

    <div class="col-md-4 mt-2">{{ pf.identity_number.label }} {{ pf.identity_number(class="form-control") }}</div>
    <div class="col-md-4 mt-2">{{ pf.phone_number.label }} {{ pf.phone_number(class="form-control") }}</div>
    <div class="col-md-4 mt-2">{{ pf.address.label }} {{ pf.address(class="form-control") }}</div>
    <div class="col-md-4 mt-2">{{ pf.unit_price_before_tax.label }} {{ pf.unit_price_before_tax(class="form-control", step="0.01") }}</div>
    <div class="col-md-4 mt-2">{{ pf.expiry_date.label }} {{ pf.expiry_date(class="form-control") }}</div>
    <div class="col-md-4 mt-2">{{ pf.notes.label }} {{ pf.notes(class="form-control") }}</div>
  </div>
</div>
{%- endmacro %}

{% block content %}
<form method="POST" id="shipment-form" novalidate>
  {{ form.hidden_tag() }}

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>بيانات الشحنة</span>
      <div class="small text-muted">رقم الشحنة سيُولد تلقائياً لو تركته فارغاً</div>
    </div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">{{ form.shipment_number.label }} {{ form.shipment_number(class="form-control") }}</div>
        <div class="col-md-3">{{ form.shipment_date.label }} {{ form.shipment_date(class="form-control") }}</div>
        <div class="col-md-3">{{ form.expected_arrival.label }} {{ form.expected_arrival(class="form-control") }}</div>
        <div class="col-md-3">{{ form.actual_arrival.label }} {{ form.actual_arrival(class="form-control") }}</div>
        <div class="col-md-4">{{ form.origin.label }} {{ form.origin(class="form-control") }}</div>
        <div class="col-md-4">{{ form.destination_id.label }} {{ form.destination_id(class_="select2 form-control") }}</div>
        <div class="col-md-2">{{ form.carrier.label }} {{ form.carrier(class="form-control") }}</div>
        <div class="col-md-2">{{ form.tracking_number.label }} {{ form.tracking_number(class="form-control") }}</div>
        <div class="col-md-3">{{ form.status.label }} {{ form.status(class="form-select") }}</div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>بنود الشحنة (القطع)</span>
      <div class="d-flex gap-2">
        <input type="text" id="barcode-input" class="form-control form-control-sm" placeholder="سكان باركود/بحث سريع">
        <button type="button" class="btn btn-sm btn-secondary" id="add-item">+ إضافة بند</button>
      </div>
    </div>
    <div class="card-body">
      <div id="items-wrapper" data-index="{{ form.items|length }}">
        {% for sf in form.items %}
          {{ item_row(sf, loop.index0) }}
        {% endfor %}
      </div>
      <div class="border-top pt-2 mt-2 d-flex justify-content-between">
        <div>إجمالي البنود: <strong id="items-count">0</strong></div>
        <div>إجمالي الكمية: <strong id="items-qty-sum">0</strong></div>
        <div>إجمالي التكلفة (تقديري): <strong id="items-cost-sum">0.00</strong></div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>شركاء الشحنة (اختياري)</span>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="add-partner">+ إضافة شريك</button>
      </div>
    </div>
    <div class="card-body">
      <div id="partners-wrapper" data-index="{{ form.partner_links|length }}">
        {% for pf in form.partner_links %}
          {{ partner_row(pf, loop.index0) }}
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">تكاليف الشحنة</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">{{ form.value_before.label }} {{ form.value_before(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.shipping_cost.label }} {{ form.shipping_cost(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.customs.label }} {{ form.customs(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.vat.label }} {{ form.vat(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.insurance.label }} {{ form.insurance(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.total_value.label }} {{ form.total_value(class="form-control", step="0.01") }}</div>
        <div class="col-md-6">{{ form.notes.label }} {{ form.notes(class="form-control") }}</div>
      </div>
    </div>
  </div>

{# ================= قوالب الصفوف الديناميكية ================= #}
<template id="item-row-template">
  <div class="item-row border rounded p-2 mb-2">
    <div class="row g-2 align-items-end">
      <div class="col-md-5">
        {{ form.items.entries[0].form.product_id.label }}
        {{ form.items.entries[0].form.product_id(class_="select2 form-control") }}
      </div>
      <div class="col-md-3">
        {{ form.items.entries[0].form.warehouse_id.label }}
        {{ form.items.entries[0].form.warehouse_id(class_="select2 form-control") }}
      </div>
      <div class="col-md-2">
        {{ form.items.entries[0].form.quantity.label }}
        {{ form.items.entries[0].form.quantity(class="form-control") }}
      </div>
      <div class="col-md-2">
        {{ form.items.entries[0].form.unit_cost.label }}
        {{ form.items.entries[0].form.unit_cost(class="form-control") }}
      </div>
      <div class="col-md-2 mt-2">
        {{ form.items.entries[0].form.declared_value.label }}
        {{ form.items.entries[0].form.declared_value(class="form-control") }}
      </div>
      <div class="col-md-2 mt-4">
        <button type="button" class="btn btn-sm btn-danger remove-item">حذف</button>
      </div>
    </div>
  </div>
</template>

<template id="partner-row-template">
  <div class="partner-row border rounded p-2 mb-2">
    <div class="row g-2">
      <div class="col-md-4">
        {{ form.partner_links.entries[0].form.partner_id.label }}
        {{ form.partner_links.entries[0].form.partner_id(class_="select2 form-control") }}
      </div>
      <div class="col-md-2">
        {{ form.partner_links.entries[0].form.share_percentage.label }}
        {{ form.partner_links.entries[0].form.share_percentage(class="form-control") }}
      </div>
      <div class="col-md-2">
        {{ form.partner_links.entries[0].form.share_amount.label }}
        {{ form.partner_links.entries[0].form.share_amount(class="form-control") }}
      </div>
      <div class="col-md-4">
        {{ form.partner_links.entries[0].form.identity_number.label }}
        {{ form.partner_links.entries[0].form.identity_number(class="form-control") }}
      </div>
      <div class="col-md-4 mt-2">
        {{ form.partner_links.entries[0].form.phone_number.label }}
        {{ form.partner_links.entries[0].form.phone_number(class="form-control") }}
      </div>
      <div class="col-md-4 mt-2">
        {{ form.partner_links.entries[0].form.address.label }}
        {{ form.partner_links.entries[0].form.address(class="form-control") }}
      </div>
      <div class="col-md-4 mt-2">
        {{ form.partner_links.entries[0].form.unit_price_before_tax.label }}
        {{ form.partner_links.entries[0].form.unit_price_before_tax(class="form-control") }}
      </div>
      <div class="col-md-4 mt-2">
        {{ form.partner_links.entries[0].form.expiry_date.label }}
        {{ form.partner_links.entries[0].form.expiry_date(class="form-control") }}
      </div>
      <div class="col-md-4 mt-2">
        {{ form.partner_links.entries[0].form.notes.label }}
        {{ form.partner_links.entries[0].form.notes(class="form-control") }}
      </div>
      <div class="col-md-2 mt-4">
        <button type="button" class="btn btn-sm btn-danger remove-partner">حذف</button>
      </div>
    </div>
  </div>
</template>

<div class="mt-3">
  <button class="btn btn-primary">حفظ الشحنة</button>
  <a class="btn btn-secondary" href="{{ url_for('shipments_bp.list_shipments') }}">عودة</a>
</div>
</form>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/shipments.js') }}"></script>
<script src="{{ url_for('static', filename='js/warehouses.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const itemsWrap   = document.getElementById('items-wrapper');
  const addItemBtn  = document.getElementById('add-item');
  const itemTpl     = document.getElementById('item-row-template');

  const partnersWrap  = document.getElementById('partners-wrapper');
  const addPartnerBtn = document.getElementById('add-partner');
  const partnerTpl    = document.getElementById('partner-row-template');

  function reindex(container, prefix){
    [...container.querySelectorAll('[name^="'+prefix+'-"]')].forEach((el, i) => {
      const parts = el.name.split('-');
      parts[1] = i.toString();
      el.name = parts.join('-');
      if (el.id){
        const idParts = el.id.split('-');
        idParts[1] = i.toString();
        el.id = idParts.join('-');
      }
    });
  }

  function initSelect2Within(el){
    if (window.jQuery && jQuery.fn.select2){
      jQuery(el).find('.select2').each(function(){
        const $el = jQuery(this);
        const endpoint = $el.dataset.endpoint;
        if (endpoint){
          $el.select2({
            width: '100%',
            placeholder: 'اختر...',
            allowClear: true,
            ajax: {
              delay: 250,
              url: endpoint,
              data: params => ({ q: params.term || '', limit: 20 }),
              processResults: (data) => {
                const arr = Array.isArray(data) ? data : (data.results || data.data || []);
                return { results: arr.map(x => ({ id: x.id, text: x.text || x.name || String(x.id) })) };
              }
            }
          });
        } else {
          $el.select2({ width: '100%' });
        }
      });
    }
  }

  if (addItemBtn && itemTpl && itemsWrap){
    addItemBtn.addEventListener('click', () => {
      const clone = document.importNode(itemTpl.content, true);
      itemsWrap.appendChild(clone);
      reindex(itemsWrap, 'items');
      initSelect2Within(itemsWrap.lastElementChild);
    });
    itemsWrap.addEventListener('click', (e) => {
      if (e.target.closest('.remove-item')){
        e.target.closest('.item-row').remove();
        reindex(itemsWrap, 'items');
      }
    });
  }

  if (addPartnerBtn && partnerTpl && partnersWrap){
    addPartnerBtn.addEventListener('click', () => {
      const clone = document.importNode(partnerTpl.content, true);
      partnersWrap.appendChild(clone);
      reindex(partnersWrap, 'partner_links');
      initSelect2Within(partnersWrap.lastElementChild);
    });
    partnersWrap.addEventListener('click', (e) => {
      if (e.target.closest('.remove-partner')){
        e.target.closest('.partner-row').remove();
        reindex(partnersWrap, 'partner_links');
      }
    });
  }

  initSelect2Within(document);
});
</script>
{% endblock %}
