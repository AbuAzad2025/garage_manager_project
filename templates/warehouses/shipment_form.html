{% extends 'warehouses/base.html' %}
{% set is_edit = shipment is not none %}
{% block title %}{{ is_edit and 'تعديل شحنة' or 'شحنة جديدة' }}{% endblock %}
{% block page_title %}{{ is_edit and 'تعديل شحنة' or 'شحنة جديدة' }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shipments.css') }}">
{% endblock %}

{% macro item_row(sf, idx) -%}
<div class="shipment-item border rounded p-2 mb-2" data-index="{{ idx }}">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">{{ sf.product_id.label }} {{ sf.product_id(class_="select2 form-control") }}</div>
    <div class="col-md-3">{{ sf.warehouse_id.label }} {{ sf.warehouse_id(class_="select2 form-control") }}</div>
    <div class="col-md-2">{{ sf.quantity.label }} {{ sf.quantity(class="form-control item-qty", min="1") }}</div>
    <div class="col-md-2">{{ sf.unit_cost.label }} {{ sf.unit_cost(class="form-control item-cost", step="0.01") }}</div>
    <div class="col-md-1 text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-remove-item">حذف</button></div>
    <div class="col-12 mt-1">{{ sf.declared_value.label }} {{ sf.declared_value(class="form-control item-declared", step="0.01") }}</div>
    {% if sf.notes is defined %}<div class="col-12 mt-1">{{ sf.notes.label }} {{ sf.notes(class="form-control") }}</div>{% endif %}
  </div>
</div>
{%- endmacro %}

{% macro partner_row(pf, idx) -%}
<div class="shipment-partner border rounded p-2 mb-2" data-index="{{ idx }}">
  <div class="row g-2">
    <div class="col-md-4">{{ pf.partner_id.label }} {{ pf.partner_id(class_="select2 form-control") }}</div>
    <div class="col-md-2">{{ pf.share_percentage.label }} {{ pf.share_percentage(class="form-control", step="0.01") }}</div>
    <div class="col-md-2">{{ pf.share_amount.label }} {{ pf.share_amount(class="form-control", step="0.01") }}</div>
    <div class="col-md-4 text-end">
      <a href="{{ url_for('vendors_bp.partners_create') }}" target="_blank" class="btn btn-sm btn-outline-secondary">+ شريك جديد</a>
      <button type="button" class="btn btn-sm btn-outline-danger btn-remove-partner">حذف</button>
    </div>
    {% if pf.identity_number is defined %}<div class="col-md-4 mt-2">{{ pf.identity_number.label }} {{ pf.identity_number(class="form-control") }}</div>{% endif %}
    {% if pf.phone_number is defined %}<div class="col-md-4 mt-2">{{ pf.phone_number.label }} {{ pf.phone_number(class="form-control") }}</div>{% endif %}
    {% if pf.address is defined %}<div class="col-md-4 mt-2">{{ pf.address.label }} {{ pf.address(class="form-control") }}</div>{% endif %}
    {% if pf.unit_price_before_tax is defined %}<div class="col-md-4 mt-2">{{ pf.unit_price_before_tax.label }} {{ pf.unit_price_before_tax(class="form-control", step="0.01") }}</div>{% endif %}
    {% if pf.expiry_date is defined %}<div class="col-md-4 mt-2">{{ pf.expiry_date.label }} {{ pf.expiry_date(class="form-control") }}</div>{% endif %}
    {% if pf.notes is defined %}<div class="col-md-4 mt-2">{{ pf.notes.label }} {{ pf.notes(class="form-control") }}</div>{% endif %}
  </div>
</div>
{%- endmacro %}

{% block content %}
<form method="POST" id="shipment-form" novalidate>
  {{ form.hidden_tag() }}

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>بيانات الشحنة</span>
      <div class="small text-muted">رقم الشحنة سيُولد تلقائياً لو تركته فارغاً</div>
    </div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">{{ form.shipment_number.label }} {{ form.shipment_number(class="form-control") }}</div>
        <div class="col-md-3">{{ form.shipment_date.label }} {{ form.shipment_date(class="form-control") }}</div>
        <div class="col-md-3">{{ form.expected_arrival.label }} {{ form.expected_arrival(class="form-control") }}</div>
        <div class="col-md-3">{{ form.actual_arrival.label }} {{ form.actual_arrival(class="form-control") }}</div>
        <div class="col-md-4">{{ form.origin.label }} {{ form.origin(class="form-control") }}</div>
        <div class="col-md-4">{{ form.destination_id.label }} {{ form.destination_id(class_="select2 form-control") }}</div>
        <div class="col-md-2">{{ form.carrier.label }} {{ form.carrier(class="form-control") }}</div>
        <div class="col-md-2">{{ form.tracking_number.label }} {{ form.tracking_number(class="form-control") }}</div>
        <div class="col-md-3">{{ form.status.label }} {{ form.status(class="form-select") }}</div>
        {% if form.currency is defined %}<div class="col-md-3">{{ form.currency.label }} {{ form.currency(class="form-select") }}</div>{% endif %}
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>بنود الشحنة</span>
      <div class="d-flex gap-2">
        <input type="text" id="barcode-input" class="form-control form-control-sm" placeholder="سكان باركود/بحث سريع">
        <button type="button" class="btn btn-sm btn-secondary" id="add-item">+ إضافة بند</button>
      </div>
    </div>
    <div class="card-body">
      <div id="items-wrapper" data-index="{{ form.items|length }}">
        {% for sf in form.items %}
          {{ item_row(sf, loop.index0) }}
        {% else %}
          <div class="text-muted small">لا توجد بنود بعد.</div>
        {% endfor %}
      </div>
      <div class="border-top pt-2 mt-2 d-flex flex-wrap gap-3 justify-content-between">
        <div>إجمالي البنود: <strong id="items-count">0</strong></div>
        <div>إجمالي الكمية: <strong id="items-qty-sum">0</strong></div>
        <div>إجمالي التكلفة: <strong id="items-cost-sum">0.00</strong></div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>شركاء الشحنة</span>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="add-partner">+ إضافة شريك</button>
      </div>
    </div>
    <div class="card-body">
      <div id="partners-wrapper" data-index="{{ form.partners|length }}">
        {% for pf in form.partners %}
          {{ partner_row(pf, loop.index0) }}
        {% else %}
          <div class="text-muted small">لا توجد صفوف شركاء بعد.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">تكاليف الشحنة</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">{{ form.value_before.label }} {{ form.value_before(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.shipping_cost.label }} {{ form.shipping_cost(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.customs.label }} {{ form.customs(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.vat.label }} {{ form.vat(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.insurance.label }} {{ form.insurance(class="form-control", step="0.01") }}</div>
        <div class="col-md-3">{{ form.total_value.label }} {{ form.total_value(class="form-control", step="0.01") }}</div>
        <div class="col-md-6">{{ form.notes.label }} {{ form.notes(class="form-control") }}</div>
      </div>
    </div>
  </div>

  {% if form.items|length %}
  <template id="item-row-template">
    {{ item_row(form.items.entries[0].form, "__INDEX__") }}
  </template>
  {% else %}
  <template id="item-row-template">
    <div class="shipment-item border rounded p-2 mb-2" data-index="__INDEX__">
      <div class="row g-2 align-items-end">
        <div class="col-md-4"><label>الصنف</label><select name="items-__INDEX__-product_id" class="select2 form-control"></select></div>
        <div class="col-md-3"><label>المخزن</label><select name="items-__INDEX__-warehouse_id" class="select2 form-control"></select></div>
        <div class="col-md-2"><label>الكمية</label><input name="items-__INDEX__-quantity" type="number" min="1" class="form-control item-qty"></div>
        <div class="col-md-2"><label>تكلفة الوحدة</label><input name="items-__INDEX__-unit_cost" type="number" step="0.01" class="form-control item-cost"></div>
        <div class="col-md-1 text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-remove-item">حذف</button></div>
        <div class="col-12 mt-1"><label>القيمة المصرّح بها</label><input name="items-__INDEX__-declared_value" type="number" step="0.01" class="form-control item-declared"></div>
      </div>
    </div>
  </template>
  {% endif %}

  {% if form.partners|length %}
  <template id="partner-row-template">
    {{ partner_row(form.partners.entries[0].form, "__INDEX__") }}
  </template>
  {% else %}
  <template id="partner-row-template">
    <div class="shipment-partner border rounded p-2 mb-2" data-index="__INDEX__">
      <div class="row g-2">
        <div class="col-md-4"><label>الشريك</label><select name="partners-__INDEX__-partner_id" class="select2 form-control"></select></div>
        <div class="col-md-2"><label>نسبة الشراكة %</label><input name="partners-__INDEX__-share_percentage" type="number" step="0.01" class="form-control"></div>
        <div class="col-md-2"><label>المبلغ</label><input name="partners-__INDEX__-share_amount" type="number" step="0.01" class="form-control"></div>
        <div class="col-md-4 text-end">
          <a href="{{ url_for('vendors_bp.partners_create') }}" target="_blank" class="btn btn-sm btn-outline-secondary">+ شريك جديد</a>
          <button type="button" class="btn btn-sm btn-outline-danger btn-remove-partner">حذف</button>
        </div>
        <div class="col-md-4 mt-2"><label>الرقم التعريفي</label><input name="partners-__INDEX__-identity_number" class="form-control"></div>
        <div class="col-md-4 mt-2"><label>الهاتف</label><input name="partners-__INDEX__-phone_number" class="form-control"></div>
        <div class="col-md-4 mt-2"><label>العنوان</label><input name="partners-__INDEX__-address" class="form-control"></div>
        <div class="col-md-4 mt-2"><label>سعر الوحدة قبل الضريبة</label><input name="partners-__INDEX__-unit_price_before_tax" type="number" step="0.01" class="form-control"></div>
        <div class="col-md-4 mt-2"><label>انتهاء الصلاحية</label><input name="partners-__INDEX__-expiry_date" type="date" class="form-control"></div>
        <div class="col-md-4 mt-2"><label>ملاحظات</label><input name="partners-__INDEX__-notes" class="form-control"></div>
      </div>
    </div>
  </template>
  {% endif %}

  <div class="mt-3">
    <button class="btn btn-primary">{{ is_edit and 'تحديث الشحنة' or 'حفظ الشحنة' }}</button>
    <a class="btn btn-secondary" href="{{ url_for('shipments_bp.list_shipments') }}">عودة</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/shipments.js') }}"></script>
  <script src="{{ url_for('static', filename='js/warehouses.js') }}"></script>
{% endblock %}
