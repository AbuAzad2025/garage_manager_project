{% extends 'warehouses/base.html' %}
{% block title %}الشحنات{% if warehouse %} – {{ warehouse.name }}{% endif %}{% endblock %}
{% block page_title %}الشحنات{% if warehouse %} – {{ warehouse.name }}{% endif %}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shipments.css') }}">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
  <h3 class="mb-0">الشحنات{% if warehouse %} في {{ warehouse.name }}{% endif %}</h3>
  <a href="{{ url_for('shipments_bp.create_shipment', destination_id=warehouse.id) if warehouse else url_for('shipments_bp.create_shipment') }}" class="btn btn-success btn-sm">
    <i class="fa fa-plus"></i> إضافة شحنة
  </a>
</div>

<form id="shipmentsFilters" class="row g-2 mb-3" autocomplete="off" novalidate>
  <div class="col-md-2">
    <label for="fStatus" class="form-label">الحالة</label>
    <select id="fStatus" class="form-select" name="status">
      <option value="">الكل</option>
      <option value="DRAFT">مسودة</option>
      <option value="PENDING">قيد الانتظار</option>
      <option value="IN_TRANSIT">قيد النقل</option>
      <option value="IN_CUSTOMS">في الجمارك</option>
      <option value="ARRIVED">وصلت</option>
      <option value="DELIVERED">تم التسليم</option>
      <option value="CANCELLED">ملغاة</option>
      <option value="RETURNED">مرتجعة</option>
    </select>
  </div>
  <div class="col-md-2">
    <label for="fFrom" class="form-label">من تاريخ</label>
    <input type="date" id="fFrom" class="form-control" name="from">
  </div>
  <div class="col-md-2">
    <label for="fTo" class="form-label">إلى تاريخ</label>
    <input type="date" id="fTo" class="form-control" name="to">
  </div>
  <div class="col-md-3">
    <label for="fDestination" class="form-label">الوجهة</label>
    <input type="text" id="fDestination" class="form-control" name="destination" placeholder="اسم المستودع/الوجهة"{% if warehouse %} value="{{ warehouse.name }}"{% endif %}>
  </div>
  <div class="col-md-3">
    <label for="fSearch" class="form-label">بحث عام</label>
    <input type="text" id="fSearch" class="form-control" name="search" placeholder="رقم الشحنة / شركة النقل / تتبع">
  </div>
</form>

<div class="table-responsive">
  <table id="shipmentsTable" class="table table-striped table-bordered table-hover align-middle w-100">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>رقم الشحنة</th>
        <th>الوجهة</th>
        <th>تاريخ الوصول المتوقع</th>
        <th>الحالة</th>
        <th class="text-end">الإجمالي</th>
        <th class="text-center">إجراءات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
  <script>
    (function(){
      const $ = window.jQuery;
      if (!$('#shipmentsTable').length) return;

      const dataUrl = "{{ url_for('shipments_bp.shipments_data') }}";

      const dt = $('#shipmentsTable').DataTable({
        ajax: {
          url: dataUrl,
          data: function(d){
            d.status      = $('#fStatus').val() || '';
            d.from        = $('#fFrom').val() || '';
            d.to          = $('#fTo').val() || '';
            d.destination = $('#fDestination').val() || '';
            d.search_extra= $('#fSearch').val() || '';
          }
        },
        serverSide: true,
        processing: true,
        order: [[3,'desc']],
        columns: [
          { data: 'id', width: '60px' },
          { data: 'number' },
          { data: 'destination' },
          { data: 'expected_arrival', render: function(d){ return d ? new Date(d).toLocaleString('ar-EG').split(',')[0] : ''; } },
          { data: 'status' },
          { data: 'total_value', className: 'text-end', render: function(d){ return (Number(d||0)).toFixed(2); } },
          { data: 'actions', className: 'text-center', orderable: false, searchable: false }
        ],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json'
        }
      });

      $('#shipmentsFilters').on('change', 'select,input', function(){ dt.ajax.reload(); });
      $('#fSearch').on('keydown', function(e){ if (e.key === 'Enter'){ e.preventDefault(); dt.ajax.reload(); }});
    })();
  </script>
  <script src="{{ url_for('static', filename='js/shipments.js') }}"></script>
{% endblock %}
