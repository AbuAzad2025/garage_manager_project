{% extends 'warehouses/base.html' %}
{% block page_title %}Ø§Ù„Ø´Ø­Ù†Ø§Øª{% if warehouse %} â€“ {{ warehouse.name }}{% endif %}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shipments.css') }}">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
  <h3 class="mb-0">Ø§Ù„Ø´Ø­Ù†Ø§Øª{% if warehouse %} ÙÙŠ {{ warehouse.name }}{% endif %}</h3>
  <a href="{{ url_for('shipments_bp.create_shipment', destination_id=warehouse.id) if warehouse else url_for('shipments_bp.create_shipment') }}" class="btn btn-success btn-sm">
    <i class="fa fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø´Ø­Ù†Ø©
  </a>
</div>

<form id="shipmentsFilters" class="row g-2 mb-3" autocomplete="off" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <div class="col-md-2">
    <label for="fStatus" class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
    <select id="fStatus" class="form-select" name="status">
      <option value="">Ø§Ù„ÙƒÙ„</option>
      <option value="DRAFT">Ù…Ø³ÙˆØ¯Ø©</option>
      <option value="PENDING">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
      <option value="IN_TRANSIT">Ù‚ÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„</option>
      <option value="IN_CUSTOMS">ÙÙŠ Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ</option>
      <option value="ARRIVED">ÙˆØµÙ„Øª</option>
      <option value="DELIVERED">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
      <option value="CANCELLED">Ù…Ù„ØºØ§Ø©</option>
      <option value="RETURNED">Ù…Ø±ØªØ¬Ø¹Ø©</option>
    </select>
  </div>
  <div class="col-md-2">
    <label for="fFrom" class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
    <input type="date" id="fFrom" class="form-control" name="from">
  </div>
  <div class="col-md-2">
    <label for="fTo" class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
    <input type="date" id="fTo" class="form-control" name="to">
  </div>
  <div class="col-md-3">
    <label for="fDestination" class="form-label">Ø§Ù„ÙˆØ¬Ù‡Ø©</label>
    <input type="text" id="fDestination" class="form-control" name="destination" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹/Ø§Ù„ÙˆØ¬Ù‡Ø©"{% if warehouse %} value="{{ warehouse.name }}"{% endif %}>
  </div>
  <div class="col-md-3">
    <label for="fSearch" class="form-label">Ø¨Ø­Ø« Ø¹Ø§Ù…</label>
    <input type="text" id="fSearch" class="form-control" name="search" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø© / Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ / ØªØªØ¨Ø¹">
  </div>
</form>

<div class="table-responsive">
  <table id="shipmentsTable" class="table table-striped table-bordered table-hover align-middle w-100">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø©</th>
        <th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
        <th>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</th>
        <th class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
  <script>
    (function(){
      const $ = window.jQuery;
      if (!$('#shipmentsTable').length) return;

      const dataUrl = "{{ url_for('shipments_bp.shipments_data') }}";

      const dt = $('#shipmentsTable').DataTable({
        ajax: {
          url: dataUrl,
          data: function(d){
            d.status      = $('#fStatus').val() || '';
            d.from        = $('#fFrom').val() || '';
            d.to          = $('#fTo').val() || '';
            d.destination = $('#fDestination').val() || '';
            d.search_extra= $('#fSearch').val() || '';
          }
        },
        serverSide: true,
        processing: true,
        order: [[3,'desc']],
        columns: [
          { data: 'id', width: '60px' },
          { data: 'number' },
          { data: 'destination' },
          { data: 'expected_arrival', render: function(d){ return d ? new Date(d).toLocaleString('en-US').split(',')[0] : ''; } },
          { data: 'status' },
          { data: 'currency', className: 'text-center', render: function(d){ return d ? '<span class="badge badge-secondary">' + d + '</span>' : '<span class="badge badge-secondary">ILS</span>'; } },
          { 
            data: null, 
            className: 'text-center',
            render: function(data, type, row) {
              if (row.fx_rate_used && row.currency !== 'ILS') {
                var sourceIcon = '';
                if (row.fx_rate_source) {
                  if (row.fx_rate_source === 'online') sourceIcon = 'ğŸŒ';
                  else if (row.fx_rate_source === 'manual') sourceIcon = 'âœï¸';
                  else sourceIcon = 'âš™ï¸';
                }
                return '<small class="text-muted">' + parseFloat(row.fx_rate_used).toFixed(4) + ' ' + sourceIcon + '</small>';
              }
              return '<span class="text-muted">-</span>';
            }
          },
          { data: 'total_value', className: 'text-end', render: function(d){ return (Number(d||0)).toFixed(2); } },
          { data: 'actions', className: 'text-center', orderable: false, searchable: false }
        ],
        language: {
          url: "{{ url_for('static', filename='datatables/Arabic.json') }}"
        }
      });

      $('#shipmentsFilters').on('change', 'select,input', function(){ dt.ajax.reload(); });
      $('#fSearch').on('keydown', function(e){ if (e.key === 'Enter'){ e.preventDefault(); dt.ajax.reload(); }});
    })();
  </script>
  <script src="{{ url_for('static', filename='js/shipments.js') }}"></script>
{% endblock %}
