{% extends 'base.html' %}
{% block title %}تفاصيل الحجز{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>قسيمة حجز {{ preorder.reference or preorder.id }}</h2>

  {% set qty = preorder.quantity|int %}
  {% set unit_price = (preorder.product.price or 0)|float %}
  {% set tax = (preorder.tax_rate or 0)|float %}
  {% set prepaid = (preorder.prepaid_amount or 0)|float %}
  {% set total_before = qty * unit_price %}
  {% set total_with_tax = total_before * (1 + tax/100) %}
  {% set balance = total_with_tax - prepaid %}

  <dl class="row">
    <dt class="col-sm-3">الجهة</dt>
    <dd class="col-sm-9">
      {% if preorder.customer %}{{ preorder.customer.name }}
      {% elif preorder.supplier %}{{ preorder.supplier.name }}
      {% elif preorder.partner %}{{ preorder.partner.name }}
      {% else %}غير محدد{% endif %}
    </dd>

    <dt class="col-sm-3">القطعة</dt>
    <dd class="col-sm-9">{{ preorder.product.name }}</dd>

    <dt class="col-sm-3">الكمية</dt>
    <dd class="col-sm-9">{{ qty }}</dd>

    <dt class="col-sm-3">السعر للوحدة</dt>
    <dd class="col-sm-9">{{ unit_price|format_currency }}</dd>

    <dt class="col-sm-3">الإجمالي قبل ضريبة</dt>
    <dd class="col-sm-9">{{ total_before|format_currency }}</dd>

    <dt class="col-sm-3">نسبة الضريبة</dt>
    <dd class="col-sm-9">{{ tax }}%</dd>

    <dt class="col-sm-3">الإجمالي بعد ضريبة</dt>
    <dd class="col-sm-9">{{ total_with_tax|format_currency }}</dd>

    <dt class="col-sm-3">مدفوع (عربون)</dt>
    <dd class="col-sm-9">{{ prepaid|format_currency }}</dd>

    <dt class="col-sm-3">متبقي</dt>
    <dd class="col-sm-9">{{ balance|format_currency }}</dd>
  </dl>

  <div class="mt-3">
    {% if preorder.status not in ('CANCELLED','FULFILLED') %}
      <form method="post" action="{{ url_for('warehouse_bp.preorder_fulfill', preorder_id=preorder.id) }}" style="display:inline">
        {{ csrf_token() }}
        <button class="btn btn-success">تنفيذ</button>
      </form>
      <form method="post" action="{{ url_for('warehouse_bp.preorder_cancel', preorder_id=preorder.id) }}" style="display:inline" onsubmit="return confirm('إلغاء الحجز؟');">
        {{ csrf_token() }}
        <button class="btn btn-danger">إلغاء</button>
      </form>
      <a class="btn btn-outline-primary"
         href="{{ url_for('payments.create_payment', entity_type='PREORDER', entity_id=preorder.id, amount=prepaid) }}">
        إضافة دفعة للحجز
      </a>
    {% endif %}
    <a class="btn btn-secondary" href="{{ url_for('warehouse_bp.preorders_list') }}">رجوع</a>
  </div>
</div>
{% endblock %}
