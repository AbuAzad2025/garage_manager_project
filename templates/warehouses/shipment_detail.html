{% extends 'warehouses/base.html' %}
{% block title %}تفاصيل الشحنة {{ shipment.shipment_number or shipment.number or ('#' ~ shipment.id) }}{% endblock %}
{% block page_title %}تفاصيل الشحنة{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div></div>
  <div class="btn-group">
    <a href="{{ url_for('shipments_bp.edit_shipment', id=shipment.id) }}" class="btn btn-warning">تعديل</a>

    <form method="POST" action="{{ url_for('shipments_bp.delete_shipment', id=shipment.id) }}" onsubmit="return confirm('تأكيد حذف الشحنة؟');" class="d-inline m-0 p-0">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-danger">حذف</button>
    </form>

    {% set st = (shipment.status or '').upper() %}
    
    {% if st not in ['IN_TRANSIT', 'ARRIVED', 'DELIVERED', 'CANCELLED'] %}
    <form method="POST" action="{{ url_for('shipments_bp.mark_in_transit', id=shipment.id) }}" class="d-inline m-0 p-0">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-info">وضع في الطريق</button>
    </form>
    {% endif %}

    {% if st == 'IN_TRANSIT' %}
    <form method="POST" action="{{ url_for('shipments_bp.mark_in_customs', id=shipment.id) }}" class="d-inline m-0 p-0">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-primary">وضع في الجمارك</button>
    </form>
    {% endif %}

    {% if st == 'IN_CUSTOMS' %}
    <form method="POST" action="{{ url_for('shipments_bp.mark_arrived', id=shipment.id) }}" class="d-inline m-0 p-0">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-success" onclick="return confirm('تأكيد وصول الشحنة وتحديث المخزون؟')">اعتماد الوصول</button>
    </form>
    {% endif %}

    {% if st == 'ARRIVED' %}
    <form method="POST" action="{{ url_for('shipments_bp.mark_delivered', id=shipment.id) }}" class="d-inline m-0 p-0">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-success" onclick="return confirm('تأكيد تسليم الشحنة؟')">تسليم</button>
    </form>
    {% endif %}

    {% if st not in ['CANCELLED', 'RETURNED'] %}
    <form method="POST" action="{{ url_for('shipments_bp.mark_returned', id=shipment.id) }}" class="d-inline m-0 p-0">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-warning">إرجاع</button>
    </form>
    {% endif %}

    <form method="POST" action="{{ url_for('shipments_bp.cancel_shipment', id=shipment.id) }}" class="d-inline m-0 p-0">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-secondary" {% if st == 'CANCELLED' %}disabled{% endif %}>إلغاء</button>
    </form>

    <a href="{{ url_for('shipments_bp.list_shipments') }}" class="btn btn-outline-secondary">رجوع</a>
  </div>
</div>

<div class="card">
  <div class="card-body">
    {% macro status_badge(s) -%}
      {% set u = (s or '')|upper %}
      <span class="badge
        {% if u == 'ARRIVED' %} bg-success
        {% elif u == 'IN_TRANSIT' %} bg-primary
        {% elif u == 'CANCELLED' %} bg-secondary
        {% else %} bg-info {% endif %}
      ">{{ s or '-' }}</span>
    {%- endmacro %}

    <dl class="row mb-0">
      <dt class="col-sm-3">رقم الشحنة</dt>
      <dd class="col-sm-9">{{ shipment.shipment_number or shipment.number or '-' }}</dd>

      <dt class="col-sm-3">من</dt>
      <dd class="col-sm-9">{{ shipment.origin or '-' }}</dd>

      <dt class="col-sm-3">إلى</dt>
      <dd class="col-sm-9">
        {% if shipment.destination_warehouse %}
          {{ shipment.destination_warehouse.name }}
        {% else %}
          {{ shipment.destination or '-' }}
        {% endif %}
      </dd>

      <dt class="col-sm-3">الحالة</dt>
      <dd class="col-sm-9">{{ status_badge(shipment.status) }}</dd>

      <dt class="col-sm-3">تاريخ الشحن</dt>
      <dd class="col-sm-9">
        {{ shipment.shipment_date and shipment.shipment_date.strftime('%Y-%m-%d %H:%M') or '-' }}
      </dd>

      <dt class="col-sm-3">متوقع الوصول</dt>
      <dd class="col-sm-9">
        {{ shipment.expected_arrival and shipment.expected_arrival.strftime('%Y-%m-%d %H:%M') or '-' }}
      </dd>

      <dt class="col-sm-3">الوصول الفعلي</dt>
      <dd class="col-sm-9">
        {{ shipment.actual_arrival and shipment.actual_arrival.strftime('%Y-%m-%d %H:%M') or '-' }}
      </dd>

      <dt class="col-sm-3">تاريخ التسليم</dt>
      <dd class="col-sm-9">
        {{ shipment.delivered_date and shipment.delivered_date.strftime('%Y-%m-%d %H:%M') or '-' }}
      </dd>

      <dt class="col-sm-3">الوزن</dt>
      <dd class="col-sm-9">{{ shipment.weight or '-' }} كيلو</dd>

      <dt class="col-sm-3">الأبعاد</dt>
      <dd class="col-sm-9">{{ shipment.dimensions or '-' }}</dd>

      <dt class="col-sm-3">عدد الطرود</dt>
      <dd class="col-sm-9">{{ shipment.package_count or 1 }}</dd>

      <dt class="col-sm-3">الأولوية</dt>
      <dd class="col-sm-9">
        <span class="badge 
          {% if shipment.priority == 'URGENT' %}bg-danger
          {% elif shipment.priority == 'HIGH' %}bg-warning
          {% elif shipment.priority == 'LOW' %}bg-success
          {% else %}bg-info{% endif %}">
          {{ shipment.priority or 'NORMAL' }}
        </span>
      </dd>

      <dt class="col-sm-3">طريقة التسليم</dt>
      <dd class="col-sm-9">{{ shipment.delivery_method or '-' }}</dd>

      <dt class="col-sm-3">تعليمات التسليم</dt>
      <dd class="col-sm-9">{{ shipment.delivery_instructions or '-' }}</dd>

      <dt class="col-sm-3">رقم البيان الجمركي</dt>
      <dd class="col-sm-9">{{ shipment.customs_declaration or '-' }}</dd>

      <dt class="col-sm-3">تاريخ التخليص الجمركي</dt>
      <dd class="col-sm-9">
        {{ shipment.customs_cleared_date and shipment.customs_cleared_date.strftime('%Y-%m-%d %H:%M') or '-' }}
      </dd>

      <dt class="col-sm-3">محاولات التسليم</dt>
      <dd class="col-sm-9">
        <span class="badge bg-info">{{ shipment.delivery_attempts or 0 }}</span>
        {% if shipment.delivery_attempts and shipment.delivery_attempts > 0 %}
        <button class="btn btn-sm btn-outline-primary ms-2" onclick="updateDeliveryAttempt({{ shipment.id }})">
          <i class="fas fa-plus"></i> إضافة محاولة
        </button>
        {% endif %}
      </dd>

      <dt class="col-sm-3">آخر محاولة تسليم</dt>
      <dd class="col-sm-9">
        {{ shipment.last_delivery_attempt and shipment.last_delivery_attempt.strftime('%Y-%m-%d %H:%M') or '-' }}
      </dd>

      <dt class="col-sm-3">سبب الإرجاع</dt>
      <dd class="col-sm-9">{{ shipment.return_reason or '-' }}</dd>

      <dt class="col-sm-3">قيمة البضائع</dt>
      <dd class="col-sm-9">{{ format_currency(shipment.value_before or 0) }}</dd>

      <dt class="col-sm-3">كلفة الشحن</dt>
      <dd class="col-sm-9">{{ format_currency(shipment.shipping_cost or 0) }}</dd>

      <dt class="col-sm-3">الجمارك</dt>
      <dd class="col-sm-9">{{ format_currency(shipment.customs or 0) }}</dd>

      <dt class="col-sm-3">VAT</dt>
      <dd class="col-sm-9">{{ format_currency(shipment.vat or 0) }}</dd>

      <dt class="col-sm-3">التأمين</dt>
      <dd class="col-sm-9">{{ format_currency(shipment.insurance or 0) }}</dd>

      <dt class="col-sm-3">الإجمالي</dt>
      <dd class="col-sm-9">{{ format_currency(shipment.total_value or 0) }}</dd>

      <dt class="col-sm-3">المدفوع</dt>
      <dd class="col-sm-9">{{ format_currency(total_paid or 0) }}</dd>

      <dt class="col-sm-3">ملاحظات</dt>
      <dd class="col-sm-9">{{ shipment.notes or '-' }}</dd>
    </dl>

    <hr>

    <h5 class="mt-2">العناصر</h5>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>المنتج</th>
            <th>المستودع</th>
            <th class="text-center">الكمية</th>
            <th class="text-end">سعر الوحدة</th>
            <th class="text-end">حصة التكاليف</th>
            <th class="text-end">التكلفة الواصلة للوحدة</th>
            <th class="text-end">الإجمالي</th>
          </tr>
        </thead>
        <tbody>
          {% set qty_sum = 0 %}
          {% set total_sum = 0 %}
          {% for i in shipment.items %}
            {% set q = (i.quantity or 0) %}
            {% set uc = (i.unit_cost or 0)|float %}
            {% set line_total = q * uc %}
            {% set qty_sum = qty_sum + q %}
            {% set total_sum = total_sum + line_total %}
            <tr>
              <td>{{ i.product and i.product.name or '-' }}</td>
              <td>{{ i.warehouse and i.warehouse.name or '-' }}</td>
              <td class="text-center">{{ q }}</td>
              <td class="text-end">{{ format_currency(i.unit_cost or 0) }}</td>
              <td class="text-end">{{ format_currency(i.landed_extra_share or 0) }}</td>
              <td class="text-end">{{ format_currency(i.landed_unit_cost or 0) }}</td>
              <td class="text-end">{{ format_currency(line_total) }}</td>
            </tr>
          {% else %}
            <tr><td colspan="7" class="text-center text-muted">لا توجد عناصر</td></tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2" class="text-end">الإجماليات</th>
            <th class="text-center">{{ qty_sum }}</th>
            <th></th>
            <th></th>
            <th></th>
            <th class="text-end">{{ format_currency(total_sum) }}</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <h5 class="mt-3">الشركاء</h5>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>الشريك</th>
            <th class="text-center">النسبة %</th>
            <th class="text-end">المبلغ</th>
          </tr>
        </thead>
        <tbody>
          {% for p in shipment.partners %}
            <tr>
              <td>{{ p.partner and p.partner.name or '-' }}</td>
              <td class="text-center">{{ (p.share_percentage or 0)|round(2) }}</td>
              <td class="text-end">{{ format_currency(p.share_amount or 0) }}</td>
            </tr>
          {% else %}
            <tr><td colspan="3" class="text-center text-muted">لا توجد مساهمات شركاء</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <hr>

    <div class="d-flex gap-2">
      <a href="{{ url_for('shipments_bp.shipment_detail', id=shipment.id) }}" class="btn btn-outline-success">تحديث</a>
      <a href="{{ url_for('shipments_bp.list_shipments') }}" class="btn btn-outline-secondary">عودة للقائمة</a>
    </div>
  </div>
</div>

<script>
function updateDeliveryAttempt(shipmentId) {
    const notes = prompt('أدخل ملاحظات محاولة التسليم (اختياري):');
    if (notes === null) return; // User cancelled
    
    fetch(`/shipments/${shipmentId}/update-delivery-attempt`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').content
        },
        body: JSON.stringify({ notes: notes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            alert('خطأ: ' + (data.error || 'حدث خطأ غير متوقع'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطأ في الاتصال');
    });
}
</script>
{% endblock %}
