{% extends 'warehouses/base.html' %}
{% block page_title %}Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ø¨Ø± Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…Ø­Ø¯Ø¯Ø©{% endblock %}

{% block breadcrumb %}
  {{ super() }}
{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/warehouses.css') }}">
  <style>
    .inline-input{width:100%;min-width:90px;max-width:140px}
    .w-qty{min-width:90px;max-width:110px}
    .w-price{min-width:100px;max-width:130px}
    #notification-container{position:fixed;top:20px;right:20px;z-index:2000}
    
    .sticky-column {
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 10;
      border-right: 2px solid #dee2e6;
    }
    
    .table th { white-space: nowrap; font-weight: 600; font-size: 0.9rem; }
    .table td { vertical-align: middle; font-size: 0.9rem; }
    
    .column-hidden { display: none !important; }
    
    .stat-card {
      transition: transform 0.2s;
      border-left: 4px solid;
    }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card.primary { border-left-color: #007bff; }
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.danger { border-left-color: #dc3545; }
    
    @media (max-width: 768px) {
      .btn-group { flex-wrap: wrap; gap: 0.25rem; }
      .btn-group .btn { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
      .inline-input { min-width: 60px; max-width: 100px; }
    }
    
    /* Save button styling */
    .save-btn {
      transition: all 0.3s ease;
    }
    
    .save-btn:hover {
      transform: scale(1.1);
    }
    
    .save-btn.saving {
      background-color: #ffc107 !important;
      border-color: #ffc107 !important;
    }
    
    .save-btn.saved {
      background-color: #28a745 !important;
      border-color: #28a745 !important;
    }
    
    .save-btn.error {
      background-color: #dc3545 !important;
      border-color: #dc3545 !important;
    }
    
    /* Mark changed inputs */
    .inline-input.changed {
      border-color: #ffc107 !important;
      border-width: 2px !important;
      background-color: #fff3cd !important;
    }
    
    /* Print Styles */
    @media print {
      /* Hide unnecessary elements */
      .sidebar, .navbar, .breadcrumb, .btn-group, .card-header .d-flex .btn-group,
      button, .btn, input[type="button"], input[type="submit"], 
      footer, .footer, #notification-container, .no-print {
        display: none !important;
      }
      
      /* Reset page margins */
      @page {
        size: A4 landscape;
        margin: 1cm;
      }
      
      body {
        margin: 0;
        padding: 10px;
        font-size: 11pt;
      }
      
      /* Make table full width */
      .card, .card-body, .table-responsive {
        box-shadow: none !important;
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Print header */
      .card-header {
        background: white !important;
        border-bottom: 2px solid #000 !important;
        padding: 10px 0 !important;
        margin-bottom: 10px;
      }
      
      .card-header h6 {
        font-size: 14pt;
        color: #000 !important;
      }
      
      /* Table styling */
      table {
        width: 100% !important;
        border-collapse: collapse !important;
        page-break-inside: auto;
      }
      
      thead {
        display: table-header-group;
        background: #f0f0f0 !important;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      th, td {
        border: 1px solid #000 !important;
        padding: 6px !important;
        font-size: 10pt !important;
        text-align: right !important;
      }
      
      th {
        background: #e0e0e0 !important;
        font-weight: bold !important;
        color: #000 !important;
      }
      
      /* Hide inputs, show values */
      input, select {
        border: none !important;
        background: none !important;
        padding: 0 !important;
        font-size: 10pt !important;
      }
      
      /* Hide filter form */
      #filter-form {
        display: none !important;
      }
      
      /* Hide statistics cards */
      .stat-card, .row.mb-4:has(.stat-card) {
        display: none !important;
      }
      
      /* Show print header */
      .print-header {
        display: block !important;
      }
      
      /* Sticky column fix for print */
      .sticky-column {
        position: static !important;
        background: white !important;
      }
      
      /* Hide hidden columns in print too */
      .column-hidden {
        display: none !important;
      }
      
      /* Add print header */
      .print-header {
        text-align: center;
        margin-bottom: 15px;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
      }
      
      .print-header h2 {
        margin: 0;
        font-size: 18pt;
      }
      
      .print-date {
        font-size: 10pt;
        color: #666;
      }
      
      /* Page numbers */
      .page-footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        font-size: 9pt;
        border-top: 1px solid #000;
        padding-top: 5px;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div id="notification-container"></div>

<!-- Print Header (Only visible when printing) -->
<div class="print-header d-none d-print-block">
  <h2>ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - {{ warehouse.name }}</h2>
  <div class="print-date">
    <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ now().strftime('%Y-%m-%d %H:%M') }} | 
    <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</strong> {{ rows|length }} | 
    <strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª:</strong> {{ whs|map(attribute='name')|join('ØŒ ') }}
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card primary shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-primary fw-bold small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
            <div class="h5 mb-0 fw-bold" id="stat-total-products">{{ rows|length }}</div>
          </div>
          <i class="fas fa-boxes fa-2x text-primary opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card success shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-success fw-bold small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
            <div class="h5 mb-0 fw-bold" id="stat-total-quantity">
              {% set total_qty = rows|sum(attribute='total')|int %}{{ total_qty }}
            </div>
          </div>
          <i class="fas fa-cubes fa-2x text-success opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card warning shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-warning fw-bold small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© (â‚ª)</div>
            <div class="h5 mb-0 fw-bold" id="stat-total-value">
              {% set values = [] %}
              {% for r in rows %}
                {% set qty = r.total or 0 %}
                {% set price = r.product.selling_price or r.product.price or 0 %}
                {% set _ = values.append(qty * price) %}
              {% endfor %}
              {{ "%.2f"|format(values|sum) }}
            </div>
          </div>
          <i class="fas fa-dollar-sign fa-2x text-warning opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card danger shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-danger fw-bold small mb-1">Ù…Ù†ØªØ¬Ø§Øª Ù†ÙØ¯Øª</div>
            <div class="h5 mb-0 fw-bold" id="stat-out-of-stock">
              {% set out_of_stock = rows|selectattr('total', 'equalto', 0)|list|length %}{{ out_of_stock }}
            </div>
          </div>
          <i class="fas fa-exclamation-triangle fa-2x text-danger opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filter Form -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form id="filter-form" class="row g-3 align-items-end" method="get">
      <div class="col-lg-6">
        <label for="warehouse_ids" class="form-label">
          <i class="fas fa-warehouse ml-1"></i>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
        </label>
        <select id="warehouse_ids" class="custom-select" name="warehouse_ids" multiple size="4">
          {% for w in warehouses %}
            <option value="{{ w.id }}" {% if w.id in selected_ids %}selected{% endif %}>{{ w.name }}</option>
          {% endfor %}
        </select>
        <small class="text-muted">
          <i class="fas fa-info-circle ml-1"></i>Ø§Ø³ØªØ®Ø¯Ù… Ctrl Ø£Ùˆ âŒ˜ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
        </small>
      </div>
      <div class="col-lg-4">
        <label for="q" class="form-label">
          <i class="fas fa-search ml-1"></i>Ø¨Ø­Ø«
        </label>
        <input id="q" name="q" type="search" class="form-control" value="{{ search }}" 
               placeholder="Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ SKU Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© Ø£Ùˆ Ø§Ù„Ù…Ø§Ø±ÙƒØ©">
      </div>
      <div class="col-lg-2 d-flex gap-2">
        <button class="btn btn-primary flex-fill" type="submit">
          <i class="fas fa-filter ml-1"></i>ØªØ·Ø¨ÙŠÙ‚
        </button>
        <a class="btn btn-secondary flex-fill" href="{{ url_for('warehouse_bp.detail', warehouse_id=active_warehouse_id) }}">
          <i class="fas fa-arrow-right ml-1"></i>Ø±Ø¬ÙˆØ¹
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Products Table -->
<div class="card shadow-sm">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h6 class="mb-0">
        <i class="fas fa-boxes ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        <span class="badge bg-primary ms-2">{{ rows|length }}</span>
      </h6>
      
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('sku')">
          <i class="fas fa-tag"></i> SKU
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('part_number')">
          <i class="fas fa-hashtag"></i> Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('brand')">
          <i class="fas fa-star"></i> Ø§Ù„Ù…Ø§Ø±ÙƒØ©
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('purchase_price')">
          <i class="fas fa-shopping-cart"></i> Ø§Ù„ØªÙƒÙ„ÙØ©
        </button>
      </div>
      
      <button type="button" class="btn btn-success btn-sm" onclick="window.print()">
        <i class="fas fa-print ml-1"></i>Ø·Ø¨Ø§Ø¹Ø©
      </button>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0" id="products-table">
        <thead class="table-light">
          <tr>
            <th class="sticky-column"><i class="fas fa-box ml-1"></i>Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
            <th class="column-sku column-hidden"><i class="fas fa-tag ml-1"></i>SKU</th>
            <th class="column-part_number column-hidden"><i class="fas fa-hashtag ml-1"></i>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
            <th class="column-brand column-hidden"><i class="fas fa-star ml-1"></i>Ø§Ù„Ù…Ø§Ø±ÙƒØ©</th>
            <th class="text-center"><i class="fas fa-money-bill ml-1"></i>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
            <th class="text-end column-purchase_price column-hidden"><i class="fas fa-receipt ml-1"></i>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
            <th class="text-end"><i class="fas fa-dollar-sign ml-1"></i>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
            <th class="text-end"><i class="fas fa-cubes ml-1"></i>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th class="text-end"><i class="fas fa-calculator ml-1"></i>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th class="text-center no-print" style="width: 100px;"><i class="fas fa-cog ml-1"></i>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
              {% set p = r.product %}
              <tr data-id="{{ p.id }}">
                <td class="sticky-column">
                  <a href="/warehouses/parts/{{ p.id }}" class="fw-bold text-decoration-none">{{ p.name }}</a>
                </td>
                <td class="column-sku column-hidden">
                  <input class="form-control form-control-sm inline-input" data-field="sku" 
                         data-id="{{ p.id }}" value="{{ p.sku or '' }}">
                </td>
                <td class="column-part_number column-hidden">
                  <input class="form-control form-control-sm inline-input" data-field="part_number" 
                         data-id="{{ p.id }}" value="{{ p.part_number or '' }}">
                </td>
                <td class="column-brand column-hidden">
                  <input class="form-control form-control-sm inline-input" data-field="brand" 
                         data-id="{{ p.id }}" value="{{ p.brand or '' }}">
                </td>
                <td class="text-center">
                  <select class="custom-select custom-select-sm inline-input" data-field="currency" 
                          data-id="{{ p.id }}" style="max-width:90px">
                    <option value="ILS" {% if p.currency=='ILS' %}selected{% endif %}>â‚ª ILS</option>
                    <option value="USD" {% if p.currency=='USD' %}selected{% endif %}>$ USD</option>
                    <option value="EUR" {% if p.currency=='EUR' %}selected{% endif %}>â‚¬ EUR</option>
                    <option value="JOD" {% if p.currency=='JOD' %}selected{% endif %}>Ø¯.Ø£ JOD</option>
                  </select>
                </td>
                <td class="text-end column-purchase_price column-hidden">
                  <input type="number" step="0.01" class="form-control form-control-sm inline-input text-end w-price" 
                         data-field="purchase_price" data-id="{{ p.id }}" value="{{ p.purchase_price or '' }}">
                </td>
                <td class="text-end">
                  <input type="number" step="0.01" class="form-control form-control-sm inline-input text-end w-price" 
                         data-field="selling_price" data-id="{{ p.id }}" value="{{ p.selling_price or '' }}">
                </td>
                <td class="text-end">
                  <input type="number" step="1" class="form-control form-control-sm inline-input text-end w-qty" 
                         data-field="quantity" data-id="{{ p.id }}" value="{{ r.by.get(active_warehouse_id, {}).get('on', 0) }}">
                </td>
                <td class="text-end fw-bold">{{ r.total or 0 }}</td>
                <td class="text-center no-print">
                  <button class="btn btn-sm btn-success save-btn" 
                          data-id="{{ p.id }}" 
                          onclick="saveProduct({{ p.id }})"
                          title="Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª">
                    <i class="fas fa-save"></i>
                  </button>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="10" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Print Footer (Only visible when printing) -->
<div class="page-footer d-none d-print-block">
  <small>
    Ø´Ø±ÙƒØ© Ø£Ø²Ø§Ø¯ Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø°ÙƒÙŠØ© | 
    Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ | 
    +970-562-150-193 | 
    ahmed@azad-systems.com
  </small>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function(){
      // Notification system
      function notify(message, type) {
        type = type || 'info';
        const container = document.getElementById('notification-container') || 
          (() => { const c = document.createElement('div'); c.id = 'notification-container'; document.body.appendChild(c); return c; })();
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `<strong>${message}</strong><button type="button" class="close" data-dismiss="alert"></button>`;
        container.appendChild(alert);
        
        setTimeout(() => alert.remove(), 5000);
      }
      window.notify = notify;
      
      // Toggle column visibility
      function toggleColumn(columnName) {
        const headers = document.querySelectorAll(`.column-${columnName}`);
        const button = document.querySelector(`[onclick*="toggleColumn('${columnName}')"]`);
        
        headers.forEach(el => el.classList.toggle('column-hidden'));
        button?.classList.toggle('active');
      }
      window.toggleColumn = toggleColumn;
      
      // Get CSRF token
      function csrfToken(){
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta?.content) return meta.content;
        const input = document.querySelector('input[name="csrf_token"]');
        if (input?.value) return input.value;
        const cookie = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
        return cookie ? decodeURIComponent(cookie[1]) : null;
      }
      
      // Track changes to inputs
      document.getElementById('products-table')?.addEventListener('input', function(e) {
        const input = e.target;
        if (!input.classList.contains('inline-input')) return;
        
        // Mark as changed
        if (!input.dataset.originalValue) {
          input.dataset.originalValue = input.value;
        }
        
        if (input.value !== input.dataset.originalValue) {
          input.classList.add('changed');
        } else {
          input.classList.remove('changed');
        }
      });
      
      // Save product function
      window.saveProduct = async function(productId) {
        const row = document.querySelector(`tr[data-id="${productId}"]`);
        if (!row) return;
        
        const saveBtn = row.querySelector('.save-btn');
        const inputs = row.querySelectorAll('.inline-input.changed');
        
        if (inputs.length === 0) {
          notify('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§', 'info');
          return;
        }
        
        // Set button to saving state
        saveBtn.classList.add('saving');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
          // Collect all changed data
          const payload = {};
          inputs.forEach(input => {
            const field = input.dataset.field;
            payload[field] = input.value;
          });
          
          // Send to server
          const url = `/warehouses/{{ active_warehouse_id }}/products/${productId}`;
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken() || ''
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          
          const data = await res.json();
          if (!res.ok || data.ok === false) {
            throw new Error(data?.error || data?.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸');
          }
          
          // Success!
          inputs.forEach(input => {
            input.classList.remove('changed');
            input.dataset.originalValue = input.value;
          });
          
          saveBtn.classList.remove('saving');
          saveBtn.classList.add('saved');
          saveBtn.innerHTML = '<i class="fas fa-check"></i>';
          
          notify('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ“', 'success');
          
          // Reset button after 2 seconds
          setTimeout(() => {
            saveBtn.classList.remove('saved');
            saveBtn.innerHTML = '<i class="fas fa-save"></i>';
            saveBtn.disabled = false;
          }, 2000);
          
        } catch(err) {
          // Error
          saveBtn.classList.remove('saving');
          saveBtn.classList.add('error');
          saveBtn.innerHTML = '<i class="fas fa-times"></i>';
          
          notify(err.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'danger');
          
          // Reset button after 2 seconds
          setTimeout(() => {
            saveBtn.classList.remove('error');
            saveBtn.innerHTML = '<i class="fas fa-save"></i>';
            saveBtn.disabled = false;
          }, 2000);
        }
      };
      
      // Handle keyboard shortcuts
      document.getElementById('products-table')?.addEventListener('keydown', function(e) {
        if (!e.target.classList.contains('inline-input')) return;
        
        if (e.key === 'Enter') {
          e.preventDefault();
          // Find save button in the same row
          const row = e.target.closest('tr');
          const saveBtn = row?.querySelector('.save-btn');
          if (saveBtn) {
            saveBtn.click();
          }
        } else if (e.key === 'Escape') {
          const input = e.target;
          // Reset to original value
          if (input.dataset.originalValue) {
            input.value = input.dataset.originalValue;
            input.classList.remove('changed');
          }
          input.blur();
        }
      });
      
      // Initialize original values
      document.querySelectorAll('.inline-input').forEach(input => {
        input.dataset.originalValue = input.value;
      });
      
    })();
  </script>
{% endblock %}
