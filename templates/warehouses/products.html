{% extends 'warehouses/base.html' %}
{% block title %}عرض المخزون عبر مستودعات محددة{% endblock %}
{% block page_title %}عرض المخزون عبر مستودعات محددة{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/warehouses.css') }}">
  <style>
    .inline-input{width:100%;min-width:90px;max-width:140px}
    .w-qty{min-width:90px;max-width:110px}
    .w-price{min-width:100px;max-width:130px}
    #notification-container{position:fixed;top:20px;right:20px;z-index:2000}
  </style>
{% endblock %}

{% block content %}
<div id="notification-container"></div>

<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form id="filter-form" class="row g-3 align-items-end" method="get">
      <div class="col-lg-7">
        <label for="warehouse_ids" class="form-label">اختر المستودعات</label>
        <select id="warehouse_ids" class="form-select" name="warehouse_ids" multiple size="6">
          {% for w in warehouses %}
            <option value="{{ w.id }}" {% if w.id in selected_ids %}selected{% endif %}>{{ w.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">استخدم Ctrl أو ⌘ للاختيار المتعدد</div>
      </div>
      <div class="col-lg-3">
        <label for="q" class="form-label">بحث</label>
        <input id="q" name="q" type="search" class="form-control" value="{{ request.args.get('q','') }}" placeholder="الاسم أو SKU أو رقم القطعة أو الماركة">
      </div>
      <div class="col-lg-2 d-flex gap-2">
        <button class="btn btn-primary flex-fill">تطبيق</button>
<a class="btn btn-secondary flex-fill"
   href="{{ url_for('warehouse_bp.detail', warehouse_id=active_warehouse_id) }}">رجوع</a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped mb-0" id="products-table" data-active-warehouse-id="{{ active_warehouse_id }}">
        <thead class="table-light">
          <tr>
            <th>القطعة</th>
            <th>SKU</th>
            <th>رقم القطعة</th>
            <th>الماركة</th>
            <th class="text-end">سعر الشراء</th>
            <th class="text-end">سعر البيع</th>
            <th class="text-end">السعر</th>
            <th class="text-end">سعر الأونلاين</th>
            <th class="text-end">الكمية</th>
            <th class="text-end">الإجمالي (المحدد)</th>
          </tr>
        </thead>
        <tbody id="products-body"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function(){
      var DT=null;

      function csrfToken(){
        var m=document.querySelector('meta[name="csrf-token"]');if(m&&m.content)return m.content;
        var i=document.querySelector('input[name="csrf_token"]');if(i&&i.value)return i.value;
        var c=document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);return c?decodeURIComponent(c[1]):null;
      }

      function notify(msg,type){
        type=type||'info';
        var c=document.getElementById('notification-container');
        var el=document.createElement('div');
        el.className='alert alert-'+type+' alert-dismissible fade show shadow-sm mb-2';
        el.setAttribute('role','alert');
        var isBS5=!!(window.bootstrap&&window.bootstrap.Modal);
        var closeBtn=isBS5?'<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>':'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
        el.innerHTML=msg+closeBtn;
        c.appendChild(el);
        setTimeout(function(){if(!el.parentNode)return;el.classList.remove('show');setTimeout(function(){if(el.parentNode)el.parentNode.removeChild(el);},300);},4000);
      }

      function toStr(v){return v==null?'':String(v)}
      function fmt(n){if(n==null||n==='')return '';var x=Number(n);if(!isFinite(x))return String(n);return x.toLocaleString('ar-EG',{minimumFractionDigits:0,maximumFractionDigits:2})}

      function buildQuery(){
        var q=document.getElementById('q').value||'';
        var sel=document.getElementById('warehouse_ids');
        var params=['format=json'];
        if(q)params.push('q='+encodeURIComponent(q));
        if(sel){
          for(var i=0;i<sel.options.length;i++){
            var o=sel.options[i];
            if(o.selected)params.push('warehouse_ids='+encodeURIComponent(o.value));
          }
        }
        return params.join('&');
      }

function productsURL(){
  var aw = document.getElementById('products-table').dataset.activeWarehouseId;
  return '/api/v1/warehouses/' + aw + '/products';
}

      function renderRow(p){
        var tr=document.createElement('tr');
        tr.dataset.id=p.id;
        tr.innerHTML=
          '<td class="align-middle"><a href="/warehouses/parts/'+p.id+'">'+toStr(p.name||p.text)+'</a></td>'+
          '<td class="align-middle"><input class="form-control form-control-sm inline-input" data-field="sku" value="'+toStr(p.sku||'')+'"></td>'+
          '<td class="align-middle"><input class="form-control form-control-sm inline-input" data-field="part_number" value="'+toStr(p.part_number||'')+'"></td>'+
          '<td class="align-middle"><input class="form-control form-control-sm inline-input" data-field="brand" value="'+toStr(p.brand||'')+'"></td>'+
          '<td class="align-middle text-end w-price"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="purchase_price" value="'+toStr(p.purchase_price!=null?p.purchase_price:'')+'"></td>'+
          '<td class="align-middle text-end w-price"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="selling_price" value="'+toStr(p.selling_price!=null?p.selling_price:'')+'"></td>'+
          '<td class="align-middle text-end w-price"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="price" value="'+toStr(p.price!=null?p.price:'')+'"></td>'+
          '<td class="align-middle text-end w-price"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="online_price" value="'+toStr(p.online_price!=null?p.online_price:'')+'"></td>'+
          '<td class="align-middle text-end w-qty"><input type="number" step="1" class="form-control form-control-sm inline-input text-end" data-field="quantity" value="'+toStr(p.quantity!=null?p.quantity:'0')+'"></td>'+
          '<td class="align-middle text-end" data-role="total_quantity">'+fmt(p.total_quantity||0)+'</td>';
        return tr;
      }

      function initDT(){
        if(!(window.jQuery&&jQuery.fn.DataTable))return;
        if(!DT){
          DT=window.jQuery('#products-table').DataTable({
            pageLength:25,
            order:[],
            responsive:true,
            autoWidth:false,
            language:{ url:"{{ url_for('static', filename='datatables/Arabic.json') }}" }
          });
        }
      }

      function loadProducts(){
        var url=productsURL()+'?'+buildQuery();
        var tbody=document.getElementById('products-body');
        fetch(url,{headers:{'X-Requested-With':'XMLHttpRequest'},credentials:'same-origin'})
          .then(function(r){return r.json()})
          .then(function(res){
            var arr=(res&&res.results)?res.results:[];
            if(window.jQuery&&jQuery.fn.DataTable&&DT){
              DT.clear();
              for(var i=0;i<arr.length;i++){ DT.row.add( renderRow(arr[i]) ); }
              DT.draw(false);
            }else{
              var frag=document.createDocumentFragment();
              for(var j=0;j<arr.length;j++){ frag.appendChild(renderRow(arr[j])); }
              tbody.innerHTML='';
              tbody.appendChild(frag);
              initDT();
            }
          })
          .catch(function(){notify('تعذر جلب البيانات','danger')});
      }

      function saveInline(productId, field, value){
        var aw=document.getElementById('products-table').dataset.activeWarehouseId;
        var url='/warehouses/'+aw+'/products/'+productId;
        var payload={};payload[field]=value;
        return fetch(url,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Requested-With':'XMLHttpRequest',
            'X-CSRFToken':csrfToken()||''
          },
          credentials:'same-origin',
          body:JSON.stringify(payload)
        }).then(function(res){
          return res.json().catch(function(){return{}}).then(function(data){
            if(!res.ok || data.ok===false){
              var msg=(data&&(data.error||data.message))||'فشل الحفظ';
              throw new Error(msg);
            }
            return data;
          });
        });
      }

      function onEditCommit(e){
        var input=e.target;
        if(!input.classList.contains('inline-input'))return;
        var tr=input.closest('tr');if(!tr)return;
        var id=tr.dataset.id;
        var field=input.dataset.field;
        var val=input.value;
        var old=input.dataset.oldValue;if(old==null){old=''+val}
        if(input.dataset.saving==='1')return;
        input.dataset.saving='1';
        saveInline(id,field,val).then(function(data){
          if(field==='quantity'){
            var tq=tr.querySelector('[data-role="total_quantity"]');
            if(tq&&typeof data.total_quantity!=='undefined'){tq.textContent=fmt(data.total_quantity)}
            if(typeof data.quantity!=='undefined'&&data.quantity!==null){
              var qInput=tr.querySelector('input[data-field="quantity"]');
              if(qInput)qInput.value=data.quantity;
            }
          }
          if(data&&data.product){
            var p=data.product;
            if(typeof p.purchase_price!=='undefined'){tr.querySelector('input[data-field="purchase_price"]').value=p.purchase_price!=null?p.purchase_price:''}
            if(typeof p.selling_price!=='undefined'){tr.querySelector('input[data-field="selling_price"]').value=p.selling_price!=null?p.selling_price:''}
            if(typeof p.price!=='undefined'){tr.querySelector('input[data-field="price"]').value=p.price!=null?p.price:''}
            if(typeof p.online_price!=='undefined'){tr.querySelector('input[data-field="online_price"]').value=p.online_price!=null?p.online_price:''}
            if(typeof p.sku!=='undefined'){tr.querySelector('input[data-field="sku"]').value=p.sku||''}
            if(typeof p.part_number!=='undefined'){tr.querySelector('input[data-field="part_number"]').value=p.part_number||''}
            if(typeof p.brand!=='undefined'){tr.querySelector('input[data-field="brand"]').value=p.brand||''}
          }
          input.dataset.oldValue=''+val;
          notify('تم الحفظ','success');
        }).catch(function(err){
          if(old!=null)input.value=old;
          notify(err&&err.message?err.message:'فشل الحفظ','danger');
        }).finally(function(){delete input.dataset.saving});
      }

      function onInputFocus(e){
        var input=e.target;
        if(!input.classList.contains('inline-input'))return;
        input.dataset.oldValue=input.value;
      }

      function onInputKey(e){
        if(!e.target.classList.contains('inline-input'))return;
        if(e.key==='Enter'){e.preventDefault();e.target.blur();}
        if(e.key==='Escape'){if(e.target.dataset.oldValue!=null)e.target.value=e.target.dataset.oldValue;e.target.blur();}
      }

      document.getElementById('filter-form').addEventListener('submit',function(e){e.preventDefault();loadProducts();});
      document.getElementById('products-table').addEventListener('change',onEditCommit);
      document.getElementById('products-table').addEventListener('focusin',onInputFocus);
      document.getElementById('products-table').addEventListener('keydown',onInputKey);

      loadProducts();
    })();
  </script>
{% endblock %}
