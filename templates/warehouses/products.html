{% extends 'warehouses/base.html' %}
{% block page_title %}عرض المخزون عبر مستودعات محددة{% endblock %}

{% block breadcrumb %}
  {{ super() }}
{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/warehouses.css') }}">
  <style>
    .inline-input{width:100%;min-width:90px;max-width:140px}
    .w-qty{min-width:90px;max-width:110px}
    .w-price{min-width:100px;max-width:130px}
    #notification-container{position:fixed;top:20px;right:20px;z-index:2000}
    
    .sticky-column {
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 10;
      border-right: 2px solid #dee2e6;
    }
    
    .table th { white-space: nowrap; font-weight: 600; font-size: 0.9rem; }
    .table td { vertical-align: middle; font-size: 0.9rem; }
    
    .column-hidden { display: none !important; }
    
    .stat-card {
      transition: transform 0.2s;
      border-left: 4px solid;
    }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card.primary { border-left-color: #007bff; }
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.danger { border-left-color: #dc3545; }
    
    @media (max-width: 768px) {
      .btn-group { flex-wrap: wrap; gap: 0.25rem; }
      .btn-group .btn { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
      .inline-input { min-width: 60px; max-width: 100px; }
    }
    
    /* Print Styles */
    @media print {
      /* Hide unnecessary elements */
      .sidebar, .navbar, .breadcrumb, .btn-group, .card-header .d-flex .btn-group,
      button, .btn, input[type="button"], input[type="submit"], 
      footer, .footer, #notification-container, .no-print {
        display: none !important;
      }
      
      /* Reset page margins */
      @page {
        size: A4 landscape;
        margin: 1cm;
      }
      
      body {
        margin: 0;
        padding: 10px;
        font-size: 11pt;
      }
      
      /* Make table full width */
      .card, .card-body, .table-responsive {
        box-shadow: none !important;
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Print header */
      .card-header {
        background: white !important;
        border-bottom: 2px solid #000 !important;
        padding: 10px 0 !important;
        margin-bottom: 10px;
      }
      
      .card-header h6 {
        font-size: 14pt;
        color: #000 !important;
      }
      
      /* Table styling */
      table {
        width: 100% !important;
        border-collapse: collapse !important;
        page-break-inside: auto;
      }
      
      thead {
        display: table-header-group;
        background: #f0f0f0 !important;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      th, td {
        border: 1px solid #000 !important;
        padding: 6px !important;
        font-size: 10pt !important;
        text-align: right !important;
      }
      
      th {
        background: #e0e0e0 !important;
        font-weight: bold !important;
        color: #000 !important;
      }
      
      /* Hide inputs, show values */
      input, select {
        border: none !important;
        background: none !important;
        padding: 0 !important;
        font-size: 10pt !important;
      }
      
      /* Hide filter form */
      #filter-form {
        display: none !important;
      }
      
      /* Hide statistics cards */
      .stat-card, .row.mb-4:has(.stat-card) {
        display: none !important;
      }
      
      /* Show print header */
      .print-header {
        display: block !important;
      }
      
      /* Sticky column fix for print */
      .sticky-column {
        position: static !important;
        background: white !important;
      }
      
      /* Hide hidden columns in print too */
      .column-hidden {
        display: none !important;
      }
      
      /* Add print header */
      .print-header {
        text-align: center;
        margin-bottom: 15px;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
      }
      
      .print-header h2 {
        margin: 0;
        font-size: 18pt;
      }
      
      .print-date {
        font-size: 10pt;
        color: #666;
      }
      
      /* Page numbers */
      .page-footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        font-size: 9pt;
        border-top: 1px solid #000;
        padding-top: 5px;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div id="notification-container"></div>

<!-- Print Header (Only visible when printing) -->
<div class="print-header d-none d-print-block">
  <h2>📦 تقرير المخزون - {{ warehouse.name }}</h2>
  <div class="print-date">
    <strong>التاريخ:</strong> {{ now().strftime('%Y-%m-%d %H:%M') }} | 
    <strong>عدد المنتجات:</strong> {{ rows|length }} | 
    <strong>المستودعات:</strong> {{ whs|map(attribute='name')|join('، ') }}
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card primary shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-primary fw-bold small mb-1">إجمالي المنتجات</div>
            <div class="h5 mb-0 fw-bold" id="stat-total-products">{{ rows|length }}</div>
          </div>
          <i class="fas fa-boxes fa-2x text-primary opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card success shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-success fw-bold small mb-1">إجمالي الكمية</div>
            <div class="h5 mb-0 fw-bold" id="stat-total-quantity">
              {% set total_qty = rows|sum(attribute='total')|int %}{{ total_qty }}
            </div>
          </div>
          <i class="fas fa-cubes fa-2x text-success opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card warning shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-warning fw-bold small mb-1">إجمالي القيمة (₪)</div>
            <div class="h5 mb-0 fw-bold" id="stat-total-value">
              {% set values = [] %}
              {% for r in rows %}
                {% set qty = r.total or 0 %}
                {% set price = r.product.selling_price or r.product.price or 0 %}
                {% set _ = values.append(qty * price) %}
              {% endfor %}
              {{ "%.2f"|format(values|sum) }}
            </div>
          </div>
          <i class="fas fa-dollar-sign fa-2x text-warning opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stat-card danger shadow-sm h-100 py-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-danger fw-bold small mb-1">منتجات نفدت</div>
            <div class="h5 mb-0 fw-bold" id="stat-out-of-stock">
              {% set out_of_stock = rows|selectattr('total', 'equalto', 0)|list|length %}{{ out_of_stock }}
            </div>
          </div>
          <i class="fas fa-exclamation-triangle fa-2x text-danger opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filter Form -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form id="filter-form" class="row g-3 align-items-end" method="get">
      <div class="col-lg-6">
        <label for="warehouse_ids" class="form-label">
          <i class="fas fa-warehouse me-1"></i>اختر المستودعات
        </label>
        <select id="warehouse_ids" class="form-select" name="warehouse_ids" multiple size="4">
          {% for w in warehouses %}
            <option value="{{ w.id }}" {% if w.id in selected_ids %}selected{% endif %}>{{ w.name }}</option>
          {% endfor %}
        </select>
        <small class="text-muted">
          <i class="fas fa-info-circle me-1"></i>استخدم Ctrl أو ⌘ للاختيار المتعدد
        </small>
      </div>
      <div class="col-lg-4">
        <label for="q" class="form-label">
          <i class="fas fa-search me-1"></i>بحث
        </label>
        <input id="q" name="q" type="search" class="form-control" value="{{ search }}" 
               placeholder="الاسم أو SKU أو رقم القطعة أو الماركة">
      </div>
      <div class="col-lg-2 d-flex gap-2">
        <button class="btn btn-primary flex-fill" type="submit">
          <i class="fas fa-filter me-1"></i>تطبيق
        </button>
        <a class="btn btn-secondary flex-fill" href="{{ url_for('warehouse_bp.detail', warehouse_id=active_warehouse_id) }}">
          <i class="fas fa-arrow-right me-1"></i>رجوع
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Products Table -->
<div class="card shadow-sm">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h6 class="mb-0">
        <i class="fas fa-boxes me-2"></i>قائمة المنتجات
        <span class="badge bg-primary ms-2">{{ rows|length }}</span>
      </h6>
      
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('sku')">
          <i class="fas fa-tag"></i> SKU
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('part_number')">
          <i class="fas fa-hashtag"></i> رقم القطعة
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('brand')">
          <i class="fas fa-star"></i> الماركة
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('purchase_price')">
          <i class="fas fa-shopping-cart"></i> التكلفة
        </button>
      </div>
      
      <button type="button" class="btn btn-success btn-sm" onclick="window.print()">
        <i class="fas fa-print me-1"></i>طباعة
      </button>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0" id="products-table">
        <thead class="table-light">
          <tr>
            <th class="sticky-column"><i class="fas fa-box me-1"></i>القطعة</th>
            <th class="column-sku column-hidden"><i class="fas fa-tag me-1"></i>SKU</th>
            <th class="column-part_number column-hidden"><i class="fas fa-hashtag me-1"></i>رقم القطعة</th>
            <th class="column-brand column-hidden"><i class="fas fa-star me-1"></i>الماركة</th>
            <th class="text-center"><i class="fas fa-money-bill me-1"></i>العملة</th>
            <th class="text-end column-purchase_price column-hidden"><i class="fas fa-receipt me-1"></i>التكلفة</th>
            <th class="text-end"><i class="fas fa-dollar-sign me-1"></i>سعر البيع</th>
            <th class="text-end"><i class="fas fa-cubes me-1"></i>الكمية</th>
            <th class="text-end"><i class="fas fa-calculator me-1"></i>الإجمالي</th>
            <th class="text-center no-print" style="width: 100px;"><i class="fas fa-cog me-1"></i>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
              {% set p = r.product %}
              <tr data-id="{{ p.id }}">
                <td class="sticky-column">
                  <a href="/warehouses/parts/{{ p.id }}" class="fw-bold text-decoration-none">{{ p.name }}</a>
                </td>
                <td class="column-sku column-hidden">
                  <input class="form-control form-control-sm inline-input" data-field="sku" 
                         data-id="{{ p.id }}" value="{{ p.sku or '' }}">
                </td>
                <td class="column-part_number column-hidden">
                  <input class="form-control form-control-sm inline-input" data-field="part_number" 
                         data-id="{{ p.id }}" value="{{ p.part_number or '' }}">
                </td>
                <td class="column-brand column-hidden">
                  <input class="form-control form-control-sm inline-input" data-field="brand" 
                         data-id="{{ p.id }}" value="{{ p.brand or '' }}">
                </td>
                <td class="text-center">
                  <select class="form-select form-select-sm inline-input" data-field="currency" 
                          data-id="{{ p.id }}" style="max-width:90px">
                    <option value="ILS" {% if p.currency=='ILS' %}selected{% endif %}>₪ ILS</option>
                    <option value="USD" {% if p.currency=='USD' %}selected{% endif %}>$ USD</option>
                    <option value="EUR" {% if p.currency=='EUR' %}selected{% endif %}>€ EUR</option>
                    <option value="JOD" {% if p.currency=='JOD' %}selected{% endif %}>د.أ JOD</option>
                  </select>
                </td>
                <td class="text-end column-purchase_price column-hidden">
                  <input type="number" step="0.01" class="form-control form-control-sm inline-input text-end w-price" 
                         data-field="purchase_price" data-id="{{ p.id }}" value="{{ p.purchase_price or '' }}">
                </td>
                <td class="text-end">
                  <input type="number" step="0.01" class="form-control form-control-sm inline-input text-end w-price" 
                         data-field="selling_price" data-id="{{ p.id }}" value="{{ p.selling_price or '' }}">
                </td>
                <td class="text-end">
                  <input type="number" step="1" class="form-control form-control-sm inline-input text-end w-qty" 
                         data-field="quantity" data-id="{{ p.id }}" value="{{ r.by.get(active_warehouse_id, {}).get('on', 0) }}">
                </td>
                <td class="text-end fw-bold">{{ r.total or 0 }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                لا توجد منتجات
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Print Footer (Only visible when printing) -->
<div class="page-footer d-none d-print-block">
  <small>
    شركة أزاد للأنظمة الذكية | 
    رام الله - فلسطين 🇵🇸 | 
    +970-562-150-193 | 
    ahmed@azad-systems.com
  </small>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function(){
      // Notification system
      function notify(message, type) {
        type = type || 'info';
        const container = document.getElementById('notification-container') || 
          (() => { const c = document.createElement('div'); c.id = 'notification-container'; document.body.appendChild(c); return c; })();
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `<strong>${message}</strong><button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        container.appendChild(alert);
        
        setTimeout(() => alert.remove(), 5000);
      }
      window.notify = notify;
      
      // Toggle column visibility
      function toggleColumn(columnName) {
        const headers = document.querySelectorAll(`.column-${columnName}`);
        const button = document.querySelector(`[onclick*="toggleColumn('${columnName}')"]`);
        
        headers.forEach(el => el.classList.toggle('column-hidden'));
        button?.classList.toggle('active');
      }
      window.toggleColumn = toggleColumn;
      
      // Get CSRF token
      function csrfToken(){
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta?.content) return meta.content;
        const input = document.querySelector('input[name="csrf_token"]');
        if (input?.value) return input.value;
        const cookie = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
        return cookie ? decodeURIComponent(cookie[1]) : null;
      }
      
      // Save inline edit
      async function saveInline(productId, field, value){
        const url = `/warehouses/{{ active_warehouse_id }}/products/${productId}`;
        const payload = { [field]: value };
        
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken() || ''
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          
          const data = await res.json();
          if (!res.ok || data.ok === false) {
            throw new Error(data?.error || data?.message || 'فشل الحفظ');
          }
          return data;
        } catch(err) {
          throw err;
        }
      }
      
      // Handle inline editing
      let saveTimeout = null;
      document.getElementById('products-table')?.addEventListener('change', async function(e) {
        const input = e.target;
        if (!input.classList.contains('inline-input')) return;
        
        const productId = input.dataset.id;
        const field = input.dataset.field;
        const value = input.value;
        
        if (input.dataset.saving === '1') return;
        input.dataset.saving = '1';
        input.disabled = true;
        
        try {
          await saveInline(productId, field, value);
          input.classList.add('border-success');
          setTimeout(() => input.classList.remove('border-success'), 2000);
          notify('تم الحفظ', 'success');
        } catch(err) {
          input.classList.add('border-danger');
          setTimeout(() => input.classList.remove('border-danger'), 2000);
          notify(err.message || 'فشل الحفظ', 'danger');
        } finally {
          delete input.dataset.saving;
          input.disabled = false;
        }
      });
      
      // Handle keyboard shortcuts
      document.getElementById('products-table')?.addEventListener('keydown', function(e) {
        if (!e.target.classList.contains('inline-input')) return;
        
        if (e.key === 'Enter') {
          e.preventDefault();
          e.target.blur();
        } else if (e.key === 'Escape') {
          e.target.value = e.target.defaultValue;
          e.target.blur();
        }
      });
      
    })();
  </script>
{% endblock %}
