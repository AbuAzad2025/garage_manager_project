{% extends 'warehouses/base.html' %}
{% block page_title %}عرض المخزون عبر مستودعات محددة{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/warehouses.css') }}">
  <style>
    .inline-input{width:100%;min-width:90px;max-width:140px}
    .w-qty{min-width:90px;max-width:110px}
    .w-price{min-width:100px;max-width:130px}
    #notification-container{position:fixed;top:20px;right:20px;z-index:2000}
    
    /* تحسينات الجدول */
    .sticky-column {
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 10;
      border-right: 2px solid #dee2e6;
    }
    
    .table th {
      white-space: nowrap;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .table td {
      vertical-align: middle;
      font-size: 0.9rem;
    }
    
    /* أزرار التحكم في الأعمدة */
    .btn-group .btn {
      border-radius: 0.375rem;
      margin: 0 2px;
    }
    
    .btn-group .btn.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    /* تحسين العرض للشاشات الصغيرة */
    @media (max-width: 768px) {
      .btn-group {
        flex-wrap: wrap;
        gap: 0.25rem;
      }
      
      .btn-group .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
      }
      
      .card-header .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 1rem;
      }
      
      .card-header .btn-group {
        width: 100%;
        justify-content: center;
      }
      
      .table-responsive {
        font-size: 0.8rem;
      }
      
      .inline-input {
        min-width: 60px;
        max-width: 100px;
      }
    }
    
    @media (max-width: 576px) {
      .btn-group .btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }
      
      .table th, .table td {
        padding: 0.3rem;
      }
    }
    
    /* تحسين الأعمدة المخفية */
    .column-hidden {
      display: none !important;
    }
    
    /* تحسين عرض الشركاء والموردين */
    .partners-list, .suppliers-list {
      max-width: 200px;
      font-size: 0.85rem;
    }
    
    .partner-item, .supplier-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.25rem 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .partner-item:last-child, .supplier-item:last-child {
      border-bottom: none;
    }
    
    .partner-item .badge, .supplier-item .badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
    }
    
    /* تحسين الأزرار */
    .btn-group .btn {
      transition: all 0.2s ease;
    }
    
    .btn-group .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* تحسين زر الطباعة */
    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none;
      box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
    }
    
    .border-left-primary {
      border-left: 4px solid #007bff !important;
    }
    
    .border-left-success {
      border-left: 4px solid #28a745 !important;
    }
    
    .border-left-warning {
      border-left: 4px solid #ffc107 !important;
    }
    
    .border-left-danger {
      border-left: 4px solid #dc3545 !important;
    }
    
    .text-xs {
      font-size: 0.7rem;
      letter-spacing: 0.5px;
    }
    
    .text-gray-800 {
      color: #5a5c69 !important;
    }
    
    .card.shadow {
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    }
    
    .card.shadow:hover {
      box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.25) !important;
      transform: translateY(-2px);
      transition: all 0.3s ease;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
{% endblock %}

{% block content %}
<div id="notification-container"></div>

<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">إجمالي المنتجات</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-total-products">0</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-boxes fa-2x text-primary"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">إجمالي الكمية</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-total-quantity">0</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-cubes fa-2x text-success"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">إجمالي القيمة (ILS)</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-total-value">0.00</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-dollar-sign fa-2x text-warning"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-left-danger shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">منتجات نفدت</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-out-of-stock">0</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form id="filter-form" class="row g-3 align-items-end" method="get">
      <div class="col-lg-6">
        <label for="warehouse_ids" class="form-label">
          <i class="fas fa-warehouse me-1"></i>اختر المستودعات
        </label>
        <select id="warehouse_ids" class="form-select" name="warehouse_ids" multiple size="4">
          {% for w in warehouses %}
            <option value="{{ w.id }}" {% if w.id in selected_ids %}selected{% endif %}>{{ w.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">
          <i class="fas fa-info-circle me-1"></i>استخدم Ctrl أو ⌘ للاختيار المتعدد
        </div>
      </div>
      <div class="col-lg-4">
        <label for="q" class="form-label">
          <i class="fas fa-search me-1"></i>بحث
        </label>
        <input id="q" name="q" type="search" class="form-control" value="{{ request.args.get('q','') }}" placeholder="الاسم أو SKU أو رقم القطعة أو الماركة">
      </div>
      <div class="col-lg-2 d-flex gap-2">
        <button class="btn btn-primary flex-fill" type="submit">
          <i class="fas fa-filter me-1"></i>تطبيق
        </button>
        <a class="btn btn-secondary flex-fill" href="{{ url_for('warehouse_bp.detail', warehouse_id=active_warehouse_id) }}">
          <i class="fas fa-arrow-right me-1"></i>رجوع
        </a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-0">
        <i class="fas fa-boxes me-2"></i>قائمة المنتجات
        <span class="badge bg-primary ms-2" id="products-count">0</span>
      </h6>
      
      <!-- أزرار التحكم في الأعمدة -->
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('sku')" title="إظهار/إخفاء SKU">
          <i class="fas fa-tag"></i> SKU
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('part_number')" title="إظهار/إخفاء رقم القطعة">
          <i class="fas fa-hashtag"></i> رقم القطعة
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('brand')" title="إظهار/إخفاء الماركة">
          <i class="fas fa-star"></i> الماركة
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('purchase_price')" title="إظهار/إخفاء سعر الشراء">
          <i class="fas fa-shopping-cart"></i> سعر الشراء
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('online_price')" title="إظهار/إخفاء سعر الأونلاين">
          <i class="fas fa-globe"></i> سعر الأونلاين
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('partners')" title="إظهار/إخفاء الشركاء">
          <i class="fas fa-handshake"></i> الشركاء
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('suppliers')" title="إظهار/إخفاء الموردين">
          <i class="fas fa-truck"></i> الموردين
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('created_at')" title="إظهار/إخفاء تاريخ الإضافة">
          <i class="fas fa-calendar"></i> تاريخ الإضافة
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleColumn('status')" title="إظهار/إخفاء الحالة">
          <i class="fas fa-info-circle"></i> الحالة
        </button>
      </div>
      
      <!-- زر الطباعة -->
      <div class="ms-3">
        <button type="button" class="btn btn-success btn-sm" onclick="printTable()" title="طباعة الجدول">
          <i class="fas fa-print me-1"></i>طباعة
        </button>
      </div>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped mb-0" id="products-table" data-active-warehouse-id="{{ active_warehouse_id }}">
        <thead class="table-light">
          <tr>
            <th class="sticky-column">
              <i class="fas fa-box me-1"></i>القطعة
            </th>
            <th class="column-sku" style="display: none;">
              <i class="fas fa-tag me-1"></i>SKU
            </th>
            <th class="column-part_number" style="display: none;">
              <i class="fas fa-hashtag me-1"></i>رقم القطعة
            </th>
            <th class="column-brand" style="display: none;">
              <i class="fas fa-star me-1"></i>الماركة
            </th>
            <th class="text-end column-purchase_price" style="display: none;">
              <i class="fas fa-shopping-cart me-1"></i>سعر الشراء
            </th>
            <th class="text-end">
              <i class="fas fa-dollar-sign me-1"></i>سعر البيع
            </th>
            <th class="text-end">
              <i class="fas fa-tag me-1"></i>السعر
            </th>
            <th class="text-end column-online_price" style="display: none;">
              <i class="fas fa-globe me-1"></i>سعر الأونلاين
            </th>
            <th class="text-end">
              <i class="fas fa-cubes me-1"></i>الكمية
            </th>
            <th class="text-end">
              <i class="fas fa-calculator me-1"></i>الإجمالي
            </th>
            <th class="column-partners" style="display: none;">
              <i class="fas fa-handshake me-1"></i>الشركاء
            </th>
            <th class="column-suppliers" style="display: none;">
              <i class="fas fa-truck me-1"></i>الموردين
            </th>
            <th class="column-created_at" style="display: none;">
              <i class="fas fa-calendar me-1"></i>تاريخ الإضافة
            </th>
            <th class="column-status" style="display: none;">
              <i class="fas fa-info-circle me-1"></i>الحالة
            </th>
          </tr>
        </thead>
        <tbody id="products-body"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function(){
      var DT=null;
      
      // إدارة الأعمدة
      function toggleColumn(columnName) {
        const header = document.querySelector(`.column-${columnName}`);
        const button = document.querySelector(`[onclick="toggleColumn('${columnName}')"]`);
        
        if (header.style.display === 'none') {
          // إظهار العمود
          header.style.display = '';
          button.classList.add('active');
          
          // إظهار الخلايا في الجدول
          const cells = document.querySelectorAll(`td.column-${columnName}`);
          cells.forEach(cell => {
            cell.style.display = '';
          });
          
          // إذا كان DataTable موجود، إعادة رسم الجدول
          if (DT) {
            DT.columns.adjust();
          }
        } else {
          // إخفاء العمود
          header.style.display = 'none';
          button.classList.remove('active');
          
          // إخفاء الخلايا في الجدول
          const cells = document.querySelectorAll(`td.column-${columnName}`);
          cells.forEach(cell => {
            cell.style.display = 'none';
          });
          
          // إذا كان DataTable موجود، إعادة رسم الجدول
          if (DT) {
            DT.columns.adjust();
          }
        }
      }
      
      // جعل الدالة متاحة عالمياً
      window.toggleColumn = toggleColumn;
      
      // دالة الطباعة
      function printTable() {
        var table = document.getElementById('products-table');
        var rows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
        if (rows.length === 0) {
          alert('لا توجد بيانات للطباعة');
          return;
        }
        
        var rowsPerPage = 25;
        var estimatedPages = Math.ceil(rows.length / rowsPerPage);
        
        var msg = 'سيتم طباعة ' + rows.length + ' منتج';
        if (estimatedPages > 1) {
          msg += ' في حوالي ' + estimatedPages + ' صفحة';
        }
        
        if (estimatedPages > 10) {
          msg = 'تحذير: ' + msg + '\nهل تريد المتابعة؟';
          if (!confirm(msg)) return;
        } else if (estimatedPages > 1) {
          msg += '\nهل تريد المتابعة؟';
          if (!confirm(msg)) return;
        }
        
        // إنشاء نافذة طباعة
        var printWindow = window.open('', '_blank');
        var printContent = generatePrintContent();
        
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
      }
      
      // إنشاء محتوى الطباعة
      function generatePrintContent() {
        var table = document.getElementById('products-table');
        var visibleColumns = getVisibleColumns();
        var rows = table.querySelectorAll('tbody tr');
        
        var content = `
          <!DOCTYPE html>
          <html dir="rtl" lang="ar">
          <head>
            <meta charset="UTF-8">
            <title>قائمة المنتجات - ${new Date().toLocaleDateString('ar-SA')}</title>
            <style>
              body { font-family: 'Arial', sans-serif; font-size: 12px; margin: 20px; }
              .header { text-align: center; margin-bottom: 30px; }
              .header h1 { color: #333; margin-bottom: 10px; }
              .header .date { color: #666; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
              th { background-color: #f5f5f5; font-weight: bold; }
              .partners-list, .suppliers-list { font-size: 10px; }
              .badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; }
              .bg-info { background-color: #17a2b8; color: white; }
              .bg-warning { background-color: #ffc107; color: black; }
              .bg-success { background-color: #28a745; color: white; }
              .bg-danger { background-color: #dc3545; color: white; }
              .bg-secondary { background-color: #6c757d; color: white; }
              @media print {
                body { margin: 0; }
                .no-print { display: none; }
              }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>قائمة المنتجات</h1>
              <div class="date">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</div>
              <div class="date">إجمالي المنتجات: ${rows.length}</div>
            </div>
            
            <table>
              <thead>
                <tr>
                  ${generatePrintHeaders(visibleColumns)}
                </tr>
              </thead>
              <tbody>
                ${generatePrintRows(rows, visibleColumns)}
              </tbody>
            </table>
          </body>
          </html>
        `;
        
        return content;
      }
      
      // الحصول على الأعمدة المرئية
      function getVisibleColumns() {
        var headers = document.querySelectorAll('#products-table thead th');
        var visible = [];
        
        headers.forEach(function(header, index) {
          if (header.style.display !== 'none' && !header.classList.contains('column-hidden')) {
            visible.push({
              index: index,
              text: header.textContent.trim(),
              class: header.className
            });
          }
        });
        
        return visible;
      }
      
      // إنشاء رؤوس الطباعة
      function generatePrintHeaders(visibleColumns) {
        return visibleColumns.map(col => `<th>${col.text}</th>`).join('');
      }
      
      // إنشاء صفوف الطباعة
      function generatePrintRows(rows, visibleColumns) {
        var html = '';
        
        rows.forEach(function(row) {
          var cells = row.querySelectorAll('td');
          var rowHtml = '<tr>';
          
          visibleColumns.forEach(function(col) {
            var cell = cells[col.index];
            if (cell) {
              var cellContent = cell.innerHTML;
              // تنظيف المحتوى للطباعة
              cellContent = cellContent.replace(/<input[^>]*>/g, function(match) {
                var input = document.createElement('div');
                input.innerHTML = match;
                var inputEl = input.querySelector('input');
                return inputEl ? inputEl.value : '';
              });
              rowHtml += '<td>' + cellContent + '</td>';
            }
          });
          
          rowHtml += '</tr>';
          html += rowHtml;
        });
        
        return html;
      }
      
      // جعل دالة الطباعة متاحة عالمياً
      window.printTable = printTable;

      function csrfToken(){
        var m=document.querySelector('meta[name="csrf-token"]');if(m&&m.content)return m.content;
        var i=document.querySelector('input[name="csrf_token"]');if(i&&i.value)return i.value;
        var c=document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);return c?decodeURIComponent(c[1]):null;
      }

      function notify(msg,type){
        type=type||'info';
        var c=document.getElementById('notification-container');
        var el=document.createElement('div');
        el.className='alert alert-'+type+' alert-dismissible fade show shadow-sm mb-2';
        el.setAttribute('role','alert');
        var isBS5=!!(window.bootstrap&&window.bootstrap.Modal);
        var closeBtn=isBS5?'<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>':'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
        el.innerHTML=msg+closeBtn;
        c.appendChild(el);
        setTimeout(function(){if(!el.parentNode)return;el.classList.remove('show');setTimeout(function(){if(el.parentNode)el.parentNode.removeChild(el);},300);},4000);
      }

      function toStr(v){return v==null?'':String(v)}
      function fmt(n){if(n==null||n==='')return '';var x=Number(n);if(!isFinite(x))return String(n);return x.toLocaleString('ar-EG',{minimumFractionDigits:0,maximumFractionDigits:2})}

      function buildQuery(){
        var q=document.getElementById('q').value||'';
        var sel=document.getElementById('warehouse_ids');
        var params=['format=json'];
        if(q)params.push('q='+encodeURIComponent(q));
        if(sel){
          for(var i=0;i<sel.options.length;i++){
            var o=sel.options[i];
            if(o.selected)params.push('warehouse_ids='+encodeURIComponent(o.value));
          }
        }
        return params.join('&');
      }

function productsURL(){
  var aw = document.getElementById('products-table').dataset.activeWarehouseId;
  // إذا كان هناك مستودع واحد محدد في الفلتر، استخدمه كـ wid للـ API
  var selected = (function(){
    var ids=[];
    var sel=document.querySelector('#filter-form select[name="warehouse_ids"]');
    if(sel){
      var opts=sel.options;
      for(var i=0;i<opts.length;i++){
        var o=opts[i];
        if(o.selected){ ids.push(o.value); }
      }
    }
    return ids;
  })();
  var wid = (selected && selected.length===1) ? selected[0] : aw;
  return '/api/warehouses/' + wid + '/products';
}

      function renderRow(p){
        var tr=document.createElement('tr');
        tr.dataset.id=p.id;
        
        tr.innerHTML=
          // العمود الأساسي - القطعة (دائماً مرئي)
          '<td class="align-middle sticky-column"><a href="/warehouses/parts/'+p.id+'" class="fw-bold text-decoration-none">'+toStr(p.name||p.text)+'</a></td>'+
          
          // الأعمدة المخفية افتراضياً
          '<td class="align-middle column-sku" style="display: none;"><input class="form-control form-control-sm inline-input" data-field="sku" value="'+toStr(p.sku||'')+'"></td>'+
          '<td class="align-middle column-part_number" style="display: none;"><input class="form-control form-control-sm inline-input" data-field="part_number" value="'+toStr(p.part_number||'')+'"></td>'+
          '<td class="align-middle column-brand" style="display: none;"><input class="form-control form-control-sm inline-input" data-field="brand" value="'+toStr(p.brand||'')+'"></td>'+
          '<td class="align-middle text-end w-price column-purchase_price" style="display: none;"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="purchase_price" value="'+toStr(p.purchase_price!=null?p.purchase_price:'')+'"></td>'+
          
          // الأعمدة المرئية افتراضياً
          '<td class="align-middle text-end w-price"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="selling_price" value="'+toStr(p.selling_price!=null?p.selling_price:'')+'"></td>'+
          '<td class="align-middle text-end w-price"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="price" value="'+toStr(p.price!=null?p.price:'')+'"></td>'+
          '<td class="align-middle text-end w-price column-online_price" style="display: none;"><input type="number" step="0.01" class="form-control form-control-sm inline-input text-end" data-field="online_price" value="'+toStr(p.online_price!=null?p.online_price:'')+'"></td>'+
          '<td class="align-middle text-end w-qty"><input type="number" step="1" class="form-control form-control-sm inline-input text-end" data-field="quantity" value="'+toStr(p.quantity!=null?p.quantity:'0')+'"></td>'+
          '<td class="align-middle text-end fw-bold" data-role="total_quantity">'+fmt(p.total_quantity||0)+'</td>'+
          
          // أعمدة الشركاء والموردين
          '<td class="align-middle column-partners" style="display: none;"><div class="partners-list">'+formatPartners(p.partners||[])+'</div></td>'+
          '<td class="align-middle column-suppliers" style="display: none;"><div class="suppliers-list">'+formatSuppliers(p.suppliers||[])+'</div></td>'+
          
          // أعمدة إضافية
          '<td class="align-middle column-created_at" style="display: none;"><small class="text-muted">'+formatDate(p.created_at)+'</small></td>'+
          '<td class="align-middle column-status" style="display: none;"><span class="badge '+getStatusBadgeClass(p.status)+'">'+getStatusText(p.status)+'</span></td>';
        return tr;
      }
      
      // تحديد نوع المستودع
      var cachedWarehouseType = null;
      
      function getWarehouseType() {
        if (cachedWarehouseType) return cachedWarehouseType;
        
        var activeWarehouseId = document.getElementById('products-table').dataset.activeWarehouseId;
        // إن وُجد مستودع واحد محدد في الفلتر، استخدمه للاستعلام عن نوع المستودع
        var sel=document.querySelector('#filter-form select[name="warehouse_ids"]');
        if(sel){
          var chosen=[]; var opts=sel.options;
          for(var i=0;i<opts.length;i++){ if(opts[i].selected){ chosen.push(opts[i].value); } }
          if(chosen.length===1){ activeWarehouseId = chosen[0]; }
        }
        if (activeWarehouseId) {
          fetch('/warehouses/api/warehouse-info?id=' + activeWarehouseId, {
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            credentials: 'same-origin'
          })
          .then(r => r.json())
          .then(data => {
            cachedWarehouseType = data.type || 'MAIN';
            updateColumnsByWarehouseType();
          })
          .catch(e => {
            cachedWarehouseType = 'MAIN';
            updateColumnsByWarehouseType();
          });
        } else {
          cachedWarehouseType = 'MAIN';
          updateColumnsByWarehouseType();
        }
        return cachedWarehouseType || 'MAIN';
      }
      
      
      
      function updateColumnsByWarehouseType() {
        var warehouseType = cachedWarehouseType || 'MAIN';
        
        var partnersBtn = document.querySelector('[onclick="toggleColumn(\'partners\')"]');
        var suppliersBtn = document.querySelector('[onclick="toggleColumn(\'suppliers\')"]');
        
        if (warehouseType === 'PARTNER') {
          if (partnersBtn && !partnersBtn.classList.contains('active')) {
            toggleColumn('partners');
          }
          if (suppliersBtn && suppliersBtn.classList.contains('active')) {
            toggleColumn('suppliers');
          }
        } else if (warehouseType === 'EXCHANGE') {
          if (suppliersBtn && !suppliersBtn.classList.contains('active')) {
            toggleColumn('suppliers');
          }
          if (partnersBtn && partnersBtn.classList.contains('active')) {
            toggleColumn('partners');
          }
        } else {
          if (partnersBtn && partnersBtn.classList.contains('active')) {
            toggleColumn('partners');
          }
          if (suppliersBtn && suppliersBtn.classList.contains('active')) {
            toggleColumn('suppliers');
          }
        }
      }
      
      function formatPartners(partners) {
        if (!Array.isArray(partners) || partners.length === 0) {
          return '<span class="text-muted small" title="لا يوجد شركاء مُحددين لهذا المنتج">-</span>';
        }
        return partners.map(p => 
          '<div class="partner-item">' +
            '<span class="fw-bold small">' + toStr(p.name) + '</span>' +
            '<span class="badge bg-info ms-1 small">' + (p.share_percent || 0) + '%</span>' +
          '</div>'
        ).join('');
      }
      
      function formatSuppliers(suppliers) {
        if (!Array.isArray(suppliers) || suppliers.length === 0) {
          return '<span class="text-muted small" title="لا يوجد موردين مُحددين لهذا المنتج">-</span>';
        }
        return suppliers.map(s => 
          '<div class="supplier-item">' +
            '<span class="fw-bold small">' + toStr(s.name) + '</span>' +
            (s.quantity ? '<span class="badge bg-warning text-dark ms-1 small">' + s.quantity + ' قطعة</span>' : '') +
          '</div>'
        ).join('');
      }
      
      // تنسيق التاريخ
      function formatDate(dateStr) {
        if (!dateStr) return 'غير محدد';
        try {
          var date = new Date(dateStr);
          return date.toLocaleDateString('ar-SA');
        } catch (e) {
          return 'غير صحيح';
        }
      }
      
      // فئة الحالة
      function getStatusBadgeClass(status) {
        switch(status) {
          case 'active': return 'bg-success';
          case 'inactive': return 'bg-secondary';
          case 'out_of_stock': return 'bg-danger';
          default: return 'bg-info';
        }
      }
      
      // نص الحالة
      function getStatusText(status) {
        switch(status) {
          case 'active': return 'نشط';
          case 'inactive': return 'غير نشط';
          case 'out_of_stock': return 'نفد المخزون';
          default: return 'غير محدد';
        }
      }

      function initDT(){
        if(!(window.jQuery&&jQuery.fn.DataTable))return;
        if(DT) return; // تم تهيئته مسبقاً
        
        var $table = window.jQuery('#products-table');
        if (!$table.length) return;
        
        // تحقق من وجود بيانات
        var dataRows = $table.find('tbody tr');
        if (dataRows.length === 0) return; // لا نهيئ جدول فارغ
        
        try {
          DT = $table.DataTable({
            pageLength: 25,
            order: [],
            responsive: true,
            autoWidth: false,
            language: { 
              url: "{{ url_for('static', filename='datatables/Arabic.json') }}",
              emptyTable: "لا توجد منتجات",
              info: "عرض _START_ إلى _END_ من أصل _TOTAL_",
              search: "بحث:",
              paginate: { first: "الأول", last: "الأخير", next: "التالي", previous: "السابق" }
            }
          });
        } catch (e) {
          console.error('Products DataTable failed:', e);
        }
      }

      var isLoading = false;
      
      function updateStatistics(products) {
        var totalProducts = products.length;
        var totalQuantity = 0;
        var totalValue = 0;
        var outOfStock = 0;
        
        products.forEach(function(p) {
          var qty = parseInt(p.total_quantity || p.quantity || 0);
          var price = parseFloat(p.price || p.selling_price || 0);
          
          totalQuantity += qty;
          totalValue += qty * price;
          
          if (qty === 0) {
            outOfStock++;
          }
        });
        
        document.getElementById('stat-total-products').textContent = totalProducts.toLocaleString('en-US');
        document.getElementById('stat-total-quantity').textContent = totalQuantity.toLocaleString('en-US');
        document.getElementById('stat-total-value').textContent = totalValue.toLocaleString('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        document.getElementById('stat-out-of-stock').textContent = outOfStock.toLocaleString('en-US');
        
        var outOfStockCard = document.getElementById('stat-out-of-stock').closest('.card');
        if (outOfStock > 0) {
          outOfStockCard.classList.add('pulse');
        } else {
          outOfStockCard.classList.remove('pulse');
        }
      }
      
      function loadProducts(){
        if (isLoading) {
          console.warn('Already loading, please wait...');
          return;
        }
        
        // إعادة تعيين cachedWarehouseType عند كل تحميل لضمان التحديث
        cachedWarehouseType = null;
        
        isLoading = true;
        var url=productsURL()+'?'+buildQuery();
        var tbody=document.getElementById('products-body');
        var submitBtn = document.querySelector('#filter-form button[type="submit"]');
        
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري التحميل...';
        }
        
        tbody.innerHTML = '<tr><td colspan="16" class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';
        
        var controller = new AbortController();
        var timeoutId = setTimeout(function() {
          controller.abort();
        }, 30000);
        
        fetch(url,{
          headers:{'X-Requested-With':'XMLHttpRequest'},
          credentials:'same-origin',
          signal: controller.signal
        })
          .then(function(r){
            if (!r.ok) {
              throw new Error('HTTP ' + r.status);
            }
            return r.json();
          })
          .then(function(res){
            var arr = [];
            if (res && res.results) {
              arr = res.results;
            } else if (res && res.data) {
              arr = res.data;
            } else if (Array.isArray(res)) {
              arr = res;
            }
            
            if (res && res.error) {
              throw new Error(res.error);
            }
            
            document.getElementById('products-count').textContent = arr.length;
            
            if (arr.length === 0) {
              tbody.innerHTML = '<tr><td colspan="16" class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2 d-block"></i>لا توجد منتجات</td></tr>';
              return;
            }
            
            if (arr.length > 200) {
              notify('تحذير: يتم عرض ' + arr.length + ' منتج. قد يكون التحميل بطيئاً.', 'warning');
            }
            
            updateStatistics(arr);
            // تأخير قصير لضمان تحديث الأعمدة أولاً
            setTimeout(function() {
              updateColumnsByWarehouseType();
            }, 100);
            
            if(window.jQuery&&jQuery.fn.DataTable&&DT){
              DT.clear();
              for(var i=0;i<arr.length;i++){ 
                DT.row.add( renderRow(arr[i]) ); 
              }
              DT.draw(false);
            }else{
              var frag=document.createDocumentFragment();
              for(var j=0;j<arr.length;j++){ 
                frag.appendChild(renderRow(arr[j])); 
              }
              tbody.innerHTML='';
              tbody.appendChild(frag);
              initDT();
            }
          })
          .catch(function(err){
            console.error('Load products error:', err);
            tbody.innerHTML = '<tr><td colspan="16" class="text-center text-danger"><i class="fas fa-exclamation-circle"></i> تعذر جلب البيانات: ' + err.message + '</td></tr>';
            notify('تعذر جلب البيانات: ' + err.message,'danger');
          })
          .finally(function(){
            clearTimeout(timeoutId);
            isLoading = false;
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-filter me-1"></i>تطبيق';
            }
          });
      }

      function saveInline(productId, field, value){
        var aw=document.getElementById('products-table').dataset.activeWarehouseId;
        var url='/warehouses/'+aw+'/products/'+productId;
        var payload={};payload[field]=value;
        return fetch(url,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Requested-With':'XMLHttpRequest',
            'X-CSRFToken':csrfToken()||''
          },
          credentials:'same-origin',
          body:JSON.stringify(payload)
        }).then(function(res){
          return res.json().catch(function(){return{}}).then(function(data){
            if(!res.ok || data.ok===false){
              var msg=(data&&(data.error||data.message))||'فشل الحفظ';
              throw new Error(msg);
            }
            return data;
          });
        });
      }

      function onEditCommit(e){
        var input=e.target;
        if(!input.classList.contains('inline-input'))return;
        var tr=input.closest('tr');if(!tr)return;
        var id=tr.dataset.id;
        var field=input.dataset.field;
        var val=input.value;
        var old=input.dataset.oldValue;if(old==null){old=''+val}
        if(input.dataset.saving==='1')return;
        input.dataset.saving='1';
        saveInline(id,field,val).then(function(data){
          if(field==='quantity'){
            var tq=tr.querySelector('[data-role="total_quantity"]');
            if(tq&&typeof data.total_quantity!=='undefined'){tq.textContent=fmt(data.total_quantity)}
            if(typeof data.quantity!=='undefined'&&data.quantity!==null){
              var qInput=tr.querySelector('input[data-field="quantity"]');
              if(qInput)qInput.value=data.quantity;
            }
          }
          if(data&&data.product){
            var p=data.product;
            if(typeof p.purchase_price!=='undefined'){tr.querySelector('input[data-field="purchase_price"]').value=p.purchase_price!=null?p.purchase_price:''}
            if(typeof p.selling_price!=='undefined'){tr.querySelector('input[data-field="selling_price"]').value=p.selling_price!=null?p.selling_price:''}
            if(typeof p.price!=='undefined'){tr.querySelector('input[data-field="price"]').value=p.price!=null?p.price:''}
            if(typeof p.online_price!=='undefined'){tr.querySelector('input[data-field="online_price"]').value=p.online_price!=null?p.online_price:''}
            if(typeof p.sku!=='undefined'){tr.querySelector('input[data-field="sku"]').value=p.sku||''}
            if(typeof p.part_number!=='undefined'){tr.querySelector('input[data-field="part_number"]').value=p.part_number||''}
            if(typeof p.brand!=='undefined'){tr.querySelector('input[data-field="brand"]').value=p.brand||''}
          }
          input.dataset.oldValue=''+val;
          notify('تم الحفظ','success');
        }).catch(function(err){
          if(old!=null)input.value=old;
          notify(err&&err.message?err.message:'فشل الحفظ','danger');
        }).finally(function(){delete input.dataset.saving});
      }

      function onInputFocus(e){
        var input=e.target;
        if(!input.classList.contains('inline-input'))return;
        input.dataset.oldValue=input.value;
      }

      function onInputKey(e){
        if(!e.target.classList.contains('inline-input'))return;
        if(e.key==='Enter'){e.preventDefault();e.target.blur();}
        if(e.key==='Escape'){if(e.target.dataset.oldValue!=null)e.target.value=e.target.dataset.oldValue;e.target.blur();}
      }

      document.getElementById('filter-form').addEventListener('submit',function(e){e.preventDefault();loadProducts();});
      document.getElementById('products-table').addEventListener('change',onEditCommit);
      document.getElementById('products-table').addEventListener('focusin',onInputFocus);
      document.getElementById('products-table').addEventListener('keydown',onInputKey);

      // تحديد نوع المستودع أولاً ثم تحميل المنتجات
      getWarehouseType();
      loadProducts();
    })();
  </script>
{% endblock %}
