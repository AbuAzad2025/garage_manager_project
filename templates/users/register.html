{% extends 'base.html' %}
{% block title %}إنشاء حساب داخلي{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('users_bp.list_users') }}">المستخدمون</a></li>
<li class="breadcrumb-item active">إنشاء حساب داخلي</li>
{% endblock %}

{% block content %}
<div class="container-fluid" dir="rtl">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-user-plus mr-1"></i> إنشاء حساب مستخدم
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, msg in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ msg }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              </div>
            {% endfor %}
          {% endwith %}

          <form method="post" action="{{ url_for('users_bp.create_user') }}" novalidate>
            {{ form.hidden_tag() }}

            <div class="mb-3 text-right">
              {{ form.username.label(class="form-label") }}
              {{ form.username(class="form-control", placeholder="أدخل اسم المستخدم", autocomplete="username") }}
              {% for err in form.username.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="mb-3 text-right">
              {{ form.email.label(class="form-label") }}
              {{ form.email(class="form-control", placeholder="أدخل البريد الإلكتروني", autocomplete="email", dir="ltr") }}
              {% for err in form.email.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="mb-3 text-right">
              {{ form.password.label(class="form-label") }}
              {{ form.password(class="form-control", placeholder="أدخل كلمة المرور", id="password", autocomplete="new-password") }}
              {% for err in form.password.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            {% if form.confirm is defined %}
            <div class="mb-3 text-right">
              {{ form.confirm.label(class="form-label") }}
              {{ form.confirm(class="form-control", placeholder="أعد إدخال كلمة المرور", autocomplete="new-password") }}
              {% for err in form.confirm.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>
            {% endif %}

            <div class="mb-3 text-right">
              {{ form.role_id.label(class="form-label") }}
              {{ form.role_id(class="custom-select") }}
              {% for err in form.role_id.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="mb-3">
              <div class="form-check">
                {{ form.is_active(class="form-check-input", id="is_active") }}
                <label class="form-check-label" for="is_active">{{ form.is_active.label.text }}</label>
              </div>
            </div>

            {% if all_permissions is defined %}
            <div class="mb-3 text-right">
              <label class="form-label d-block">صلاحيات إضافية</label>
              <div class="d-flex align-items-center mb-2">
                <input type="text" class="form-control form-control-sm" id="perm-filter" placeholder="بحث في الصلاحيات…" style="max-width: 260px;">
                <div class="btn-group btn-group-sm ml-2" role="group">
                  <button type="button" id="perm-select-visible" class="btn btn-outline-primary">تحديد المعروض</button>
                  <button type="button" id="perm-clear-visible" class="btn btn-outline-secondary">إلغاء المعروض</button>
                </div>
              </div>
              <div class="border rounded p-2" style="max-height:260px;overflow:auto" id="perm-list">
                {% for perm in all_permissions %}
                  {% set disp = (perm.display_name if perm.display_name is defined else (perm.name_ar or perm.name)) %}
                  <div class="form-check perm-item" data-name="{{ (disp|string)|lower }} {{ (perm.code or '')|lower }}">
                    <input class="form-check-input" type="checkbox" name="extra_permissions" id="perm-{{ perm.id }}" value="{{ perm.id }}"
                           {% if (selected_perm_ids is defined and perm.id in selected_perm_ids)
                                 or (form.extra_permissions is defined and form.extra_permissions.data and perm.id in form.extra_permissions.data) %}checked{% endif %}>
                    <label class="form-check-label" for="perm-{{ perm.id }}">{{ disp }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <div class="form-group">
              {{ form.submit(class="btn btn-primary btn-block") }}
            </div>
          </form>

          <div class="text-center mt-3">
            <a href="{{ url_for('users_bp.list_users') }}" class="text-decoration-none">
              <i class="fas fa-arrow-left"></i> العودة لقائمة المستخدمين
            </a>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function(){
    var pwd = document.getElementById('password');
    if(!pwd) return;
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm btn-outline-secondary mt-2';
    btn.textContent = 'إظهار/إخفاء';
    pwd.insertAdjacentElement('afterend', btn);
    btn.addEventListener('click', function(){ pwd.type = (pwd.type === 'password') ? 'text' : 'password'; });
  })();

  (function(){
    var input = document.getElementById('perm-filter');
    var container = document.getElementById('perm-list');
    if(!input || !container) return;
    var items = container.querySelectorAll('.perm-item');
    function visibleItems(){ return Array.prototype.filter.call(items, function(it){ return it.style.display !== 'none'; }); }
    input.addEventListener('input', function(){
      var q = (this.value || '').toLowerCase().trim();
      Array.prototype.forEach.call(items, function(it){
        var name = it.getAttribute('data-name') || '';
        it.style.display = (!q || name.indexOf(q) !== -1) ? '' : 'none';
      });
    });
    var btnSel = document.getElementById('perm-select-visible');
    var btnClr = document.getElementById('perm-clear-visible');
    if(btnSel){ btnSel.addEventListener('click', function(){ visibleItems().forEach(function(it){ var cb = it.querySelector('input[type="checkbox"]'); if(cb) cb.checked = true; }); }); }
    if(btnClr){ btnClr.addEventListener('click', function(){ visibleItems().forEach(function(it){ var cb = it.querySelector('input[type="checkbox"]'); if(cb) cb.checked = false; }); }); }
  })();
</script>
{% endblock %}
