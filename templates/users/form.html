{% extends 'base.html' %}

{% block title %}
  {{ 'تعديل مستخدم' if user_id else 'إضافة مستخدم جديد' }}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
  <a href="{{ url_for('main.dashboard') }}">الرئيسية</a>
</li>
<li class="breadcrumb-item">
  <a href="{{ url_for('users_bp.list_users') }}">المستخدمون</a>
</li>
<li class="breadcrumb-item active">
  {{ 'تعديل' if user_id else 'إضافة' }}
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <form
    method="post"
    action="{% if user_id %}
               {{ url_for('users_bp.edit_user', user_id=user_id) }}
             {% else %}
               {{ url_for('users_bp.create_user') }}
             {% endif %}"
  >
    {{ form.hidden_tag() }}

    <div class="form-group mb-3">
      {{ form.username.label(class="form-label") }}
      {{ form.username(class="form-control", placeholder="أدخل اسم المستخدم") }}
      {% for e in form.username.errors %}
        <div class="text-danger">{{ e }}</div>
      {% endfor %}
    </div>

    <div class="form-group mb-3">
      {{ form.email.label(class="form-label") }}
      {{ form.email(class="form-control", placeholder="أدخل البريد الإلكتروني") }}
      {% for e in form.email.errors %}
        <div class="text-danger">{{ e }}</div>
      {% endfor %}
    </div>

    <div class="form-group mb-3">
      {{ form.password.label(class="form-label") }}
      {{ form.password(
          class="form-control",
          placeholder=(user_id
            and 'اتركه فارغاً إن لم ترغب بالتغيير'
            or 'أدخل كلمة المرور')
      ) }}
      {% for e in form.password.errors %}
        <div class="text-danger">{{ e }}</div>
      {% endfor %}
    </div>

    <div class="form-group mb-3">
      {{ form.role_id.label(class="form-label") }}
      {{ form.role_id(class="form-select") }}
      {% for e in form.role_id.errors %}
        <div class="text-danger">{{ e }}</div>
      {% endfor %}
    </div>

    <div class="form-group mb-3">
      <div class="form-check">
        {{ form.is_active(class="form-check-input") }}
        {{ form.is_active.label(class="form-check-label") }}
      </div>
    </div>

    <div class="form-group mb-4">
      <label class="form-label">صلاحيات إضافية</label>
      {% for perm in all_permissions %}
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            name="extra_permissions"
            id="perm-{{ perm.id }}"
            value="{{ perm.id }}"
            {% if perm.id in selected_perm_ids %}checked{% endif %}
          >
          <label class="form-check-label" for="perm-{{ perm.id }}">
            {{ perm.name }}
          </label>
        </div>
      {% endfor %}
    </div>

    <button type="submit" class="btn btn-success">
      {{ 'تحديث' if user_id else 'إنشاء' }}
    </button>
    <a href="{{ url_for('users_bp.list_users') }}" class="btn btn-secondary ms-2">
      إلغاء
    </a>
  </form>
</div>
{% endblock %}
