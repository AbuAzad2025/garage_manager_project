{# templates/users/detail.html #}
{% extends 'base.html' %}

{% block title %}تفاصيل المستخدم - {{ user.username }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('users_bp.list_users') }}">المستخدمون</a></li>
<li class="breadcrumb-item active">تفاصيل {{ user.username }}</li>
{% endblock %}

{% block head_extra %}
  {{ super() }}
  <style>
    .avatar-lg{width:76px;height:76px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;background:#e9ecef;color:#495057}
    .profile-header{background:linear-gradient(135deg,#2c7be5,#00b8d8);color:#fff}
    .badge-perm{background:#e9f5ff;color:#0d6efd;margin:2px;border:1px solid #cfe2ff}
    .stat{border-radius:1rem}
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- الجانب الأيسر: بطاقة البروفايل -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="avatar-lg mx-auto mb-3"><i class="fas fa-user"></i></div>
          <h4 class="mb-1">{{ user.username }}</h4>
          <div class="mb-2">
            {% if user.is_active %}<span class="badge bg-success">نشط</span>{% else %}<span class="badge bg-secondary">موقوف</span>{% endif %}
            <span class="badge bg-dark">{{ user.role.name if user.role else '—' }}</span>
          </div>
          <div class="text-muted mb-3">
            <i class="far fa-envelope me-1"></i>
            <a href="mailto:{{ user.email }}">{{ user.email }}</a>
          </div>
          <div class="d-flex justify-content-center gap-2">
            <a href="{{ url_for('users_bp.edit_user', user_id=user.id) }}" class="btn btn-primary btn-sm"><i class="fas fa-edit"></i> تعديل</a>
            <a href="{{ url_for('users_bp.list_users') }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i> رجوع</a>
          </div>
        </div>

        {% set _last_seen = (user.last_seen if user.last_seen is defined else (user.last_seen_at if user.last_seen_at is defined else None)) %}
        <div class="card-footer bg-white">
          <div class="row text-center">
            <div class="col-6 border-end">
              <div class="small text-muted">آخر ظهور</div>
              <div class="fw-bold">
                {% if _last_seen %}{{ _last_seen.strftime('%Y-%m-%d %H:%M') }}{% else %}—{% endif %}
              </div>
              <div class="small text-muted timeago" data-dt="{{ _last_seen.isoformat() if _last_seen else '' }}"></div>
            </div>
            <div class="col-6">
              <div class="small text-muted">آخر تسجيل دخول</div>
              <div class="fw-bold">
                {% if user.last_login %}{{ user.last_login.strftime('%Y-%m-%d %H:%M') }}{% else %}—{% endif %}
              </div>
              <div class="small text-muted timeago" data-dt="{{ user.last_login.isoformat() if user.last_login else '' }}"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header"><h3 class="card-title mb-0">الصلاحيات الإضافية</h3></div>
        <div class="card-body">
          {% set _q = user.extra_permissions %}
          {% set perms = (_q.all() if _q.__class__.__name__ in ['AppenderQuery','AppenderBaseQuery'] else _q) | list %}
          {% if perms|length %}
            <div class="d-flex flex-wrap">
              {% for p in perms %}<span class="badge badge-perm">{{ p.name }}</span>{% endfor %}
            </div>
          {% else %}
            <span class="text-muted">— لا يوجد —</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- الجانب الأيمن: تبويبات -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header profile-header">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">ملف المستخدم</h3>
            <span class="small">تم الإنشاء: {% if user.created_at %}{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}{% else %}—{% endif %}</span>
          </div>
        </div>
        <div class="card-body">
          <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#tab-overview" role="tab">نظرة عامة</a></li>
            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-perms" role="tab">الأدوار والصلاحيات</a></li>
            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-activity" role="tab">النشاط</a></li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
              <dl class="row mb-0">
                <dt class="col-sm-3">اسم المستخدم</dt><dd class="col-sm-9">{{ user.username }}</dd>
                <dt class="col-sm-3">البريد الإلكتروني</dt><dd class="col-sm-9"><a href="mailto:{{ user.email }}">{{ user.email }}</a></dd>
                <dt class="col-sm-3">الحالة</dt>
                <dd class="col-sm-9">{% if user.is_active %}<span class="badge bg-success">نشط</span>{% else %}<span class="badge bg-secondary">موقوف</span>{% endif %}</dd>
                <dt class="col-sm-3">الدور</dt><dd class="col-sm-9">{{ user.role.name if user.role else '—' }}</dd>
              </dl>
            </div>

            <div class="tab-pane fade" id="tab-perms" role="tabpanel">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-muted">الدور</h6>
                  <p class="mb-2">{{ user.role.name if user.role else '—' }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted">صلاحيات إضافية</h6>
                  {% if perms|length %}
                    <div class="d-flex flex-wrap">
                      {% for p in perms %}<span class="badge badge-perm">{{ p.name }}</span>{% endfor %}
                    </div>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-activity" role="tabpanel">
              <div class="row">
                <div class="col-sm-6 mb-3">
                  <div class="p-3 border rounded stat">
                    <div class="small text-muted">آخر ظهور</div>
                    <div class="fs-5">{% if _last_seen %}<span class="d-block">{{ _last_seen.strftime('%Y-%m-%d %H:%M') }}</span><span class="text-muted small timeago" data-dt="{{ _last_seen.isoformat() }}"></span>{% else %}—{% endif %}</div>
                  </div>
                </div>
                <div class="col-sm-6 mb-3">
                  <div class="p-3 border rounded stat">
                    <div class="small text-muted">آخر تسجيل دخول</div>
                    <div class="fs-5">{% if user.last_login %}<span class="d-block">{{ user.last_login.strftime('%Y-%m-%d %H:%M') }}</span><span class="text-muted small timeago" data-dt="{{ user.last_login.isoformat() }}"></span>{% else %}—{% endif %}</div>
                  </div>
                </div>

                <div class="col-sm-6 mb-3">
                  <div class="p-3 border rounded stat">
                    <div class="small text-muted">عنوان الـ IP</div>
                    <div class="fs-6">{% if user.last_login_ip is defined and user.last_login_ip %}{{ user.last_login_ip }}{% else %}<span class="text-muted">—</span>{% endif %}</div>
                  </div>
                </div>

                <div class="col-sm-6 mb-3">
                  <div class="p-3 border rounded stat">
                    <div class="small text-muted">عدد تسجيلات الدخول</div>
                    <div class="fs-6">{% if user.login_count is defined and user.login_count is not none %}{{ user.login_count }}{% else %}<span class="text-muted">—</span>{% endif %}</div>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function(){
      function fromNowArabic(dateStr){
        if(!dateStr) return '';
        var d=new Date(dateStr); if(isNaN(d)) return '';
        var s=Math.floor((Date.now()-d.getTime())/1000), v=s, u='ثانية';
        if(s>=31536000){v=Math.floor(s/31536000);u='سنة';}
        else if(s>=2592000){v=Math.floor(s/2592000);u='شهر';}
        else if(s>=604800){v=Math.floor(s/604800);u='أسبوع';}
        else if(s>=86400){v=Math.floor(s/86400);u='يوم';}
        else if(s>=3600){v=Math.floor(s/3600);u='ساعة';}
        else if(s>=60){v=Math.floor(s/60);u='دقيقة';}
        return 'منذ ' + v + ' ' + u;
      }
      document.querySelectorAll('.timeago').forEach(function(el){
        var iso=el.getAttribute('data-dt');
        if(!iso) return;
        el.textContent=fromNowArabic(iso);
        try{ el.title=new Date(iso).toLocaleString(); }catch(e){}
      });
    })();
  </script>
{% endblock %}
