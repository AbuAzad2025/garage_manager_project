{% extends 'base.html' %}

{% block title %}إدارة المستخدمين{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
  <a href="{{ url_for('main.dashboard') }}">الرئيسية</a>
</li>
<li class="breadcrumb-item active">المستخدمون</li>
{% endblock %}

{% block content %}
<div class="container-fluid">

  {% if current_user.has_permission('manage_users') %}
    <a href="{{ url_for('users_bp.create_user') }}" class="btn btn-success mb-3">
      <i class="fas fa-user-plus"></i> إضافة مستخدم جديد
    </a>
  {% endif %}

  <table id="users-table" class="table table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr class="text-center">
        <th>اسم المستخدم</th>
        <th>البريد الإلكتروني</th>
        <th>الدور</th>
        <th>الحالة</th>
        <th>آخر ظهور</th>
        <th>آخر دخول</th>
        <th>صلاحيات إضافية</th>
        <th>تاريخ الإنشاء</th>
        {% if current_user.has_permission('manage_users') %}
          <th style="width:160px">إجراءات</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
        {% set _q = user.extra_permissions %}
        {% set perms = (_q.all() if _q.__class__.__name__ in ['AppenderQuery','AppenderBaseQuery'] else _q) | list %}
        {% set perm_names = perms | map(attribute='name') | list %}

        <tr>
          <td class="text-nowrap">{{ user.username }}</td>
          <td class="text-nowrap">
            {% if user.email %}<a href="mailto:{{ user.email }}">{{ user.email }}</a>{% else %}—{% endif %}
          </td>
          <td>{{ user.role.name if user.role else '—' }}</td>
          <td>
            {% if user.is_active %}
              <span class="badge bg-success">نشط</span>
            {% else %}
              <span class="badge bg-secondary">موقوف</span>
            {% endif %}
          </td>

          {# آخر ظهور #}
          <td class="text-center"
              data-order="{{ user.last_seen.isoformat() if user.last_seen else '' }}">
            {% if user.last_seen %}
              <span>{{ user.last_seen.strftime('%Y-%m-%d %H:%M') }}</span>
              <small class="text-muted d-block timeago" data-dt="{{ user.last_seen.isoformat() }}"></small>
            {% else %} — {% endif %}
          </td>

          {# آخر دخول #}
          <td class="text-center"
              data-order="{{ user.last_login.isoformat() if user.last_login else '' }}">
            {% if user.last_login %}
              <span>{{ user.last_login.strftime('%Y-%m-%d %H:%M') }}</span>
              <small class="text-muted d-block timeago" data-dt="{{ user.last_login.isoformat() }}"></small>
            {% else %} — {% endif %}
          </td>

          <td>
            {% if perm_names|length %}
              {% for name in perm_names[:3] %}
                <span class="badge bg-info text-dark me-1 mb-1">{{ name }}</span>
              {% endfor %}
              {% if perm_names|length > 3 %}
                <span class="badge bg-light text-dark border mb-1">+{{ perm_names|length - 3 }}</span>
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>

          <td class="text-center"
              data-order="{{ user.created_at.isoformat() if user.created_at else '' }}">
            {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '—' }}
          </td>

          {% if current_user.has_permission('manage_users') %}
            <td class="text-center text-nowrap">
              <a href="{{ url_for('users_bp.user_detail', user_id=user.id) }}"
                 class="btn btn-sm btn-info" title="تفاصيل">
                <i class="fas fa-eye"></i>
              </a>
              <a href="{{ url_for('users_bp.edit_user', user_id=user.id) }}"
                 class="btn btn-sm btn-primary" title="تعديل">
                <i class="fas fa-edit"></i>
              </a>
              <form action="{{ url_for('users_bp.delete_user', user_id=user.id) }}"
                    method="post" class="d-inline"
                    onsubmit="return confirm('هل أنت متأكد من حذف هذا المستخدم؟');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-danger" title="حذف">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
            </td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(function(){
    function fromNowArabic(iso){
      if(!iso) return '';
      var d=new Date(iso); if(isNaN(d)) return '';
      var s=Math.floor((Date.now()-d.getTime())/1000), v=s, u='ثانية';
      if(s>=31536000){v=Math.floor(s/31536000);u='سنة';}
      else if(s>=2592000){v=Math.floor(s/2592000);u='شهر';}
      else if(s>=604800){v=Math.floor(s/604800);u='أسبوع';}
      else if(s>=86400){v=Math.floor(s/86400);u='يوم';}
      else if(s>=3600){v=Math.floor(s/3600);u='ساعة';}
      else if(s>=60){v=Math.floor(s/60);u='دقيقة';}
      return 'منذ ' + v + ' ' + u;
    }

    document.querySelectorAll('.timeago').forEach(function(el){
      var iso=el.getAttribute('data-dt');
      if(!iso) return;
      el.textContent = fromNowArabic(iso);
      try { el.title = new Date(iso).toLocaleString(); } catch(e){}
    });

    const $tbl = $('#users-table');
    if ($.fn.DataTable && $tbl.length) {
      $tbl.DataTable({
        responsive: true,
        autoWidth: false,
        pageLength: 10,
        order: [[4, 'desc'], [7, 'desc']], // آخر ظهور ثم تاريخ الإنشاء
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf'],
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/Arabic.json"
        },
        columnDefs: [
          { targets: [0,1,2,3,4,5,6,7], className: "text-center align-middle" }
        ]
      });
    }
  });
</script>
{% endblock %}
