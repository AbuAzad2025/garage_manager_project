{% extends 'base.html' %}
{% block title %}العملاء المسجلون (الأونلاين){% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('users_bp.list_users') }}">المستخدمون</a></li>
<li class="breadcrumb-item active">العملاء المسجلون</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">قائمة العملاء المسجلين (is_online = True)</h5>
    <form class="d-flex" method="get" action="{{ url_for('users_bp.registered_customers') }}">
      <input type="text" name="search" class="form-control" value="{{ search or '' }}" placeholder="بحث بالاسم/الهاتف/الإيميل">
      <button class="btn btn-primary ms-2" type="submit"><i class="fas fa-search"></i></button>
    </form>
  </div>

  <table id="registered-customers-table" class="table table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr class="text-center">
        <th>الاسم</th>
        <th>الهاتف</th>
        <th>البريد</th>
        <th>الحالة</th>
        <th>أونلاين</th>
        <th>تاريخ الإنشاء</th>
        <th style="width:160px">إجراءات</th>
      </tr>
    </thead>
    <tbody>
      {% for c in customers %}
      <tr>
        <td class="text-nowrap">{{ c.name }}</td>
        <td class="text-nowrap">{{ c.phone or '—' }}</td>
        <td class="text-nowrap">
          {% if c.email %}
            <a href="mailto:{{ c.email }}" dir="ltr">{{ c.email }}</a>
          {% else %} — {% endif %}
        </td>
        <td>
          {% if c.is_active %}
            <span class="badge bg-success">نشط</span>
          {% else %}
            <span class="badge bg-secondary">موقوف</span>
          {% endif %}
        </td>
        <td>
          {% if c.is_online %}
            <span class="badge bg-primary">أونلاين</span>
          {% else %}
            <span class="badge bg-light text-dark border">غير مُسجل</span>
          {% endif %}
        </td>
        <td class="text-center">{{ c.created_at|format_date if c.created_at else '—' }}</td>
        <td class="text-center text-nowrap">
          <a href="{{ url_for('customers_bp.customer_detail', customer_id=c.id) }}" class="btn btn-sm btn-info" title="تفاصيل"><i class="fas fa-eye"></i></a>
          {% if has_perm('owner_panel') %}
          <a href="{{ url_for('customers_bp.edit_customer', customer_id=c.id) }}" class="btn btn-sm btn-primary" title="تعديل"><i class="fas fa-edit"></i></a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if pagination %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center mb-0">
      {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('users_bp.registered_customers', page=pagination.prev_num, **args) }}">السابق</a>
      </li>
      {% endif %}
      {% for p in pagination.iter_pages() %}
        {% if p %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('users_bp.registered_customers', page=p, **args) }}">{{ p }}</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endfor %}
      {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('users_bp.registered_customers', page=pagination.next_num, **args) }}">التالي</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  $(function(){
    const $tbl = $('#registered-customers-table');
    if ($.fn.DataTable && $tbl.length) {
      const cols = $tbl.find('thead th').length;
      $tbl.DataTable({
        responsive: true,
        autoWidth: false,
        pageLength: 10,
        order: [[0, 'asc']],
        dom: "<'row'<'col-sm-6'B><'col-sm-6'f>>" +
             "<'row'<'col-sm-12'tr>>" +
             "<'row'<'col-sm-5'i><'col-sm-7'p>>",
        buttons: ['excelHtml5', 'pdfHtml5', 'print'],
        language: { url: "{{ url_for('static', filename='datatables/Arabic.json') }}" },
        columnDefs: [{ targets: Array.from({length: cols}, (_, i) => i), className: "text-center align-middle" }]
      });
    }
  });
  </script>
{% endblock %}
