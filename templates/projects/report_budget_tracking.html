{% extends 'base.html' %}
{% block title %}تقرير متابعة الميزانية - المشاريع{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/reporting.css') }}">
{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-tasks text-primary"></i> 
                    تقرير متابعة الميزانية
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-left">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}"><i class="fas fa-home"></i> الرئيسية</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('projects.index') }}">المشاريع</a></li>
                    <li class="breadcrumb-item active">متابعة الميزانية</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
<div class="container-fluid">
  
  <div class="row mb-3 no-print">
    <div class="col-md-8">
      <form method="GET" class="form-inline">
        <div class="form-group mr-2">
          <label>المشروع:</label>
          <select name="project_id" class="form-control mr-2">
            <option value="">جميع المشاريع</option>
            {% for p in all_projects %}
            <option value="{{ p.id }}" {% if p.id == selected_project %}selected{% endif %}>{{ p.code }} - {{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> عرض</button>
      </form>
    </div>
    <div class="col-md-4 text-left">
      <button class="btn btn-secondary" onclick="window.print()">
        <i class="fas fa-print"></i> طباعة
      </button>
    </div>
  </div>

  {% if tracking_data %}
  <div class="row mb-3">
    <div class="col-md-4">
      <div class="info-box bg-info">
        <span class="info-box-icon"><i class="fas fa-calculator"></i></span>
        <div class="info-box-content">
          <span class="info-box-text">الميزانية المقدرة</span>
          <span class="info-box-number">{{ "{:,.2f}".format(totals.estimated) }} ₪</span>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="info-box bg-warning">
        <span class="info-box-icon"><i class="fas fa-money-bill"></i></span>
        <div class="info-box-content">
          <span class="info-box-text">المصروف الفعلي</span>
          <span class="info-box-number">{{ "{:,.2f}".format(totals.actual) }} ₪</span>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="info-box {% if totals.variance >= 0 %}bg-success{% else %}bg-danger{% endif %}">
        <span class="info-box-icon"><i class="fas fa-chart-line"></i></span>
        <div class="info-box-content">
          <span class="info-box-text">الانحراف</span>
          <span class="info-box-number">{{ "{:,.2f}".format(totals.variance) }} ₪</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-gradient-primary">
      <h3 class="card-title">تفاصيل متابعة الميزانية</h3>
    </div>
    <div class="card-body p-0">
      <table class="table table-bordered table-hover">
        <thead>
          <tr class="bg-light">
            <th>المشروع</th>
            <th class="text-center">الميزانية المقدرة</th>
            <th class="text-center">المصروف الفعلي</th>
            <th class="text-center">الانحراف</th>
            <th class="text-center">النسبة %</th>
            <th class="text-center">الحالة</th>
          </tr>
        </thead>
        <tbody>
          {% for item in tracking_data %}
          <tr>
            <td>
              <strong>{{ item.project_code }}</strong> - {{ item.project_name }}
            </td>
            <td class="text-end">{{ "{:,.2f}".format(item.estimated) }} ₪</td>
            <td class="text-end">{{ "{:,.2f}".format(item.actual) }} ₪</td>
            <td class="text-end {% if item.variance >= 0 %}text-success{% else %}text-danger{% endif %}">
              {{ "{:,.2f}".format(item.variance) }} ₪
            </td>
            <td class="text-center">
              <span class="badge {% if item.percentage <= 100 %}bg-success{% elif item.percentage <= 110 %}bg-warning{% else %}bg-danger{% endif %}">
                {{ "{:.1f}".format(item.percentage) }}%
              </span>
            </td>
            <td class="text-center">
              {% if item.percentage <= 100 %}
                <span class="badge bg-success">ضمن الميزانية</span>
              {% elif item.percentage <= 110 %}
                <span class="badge bg-warning">تحذير</span>
              {% else %}
                <span class="badge bg-danger">تجاوز الميزانية</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-dark">
          <tr>
            <th>الإجمالي</th>
            <th class="text-end">{{ "{:,.2f}".format(totals.estimated) }} ₪</th>
            <th class="text-end">{{ "{:,.2f}".format(totals.actual) }} ₪</th>
            <th class="text-end {% if totals.variance >= 0 %}text-success{% else %}text-danger{% endif %}">
              {{ "{:,.2f}".format(totals.variance) }} ₪
            </th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    لا توجد بيانات ميزانية لعرضها.
  </div>
  {% endif %}

</div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/print.js') }}"></script>
{% endblock %}

