{% extends 'base.html' %}

{% block title %}Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ{% endblock %}

{% block head_extra %}
<style>
.chat-container {
    max-width: 900px;
    margin: 0 auto;
}

.chat-box {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    height: 600px;
    display: flex;
    flex-direction: column;
}

.chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 15px 15px 0 0;
    text-align: center;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 15px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    text-align: right;
}

.message.ai {
    text-align: left;
}

.message-content {
    display: inline-block;
    max-width: 70%;
    padding: 15px 20px;
    border-radius: 15px;
    word-wrap: break-word;
}

.message.user .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message.ai .message-content {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
}

.chat-input-area {
    padding: 20px;
    background: white;
    border-radius: 0 0 15px 15px;
    border-top: 1px solid #e0e0e0;
}

.quick-questions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.quick-question-btn {
    background: #f0f0f0;
    border: 1px solid #ddd;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.quick-question-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.typing-indicator {
    padding: 15px;
    text-align: left;
}

.typing-indicator span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #999;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.stats-row {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    flex: 1;
    min-width: 150px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.stat-card .number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.stat-card .label {
    color: #666;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-robot"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li class="breadcrumb-item active">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
            <div class="stats-row" id="quickStats">
                <div class="stat-card">
                    <div class="number" id="stat-customers">-</div>
                    <div class="label">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-services">-</div>
                    <div class="label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-products">-</div>
                    <div class="label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-invoices">-</div>
                    <div class="label">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-warehouses">-</div>
                    <div class="label">Ø§Ù„Ù…Ø®Ø§Ø²Ù†</div>
                </div>
            </div>

            <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
            <div class="chat-container">
                <div class="chat-box">
                    <div class="chat-header">
                        <h3><i class="fas fa-robot"></i> Ù…Ø³Ø§Ø¹Ø¯ Ù†Ø¸Ø§Ù… Ø£Ø²Ø§Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h3>
                        <p class="mb-0">Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù…!</p>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <div class="message-content">
                                <strong>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹!</strong><br>
                                Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ù†Ø¸Ø§Ù… Ø£Ø²Ø§Ø¯ Ø§Ù„Ø°ÙƒÙŠ. ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:
                                <ul class="mb-0 mt-2" style="text-align: right;">
                                    <li>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù† Ø£Ø³Ø¦Ù„ØªÙƒ Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                                    <li>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ù…Ù„Ø§Ø¡ØŒ Ù…Ù†ØªØ¬Ø§ØªØŒ Ø®Ø¯Ù…Ø§Øª)</li>
                                    <li>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</li>
                                    <li>Ø´Ø±Ø­ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <!-- Ø£Ø³Ø¦Ù„Ø© Ø³Ø±ÙŠØ¹Ø© -->
                        <div class="quick-questions">
                            <button class="quick-question-btn" onclick="askQuestion('Ù…Ù† Ø£Ù†ØªØŸ')">
                                Ù…Ù† Ø£Ù†ØªØŸ
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŸ')">
                                ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŸ
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©ØŸ')">
                                Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…')">
                                ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…
                            </button>
                        </div>

                        <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
                        <form id="chatForm">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="messageInput" 
                                       placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."
                                       required>
                                <button class="btn btn-primary btn-lg" type="submit">
                                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
async function loadQuickStats() {
    try {
        const response = await fetch('{{ url_for("ai.quick_stats") }}');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('stat-customers').textContent = data.stats.customers;
            document.getElementById('stat-services').textContent = data.stats.services;
            document.getElementById('stat-products').textContent = data.stats.products;
            document.getElementById('stat-invoices').textContent = data.stats.invoices;
            document.getElementById('stat-warehouses').textContent = data.stats.warehouses;
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
    }
}

// Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹
function askQuestion(question) {
    document.getElementById('messageInput').value = question;
    document.getElementById('chatForm').dispatchEvent(new Event('submit'));
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
function addMessage(text, isUser = false) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = text;
    
    messageDiv.appendChild(contentDiv);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
function showTyping() {
    const messagesDiv = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typing';
    typingDiv.innerHTML = '<span></span><span></span><span></span>';
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
function hideTyping() {
    const typing = document.getElementById('typing');
    if (typing) typing.remove();
}

// Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    addMessage(message, true);
    input.value = '';
    
    // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
    showTyping();
    
    try {
        const response = await fetch('{{ url_for("ai.chat") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ message })
        });
        
        hideTyping();
        
        const data = await response.json();
        
        if (data.success) {
            addMessage(data.response, false);
        } else {
            addMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), false);
        }
    } catch (error) {
        hideTyping();
        addMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ', false);
        console.error('Ø®Ø·Ø£:', error);
    }
});

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    loadQuickStats();
});
</script>
{% endblock %}

