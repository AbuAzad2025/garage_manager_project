{% extends 'base.html' %}

{% block title %}المساعد الذكي{% endblock %}

{% block head_extra %}
<style>
.chat-container {
    max-width: 900px;
    margin: 0 auto;
}

.chat-box {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    height: 600px;
    display: flex;
    flex-direction: column;
}

.chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 15px 15px 0 0;
    text-align: center;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 15px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    text-align: right;
}

.message.ai {
    text-align: left;
}

.message-content {
    display: inline-block;
    max-width: 70%;
    padding: 15px 20px;
    border-radius: 15px;
    word-wrap: break-word;
}

.message.user .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message.ai .message-content {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
}

.chat-input-area {
    padding: 20px;
    background: white;
    border-radius: 0 0 15px 15px;
    border-top: 1px solid #e0e0e0;
}

.quick-questions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.quick-question-btn {
    background: #f0f0f0;
    border: 1px solid #ddd;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.quick-question-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.typing-indicator {
    padding: 15px;
    text-align: left;
}

.typing-indicator span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #999;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.stats-row {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    flex: 1;
    min-width: 150px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.stat-card .number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.stat-card .label {
    color: #666;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-robot"></i> المساعد الذكي
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item active">المساعد الذكي</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <!-- إحصائيات سريعة -->
            <div class="stats-row" id="quickStats">
                <div class="stat-card">
                    <div class="number" id="stat-customers">-</div>
                    <div class="label">العملاء</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-services">-</div>
                    <div class="label">طلبات الصيانة</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-products">-</div>
                    <div class="label">المنتجات</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-invoices">-</div>
                    <div class="label">الفواتير</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="stat-warehouses">-</div>
                    <div class="label">المخازن</div>
                </div>
            </div>

            <!-- صندوق الدردشة -->
            <div class="chat-container">
                <div class="chat-box">
                    <div class="chat-header">
                        <h3><i class="fas fa-robot"></i> مساعد نظام أزاد الذكي</h3>
                        <p class="mb-0">اسألني أي شيء عن النظام!</p>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <div class="message-content">
                                <strong>👋 مرحباً!</strong><br>
                                أنا مساعد نظام أزاد الذكي. يمكنني مساعدتك في:
                                <ul class="mb-0 mt-2" style="text-align: right;">
                                    <li>الإجابة عن أسئلتك حول النظام</li>
                                    <li>البحث عن البيانات (عملاء، منتجات، خدمات)</li>
                                    <li>تحليل الإحصائيات والتقارير</li>
                                    <li>شرح كيفية استخدام الوحدات المختلفة</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <!-- أسئلة سريعة -->
                        <div class="quick-questions">
                            <button class="quick-question-btn" onclick="askQuestion('من أنت؟')">
                                من أنت؟
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('كم عدد العملاء؟')">
                                كم عدد العملاء؟
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('ما هي المنتجات المتوفرة؟')">
                                المنتجات المتوفرة
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion('تقرير اليوم')">
                                تقرير اليوم
                            </button>
                        </div>

                        <!-- حقل الإدخال -->
                        <form id="chatForm">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="messageInput" 
                                       placeholder="اكتب سؤالك هنا..."
                                       required>
                                <button class="btn btn-primary btn-lg" type="submit">
                                    <i class="fas fa-paper-plane"></i> إرسال
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

// تحميل الإحصائيات السريعة
async function loadQuickStats() {
    try {
        const response = await fetch('{{ url_for("ai.quick_stats") }}');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('stat-customers').textContent = data.stats.customers;
            document.getElementById('stat-services').textContent = data.stats.services;
            document.getElementById('stat-products').textContent = data.stats.products;
            document.getElementById('stat-invoices').textContent = data.stats.invoices;
            document.getElementById('stat-warehouses').textContent = data.stats.warehouses;
        }
    } catch (error) {
        console.error('خطأ في تحميل الإحصائيات:', error);
    }
}

// سؤال سريع
function askQuestion(question) {
    document.getElementById('messageInput').value = question;
    document.getElementById('chatForm').dispatchEvent(new Event('submit'));
}

// إضافة رسالة للدردشة
function addMessage(text, isUser = false) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = text;
    
    messageDiv.appendChild(contentDiv);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// إضافة مؤشر الكتابة
function showTyping() {
    const messagesDiv = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typing';
    typingDiv.innerHTML = '<span></span><span></span><span></span>';
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// إزالة مؤشر الكتابة
function hideTyping() {
    const typing = document.getElementById('typing');
    if (typing) typing.remove();
}

// معالج الإرسال
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // عرض رسالة المستخدم
    addMessage(message, true);
    input.value = '';
    
    // عرض مؤشر الكتابة
    showTyping();
    
    try {
        const response = await fetch('{{ url_for("ai.chat") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ message })
        });
        
        hideTyping();
        
        const data = await response.json();
        
        if (data.success) {
            addMessage(data.response, false);
        } else {
            addMessage('❌ حدث خطأ: ' + (data.error || 'خطأ غير معروف'), false);
        }
    } catch (error) {
        hideTyping();
        addMessage('❌ خطأ في الاتصال بالمساعد الذكي', false);
        console.error('خطأ:', error);
    }
});

// تحميل عند بدء الصفحة
document.addEventListener('DOMContentLoaded', function() {
    loadQuickStats();
});
</script>
{% endblock %}

