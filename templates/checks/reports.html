{% extends 'base.html' %}

{% block title %}ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙƒØ§Øª{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ğŸ”¥ Force visible tables - Critical Fix */
.table { 
    display: table !important;
    visibility: visible !important;
}

.table tbody { 
    display: table-row-group !important; 
}

.table tr { 
    display: table-row !important; 
}

.table td, .table th { 
    display: table-cell !important; 
}

.table-responsive {
    display: block !important;
    visibility: visible !important;
}

/* ğŸ”¥ Force visible charts */
.card-body {
    display: block !important;
    visibility: visible !important;
}

canvas {
    display: block !important;
    visibility: visible !important;
    min-height: 250px !important;
}
</style>
{% endblock %}

{% block content %}
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-chart-bar"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙƒØ§Øª</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('checks.index') }}">Ø§Ù„Ø´ÙŠÙƒØ§Øª</a></li>
            <li class="breadcrumb-item active">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
      <div class="row">
        <div class="col-lg-3 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ all_checks|length }}</h3>
              <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙŠÙƒØ§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±)</p>
            </div>
            <div class="icon">
              <i class="fas fa-money-check-alt"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-6">
          <div class="small-box bg-danger">
            <div class="inner">
              <h3>{{ overdue_checks|length }}</h3>
              <p>Ø´ÙŠÙƒØ§Øª Ù…ØªØ£Ø®Ø±Ø©</p>
            </div>
            <div class="icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>{{ due_soon_checks|length }}</h3>
              <p>ØªØ³ØªØ­Ù‚ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…</p>
            </div>
            <div class="icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              {% set cashed_count = all_checks|selectattr('status', 'equalto', 'CASHED')|list|length %}
              <h3>{{ cashed_count }}</h3>
              <p>ØªÙ… ØµØ±ÙÙ‡Ø§ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±)</p>
            </div>
            <div class="icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-pie"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
            </div>
            <div class="card-body">
              <canvas id="statusChart" height="250"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-pie"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡</h3>
            </div>
            <div class="card-body">
              <canvas id="directionChart" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© -->
      {% if overdue_checks %}
      <div class="row">
        <div class="col-12">
          <div class="card card-danger">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</th>
                    <th>Ø§Ù„Ø¨Ù†Ùƒ</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                    <th>Ø§Ù„Ø¬Ù‡Ø©</th>
                    <th>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody>
                  {% for check in overdue_checks %}
                  <tr class="table-danger">
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ check.get('check_number', '-') }}</strong></td>
                    <td>{{ check.get('check_bank', '-') }}</td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(check.get('amount', 0)) }} â‚ª</strong></td>
                    <td>{{ check.get('due_date_formatted', check.get('check_due_date', '-')) }}</td>
                    <td>{{ check.get('entity_name', '-') }}</td>
                    <td class="text-danger"><strong>{{ check.get('days_until_due', 0)|abs }} ÙŠÙˆÙ…</strong></td>
                    <td>
                      <span class="badge badge-secondary">{{ check.get('source', '-') }}</span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹ -->
      {% if due_soon_checks %}
      <div class="row">
        <div class="col-12">
          <div class="card card-warning">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-clock"></i> Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹ (Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…)</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</th>
                    <th>Ø§Ù„Ø¨Ù†Ùƒ</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                    <th>Ø§Ù„Ø¬Ù‡Ø©</th>
                    <th>Ø¨Ø¹Ø¯ (Ø£ÙŠØ§Ù…)</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody>
                  {% for check in due_soon_checks %}
                  <tr class="table-warning">
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ check.get('check_number', '-') }}</strong></td>
                    <td>{{ check.get('check_bank', '-') }}</td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(check.get('amount', 0)) }} â‚ª</strong></td>
                    <td>{{ check.get('due_date_formatted', check.get('check_due_date', '-')) }}</td>
                    <td>{{ check.get('entity_name', '-') }}</td>
                    <td class="text-warning"><strong>{{ check.get('days_until_due', 0) }} ÙŠÙˆÙ…</strong></td>
                    <td>
                      <span class="badge badge-secondary">{{ check.get('source', '-') }}</span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙØµÙ„Ø© -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-table"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  </tr>
                </thead>
                <tbody>
                  {% for stat in stats_by_status %}
                  <tr>
                    <td>
                      <span class="badge badge-{{ CHECK_STATUS.get(stat.status, {}).get('color', 'secondary') if CHECK_STATUS else 'info' }}">
                        {{ stat.status }}
                      </span>
                    </td>
                    <td><strong>{{ stat.count if stat.count is defined else stat.get('count', 0) }}</strong></td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(stat.total_amount if stat.total_amount is defined else stat.get('total_amount', 0)) }} â‚ª</strong></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-table"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th>
                    <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  </tr>
                </thead>
                <tbody>
                  {% for stat in stats_by_direction %}
                  <tr>
                    <td>
                      {% if stat.direction == 'IN' %}
                        <span class="badge badge-success"><i class="fas fa-arrow-down"></i> ÙˆØ§Ø±Ø¯</span>
                      {% else %}
                        <span class="badge badge-danger"><i class="fas fa-arrow-up"></i> ØµØ§Ø¯Ø±</span>
                      {% endif %}
                    </td>
                    <td><strong>{{ stat.count }}</strong></td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(stat.total_amount or 0) }} â‚ª</strong></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
// ğŸ”¥ ÙØ±Ø¶ Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ±Ø³Ù… Ø§Ù„Ù€ Charts
document.addEventListener('DOMContentLoaded', function() {

    // ÙØ±Ø¶ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    document.querySelectorAll('.table-responsive').forEach(function(el) {
        el.style.setProperty('display', 'block', 'important');
        el.style.setProperty('visibility', 'visible', 'important');
    });
    
    document.querySelectorAll('table').forEach(function(el) {
        el.style.setProperty('display', 'table', 'important');
        el.style.setProperty('visibility', 'visible', 'important');
    });
    
    // ÙØ±Ø¶ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ Cards ÙˆØ§Ù„Ù€ Canvas
    document.querySelectorAll('.card-body').forEach(function(el) {
        el.style.setProperty('display', 'block', 'important');
        el.style.setProperty('visibility', 'visible', 'important');
    });
    
    document.querySelectorAll('canvas').forEach(function(el) {
        el.style.setProperty('display', 'block', 'important');
        el.style.setProperty('visibility', 'visible', 'important');
    });

    // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø­Ø§Ù„Ø§Øª
    setTimeout(function() {
        const statusCanvas = document.getElementById('statusChart');
        if (statusCanvas) {

            const statusCtx = statusCanvas.getContext('2d');
            const statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: [{% for stat in stats_by_status %}'{{ stat.status }}'{% if not loop.last %},{% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for stat in stats_by_status %}{{ stat.count if stat.count is defined else stat.get('count', 0) }}{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d', '#e83e8c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {{ all_checks|length }} Ø´ÙŠÙƒ'
                        }
                    }
                }
            });

        } else {

        }
        
        // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø§ØªØ¬Ø§Ù‡
        const directionCanvas = document.getElementById('directionChart');
        if (directionCanvas) {

            const directionCtx = directionCanvas.getContext('2d');
            const directionChart = new Chart(directionCtx, {
                type: 'pie',
                data: {
                    labels: [{% for stat in stats_by_direction %}'{{ "ÙˆØ§Ø±Ø¯" if (stat.direction if stat.direction is defined else stat.get("direction")) == "IN" else "ØµØ§Ø¯Ø±" }}'{% if not loop.last %},{% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for stat in stats_by_direction %}{{ stat.count if stat.count is defined else stat.get('count', 0) }}{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {{ all_checks|length }} Ø´ÙŠÙƒ'
                        }
                    }
                }
            });

        } else {

        }
    }, 500);
});
</script>
{% endblock %}

