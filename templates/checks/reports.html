{% extends 'base.html' %}

{% block title %}تقارير الشيكات{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0"><i class="fas fa-chart-bar"></i> تقارير الشيكات</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('checks.index') }}">الشيكات</a></li>
            <li class="breadcrumb-item active">التقارير</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <!-- الإحصائيات العامة -->
      <div class="row">
        <div class="col-lg-3 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ independent_checks|length }}</h3>
              <p>إجمالي الشيكات اليدوية</p>
            </div>
            <div class="icon">
              <i class="fas fa-money-check-alt"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-6">
          <div class="small-box bg-danger">
            <div class="inner">
              <h3>{{ overdue_checks|length }}</h3>
              <p>شيكات متأخرة</p>
            </div>
            <div class="icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>{{ due_soon_checks|length }}</h3>
              <p>تستحق خلال 7 أيام</p>
            </div>
            <div class="icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              {% set cashed_count = independent_checks|selectattr('status', 'equalto', 'CASHED')|list|length %}
              <h3>{{ cashed_count }}</h3>
              <p>تم صرفها</p>
            </div>
            <div class="icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- الرسوم البيانية -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-pie"></i> توزيع الشيكات حسب الحالة</h3>
            </div>
            <div class="card-body">
              <canvas id="statusChart" height="250"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-pie"></i> توزيع الشيكات حسب الاتجاه</h3>
            </div>
            <div class="card-body">
              <canvas id="directionChart" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- الشيكات المتأخرة -->
      {% if overdue_checks %}
      <div class="row">
        <div class="col-12">
          <div class="card card-danger">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> الشيكات المتأخرة</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>رقم الشيك</th>
                    <th>البنك</th>
                    <th>المبلغ</th>
                    <th>الاستحقاق</th>
                    <th>الجهة</th>
                    <th>الأيام المتأخرة</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  {% for check in overdue_checks %}
                  <tr class="table-danger">
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ check.check_number }}</strong></td>
                    <td>{{ check.check_bank }}</td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(check.amount) }} {{ check.currency }}</strong></td>
                    <td>{{ check.check_due_date.strftime('%d/%m/%Y') }}</td>
                    <td>{{ check.get_entity_name() }}</td>
                    <td class="text-danger"><strong>{{ -check.days_until_due }} يوم</strong></td>
                    <td>
                      <a href="{{ url_for('checks.check_detail', check_id=check.id) }}" class="btn btn-sm btn-info">
                        <i class="fas fa-eye"></i> عرض
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- الشيكات المستحقة قريباً -->
      {% if due_soon_checks %}
      <div class="row">
        <div class="col-12">
          <div class="card card-warning">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-clock"></i> الشيكات المستحقة قريباً (خلال 7 أيام)</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>رقم الشيك</th>
                    <th>البنك</th>
                    <th>المبلغ</th>
                    <th>الاستحقاق</th>
                    <th>الجهة</th>
                    <th>بعد (أيام)</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  {% for check in due_soon_checks %}
                  <tr class="table-warning">
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ check.check_number }}</strong></td>
                    <td>{{ check.check_bank }}</td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(check.amount) }} {{ check.currency }}</strong></td>
                    <td>{{ check.check_due_date.strftime('%d/%m/%Y') }}</td>
                    <td>{{ check.get_entity_name() }}</td>
                    <td class="text-warning"><strong>{{ check.days_until_due }} يوم</strong></td>
                    <td>
                      <a href="{{ url_for('checks.check_detail', check_id=check.id) }}" class="btn btn-sm btn-info">
                        <i class="fas fa-eye"></i> عرض
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- إحصائيات مفصلة -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-table"></i> إحصائيات حسب الحالة</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>الحالة</th>
                    <th>العدد</th>
                    <th>المبلغ الإجمالي</th>
                  </tr>
                </thead>
                <tbody>
                  {% for stat in stats_by_status %}
                  <tr>
                    <td>
                      <span class="badge badge-{{ CHECK_STATUS[stat.status]['color'] if stat.status in CHECK_STATUS else 'secondary' }}">
                        {{ CheckStatus(stat.status).label }}
                      </span>
                    </td>
                    <td><strong>{{ stat.count }}</strong></td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(stat.total_amount or 0) }} ₪</strong></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-table"></i> إحصائيات حسب الاتجاه</h3>
            </div>
            <div class="card-body table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>الاتجاه</th>
                    <th>العدد</th>
                    <th>المبلغ الإجمالي</th>
                  </tr>
                </thead>
                <tbody>
                  {% for stat in stats_by_direction %}
                  <tr>
                    <td>
                      {% if stat.direction == 'IN' %}
                        <span class="badge badge-success"><i class="fas fa-arrow-down"></i> وارد</span>
                      {% else %}
                        <span class="badge badge-danger"><i class="fas fa-arrow-up"></i> صادر</span>
                      {% endif %}
                    </td>
                    <td><strong>{{ stat.count }}</strong></td>
                    <td class="text-success"><strong>{{ "%0.2f"|format(stat.total_amount or 0) }} ₪</strong></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
// رسم بياني للحالات
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for stat in stats_by_status %}'{{ CheckStatus(stat.status).label }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for stat in stats_by_status %}{{ stat.count }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d', '#e83e8c']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// رسم بياني للاتجاه
const directionCtx = document.getElementById('directionChart').getContext('2d');
const directionChart = new Chart(directionCtx, {
    type: 'pie',
    data: {
        labels: [{% for stat in stats_by_direction %}'{{ "وارد" if stat.direction == "IN" else "صادر" }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for stat in stats_by_direction %}{{ stat.count }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: ['#28a745', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}

