{% extends 'base.html' %}
{% block title %}إدارة الأدوار{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>إدارة الأدوار</h2>

  {# زر إضافة دور جديد يظهر فقط لمن يملك صلاحية إدارة الأدوار #}
  {% if current_user.has_permission('manage_roles') %}
    <a href="{{ url_for('roles.create') }}" class="btn btn-primary mb-3">
      إضافة دور جديد
    </a>
  {% endif %}

  <table id="roles-table" class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>اسم الدور</th>
        <th>الوصف</th>
        <th>الصلاحيات</th>
        <th>الإجراءات</th>
      </tr>
    </thead>
    <tbody>
      {% for r in roles %}
      <tr>
        <td>{{ r.name }}</td>
        <td>{{ r.description or '-' }}</td>
        <td>
          {% if r.permissions.count() %}
            {% for p in r.permissions %}
              <span class="badge badge-info">{{ p.name }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted">لا توجد</span>
          {% endif %}
        </td>
        <td>
          {# تحرير الدور #}
          {% if current_user.has_permission('manage_roles') %}
            <a href="{{ url_for('roles.edit', role_id=r.id) }}"
               class="btn btn-sm btn-warning">تعديل</a>
          {% endif %}

          {# حذف الدور – لا يسمح بحذف دور "admin" الافتراضي #}
          {% if current_user.has_permission('manage_roles') and r.name != 'admin' %}
            <form action="{{ url_for('roles.delete', role_id=r.id) }}"
                  method="post" style="display:inline;"
                  onsubmit="return confirm('هل أنت متأكد من حذف هذا الدور؟');">
              {{ csrf_token() }}
              <button class="btn btn-sm btn-danger">حذف</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  $('#roles-table').DataTable({
    dom: 'Bfrtip',
    buttons: ['excel','pdf'],
    language: {
      url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Arabic.json'
    }
  });
});
</script>
{% endblock %}
