{% extends 'base.html' %}

{% block title %}لوحة دفتر الأستاذ{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-gradient-primary text-white">
            <h3 class="mb-0">
                <i class="fas fa-book"></i>
                دفتر الأستاذ العام - General Ledger
            </h3>
        </div>
        
        <div class="card-body p-0">
            <!-- التبويبات -->
            <ul class="nav nav-tabs nav-fill" id="ledgerTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-toggle="tab" data-target="#overview" type="button">
                        <i class="fas fa-tachometer-alt"></i> نظرة عامة
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="entries-tab" data-toggle="tab" data-target="#entries" type="button">
                        <i class="fas fa-list"></i> القيود اليومية
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trial-balance-tab" data-toggle="tab" data-target="#trial-balance" type="button">
                        <i class="fas fa-balance-scale"></i> ميزان المراجعة
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="accounts-tab" data-toggle="tab" data-target="#accounts" type="button">
                        <i class="fas fa-book-open"></i> دليل الحسابات
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-toggle="tab" data-target="#reports" type="button">
                        <i class="fas fa-chart-pie"></i> التقارير المالية
                    </button>
                </li>
            </ul>
            
            <div class="tab-content p-4" id="ledgerTabContent">
                <!-- نظرة عامة -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card bg-success text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-wallet fa-2x mb-2"></i>
                                    <h6>النقدية الحالية</h6>
                                    <h4 id="cash-total">0 ₪</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card bg-primary text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-2x mb-2"></i>
                                    <h6>ذمم العملاء</h6>
                                    <h4 id="ar-total">0 ₪</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card bg-danger text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-truck fa-2x mb-2"></i>
                                    <h6>ذمم الموردين</h6>
                                    <h4 id="ap-total">0 ₪</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card bg-info text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                    <h6>صافي الربح (الشهر)</h6>
                                    <h4 id="profit-total">0 ₪</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">الوصول السريع</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <a href="/reports/financial" class="btn btn-outline-success w-100 btn-lg">
                                                <i class="fas fa-chart-line fa-2x d-block mb-2"></i>
                                                قائمة الدخل
                                            </a>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="/reports/financial" class="btn btn-outline-primary w-100 btn-lg">
                                                <i class="fas fa-balance-scale fa-2x d-block mb-2"></i>
                                                الميزانية العمومية
                                            </a>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="/reports/financial" class="btn btn-outline-info w-100 btn-lg">
                                                <i class="fas fa-money-bill-wave fa-2x d-block mb-2"></i>
                                                التدفقات النقدية
                                            </a>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="/reports/financial" class="btn btn-outline-warning w-100 btn-lg">
                                                <i class="fas fa-clock fa-2x d-block mb-2"></i>
                                                الذمم المعمرة
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- القيود اليومية -->
                <div class="tab-pane fade" id="entries" role="tabpanel">
                    <iframe src="/ledger" style="width:100%; height:800px; border:none;"></iframe>
                </div>
                
                <!-- ميزان المراجعة -->
                <div class="tab-pane fade" id="trial-balance" role="tabpanel">
                    <div id="trial-balance-content">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">جارٍ تحميل ميزان المراجعة...</p>
                        </div>
                    </div>
                </div>
                
                <!-- دليل الحسابات -->
                <div class="tab-pane fade" id="accounts" role="tabpanel">
                    <iframe src="/ledger/chart-of-accounts" style="width:100%; height:800px; border:none;"></iframe>
                </div>
                
                <!-- التقارير المالية -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> قائمة الدخل</h5>
                                </div>
                                <div class="card-body">
                                    <p>تقرير الإيرادات والمصاريف وصافي الربح/الخسارة</p>
                                    <a href="/reports/financial" class="btn btn-success w-100">
                                        عرض التقرير
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-balance-scale"></i> الميزانية العمومية</h5>
                                </div>
                                <div class="card-body">
                                    <p>الأصول = الخصوم + حقوق الملكية</p>
                                    <a href="/reports/financial" class="btn btn-primary w-100">
                                        عرض التقرير
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> التدفقات النقدية</h5>
                                </div>
                                <div class="card-body">
                                    <p>التدفقات التشغيلية والاستثمارية والتمويلية</p>
                                    <a href="/reports/financial" class="btn btn-info w-100">
                                        عرض التقرير
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="fas fa-clock"></i> الذمم المعمرة</h5>
                                </div>
                                <div class="card-body">
                                    <p>تصنيف الذمم حسب العمر (30-60-90 يوم)</p>
                                    <a href="/reports/financial" class="btn btn-warning w-100">
                                        عرض التقرير
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.nav-tabs {
    border-bottom: 2px solid #dee2e6;
}

.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
    padding: 1rem 1.5rem;
}

.nav-tabs .nav-link:hover {
    color: #667eea;
    background: #f8f9fa;
}

.nav-tabs .nav-link.active {
    color: #667eea;
    border-bottom: 3px solid #667eea;
    background: white;
    font-weight: 600;
}
</style>

<script>
// تحميل الإحصائيات
async function loadStats() {
    try {
        const response = await fetch('/ledger/stats');
        const data = await response.json();
        
        document.getElementById('cash-total').textContent = `${data.cash.toLocaleString()} ₪`;
        document.getElementById('ar-total').textContent = `${data.ar.toLocaleString()} ₪`;
        document.getElementById('ap-total').textContent = `${data.ap.toLocaleString()} ₪`;
        document.getElementById('profit-total').textContent = `${data.profit.toLocaleString()} ₪`;
    } catch (error) {
        console.error('خطأ في تحميل الإحصائيات:', error);
    }
}

// تحميل ميزان المراجعة
async function loadTrialBalance() {
    try {
        const response = await fetch('/ledger/trial-balance');
        const data = await response.json();
        
        let html = `
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>الحساب</th>
                        <th class="text-end">المدين</th>
                        <th class="text-end">الدائن</th>
                        <th class="text-end">الرصيد</th>
                        <th>الجانب</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        let totalDebit = 0;
        let totalCredit = 0;
        
        data.rows.forEach(row => {
            totalDebit += row.debit;
            totalCredit += row.credit;
            
            html += `
                <tr>
                    <td>${row.account}</td>
                    <td class="text-end">${row.debit.toLocaleString('en-US', {minimumFractionDigits: 2})} ₪</td>
                    <td class="text-end">${row.credit.toLocaleString('en-US', {minimumFractionDigits: 2})} ₪</td>
                    <td class="text-end fw-bold">${row.net.toLocaleString('en-US', {minimumFractionDigits: 2})} ₪</td>
                    <td class="text-center">
                        <span class="badge bg-${row.side === 'DR' ? 'danger' : 'success'}">${row.side}</span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
                <tfoot class="table-dark fw-bold">
                    <tr>
                        <td>الإجمالي</td>
                        <td class="text-end">${totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2})} ₪</td>
                        <td class="text-end">${totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2})} ₪</td>
                        <td colspan="2" class="text-center">
                            ${Math.abs(totalDebit - totalCredit) < 0.01 ? 
                              '<span class="badge bg-success fs-6">✅ متوازن</span>' : 
                              '<span class="badge bg-danger fs-6">❌ غير متوازن</span>'}
                        </td>
                    </tr>
                </tfoot>
            </table>
        `;
        
        document.getElementById('trial-balance-content').innerHTML = html;
    } catch (error) {
        console.error('خطأ في تحميل ميزان المراجعة:', error);
        document.getElementById('trial-balance-content').innerHTML = `
            <div class="alert alert-danger">
                حدث خطأ في تحميل ميزان المراجعة
            </div>
        `;
    }
}

// عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    
    // تحميل ميزان المراجعة عند النقر على التبويب
    document.getElementById('trial-balance-tab').addEventListener('click', function() {
        if (document.getElementById('trial-balance-content').innerHTML.includes('spinner')) {
            loadTrialBalance();
        }
    });
});
</script>
{% endblock %}

