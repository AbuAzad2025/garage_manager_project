<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>{% block title %}{{ system_settings.system_name or 'شركة ازاد' }} - {{ system_settings.company_name or 'شركة ازاد' }}{% endblock %}</title>
  
  <!-- Mobile Optimization Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="{{ system_settings.system_name or 'شركة ازاد' }}">
  <meta name="format-detection" content="telephone=yes">
  <meta name="theme-color" content="#667eea">
  
  <meta name="description" content="{{ system_settings.system_name or 'نظام إدارة الكراج المتكامل' }} - {{ system_settings.company_name or 'شركة ازاد للأنظمة الذكية' }}">
  <meta name="keywords" content="نظام إدارة الكراج، إدارة المركبات، صيانة السيارات، {{ system_settings.company_name or 'شركة ازاد' }}">
  <meta name="author" content="{{ system_settings.company_name or 'شركة ازاد للأنظمة الذكية' }}">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  
  <!-- Favicon -->
  {% if system_settings.custom_favicon %}
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename=system_settings.custom_favicon.replace('static/', '')) }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename=system_settings.custom_favicon.replace('static/', '')) }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename=system_settings.custom_favicon.replace('static/', '')) }}">
  {% else %}
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/logo.png') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/logo.png') }}">
  {% endif %}
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- CSS Libraries -->
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/fontawesome-free/css/all.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/overlayScrollbars/css/OverlayScrollbars.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/css/adminlte.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/datatables-buttons/css/buttons.bootstrap4.min.css') }}">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  <!-- Mobile Optimizations CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
  
  <!-- Safe Enhancements CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/enhancements.css') }}">
  
  <!-- Performance & Event Utilities (loaded early for all pages) -->
  <script src="{{ url_for('static', filename='js/event-utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/performance-utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/safe-enhancements.js') }}" defer></script>
  
  <!-- Dynamic System Colors from Security Settings -->
  {% if system_settings.primary_color %}
  <style>
    :root {
      --primary-color: {{ system_settings.primary_color }};
    }
    
    /* Apply primary color dynamically */
    .btn-primary, .badge-primary, .bg-primary,
    .alert-primary, .text-primary, .border-primary {
      background-color: {{ system_settings.primary_color }} !important;
      border-color: {{ system_settings.primary_color }} !important;
    }
    
    .btn-primary:hover, .btn-primary:focus {
      background-color: {{ system_settings.primary_color }}dd !important;
      border-color: {{ system_settings.primary_color }}dd !important;
    }
    
    a, .nav-link.active, .sidebar .nav-link.active {
      color: {{ system_settings.primary_color }} !important;
    }
    
    .content-header {
      background: linear-gradient(135deg, {{ system_settings.primary_color }} 0%, {{ system_settings.primary_color }}cc 100%) !important;
    }
    
    .main-sidebar {
      background-color: {{ system_settings.primary_color }}22 !important;
    }
  </style>
  {% endif %}
  
  {% block styles %}{% endblock %}
  {% block head_extra %}{% endblock %}
  
  <!-- Enhanced Styles -->
  <style>
    /* FIX: Dropdown فوق Sidebar */
    .dropdown-menu,
    .navbar .dropdown-menu,
    .main-header .dropdown-menu {
      z-index: 9999 !important;
      position: absolute !important;
    }
    
    /* Sidebar - موقع افتراضي على اليسار لمنع الـ flash */
    .main-sidebar {
      z-index: 1000 !important;
      transition: left 0.3s ease, right 0.3s ease, width 0.3s ease;
      right: auto !important;
      left: 0 !important;
      width: 280px !important;
    }
    
    .content-wrapper,
    .main-footer {
      margin-left: 280px !important;
      margin-right: 0 !important;
      transition: margin-left 0.3s ease, margin-right 0.3s ease;
    }
    
    .main-header.navbar {
      z-index: 1030 !important;
      margin-left: 280px !important;
      margin-right: 0 !important;
      transition: margin-left 0.3s ease, margin-right 0.3s ease;
    }
    
    /* Sidebar على اليسار (افتراضي) */
    body[data-sidebar-position="left"] .main-sidebar {
      right: auto !important;
      left: 0 !important;
    }
    
    body[data-sidebar-position="left"] .content-wrapper,
    body[data-sidebar-position="left"] .main-footer,
    body[data-sidebar-position="left"] .main-header.navbar {
      margin-right: 0 !important;
      margin-left: 280px !important;
    }
    
    /* Sidebar على اليمين */
    body[data-sidebar-position="right"] .main-sidebar {
      left: auto !important;
      right: 0 !important;
    }
    
    body[data-sidebar-position="right"] .content-wrapper,
    body[data-sidebar-position="right"] .main-footer,
    body[data-sidebar-position="right"] .main-header.navbar {
      margin-left: 0 !important;
      margin-right: 280px !important;
    }
    
    /* إصلاح Sidebar في RTL */
    .sidebar {
      direction: rtl;
    }
    
    .nav-sidebar > .nav-item .nav-icon {
      margin-left: 0;
      margin-right: 0.5rem;
    }
    
    /* ==================== RESPONSIVE DESIGN ==================== */
    
    /* Mobile (< 576px) */
    @media (max-width: 575.98px) {
      .main-sidebar {
        width: 100% !important;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      body.sidebar-open .main-sidebar {
        transform: translateX(0);
      }
      
      .content-wrapper,
      .main-footer,
      .main-header.navbar {
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
      
      /* إخفاء بعض العناصر على الموبايل */
      .breadcrumb {
        font-size: 12px;
      }
      
      .card {
        margin-bottom: 15px;
      }
      
    }
    
    /* Tablet (576px - 991px) */
    @media (min-width: 576px) and (max-width: 991.98px) {
      .main-sidebar {
        width: 250px !important;
      }
      
      body[data-sidebar-position="left"] .content-wrapper,
      body[data-sidebar-position="left"] .main-footer,
      body[data-sidebar-position="left"] .main-header.navbar {
        margin-left: 250px !important;
      }
      
      body[data-sidebar-position="right"] .content-wrapper,
      body[data-sidebar-position="right"] .main-footer,
      body[data-sidebar-position="right"] .main-header.navbar {
        margin-right: 250px !important;
      }
      
    }
    
    /* Desktop (992px - 1399px) */
    @media (min-width: 992px) and (max-width: 1399.98px) {
      .main-sidebar {
        width: 280px !important;
      }
      
      body[data-sidebar-position="left"] .content-wrapper,
      body[data-sidebar-position="left"] .main-footer,
      body[data-sidebar-position="left"] .main-header.navbar {
        margin-left: 280px !important;
      }
      
      body[data-sidebar-position="right"] .content-wrapper,
      body[data-sidebar-position="right"] .main-footer,
      body[data-sidebar-position="right"] .main-header.navbar {
        margin-right: 280px !important;
      }
      
    }
    
    /* Large Desktop (1400px - 1919px) */
    @media (min-width: 1400px) and (max-width: 1919.98px) {
      .main-sidebar {
        width: 300px !important;
      }
      
      body[data-sidebar-position="left"] .content-wrapper,
      body[data-sidebar-position="left"] .main-footer,
      body[data-sidebar-position="left"] .main-header.navbar {
        margin-left: 300px !important;
      }
      
      body[data-sidebar-position="right"] .content-wrapper,
      body[data-sidebar-position="right"] .main-footer,
      body[data-sidebar-position="right"] .main-header.navbar {
        margin-right: 300px !important;
      }
      
    }
    
    /* Extra Large (TV/4K - >= 1920px) */
    @media (min-width: 1920px) {
      .main-sidebar {
        width: 320px !important;
      }
      
      body[data-sidebar-position="left"] .content-wrapper,
      body[data-sidebar-position="left"] .main-footer,
      body[data-sidebar-position="left"] .main-header.navbar {
        margin-left: 320px !important;
      }
      
      body[data-sidebar-position="right"] .content-wrapper,
      body[data-sidebar-position="right"] .main-footer,
      body[data-sidebar-position="right"] .main-header.navbar {
        margin-right: 320px !important;
      }
      
      
      .content-wrapper {
        max-width: 1800px;
        margin-left: auto;
        margin-right: auto;
      }
    }
    
    
    
    
    
    
    
    /* Sidebar Collapse على Mobile */
    @media (max-width: 991.98px) {
      body.sidebar-collapse .main-sidebar {
        transform: translateX(-100%);
      }
    }
    
    /* Enhanced Select2 Styling */
    .select2-container .select2-selection--single {
      height: calc(2.25rem + 2px);
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      transition: all 0.15s ease-in-out;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 2.25rem;
      color: #495057;
      font-weight: 500;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 100%;
      top: 0;
    }
    .select2-container--default .select2-selection--single:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* Enhanced DataTables */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      margin: 1rem 0;
    }
    
    /* Enhanced Cards */
    .card {
      border: none;
      border-radius: 0.75rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    /* Enhanced Buttons */
    .btn {
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    
    /* Enhanced Alerts */
    .alert {
      border: none;
      border-radius: 0.75rem;
      font-weight: 500;
    }
    
    /* Enhanced Breadcrumb */
    .breadcrumb {
      background: transparent;
      padding: 0;
      margin: 0;
    }
    .breadcrumb-item + .breadcrumb-item::before {
      content: "›";
      color: #6c757d;
      font-weight: bold;
    }
    
    /* Enhanced Content Header - Harmonized with AdminLTE */
    .content-header {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: #ffffff;
      border-radius: 0 0 0.5rem 0.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .content-header h1 {
      color: #ffffff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      font-weight: 600;
    }
    
    /* Enhanced Breadcrumb - Harmonized with AdminLTE */
    .breadcrumb {
      background: transparent;
      padding: 0;
      margin: 0;
    }
    .breadcrumb-item {
      color: #6c757d;
      font-weight: 400;
    }
    .breadcrumb-item + .breadcrumb-item::before {
      content: "›";
      color: #adb5bd;
      font-weight: normal;
    }
    .breadcrumb-item a {
      color: #007bff;
      text-decoration: none;
      font-weight: 400;
    }
    .breadcrumb-item a:hover {
      color: #0056b3;
      text-decoration: underline;
    }
    
    /* Enhanced Text Contrast - Harmonized with AdminLTE */
    body {
      color: #495057;
      background-color: #f4f6f9;
    }
    
    .text-muted {
      color: #6c757d !important;
    }
    
    .text-dark {
      color: #343a40 !important;
    }
    
    .text-primary {
      color: #007bff !important;
    }
    
    /* Enhanced Card Text - Harmonized with AdminLTE */
    .card {
      background: #ffffff;
      color: #495057;
      border: 1px solid #dee2e6;
    }
    
    .card-header {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: #ffffff;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .card-body {
      color: #495057;
    }
    
    /* Enhanced Table Text - Harmonized with AdminLTE */
    .table {
      color: #495057;
    }
    
    .table th {
      color: #343a40;
      font-weight: 600;
      background-color: #f8f9fa;
    }
    
    .table td {
      color: #495057;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed text-sm layout-navbar-fixed sidebar-collapse-left {% block body_class %}{% endblock %}">
<div class="wrapper">
  {% include 'partials/navbar.html' %}
  {% include 'partials/sidebar.html' %}
  <div class="content-wrapper">
    <div class="content-header border-bottom mb-3 pb-2 bg-light">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <h1 class="m-0 fw-bold text-primary">{% block page_title %}{% endblock %}</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-left small m-0">
              {% block breadcrumb %}{% endblock %}
            </ol>
          </div>
        </div>
      </div>
    </div>
    <section class="content">
      <div class="container-fluid">
        {% with messages = get_unique_flashes(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert" style="position: relative; z-index: 1050;">
                <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'danger' or category == 'error' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>{{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="إغلاق">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
      </div>
    </section>
  </div>
  {% include 'partials/footer.html' %}
</div>

<script src="{{ url_for('static', filename='adminlte/plugins/jquery/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/js/adminlte.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables-buttons/js/dataTables.buttons.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables-buttons/js/buttons.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/jszip/jszip.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables-buttons/js/buttons.html5.min.js') }}"></script>
<script src="{{ url_for('static', filename='adminlte/plugins/datatables-buttons/js/buttons.print.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/datatables-arabic.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="{{ url_for('static', filename='js/archive.js') }}"></script>

<script>
  (function () {
    var token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (token && window.jQuery) {
      $.ajaxSetup({
        beforeSend: function (xhr) {
          xhr.setRequestHeader('X-CSRFToken', token);
          xhr.setRequestHeader('X-CSRF-Token', token);
        }
      });
    }
    if (window.jQuery && $.fn && $.fn.select2) {
      try { $.fn.select2.defaults.set('dir', 'rtl'); } catch (_) {}
    }
    // DataTables Arabic translation now loaded from datatables-arabic.js
  })();
</script>

<!-- Socket.IO for real-time notifications - فقط إذا كان مُفعل -->
{% if config.get('SOCKETIO_ENABLED', False) %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js" integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI" crossorigin="anonymous"></script>
{% endif %}

<script src="{{ url_for('static', filename='js/fx_utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script src="{{ url_for('static', filename='js/ux-enhancements.js') }}"></script>

<script>
// ========== إدارة التنبيهات التلقائية ==========
(function() {
  // إخفاء التنبيهات تلقائياً بعد 10 ثواني فقط لتنبيهات النجاح
  document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.auto-dismiss-alert');
    
    alerts.forEach(function(alert) {
      // فقط تنبيهات النجاح تختفي تلقائياً
      const isSuccess = alert.classList.contains('alert-success');
      
      if (isSuccess) {
        // تأخير 10 ثواني قبل البدء بالإخفاء
        setTimeout(function() {
          // إضافة تأثير fade out
          alert.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          alert.style.opacity = '0';
          alert.style.transform = 'translateY(-20px)';
          
          // إزالة العنصر بعد انتهاء التأثير
          setTimeout(function() {
            alert.remove();
          }, 500);
        }, 10000); // 10 ثواني فقط للنجاح
      }
      // باقي التنبيهات (تحذير/خطأ/معلومات) تبقى حتى يغلقها المستخدم يدوياً
    });
  });
  
  // منع التنبيهات من التأثير على الأداء
  const originalAlert = window.alert;
  window.alert = function(message) {
    console.log('[Alert]', message);
    return originalAlert.call(window, message);
  };
})();

// ========== تبديل موقع Sidebar يمين/يسار ==========
function toggleSidebarPosition() {
  const body = document.body;
  const currentPosition = localStorage.getItem('sidebarPosition') || 'left';
  const newPosition = currentPosition === 'left' ? 'right' : 'left';
  
  console.log('🔄 تبديل Sidebar من', currentPosition, 'إلى', newPosition);
  
  // حفظ الموقع الجديد
  localStorage.setItem('sidebarPosition', newPosition);
  
  // تحديث data attribute
  body.setAttribute('data-sidebar-position', newPosition);
  
  // تطبيق التغيير
  applySidebarPosition(newPosition);
  
  // تحديث النص في الزر
  document.getElementById('sidebar-position-badge').textContent = newPosition === 'left' ? 'يسار' : 'يمين';
}

function applySidebarPosition(position) {
  const body = document.body;
  const sidebar = document.querySelector('.main-sidebar');
  const contentWrapper = document.querySelector('.content-wrapper');
  const navbar = document.querySelector('.main-header.navbar');
  const footer = document.querySelector('.main-footer');
  
  if (!sidebar) {
    console.error('❌ Sidebar not found!');
    return;
  }
  
  // تحديث data attribute على body
  body.setAttribute('data-sidebar-position', position);
  
  // عرض الـ sidebar حسب حجم الشاشة
  const screenWidth = window.innerWidth;
  let sidebarWidth = '280px';
  
  if (screenWidth < 576) {
    sidebarWidth = '0px'; // على الموبايل لا نحتاج margin
  } else if (screenWidth < 992) {
    sidebarWidth = '250px';
  } else if (screenWidth < 1400) {
    sidebarWidth = '280px';
  } else if (screenWidth < 1920) {
    sidebarWidth = '300px';
  } else {
    sidebarWidth = '320px';
  }
  
  // تطبيق التغييرات فوراً على العناصر
  if (screenWidth < 576) {
    // على الموبايل: إزالة كل الـ margins
    if (contentWrapper) {
      contentWrapper.style.setProperty('margin-left', '0', 'important');
      contentWrapper.style.setProperty('margin-right', '0', 'important');
    }
    if (navbar) {
      navbar.style.setProperty('margin-left', '0', 'important');
      navbar.style.setProperty('margin-right', '0', 'important');
    }
    if (footer) {
      footer.style.setProperty('margin-left', '0', 'important');
      footer.style.setProperty('margin-right', '0', 'important');
    }
  } else {
    // على الشاشات الكبيرة: تطبيق الموقع
    if (position === 'left') {
      if (contentWrapper) {
        contentWrapper.style.setProperty('margin-left', sidebarWidth, 'important');
        contentWrapper.style.setProperty('margin-right', '0', 'important');
      }
      if (navbar) {
        navbar.style.setProperty('margin-left', sidebarWidth, 'important');
        navbar.style.setProperty('margin-right', '0', 'important');
      }
      if (footer) {
        footer.style.setProperty('margin-left', sidebarWidth, 'important');
        footer.style.setProperty('margin-right', '0', 'important');
      }
    } else {
      if (contentWrapper) {
        contentWrapper.style.setProperty('margin-right', sidebarWidth, 'important');
        contentWrapper.style.setProperty('margin-left', '0', 'important');
      }
      if (navbar) {
        navbar.style.setProperty('margin-right', sidebarWidth, 'important');
        navbar.style.setProperty('margin-left', '0', 'important');
      }
      if (footer) {
        footer.style.setProperty('margin-right', sidebarWidth, 'important');
        footer.style.setProperty('margin-left', '0', 'important');
      }
    }
  }
  
  console.log('✅ Sidebar على', position === 'left' ? 'اليسار' : 'اليمين', '- العرض:', sidebarWidth);
  
  // لوگ للتأكد
  setTimeout(() => {
    if (contentWrapper) {
      console.log('🔍 التحقق من الموقع:', {
        position: position,
        contentMarginLeft: contentWrapper.style.marginLeft,
        contentMarginRight: contentWrapper.style.marginRight
      });
    }
  }, 100);
}

// تطبيق الموقع المحفوظ قبل تحميل الصفحة لمنع الـ flash
(function() {
  const savedPosition = localStorage.getItem('sidebarPosition') || 'left';
  document.body.setAttribute('data-sidebar-position', savedPosition);
  console.log('⚡ تطبيق سريع للموقع:', savedPosition);
})();

// تطبيق الموقع المحفوظ عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
  const savedPosition = localStorage.getItem('sidebarPosition') || 'left';
  console.log('📍 الموقع المحفوظ:', savedPosition);
  applySidebarPosition(savedPosition);
  
  // تحديث النص في الزر
  const badge = document.getElementById('sidebar-position-badge');
  if (badge) {
    badge.textContent = savedPosition === 'left' ? 'يسار' : 'يمين';
  }
});

// إعادة الحساب عند تغيير حجم الشاشة
window.addEventListener('resize', function() {
  const savedPosition = localStorage.getItem('sidebarPosition') || 'left';
  applySidebarPosition(savedPosition);
});

// ═══════════════════════════════════════════════════════════════════
// 📱 Mobile Enhancements - تحسينات الموبايل
// ═══════════════════════════════════════════════════════════════════

(function() {
  'use strict';
  
  // التحقق من الموبايل
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  // تهيئة للموبايل
  function initMobile() {
    if (!isMobile()) return;
    
    const body = document.body;
    const sidebar = document.querySelector('.main-sidebar');
    const pushmenuBtn = document.querySelector('[data-widget="pushmenu"]');
    
    // إغلاق Sidebar افتراضياً على الموبايل
    if (sidebar && !body.classList.contains('sidebar-open')) {
      sidebar.style.display = 'block';
    }
    
    // التعامل مع فتح/إغلاق Sidebar
    if (pushmenuBtn) {
      pushmenuBtn.addEventListener('click', function(e) {
        e.preventDefault();
        body.classList.toggle('sidebar-open');
      });
    }
    
    // إغلاق Sidebar عند النقر على الـ Overlay
    body.addEventListener('click', function(e) {
      if (body.classList.contains('sidebar-open') && 
          !sidebar.contains(e.target) && 
          !pushmenuBtn.contains(e.target)) {
        body.classList.remove('sidebar-open');
      }
    });
    
    // منع إغلاق Sidebar عند النقر داخله
    if (sidebar) {
      sidebar.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
    
    // إغلاق Sidebar عند اختيار رابط
    const sidebarLinks = document.querySelectorAll('.main-sidebar .nav-link');
    sidebarLinks.forEach(link => {
      link.addEventListener('click', function() {
        if (isMobile()) {
          setTimeout(() => {
            body.classList.remove('sidebar-open');
          }, 300);
        }
      });
    });
    
    console.log('📱 تم تفعيل تحسينات الموبايل');
  }
  
  // تحسينات اللمس
  function enhanceTouchInteractions() {
    // إضافة تأثير ripple للأزرار
    document.querySelectorAll('.btn, .nav-link').forEach(element => {
      element.addEventListener('touchstart', function() {
        this.style.opacity = '0.8';
      });
      
      element.addEventListener('touchend', function() {
        this.style.opacity = '1';
      });
    });
  }
  
  // تحسين الجداول للموبايل
  function enhanceTables() {
    if (!isMobile()) return;
    
    const tables = document.querySelectorAll('.table:not(.no-mobile-cards)');
    tables.forEach(table => {
      // إضافة class للتحويل إلى بطاقات
      table.classList.add('table-mobile-cards');
      
      // إضافة data-label لكل خلية
      const headers = table.querySelectorAll('thead th');
      const rows = table.querySelectorAll('tbody tr');
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
          if (headers[index]) {
            cell.setAttribute('data-label', headers[index].textContent.trim());
          }
        });
      });
    });
  }
  
  // منع Zoom عند double-tap
  function preventDoubleTapZoom() {
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
  }
  
  // تحسين scrolling
  function smoothScroll() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          e.preventDefault();
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  }
  
  // Lazy load images
  function lazyLoadImages() {
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
              observer.unobserve(img);
            }
          }
        });
      });
      
      document.querySelectorAll('img[data-src]').forEach(img => {
        imageObserver.observe(img);
      });
    }
  }
  
  // تشغيل التحسينات
  document.addEventListener('DOMContentLoaded', function() {
    initMobile();
    enhanceTouchInteractions();
    enhanceTables();
    smoothScroll();
    lazyLoadImages();
    
    // إعادة تهيئة عند تغيير حجم الشاشة
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {
        if (isMobile()) {
          initMobile();
          enhanceTables();
        }
      }, 250);
    });
  });
  
  // دعم PWA - إضافة للشاشة الرئيسية
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log('📱 يمكن إضافة التطبيق للشاشة الرئيسية');
    
    // عرض زر تثبيت مخصص (اختياري)
    const installBtn = document.getElementById('install-app-btn');
    if (installBtn) {
      installBtn.style.display = 'block';
      installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`📱 نتيجة التثبيت: ${outcome}`);
          deferredPrompt = null;
          installBtn.style.display = 'none';
        }
      });
    }
  });
  
  // تسجيل Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/static/service-worker.js')
        .then((registration) => {
          console.log('✅ Service Worker registered:', registration.scope);
          
          // التحقق من التحديثات
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('🔄 تحديث جديد متاح');
                // يمكن عرض إشعار للمستخدم
                if (confirm('يتوفر تحديث جديد. هل تريد تحديث الصفحة؟')) {
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                  window.location.reload();
                }
              }
            });
          });
        })
        .catch((error) => {
          console.error('❌ Service Worker registration failed:', error);
        });
    });
    
    // إعادة تحميل الصفحة عند تفعيل SW جديد
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!refreshing) {
        refreshing = true;
        window.location.reload();
      }
    });
  }
  
})();
</script>

{% block scripts %}{% endblock %}
</body>
</html>
