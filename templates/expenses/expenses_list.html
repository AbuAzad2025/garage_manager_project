{% extends 'base.html' %}
{% block title %}Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ{% endblock %}

{% block page_title %}Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
<li class="breadcrumb-item active">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</li>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  /* ÙŠØ¸Ù‡Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø­ØªÙ‰ Ù…Ø¹ ØªØºÙ„ÙŠÙ DataTables */
  .table-responsive{overflow-x:auto}

  /* Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… DataTables Ù…Ø¹ scrollX */
  .dataTables_wrapper .dataTables_scrollBody{
    overflow-x:auto !important;
    overflow-y:hidden;
  }

  /* Ø§Ø¬Ø¹Ù„ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¸Ø§Ù‡Ø±Ù‹Ø§ */
  table.table-sticky th:last-child,
  table.table-sticky td:last-child{
    position:sticky;
    right:0;                 /* Ù„Ø£Ù†Ù†Ø§ RTL */
    background:var(--bs-body-bg, #fff);
    z-index:3;
    box-shadow:-4px 0 6px rgba(0,0,0,.06);
  }

  /* Ù…Ù†Ø¹ Ø³Ø­Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
  table.table-sticky{min-width:1200px}
  
  /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù† */
  .expense-nav {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    direction: rtl;
  }
  
  .expense-nav .nav-link {
    color: white;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.1);
    margin: 0 0.25rem;
    text-align: center;
  }
  
  .expense-nav .nav-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }
  
  .expense-nav .nav-link.active {
    background: white;
    color: #667eea;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* ØªÙƒÙŠÙ‘Ù Ø§Ù„Ù€ tabs Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù€ sidebar */
  body[data-sidebar-position="right"] .expense-nav {
    direction: ltr;
  }
  
  body[data-sidebar-position="left"] .expense-nav {
    direction: rtl;
  }
  
  .summary-cards{display:flex;gap:1.25rem;flex-wrap:wrap;align-items:stretch}
  .summary-card{flex:1 1 240px;border-radius:16px;padding:1.25rem;box-shadow:0 8px 20px rgba(0,0,0,.08);color:#1f2937;position:relative;overflow:hidden;transition:transform .3s ease,box-shadow .3s ease}
  .summary-card:hover{transform:translateY(-4px);box-shadow:0 14px 28px rgba(0,0,0,.12)}
  .summary-card__row{display:flex;justify-content:space-between;align-items:center}
  .summary-card h6{font-size:.85rem;margin:0 0 .35rem;letter-spacing:.5px;text-transform:uppercase;opacity:.8;font-weight:600}
  .summary-card h3{margin:0;font-size:1.9rem;font-weight:700}
  .summary-card small{display:block;margin-top:.35rem;font-size:.85rem;opacity:.75}
  .summary-card__icon{font-size:2.4rem;opacity:.25;transition:transform .3s ease}
  .summary-card:hover .summary-card__icon{transform:scale(1.05)}
  .summary-card--total{background:linear-gradient(135deg,#f5365c 0%,#fb8c00 100%);color:#fff}
  .summary-card--count{background:linear-gradient(135deg,#43a047 0%,#26c6da 100%);color:#fff}
  .summary-card--average{background:linear-gradient(135deg,#3949ab 0%,#5c6bc0 100%);color:#fff}
  .summary-card--latest{background:linear-gradient(135deg,#4a148c 0%,#7b1fa2 100%);color:#fff}
  .summary-card--latest .latest-meta{margin-top:1rem;font-size:.9rem;opacity:.9}
  .summary-card--latest .latest-meta div{margin-bottom:.25rem}
  .summary-card--latest .latest-meta .text-uppercase{opacity:.75;letter-spacing:.6px}
  .payee-chip{display:inline-flex;align-items:center;padding:.25rem .7rem;font-size:.92rem;font-weight:600;border-radius:999px;margin-left:.35rem}
  .payee-chip--employee{background:rgba(13,202,240,.2);color:#04505c;border:1px solid rgba(13,202,240,.45)}
  .payee-chip--utility{background:rgba(111,66,193,.18);color:#301a68;border:1px solid rgba(111,66,193,.35)}
  .payee-chip--other{background:rgba(108,117,125,.18);color:#343a40;border:1px solid rgba(108,117,125,.35)}
.payee-chip--supplier{background:rgba(255,193,7,.2);color:#7a4d00;border:1px solid rgba(255,193,7,.4)}
.payee-chip--partner{background:rgba(23,162,184,.18);color:#0b4b58;border:1px solid rgba(23,162,184,.35)}
.payee-chip--customer{background:rgba(40,167,69,.2);color:#0f5132;border:1px solid rgba(40,167,69,.4)}
  .payee-chip-guess{border-style:dashed;opacity:.85}
.payment-badge{border:1px solid rgba(0,0,0,.12);background:#fff;color:#212529;font-size:.85rem;font-weight:500;padding:.25rem .55rem;border-radius:999px}
.payment-badge .method{color:#495057;margin-left:.35rem}
.payment-badge .amount{font-weight:600;margin-left:.25rem}
.payment-badge .currency{color:#6c757d;font-weight:500;margin-right:.25rem}
  @media print{
    body{background:#fff}
    .card,.card-body{box-shadow:none!important;border:none!important}
    .print-header{display:block!important;margin-bottom:1.5rem}
    table{width:100%!important;border-collapse:collapse!important}
    table thead{display:table-header-group!important}
    table thead th{background:#f4f5f7!important;color:#000!important;border:1px solid #ccc!important;padding:.6rem!important;font-size:1rem!important}
    table tbody td{border:1px solid #ddd!important;padding:.55rem!important;font-size:.95rem!important;color:#000!important}
    .payee-chip{border:1px solid #666!important;color:#000!important;background:#f1f1f1!important}
    .summary-cards,.no-print{display:none!important}
    .table-responsive{overflow:visible!important}
  }
</style>
{% endblock %}

{% macro type_details(expense) %}
{% set code = (expense.type.code if expense.type else '')|upper %}
{% set ns = namespace(items=[]) %}
{% if code == 'RENT' %}
  {% if expense.rent_property_address %}{% set ns.items = ns.items + ['Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.rent_property_address] %}{% endif %}
  {% if expense.rent_property_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.rent_property_notes] %}{% endif %}
{% elif code == 'SOFTWARE' %}
  {% if expense.tech_provider_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø²ÙˆØ¯: ' ~ expense.tech_provider_name] %}{% endif %}
  {% if expense.tech_provider_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.tech_provider_address] %}{% endif %}
  {% if expense.tech_provider_phone %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø§ØªÙ: ' ~ expense.tech_provider_phone] %}{% endif %}
  {% if expense.tech_subscription_id %}{% set ns.items = ns.items + ['Ù…Ø¹Ø±Ù: ' ~ expense.tech_subscription_id] %}{% endif %}
{% elif code == 'SHIP_STORAGE' %}
  {% if expense.storage_property_address %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' ~ expense.storage_property_address] %}{% endif %}
  {% if expense.storage_expected_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.storage_expected_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.storage_start_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ' ~ expense.storage_start_date|format_date] %}{% endif %}
  {% if expense.storage_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.storage_notes] %}{% endif %}
{% elif code in ['SHIP_CLEARANCE','SHIP_CUSTOMS'] %}
  {% if expense.customs_origin %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ù†Ø´Ø£: ' ~ expense.customs_origin] %}{% endif %}
  {% if expense.customs_port_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡: ' ~ expense.customs_port_name] %}{% endif %}
  {% if expense.customs_arrival_date %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØµÙˆÙ„: ' ~ expense.customs_arrival_date|format_date] %}{% endif %}
  {% if expense.customs_departure_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø®Ø±ÙˆØ¬: ' ~ expense.customs_departure_date|format_date] %}{% endif %}
  {% if expense.customs_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.customs_notes] %}{% endif %}
{% elif code == 'TRAINING' %}
  {% if expense.training_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¬Ù‡Ø©: ' ~ expense.training_company_name] %}{% endif %}
  {% if expense.training_location %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙƒØ§Ù†: ' ~ expense.training_location] %}{% endif %}
  {% if expense.training_duration_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.training_duration_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.training_participants_count is not none %}{% set ns.items = ns.items + ['Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯: ' ~ expense.training_participants_count] %}{% endif %}
  {% if expense.training_notes %}{% set ns.items = ns.items + ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ' ~ expense.training_notes] %}{% endif %}
{% elif code == 'ENTERTAINMENT' %}
  {% if expense.entertainment_duration_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.entertainment_duration_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.entertainment_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.entertainment_notes] %}{% endif %}
{% elif code == 'BANK_FEES' %}
  {% if expense.bank_fee_bank_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¨Ù†Ùƒ: ' ~ expense.bank_fee_bank_name] %}{% endif %}
  {% if expense.bank_fee_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.bank_fee_reference] %}{% endif %}
  {% if expense.bank_fee_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.bank_fee_notes] %}{% endif %}
{% elif code == 'GOV_FEES' %}
  {% if expense.gov_fee_entity_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¬Ù‡Ø©: ' ~ expense.gov_fee_entity_name] %}{% endif %}
  {% if expense.gov_fee_entity_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.gov_fee_entity_address] %}{% endif %}
  {% if expense.gov_fee_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.gov_fee_notes] %}{% endif %}
{% elif code == 'SHIP_PORT_FEES' %}
  {% if expense.port_fee_port_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡: ' ~ expense.port_fee_port_name] %}{% endif %}
  {% if expense.port_fee_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.port_fee_reference] %}{% endif %}
  {% if expense.port_fee_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.port_fee_notes] %}{% endif %}
{% elif code == 'SALARY' %}
  {% if expense.period_start and expense.period_end %}{% set ns.items = ns.items + ['Ø§Ù„ÙØªØ±Ø©: ' ~ expense.period_start|format_date ~ ' - ' ~ expense.period_end|format_date] %}{% endif %}
  {% if expense.salary_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.salary_reference] %}{% endif %}
  {% if expense.salary_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.salary_notes] %}{% endif %}
{% elif code == 'TRAVEL' %}
  {% if expense.travel_destination %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØ¬Ù‡Ø©: ' ~ expense.travel_destination] %}{% endif %}
  {% if expense.travel_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø¯Ù: ' ~ expense.travel_reason] %}{% endif %}
  {% if expense.travel_start_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ' ~ expense.travel_start_date|format_date] %}{% endif %}
  {% if expense.travel_duration_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.travel_duration_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.travel_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.travel_notes] %}{% endif %}
{% elif code == 'EMPLOYEE_ADVANCE' %}
  {% if expense.employee_advance_period %}{% set ns.items = ns.items + ['Ø§Ù„ÙØªØ±Ø©: ' ~ expense.employee_advance_period] %}{% endif %}
  {% if expense.employee_advance_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.employee_advance_reason] %}{% endif %}
  {% if expense.employee_advance_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.employee_advance_notes] %}{% endif %}
{% elif code == 'SHIP_FREIGHT' %}
  {% if expense.shipping_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙƒØ©: ' ~ expense.shipping_company_name] %}{% endif %}
  {% if expense.shipping_date %}{% set ns.items = ns.items + ['Ø§Ù„ØªØ§Ø±ÙŠØ®: ' ~ expense.shipping_date|format_date] %}{% endif %}
  {% if expense.shipping_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.shipping_reference] %}{% endif %}
  {% if expense.shipping_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.shipping_notes] %}{% endif %}
  {% if expense.shipping_mode %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØ³ÙŠÙ„Ø©: ' ~ expense.shipping_mode] %}{% endif %}
{% elif code == 'MAINTENANCE' %}
  {% if expense.maintenance_provider_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¬Ù‡Ø©: ' ~ expense.maintenance_provider_name] %}{% endif %}
  {% if expense.maintenance_details %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.maintenance_details] %}{% endif %}
  {% if expense.maintenance_completion_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ' ~ expense.maintenance_completion_date|format_date] %}{% endif %}
{% elif code == 'SHIP_IMPORT_TAX' %}
  {% if expense.import_tax_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.import_tax_reference] %}{% endif %}
  {% if expense.import_tax_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.import_tax_notes] %}{% endif %}
{% elif code == 'HOSPITALITY' %}
  {% if expense.hospitality_type %}{% set ns.items = ns.items + ['Ø§Ù„Ù†ÙˆØ¹: ' ~ expense.hospitality_type] %}{% endif %}
  {% if expense.hospitality_location %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙƒØ§Ù†: ' ~ expense.hospitality_location] %}{% endif %}
  {% if expense.hospitality_attendees %}{% set ns.items = ns.items + ['Ø§Ù„Ø­Ø¶ÙˆØ±: ' ~ expense.hospitality_attendees] %}{% endif %}
  {% if expense.hospitality_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.hospitality_notes] %}{% endif %}
{% elif code == 'TELECOM' or code == '' and expense.telecom_phone_number %}
  {% if expense.telecom_phone_number %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø§ØªÙ: ' ~ expense.telecom_phone_number] %}{% endif %}
  {% if expense.telecom_service_type %}{% set ns.items = ns.items + ['Ø§Ù„Ø®Ø¯Ù…Ø©: ' ~ expense.telecom_service_type] %}{% endif %}
  {% if expense.telecom_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.telecom_notes] %}{% endif %}
{% elif code in ['INSURANCE','INS_OLD','SHIP_INSURANCE'] %}
  {% if expense.insurance_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙƒØ©: ' ~ expense.insurance_company_name] %}{% endif %}
  {% if expense.insurance_company_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.insurance_company_address] %}{% endif %}
  {% if expense.insurance_company_phone %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø§ØªÙ: ' ~ expense.insurance_company_phone] %}{% endif %}
  {% if expense.insurance_policy_number %}{% set ns.items = ns.items + ['ÙˆØ«ÙŠÙ‚Ø©: ' ~ expense.insurance_policy_number] %}{% endif %}
  {% if expense.insurance_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.insurance_notes] %}{% endif %}
{% elif code in ['OFFICE','OFFICE_OLD'] %}
  {% if expense.office_supplier_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙˆØ±Ø¯: ' ~ expense.office_supplier_name] %}{% endif %}
  {% if expense.office_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.office_notes] %}{% endif %}
  {% if expense.office_purchase_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.office_purchase_reference] %}{% endif %}
{% elif code in ['HOME_EXPENSE','HOME_OLD'] %}
  {% if expense.home_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.home_address] %}{% endif %}
  {% if expense.home_owner_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø§Ù„Ùƒ: ' ~ expense.home_owner_name] %}{% endif %}
  {% if expense.home_relation_to_company %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©: ' ~ expense.home_relation_to_company] %}{% endif %}
  {% if expense.home_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.home_notes] %}{% endif %}
{% elif code == 'PARTNER_EXPENSE' %}
  {% if expense.partner and expense.partner.name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙŠÙƒ: ' ~ expense.partner.name] %}{% endif %}
  {% if expense.partner_expense_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.partner_expense_reason] %}{% endif %}
  {% if expense.partner_expense_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.partner_expense_notes] %}{% endif %}
{% elif code == 'SUPPLIER_EXPENSE' %}
  {% if expense.supplier and expense.supplier.name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙˆØ±Ø¯: ' ~ expense.supplier.name] %}{% endif %}
  {% if expense.supplier_expense_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.supplier_expense_reason] %}{% endif %}
  {% if expense.supplier_expense_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.supplier_expense_notes] %}{% endif %}
{% elif code == 'SHIP_HANDLING' %}
  {% if expense.handling_quantity is not none %}{% set ns.items = ns.items + ['Ø§Ù„ÙƒÙ…ÙŠØ©: ' ~ expense.handling_quantity] %}{% endif %}
  {% if expense.handling_unit %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØ­Ø¯Ø©: ' ~ expense.handling_unit] %}{% endif %}
  {% if expense.handling_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.handling_notes] %}{% endif %}
{% elif code == 'FUEL' %}
  {% if expense.fuel_vehicle_number %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ' ~ expense.fuel_vehicle_number] %}{% endif %}
  {% if expense.fuel_driver_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø§Ø¦Ù‚: ' ~ expense.fuel_driver_name] %}{% endif %}
  {% if expense.fuel_usage_type %}{% set ns.items = ns.items + ['Ø§Ù„ØºØ±Ø¶: ' ~ expense.fuel_usage_type] %}{% endif %}
  {% if expense.fuel_volume is not none %}{% set ns.items = ns.items + ['Ø§Ù„ÙƒÙ…ÙŠØ©: ' ~ expense.fuel_volume] %}{% endif %}
  {% if expense.fuel_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.fuel_notes] %}{% endif %}
{% elif code == 'TRANSPORT' %}
  {% if expense.transport_beneficiary_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø³ØªÙÙŠØ¯: ' ~ expense.transport_beneficiary_name] %}{% endif %}
  {% if expense.transport_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.transport_reason] %}{% endif %}
  {% if expense.transport_usage_type %}{% set ns.items = ns.items + ['Ø§Ù„ØªØµÙ†ÙŠÙ: ' ~ expense.transport_usage_type] %}{% endif %}
  {% if expense.transport_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.transport_notes] %}{% endif %}
{% elif code == 'CONSULTING' %}
  {% if expense.legal_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙƒØ©: ' ~ expense.legal_company_name] %}{% endif %}
  {% if expense.legal_company_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.legal_company_address] %}{% endif %}
  {% if expense.legal_case_number %}{% set ns.items = ns.items + ['Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©: ' ~ expense.legal_case_number] %}{% endif %}
  {% if expense.legal_case_type %}{% set ns.items = ns.items + ['Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ©: ' ~ expense.legal_case_type] %}{% endif %}
  {% if expense.legal_case_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.legal_case_notes] %}{% endif %}
{% endif %}
{% if not ns.items %}
  {% if expense.description %}{% set ns.items = ns.items + [expense.description] %}{% endif %}
  {% if expense.notes %}{% set ns.items = ns.items + [expense.notes] %}{% endif %}
{% endif %}
{{ ', '.join(ns.items) if ns.items else 'â€”' }}
{% endmacro %}

{% set payment_method_labels = {
  'cash':'Ù†Ù‚Ø¯Ù‹Ø§',
  'bank':'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
  'cheque':'Ø´ÙŠÙƒ',
  'card':'Ø¨Ø·Ø§Ù‚Ø©',
  'credit_card':'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
  'debit_card':'Ø¨Ø·Ø§Ù‚Ø© Ø®ØµÙ…',
  'online':'Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
  'other':'Ø£Ø®Ø±Ù‰'
} %}

{% macro payment_label(value) -%}
  {% set key = (value or '')|lower %}
  {{ payment_method_labels.get(key, value or 'â€”') }}
{%- endmacro %}

{% macro render_payment_methods(expense) -%}
  {% if expense.payments and expense.payments|length %}
    <div class="d-flex flex-wrap gap-1">
      {% for payment in expense.payments %}
        {% set label = payment_label(payment.method) %}
        <span class="badge payment-badge" title="{{ payment.payment_date|format_date if payment.payment_date }}{% if payment.reference %} â€” {{ payment.reference }}{% endif %}">
          <span class="method">{{ label }}</span>
          <span class="amount">{{ payment.total_amount|number_format(2) }}</span>
          <span class="currency">{{ payment.currency or expense.currency or 'ILS' }}</span>
        </span>
      {% endfor %}
    </div>
    <small class="text-muted d-block mt-1">{{ expense.payments|length }} Ø¯ÙØ¹Ø©{% if expense.payments|length > 1 %} Ø¬Ø²Ø¦ÙŠØ©{% endif %}</small>
  {% else %}
    <span class="text-muted">{{ payment_label(expense.payment_method) }}</span>
  {% endif %}
{%- endmacro %}

{% block content %}
  <!-- Ø±Ø£Ø³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
  <div class="print-header d-none d-print-block">
    <h2>Ù†Ø¸Ø§Ù… Ø£Ø²Ø§Ø¯ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ±Ø§Ø¬</h2>
    <div class="company-info">
      Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {{ "now"|format_datetime("%Y-%m-%d") }}
    </div>
    <h3 class="mt-3">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
  </div>

  <!-- Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  <nav class="expense-nav no-print">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div class="d-flex align-items-center mb-2 mb-md-0">
        <i class="fas fa-money-bill-wave fa-2x text-white ml-3"></i>
        <h4 class="text-white mb-0 fw-bold">ÙˆØ­Ø¯Ø© Ø§Ù„Ù†ÙÙ‚Ø§Øª</h4>
      </div>
      <div class="nav nav-pills" role="tablist">
        <a class="nav-link active" href="{{ url_for('expenses_bp.list_expenses') }}">
          <i class="fas fa-receipt ml-2"></i>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
        </a>
        <a class="nav-link" href="{{ url_for('expenses_bp.employees_list') }}">
          <i class="fas fa-users ml-2"></i>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†
        </a>
        <a class="nav-link" href="{{ url_for('expenses_bp.types_list') }}">
          <i class="fas fa-tags ml-2"></i>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
        </a>
      </div>
    </div>
  </nav>

  <div class="card shadow-sm mb-3">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
      <h2 class="mb-0"><i class="fas fa-receipt ml-2 text-primary"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
      <div class="d-flex gap-2 flex-wrap no-print">
        <button class="btn btn-outline-primary" onclick="window.print()">
          <i class="fas fa-print ml-1"></i>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        </button>
        {% if current_user.has_permission('manage_expenses') %}
        <a href="{{ url_for('expenses_bp.create_expense') }}" class="btn btn-action-add">
          <i class="fas fa-plus ml-1"></i>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
        </a>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <!-- Ø§Ù„Ù…Ù„Ø®ØµØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
      <div id="expenses-summary-wrapper">
      {% if summary %}
        <div class="summary-cards mb-4 no-print">
          <div class="summary-card summary-card--total">
            <div class="summary-card__row">
              <div>
                <h6>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ÙÙ‚Ø§Øª</h6>
                <h3>{{ "{:,.2f}".format(summary.total_expenses) }} â‚ª</h3>
                <small>{{ summary.expenses_count }} Ù…ØµØ±ÙˆÙ</small>
              </div>
              <i class="fas fa-receipt summary-card__icon"></i>
            </div>
          </div>
          <div class="summary-card summary-card--count">
            <div class="summary-card__row">
              <div>
                <h6>ğŸ§¾ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h6>
                <h3>{{ summary.expenses_count }}</h3>
                <small>Ø¶Ù…Ù† Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
              </div>
              <i class="fas fa-list-ol summary-card__icon"></i>
            </div>
          </div>
          <div class="summary-card summary-card--average">
            <div class="summary-card__row">
              <div>
                <h6>ğŸ“Š Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØµØ±ÙˆÙ</h6>
                <h3>{{ "{:,.2f}".format(summary.average_expense) }} â‚ª</h3>
                <small>Ù„ÙƒÙ„ Ù…ØµØ±ÙˆÙ</small>
              </div>
              <i class="fas fa-chart-line summary-card__icon"></i>
            </div>
          </div>
          {% set latest = summary.latest_expense %}
          <div class="summary-card summary-card--latest">
            <div class="summary-card__row">
              <div>
                <h6>ğŸ†• Ø¢Ø®Ø± Ù…ØµØ±ÙˆÙ</h6>
                {% if latest %}
                <h3>{{ latest.amount|number_format(2) }} {{ latest.currency or 'ILS' }}</h3>
                <small>{{ latest.date|format_date }} â€” {{ latest.type.name if latest.type else 'ØºÙŠØ± Ù…ØµÙ†Ù' }}</small>
                {% else %}
                <h3>â€”</h3>
                <small>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</small>
                {% endif %}
              </div>
              <i class="fas fa-clock summary-card__icon"></i>
            </div>
            {% if latest %}
            <div class="latest-meta">
              <div class="fw-semibold">{{ latest.payee_name or latest.paid_to or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
              <div class="text-uppercase">{{ latest.payment_method or 'â€”' }}</div>
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- ØªØµÙ†ÙŠÙ Ø§Ù„Ù†ÙÙ‚Ø§Øª -->
        <div class="row mb-4 no-print">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“Š Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h5>
              </div>
              <div class="card-body">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Ø§Ù„Ù†ÙˆØ¹</th>
                      <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                      <th>Ø§Ù„Ù…Ø¨Ù„Øº (â‚ª)</th>
                      <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for type_name, data in summary.expenses_by_type[:5] %}
                    <tr>
                      <td><strong>{{ type_name }}</strong></td>
                      <td>{{ data.count }}</td>
                      <td>{{ "{:,.2f}".format(data.amount) }}</td>
                      <td>
                        {% set percentage = (data.amount / summary.total_expenses * 100) if summary.total_expenses > 0 else 0 %}
                        <div class="progress" style="height: 20px;">
                          <div class="progress-bar bg-danger" role="progressbar" style="width: {{ percentage }}%">
                            {{ "{:.1f}".format(percentage) }}%
                          </div>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ’± Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø©</h5>
              </div>
              <div class="card-body">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                      <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                      <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ</th>
                      <th>Ø¨Ø§Ù„Ø´ÙŠÙ‚Ù„</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for currency, data in summary.expenses_by_currency.items() %}
                    <tr>
                      <td><strong>{{ currency }}</strong></td>
                      <td>{{ data.count }}</td>
                      <td>{{ "{:,.2f}".format(data.amount) }}</td>
                      <td>{{ "{:,.2f}".format(data.amount_ils) }} â‚ª</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
      </div>
      
      <div class="card border-0 shadow-sm mb-3 no-print">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-lg-6 col-md-7">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input id="expenses-search" type="text" class="form-control" placeholder="Ø¨Ø­Ø« Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ" value="{{ search or '' }}">
              </div>
            </div>
            <div class="col-lg-6 col-md-5 text-md-left text-sm-right mt-3 mt-md-0">
              <div class="d-flex align-items-center justify-content-end gap-2">
                <label class="form-check-label d-flex align-items-center" for="show-archived-expenses">
                  <input type="checkbox" class="form-check-input me-2" id="show-archived-expenses" {% if show_archived %}checked{% endif %} onchange="toggleArchivedExpenses()">
                  <span>Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</span>
                </label>
                <span class="text-muted d-inline-block" id="expenses-search-summary">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {{ pagination.total if pagination else (summary.expenses_count if summary else expenses|length) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {# â€¦ Ù†ÙØ³ ÙÙˆØ±Ù… Ø§Ù„ÙÙ„Ø§ØªØ± ÙƒÙ…Ø§ Ù‡Ùˆ â€¦ #}
      {{ super() }}
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div id="expenses-table-wrapper" class="table-responsive">
      <table id="expenses-table" class="table table-striped table-bordered align-middle table-sticky">
        <thead class="table-primary text-center">
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø¬Ù‡Ø©</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
            <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th style="width:170px" data-sortable="false">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
          <tr {% if e.is_archived %}class="table-warning opacity-75" title="Ù…ØµØ±ÙˆÙ Ù…Ø¤Ø±Ø´Ù{% if e.archive_reason %}: {{ e.archive_reason }}{% endif %}"{% endif %}>
            {% set payee = namespace(label='Ø§Ù„Ø¬Ù‡Ø©', name='', chip='other', guessed=False) %}
            {% set pt = (e.payee_type or '')|upper %}
            {% if e.supplier %}
              {% set payee = namespace(label='Ø§Ù„Ù…ÙˆØ±Ø¯', name=e.supplier.name, chip='supplier', guessed=False) %}
            {% elif e.customer %}
              {% set payee = namespace(label='Ø§Ù„Ø¹Ù…ÙŠÙ„', name=e.customer.name, chip='customer', guessed=False) %}
            {% elif e.partner %}
              {% set payee = namespace(label='Ø§Ù„Ø´Ø±ÙŠÙƒ', name=e.partner.name, chip='partner', guessed=False) %}
            {% elif e.employee %}
              {% set payee = namespace(label='Ø§Ù„Ù…ÙˆØ¸Ù', name=e.employee.name, chip='employee', guessed=False) %}
            {% elif pt == 'CUSTOMER' %}
              {% set payee = namespace(label='Ø§Ù„Ø¹Ù…ÙŠÙ„', name=e.payee_name or ('Ø¹Ù…ÙŠÙ„ #' ~ e.payee_entity_id if e.payee_entity_id else 'â€”'), chip='customer', guessed=False) %}
            {% elif pt == 'SUPPLIER' %}
              {% set payee = namespace(label='Ø§Ù„Ù…ÙˆØ±Ø¯', name=e.payee_name or ('Ù…ÙˆØ±Ø¯ #' ~ e.payee_entity_id if e.payee_entity_id else 'â€”'), chip='supplier', guessed=False) %}
            {% elif pt == 'PARTNER' %}
              {% set payee = namespace(label='Ø§Ù„Ø´Ø±ÙŠÙƒ', name=e.payee_name or ('Ø´Ø±ÙŠÙƒ #' ~ e.payee_entity_id if e.payee_entity_id else 'â€”'), chip='partner', guessed=False) %}
            {% elif pt == 'EMPLOYEE' %}
              {% set payee = namespace(label='Ø§Ù„Ù…ÙˆØ¸Ù', name=e.payee_name or ('Ù…ÙˆØ¸Ù #' ~ e.payee_entity_id if e.payee_entity_id else 'â€”'), chip='employee', guessed=False) %}
            {% elif pt == 'UTILITY' and e.utility_account %}
              {% set payee = namespace(label='Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚', name=e.utility_account.alias or e.utility_account.provider, chip='utility', guessed=False) %}
            {% endif %}
            {% if not payee.name %}
              {% if e.payee_name %}
                {% set payee.name = e.payee_name %}
              {% elif e.beneficiary_name %}
                {% set payee.name = e.beneficiary_name %}
              {% elif e.paid_to %}
                {% set payee.name = e.paid_to %}
              {% elif e.disbursed_by %}
                {% set payee.name = e.disbursed_by %}
              {% elif e.payee_entity_id %}
                {% set payee.name = 'Ø¬Ù‡Ø© #' ~ e.payee_entity_id %}
              {% else %}
                {% set payee.name = 'â€”' %}
              {% endif %}
            {% endif %}
            {% if (payee.chip == 'other' or payee.name == 'â€”') and e.smart_entity_guess %}
              {% set guess = e.smart_entity_guess %}
              {% set payee.label = guess.label %}
              {% set payee.name = guess.name %}
              {% set payee.chip = guess.chip %}
              {% set payee.guessed = True %}
            {% endif %}
            <td class="text-nowrap" data-sort-value="{{ e.date.isoformat() if e.date else '' }}">{{ e.date|format_date if e.date else 'â€”' }}</td>
            <td>
              <div class="fw-semibold">{{ e.type.name if e.type else 'Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
              {% if e.type and not e.type.is_active %}
              <span class="badge bg-warning text-dark small">Ù†ÙˆØ¹ ØºÙŠØ± Ù†Ø´Ø·</span>
              {% endif %}
              {% if e.branch %}
              <div class="text-muted small"><i class="fas fa-building ml-1"></i>{{ e.branch.name or e.branch.code or 'ÙØ±Ø¹ #' ~ e.branch.id }}</div>
              {% elif e.branch_id %}
              <div class="text-muted small text-danger"><i class="fas fa-exclamation-triangle ml-1"></i>Ø§Ù„ÙØ±Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>
              {% endif %}
              {% if e.disbursed_by %}
              <div class="text-muted small"><i class="fas fa-user ml-1"></i>Ø³Ù„Ù… Ø§Ù„Ù…Ø§Ù„: {{ e.disbursed_by }}</div>
              {% endif %}
            </td>
            <td class="text-truncate" style="max-width:220px" data-sort-value="{{ payee.name }}">
              {% if payee.chip != 'other' %}
                <span class="payee-chip payee-chip--{{ payee.chip }}{% if payee.guessed %} payee-chip-guess{% endif %}">{{ payee.label }}{% if payee.guessed %} <small class="text-muted">ØªØ®Ù…ÙŠÙ†</small>{% endif %}</span>
              {% endif %}
              <span class="fw-bold text-dark">{{ payee.name }}</span>
            </td>
            <td class="fw-bold text-end" data-sort-value="{{ e.amount or 0 }}">
              {{ e.amount|number_format(2) }}
            </td>
            <td class="text-center"><span class="badge badge-secondary">{{ e.currency or 'ILS' }}</span></td>
            <td class="text-truncate" style="min-width:180px">
              {{ render_payment_methods(e) }}
            </td>
            <td class="text-end" data-sort-value="{{ e.total_paid or 0 }}">{{ (e.total_paid or 0)|float|round(2)|number_format(2) }}</td>
            <td class="text-center" data-sort-value="{{ 0 if e.is_paid else (e.balance or 0) }}">
              {% if e.is_paid %}
                <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</span>
              {% else %}
                <div class="fw-bold text-danger">{{ (e.balance or 0)|float|round(2)|number_format(2) }}</div>
              {% endif %}
            </td>
            <td class="text-nowrap text-center">
              <div class="btn-group">
                <a href="{{ url_for('expenses_bp.detail', exp_id=e.id) }}" class="btn btn-sm btn-info" title="ØªÙØ§ØµÙŠÙ„"><i class="fas fa-eye"></i></a>
                {% if current_user.has_permission('manage_expenses') %}
                  <a href="{{ url_for('expenses_bp.edit', exp_id=e.id) }}" class="btn btn-sm btn-warning" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></a>
                  {% if e.is_archived %}
                  <button type="button" class="btn btn-action-restore btn-action-sm" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø©" onclick="restoreExpense({{ e.id }})">
                    <i class="fas fa-undo"></i>
                  </button>
                  {% else %}
                  <button type="button" class="btn btn-action-archive btn-action-sm" title="Ø£Ø±Ø´ÙØ©" onclick="archiveExpense({{ e.id }})">
                    <i class="fas fa-archive"></i>
                  </button>
                  {% endif %}
                  <form method="post" action="{{ url_for('expenses_bp.delete', exp_id=e.id) }}" onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ');" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-danger" title="Ø­Ø°Ù Ø¹Ø§Ø¯ÙŠ"><i class="fas fa-trash"></i></button>
                  </form>
                  
                {% endif %}
                {% if current_user.has_permission('manage_payments') and not e.is_paid and e.balance and e.balance > 0 %}
                  <a href="{{ url_for('expenses_bp.pay', exp_id=e.id) }}" class="btn btn-sm btn-outline-success" title="Ø¯ÙØ¹ ({{ '%.2f'|format(e.balance) }} â‚ª)"><i class="fas fa-money-bill-wave"></i></a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          {# â€¦ Ù†ÙØ³ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª â€¦ #}
        </tfoot>
      </table>
      </div>
    </div>
  </div>
  <div id="expenses-pagination" class="mt-3">
    {% if pagination_data and pagination_data.pages > 1 %}
    <nav aria-label="Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† ØµÙØ­Ø§Øª Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ">
      <ul class="pagination justify-content-center flex-wrap mb-0">
        <li class="page-item {% if not pagination_data.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ pagination_data.prev_url or '#' }}" data-expenses-page="true" data-page="{{ pagination_data.prev_page or '' }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
        </li>
        {% if pagination_data.show_first_gap %}
        <li class="page-item">
          <a class="page-link" href="{{ pagination_data.first_url }}" data-expenses-page="true" data-page="1">1</a>
        </li>
        <li class="page-item disabled"><span class="page-link">â€¦</span></li>
        {% endif %}
        {% for item in pagination_data.window %}
        <li class="page-item {% if item.current %}active{% endif %}">
          <a class="page-link" href="{{ item.url }}" data-expenses-page="true" data-page="{{ item.page }}">{{ item.page }}</a>
        </li>
        {% endfor %}
        {% if pagination_data.show_last_gap %}
        <li class="page-item disabled"><span class="page-link">â€¦</span></li>
        <li class="page-item">
          <a class="page-link" href="{{ pagination_data.last_url }}" data-expenses-page="true" data-page="{{ pagination_data.last_page }}">{{ pagination_data.last_page }}</a>
        </li>
        {% endif %}
        <li class="page-item {% if not pagination_data.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ pagination_data.next_url or '#' }}" data-expenses-page="true" data-page="{{ pagination_data.next_page or '' }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
        </li>
      </ul>
    </nav>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/expenses.js') }}"></script>
<script>
  function toggleArchivedExpenses() {
    const checkbox = document.getElementById('show-archived-expenses');
    const url = new URL(window.location.href);
    
    if (checkbox.checked) {
      url.searchParams.set('show_archived', '1');
    } else {
      url.searchParams.delete('show_archived');
    }
    
    window.location.href = url.toString();
  }

</script>
{% endblock %}
