{% extends 'base.html' %}
{% block title %}Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ{% endblock %}

{% block page_title %}Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
<li class="breadcrumb-item active">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</li>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  /* ÙŠØ¸Ù‡Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø­ØªÙ‰ Ù…Ø¹ ØªØºÙ„ÙŠÙ DataTables */
  .table-responsive{overflow-x:auto}

  /* Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… DataTables Ù…Ø¹ scrollX */
  .dataTables_wrapper .dataTables_scrollBody{
    overflow-x:auto !important;
    overflow-y:hidden;
  }

  /* Ø§Ø¬Ø¹Ù„ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¸Ø§Ù‡Ø±Ù‹Ø§ */
  table.table-sticky th:last-child,
  table.table-sticky td:last-child{
    position:sticky;
    right:0;                 /* Ù„Ø£Ù†Ù†Ø§ RTL */
    background:var(--bs-body-bg, #fff);
    z-index:3;
    box-shadow:-4px 0 6px rgba(0,0,0,.06);
  }

  /* Ù…Ù†Ø¹ Ø³Ø­Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
  table.table-sticky{min-width:1200px}
  
  /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù† */
  .expense-nav {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    direction: rtl;
  }
  
  .expense-nav .nav-link {
    color: white;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.1);
    margin: 0 0.25rem;
    text-align: center;
  }
  
  .expense-nav .nav-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }
  
  .expense-nav .nav-link.active {
    background: white;
    color: #667eea;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* ØªÙƒÙŠÙ‘Ù Ø§Ù„Ù€ tabs Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù€ sidebar */
  body[data-sidebar-position="right"] .expense-nav {
    direction: ltr;
  }
  
  body[data-sidebar-position="left"] .expense-nav {
    direction: rtl;
  }
  
  .summary-cards{display:flex;gap:1.25rem;flex-wrap:wrap;align-items:stretch}
  .summary-card{flex:1 1 240px;border-radius:16px;padding:1.25rem;box-shadow:0 8px 20px rgba(0,0,0,.08);color:#1f2937;position:relative;overflow:hidden;transition:transform .3s ease,box-shadow .3s ease}
  .summary-card:hover{transform:translateY(-4px);box-shadow:0 14px 28px rgba(0,0,0,.12)}
  .summary-card__row{display:flex;justify-content:space-between;align-items:center}
  .summary-card h6{font-size:.85rem;margin:0 0 .35rem;letter-spacing:.5px;text-transform:uppercase;opacity:.8;font-weight:600}
  .summary-card h3{margin:0;font-size:1.9rem;font-weight:700}
  .summary-card small{display:block;margin-top:.35rem;font-size:.85rem;opacity:.75}
  .summary-card__icon{font-size:2.4rem;opacity:.25;transition:transform .3s ease}
  .summary-card:hover .summary-card__icon{transform:scale(1.05)}
  .summary-card--total{background:linear-gradient(135deg,#f5365c 0%,#fb8c00 100%);color:#fff}
  .summary-card--count{background:linear-gradient(135deg,#43a047 0%,#26c6da 100%);color:#fff}
  .summary-card--average{background:linear-gradient(135deg,#3949ab 0%,#5c6bc0 100%);color:#fff}
  .summary-card--latest{background:linear-gradient(135deg,#4a148c 0%,#7b1fa2 100%);color:#fff}
  .summary-card--latest .latest-meta{margin-top:1rem;font-size:.9rem;opacity:.9}
  .summary-card--latest .latest-meta div{margin-bottom:.25rem}
  .summary-card--latest .latest-meta .text-uppercase{opacity:.75;letter-spacing:.6px}
  .payee-chip{display:inline-flex;align-items:center;padding:.25rem .7rem;font-size:.92rem;font-weight:600;border-radius:999px;margin-left:.35rem}
  .payee-chip--employee{background:rgba(13,202,240,.2);color:#04505c;border:1px solid rgba(13,202,240,.45)}
  .payee-chip--utility{background:rgba(111,66,193,.18);color:#301a68;border:1px solid rgba(111,66,193,.35)}
  .payee-chip--other{background:rgba(108,117,125,.18);color:#343a40;border:1px solid rgba(108,117,125,.35)}
  @media print{
    body{background:#fff}
    .card,.card-body{box-shadow:none!important;border:none!important}
    .print-header{display:block!important;margin-bottom:1.5rem}
    table{width:100%!important;border-collapse:collapse!important}
    table thead{display:table-header-group!important}
    table thead th{background:#f4f5f7!important;color:#000!important;border:1px solid #ccc!important;padding:.6rem!important;font-size:1rem!important}
    table tbody td{border:1px solid #ddd!important;padding:.55rem!important;font-size:.95rem!important;color:#000!important}
    .payee-chip{border:1px solid #666!important;color:#000!important;background:#f1f1f1!important}
    .summary-cards,.no-print{display:none!important}
    .table-responsive{overflow:visible!important}
  }
</style>
{% endblock %}

{% macro type_details(expense) %}
{% set code = (expense.type.code if expense.type else '')|upper %}
{% set ns = namespace(items=[]) %}
{% if code == 'RENT' %}
  {% if expense.rent_property_address %}{% set ns.items = ns.items + ['Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.rent_property_address] %}{% endif %}
  {% if expense.rent_property_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.rent_property_notes] %}{% endif %}
{% elif code == 'SOFTWARE' %}
  {% if expense.tech_provider_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø²ÙˆØ¯: ' ~ expense.tech_provider_name] %}{% endif %}
  {% if expense.tech_provider_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.tech_provider_address] %}{% endif %}
  {% if expense.tech_provider_phone %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø§ØªÙ: ' ~ expense.tech_provider_phone] %}{% endif %}
  {% if expense.tech_subscription_id %}{% set ns.items = ns.items + ['Ù…Ø¹Ø±Ù: ' ~ expense.tech_subscription_id] %}{% endif %}
{% elif code == 'SHIP_STORAGE' %}
  {% if expense.storage_property_address %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' ~ expense.storage_property_address] %}{% endif %}
  {% if expense.storage_expected_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.storage_expected_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.storage_start_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ' ~ expense.storage_start_date|format_date] %}{% endif %}
  {% if expense.storage_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.storage_notes] %}{% endif %}
{% elif code in ['SHIP_CLEARANCE','SHIP_CUSTOMS'] %}
  {% if expense.customs_origin %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ù†Ø´Ø£: ' ~ expense.customs_origin] %}{% endif %}
  {% if expense.customs_port_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡: ' ~ expense.customs_port_name] %}{% endif %}
  {% if expense.customs_arrival_date %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØµÙˆÙ„: ' ~ expense.customs_arrival_date|format_date] %}{% endif %}
  {% if expense.customs_departure_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø®Ø±ÙˆØ¬: ' ~ expense.customs_departure_date|format_date] %}{% endif %}
  {% if expense.customs_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.customs_notes] %}{% endif %}
{% elif code == 'TRAINING' %}
  {% if expense.training_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¬Ù‡Ø©: ' ~ expense.training_company_name] %}{% endif %}
  {% if expense.training_location %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙƒØ§Ù†: ' ~ expense.training_location] %}{% endif %}
  {% if expense.training_duration_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.training_duration_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.training_participants_count is not none %}{% set ns.items = ns.items + ['Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯: ' ~ expense.training_participants_count] %}{% endif %}
  {% if expense.training_notes %}{% set ns.items = ns.items + ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ' ~ expense.training_notes] %}{% endif %}
{% elif code == 'ENTERTAINMENT' %}
  {% if expense.entertainment_duration_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.entertainment_duration_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.entertainment_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.entertainment_notes] %}{% endif %}
{% elif code == 'BANK_FEES' %}
  {% if expense.bank_fee_bank_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¨Ù†Ùƒ: ' ~ expense.bank_fee_bank_name] %}{% endif %}
  {% if expense.bank_fee_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.bank_fee_reference] %}{% endif %}
  {% if expense.bank_fee_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.bank_fee_notes] %}{% endif %}
{% elif code == 'GOV_FEES' %}
  {% if expense.gov_fee_entity_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¬Ù‡Ø©: ' ~ expense.gov_fee_entity_name] %}{% endif %}
  {% if expense.gov_fee_entity_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.gov_fee_entity_address] %}{% endif %}
  {% if expense.gov_fee_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.gov_fee_notes] %}{% endif %}
{% elif code == 'SHIP_PORT_FEES' %}
  {% if expense.port_fee_port_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡: ' ~ expense.port_fee_port_name] %}{% endif %}
  {% if expense.port_fee_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.port_fee_reference] %}{% endif %}
  {% if expense.port_fee_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.port_fee_notes] %}{% endif %}
{% elif code == 'SALARY' %}
  {% if expense.period_start and expense.period_end %}{% set ns.items = ns.items + ['Ø§Ù„ÙØªØ±Ø©: ' ~ expense.period_start|format_date ~ ' - ' ~ expense.period_end|format_date] %}{% endif %}
  {% if expense.salary_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.salary_reference] %}{% endif %}
  {% if expense.salary_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.salary_notes] %}{% endif %}
{% elif code == 'TRAVEL' %}
  {% if expense.travel_destination %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØ¬Ù‡Ø©: ' ~ expense.travel_destination] %}{% endif %}
  {% if expense.travel_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø¯Ù: ' ~ expense.travel_reason] %}{% endif %}
  {% if expense.travel_start_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ' ~ expense.travel_start_date|format_date] %}{% endif %}
  {% if expense.travel_duration_days is not none %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø¯Ø©: ' ~ expense.travel_duration_days ~ ' ÙŠÙˆÙ…'] %}{% endif %}
  {% if expense.travel_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.travel_notes] %}{% endif %}
{% elif code == 'EMPLOYEE_ADVANCE' %}
  {% if expense.employee_advance_period %}{% set ns.items = ns.items + ['Ø§Ù„ÙØªØ±Ø©: ' ~ expense.employee_advance_period] %}{% endif %}
  {% if expense.employee_advance_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.employee_advance_reason] %}{% endif %}
  {% if expense.employee_advance_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.employee_advance_notes] %}{% endif %}
{% elif code == 'SHIP_FREIGHT' %}
  {% if expense.shipping_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙƒØ©: ' ~ expense.shipping_company_name] %}{% endif %}
  {% if expense.shipping_date %}{% set ns.items = ns.items + ['Ø§Ù„ØªØ§Ø±ÙŠØ®: ' ~ expense.shipping_date|format_date] %}{% endif %}
  {% if expense.shipping_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.shipping_reference] %}{% endif %}
  {% if expense.shipping_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.shipping_notes] %}{% endif %}
  {% if expense.shipping_mode %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØ³ÙŠÙ„Ø©: ' ~ expense.shipping_mode] %}{% endif %}
{% elif code == 'MAINTENANCE' %}
  {% if expense.maintenance_provider_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø¬Ù‡Ø©: ' ~ expense.maintenance_provider_name] %}{% endif %}
  {% if expense.maintenance_details %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.maintenance_details] %}{% endif %}
  {% if expense.maintenance_completion_date %}{% set ns.items = ns.items + ['Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ' ~ expense.maintenance_completion_date|format_date] %}{% endif %}
{% elif code == 'SHIP_IMPORT_TAX' %}
  {% if expense.import_tax_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.import_tax_reference] %}{% endif %}
  {% if expense.import_tax_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.import_tax_notes] %}{% endif %}
{% elif code == 'HOSPITALITY' %}
  {% if expense.hospitality_type %}{% set ns.items = ns.items + ['Ø§Ù„Ù†ÙˆØ¹: ' ~ expense.hospitality_type] %}{% endif %}
  {% if expense.hospitality_location %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙƒØ§Ù†: ' ~ expense.hospitality_location] %}{% endif %}
  {% if expense.hospitality_attendees %}{% set ns.items = ns.items + ['Ø§Ù„Ø­Ø¶ÙˆØ±: ' ~ expense.hospitality_attendees] %}{% endif %}
  {% if expense.hospitality_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.hospitality_notes] %}{% endif %}
{% elif code == 'TELECOM' or code == '' and expense.telecom_phone_number %}
  {% if expense.telecom_phone_number %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø§ØªÙ: ' ~ expense.telecom_phone_number] %}{% endif %}
  {% if expense.telecom_service_type %}{% set ns.items = ns.items + ['Ø§Ù„Ø®Ø¯Ù…Ø©: ' ~ expense.telecom_service_type] %}{% endif %}
  {% if expense.telecom_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.telecom_notes] %}{% endif %}
{% elif code in ['INSURANCE','INS_OLD','SHIP_INSURANCE'] %}
  {% if expense.insurance_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙƒØ©: ' ~ expense.insurance_company_name] %}{% endif %}
  {% if expense.insurance_company_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.insurance_company_address] %}{% endif %}
  {% if expense.insurance_company_phone %}{% set ns.items = ns.items + ['Ø§Ù„Ù‡Ø§ØªÙ: ' ~ expense.insurance_company_phone] %}{% endif %}
  {% if expense.insurance_policy_number %}{% set ns.items = ns.items + ['ÙˆØ«ÙŠÙ‚Ø©: ' ~ expense.insurance_policy_number] %}{% endif %}
  {% if expense.insurance_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.insurance_notes] %}{% endif %}
{% elif code in ['OFFICE','OFFICE_OLD'] %}
  {% if expense.office_supplier_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙˆØ±Ø¯: ' ~ expense.office_supplier_name] %}{% endif %}
  {% if expense.office_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.office_notes] %}{% endif %}
  {% if expense.office_purchase_reference %}{% set ns.items = ns.items + ['Ù…Ø±Ø¬Ø¹: ' ~ expense.office_purchase_reference] %}{% endif %}
{% elif code in ['HOME_EXPENSE','HOME_OLD'] %}
  {% if expense.home_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.home_address] %}{% endif %}
  {% if expense.home_owner_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø§Ù„Ùƒ: ' ~ expense.home_owner_name] %}{% endif %}
  {% if expense.home_relation_to_company %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©: ' ~ expense.home_relation_to_company] %}{% endif %}
  {% if expense.home_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.home_notes] %}{% endif %}
{% elif code == 'PARTNER_EXPENSE' %}
  {% if expense.partner and expense.partner.name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙŠÙƒ: ' ~ expense.partner.name] %}{% endif %}
  {% if expense.partner_expense_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.partner_expense_reason] %}{% endif %}
  {% if expense.partner_expense_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.partner_expense_notes] %}{% endif %}
{% elif code == 'SUPPLIER_EXPENSE' %}
  {% if expense.supplier and expense.supplier.name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…ÙˆØ±Ø¯: ' ~ expense.supplier.name] %}{% endif %}
  {% if expense.supplier_expense_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.supplier_expense_reason] %}{% endif %}
  {% if expense.supplier_expense_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.supplier_expense_notes] %}{% endif %}
{% elif code == 'SHIP_HANDLING' %}
  {% if expense.handling_quantity is not none %}{% set ns.items = ns.items + ['Ø§Ù„ÙƒÙ…ÙŠØ©: ' ~ expense.handling_quantity] %}{% endif %}
  {% if expense.handling_unit %}{% set ns.items = ns.items + ['Ø§Ù„ÙˆØ­Ø¯Ø©: ' ~ expense.handling_unit] %}{% endif %}
  {% if expense.handling_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.handling_notes] %}{% endif %}
{% elif code == 'FUEL' %}
  {% if expense.fuel_vehicle_number %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ' ~ expense.fuel_vehicle_number] %}{% endif %}
  {% if expense.fuel_driver_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø§Ø¦Ù‚: ' ~ expense.fuel_driver_name] %}{% endif %}
  {% if expense.fuel_usage_type %}{% set ns.items = ns.items + ['Ø§Ù„ØºØ±Ø¶: ' ~ expense.fuel_usage_type] %}{% endif %}
  {% if expense.fuel_volume is not none %}{% set ns.items = ns.items + ['Ø§Ù„ÙƒÙ…ÙŠØ©: ' ~ expense.fuel_volume] %}{% endif %}
  {% if expense.fuel_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.fuel_notes] %}{% endif %}
{% elif code == 'TRANSPORT' %}
  {% if expense.transport_beneficiary_name %}{% set ns.items = ns.items + ['Ø§Ù„Ù…Ø³ØªÙÙŠØ¯: ' ~ expense.transport_beneficiary_name] %}{% endif %}
  {% if expense.transport_reason %}{% set ns.items = ns.items + ['Ø§Ù„Ø³Ø¨Ø¨: ' ~ expense.transport_reason] %}{% endif %}
  {% if expense.transport_usage_type %}{% set ns.items = ns.items + ['Ø§Ù„ØªØµÙ†ÙŠÙ: ' ~ expense.transport_usage_type] %}{% endif %}
  {% if expense.transport_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.transport_notes] %}{% endif %}
{% elif code == 'CONSULTING' %}
  {% if expense.legal_company_name %}{% set ns.items = ns.items + ['Ø§Ù„Ø´Ø±ÙƒØ©: ' ~ expense.legal_company_name] %}{% endif %}
  {% if expense.legal_company_address %}{% set ns.items = ns.items + ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' ~ expense.legal_company_address] %}{% endif %}
  {% if expense.legal_case_number %}{% set ns.items = ns.items + ['Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©: ' ~ expense.legal_case_number] %}{% endif %}
  {% if expense.legal_case_type %}{% set ns.items = ns.items + ['Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ©: ' ~ expense.legal_case_type] %}{% endif %}
  {% if expense.legal_case_notes %}{% set ns.items = ns.items + ['ØªÙØ§ØµÙŠÙ„: ' ~ expense.legal_case_notes] %}{% endif %}
{% endif %}
{% if not ns.items %}
  {% if expense.description %}{% set ns.items = ns.items + [expense.description] %}{% endif %}
  {% if expense.notes %}{% set ns.items = ns.items + [expense.notes] %}{% endif %}
{% endif %}
{{ ', '.join(ns.items) if ns.items else 'â€”' }}
{% endmacro %}

{% block content %}
  <!-- Ø±Ø£Ø³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
  <div class="print-header d-none d-print-block">
    <h2>Ù†Ø¸Ø§Ù… Ø£Ø²Ø§Ø¯ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ±Ø§Ø¬</h2>
    <div class="company-info">
      Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {{ "now"|format_datetime("%Y-%m-%d") }}
    </div>
    <h3 class="mt-3">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
  </div>

  <!-- Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  <nav class="expense-nav no-print">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div class="d-flex align-items-center mb-2 mb-md-0">
        <i class="fas fa-money-bill-wave fa-2x text-white ml-3"></i>
        <h4 class="text-white mb-0 fw-bold">ÙˆØ­Ø¯Ø© Ø§Ù„Ù†ÙÙ‚Ø§Øª</h4>
      </div>
      <div class="nav nav-pills" role="tablist">
        <a class="nav-link active" href="{{ url_for('expenses_bp.list_expenses') }}">
          <i class="fas fa-receipt ml-2"></i>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
        </a>
        <a class="nav-link" href="{{ url_for('expenses_bp.employees_list') }}">
          <i class="fas fa-users ml-2"></i>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†
        </a>
        <a class="nav-link" href="{{ url_for('expenses_bp.types_list') }}">
          <i class="fas fa-tags ml-2"></i>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
        </a>
      </div>
    </div>
  </nav>

  <div class="card shadow-sm mb-3">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
      <h2 class="mb-0"><i class="fas fa-receipt ml-2 text-primary"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
      <div class="d-flex gap-2 flex-wrap no-print">
        <button class="btn btn-outline-primary" onclick="window.print()">
          <i class="fas fa-print ml-1"></i>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        </button>
        {% if current_user.has_permission('manage_expenses') %}
        <a href="{{ url_for('expenses_bp.create_expense') }}" class="btn btn-action-add">
          <i class="fas fa-plus ml-1"></i>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
        </a>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <!-- Ø§Ù„Ù…Ù„Ø®ØµØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
      {% if summary %}
      <div class="summary-cards mb-4 no-print">
        <div class="summary-card summary-card--total">
          <div class="summary-card__row">
            <div>
              <h6>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ÙÙ‚Ø§Øª</h6>
              <h3>{{ "{:,.2f}".format(summary.total_expenses) }} â‚ª</h3>
              <small>{{ summary.expenses_count }} Ù…ØµØ±ÙˆÙ</small>
            </div>
            <i class="fas fa-receipt summary-card__icon"></i>
          </div>
        </div>
        <div class="summary-card summary-card--count">
          <div class="summary-card__row">
            <div>
              <h6>ğŸ§¾ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h6>
              <h3>{{ summary.expenses_count }}</h3>
              <small>Ø¶Ù…Ù† Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
            </div>
            <i class="fas fa-list-ol summary-card__icon"></i>
          </div>
        </div>
        <div class="summary-card summary-card--average">
          <div class="summary-card__row">
            <div>
              <h6>ğŸ“Š Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØµØ±ÙˆÙ</h6>
              <h3>{{ "{:,.2f}".format(summary.average_expense) }} â‚ª</h3>
              <small>Ù„ÙƒÙ„ Ù…ØµØ±ÙˆÙ</small>
            </div>
            <i class="fas fa-chart-line summary-card__icon"></i>
          </div>
        </div>
        {% set latest = summary.latest_expense %}
        <div class="summary-card summary-card--latest">
          <div class="summary-card__row">
            <div>
              <h6>ğŸ†• Ø¢Ø®Ø± Ù…ØµØ±ÙˆÙ</h6>
              {% if latest %}
              <h3>{{ latest.amount|number_format(2) }} {{ latest.currency or 'ILS' }}</h3>
              <small>{{ latest.date|format_date }} â€” {{ latest.type.name if latest.type else 'ØºÙŠØ± Ù…ØµÙ†Ù' }}</small>
              {% else %}
              <h3>â€”</h3>
              <small>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</small>
              {% endif %}
            </div>
            <i class="fas fa-clock summary-card__icon"></i>
          </div>
          {% if latest %}
          <div class="latest-meta">
            <div class="fw-semibold">{{ latest.payee_name or latest.paid_to or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
            <div class="text-uppercase">{{ latest.payment_method or 'â€”' }}</div>
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- ØªØµÙ†ÙŠÙ Ø§Ù„Ù†ÙÙ‚Ø§Øª -->
      <div class="row mb-4 no-print">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">ğŸ“Š Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h5>
            </div>
            <div class="card-body">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº (â‚ª)</th>
                    <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                  </tr>
                </thead>
                <tbody>
                  {% for type_name, data in summary.expenses_by_type[:5] %}
                  <tr>
                    <td><strong>{{ type_name }}</strong></td>
                    <td>{{ data.count }}</td>
                    <td>{{ "{:,.2f}".format(data.amount) }}</td>
                    <td>
                      {% set percentage = (data.amount / summary.total_expenses * 100) if summary.total_expenses > 0 else 0 %}
                      <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ percentage }}%">
                          {{ "{:.1f}".format(percentage) }}%
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">ğŸ’± Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø©</h5>
            </div>
            <div class="card-body">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                    <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ</th>
                    <th>Ø¨Ø§Ù„Ø´ÙŠÙ‚Ù„</th>
                  </tr>
                </thead>
                <tbody>
                  {% for currency, data in summary.expenses_by_currency.items() %}
                  <tr>
                    <td><strong>{{ currency }}</strong></td>
                    <td>{{ data.count }}</td>
                    <td>{{ "{:,.2f}".format(data.amount) }}</td>
                    <td>{{ "{:,.2f}".format(data.amount_ils) }} â‚ª</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
      {# â€¦ Ù†ÙØ³ ÙÙˆØ±Ù… Ø§Ù„ÙÙ„Ø§ØªØ± ÙƒÙ…Ø§ Ù‡Ùˆ â€¦ #}
      {{ super() }}
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body table-responsive">
      <table id="expenses-table" class="table table-striped table-bordered align-middle table-sticky">
        <thead class="table-primary text-center">
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø¬Ù‡Ø©</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
            <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th style="width:170px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
          {% set pt = e.payee_type or '' %}
          <tr>
            <td class="text-nowrap">{{ e.date|format_date }}</td>
            <td>{{ e.type.name if e.type else 'â€”' }}</td>
            <td class="text-truncate" style="max-width:260px">{{ type_details(e) }}</td>
            <td class="text-truncate" style="max-width:200px">
              {% if pt == 'EMPLOYEE' %}<span class="payee-chip payee-chip--employee">Ù…ÙˆØ¸Ù‘Ù</span>
              {% elif pt == 'UTILITY' %}<span class="payee-chip payee-chip--utility">Ù…Ø±ÙÙ‚</span>
              {% elif pt %}<span class="payee-chip payee-chip--other">Ø£Ø®Ø±Ù‰</span>{% endif %}
              <span class="fw-bold text-dark">{{ e.payee_name or e.paid_to or (e.employee.name if e.employee else 'â€”') }}</span>
            </td>
            <td class="fw-bold text-end">
              {{ e.amount|number_format(2) }}
            </td>
            <td class="text-center"><span class="badge badge-secondary">{{ e.currency or 'ILS' }}</span></td>
            <td class="text-nowrap">{{ e.payment_method or 'â€”' }}</td>
            <td class="text-end">{{ (e.total_paid or 0)|float|round(2)|number_format(2) }}</td>
            <td class="text-center">
              {% if e.is_paid %}
                <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</span>
              {% else %}
                <div class="fw-bold text-danger">{{ (e.balance or 0)|float|round(2)|number_format(2) }}</div>
              {% endif %}
            </td>
            <td class="text-nowrap text-center">
              <div class="btn-group">
                <a href="{{ url_for('expenses_bp.detail', exp_id=e.id) }}" class="btn btn-sm btn-info" title="ØªÙØ§ØµÙŠÙ„"><i class="fas fa-eye"></i></a>
                {% if current_user.has_permission('manage_expenses') %}
                  <a href="{{ url_for('expenses_bp.edit', exp_id=e.id) }}" class="btn btn-sm btn-warning" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></a>
                  {% if e.is_archived %}
                  <button type="button" class="btn btn-action-restore btn-action-sm" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø©" onclick="restoreExpense({{ e.id }})">
                    <i class="fas fa-undo"></i>
                  </button>
                  {% else %}
                  <button type="button" class="btn btn-action-archive btn-action-sm" title="Ø£Ø±Ø´ÙØ©" onclick="archiveExpense({{ e.id }})">
                    <i class="fas fa-archive"></i>
                  </button>
                  {% endif %}
                  <form method="post" action="{{ url_for('expenses_bp.delete', exp_id=e.id) }}" onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ');" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-danger" title="Ø­Ø°Ù Ø¹Ø§Ø¯ÙŠ"><i class="fas fa-trash"></i></button>
                  </form>
                  <a href="{{ url_for('hard_delete_bp.delete_expense', expense_id=e.id) }}"
                     class="btn btn-sm btn-outline-danger" title="Ø­Ø°Ù Ù‚ÙˆÙŠ"
                     onclick="return confirm('Ø­Ø°Ù Ù‚ÙˆÙŠ - Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©!')">
                    <i class="fas fa-bomb"></i>
                  </a>
                {% endif %}
                {% if current_user.has_permission('manage_payments') and not e.is_paid and e.balance and e.balance > 0 %}
                  <a href="{{ url_for('expenses_bp.pay', exp_id=e.id) }}" class="btn btn-sm btn-outline-success" title="Ø¯ÙØ¹ ({{ '%.2f'|format(e.balance) }} â‚ª)"><i class="fas fa-money-bill-wave"></i></a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          {# â€¦ Ù†ÙØ³ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª â€¦ #}
        </tfoot>
      </table>
    </div>
  </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/expenses.js') }}"></script>
<script>
  // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø±Ø´ÙØ© Ù…ØªÙˆÙØ±Ø© Ø§Ù„Ø¢Ù† ÙÙŠ archive.js

</script>
{% endblock %}
