{% extends 'base.html' %}
{% block title %}المصاريف / الرواتب / الجمارك{% endblock %}

{% block content %}
<div class="container mt-4" dir="rtl">
  <div class="card shadow-sm mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h2 class="mb-0"><i class="fas fa-receipt me-2"></i> كل المصاريف</h2>
      {% if current_user.has_permission('manage_expenses') %}
      <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('expenses_bp.create_expense') }}" class="btn btn-success">
          <i class="fas fa-plus"></i> إضافة مصروف
        </a>
        <a href="{{ url_for('expenses_bp.quick_add') }}" class="btn btn-warning">
          <i class="fas fa-bolt"></i> مصروف سريع
        </a>
        <a href="{{ url_for('expenses_bp.types_list') }}" class="btn btn-outline-secondary">
          <i class="fas fa-tags"></i> أنواع المصاريف
        </a>
        <a href="{{ url_for('expenses_bp.employees_list') }}" class="btn btn-outline-secondary">
          <i class="fas fa-users"></i> الموظفون
        </a>
      </div>
      {% endif %}
    </div>

    <div class="card-body">
      {% set ns_types = namespace(data={}) %}
      {% set ns_emps = namespace(data={}) %}
      {% set ns_ship = namespace(data={}) %}
      {% set ns_util = namespace(data={}) %}
      {% set ns_sadj = namespace(data={}) %}
      {% for e in expenses %}
        {% if e.type %}{% set _ = ns_types.data.update({e.type.id: e.type.name}) %}{% endif %}
        {% if e.employee %}{% set _ = ns_emps.data.update({e.employee.id: e.employee.name}) %}{% endif %}
        {% if e.shipment %}{% set _ = ns_ship.data.update({e.shipment.id: e.shipment.number}) %}{% endif %}
        {% if e.utility_account %}{% set _ = ns_util.data.update({e.utility_account.id: (e.utility_account.alias or e.utility_account.provider)}) %}{% endif %}
        {% if e.stock_adjustment_id %}{% set _ = ns_sadj.data.update({e.stock_adjustment_id: ('#' ~ e.stock_adjustment_id)}) %}{% endif %}
      {% endfor %}

      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">بحث</label>
          <input type="text" name="q" value="{{ search or '' }}" class="form-control" placeholder="وصف، جهة، رقم فاتورة...">
        </div>

        <div class="col-md-2">
          <label class="form-label">من تاريخ</label>
          <input type="date" name="start" value="{{ start and start.strftime('%Y-%m-%d') or '' }}" class="form-control">
        </div>

        <div class="col-md-2">
          <label class="form-label">إلى تاريخ</label>
          <input type="date" name="end" value="{{ end and end.strftime('%Y-%m-%d') or '' }}" class="form-control">
        </div>

        <div class="col-md-2">
          <label class="form-label">نوع المصروف</label>
          <select name="type_id" class="form-select">
            <option value="">الكل</option>
            {% for tid, tname in ns_types.data|dictsort(by='value') %}
              <option value="{{ tid }}" {{ (type_id and tid==type_id) and 'selected' or '' }}>{{ tname }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">الموظف</label>
          <select name="employee_id" class="form-select">
            <option value="">الكل</option>
            {% for eid, ename in ns_emps.data|dictsort(by='value') %}
              <option value="{{ eid }}" {{ (employee_id and eid==employee_id) and 'selected' or '' }}>{{ ename }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">الشحنة</label>
          <select name="shipment_id" class="form-select">
            <option value="">الكل</option>
            {% for sid, snum in ns_ship.data|dictsort(by='value') %}
              <option value="{{ sid }}" {{ (shipment_id and sid==shipment_id) and 'selected' or '' }}>{{ snum }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">حساب المرفق</label>
          <select name="utility_account_id" class="form-select">
            <option value="">الكل</option>
            {% for uid, uname in ns_util.data|dictsort(by='value') %}
              <option value="{{ uid }}" {{ (utility_account_id and uid==utility_account_id) and 'selected' or '' }}>{{ uname }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">تسوية مخزون</label>
          <select name="stock_adjustment_id" class="form-select">
            <option value="">الكل</option>
            {% for aid, alabel in ns_sadj.data|dictsort(by='value') %}
              <option value="{{ aid }}" {{ (stock_adjustment_id and aid==stock_adjustment_id) and 'selected' or '' }}>{{ alabel }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">نوع المستفيد</label>
          <select name="payee_type" class="form-select">
            <option value="">الكل</option>
            <option value="EMPLOYEE" {{ payee_type=='EMPLOYEE' and 'selected' or '' }}>موظّف</option>
            <option value="UTILITY" {{ payee_type=='UTILITY' and 'selected' or '' }}>مرفق</option>
            <option value="OTHER" {{ payee_type=='OTHER' and 'selected' or '' }}>أخرى</option>
          </select>
        </div>

        <div class="col-md-12 d-flex gap-2 flex-wrap">
          <button class="btn btn-primary"><i class="fas fa-search"></i> بحث</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('expenses_bp.list_expenses') }}">مسح</a>
          <a class="btn btn-outline-success"
             href="{{ url_for('expenses_bp.export',
               q=search or None,
               start=start and start.strftime('%Y-%m-%d') or None,
               end=end and end.strftime('%Y-%m-%d') or None,
               type_id=type_id or None,
               employee_id=employee_id or None,
               shipment_id=shipment_id or None,
               utility_account_id=utility_account_id or None,
               stock_adjustment_id=stock_adjustment_id or None,
               payee_type=payee_type or None
             ) }}">
            <i class="fas fa-file-excel"></i> تصدير (CSV)
          </a>
          <a class="btn btn-outline-dark" target="_blank"
             href="{{ url_for('expenses_bp.print_list',
               q=search or None,
               start=start and start.strftime('%Y-%m-%d') or None,
               end=end and end.strftime('%Y-%m-%d') or None,
               type_id=type_id or None,
               employee_id=employee_id or None,
               shipment_id=shipment_id or None,
               utility_account_id=utility_account_id or None,
               stock_adjustment_id=stock_adjustment_id or None,
               payee_type=payee_type or None
             ) }}">
            <i class="fas fa-print"></i> طباعة
          </a>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">إجمالي المبالغ</div>
            <div class="h5 mb-0">
              {{ expenses|map(attribute='amount')|sum|float|round(2) | number_format(2) }}
            </div>
          </div>
          <i class="fas fa-sack-dollar fa-lg text-primary"></i>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">مدفوع</div>
            <div class="h5 mb-0">
              {{ expenses|map(attribute='total_paid')|sum|float|round(2) | number_format(2) }}
            </div>
          </div>
          <i class="fas fa-check-circle fa-lg text-success"></i>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">الرصيد</div>
            <div class="h5 mb-0">
              {{ expenses|map(attribute='balance')|sum|float|round(2) | number_format(2) }}
            </div>
          </div>
          <i class="fas fa-wallet fa-lg text-warning"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body table-responsive">
      <table id="expenses-table" class="table table-striped table-bordered align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th>التاريخ</th>
            <th>النوع</th>
            <th>الموظف</th>
            <th>المستفيد</th>
            <th>المبلغ</th>
            <th>العملة</th>
            <th>طريقة الدفع</th>
            <th>مدفوع</th>
            <th>الرصيد</th>
            <th>الوصف</th>
            <th>ملاحظات</th>
            <th>رقم الفاتورة</th>
            <th style="width:180px">إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
          {% set pt = e.payee_type or '' %}
          <tr>
            <td class="text-nowrap">{{ e.date|format_date }}</td>
            <td>{{ e.type.name if e.type else '—' }}</td>
            <td>{{ e.employee.name if e.employee else '—' }}</td>
            <td>
              {% if pt == 'EMPLOYEE' %}
                <span class="badge bg-info text-dark me-1">موظّف</span>
              {% elif pt == 'UTILITY' %}
                <span class="badge bg-secondary me-1">مرفق</span>
              {% elif pt %}
                <span class="badge bg-light text-dark me-1">أخرى</span>
              {% endif %}
              {{ e.payee_name or e.paid_to or '—' }}
            </td>
            <td class="fw-bold text-end">
              {{ e.amount|number_format(2) }}
              <span class="badge bg-light text-dark">{{ e.currency }}</span>
            </td>
            <td>{{ e.currency }}</td>
            <td class="text-nowrap">{{ e.payment_method or '—' }}</td>
            <td class="text-end">{{ (e.total_paid or 0)|float|round(2)|number_format(2) }}</td>
            <td class="text-end">
              {% if e.is_paid %}
                <span class="badge bg-success">مدفوع</span>
              {% else %}
                {{ (e.balance or 0)|float|round(2)|number_format(2) }}
              {% endif %}
            </td>
            <td class="text-truncate" style="max-width:220px">{{ e.description or '—' }}</td>
            <td class="text-truncate" style="max-width:220px">{{ e.notes or '—' }}</td>
            <td>{{ e.tax_invoice_number or '—' }}</td>
            <td class="text-nowrap text-center">
              <div class="btn-group">
                <a href="{{ url_for('expenses_bp.detail', exp_id=e.id) }}" class="btn btn-sm btn-info" title="تفاصيل">
                  <i class="fas fa-eye"></i>
                </a>
                {% if current_user.has_permission('manage_expenses') %}
                <a href="{{ url_for('expenses_bp.edit', exp_id=e.id) }}" class="btn btn-sm btn-warning" title="تعديل">
                  <i class="fas fa-edit"></i>
                </a>
                <form method="post" action="{{ url_for('expenses_bp.delete', exp_id=e.id) }}" onsubmit="return confirm('حذف المصروف؟');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-sm btn-danger" title="حذف"><i class="fas fa-trash"></i></button>
                </form>
                {% endif %}
                {% if current_user.has_permission('manage_payments') and not e.is_paid %}
                <a href="{{ url_for('expenses_bp.pay', exp_id=e.id) }}" class="btn btn-sm btn-outline-success" title="دفع">
                  <i class="fas fa-money-bill-wave"></i>
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="fw-bold">
            <td colspan="4" class="text-end">الإجماليات</td>
            <td class="text-end">
              {{ expenses|map(attribute='amount')|sum|float|round(2) | number_format(2) }}
            </td>
            <td></td>
            <td></td>
            <td class="text-end">
              {{ expenses|map(attribute='total_paid')|sum|float|round(2) | number_format(2) }}
            </td>
            <td class="text-end">
              {{ expenses|map(attribute='balance')|sum|float|round(2) | number_format(2) }}
            </td>
            <td colspan="4"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/expenses.js') }}"></script>
{% endblock %}
