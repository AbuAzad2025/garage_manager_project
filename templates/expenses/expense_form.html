{% extends "base.html" %}
{% block title %}{{ is_edit and 'ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ' or 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ' }}{% endblock %}

{% block content %}
<div class="container mt-4" dir="rtl">
  
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
  <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">
          <i class="fas fa-{{ is_edit and 'edit' or 'plus' }} ml-2"></i>
          {{ is_edit and 'ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ' or 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯' }}
        </h3>
    <a href="{{ url_for('expenses_bp.list_expenses') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-right ml-1"></i> Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
          </a>
        </div>

  <!-- Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
  {% if form.errors %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle ml-2"></i>Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:</h5>
    <ul class="mb-0">
      {% for field_name, errors in form.errors.items() %}
        {% for error in errors %}
          <li><strong>{{ form[field_name].label.text }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
    <button type="button" class="close" data-dismiss="alert"></button>
  </div>
  {% endif %}

  <form method="POST" id="expenseForm" class="needs-validation" novalidate>
    {{ form.hidden_tag() }}
    <script>
      window.expenseTypeMeta = {{ types_meta|tojson|safe }};
      window._types = {{ _types|tojson|safe }};
    </script>
    <div class="card shadow-sm">
      <div class="card-body">
    <div class="row g-3">
          
          <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©) -->
          <div class="col-md-3">
            {{ form.date.label(class="form-label fw-bold text-danger") }}
            {{ form.date(type="date", class="form-control", id="date", required=true) }}
            <small class="text-muted">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ</small>
              {% for e in form.date.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
            </div>

          <div class="col-md-3">
            {{ form.type_id.label(class="form-label fw-bold text-danger") }}
            {{ form.type_id(class="custom-select", id="type_id", required=true) }}
            <small class="text-muted">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</small>
            {% for e in form.type_id.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>

          <div class="col-md-3">
            {{ form.amount.label(class="form-label fw-bold text-danger") }}
            {{ form.amount(class="form-control", step="0.01", id="amount", required=true, placeholder="0.00") }}
            <small class="text-muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small>
              {% for e in form.amount.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
            </div>

          <div class="col-md-3">
            {{ form.currency.label(class="form-label fw-bold text-danger") }}
            {{ form.currency(class="custom-select", id="currency", required=true) }}
            <small class="text-muted">Ø§Ù„Ø¹Ù…Ù„Ø©</small>
              {% for e in form.currency.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
            </div>

          <!-- Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹) -->
          <div class="col-12"><hr class="my-2"><h6 class="text-muted mb-0"><i class="fas fa-link ml-1"></i>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹)</h6></div>

          <div class="col-md-3">
            {{ form.branch_id.label(class="form-label fw-bold text-danger") }}
            {{ form.branch_id(class="custom-select", id="branch_id", required=true) }}
            <small class="text-muted">ÙØ±Ø¹ Ø§Ù„Ø´Ø±ÙƒØ© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</small>
            {% for e in form.branch_id.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>

          <div class="col-md-3">
            {{ form.site_id.label(class="form-label") }}
            {{ form.site_id(class="custom-select", id="site_id") }}
            <small class="text-muted">Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
            {% for e in form.site_id.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>

          <div id="employee-field" class="col-md-6">
            {{ form.employee_id.label(class="form-label fw-bold") }}
            {{ form.employee_id(class="custom-select ajax", id="employee_id", **{
              'data-url': url_for('api.search_employees'),
              'data-current': form.employee_id.data or ''
            }) }}
            <small class="text-muted">Ù„Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø³Ù„Ù</small>
            {% for e in form.employee_id.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
            </div>

          <div id="period-fields" class="col-md-6">
            <label class="form-label fw-bold">Ø§Ù„ÙØªØ±Ø©</label>
            <div class="row g-2">
              <div class="col-6">
                {{ form.period_start(type="date", class="form-control form-control-sm", id="period_start", placeholder="Ù…Ù†") }}
              </div>
              <div class="col-6">
                {{ form.period_end(type="date", class="form-control form-control-sm", id="period_end", placeholder="Ø¥Ù„Ù‰") }}
              </div>
            </div>
            <small class="text-muted">Ù„Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</small>
          </div>

          <div id="utility-field" class="col-md-4">
            {{ form.utility_account_id.label(class="form-label") }}
            {{ form.utility_account_id(class="custom-select custom-select-sm ajax", id="utility_account_id", **{
              'data-url': url_for('api.search_utility_accounts'),
              'data-current': form.utility_account_id.data or ''
            }) }}
            <small class="text-muted">Ù„Ù„Ù…Ø±Ø§ÙÙ‚ (ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…Ø§Ø¡/Ø§ØªØµØ§Ù„Ø§Øª)</small>
          </div>

          <div id="warehouse-field" class="col-md-4">
            {{ form.warehouse_id.label(class="form-label") }}
            {{ form.warehouse_id(class="custom-select custom-select-sm ajax", id="warehouse_id", **{
              'data-url': url_for('api.search_warehouses'),
              'data-current': form.warehouse_id.data or ''
            }) }}
            <small class="text-muted">Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±/Ø§Ù„ØµÙŠØ§Ù†Ø©</small>
          </div>

          <div id="shipment-field" class="col-md-4">
            {{ form.shipment_id.label(class="form-label") }}
            {{ form.shipment_id(class="custom-select custom-select-sm", id="shipment_id") }}
            <small class="text-muted">Ù„Ù„Ø´Ø­Ù†Ø§Øª</small>
          </div>

          <div id="partner-field" class="col-md-4">
            {{ form.partner_id.label(class="form-label") }}
            <div class="input-group input-group-sm">
              {{ form.partner_id(class="custom-select custom-select-sm ajax", id="partner_id", **{
                'data-url': url_for('api.search_partners'),
                'data-current': form.partner_id.data or ''
              }) }}
              <div class="input-group-append">
                <a href="{{ url_for('vendors_bp.partners_create') }}" target="_blank" class="btn btn-sm btn-success" title="Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠÙƒ Ø¬Ø¯ÙŠØ¯">
                  <i class="fas fa-plus"></i>
                </a>
              </div>
            </div>
            <small class="text-muted">Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ</small>
          </div>

          <div id="supplier-field" class="col-md-4">
            {{ form.supplier_id.label(class="form-label") }}
            <div class="input-group input-group-sm">
              {{ form.supplier_id(class="custom-select custom-select-sm ajax", id="supplier_id", **{
                'data-url': url_for('api.search_suppliers'),
                'data-current': form.supplier_id.data or ''
              }) }}
              <div class="input-group-append">
                <a href="{{ url_for('vendors_bp.suppliers_create') }}" target="_blank" class="btn btn-sm btn-success" title="Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯">
                  <i class="fas fa-plus"></i>
                </a>
              </div>
            </div>
            <small class="text-muted">Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ÙˆØ±Ø¯</small>
          </div>

          <div id="beneficiary-field" class="col-md-4">
            {{ form.beneficiary_name.label(class="form-label") }}
            {{ form.beneficiary_name(class="form-control form-control-sm", id="beneficiary_name", placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯") }}
            <small class="text-muted">Ù„Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰</small>
            </div>

          <div id="stock-field" class="col-md-4">
            {{ form.stock_adjustment_id.label(class="form-label") }}
            {{ form.stock_adjustment_id(class="custom-select custom-select-sm", id="stock_adjustment_id") }}
            <small class="text-muted">Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</small>
          </div>

          <!-- Ø­Ù‚ÙˆÙ„ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø³Ù„Ù (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù†ÙˆØ¹ Ø³Ù„ÙØ© Ù…ÙˆØ¸Ù) -->
          <div id="advance-fields" class="col-12" style="display:none;">
            <div class="row g-2">
              <div class="col-md-4">
                {{ form.installments_count.label(class="form-label") }}
                {{ form.installments_count(class="form-control form-control-sm", id="installments_count", placeholder="1") }}
                <small class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„ÙØ©</small>
              </div>
              <div class="col-md-4">
                <div class="form-check mt-4">
                  {{ form.create_deduction(class="form-check-input", id="create_deduction") }}
                  <label class="form-check-label" for="create_deduction">
                    {{ form.create_deduction.label.text }}
                  </label>
                  <small class="form-text text-muted d-block">Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ -->
          <div class="col-12"><hr class="my-2"><h6 class="text-muted mb-0"><i class="fas fa-money-bill ml-1"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h6></div>

          <div class="col-md-4">
            {{ form.disbursed_by.label(class="form-label fw-bold") }}
            {{ form.disbursed_by(class="form-control", id="disbursed_by", placeholder="Ù…Ù† Ø³Ù„Ù… Ø§Ù„Ù…Ø§Ù„ØŸ") }}
            <small class="text-muted">Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ø³Ù„Ù… Ø§Ù„Ù…Ø§Ù„ (Ø¥Ù„Ø²Ø§Ù…ÙŠ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙÙ‚Ø§Øª)</small>
            {% for e in form.disbursed_by.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>

          <div class="col-md-4">
            {{ form.payment_method.label(class="form-label fw-bold") }}
              {{ form.payment_method(class="custom-select", id="payment_method") }}
            <small class="text-muted">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</small>
              {% for e in form.payment_method.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
            </div>

          <div id="methodDetails" class="col-12" style="display:none;">
            <div class="row g-2">
              <div class="col-md-3" data-field="check_number">
                {{ form.check_number.label(class="form-label") }}
                {{ form.check_number(class="form-control", placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ") }}
              </div>
              <div class="col-md-3" data-field="check_bank">
                {{ form.check_bank.label(class="form-label") }}
                {{ form.check_bank(class="form-control", placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ") }}
              </div>
              <div class="col-md-3" data-field="check_due_date">
                {{ form.check_due_date.label(class="form-label") }}
                {{ form.check_due_date(type="date", class="form-control") }}
              </div>
              <div class="col-md-3" data-field="check_payee">
                {{ form.check_payee.label(class="form-label") }}
                {{ form.check_payee(class="form-control", placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯") }}
              </div>

              <div class="col-md-3" data-field="bank_transfer_ref">
                {{ form.bank_transfer_ref.label(class="form-label") }}
                {{ form.bank_transfer_ref(class="form-control", placeholder="Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø­ÙˆØ§Ù„Ø©") }}
              </div>
              <div class="col-md-3" data-field="bank_name">
                {{ form.bank_name.label(class="form-label") }}
                {{ form.bank_name(class="form-control", placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ") }}
              </div>
              <div class="col-md-3" data-field="account_number">
                {{ form.account_number.label(class="form-label") }}
                {{ form.account_number(class="form-control", placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨") }}
              </div>
              <div class="col-md-3" data-field="account_holder">
                {{ form.account_holder.label(class="form-label") }}
                {{ form.account_holder(class="form-control", placeholder="ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨") }}
              </div>

              <div class="col-md-3" data-field="card_number">
                {{ form.card_number.label(class="form-label") }}
                {{ form.card_number(class="form-control", placeholder="**** ****") }}
              </div>
              <div class="col-md-3" data-field="card_holder">
                {{ form.card_holder.label(class="form-label") }}
                {{ form.card_holder(class="form-control", placeholder="Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©") }}
              </div>

              <div class="col-md-4" data-field="online_gateway">
                {{ form.online_gateway.label(class="form-label") }}
                {{ form.online_gateway(class="form-control", placeholder="Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©") }}
              </div>
              <div class="col-md-4" data-field="online_ref">
                {{ form.online_ref.label(class="form-label") }}
                {{ form.online_ref(class="form-control", placeholder="Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©") }}
          </div>
        </div>
      </div>

          <div class="col-md-8">
            {{ form.payment_details.label(class="form-label") }}
            {{ form.payment_details(class="form-control", placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹") }}
            <small class="text-muted">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ø¯ÙØ¹Ø©</small>
            </div>

          <!-- Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© -->
          <div class="col-12">
            <hr class="my-2">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#optionalSection" aria-expanded="false" aria-controls="optionalSection">
              <i class="fas fa-sliders-h ml-1"></i> Ø­Ù‚ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
            </button>
          </div>

          <div id="optionalSection" class="collapse col-12">

          <div class="col-md-4">
              {{ form.tax_invoice_number.label(class="form-label") }}
            {{ form.tax_invoice_number(class="form-control", placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ©") }}
            <small class="text-muted">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
            </div>

          <div class="col-md-8">
              {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ") }}
            <small class="text-muted">Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</small>
            </div>

          <div class="col-12">
              {{ form.notes.label(class="form-label") }}
            {{ form.notes(class="form-control", rows=2, placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©") }}
            <small class="text-muted">Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰</small>
          </div>
          </div>

        </div>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-success btn-lg">
        <i class="fas fa-save ml-1"></i>
        {{ is_edit and 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' or 'Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ' }}
      </button>
      <a class="btn btn-outline-secondary btn-lg" href="{{ url_for('expenses_bp.list_expenses') }}">
        <i class="fas fa-times ml-1"></i>
        Ø¥Ù„ØºØ§Ø¡
      </a>
    </div>
  </form>
</div>

<script>
// âœ… Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ
document.addEventListener('DOMContentLoaded', function() {
  const typeSelect = document.getElementById('type_id');
  const employeeField = document.getElementById('employee-field');
  const periodFields = document.getElementById('period-fields');
  const utilityField = document.getElementById('utility-field');
  const warehouseField = document.getElementById('warehouse-field');
  const shipmentField = document.getElementById('shipment-field');
  const partnerField = document.getElementById('partner-field');
  const supplierField = document.getElementById('supplier-field');
  const beneficiaryField = document.getElementById('beneficiary-field');
  const stockField = document.getElementById('stock-field');
  
  // Meta Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
  const typeMeta = (window.expenseTypeMeta || {});
  
  // ØªÙ‡ÙŠØ¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨Ø­Ø« AJAX Ø¨Ø³ÙŠØ·Ø©
  function initAjaxSelects() {
    document.querySelectorAll('select.ajax').forEach(sel => {
      const url = sel.getAttribute('data-url');
      if (!url) return;
      // Ø¯Ø¹Ù… Ø¨Ø­Ø« Ø¨Ø³ÙŠØ· Ø¹Ø¨Ø± datalist-like
      sel.addEventListener('focus', () => sel.size = Math.min(sel.options.length, 8));
      sel.addEventListener('blur', () => sel.size = 0);
      sel.addEventListener('input', e => {
        // placeholder: ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø±Ø¨Ø· Select2ØŒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù…Ù„Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ø¨Ø± Ø§Ù„ØµÙØ­Ø©
      });
    });
  }
  
    // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ container ÙˆÙ…Ø³Ø­ Ø§Ù„Ù‚ÙŠÙ…
    function setFieldsDisabled(container, disabled) {
      if (!container) return;
      const inputs = container.querySelectorAll('input, select, textarea');
      inputs.forEach(inp => {
        if (disabled) {
          inp.setAttribute('disabled', 'disabled');
          if (inp.tagName === 'SELECT') {
            inp.selectedIndex = 0;
          } else {
            inp.value = '';
          }
        } else {
          inp.removeAttribute('disabled');
        }
      });
    }
  
  function updateRelatedFields() {
    // Debug: ÙØ­Øµ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    console.log('ğŸ” Debug:', {
      typeSelect: !!typeSelect,
      employeeField: !!employeeField,
      periodFields: !!periodFields,
      utilityField: !!utilityField,
      warehouseField: !!warehouseField,
      shipmentField: !!shipmentField,
      partnerField: !!partnerField,
      supplierField: !!supplierField,
      beneficiaryField: !!beneficiaryField,
      stockField: !!stockField
    });
    
    // âœ… Ø¥Ø®ÙØ§Ø¡ ÙˆØªØ¹Ø·ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ ÙˆÙ…Ø³Ø­ Ø§Ù„Ù‚ÙŠÙ…
    [employeeField, periodFields, utilityField, warehouseField, shipmentField, 
     partnerField, supplierField, beneficiaryField, stockField].forEach(f => {
      if (f) {
        const wasVisible = f.style.display !== 'none';
        f.style.display = 'none';
        if (wasVisible) {
          setFieldsDisabled(f, true);
        }
      }
    });
    
    const typeId = parseInt(typeSelect.value);
    const meta = typeMeta[typeId] || {};
    const required = new Set((meta.required || []));
    const optional = new Set((meta.optional || []));

    function showIf(key, container) {
      if (!container) return;
      if (required.has(key) || optional.has(key)) {
        container.style.display = 'block';
        setFieldsDisabled(container, false);
      }
    }

    // Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
    showIf('employee_id', employeeField);
    showIf('period', periodFields);
    showIf('utility_account_id', utilityField);
    showIf('warehouse_id', warehouseField);
    showIf('shipment_id', shipmentField);
    showIf('partner_id', partnerField);
    showIf('supplier_id', supplierField);
    showIf('stock_adjustment_id', stockField);
    showIf('beneficiary_name', beneficiaryField);
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ù„Ù ÙÙ‚Ø· Ù„Ù†ÙˆØ¹ EMPLOYEE_ADVANCE
    const advanceFields = document.getElementById('advance-fields');
    const selectedType = _types.find(t => t.id === typeId);
    if (advanceFields) {
      if (selectedType && selectedType.code === 'EMPLOYEE_ADVANCE') {
        advanceFields.style.display = 'block';
        const advInputs = advanceFields.querySelectorAll('input, select');
        advInputs.forEach(inp => inp.removeAttribute('disabled'));
      } else {
        advanceFields.style.display = 'none';
        const advInputs = advanceFields.querySelectorAll('input, select');
        advInputs.forEach(inp => {
          inp.setAttribute('disabled', 'disabled');
          if (inp.tagName === 'SELECT') {
            inp.selectedIndex = 0;
          } else {
            inp.value = '';
          }
        });
      }
    }
  }
  
  typeSelect.addEventListener('change', updateRelatedFields);
  updateRelatedFields(); // ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  
  // âœ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø·Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù„Ù…Ù†Ø¹ MemoryError)
  const form = document.getElementById('expenseForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      const branchSelect = document.getElementById('branch_id');
      const siteSelect = document.getElementById('site_id');
      const typeSelect = document.getElementById('type_id');
      const amountInput = document.getElementById('amount');
      const disbursedInput = document.getElementById('disbursed_by');
      
      if (!branchSelect || !branchSelect.value || branchSelect.value === '0') {
        e.preventDefault();
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹');
        branchSelect.focus();
        return false;
      }
      
      if (!disbursedInput || !disbursedInput.value || disbursedInput.value.trim() === '') {
        e.preventDefault();
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ø³Ù„Ù… Ø§Ù„Ù…Ø§Ù„');
        disbursedInput.focus();
        return false;
      }
      
      const criticalFields = [branchSelect, siteSelect, typeSelect, amountInput, disbursedInput];
      
      const disabledFields = form.querySelectorAll('input:disabled, select:disabled, textarea:disabled');
      disabledFields.forEach(field => {
        if (!criticalFields.includes(field)) {
          field.removeAttribute('name');
        }
      });
    });
  }
  
  // âœ… Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
  const methodSelect = document.getElementById('payment_method');
  const methodDetails = document.getElementById('methodDetails');
  
  function updateMethodDetails() {
    const method = methodSelect.value;
    methodDetails.style.display = 'none';
    methodDetails.querySelectorAll('[data-field]').forEach(f => f.style.display = 'none');
    
    if (method === 'CHEQUE') {
      methodDetails.style.display = 'block';
      ['check_number', 'check_bank', 'check_due_date', 'check_payee'].forEach(f => {
        const el = methodDetails.querySelector(`[data-field="${f}"]`);
        if (el) el.style.display = 'block';
      });
    } else if (method === 'BANK_TRANSFER') {
      methodDetails.style.display = 'block';
      ['bank_transfer_ref', 'bank_name', 'account_number', 'account_holder'].forEach(f => {
        const el = methodDetails.querySelector(`[data-field="${f}"]`);
        if (el) el.style.display = 'block';
      });
    } else if (method === 'CREDIT_CARD' || method === 'DEBIT_CARD') {
      methodDetails.style.display = 'block';
      ['card_number', 'card_holder'].forEach(f => {
        const el = methodDetails.querySelector(`[data-field="${f}"]`);
        if (el) el.style.display = 'block';
      });
    } else if (method === 'ONLINE') {
      methodDetails.style.display = 'block';
      ['online_gateway', 'online_ref'].forEach(f => {
        const el = methodDetails.querySelector(`[data-field="${f}"]`);
        if (el) el.style.display = 'block';
      });
    }
  }
  
  methodSelect.addEventListener('change', updateMethodDetails);
  updateMethodDetails();
  initAjaxSelects();
});
</script>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/expenses.js') }}"></script>
  <script src="{{ url_for('static', filename='js/branch-site-filter.js') }}"></script>
{% endblock %}
