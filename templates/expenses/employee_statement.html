{% extends 'base.html' %}
{% block title %}ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù - {{ employee.name }}{% endblock %}

{% block page_title %}ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù - {{ employee.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('expenses_bp.list_expenses') }}">Ø§Ù„Ù†ÙÙ‚Ø§Øª</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('expenses_bp.employees_list') }}">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</a></li>
<li class="breadcrumb-item active">ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</li>
{% endblock %}

{% block content %}
  
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© (Ù…Ø®ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
  <div class="d-flex justify-content-between align-items-center mb-3 no-print">
      <h3 class="mb-0">
        <i class="fas fa-file-invoice mr-2"></i>
        ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù: {{ employee.name }}
      </h3>
      <div class="d-flex">
        <a href="{{ url_for('expenses_bp.employees_list') }}" class="btn btn-secondary mr-2">
          <i class="fas fa-arrow-right mr-1"></i> Ø±Ø¬ÙˆØ¹
        </a>
        <button class="btn btn-primary btn-print" onclick="window.print()">
          <i class="fas fa-print mr-1"></i> Ø·Ø¨Ø§Ø¹Ø©
        </button>
    </div>
  </div>

  <!-- Ø±Ø£Ø³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
  <div class="print-header d-none d-print-block">
    <h2>Ù†Ø¸Ø§Ù… Ø£Ø²Ø§Ø¯ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ±Ø§Ø¬</h2>
    <div class="company-info">
      Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ | {{ "now"|format_datetime("%Y-%m-%d %H:%M") }}
    </div>
    <h3 class="mt-3">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù</h3>
  </div>

  <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <i class="fas fa-user mr-1"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ employee.name }}
        </div>
        <div class="col-md-3">
          <strong>Ø§Ù„Ù…Ø³Ù…Ù‰:</strong> {{ employee.position or 'â€”' }}
        </div>
        <div class="col-md-3">
          <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†:</strong> {{ employee.hire_date.strftime('%Y-%m-%d') if employee.hire_date else 'â€”' }}
        </div>
        <div class="col-md-3">
          <strong>Ø§Ù„ÙØ±Ø¹:</strong> {{ employee.branch.name if employee.branch else 'â€”' }}
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</h6>
          <h4 class="text-dark">{{ "%.2f"|format(employee.salary or 0) }} â‚ª</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù</h6>
          <h4 class="text-warning">{{ "%.2f"|format(employee.total_advances) }} â‚ª</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h6>
          <h4 class="text-danger">{{ "%.2f"|format(employee.total_deductions) }} â‚ª</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ</h6>
          <h4 class="text-success">{{ "%.2f"|format(employee.net_salary) }} â‚ª</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ø³Ù„Ù -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-white">
      <i class="fas fa-hand-holding-usd mr-1"></i> Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©
    </div>
    <div class="card-body">
      {% if advances %}
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„ÙˆØµÙ</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
            </tr>
          </thead>
          <tbody>
            {% for adv in advances %}
            <tr>
              <td>{{ adv.date.strftime('%Y-%m-%d') if adv.date else 'â€”' }}</td>
              <td>{{ "%.2f"|format(adv.amount) }} {{ adv.currency }}</td>
              <td>{{ adv.description or 'â€”' }}</td>
              <td>
                {% set installments = adv.installments %}
                {% if installments %}
                  {% set paid_count = installments|selectattr('paid')|list|length %}
                  {% set total_count = installments|length %}
                  <span class="badge bg-{% if paid_count == total_count %}success{% else %}warning{% endif %}">
                    {{ paid_count }}/{{ total_count }} Ø£Ù‚Ø³Ø§Ø·
                  </span>
                {% else %}
                  <span class="badge bg-secondary">Ø¨Ø¯ÙˆÙ† Ø£Ù‚Ø³Ø§Ø·</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center mb-0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù Ù…Ø³Ø¬Ù„Ø©</p>
      {% endif %}
    </div>
  </div>

  <!-- Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-danger text-white">
      <i class="fas fa-minus-circle mr-1"></i> Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    </div>
    <div class="card-body">
      {% if deductions %}
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ù…Ù†</th>
              <th>Ø¥Ù„Ù‰</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for ded in deductions %}
            <tr>
              <td>{{ ded.deduction_type }}</td>
              <td>{{ "%.2f"|format(ded.amount) }} {{ ded.currency }}</td>
              <td>{{ ded.start_date.strftime('%Y-%m-%d') if ded.start_date else 'â€”' }}</td>
              <td>{{ ded.end_date.strftime('%Y-%m-%d') if ded.end_date else 'Ù…Ø³ØªÙ…Ø±' }}</td>
              <td>
                <span class="badge bg-{% if ded.is_active %}success{% else %}secondary{% endif %}">
                  {{ 'Ù†Ø´Ø·' if ded.is_active else 'Ù…ÙˆÙ‚ÙˆÙ' }}
                </span>
              </td>
              <td>{{ ded.notes or 'â€”' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center mb-0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ØµÙˆÙ…Ø§Øª Ø´Ù‡Ø±ÙŠØ©</p>
      {% endif %}
    </div>
  </div>

  <!-- Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <span><i class="fas fa-money-bill-wave mr-1"></i> Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</span>
      <button type="button" class="btn btn-light btn-sm no-print" data-toggle="modal" data-target="#generateSalaryModal">
        <i class="fas fa-plus-circle mr-1"></i> ØªÙˆÙ„ÙŠØ¯ Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ
      </button>
    </div>
    <div class="card-body">
      {% if salaries %}
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø´Ù‡Ø±</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for sal in salaries %}
            <tr>
              <td>{{ sal.date.strftime('%Y-%m-%d') if sal.date else 'â€”' }}</td>
              <td>
                {% if sal.period_start %}
                  {{ sal.period_start.strftime('%Y-%m') }}
                {% else %}
                  â€”
                {% endif %}
              </td>
              <td>{{ "%.2f"|format(sal.amount) }} {{ sal.currency }}</td>
              <td>{{ sal.payment_method|upper }}</td>
              <td>{{ sal.description or 'â€”' }}</td>
              <td class="no-print">
                <a href="{{ url_for('expenses_bp.salary_receipt', salary_exp_id=sal.id) }}" class="btn btn-sm btn-success" target="_blank" title="Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„">
                  <i class="fas fa-print"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center mb-0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§ØªØ¨ Ù…Ø¯ÙÙˆØ¹Ø©</p>
      {% endif %}
    </div>
  </div>

  <!-- Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ -->
  <div class="card shadow-lg">
    <div class="card-body text-center">
      <h5>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h5>
      {% set balance = employee.balance %}
      <h2 class="{% if balance < 0 %}text-danger{% elif balance > 0 %}text-success{% else %}text-secondary{% endif %}">
        {{ "%.2f"|format(balance|abs) }} â‚ª
        {% if balance < 0 %}
          <small class="text-muted d-block mt-2">Ù„Ù‡ Ø¹Ù†Ø¯Ù†Ø§ (ÙŠØ³ØªØ­Ù‚ Ø¯ÙØ¹)</small>
        {% elif balance > 0 %}
          <small class="text-muted d-block mt-2">Ø¹Ù„ÙŠÙ‡ Ù„Ù†Ø§ (Ù…Ø¯ÙŠÙ†)</small>
        {% else %}
          <small class="text-muted d-block mt-2">Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ§Ø²Ù†</small>
        {% endif %}
      </h2>
    </div>
  </div>

  <!-- Ø°ÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
  <div class="print-footer d-none d-print-block">
    ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø©: {{ current_user.username }} | Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ "now"|format_datetime("%Y-%m-%d %H:%M") }}
    <br>
    <small>Ù†Ø¸Ø§Ù… Ø£Ø²Ø§Ø¯ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ±Ø§Ø¬ - v5.0.0 Enterprise</small>
  </div>

  <div class="modal fade" id="generateSalaryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-calculator mr-2"></i>ØªÙˆÙ„ÙŠØ¯ Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ - {{ employee.name }}</h5>
          <button type="button" class="close text-white" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <form method="post" action="{{ url_for('expenses_bp.generate_salary', emp_id=employee.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="modal-body" style="background: #f8f9fa;">
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-body">
                <h6 class="text-muted mb-3"><i class="fas fa-calendar text-primary"></i> Ø§Ù„ÙØªØ±Ø©</h6>
                <div class="row">
                  <div class="col-6">
                    <label class="font-weight-bold">Ø§Ù„Ø´Ù‡Ø±</label>
                    <select name="month" class="form-control form-control-lg" required>
                      {% for m in range(1, 13) %}
                      <option value="{{ m }}" {% if m == "now"|format_datetime("%m")|int %}selected{% endif %}>
                        {% set month_names = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'] %}
                        {{ month_names[m-1] }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="font-weight-bold">Ø§Ù„Ø³Ù†Ø©</label>
                    <select name="year" id="year_select" class="form-control form-control-lg" required>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="card border-0 shadow-sm mb-3">
              <div class="card-body">
                <h6 class="text-muted mb-3"><i class="fas fa-money-bill-wave text-success"></i> Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h6>
                <div class="row">
                  <div class="col-6 mb-3">
                    <label class="font-weight-bold">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
                    <input type="number" step="0.01" name="base_salary" id="base_salary" class="form-control form-control-lg" value="{{ employee.salary }}" required>
                  </div>
                  <div class="col-6 mb-3">
                    <label class="font-weight-bold">Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</label>
                    <input type="number" step="0.01" name="monthly_deductions" class="form-control form-control-lg bg-light" value="{{ employee.total_deductions }}" readonly>
                  </div>
                  <div class="col-6 mb-3">
                    <label class="font-weight-bold">Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª</label>
                    <input type="number" step="0.01" name="social_insurance_emp" class="form-control form-control-lg bg-light" value="{{ employee.social_insurance_employee_amount|round(2) }}" readonly>
                  </div>
                  <div class="col-6 mb-3">
                    <label class="font-weight-bold">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ø®Ù„</label>
                    <input type="number" step="0.01" name="income_tax" class="form-control form-control-lg bg-light" value="{{ employee.income_tax_amount|round(2) }}" readonly>
                  </div>
                </div>
                <div id="advances_container"></div>
                <div class="alert alert-success mb-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="font-weight-bold">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ:</span>
                    <span class="h3 mb-0" id="total_net_salary">{{ employee.net_salary_after_all|round(2) }} â‚ª</span>
                  </div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <label class="font-weight-bold">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙØ¹Ù„ÙŠØ§Ù‹</label>
                    <input type="number" step="0.01" name="actual_payment" id="actual_payment" class="form-control form-control-lg" value="{{ employee.net_salary_after_all|round(2) }}" required>
                    <small class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ø²Ø¦ÙŠ</small>
                  </div>
                  <div class="col-6">
                    <label class="font-weight-bold">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</label>
                    <div class="input-group">
                      <input type="text" id="payment_percentage" class="form-control form-control-lg bg-light text-center" readonly value="100">
                      <div class="input-group-append">
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="alert alert-warning mt-3 mb-0" id="remaining_alert" style="display:none;">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="font-weight-bold">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¯ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©):</span>
                    <span class="h4 mb-0 text-danger" id="remaining_amount">0.00 â‚ª</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h6 class="text-muted mb-3"><i class="fas fa-file-invoice text-info"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h6>
                <div class="row">
                  <div class="col-6 mb-3">
                    <label class="font-weight-bold">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                    <select name="payment_method" id="payment_method" class="form-control form-control-lg" required>
                      <option value="CASH">Ù†Ù‚Ø¯Ø§Ù‹</option>
                      <option value="BANK_TRANSFER" selected>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                      <option value="CHECK">Ø´ÙŠÙƒ</option>
                      <option value="OTHER">Ø£Ø®Ø±Ù‰</option>
                    </select>
                  </div>
                  <div class="col-6 mb-3">
                    <label class="font-weight-bold">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
                    <input type="date" name="payment_date" class="form-control form-control-lg" value="{{ 'now'|format_datetime('%Y-%m-%d') }}" required>
                  </div>
                </div>
                
                <div id="payment_details_container"></div>
                
                <div class="row">
                  <div class="col-12">
                    <label class="font-weight-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" class="form-control" rows="3" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary btn-lg" data-dismiss="modal" id="cancel_btn">
              <i class="fas fa-times mr-1"></i> Ø¥Ù„ØºØ§Ø¡
            </button>
            <button type="submit" class="btn btn-success btn-lg" id="save_salary_btn">
              <i class="fas fa-check-circle mr-1"></i> ØªÙˆÙ„ÙŠØ¯ ÙˆØ­ÙØ¸
            </button>
            <button type="button" class="btn btn-success btn-lg d-none" id="loading_btn" disabled>
              <span class="spinner-border spinner-border-sm mr-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<style>
  .modal-backdrop { pointer-events: none !important; }
  #generateSalaryModal .modal-content { border-radius: 15px; overflow: hidden; }
  #generateSalaryModal .modal-header { border: none; }
  #generateSalaryModal .modal-footer { border: none; }
  #generateSalaryModal .card { transition: transform 0.2s; }
  #generateSalaryModal .form-control:focus { border-color: #28a745; box-shadow: 0 0 0 0.2rem rgba(40,167,69,.25); }
  .payment-detail-field { animation: fadeIn 0.3s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
<script>
$(document).ready(function() {
  const netSalary = {{ employee.net_salary_after_all|round(2) }};
  
  const currentYear = new Date().getFullYear();
  const currentMonth = new Date().getMonth() + 1;
  $('#year_select').html(`
    <option value="${currentYear - 1}">${currentYear - 1}</option>
    <option value="${currentYear}" selected>${currentYear}</option>
    <option value="${currentYear + 1}">${currentYear + 1}</option>
  `);
  
  function loadAdvanceInstallments() {
    const month = $('select[name="month"]').val();
    const year = $('#year_select').val();
    
    if (!month || !year) return;
    
    $.ajax({
      url: `/expenses/employees/{{ employee.id }}/installments-due`,
      data: { month: month, year: year },
      success: function(data) {
        const container = $('#advances_container');
        if (data.installments && data.installments.length > 0) {
          let html = '<div class="alert alert-info mt-3 mb-0"><h6 class="mb-2"><i class="fas fa-hand-holding-usd"></i> Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</h6><table class="table table-sm mb-0">';
          html += '<thead><tr><th>Ø§Ù„Ù‚Ø³Ø·</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th></tr></thead><tbody>';
          
          data.installments.forEach(inst => {
            html += `<tr><td>${inst.installment_number}/${inst.total_installments}</td><td>${inst.amount} â‚ª</td><td>${inst.due_date}</td></tr>`;
          });
          
          html += `</tbody></table><div class="mt-2"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·:</strong> <span class="text-danger">${data.total} â‚ª</span></div></div>`;
          container.html(html);
          
          recalculateNetSalary(data.total);
        } else {
          container.empty();
          recalculateNetSalary(0);
        }
      }
    });
  }
  
  function recalculateNetSalary(installmentsTotal) {
    const baseSalary = parseFloat($('#base_salary').val()) || 0;
    const deductions = {{ employee.total_deductions }};
    const insurance = {{ employee.social_insurance_employee_amount|round(2) }};
    const tax = {{ employee.income_tax_amount|round(2) }};
    
    const netBeforeAdvances = baseSalary - deductions - insurance - tax;
    const finalNet = netBeforeAdvances - installmentsTotal;
    
    $('#total_net_salary').text(finalNet.toFixed(2) + ' â‚ª');
    $('#actual_payment').val(finalNet.toFixed(2));
    $('#actual_payment').trigger('input');
  }
  
  $('select[name="month"], #year_select').on('change', loadAdvanceInstallments);
  $('#base_salary').on('input', function() {
    loadAdvanceInstallments();
  });
  
  loadAdvanceInstallments();
  
  $('#actual_payment').on('input', function() {
    const actualPayment = parseFloat($(this).val()) || 0;
    const percentage = netSalary > 0 ? ((actualPayment / netSalary) * 100).toFixed(1) : 0;
    const remaining = netSalary - actualPayment;
    
    $('#payment_percentage').val(percentage);
    $('#remaining_amount').text(remaining.toFixed(2) + ' â‚ª');
    
    if (remaining > 0.01) {
      $('#remaining_alert').slideDown();
    } else {
      $('#remaining_alert').slideUp();
    }
    
    if (actualPayment > netSalary) {
      $(this).addClass('is-invalid');
      $(this).after('<div class="invalid-feedback d-block">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ!</div>');
    } else {
      $(this).removeClass('is-invalid');
      $(this).next('.invalid-feedback').remove();
    }
  });
  
  function updatePaymentFields() {
    const method = $('#payment_method').val();
    const container = $('#payment_details_container');
    container.empty();
    
    let html = '<div class="row mt-2">';
    
    if (method === 'CHECK') {
      html += `
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-hashtag text-primary"></i> Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</label>
          <input type="text" name="check_number" class="form-control form-control-lg" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ" required>
        </div>
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-university text-primary"></i> Ø§Ù„Ø¨Ù†Ùƒ</label>
          <input type="text" name="check_bank" class="form-control form-control-lg" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ" required>
        </div>
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-calendar-day text-primary"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
          <input type="date" name="check_due_date" class="form-control form-control-lg" value="{{ 'now'|format_datetime('%Y-%m-%d') }}" required>
        </div>
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-user text-primary"></i> Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label>
          <input type="text" name="check_payee" class="form-control form-control-lg" value="{{ employee.name }}" required>
        </div>
      `;
    } else if (method === 'BANK_TRANSFER') {
      html += `
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-university text-success"></i> Ø§Ù„Ø¨Ù†Ùƒ</label>
          <input type="text" name="bank_name" class="form-control form-control-lg" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ">
        </div>
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-hashtag text-success"></i> Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
          <input type="text" name="transfer_reference" class="form-control form-control-lg" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„">
        </div>
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-credit-card text-success"></i> Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <input type="text" name="account_number" class="form-control form-control-lg" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù">
        </div>
        <div class="col-6 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-user text-success"></i> ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <input type="text" name="account_holder" class="form-control form-control-lg" value="{{ employee.name }}">
        </div>
      `;
    } else if (method === 'CASH') {
      html += `
        <div class="col-12 mb-3 payment-detail-field">
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle"></i> <strong>Ø¯ÙØ¹ Ù†Ù‚Ø¯ÙŠ</strong> - ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥ÙŠØµØ§Ù„ Ø§Ø³ØªÙ„Ø§Ù… Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù
          </div>
        </div>
      `;
    } else if (method === 'OTHER') {
      html += `
        <div class="col-12 mb-3 payment-detail-field">
          <label class="font-weight-bold"><i class="fas fa-info-circle text-info"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</label>
          <textarea name="payment_details" class="form-control" rows="2" placeholder="Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹..."></textarea>
        </div>
      `;
    }
    
    html += '</div>';
    container.html(html);
  }
  
  $('#payment_method').on('change', updatePaymentFields);
  updatePaymentFields();
  
  $('#generateSalaryModal form').on('submit', function(e) {
    const actualPayment = parseFloat($('#actual_payment').val()) || 0;
    if (actualPayment > netSalary) {
      e.preventDefault();
      alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ!');
      return false;
    }
    
    const method = $('#payment_method').val();
    if (method === 'CHECK') {
      const checkNumber = $('input[name="check_number"]').val();
      const checkBank = $('input[name="check_bank"]').val();
      if (!checkNumber || !checkBank) {
        e.preventDefault();
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ ÙˆØ§Ù„Ø¨Ù†Ùƒ!');
        return false;
      }
    }
    
    $('#save_salary_btn').addClass('d-none');
    $('#loading_btn').removeClass('d-none');
    $('#cancel_btn').prop('disabled', true);
    
    $('input, select, textarea, button').not('#loading_btn').prop('disabled', true);
  });
  
  const urlParams = new URLSearchParams(window.location.search);
  const receiptId = urlParams.get('receipt_id');
  
  if (receiptId) {
    setTimeout(function() {
      const receiptUrl = '/expenses/salary-receipt/' + receiptId;
      window.open(receiptUrl, '_blank');
      
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }, 800);
  }
});
</script>
{% endblock %}

