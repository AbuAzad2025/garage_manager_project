{% extends "base.html" %}
{% block title %}تسوية مورد {{ ss.supplier.name }} ({{ ss.code }}){% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/statement-print.css') }}">
<style>
.settlement-detail-card {
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.settlement-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.summary-box {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
}

.summary-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #343a40;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<!-- رأس الصفحة للطباعة فقط -->
<div class="print-header-info">
  <div class="company-logo">
    <img src="{{ url_for('static', filename='img/azad_logo.png') }}" alt="Logo">
  </div>
  <div class="company-info">
    <div class="company-name">{{ system_settings.system_name or system_settings.company_name or 'كراج أزاد' }}</div>
    <div class="company-details">
      {% if system_settings.COMPANY_ADDRESS %}📍 {{ system_settings.COMPANY_ADDRESS }}{% endif %}
      {% if system_settings.COMPANY_PHONE %} | 📞 {{ system_settings.COMPANY_PHONE }}{% endif %}<br>
      {% if system_settings.COMPANY_EMAIL %}📧 {{ system_settings.COMPANY_EMAIL }}{% endif %}
      {% if system_settings.TAX_NUMBER %} | رقم ضريبي: {{ system_settings.TAX_NUMBER }}{% endif %}
    </div>
  </div>
  <div class="statement-type">
    <h2>تسوية مورد</h2>
    <div class="statement-date">📅 {{ now()|format_datetime }}</div>
    <div class="user-info">👤 {{ current_user.username if current_user.is_authenticated else 'النظام' }}</div>
  </div>
</div>

<!-- تذييل الصفحة للطباعة فقط -->
<div class="print-footer-info">
  <div class="footer-line">
    <strong>{{ system_settings.system_name or system_settings.company_name or 'كراج أزاد' }}</strong>
  </div>
  <div class="footer-line print-time">
    طُبع بواسطة: {{ current_user.username if current_user.is_authenticated else 'النظام' }} | 
    {{ now()|format_datetime }} | 
    صفحة <span class="page-number"></span>
  </div>
</div>

<div class="content-wrapper">
    <div class="content-header no-print">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-{% if balance_data and balance_data.success %}calculator{% else %}file-invoice-dollar{% endif %}"></i> 
                        {% if balance_data and balance_data.success %}التسوية الذكية{% else %}تسوية مورد{% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('vendors_bp.suppliers_list') }}">الموردين</a></li>
                        <li class="breadcrumb-item active">التسوية</li>
                    </ol>
                </div>
            </div>
            
            <!-- اختيار الفترة الزمنية للتسوية الذكية -->
            {% if balance_data and balance_data.success %}
            <div class="card mb-3">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('supplier_settlements_bp.supplier_settlement', supplier_id=supplier.id) }}" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="date_from" class="form-label"><i class="fas fa-calendar-alt"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ date_from.strftime('%Y-%m-%d') if date_from else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="date_to" class="form-label"><i class="fas fa-calendar-alt"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ date_to.strftime('%Y-%m-%d') if date_to else '' }}">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> تحديث التسوية
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('date_from').value='2024-01-01'; document.getElementById('date_to').value='';">
                                <i class="fas fa-undo"></i> إعادة تعيين
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            
            <!-- معلومات التسوية -->
            <div class="card settlement-detail-card">
                <div class="settlement-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-2"><i class="fas fa-truck"></i> {{ ss.supplier.name }}</h3>
                            <p class="mb-0">
                                <i class="fas fa-barcode"></i> رقم التسوية: <strong>{{ ss.code }}</strong>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            {% set s = (ss.status.value if ss.status and ss.status.value is defined else ss.status) or 'DRAFT' %}
                            <span class="status-badge {% if s == 'DRAFT' %}bg-warning text-dark{% elif s == 'CONFIRMED' %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ s }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-calendar-alt"></i> <strong>الفترة:</strong> 
                        {{ ss.from_date.strftime("%Y-%m-%d") }} → {{ ss.to_date.strftime("%Y-%m-%d") }}
                        {% if not ss.id %}
                        <br><span class="badge bg-warning text-dark"><i class="fas fa-magic"></i> تسوية ذكية تلقائية</span>
                        {% endif %}
                    </div>
                    {% if balance_data and balance_data.currency_note %}
                    <div class="alert alert-primary">
                        <i class="fas fa-exchange-alt"></i> {{ balance_data.currency_note }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- التسوية الذكية: تحذير القطع غير المسعّرة -->
            {% if balance_data and balance_data.has_warnings and balance_data.unpriced_items|length > 0 %}
            <div class="alert alert-warning no-print">
                <h5><i class="fas fa-exclamation-triangle"></i> تنبيه: يوجد {{ balance_data.unpriced_items|length }} قطعة غير مسعّرة</h5>
                <p>يرجى تسعير القطع التالية لضمان دقة الحساب:</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered bg-white">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>SKU</th>
                                <th>الكمية</th>
                                <th>التاريخ</th>
                                <th class="no-print">السعر المقترح</th>
                                <th class="no-print">إجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in balance_data.unpriced_items %}
                            <tr data-tx-id="{{ item.id }}">
                                <td>{{ item.product_name }}</td>
                                <td><code>{{ item.product_sku or '—' }}</code></td>
                                <td>{{ item.quantity }}</td>
                                <td><small>{{ item.date.strftime("%Y-%m-%d") if item.date else '—' }}</small></td>
                                <td class="no-print">
                                    <input type="number" step="0.01" min="0" 
                                           class="form-control form-control-sm" 
                                           style="width: 120px; display: inline-block;"
                                           placeholder="السعر" 
                                           data-tx-id="{{ item.id }}">
                                </td>
                                <td class="no-print">
                                    <button class="btn btn-sm btn-primary update-price-btn" 
                                            data-tx-id="{{ item.id }}">
                                        <i class="fas fa-check"></i> حفظ
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- الملخص المالي -->
            {% if balance_data and balance_data.success %}
            <!-- التسوية الذكية: ملخص مفصل -->
            <div class="row">
                <div class="col-md-4">
                    <div class="summary-box" style="border-left-color: #dc3545;">
                        <div class="summary-label">المدين (له علينا)</div>
                        <div class="summary-value text-danger">{{ "%.2f"|format(balance_data.debit.total) }}</div>
                        <small class="text-muted">₪ شيقل</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-box" style="border-left-color: #28a745;">
                        <div class="summary-label">الدائن (علينا له)</div>
                        <div class="summary-value text-success">{{ "%.2f"|format(balance_data.credit.total) }}</div>
                        <small class="text-muted">₪ شيقل</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-box" style="border-left-color: #007bff; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                        <div class="summary-label">الرصيد النهائي</div>
                        <div class="summary-value {% if balance_data.balance.amount > 0 %}text-danger{% elif balance_data.balance.amount < 0 %}text-success{% else %}text-secondary{% endif %}">
                            {{ "%.2f"|format(balance_data.balance.amount|abs) }}
                        </div>
                        <small class="text-muted">₪ {{ balance_data.balance.direction }}</small>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- التسوية العادية: ملخص بسيط -->
            <div class="row">
                <div class="col-md-4">
                    <div class="summary-box">
                        <div class="summary-label">الإجمالي</div>
                        <div class="summary-value text-primary">{{ (ss.total_gross or 0)|format_currency }}</div>
                        <small class="text-muted">{{ ss.currency }}</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-box" style="border-left-color: #28a745;">
                        <div class="summary-label">المدفوع</div>
                        <div class="summary-value text-success">{{ (ss.total_paid or 0)|format_currency }}</div>
                        <small class="text-muted">{{ ss.currency }}</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-box" style="border-left-color: #dc3545;">
                        <div class="summary-label">المتبقّي</div>
                        <div class="summary-value text-danger">{{ (ss.remaining or 0)|format_currency }}</div>
                        <small class="text-muted">{{ ss.currency }}</small>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- تفاصيل التسوية -->
            {% if balance_data and balance_data.success %}
            <!-- التسوية الذكية: تفاصيل شاملة -->
            
            <!-- القطع الواردة -->
            {% if balance_data.debit.exchange_items.items|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-boxes"></i> القطع الواردة من المورد 
                        <span class="badge bg-light text-dark">{{ balance_data.debit.exchange_items.items|length }}</span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>المنتج</th>
                                    <th>SKU</th>
                                    <th class="text-end">الكمية</th>
                                    <th class="text-end">السعر</th>
                                    <th class="text-end">القيمة (₪)</th>
                                    <th>التاريخ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.debit.exchange_items.items %}
                                <tr {% if not item.is_priced %}class="table-warning"{% endif %}>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        {{ item.product_name }}
                                        {% if item.fallback_used %}
                                        <span class="badge bg-info" title="تم استخدام سعر المنتج الافتراضي">!</span>
                                        {% endif %}
                                    </td>
                                    <td><code>{{ item.product_sku or '—' }}</code></td>
                                    <td class="text-end">{{ item.quantity }}</td>
                                    <td class="text-end">
                                        {% if item.is_priced %}
                                            {{ "%.2f"|format(item.unit_cost) }}
                                        {% else %}
                                            <span class="text-danger">غير مسعر</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.total_value) }}</strong></td>
                                    <td><small>{{ item.date.strftime("%Y-%m-%d") if item.date else '—' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end"><strong>الإجمالي:</strong></td>
                                    <td class="text-end"><strong class="text-danger">{{ "%.2f"|format(balance_data.debit.exchange_items.total_value) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- المبيعات والصيانة -->
            <div class="row">
                {% if balance_data.credit.sales.items|length > 0 %}
                <div class="col-md-6">
                    <div class="card settlement-detail-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-shopping-cart"></i> المبيعات للمورد 
                                <span class="badge bg-light text-dark">{{ balance_data.credit.sales.count }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>الفاتورة</th>
                                            <th>التاريخ</th>
                                            <th class="text-end">المبلغ (₪)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in balance_data.credit.sales.items %}
                                        <tr>
                                            <td>#{{ item.sale_number }}</td>
                                            <td><small>{{ item.date.strftime("%Y-%m-%d") if item.date else '—' }}</small></td>
                                            <td class="text-end">
                                                {{ "%.2f"|format(item.amount_ils) }}
                                                {% if item.currency != 'ILS' %}
                                                <br><small class="text-muted">({{ item.currency }}: {{ "%.2f"|format(item.amount_original) }})</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="2" class="text-end"><strong>المجموع:</strong></td>
                                            <td class="text-end"><strong class="text-success">{{ "%.2f"|format(balance_data.credit.sales.total) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if balance_data.credit.services.items|length > 0 %}
                <div class="col-md-6">
                    <div class="card settlement-detail-card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-wrench"></i> الصيانة للمورد 
                                <span class="badge bg-light text-dark">{{ balance_data.credit.services.count }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>رقم الخدمة</th>
                                            <th>التاريخ</th>
                                            <th class="text-end">المبلغ (₪)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in balance_data.credit.services.items %}
                                        <tr>
                                            <td>#{{ item.service_number }}</td>
                                            <td><small>{{ item.date.strftime("%Y-%m-%d") if item.date else '—' }}</small></td>
                                            <td class="text-end">
                                                {{ "%.2f"|format(item.amount_ils) }}
                                                {% if item.currency != 'ILS' %}
                                                <br><small class="text-muted">({{ item.currency }}: {{ "%.2f"|format(item.amount_original) }})</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="2" class="text-end"><strong>المجموع:</strong></td>
                                            <td class="text-end"><strong class="text-info">{{ "%.2f"|format(balance_data.credit.services.total) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- الدفعات النقدية -->
            {% if balance_data.credit.cash_payments > 0 %}
            <div class="alert alert-secondary">
                <strong><i class="fas fa-money-bill-wave"></i> الدفعات النقدية المباشرة:</strong> 
                {{ "%.2f"|format(balance_data.credit.cash_payments) }} ₪
            </div>
            {% endif %}

            <!-- المرتجعات -->
            {% if balance_data.credit.returns.items|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-undo"></i> المرتجعات للمورد 
                        <span class="badge bg-dark">{{ balance_data.credit.returns.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th class="text-end">الكمية</th>
                                    <th class="text-end">القيمة (₪)</th>
                                    <th>التاريخ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.credit.returns.items %}
                                <tr>
                                    <td>{{ item.product_name }}</td>
                                    <td class="text-end">{{ item.quantity }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.total_value) }}</td>
                                    <td><small>{{ item.date.strftime("%Y-%m-%d") if item.date else '—' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="2" class="text-end"><strong>المجموع:</strong></td>
                                    <td class="text-end"><strong class="text-warning">{{ "%.2f"|format(balance_data.credit.returns.total_value) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- التسويات السابقة -->
            {% if balance_data.previous_settlements|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i> التسويات السابقة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>الرمز</th>
                                    <th>الفترة</th>
                                    <th>الحالة</th>
                                    <th class="text-end">المبلغ</th>
                                    <th>التاريخ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for settlement in balance_data.previous_settlements %}
                                <tr>
                                    <td><code>{{ settlement.code }}</code></td>
                                    <td><small>{{ settlement.from_date.strftime("%Y-%m-%d") if settlement.from_date else '—' }} → {{ settlement.to_date.strftime("%Y-%m-%d") if settlement.to_date else '—' }}</small></td>
                                    <td><span class="badge bg-info">{{ settlement.status }}</span></td>
                                    <td class="text-end">{{ "%.2f"|format(settlement.total_due) }}</td>
                                    <td><small>{{ settlement.date.strftime("%Y-%m-%d %H:%M") if settlement.date else '—' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            {% else %}
            <!-- التسوية العادية: تفاصيل السطور -->
            <div class="card settlement-detail-card">
                <div class="card-header bg-gradient-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-list-ul"></i> تفاصيل السطور ({{ ss.lines|length }})</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th>المصدر</th>
                                    <th>الوصف</th>
                                    <th>المنتج</th>
                                    <th>SKU</th>
                                    <th class="text-end">الكمية</th>
                                    <th class="text-end">السعر</th>
                                    <th class="text-end">القيمة</th>
                                    <th>ملاحظات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for l in ss.lines %}
                                <tr>
                                    <td class="text-center"><strong>{{ loop.index }}</strong></td>
                                    <td><span class="badge badge-info">{{ l.source_type }}#{{ l.source_id }}</span></td>
                                    <td>{{ l.description or "—" }}</td>
                                    <td><strong>{{ l.product.name if l.product else l.product_id }}</strong></td>
                                    <td><code>{{ l.product.sku if l.product and l.product.sku else "—" }}</code></td>
                                    <td class="text-end"><strong>{{ l.quantity is not none and ("%.3f"|format(l.quantity)) or "—" }}</strong></td>
                                    <td class="text-end">{{ l.unit_price is not none and ("%.2f"|format(l.unit_price)) or "—" }}</td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(l.gross_amount or 0) }}</strong></td>
                                    <td><small>{{ l.notes or "—" }}</small></td>
                                </tr>
                                {% else %}
                                <tr><td colspan="9" class="text-center text-muted">لا توجد سطور.</td></tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="7" class="text-end"><strong>الإجمالي:</strong></td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(ss.total_gross or 0) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- تفاصيل المنتجات -->
            <div class="card settlement-detail-card">
                <div class="card-header bg-gradient-info text-white">
                    <h4 class="mb-0"><i class="fas fa-boxes"></i> ملخص المنتجات</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>المنتج</th>
                                    <th>SKU</th>
                                    <th class="text-end">إجمالي الكمية</th>
                                    <th class="text-end">متوسط السعر</th>
                                    <th class="text-end">إجمالي القيمة</th>
                                    <th>المصادر</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set products_summary = {} %}
                                {% for l in ss.lines %}
                                    {% set product_key = l.product.name if l.product else l.product_id|string %}
                                    {% if product_key not in products_summary %}
                                        {% set _ = products_summary.update({product_key: {
                                            'name': l.product.name if l.product else 'غير محدد',
                                            'sku': l.product.sku if l.product and l.product.sku else '—',
                                            'quantity': 0,
                                            'gross_amount': 0,
                                            'sources': []
                                        }}) %}
                                    {% endif %}
                                    {% set _ = products_summary[product_key].update({
                                        'quantity': products_summary[product_key]['quantity'] + (l.quantity or 0),
                                        'gross_amount': products_summary[product_key]['gross_amount'] + (l.gross_amount or 0)
                                    }) %}
                                    {% set source = l.source_type ~ '#' ~ l.source_id %}
                                    {% if source not in products_summary[product_key]['sources'] %}
                                        {% set _ = products_summary[product_key]['sources'].append(source) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for product_name, data in products_summary.items() %}
                                <tr>
                                    <td><strong>{{ data.name }}</strong></td>
                                    <td><code>{{ data.sku }}</code></td>
                                    <td class="text-end"><strong>{{ "%.3f"|format(data.quantity) }}</strong></td>
                                    <td class="text-end">{{ "%.2f"|format(data.gross_amount / data.quantity if data.quantity > 0 else 0) }}</td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(data.gross_amount) }}</strong></td>
                                    <td>
                                        {% for source in data.sources %}
                                            <span class="badge badge-info">{{ source }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="4" class="text-end"><strong>الإجمالي:</strong></td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(ss.total_gross or 0) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- أزرار الإجراءات -->
            {% set status_val = (ss.status.value if ss.status and ss.status.value is defined else ss.status) or 'DRAFT' %}
            {% if status_val == "DRAFT" %}
            <div class="card settlement-detail-card">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-outline-primary btn-lg" id="btn-print">
                        <i class="fas fa-print"></i> طباعة التسوية
                    </button>
                    
                    {% if balance_data and balance_data.success %}
                    <!-- التسوية الذكية: زر دفع/قبض ديناميكي -->
                    {% if balance_data.balance.amount|abs > 0.01 %}
                    <a href="{{ url_for('payments.create_payment',
                                      entity_type='SUPPLIER',
                                      entity_id=ss.supplier.id,
                                      direction=balance_data.balance.payment_direction,
                                      total_amount=('%.2f'|format(balance_data.balance.amount|abs)),
                                      currency='ILS',
                                      reference='SmartSettle-' ~ ss.supplier.id ~ '-' ~ ss.from_date.strftime('%Y%m%d'),
                                      notes='تسوية ذكية - ' ~ ss.supplier.name ~ ' - ' ~ ss.from_date.strftime('%Y-%m-%d') ~ ' إلى ' ~ ss.to_date.strftime('%Y-%m-%d')) }}"
                       class="btn btn-{% if balance_data.balance.payment_direction == 'OUT' %}success{% else %}warning{% endif %} btn-lg">
                        <i class="fas fa-{% if balance_data.balance.payment_direction == 'OUT' %}money-check-alt{% else %}hand-holding-usd{% endif %}"></i> 
                        {{ balance_data.balance.direction }}
                    </a>
                    {% else %}
                    <button class="btn btn-secondary btn-lg" disabled>
                        <i class="fas fa-balance-scale"></i> الحساب متوازن
                    </button>
                    {% endif %}
                    
                    {% elif ss.id %}
                    <!-- التسوية العادية المحفوظة -->
                    <form method="post" action="{{ url_for('supplier_settlements_bp.confirm', settlement_id=ss.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-primary btn-lg">
                            <i class="fas fa-check"></i> تأكيد التسوية
                        </button>
                    </form>
                    
                    <a href="{{ url_for('payments.create_payment',
                                      entity_type='SUPPLIER',
                                      entity_id=ss.supplier.id,
                                      direction=('OUT' if (ss.remaining or 0) > 0 else 'IN'),
                                      total_amount=('%.2f'|format((ss.remaining or 0)|abs)),
                                      currency=ss.currency,
                                      reference='SupplierSettle:' ~ ss.code,
                                      notes='تسوية مورد ' ~ ss.supplier.name ~ ' ' ~ ss.from_date.strftime("%Y-%m-%d") ~ ' - ' ~ ss.to_date.strftime("%Y-%m-%d") ~ ' (' ~ ss.code ~ ')') }}"
                       class="btn btn-success btn-lg">
                        <i class="fas fa-coins"></i> إنشاء دفعة
                    </a>
                    {% endif %}
                    
                    <a href="{{ url_for('vendors_bp.suppliers_list') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-right"></i> العودة
                    </a>
                </div>
            </div>
            {% else %}
            <div class="text-center">
                <a href="{{ url_for('vendors_bp.suppliers_list') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-arrow-right"></i> العودة للموردين
                </a>
            </div>
            {% endif %}

        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  'use strict';
  
  // زر الطباعة
  document.getElementById('btn-print')?.addEventListener('click', function () {
    window.print();
  });
  
  // Ctrl+P للطباعة
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
      e.preventDefault();
      window.print();
    }
  });
  
  // تحديث أسعار القطع غير المسعّرة (للتسوية الذكية)
  document.querySelectorAll('.update-price-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const txId = this.dataset.txId;
      const input = document.querySelector(`input.form-control[data-tx-id="${txId}"]`);
      const newPrice = parseFloat(input.value);
      
      if (isNaN(newPrice) || newPrice < 0) {
        alert('يرجى إدخال سعر صحيح');
        return;
      }
      
      // تأكيد من المستخدم
      if (!confirm(`هل أنت متأكد من تحديث السعر إلى ${newPrice.toFixed(2)} ₪؟`)) {
        return;
      }
      
      // تعطيل الزر أثناء المعالجة
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
      
      try {
        const response = await fetch(`{{ url_for('supplier_settlements_bp.update_exchange_transaction_price', tx_id=0) }}`.replace('/0/', `/${txId}/`), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
          },
          body: JSON.stringify({ unit_cost: newPrice })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✓ تم تحديث السعر بنجاح');
          location.reload();  // إعادة تحميل الصفحة لإظهار التغييرات
        } else {
          alert('خطأ: ' + result.error);
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-check"></i> حفظ';
        }
      } catch (error) {
        alert('حدث خطأ في الاتصال بالخادم');
        console.error(error);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-check"></i> حفظ';
      }
    });
  });
})();
</script>
{% endblock %}
