{% extends "base.html" %}
{% block title %}ØªØ³ÙˆÙŠØ© Ù…ÙˆØ±Ø¯ {{ ss.supplier.name }} ({{ ss.code }}){% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/statement-print.css') }}">
<style>
.settlement-detail-card {
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.settlement-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.summary-box {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
}

.summary-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #343a40;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-header-info">
  <div class="company-logo">
    <img src="{{ url_for('static', filename='img/azad_logo.png') }}" alt="Logo">
  </div>
  <div class="company-info">
    <div class="company-name">{{ system_settings.system_name or system_settings.company_name or 'ÙƒØ±Ø§Ø¬ Ø£Ø²Ø§Ø¯' }}</div>
    <div class="company-details">
      {% if system_settings.COMPANY_ADDRESS %}ğŸ“ {{ system_settings.COMPANY_ADDRESS }}{% endif %}
      {% if system_settings.COMPANY_PHONE %} | ğŸ“ {{ system_settings.COMPANY_PHONE }}{% endif %}<br>
      {% if system_settings.COMPANY_EMAIL %}ğŸ“§ {{ system_settings.COMPANY_EMAIL }}{% endif %}
      {% if system_settings.TAX_NUMBER %} | Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ: {{ system_settings.TAX_NUMBER }}{% endif %}
    </div>
  </div>
  <div class="statement-type">
    <h2>ØªØ³ÙˆÙŠØ© Ù…ÙˆØ±Ø¯</h2>
    <div class="statement-date">ğŸ“… {{ now()|format_datetime }}</div>
    <div class="user-info">ğŸ‘¤ {{ current_user.username if current_user.is_authenticated else 'Ø§Ù„Ù†Ø¸Ø§Ù…' }}</div>
  </div>
</div>

<!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-footer-info">
  <div class="footer-line">
    <strong>{{ system_settings.system_name or system_settings.company_name or 'ÙƒØ±Ø§Ø¬ Ø£Ø²Ø§Ø¯' }}</strong>
  </div>
  <div class="footer-line print-time">
    Ø·ÙØ¨Ø¹ Ø¨ÙˆØ§Ø³Ø·Ø©: {{ current_user.username if current_user.is_authenticated else 'Ø§Ù„Ù†Ø¸Ø§Ù…' }} | 
    {{ now()|format_datetime }} | 
    ØµÙØ­Ø© <span class="page-number"></span>
  </div>
</div>

<div class="content-wrapper">
    <div class="content-header no-print">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-{% if balance_data and balance_data.success %}calculator{% else %}file-invoice-dollar{% endif %}"></i> 
                        {% if balance_data and balance_data.success %}Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©{% else %}ØªØ³ÙˆÙŠØ© Ù…ÙˆØ±Ø¯{% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('vendors_bp.suppliers_list') }}">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</a></li>
                        <li class="breadcrumb-item active">Ø§Ù„ØªØ³ÙˆÙŠØ©</li>
                    </ol>
                </div>
            </div>
            
            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© -->
            {% if balance_data and balance_data.success %}
            <div class="card mb-3">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('supplier_settlements_bp.supplier_settlement', supplier_id=supplier.id) }}" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="date_from" class="form-label"><i class="fas fa-calendar-alt"></i> Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ date_from.strftime('%Y-%m-%d') if date_from else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="date_to" class="form-label"><i class="fas fa-calendar-alt"></i> Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ date_to.strftime('%Y-%m-%d') if date_to else '' }}">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³ÙˆÙŠØ©
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('date_from').value='2024-01-01'; document.getElementById('date_to').value='';">
                                <i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ© -->
            <div class="card settlement-detail-card">
                <div class="settlement-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-2"><i class="fas fa-truck"></i> {{ ss.supplier.name }}</h3>
                            <p class="mb-0">
                                <i class="fas fa-barcode"></i> Ø±Ù‚Ù… Ø§Ù„ØªØ³ÙˆÙŠØ©: <strong>{{ ss.code }}</strong>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            {% set s = (ss.status.value if ss.status and ss.status.value is defined else ss.status) or 'DRAFT' %}
                            <span class="status-badge {% if s == 'DRAFT' %}bg-warning text-dark{% elif s == 'CONFIRMED' %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ s }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-calendar-alt"></i> <strong>Ø§Ù„ÙØªØ±Ø©:</strong> 
                        {{ ss.from_date.strftime("%Y-%m-%d") }} â†’ {{ ss.to_date.strftime("%Y-%m-%d") }}
                        {% if not ss.id %}
                        <br><span class="badge bg-warning text-dark"><i class="fas fa-magic"></i> ØªØ³ÙˆÙŠØ© Ø°ÙƒÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</span>
                        {% endif %}
                    </div>
                    {% if balance_data and balance_data.currency_note %}
                    <div class="alert alert-primary">
                        <i class="fas fa-exchange-alt"></i> {{ balance_data.currency_note }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©: ØªØ­Ø°ÙŠØ± Ø§Ù„Ù‚Ø·Ø¹ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¹Ù‘Ø±Ø© -->
            {% if balance_data and balance_data.has_warnings and balance_data.unpriced_items|length > 0 %}
            <div class="alert alert-danger no-print" style="border-left: 5px solid #dc3545;">
                <h4><i class="fas fa-exclamation-triangle"></i> âš ï¸ ØªØ­Ø°ÙŠØ±: ÙŠÙˆØ¬Ø¯ {{ balance_data.unpriced_items|length }} Ù‚Ø·Ø¹Ø© ØºÙŠØ± Ù…Ø³Ø¹Ù‘Ø±Ø©</h4>
                <p class="mb-3"><strong>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³ÙˆÙŠØ© Ù‚Ø¨Ù„ ØªØ³Ø¹ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹!</strong></p>
                <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸" Ù„ÙƒÙ„ Ù‚Ø·Ø¹Ø©:</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered bg-white">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>SKU</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="no-print">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­</th>
                                <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in balance_data.unpriced_items %}
                            <tr data-tx-id="{{ item.id }}">
                                <td>{{ item.product_name }}</td>
                                <td><code>{{ item.product_sku or 'â€”' }}</code></td>
                                <td>{{ item.quantity }}</td>
                                <td><small>{{ item.date.strftime("%Y-%m-%d") if item.date else 'â€”' }}</small></td>
                                <td class="no-print">
                                    <input type="number" step="0.01" min="0" 
                                           class="form-control form-control-sm" 
                                           style="width: 120px; display: inline-block;"
                                           placeholder="Ø§Ù„Ø³Ø¹Ø±" 
                                           data-tx-id="{{ item.id }}">
                                </td>
                                <td class="no-print">
                                    <button class="btn btn-sm btn-primary update-price-btn" 
                                            data-tx-id="{{ item.id }}">
                                        <i class="fas fa-check"></i> Ø­ÙØ¸
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ -->
            {% if balance_data and balance_data.success %}
            <!-- Ù…Ù„Ø®Øµ Ø¨Ø³ÙŠØ· ÙˆØ§Ø¶Ø­ -->
            <div class="alert alert-info text-center mb-4">
                <h5 class="mb-3">ğŸ“Š Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h5>
                <p class="mb-0" dir="ltr" style="font-size: 1.1rem; font-weight: 600;">
                    <span class="text-success">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ±Ø¯ ({{ "%.2f"|format(balance_data.rights.total) }})</span>
                    <strong> - </strong>
                    <span class="text-danger">Ø§Ù„ØªØ²Ø§Ù…Ø§ØªÙ‡ ({{ "%.2f"|format(balance_data.obligations.total) }})</span>
                    <strong> - </strong>
                    <span class="text-warning">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© ({{ "%.2f"|format(balance_data.payments.total_settled) }})</span>
                    <strong> = </strong>
                    <span class="text-primary">Ø§Ù„Ø±ØµÙŠØ¯ ({{ "%.2f"|format(balance_data.balance.amount) }})</span>
                </p>
            </div>
            
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-box" style="border-left-color: #28a745;">
                        <div class="summary-label">ğŸŸ¢ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ±Ø¯</div>
                        <div class="summary-value text-success">{{ "%.2f"|format(balance_data.rights.total) }}</div>
                        <small class="text-muted">â‚ª Ù…Ø§ Ù„Ù‡ Ø¹Ù„ÙŠÙ†Ø§</small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-box" style="border-left-color: #dc3545;">
                        <div class="summary-label">ğŸ”´ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯</div>
                        <div class="summary-value text-danger">{{ "%.2f"|format(balance_data.obligations.total) }}</div>
                        <small class="text-muted">â‚ª Ù…Ø§ Ø¹Ù„ÙŠÙ‡ Ù„Ù†Ø§</small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-box" style="border-left-color: #ffc107;">
                        <div class="summary-label">ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</div>
                        <div class="summary-value text-warning">{{ "%.2f"|format(balance_data.payments.total_settled) }}</div>
                        <small class="text-muted">â‚ª ØªØ³Ø¯ÙŠØ¯Ø§Øª</small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-box" style="border-left-color: #007bff; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                        <div class="summary-label">ğŸ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                        <div class="summary-value {% if balance_data.balance.amount > 0 %}text-success{% elif balance_data.balance.amount < 0 %}text-danger{% else %}text-secondary{% endif %}">
                            {{ "%.2f"|format(balance_data.balance.amount|abs) }}
                        </div>
                        <small class="text-muted">â‚ª {{ balance_data.balance.direction }}</small>
                    </div>
                </div>
            </div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ© -->
            <!-- Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©: ØªÙØ§ØµÙŠÙ„ Ø´Ø§Ù…Ù„Ø© -->
            
            <!-- Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ -->
            {% if balance_data.rights.exchange_items.get('items', [])|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-boxes"></i> Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ØªØ¨Ø§Ø¯Ù„ (Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ±Ø¯)
                        <span class="badge bg-light text-dark">{{ balance_data.rights.exchange_items.get('items', [])|length }}</span>
                    </h4>
                    <button class="btn btn-sm btn-light no-print" onclick="printTable('exchangeItemsTable', 'Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ØªØ¨Ø§Ø¯Ù„')">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered table-sm" id="exchangeItemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>SKU</th>
                                    <th class="text-end">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="text-end">Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th class="text-end">Ø§Ù„Ù‚ÙŠÙ…Ø© (â‚ª)</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.rights.exchange_items.get('items', []) %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ item.product_name }}</td>
                                    <td><code>{{ item.product_sku or 'â€”' }}</code></td>
                                    <td class="text-end">{{ item.quantity }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.unit_cost) }}</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.total_value) }}</strong></td>
                                    <td><small>{{ item.date }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-success">{{ "%.2f"|format(balance_data.rights.exchange_items.get('total_value_ils', 0)) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© (Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯) -->
            <div class="row">
                {% if balance_data.obligations.sales_to_supplier.get('items', [])|length > 0 %}
                <div class="col-md-6">
                    <div class="card settlement-detail-card">
                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-shopping-cart"></i> Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù‡ (ÙƒØ¹Ù…ÙŠÙ„)
                                <span class="badge bg-light text-dark">{{ balance_data.obligations.sales_to_supplier.get('count', 0) }}</span>
                            </h5>
                            <button class="btn btn-sm btn-light no-print" onclick="printTable('salesTable', 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ù…ÙˆØ±Ø¯')">
                                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="salesTable">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº (â‚ª)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in balance_data.obligations.sales_to_supplier.get('items', []) %}
                                        <tr>
                                            <td>#{{ item.sale_number }}</td>
                                            <td><small>{{ item.date }}</small></td>
                                            <td class="text-end">
                                                {{ "%.2f"|format(item.amount_ils) }}
                                                {% if item.currency != 'ILS' %}
                                                <br><small class="text-muted">({{ item.currency }}: {{ "%.2f"|format(item.amount) }})</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="2" class="text-end"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong></td>
                                            <td class="text-end"><strong class="text-danger">{{ "%.2f"|format(balance_data.obligations.sales_to_supplier.get('total_ils', 0)) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if balance_data.obligations.services_to_supplier.get('items', [])|length > 0 %}
                <div class="col-md-6">
                    <div class="card settlement-detail-card">
                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-wrench"></i> Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù‡ (ÙƒØ¹Ù…ÙŠÙ„)
                                <span class="badge bg-light text-dark">{{ balance_data.obligations.services_to_supplier.get('count', 0) }}</span>
                            </h5>
                            <button class="btn btn-sm btn-light no-print" onclick="printTable('servicesTable', 'Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„Ù…ÙˆØ±Ø¯')">
                                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="servicesTable">
                                    <thead>
                                        <tr>
                                            <th>Ø±Ù‚Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº (â‚ª)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in balance_data.obligations.services_to_supplier.get('items', []) %}
                                        <tr>
                                            <td>#{{ item.service_number }}</td>
                                            <td><small>{{ item.date }}</small></td>
                                            <td class="text-end">
                                                {{ "%.2f"|format(item.amount_ils) }}
                                                {% if item.currency != 'ILS' %}
                                                <br><small class="text-muted">({{ item.currency }}: {{ "%.2f"|format(item.amount) }})</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="2" class="text-end"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong></td>
                                            <td class="text-end"><strong class="text-danger">{{ "%.2f"|format(balance_data.obligations.services_to_supplier.get('total_ils', 0)) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª -->
            <div class="row">
                {% if balance_data.payments.paid_to_supplier.get('items', [])|length > 0 %}
                <div class="col-md-4">
                    <div class="card settlement-detail-card">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡ (OUT)
                                <span class="badge bg-dark">{{ balance_data.payments.paid_to_supplier.get('count', 0) }}</span>
                            </h5>
                            <button class="btn btn-sm btn-light no-print" onclick="printTable('paymentOutTable', 'Ø¯ÙØ¹Ù†Ø§ Ù„Ù„Ù…ÙˆØ±Ø¯')">
                                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="paymentOutTable">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº (â‚ª)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in balance_data.payments.paid_to_supplier.get('items', []) %}
                                        <tr>
                                            <td><small>{{ item.date }}</small></td>
                                            <td class="text-end">{{ "%.2f"|format(item.amount_ils) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td class="text-end"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong></td>
                                            <td class="text-end"><strong class="text-warning">{{ "%.2f"|format(balance_data.payments.total_paid) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if balance_data.payments.received_from_supplier.get('items', [])|length > 0 %}
                <div class="col-md-4">
                    <div class="card settlement-detail-card">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-hand-holding-usd"></i> Ø¯ÙØ¹ Ù„Ù†Ø§ (IN)
                                <span class="badge bg-dark">{{ balance_data.payments.received_from_supplier.get('count', 0) }}</span>
                            </h5>
                            <button class="btn btn-sm btn-light no-print" onclick="printTable('paymentInTable', 'Ø¯ÙØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„Ù†Ø§')">
                                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="paymentInTable">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº (â‚ª)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in balance_data.payments.received_from_supplier.get('items', []) %}
                                        <tr>
                                            <td><small>{{ item.date }}</small></td>
                                            <td class="text-end">{{ "%.2f"|format(item.amount_ils) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td class="text-end"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong></td>
                                            <td class="text-end"><strong class="text-warning">{{ "%.2f"|format(balance_data.payments.total_received) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if balance_data.payments.returns_to_supplier.get('items', [])|length > 0 %}
                <div class="col-md-4">
                    <div class="card settlement-detail-card">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-undo"></i> Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù„Ù‡
                                <span class="badge bg-dark">{{ balance_data.payments.returns_to_supplier.get('count', 0) }}</span>
                            </h5>
                            <button class="btn btn-sm btn-light no-print" onclick="printTable('returnsTable', 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù„Ù„Ù…ÙˆØ±Ø¯')">
                                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="returnsTable">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                            <th class="text-end">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                            <th class="text-end">Ø§Ù„Ù‚ÙŠÙ…Ø© (â‚ª)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in balance_data.payments.returns_to_supplier.get('items', []) %}
                                        <tr>
                                            <td>{{ item.product_name }}</td>
                                            <td class="text-end">{{ item.quantity }}</td>
                                            <td class="text-end">{{ "%.2f"|format(item.total_value) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="2" class="text-end"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong></td>
                                            <td class="text-end"><strong class="text-warning">{{ "%.2f"|format(balance_data.payments.total_returns) }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
            {% if balance_data.previous_settlements|length > 0 %}
            <div class="card settlement-detail-card border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                        <span class="badge bg-light text-dark">{{ balance_data.previous_settlements|length }}</span>
                    </h5>
                    <small class="text-white-50">Ø¹Ø±Ø¶ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù„Ù„Ù…ÙˆØ±Ø¯ Ù‚Ø¨Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</small>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø£Ø¯Ù†Ø§Ù‡ ØªÙ…Øª ÙÙŠ ÙØªØ±Ø§Øª Ø³Ø§Ø¨Ù‚Ø© ÙˆØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ù„ØºÙ‡Ø§ ÙÙŠ Ø­ÙŠÙ†Ù‡. 
                        Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªØ­Ø³Ø¨ ÙÙ‚Ø· Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† <strong>{{ ss.from_date.strftime("%Y-%m-%d") }}</strong> Ø¥Ù„Ù‰ <strong>{{ ss.to_date.strftime("%Y-%m-%d") }}</strong>.
                    </div>
                    
                    <div class="accordion" id="previousSettlementsAccordion">
                        {% for settlement in balance_data.previous_settlements %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-{{ settlement.id }}">
                                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse-{{ settlement.id }}">
                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                        <div>
                                            <strong><i class="fas fa-file-invoice"></i> {{ settlement.code }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                {{ settlement.from_date.strftime("%Y-%m-%d") if settlement.from_date else 'â€”' }} â†’ 
                                                {{ settlement.to_date.strftime("%Y-%m-%d") if settlement.to_date else 'â€”' }}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-{{ 'success' if settlement.status == 'CONFIRMED' else 'warning' }}">
                                                {{ settlement.status }}
                                            </span>
                                            <br>
                                            <strong class="text-primary">{{ "%.2f"|format(settlement.total_due) }} â‚ª</strong>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse-{{ settlement.id }}" 
                                 class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                                 data-bs-parent="#previousSettlementsAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ settlement.date.strftime("%Y-%m-%d %H:%M") if settlement.date else 'â€”' }}</p>
                                            <p><strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚:</strong> <span class="text-primary">{{ "%.2f"|format(settlement.total_due) }} â‚ª</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge bg-info">{{ settlement.status }}</span></p>
                                            {% if settlement.notes %}
                                            <p><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ settlement.notes }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="alert alert-light mt-2 mb-0">
                                        <small>
                                            <i class="fas fa-info-circle"></i> 
                                            Ù‡Ø°Ù‡ Ø§Ù„ØªØ³ÙˆÙŠØ© ØªØºØ·ÙŠ Ø§Ù„ÙØªØ±Ø© Ù…Ù† {{ settlement.from_date.strftime("%d/%m/%Y") }} Ø¥Ù„Ù‰ {{ settlement.to_date.strftime("%d/%m/%Y") }}
                                            ÙˆÙ„Ø§ ØªØ´Ù…Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³ÙˆÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯.
            </div>
            {% endif %}
            
            {% endif %}
            
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
            <div class="card settlement-detail-card no-print">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-outline-primary btn-lg" id="btn-print">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙŠØ©
                    </button>
                    
                    {% if balance_data and balance_data.success %}
                        {% if balance_data.has_unpriced and balance_data.unpriced_items|length > 0 %}
                        <!-- ÙŠÙˆØ¬Ø¯ Ù‚Ø·Ø¹ ØºÙŠØ± Ù…Ø³Ø¹Ù‘Ø±Ø© - Ù†Ø¹Ø·Ù„ Ø²Ø± Ø§Ù„Ø¯ÙØ¹ -->
                        <button class="btn btn-danger btn-lg" disabled title="ÙŠØ¬Ø¨ ØªØ³Ø¹ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹ Ù‚Ø¨Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³ÙˆÙŠØ©">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ÙŠØ¬Ø¨ ØªØ³Ø¹ÙŠØ± {{ balance_data.unpriced_items|length }} Ù‚Ø·Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹
                        </button>
                        {% elif balance_data.balance.amount|abs > 0.01 %}
                        <!-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ ØºÙŠØ± Ù…Ø³Ø¹Ù‘Ø±Ø© - Ø§Ù„Ø²Ø± Ù†Ø´Ø· -->
                        <a href="{{ url_for('payments.create_payment',
                                           entity_type='SUPPLIER',
                                          entity_id=supplier.id,
                                          direction=balance_data.balance.payment_direction,
                                          total_amount=('%.2f'|format(balance_data.balance.amount|abs)),
                                          currency='ILS',
                                          reference='SmartSettle-' ~ supplier.id ~ '-' ~ date_from.strftime('%Y%m%d'),
                                          notes='ØªØ³ÙˆÙŠØ© Ø°ÙƒÙŠØ© - ' ~ supplier.name ~ ' - ' ~ date_from.strftime('%Y-%m-%d') ~ ' Ø¥Ù„Ù‰ ' ~ date_to.strftime('%Y-%m-%d')) }}"
                           class="btn btn-{% if balance_data.balance.payment_direction == 'OUT' %}success{% else %}warning{% endif %} btn-lg">
                            <i class="fas fa-{% if balance_data.balance.payment_direction == 'OUT' %}money-check-alt{% else %}hand-holding-usd{% endif %}"></i> 
                            {{ balance_data.balance.action }} - {{ "%.2f"|format(balance_data.balance.amount|abs) }} â‚ª
                        </a>
                        {% else %}
                        <button class="btn btn-secondary btn-lg" disabled>
                            <i class="fas fa-balance-scale"></i> Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ§Ø²Ù†
                        </button>
                        {% endif %}
                    {% endif %}
                    
                    <a href="{{ url_for('vendors_bp.suppliers_list') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </a>
                </div>
            </div>

        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  'use strict';
  
  // Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  document.getElementById('btn-print')?.addEventListener('click', function () {
    window.print();
  });
  
  // Ctrl+P Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
      e.preventDefault();
      window.print();
    }
  });
  
  // DataTables Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø©
  {% if balance_data and balance_data.get('success') and balance_data.get('rights') and balance_data.rights.exchange_items.get('items', [])|length > 10 %}
  $('#exchangeItemsTable').DataTable({
    language: {
      url: '{{ url_for("static", filename="datatables/Arabic.json") }}'
    },
    pageLength: 25,
    order: [[6, 'desc']],  // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    dom: 'frtip',
    searching: true,
    paging: true,
    info: true
  });
  {% endif %}
  
  // Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø¯Ø¯
  window.printTable = function(tableId, title) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>' + title + '</title>');
    printWindow.document.write('<style>');
    printWindow.document.write('body { font-family: Arial, sans-serif; direction: rtl; }');
    printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 20px 0; }');
    printWindow.document.write('th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }');
    printWindow.document.write('th { background-color: #f8f9fa; font-weight: bold; }');
    printWindow.document.write('.text-end { text-align: left; }');
    printWindow.document.write('h2 { text-align: center; color: #333; margin-bottom: 20px; }');
    printWindow.document.write('.print-header { text-align: center; margin-bottom: 20px; }');
    printWindow.document.write('.print-footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }');
    printWindow.document.write('@media print { .no-print { display: none; } }');
    printWindow.document.write('</style></head><body>');
    printWindow.document.write('<div class="print-header">');
    printWindow.document.write('<h2>' + title + '</h2>');
    printWindow.document.write('<p>{{ supplier.name }} | {{ ss.from_date.strftime("%Y-%m-%d") }} - {{ ss.to_date.strftime("%Y-%m-%d") }}</p>');
    printWindow.document.write('</div>');
    printWindow.document.write(table.outerHTML);
    printWindow.document.write('<div class="print-footer">');
    printWindow.document.write('<p>Ø·ÙØ¨Ø¹ Ø¨ØªØ§Ø±ÙŠØ®: ' + new Date().toLocaleString('ar-EG') + '</p>');
    printWindow.document.write('</div>');
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù‚Ø·Ø¹ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¹Ù‘Ø±Ø© (Ù„Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©)
  let unpricedCount = {{ balance_data.unpriced_items|length if balance_data and balance_data.unpriced_items else 0 }};
  
  function updateUnpricedCounter() {
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø·Ø¹ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¹Ù‘Ø±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    const counterElements = document.querySelectorAll('.unpriced-counter');
    counterElements.forEach(el => {
      el.textContent = unpricedCount;
    });
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¨Ù‚Ù‰ Ù‚Ø·Ø¹ ØºÙŠØ± Ù…Ø³Ø¹Ù‘Ø±Ø©ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    if (unpricedCount === 0) {
      setTimeout(() => {
        alert('âœ“ ØªÙ… ØªØ³Ø¹ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø¢Ù†...');
        location.reload();
      }, 500);
    }
  }
  
  document.querySelectorAll('.update-price-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const txId = this.dataset.txId;
      const input = document.querySelector(`input.form-control[data-tx-id="${txId}"]`);
      const newPrice = parseFloat(input.value);
      
      if (isNaN(newPrice) || newPrice < 0) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­ (Ø±Ù‚Ù… >= 0)');
        input.focus();
        return;
      }
      
      if (newPrice === 0) {
        if (!confirm('âš ï¸ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¯Ø®Ù„ Ù‡Ùˆ ØµÙØ±. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
          return;
        }
      }
      
      // ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (!confirm(`âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¹ÙŠØ±\n\nØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newPrice.toFixed(2)} â‚ª\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) {
        return;
      }
      
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
      const originalHTML = this.innerHTML;
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      input.disabled = true;
      
      try {
        const response = await fetch(`{{ url_for('supplier_settlements_bp.update_exchange_transaction_price', tx_id=0) }}`.replace('/0/', `/${txId}/`), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
          },
          body: JSON.stringify({ unit_cost: newPrice })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Ù†Ø¬Ø­ Ø§Ù„Ø­ÙØ¸ - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø·Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
          const row = this.closest('tr');
          row.style.backgroundColor = '#d4edda';
          row.style.transition = 'all 0.5s ease';
          
          setTimeout(() => {
            row.style.opacity = '0';
            setTimeout(() => {
              row.remove();
              unpricedCount--;
              updateUnpricedCounter();
            }, 300);
          }, 800);
          
        } else {
          alert('âŒ Ø®Ø·Ø£: ' + result.error);
          this.disabled = false;
          this.innerHTML = originalHTML;
          input.disabled = false;
        }
      } catch (error) {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        console.error(error);
        this.disabled = false;
        this.innerHTML = originalHTML;
        input.disabled = false;
      }
    });
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±
    const input = document.querySelector(`input.form-control[data-tx-id="${btn.dataset.txId}"]`);
    if (input) {
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          btn.click();
        }
      });
    }
  });
})();
</script>
{% endblock %}
