{% extends "layout.html" %}
{% block title %}تسوية مورد {{ ss.supplier.name }} ({{ ss.code }}){% endblock %}

{% block content %}
<div class="container" dir="rtl">
  <h3>تسوية مورد: {{ ss.supplier.name }} <small class="text-muted">({{ ss.code }})</small></h3>

  <div class="mb-2 text-muted">
    الفترة: {{ ss.from_date.strftime("%Y-%m-%d") }} → {{ ss.to_date.strftime("%Y-%m-%d") }}
    |
    {% set s = (getattr(ss.status, 'value', ss.status) or '') %}
    {% set badge = 'bg-secondary' %}
    {% if s == 'DRAFT' %}{% set badge = 'bg-warning text-dark' %}{% elif s == 'CONFIRMED' %}{% set badge = 'bg-success' %}{% endif %}
    الحالة:
    <span class="badge {{ badge }}">{{ s }}</span>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>المصدر</th>
          <th>الوصف</th>
          <th>المنتج</th>
          <th class="text-end">الكمية</th>
          <th class="text-end">سعر</th>
          <th class="text-end">القيمة</th>
        </tr>
      </thead>
      <tbody>
        {% for l in ss.lines %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ l.source_type }}#{{ l.source_id }}</td>
          <td>{{ l.description or "—" }}</td>
          <td>{{ l.product.name if l.product else l.product_id }}</td>
          <td class="text-end">{{ l.quantity is not none and ("%.3f"|format(l.quantity)) or "—" }}</td>
          <td class="text-end">{{ l.unit_price is not none and ("%.2f"|format(l.unit_price)) or "—" }}</td>
          <td class="text-end fw-bold">{{ "%.2f"|format(l.gross_amount or 0) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center text-muted">لا توجد سطور.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card"><div class="card-body">
        <div class="small text-muted">الإجمالي</div>
        <div class="fs-5">{{ (ss.total_gross or 0)|format_currency }} {{ ss.currency }}</div>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card"><div class="card-body">
        <div class="small text-muted">المدفوع</div>
        <div class="fs-5">{{ (ss.total_paid or 0)|format_currency }} {{ ss.currency }}</div>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card"><div class="card-body">
        <div class="small text-muted">المتبقّي</div>
        <div class="fs-5">{{ (ss.remaining or 0)|format_currency }} {{ ss.currency }}</div>
      </div></div>
    </div>
  </div>

  {% set status_val = getattr(ss.status, 'value', ss.status) %}
  {% if status_val == "DRAFT" %}
  <form method="post" action="{{ url_for('supplier_settlements_bp.confirm', settlement_id=ss.id) }}" class="mt-3 d-flex gap-2">
    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
    <button class="btn btn-primary"><i class="fas fa-check me-1"></i> تأكيد التسوية</button>
    <a
      href="{{ url_for(
              'payments.create_payment',
              entity_type='SUPPLIER',
              entity_id=ss.supplier.id,
              direction=('OUT' if (ss.remaining or 0) > 0 else 'IN'),
              total_amount=('%.2f'|format((ss.remaining or 0)|abs)),
              currency=ss.currency,
              reference='SupplierSettle:' ~ ss.code,
              notes='تسوية مورد ' ~ ss.supplier.name ~ ' ' ~ ss.from_date.strftime("%Y-%m-%d") ~ ' - ' ~ ss.to_date.strftime("%Y-%m-%d") ~ ' (' ~ ss.code ~ ')'
           ) }}"
      class="btn btn-success">
      <i class="fas fa-coins me-1"></i> إنشاء دفعة
    </a>
  </form>
  {% endif %}
</div>
{% endblock %}
