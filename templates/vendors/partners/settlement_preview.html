{% extends "layout.html" %}
{% block title %}تسوية شريك {{ ps.partner.name }} ({{ ps.code }}){% endblock %}
{% block content %}
<div class="container" dir="rtl">
  <h3>تسوية شريك: {{ ps.partner.name }} <small class="text-muted">({{ ps.code }})</small></h3>
  <div class="mb-2 text-muted">
    الفترة: {{ ps.from_date.strftime("%Y-%m-%d") }} → {{ ps.to_date.strftime("%Y-%m-%d") }} |
    الحالة: <span class="badge bg-info">{{ ps.status }}</span>
  </div>

  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>#</th><th>المصدر</th><th>الوصف</th><th>المنتج</th><th>المخزن</th>
        <th class="text-end">الكمية</th><th class="text-end">سعر</th><th class="text-end">إجمالي</th>
        <th class="text-end">% الشريك</th><th class="text-end">حصة الشريك</th>
      </tr>
    </thead>
    <tbody>
      {% for i, l in enumerate(ps.lines, start=1) %}
      <tr>
        <td>{{ i }}</td>
        <td>{{ l.source_type }}#{{ l.source_id }}</td>
        <td>{{ l.description or "—" }}</td>
        <td>{{ l.product.name if l.product else l.product_id }}</td>
        <td>{{ l.warehouse.name if l.warehouse else l.warehouse_id }}</td>
        <td class="text-end">{{ "%.3f"|format(l.quantity or 0) if l.quantity is not none else "—" }}</td>
        <td class="text-end">{{ "%.2f"|format(l.unit_price or 0) if l.unit_price is not none else "—" }}</td>
        <td class="text-end">{{ "%.2f"|format(l.gross_amount or 0) }}</td>
        <td class="text-end">{{ "%.2f"|format(l.share_percent or 0) }}%</td>
        <td class="text-end fw-bold">{{ "%.2f"|format(l.share_amount or 0) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="row g-3">
    <div class="col-md-3"><div class="card"><div class="card-body">
      <div class="small text-muted">إجمالي الأساس</div>
      <div class="fs-5">{{ "%.2f"|format(ps.total_gross or 0) }} {{ ps.currency }}</div>
    </div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body">
      <div class="small text-muted">حصة الشريك</div>
      <div class="fs-5">{{ "%.2f"|format(ps.total_share or 0) }} {{ ps.currency }}</div>
    </div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body">
      <div class="small text-muted">تحميلات/تكاليف</div>
      <div class="fs-5">{{ "%.2f"|format(ps.total_costs or 0) }} {{ ps.currency }}</div>
    </div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body">
      <div class="small text-muted">الصافي المستحق</div>
      <div class="fs-5">{{ "%.2f"|format(ps.total_due or 0) }} {{ ps.currency }}</div>
      <div class="small text-muted">مدفوع: {{ "%.2f"|format(ps.total_paid or 0) }} | متبقّي: {{ "%.2f"|format(ps.remaining or 0) }}</div>
    </div></div></div>
  </div>

  {% if ps.status == "DRAFT" %}
  <form method="post" action="{{ url_for('partner_settlements_bp.confirm', settlement_id=ps.id) }}" class="mt-3 d-flex gap-2">
    <button class="btn btn-primary"><i class="fas fa-check me-1"></i> تأكيد التسوية</button>
    <a
      href="{{ url_for('payments.create_payment',
                       entity_type='PARTNER',
                       entity_id=ps.partner.id,
                       direction=('OUT' if (ps.total_due or 0) > 0 else 'IN'),
                       total_amount=('%.2f'|format(ps.total_due|default(0)|abs)),
                       currency=ps.currency,
                       reference='PartnerSettle:' ~ ps.code) }}"
      class="btn btn-success">
      <i class="fas fa-coins me-1"></i> إنشاء دفعة
    </a>
  </form>
  {% endif %}
</div>
{% endblock %}
