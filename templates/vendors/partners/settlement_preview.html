{% extends "base.html" %}
{% block title %}ØªØ³ÙˆÙŠØ© Ø´Ø±ÙŠÙƒ {{ ps.partner.name }} ({{ ps.code }}){% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/statement-print.css') }}">
<style>
.settlement-detail-card {
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.settlement-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.summary-box {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
}

.summary-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #343a40;
}

.line-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    transition: all 0.2s;
}

.line-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateX(-3px);
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-header-info">
  <div class="company-logo">
    <img src="{{ url_for('static', filename='img/azad_logo.png') }}" alt="Logo">
  </div>
  <div class="company-info">
    <div class="company-name">{{ system_settings.company_name or 'Azad Garage' }}</div>
    <div class="company-details">
      {% if system_settings.COMPANY_ADDRESS %}ğŸ“ {{ system_settings.COMPANY_ADDRESS }}<br>{% endif %}
      {% if system_settings.COMPANY_PHONE %}ğŸ“ {{ system_settings.COMPANY_PHONE }}{% endif %}
      {% if system_settings.COMPANY_EMAIL %} | ğŸ“§ {{ system_settings.COMPANY_EMAIL }}{% endif %}
      {% if system_settings.TAX_NUMBER %}<br>Ø¶Ø±ÙŠØ¨Ø©: {{ system_settings.TAX_NUMBER }}{% endif %}
    </div>
  </div>
  <div class="statement-type">
    <h2>ØªØ³ÙˆÙŠØ© Ø´Ø±ÙŠÙƒ</h2>
    <div class="statement-date">{{ now()|format_date }}</div>
  </div>
</div>

<!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-footer-info">
  <div class="footer-line">
    <strong>{{ system_settings.company_name or 'Azad Garage' }}</strong> | 
    ØµÙØ­Ø© <span class="page-number"></span>
  </div>
  <div class="footer-line" style="font-size: 7pt;">
    Ø·ÙØ¨Ø¹ Ø¨ØªØ§Ø±ÙŠØ®: {{ now()|format_datetime }} | Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ±Ø§Ø¬ - Garage Manager System
  </div>
</div>

<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0"><i class="fas fa-file-invoice-dollar"></i> ØªØ³ÙˆÙŠØ© Ø´Ø±ÙŠÙƒ</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('vendors_bp.partners_list') }}">Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</a></li>
                        <li class="breadcrumb-item active">Ø§Ù„ØªØ³ÙˆÙŠØ©</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ© -->
            <div class="card settlement-detail-card">
                <div class="settlement-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-2"><i class="fas fa-user-tie"></i> {{ ps.partner.name }}</h3>
                            <p class="mb-0">
                                <i class="fas fa-barcode"></i> Ø±Ù‚Ù… Ø§Ù„ØªØ³ÙˆÙŠØ©: <strong>{{ ps.code }}</strong>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="status-badge {% if ps.status == 'DRAFT' %}bg-warning text-dark{% elif ps.status == 'CONFIRMED' %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ ps.status }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-calendar-alt"></i> <strong>Ø§Ù„ÙØªØ±Ø©:</strong> 
                        {{ ps.from_date.strftime("%Y-%m-%d") }} â†’ {{ ps.to_date.strftime("%Y-%m-%d") }}
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ -->
            <div class="row">
                <div class="col-md-3">
                    <div class="summary-box">
                        <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³</div>
                        <div class="summary-value text-primary">{{ "%.2f"|format(ps.total_gross or 0) }}</div>
                        <small class="text-muted">{{ ps.currency }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-box" style="border-left-color: #28a745;">
                        <div class="summary-label">Ø­ØµØ© Ø§Ù„Ø´Ø±ÙŠÙƒ</div>
                        <div class="summary-value text-success">{{ "%.2f"|format(ps.total_share or 0) }}</div>
                        <small class="text-muted">{{ ps.currency }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-box" style="border-left-color: #ffc107;">
                        <div class="summary-label">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</div>
                        <div class="summary-value text-warning">{{ "%.2f"|format(ps.total_costs or 0) }}</div>
                        <small class="text-muted">{{ ps.currency }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-box" style="border-left-color: #dc3545;">
                        <div class="summary-label">Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚</div>
                        <div class="summary-value text-danger">{{ "%.2f"|format(ps.total_due or 0) }}</div>
                        <small class="text-muted">Ù…Ø¯ÙÙˆØ¹: {{ "%.2f"|format(ps.total_paid or 0) }} | Ù…ØªØ¨Ù‚Ù‘ÙŠ: {{ "%.2f"|format(ps.remaining or 0) }}</small>
                    </div>
                </div>
            </div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø·ÙˆØ± -->
            <div class="card settlement-detail-card">
                <div class="card-header bg-gradient-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-list-ul"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø·ÙˆØ± ({{ ps.lines|length }})</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>SKU</th>
                                    <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
                                    <th class="text-end">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="text-end">Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th class="text-end">% Ø§Ù„Ø´Ø±ÙŠÙƒ</th>
                                    <th class="text-end">Ø­ØµØ© Ø§Ù„Ø´Ø±ÙŠÙƒ</th>
                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for l in ps.lines %}
                                <tr>
                                    <td class="text-center"><strong>{{ loop.index }}</strong></td>
                                    <td><span class="badge badge-info">{{ l.source_type }}#{{ l.source_id }}</span></td>
                                    <td>{{ l.description or "â€”" }}</td>
                                    <td><strong>{{ l.product.name if l.product else l.product_id }}</strong></td>
                                    <td><code>{{ l.product.sku if l.product and l.product.sku else "â€”" }}</code></td>
                                    <td>{{ l.warehouse.name if l.warehouse else l.warehouse_id }}</td>
                                    <td class="text-end"><strong>{{ "%.3f"|format(l.quantity or 0) if l.quantity is not none else "â€”" }}</strong></td>
                                    <td class="text-end">{{ "%.2f"|format(l.unit_price or 0) if l.unit_price is not none else "â€”" }}</td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(l.gross_amount or 0) }}</strong></td>
                                    <td class="text-end"><span class="badge badge-success">{{ "%.2f"|format(l.share_percent or 0) }}%</span></td>
                                    <td class="text-end"><strong class="text-success">{{ "%.2f"|format(l.share_amount or 0) }}</strong></td>
                                    <td><small>{{ l.notes or "â€”" }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="8" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª:</strong></td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(ps.total_gross or 0) }}</strong></td>
                                    <td></td>
                                    <td class="text-end"><strong class="text-success">{{ "%.2f"|format(ps.total_share or 0) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù†Ø³Ø¨ -->
            <div class="card settlement-detail-card">
                <div class="card-header bg-gradient-info text-white">
                    <h4 class="mb-0"><i class="fas fa-boxes"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù†Ø³Ø¨</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>SKU</th>
                                    <th class="text-end">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="text-end">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                    <th class="text-end">Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ</th>
                                    <th class="text-end">Ø­ØµØ© Ø§Ù„Ø´Ø±ÙŠÙƒ</th>
                                    <th>Ø§Ù„Ù…Ø®Ø§Ø²Ù†</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set products_summary = {} %}
                                {% for l in ps.lines %}
                                    {% set product_key = l.product.name if l.product else l.product_id|string %}
                                    {% if product_key not in products_summary %}
                                        {% set _ = products_summary.update({product_key: {
                                            'name': l.product.name if l.product else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                                            'sku': l.product.sku if l.product and l.product.sku else 'â€”',
                                            'quantity': 0,
                                            'gross_amount': 0,
                                            'share_amount': 0,
                                            'share_percent': l.share_percent or 0,
                                            'warehouses': []
                                        }}) %}
                                    {% endif %}
                                    {% set _ = products_summary[product_key].update({
                                        'quantity': products_summary[product_key]['quantity'] + (l.quantity or 0),
                                        'gross_amount': products_summary[product_key]['gross_amount'] + (l.gross_amount or 0),
                                        'share_amount': products_summary[product_key]['share_amount'] + (l.share_amount or 0)
                                    }) %}
                                    {% if l.warehouse and l.warehouse.name not in products_summary[product_key]['warehouses'] %}
                                        {% set _ = products_summary[product_key]['warehouses'].append(l.warehouse.name) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for product_name, data in products_summary.items() %}
                                <tr>
                                    <td><strong>{{ data.name }}</strong></td>
                                    <td><code>{{ data.sku }}</code></td>
                                    <td class="text-end"><strong>{{ "%.3f"|format(data.quantity) }}</strong></td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(data.gross_amount) }}</strong></td>
                                    <td class="text-end"><span class="badge badge-success">{{ "%.2f"|format(data.share_percent) }}%</span></td>
                                    <td class="text-end"><strong class="text-success">{{ "%.2f"|format(data.share_amount) }}</strong></td>
                                    <td>
                                        {% for warehouse in data.warehouses %}
                                            <span class="badge badge-secondary">{{ warehouse }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª:</strong></td>
                                    <td class="text-end"><strong class="text-primary">{{ "%.2f"|format(ps.total_gross or 0) }}</strong></td>
                                    <td></td>
                                    <td class="text-end"><strong class="text-success">{{ "%.2f"|format(ps.total_share or 0) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
            {% if ps.status == "DRAFT" %}
            <div class="card settlement-detail-card">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-outline-primary btn-lg" id="btn-print">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙŠØ©
                    </button>
                    
                    {% if ps.id %}
                    <!-- Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
                    <form method="post" action="{{ url_for('partner_settlements_bp.confirm', settlement_id=ps.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-primary btn-lg">
                            <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³ÙˆÙŠØ©
                        </button>
                    </form>
                    {% else %}
                    <!-- ØªØ³ÙˆÙŠØ© Ø°ÙƒÙŠØ© (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©) - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø± ØªØ£ÙƒÙŠØ¯ -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Ù‡Ø°Ù‡ ØªØ³ÙˆÙŠØ© Ø°ÙƒÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.
                    </div>
                    {% endif %}
                    
                    <a href="{{ url_for('payments.create_payment',
                                       entity_type='PARTNER',
                                       entity_id=ps.partner.id,
                                       direction=('OUT' if (ps.total_due or 0) > 0 else 'IN'),
                                       total_amount=('%.2f'|format(ps.total_due|default(0)|abs)),
                                       currency=ps.currency,
                                       reference='PartnerSettle:' ~ ps.code) }}"
                       class="btn btn-success btn-lg">
                        <i class="fas fa-coins"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø©
                    </a>
                    
                    <a href="{{ url_for('vendors_bp.partners_list') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </a>
                </div>
            </div>
            {% else %}
            <div class="text-center">
                <a href="{{ url_for('vendors_bp.partners_list') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø±ÙƒØ§Ø¡
                </a>
            </div>
            {% endif %}

        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.getElementById('btn-print')?.addEventListener('click', function () {
    window.print();
  });
</script>
{% endblock %}
