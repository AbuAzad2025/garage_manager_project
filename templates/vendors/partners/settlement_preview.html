{% extends "base.html" %}
{% block title %}{% if balance_data and balance_data.success %}Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©{% else %}ØªØ³ÙˆÙŠØ© Ø´Ø±ÙŠÙƒ{% endif %} - {{ partner.name }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/statement-print.css') }}">
<style>
.settlement-detail-card {
    border-radius: 12px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
}

.settlement-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 25px;
}

.balance-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.balance-box {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    text-align: center;
}

.balance-box.share {
    border-left: 4px solid #28a745;
}

.balance-box.paid {
    border-left: 4px solid #dc3545;
}

.balance-box.final {
    border-left: 4px solid #007bff;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.balance-label {
    font-size: 0.9rem;
    color: #6c757d;
    font-weight: 600;
    margin-bottom: 8px;
}

.balance-amount {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.detail-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}

.currency-note {
    background: #e3f2fd;
    border-left: 4px solid #2196F3;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.9rem;
    color: #0d47a1;
}

.summary-box {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
}

.summary-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #343a40;
}
</style>
{% endblock %}

{% block content %}
<!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-header-info">
  <div class="company-logo">
    <img src="{{ url_for('static', filename='img/azad_logo.png') }}" alt="Logo">
  </div>
  <div class="company-info">
    <div class="company-name">{{ system_settings.system_name or system_settings.company_name or 'ÙƒØ±Ø§Ø¬ Ø£Ø²Ø§Ø¯' }}</div>
    <div class="company-details">
      {% if system_settings.COMPANY_ADDRESS %}ğŸ“ {{ system_settings.COMPANY_ADDRESS }}{% endif %}
      {% if system_settings.COMPANY_PHONE %} | ğŸ“ {{ system_settings.COMPANY_PHONE }}{% endif %}<br>
      {% if system_settings.COMPANY_EMAIL %}ğŸ“§ {{ system_settings.COMPANY_EMAIL }}{% endif %}
      {% if system_settings.TAX_NUMBER %} | Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ: {{ system_settings.TAX_NUMBER }}{% endif %}
    </div>
  </div>
  <div class="statement-type">
    <h2>{% if balance_data and balance_data.success %}Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© - Ø´Ø±ÙŠÙƒ{% else %}ØªØ³ÙˆÙŠØ© Ø´Ø±ÙŠÙƒ{% endif %}</h2>
    <div class="statement-date">ğŸ“… {{ now()|format_datetime }}</div>
    <div class="user-info">ğŸ‘¤ {{ current_user.username if current_user.is_authenticated else 'Ø§Ù„Ù†Ø¸Ø§Ù…' }}</div>
  </div>
</div>

<!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-footer-info">
  <div class="footer-line">
    <strong>{{ system_settings.system_name or system_settings.company_name or 'ÙƒØ±Ø§Ø¬ Ø£Ø²Ø§Ø¯' }}</strong>
  </div>
  <div class="footer-line print-time">
    Ø·ÙØ¨Ø¹ Ø¨ÙˆØ§Ø³Ø·Ø©: {{ current_user.username if current_user.is_authenticated else 'Ø§Ù„Ù†Ø¸Ø§Ù…' }} | 
    {{ now()|format_datetime }} | 
    ØµÙØ­Ø© <span class="page-number"></span>
  </div>
</div>

<div class="content-wrapper">
    <div class="content-header no-print">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-{% if balance_data and balance_data.success %}calculator{% else %}file-invoice-dollar{% endif %}"></i> 
                        {% if balance_data and balance_data.success %}Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©{% else %}ØªØ³ÙˆÙŠØ© Ø´Ø±ÙŠÙƒ{% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('vendors_bp.partners_list') }}">Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</a></li>
                        <li class="breadcrumb-item active">Ø§Ù„ØªØ³ÙˆÙŠØ©</li>
                    </ol>
                </div>
            </div>
            
            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© -->
            {% if balance_data and balance_data.success %}
            <div class="card mb-3">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('partner_settlements_bp.partner_settlement', partner_id=partner.id) }}" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="date_from" class="form-label"><i class="fas fa-calendar-alt"></i> Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ date_from.strftime('%Y-%m-%d') if date_from else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="date_to" class="form-label"><i class="fas fa-calendar-alt"></i> Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ date_to.strftime('%Y-%m-%d') if date_to else '' }}">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³ÙˆÙŠØ©
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('date_from').value='2024-01-01'; document.getElementById('date_to').value='';">
                                <i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            
            {% if balance_data and balance_data.success %}
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ -->
            <div class="card settlement-detail-card">
                <div class="settlement-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-2"><i class="fas fa-handshake"></i> {{ partner.name }}</h3>
                            <p class="mb-1">
                                <i class="fas fa-calendar-alt"></i> <strong>Ø§Ù„ÙØªØ±Ø©:</strong> 
                                {{ date_from.strftime("%Y-%m-%d") }} â†’ {{ date_to.strftime("%Y-%m-%d") }}
                            </p>
                            <p class="mb-0">
                                <small>Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±Ø§ÙƒØ©: {{ balance_data.partner.share_percentage }}% | Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©: {{ balance_data.partner.currency }}</small>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-warning text-dark" style="font-size: 1rem; padding: 10px 20px;">
                                <i class="fas fa-magic"></i> Ø°ÙƒÙŠØ©
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¹Ù…Ù„Ø§Øª -->
            {% if balance_data.currency_note %}
            <div class="currency-note mb-3">
                <i class="fas fa-exchange-alt"></i> {{ balance_data.currency_note }}
            </div>
            {% endif %}

            <!-- Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ -->
            <div class="balance-summary">
            <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="balance-box share">
                            <div class="balance-label">ğŸŸ¢ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠÙƒ</div>
                            <div class="balance-amount text-success">
                                {{ "%.2f"|format(balance_data.rights.total) }}
                            </div>
                            <small class="text-muted">â‚ª Ù…Ø®Ø²ÙˆÙ† + Ù…Ø¨ÙŠØ¹Ø§Øª</small>
                    </div>
                </div>
                    <div class="col-md-3 mb-3">
                        <div class="balance-box paid">
                            <div class="balance-label">ğŸ”´ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªÙ‡</div>
                            <div class="balance-amount text-danger">
                                {{ "%.2f"|format(balance_data.obligations.total) }}
                            </div>
                            <small class="text-muted">â‚ª Ù…Ø´ØªØ±ÙŠØ§ØªÙ‡ + ØµÙŠØ§Ù†ØªÙ‡</small>
                    </div>
                </div>
                    <div class="col-md-3 mb-3">
                        <div class="balance-box" style="border-left: 4px solid #ffc107;">
                            <div class="balance-label">ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</div>
                            <div class="balance-amount text-warning">
                                {{ "%.2f"|format(balance_data.payments.total_settled) }}
                            </div>
                            <small class="text-muted">â‚ª Ø¯ÙØ¹Ù†Ø§: {{ "%.0f"|format(balance_data.payments.total_paid) }} | Ø¯ÙØ¹: {{ "%.0f"|format(balance_data.payments.total_received) }}</small>
                    </div>
                </div>
                    <div class="col-md-3 mb-3">
                        <div class="balance-box final">
                            <div class="balance-label">ğŸ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                            <div class="balance-amount {% if balance_data.balance.amount > 0 %}text-success{% elif balance_data.balance.amount < 0 %}text-danger{% else %}text-secondary{% endif %}">
                                {{ "%.2f"|format(balance_data.balance.amount|abs) }}
                    </div>
                            <small class="text-muted">â‚ª {{ balance_data.balance.action }}</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ø´Ø±Ø­ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
            <div class="alert alert-info" style="background: #e3f2fd; border-left: 4px solid #2196F3;">
                <strong><i class="fas fa-calculator"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</strong><br>
                <code style="font-size: 1.1rem; background: white; padding: 10px; display: inline-block; border-radius: 5px; margin-top: 8px;">
                    Ø­Ù‚ÙˆÙ‚Ù‡ ({{ "%.2f"|format(balance_data.rights.total) }}) 
                    - Ø§Ù„ØªØ²Ø§Ù…Ø§ØªÙ‡ ({{ "%.2f"|format(balance_data.obligations.total) }}) 
                    - Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡ ({{ "%.2f"|format(balance_data.payments.total_paid) }}) 
                    - Ø¯ÙØ¹ Ù„Ù†Ø§ ({{ "%.2f"|format(balance_data.payments.total_received) }}) 
                    = <strong>{{ "%.2f"|format(balance_data.balance.amount) }}</strong>
                </code>
            </div>

            <!-- ğŸŸ¢ Ù‚Ø³Ù… Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠÙƒ -->
            <h4 class="mt-4 mb-3" style="border-bottom: 3px solid #28a745; padding-bottom: 10px;">
                <i class="fas fa-hand-holding-usd text-success"></i> Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠÙƒ - Ù…Ø§ Ø§Ø³ØªØ­Ù‚Ù‡ Ù…Ù† Ø¹Ù…Ù„Ù‡
            </h4>
            
            <!-- 1. Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            {% if balance_data.rights.inventory['items']|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes"></i> Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†ØµÙŠØ¨Ù‡ Ù…Ù† Ø§Ù„ØªÙƒÙ„ÙØ©)
                        <span class="badge bg-light text-dark">{{ balance_data.rights.inventory.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                                    <th>SKU</th>
                                    <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                                    <th class="text-end">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="text-end">ØªÙƒÙ„ÙØ©/Ù‚Ø·Ø¹Ø©</th>
                                    <th class="text-end">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                    <th class="text-end">Ù†ØµÙŠØ¨ Ø§Ù„Ø´Ø±ÙŠÙƒ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.rights.inventory['items'] %}
                                <tr>
                                    <td>{{ item.product_name }}</td>
                                    <td><code>{{ item.sku or 'â€”' }}</code></td>
                                    <td><small>{{ item.warehouse }}</small></td>
                                    <td class="text-end">{{ item.quantity }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.cost_per_unit) }}</td>
                                    <td class="text-end">{{ "%.1f"|format(item.share_percentage) }}%</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.partner_share) }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="6" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-success">{{ "%.2f"|format(balance_data.rights.inventory.total) }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 2. Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
            {% if balance_data.rights.sales_share['items']|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Ù†ØµÙŠØ¨Ù‡ Ù…Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹)
                        <span class="badge bg-light text-dark">{{ balance_data.rights.sales_share.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„Ø±Ù‚Ù…</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                                    <th class="text-end">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="text-end">Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th class="text-end">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                    <th class="text-end">Ù†ØµÙŠØ¨Ù‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.rights.sales_share['items'] %}
                                <tr>
                                    <td><span class="badge badge-{% if item.type == 'ØµÙŠØ§Ù†Ø©' %}info{% else %}primary{% endif %}">{{ item.type }}</span></td>
                                    <td><code>{{ item.reference_number }}</code></td>
                                    <td><small>{{ item.date }}</small></td>
                                    <td>{{ item.customer_name }}</td>
                                    <td>{{ item.product_name }}</td>
                                    <td class="text-end">{{ item.quantity }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.unit_price) }}</td>
                                    <td class="text-end">{{ "%.1f"|format(item.share_percentage) }}%</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.partner_share_ils) }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="8" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-success">{{ "%.2f"|format(balance_data.rights.sales_share.total_share_ils) }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- ğŸ”´ Ù‚Ø³Ù… Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ -->
            <h4 class="mt-5 mb-3" style="border-bottom: 3px solid #dc3545; padding-bottom: 10px;">
                <i class="fas fa-file-invoice-dollar text-danger"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ - Ù…Ø§ Ø¹Ù„ÙŠÙ‡ Ù„Ù†Ø§
            </h4>
            
            <!-- Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ø´Ø±ÙŠÙƒ (ÙƒØ¹Ù…ÙŠÙ„) -->
            {% if balance_data.obligations.sales_to_partner['items']|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart"></i> Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ø´Ø±ÙŠÙƒ (ÙƒØ¹Ù…ÙŠÙ„)
                        <span class="badge bg-light text-dark">{{ balance_data.obligations.sales_to_partner.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                                    <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                    <th class="text-end">Ø¨Ø§Ù„Ø´ÙŠÙ‚Ù„</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.obligations.sales_to_partner['items'] %}
                                <tr>
                                    <td><code>{{ item.sale_number }}</code></td>
                                    <td><small>{{ item.date }}</small></td>
                                    <td><small>{% for p in item.products %}{{ p.name }} ({{p.qty}}){% if not loop.last %}, {% endif %}{% endfor %}</small></td>
                                    <td class="text-end">{{ "%.2f"|format(item.amount) }}</td>
                                    <td>{{ item.currency }}</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.amount_ils) }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="5" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-danger">{{ "%.2f"|format(balance_data.obligations.sales_to_partner.total_ils) }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- ğŸ’° Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© -->
            <h4 class="mt-5 mb-3" style="border-bottom: 3px solid #ffc107; padding-bottom: 10px;">
                <i class="fas fa-exchange-alt text-warning"></i> Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© - ØªÙØ®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
            </h4>
            
            <!-- Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡ (OUT) -->
            {% if balance_data.payments.paid_to_partner['items']|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-money-check-alt"></i> Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡ (OUT) - ØªÙØ­Ø³Ø¨ Ù„Ù‡
                        <span class="badge bg-light text-dark">{{ balance_data.payments.paid_to_partner.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</th>
                                    <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                    <th class="text-end">Ø¨Ø§Ù„Ø´ÙŠÙ‚Ù„</th>
                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.payments.paid_to_partner['items'] %}
                                <tr>
                                    <td><code>{{ item.payment_number }}</code></td>
                                    <td><small>{{ item.date }}</small></td>
                                    <td>{{ item.method }}</td>
                                    <td>{{ item.check_number or 'â€”' }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.amount) }}</td>
                                    <td>{{ item.currency }}</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.amount_ils) }}</strong></td>
                                    <td><small>{{ item.notes or 'â€”' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="6" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-warning">{{ "%.2f"|format(balance_data.payments.total_paid) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Ø¯ÙØ¹ Ù„Ù†Ø§ (IN) -->
            {% if balance_data.payments.received_from_partner['items']|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-hand-holding-usd"></i> Ø¯ÙØ¹ Ù„Ù†Ø§ (IN) - ØªÙØ­Ø³Ø¨ Ù„Ù‡
                        <span class="badge bg-light text-dark">{{ balance_data.payments.received_from_partner.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</th>
                                    <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                    <th class="text-end">Ø¨Ø§Ù„Ø´ÙŠÙ‚Ù„</th>
                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.payments.received_from_partner['items'] %}
                                <tr>
                                    <td><code>{{ item.payment_number }}</code></td>
                                    <td><small>{{ item.date }}</small></td>
                                    <td>{{ item.method }}</td>
                                    <td>{{ item.check_number or 'â€”' }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.amount) }}</td>
                                    <td>{{ item.currency }}</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.amount_ils) }}</strong></td>
                                    <td><small>{{ item.notes or 'â€”' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="6" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-warning">{{ "%.2f"|format(balance_data.payments.total_received) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Ø±Ø³ÙˆÙ… ØµÙŠØ§Ù†Ø© -->
            {% if balance_data.obligations.service_fees['items']|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-wrench"></i> Ø±Ø³ÙˆÙ… ØµÙŠØ§Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠÙƒ
                        <span class="badge bg-light text-dark">{{ balance_data.obligations.service_fees.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                    <th class="text-end">Ø¨Ø§Ù„Ø´ÙŠÙ‚Ù„</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.obligations.service_fees['items'] %}
                                <tr>
                                    <td><code>{{ item.service_number }}</code></td>
                                    <td><small>{{ item.date }}</small></td>
                                    <td><small>{{ item.description }}</small></td>
                                    <td class="text-end">{{ "%.2f"|format(item.amount) }}</td>
                                    <td>{{ item.currency }}</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.amount_ils) }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="5" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-danger">{{ "%.2f"|format(balance_data.obligations.service_fees.total_ils) }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Ù‚Ø·Ø¹ ØªØ§Ù„ÙØ© -->
            {% if balance_data.obligations.damaged_items['items']|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trash-alt"></i> Ù‚Ø·Ø¹ ØªØ§Ù„ÙØ© (Ù†ØµÙŠØ¨Ù‡ Ù…Ù† Ø§Ù„Ø®Ø³Ø§Ø±Ø©)
                        <span class="badge bg-light text-dark">{{ balance_data.obligations.damaged_items.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                                    <th>SKU</th>
                                    <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                                    <th class="text-end">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="text-end">Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                    <th class="text-end">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                    <th class="text-end">Ù†ØµÙŠØ¨ Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                                    <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_data.obligations.damaged_items['items'] %}
                                <tr>
                                    <td><small>{{ item.date }}</small></td>
                                    <td>{{ item.product_name }}</td>
                                    <td><code>{{ item.sku or 'â€”' }}</code></td>
                                    <td>{{ item.warehouse }}</td>
                                    <td class="text-end">{{ item.quantity }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.unit_cost) }}</td>
                                    <td class="text-end">{{ "%.1f"|format(item.share_percentage) }}%</td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(item.partner_loss) }}</strong></td>
                                    <td><small>{{ item.reason }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="7" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td class="text-end"><strong class="text-danger">{{ "%.2f"|format(balance_data.obligations.damaged_items.total_ils) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
            {% if balance_data.previous_settlements|length > 0 %}
            <div class="card settlement-detail-card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i> Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø±Ù…Ø²</th>
                                    <th>Ø§Ù„ÙØªØ±Ø©</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for settlement in balance_data.previous_settlements %}
                                <tr>
                                    <td><code>{{ settlement.code }}</code></td>
                                    <td><small>{{ settlement.from_date.strftime("%Y-%m-%d") if settlement.from_date else 'â€”' }} â†’ {{ settlement.to_date.strftime("%Y-%m-%d") if settlement.to_date else 'â€”' }}</small></td>
                                    <td><span class="badge bg-info">{{ settlement.status }}</span></td>
                                    <td class="text-end">{{ "%.2f"|format(settlement.total_due) }}</td>
                                    <td><small>{{ settlement.date.strftime("%Y-%m-%d %H:%M") if settlement.date else 'â€”' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                    </div>
                    {% endif %}
                    
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
            <div class="card settlement-detail-card no-print">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-outline-primary btn-lg" id="btn-print">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙŠØ©
                    </button>
                    
                    {% if balance_data.balance.amount|abs > 0.01 %}
                    <a href="{{ url_for('payments.create_payment',
                                       entity_type='PARTNER',
                                      entity_id=partner.id,
                                      direction=balance_data.balance.payment_direction,
                                      total_amount=('%.2f'|format(balance_data.balance.amount|abs)),
                                      currency='ILS',
                                      reference='SmartSettle-' ~ partner.id ~ '-' ~ date_from.strftime('%Y%m%d'),
                                      notes='ØªØ³ÙˆÙŠØ© Ø°ÙƒÙŠØ© - ' ~ partner.name ~ ' - ' ~ date_from.strftime('%Y-%m-%d') ~ ' Ø¥Ù„Ù‰ ' ~ date_to.strftime('%Y-%m-%d')) }}"
                       class="btn btn-{% if balance_data.balance.payment_direction == 'OUT' %}success{% else %}warning{% endif %} btn-lg">
                        <i class="fas fa-{% if balance_data.balance.payment_direction == 'OUT' %}money-check-alt{% else %}hand-holding-usd{% endif %}"></i> 
                        {{ balance_data.balance.action }} - {{ "%.2f"|format(balance_data.balance.amount|abs) }} â‚ª
                    </a>
                    {% else %}
                    <button class="btn btn-secondary btn-lg" disabled>
                        <i class="fas fa-balance-scale"></i> Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ§Ø²Ù†
                    </button>
                    {% endif %}
                    
                    <a href="{{ url_for('vendors_bp.partners_list') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </a>
                </div>
            </div>

            {% else %}
            <!-- Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ³ÙˆÙŠØ© -->
            {% if balance_data and balance_data.error_type == 'missing_fx_rate' %}
            <!-- Ø®Ø·Ø£: Ø³Ø¹Ø± ØµØ±Ù Ù…ÙÙ‚ÙˆØ¯ -->
            <div class="alert alert-warning" style="border-left: 4px solid #ffc107;">
                <h4><i class="fas fa-exclamation-triangle"></i> {{ balance_data.error }}</h4>
                <div style="white-space: pre-line; margin: 15px 0;">{{ balance_data.message }}</div>
                <hr>
                <div class="d-flex gap-2">
                    <a href="{{ balance_data.help_url or '/settings' }}" class="btn btn-warning">
                        <i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Øª
                    </a>
                    <a href="{{ url_for('vendors_bp.partners_list') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </a>
                </div>
            </div>
            {% elif balance_data and balance_data.error %}
            <!-- Ø®Ø·Ø£ Ø¹Ø§Ù… -->
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-circle"></i> Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ³ÙˆÙŠØ©</h4>
                <p>{{ balance_data.error }}</p>
            </div>
            <div class="text-center">
                <a href="{{ url_for('vendors_bp.partners_list') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø±ÙƒØ§Ø¡
                </a>
            </div>
            {% else %}
            <!-- ØªØ³ÙˆÙŠØ© Ø¹Ø§Ø¯ÙŠØ© -->
            <div class="alert alert-info">
                <h4><i class="fas fa-info-circle"></i> ØªØ³ÙˆÙŠØ© Ø¹Ø§Ø¯ÙŠØ©</h4>
                <p>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</p>
            </div>
            <div class="text-center">
                <a href="{{ url_for('vendors_bp.partners_list') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø±ÙƒØ§Ø¡
                </a>
            </div>
            {% endif %}
            {% endif %}

        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  'use strict';
  
  // Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  document.getElementById('btn-print')?.addEventListener('click', function () {
    window.print();
  });
  
  // Ctrl+P Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
      e.preventDefault();
      window.print();
    }
  });
  
  // DataTables Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø·ÙˆÙŠÙ„Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹)
  // Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù€ DataTables
})();
</script>
{% endblock %}
