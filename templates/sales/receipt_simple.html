{% extends "base_print.html" %}
{% block title %}ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª{% endblock %}

{% block head_extra %}
{% set _size = (request.args.get('s','a4')|lower) %}
{% set _ori  = (request.args.get('o','portrait')|lower) %}
{% if _size == 'a5' %}{% set W=148 %}{% set H=210 %}{% else %}{% set W=210 %}{% set H=297 %}{% endif %}
{% if _ori == 'landscape' %}{% set PW=H %}{% set PH=W %}{% else %}{% set PW=W %}{% set PH=H %}{% endif %}
{% set MT=8 %}{% set MR=8 %}{% set ML=8 %}{% set MB=8 %}
{% set content_w = PW - (ML + MR) %}

<style>
  @page { size: {{PW}}mm {{PH}}mm; margin: {{MT}}mm {{MR}}mm {{MB}}mm {{ML}}mm; }
  @media print { .no-print{display:none!important} }

  html,body{background:#fff;font-family:"DejaVu Sans","Amiri","Tahoma","Arial",sans-serif;direction:rtl;text-align:right;font-size:12px;line-height:1.4;margin:0;color:#000}
  #receipt{width:{{content_w}}mm;margin:0 auto;box-sizing:border-box}

  .simple-header{text-align:center;margin-bottom:12px;border-bottom:2px solid #333;padding-bottom:8px}
  .simple-header h2{font-size:18px;font-weight:800;margin:0 0 4px 0}
  .simple-header .subtitle{font-size:11px;color:#555;margin:0}

  .info-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:11px}
  .info-row div{flex:1}

  table{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:10px}
  th,td{border:1px solid #999;padding:5px 6px;vertical-align:middle;font-size:11px}
  thead th{background:#f0f0f0;border-color:#777;font-weight:800;color:#000;white-space:nowrap}
  .wrap{overflow-wrap:anywhere;word-break:normal;white-space:normal}
  .num{font-variant-numeric:tabular-nums;text-align:end}

  col.col-idx { width: 6%;  }
  col.col-item{ width: 36%; }
  col.col-wh  { width: 10%; }
  col.col-qty { width: 8%;  }
  col.col-unit{ width: 14%; }
  col.col-disc{ width: 8%;  }
  col.col-tax { width: 8%;  }
  col.col-sum { width: 10%; }

  .kv th{width:35mm;background:#f5f5f5;color:#333;font-weight:700;white-space:nowrap;border:1px solid #999}
  .kv td{border:1px solid #999}

  .sign-row{display:flex;gap:14px;margin-top:18px}
  .sign{flex:1;text-align:center;border-top:1px solid #888;padding-top:10px;min-height:35px;font-size:11px}

  .notes-box{border:1px solid #999;padding:8px;margin-bottom:10px;font-size:11px;min-height:20px}

  @media print{
    html,body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .btn,nav,.navbar,.sidebar,.actions,a.no-print{display:none!important}
    a[href]:after{content:""!important}
    tr,.info-row,.notes-box{break-inside:avoid;page-break-inside:avoid}
  }
</style>
{% endblock %}

{% block content %}
<div id="receipt">
  <!-- Ø±Ø£Ø³ Ù…Ø¨Ø³Ø·: Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· -->
  <div class="simple-header" style="border-bottom:1px solid #ccc;padding-bottom:6px">
    <div style="font-size:14px;font-weight:700;text-align:center">
      Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ sale.sale_date and sale.sale_date.strftime('%Y-%m-%d') or 'â€”' }}
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ -->
  <table>
    <colgroup>
      <col class="col-idx"><col class="col-item"><col class="col-wh"><col class="col-qty">
      <col class="col-unit"><col class="col-disc"><col class="col-tax"><col class="col-sum">
    </colgroup>
    <thead>
      <tr>
        <th>#</th>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
        <th>Ø®ØµÙ… (%)</th>
        <th>Ø¶Ø±ÙŠØ¨Ø© (%)</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      </tr>
    </thead>
    <tbody>
      {% for item in lines %}
        {% set ln = item.obj %}
        <tr>
          <td class="num">{{ loop.index }}</td>
          <td class="wrap">
            {{ ln.product.name if ln.product else 'â€”' }}
            {% if ln.note %}<div class="text-muted" style="font-size:10px">{{ ln.note }}</div>{% endif %}
          </td>
          <td style="text-align:center">{{ ln.warehouse.name if ln.warehouse else 'â€”' }}</td>
          <td class="num">{{ ln.quantity }}</td>
          <td class="num">{{ money_fmt(ln.unit_price) }} {{ sale.currency }}</td>
          <td class="num">{{ ln.discount_rate or 0 }}</td>
          <td class="num">{{ ln.tax_rate or 0 }}</td>
          <td class="num">{{ money_fmt(item.line_total) }} {{ sale.currency }}</td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr><td colspan="7" style="text-align:end">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</td><td class="num">{{ money_fmt(subtotal) }} {{ sale.currency }}</td></tr>
      {% if sale_discount_total and sale_discount_total != 0 %}
      <tr><td colspan="7" style="text-align:end">Ø®ØµÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td><td class="num">- {{ money_fmt(sale_discount_total) }} {{ sale.currency }}</td></tr>
      {% endif %}
      <tr><td colspan="7" style="text-align:end">Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</td><td class="num">{{ money_fmt(subtotal_after_discount) }} {{ sale.currency }}</td></tr>
      {% if sale_tax_rate and sale_tax_rate != 0 %}
      <tr><td colspan="7" style="text-align:end">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ({{ sale_tax_rate }}%):</td><td class="num">{{ money_fmt(invoice_tax_amount) }} {{ sale.currency }}</td></tr>
      {% endif %}
      {% if sale_shipping and sale_shipping != 0 %}
      <tr><td colspan="7" style="text-align:end">Ø§Ù„Ø´Ø­Ù†:</td><td class="num">{{ money_fmt(sale_shipping) }} {{ sale.currency }}</td></tr>
      {% endif %}
      <tr><td colspan="7" style="text-align:end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong></td><td class="num"><strong>{{ money_fmt(grand_total) }} {{ sale.currency }}</strong></td></tr>
    </tfoot>
  </table>

  <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
  <div class="notes-box"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ sale.notes or 'â€”' }}</div>

  <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª -->
  <div class="sign-row">
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹<br>{{ sale.seller.username if sale.seller else '________' }}</div>
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„<br>__________</div>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
  <div class="text-center mt-3 no-print" style="padding:8px 0">
    <button class="btn btn-dark btn-sm" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <a class="btn btn-info btn-sm" href="{{ url_for('sales_bp.sale_receipt', id=sale.id) }}">ğŸ¨ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©</a>
    <a class="btn btn-secondary btn-sm" href="{{ url_for('sales_bp.sale_detail', id=sale.id) }}">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>
  </div>
</div>
{% endblock %}

