{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
  <style>
    .sales-form .card-header h3{font-weight:700}
    .sales-form .card-header .badge{border-radius:999px;padding:.35rem .6rem}
    .sales-form .section-title{font-weight:700;color:#334155;margin:0 0 .5rem;display:flex;align-items:center;gap:.4rem}
    .sales-form .section-title i{opacity:.8}
    #saleForm .head-grid{display:grid; grid-template-columns:repeat(12,1fr); grid-gap:12px;}
    #saleForm .head-grid .col-span-3{grid-column:span 3}
    #saleForm .head-grid .col-span-4{grid-column:span 4}
    #saleForm .head-grid .col-span-6{grid-column:span 6}
    #saleForm .head-grid .col-span-12{grid-column:span 12}
    @media(max-width:992px){
      #saleForm .head-grid .col-span-3,
      #saleForm .head-grid .col-span-4,
      #saleForm .head-grid .col-span-6{grid-column:span 6}
    }
    @media(max-width:576px){
      #saleForm .head-grid .col-span-3,
      #saleForm .head-grid .col-span-4,
      #saleForm .head-grid .col-span-6{grid-column:span 12}
    }
    #saleForm .form-group label{font-weight:600;color:#475569;margin-bottom:.25rem}
    #saleForm .form-control{border-radius:10px}
    #saleForm select.form-control{padding-top:.35rem;padding-bottom:.35rem}

    /* بنود الفاتورة */
    .sale-line{
      display:grid;
      grid-template-columns: 2fr 4fr 1fr 1fr 2fr; /* مستودع | منتج | كمية | سعر | إجراءات */
      grid-gap:8px; align-items:start;
    }
    @media(max-width:992px){
      .sale-line{grid-template-columns: 1fr 1fr 1fr 1fr;}
      .sale-line > div:last-child{grid-column:1/-1}
    }
    @media(max-width:576px){
      .sale-line{grid-template-columns:1fr 1fr;}
      .sale-line > div:last-child{grid-column:1/-1}
    }
    .sale-line .form-control{border-radius:8px}
    .stock-badge{min-width:64px}
    .totals-table th{background:#f8fafc;font-weight:700;color:#334155}
    .totals-table td,.totals-table th{vertical-align:middle}
    .totals-table .grand{font-size:1.05rem}
    .sales-form .btn{border-radius:10px}
    .lines-wrap{max-height:56vh; overflow:auto}
    .lines-header{border-bottom:1px solid #e9ecef}
    .sortable-ghost{opacity:.5;background:#c8ebfb}
  </style>
{% endblock %}

{% block content %}
<div class="container py-5 sales-form">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-lg rounded border-0">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h3 class="mb-0"><i class="fas fa-file-invoice mr-2"></i> {{ title }}</h3>
          <span class="badge badge-success">مؤكد</span>
        </div>

        <div class="card-body bg-light">
          <form method="post" id="saleForm" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}

            <div class="section-title mb-2"><i class="far fa-clipboard"></i> تفاصيل الوثيقة</div>
            <div class="head-grid mb-4">
              <div class="form-group col-span-4">
                <label for="sale_date"><i class="far fa-calendar-alt mr-1"></i> تاريخ البيع</label>
                {{ form.sale_date(class="form-control", id="sale_date", type="datetime-local",
                  value=(form.sale_date.data.strftime('%Y-%m-%dT%H:%M') if form.sale_date.data else "")) }}
              </div>

              <div class="form-group col-span-4">
                <label for="customer_id"><i class="fas fa-user mr-1"></i> العميل</label>
                {{ form.customer_id(class="form-control select2 ajax-select", id="customer_id",
                  **{'data-endpoint': url_for('api.customers'),'data-placeholder': 'اختر العميل','data-allow-clear': 1}) }}
              </div>

              <div class="form-group col-span-4">
                <label for="seller_id"><i class="fas fa-user-tie mr-1"></i> البائع</label>
                {{ form.seller_id(class="form-control select2 ajax-select", id="seller_id",
                  **{'data-endpoint': url_for('api.users'),'data-placeholder': 'اختر البائع','data-allow-clear': 1}) }}
              </div>

              <div class="form-group col-span-4">
                <label for="currency"><i class="fas fa-dollar-sign mr-1"></i> العملة</label>
                {{ form.currency(class="form-control", id="currency") }}
              </div>

              <div class="form-group col-span-4">
                <label for="taxRate"><i class="fas fa-percent mr-1"></i> نسبة الضريبة (%)</label>
                {{ form.tax_rate(class="form-control", id="taxRate") }}
              </div>

              <div class="form-group col-span-4">
                <label for="shippingCost"><i class="fas fa-truck mr-1"></i> تكلفة الشحن</label>
                {{ form.shipping_cost(class="form-control", id="shippingCost") }}
              </div>

              <div class="form-group col-span-4">
                <label for="discountTotal"><i class="fas fa-tags mr-1"></i> الخصم الإجمالي</label>
                {{ form.discount_total(class="form-control", id="discountTotal") }}
              </div>
              
              <div class="form-group col-span-6">
                <label for="receiver_name"><i class="fas fa-user-check mr-1"></i> مستلم البضاعة</label>
                {{ form.receiver_name(class="form-control", id="receiver_name", placeholder="اسم الشخص المستلم (اختياري)") }}
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-white lines-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list mr-2"></i> بنود الفاتورة</h5>
                <button type="button" id="addLine" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-plus mr-1"></i> إضافة بند
                </button>
              </div>

              <div class="card-body lines-wrap">
                <div id="saleLines">
                  {% for line in form.lines %}
                  <div class="sale-line mb-2 p-2 border rounded bg-white" data-index="{{ loop.index0 }}">
                    <div class="form-group">
                      <select name="{{ line.warehouse_id.name }}" id="{{ line.warehouse_id.id }}" 
                              class="form-control select2 ajax-select warehouse-select" 
                              required
                              data-endpoint="{{ url_for('api.warehouses') }}"
                              data-placeholder="اختر المستودع"
                              data-allow-clear="1">
                        {% if line.warehouse_id.data and sale is defined and sale.lines[loop.index0] is defined %}
                          <option value="{{ sale.lines[loop.index0].warehouse_id }}" selected>
                            {{ sale.lines[loop.index0].warehouse.name if sale.lines[loop.index0].warehouse else 'مستودع' }}
                          </option>
                        {% endif %}
                      </select>
                    </div>
                    <div class="form-group">
                      <select name="{{ line.product_id.name }}" id="{{ line.product_id.id }}"
                              class="form-control select2 ajax-select product-select" 
                              required
                              data-endpoint="{{ url_for('api.products') }}"
                              data-placeholder="اختر الصنف"
                              data-allow-clear="1">
                        {% if line.product_id.data and sale is defined and sale.lines[loop.index0] is defined %}
                          <option value="{{ sale.lines[loop.index0].product_id }}" selected>
                            {{ sale.lines[loop.index0].product.name if sale.lines[loop.index0].product else 'منتج' }}
                          </option>
                        {% endif %}
                      </select>
                    </div>
                    <div class="form-group">
                      {{ line.quantity(class="form-control quantity-input", min="1", step="1", required=True, placeholder="الكمية") }}
                    </div>
                    <div class="form-group">
                      {{ line.unit_price(class="form-control price-input", min="0", step="0.01", required=True, placeholder="السعر") }}
                    </div>
                    <div class="form-group">
                      <div class="d-flex align-items-center justify-content-end">
                        <span class="badge badge-light text-dark stock-badge" title="المتوفر"></span>
                        <button type="button" class="btn btn-sm btn-outline-danger ml-2 remove-line" title="حذف البند">
                          <i class="fas fa-trash"></i>
                        </button>
                        <span class="btn btn-sm btn-outline-secondary ml-2 drag-handle" title="سحب لإعادة الترتيب">
                          <i class="fas fa-arrows-alt"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>

            <div class="section-title mb-2"><i class="fas fa-calculator"></i> الملخص</div>
            <div class="row justify-content-end mb-3">
              <div class="col-md-6">
                <table class="table table-bordered mb-0 totals-table">
                  <tr>
                    <th class="text-right"><i class="fas fa-calculator mr-1"></i> المجموع الفرعي:</th>
                    <td id="subtotal" class="text-right">0.00 {{ form.currency.data }}</td>
                  </tr>
                  <tr>
                    <th class="text-right"><i class="fas fa-tags mr-1"></i> الخصم الإجمالي:</th>
                    <td id="discountTotalDisplay" class="text-right">{{ "%.2f"|format(form.discount_total.data or 0) }} {{ form.currency.data }}</td>
                  </tr>
                  <tr>
                    <th class="text-right"><i class="fas fa-receipt mr-1"></i> الضريبة ({{ form.tax_rate.data or 0 }}%):</th>
                    <td id="taxAmount" class="text-right">0.00 {{ form.currency.data }}</td>
                  </tr>
                  <tr>
                    <th class="text-right"><i class="fas fa-shipping-fast mr-1"></i> الشحن:</th>
                    <td id="shippingCostDisplay" class="text-right">{{ "%.2f"|format(form.shipping_cost.data or 0) }} {{ form.currency.data }}</td>
                  </tr>
                  <tr class="table-success">
                    <th class="text-right font-weight-bold"><i class="fas fa-equals mr-1"></i> الإجمالي النهائي:</th>
                    <td id="totalAmount" class="font-weight-bold text-right grand">0.00 {{ form.currency.data }}</td>
                  </tr>
                </table>
              </div>
            </div>

            <div class="mb-4">
              {{ form.notes(class="form-control", rows="3", placeholder="ملاحظات") }}
            </div>

            <div class="d-flex justify-content-between mt-4">
              <button type="submit" class="btn btn-success px-4">
                <i class="fas fa-save mr-2"></i> حفظ
              </button>
              <a href="{{ url_for('sales_bp.list_sales') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times mr-2"></i> إلغاء
              </a>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sales.js') }}"></script>
{% endblock %}
