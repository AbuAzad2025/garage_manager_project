{# templates/sales/dashboard.html #}
{% extends 'base.html' %}
{% block title %}لوحة مبيعات{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-4 col-12 mb-3">
      <div class="small-box bg-primary">
        <div class="inner">
          <h3>{{ total_sales }}</h3>
          <p>إجمالي عدد الفواتير</p>
        </div>
        <div class="icon"><i class="fas fa-receipt"></i></div>
      </div>
    </div>
    <div class="col-lg-4 col-12 mb-3">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ (total_revenue or 0)|float|round(2) }}</h3>
          <p>إجمالي الإيرادات</p>
        </div>
        <div class="icon"><i class="fas fa-dollar-sign"></i></div>
      </div>
    </div>
    <div class="col-lg-4 col-12 mb-3">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ pending_sales }}</h3>
          <p>فواتير مسودة</p>
        </div>
        <div class="icon"><i class="fas fa-hourglass-half"></i></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-light">عدد الفواتير شهرياً</div>
        <div class="card-body">
          <div style="height:280px">
            <canvas id="salesCountChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-light">الإيراد الشهري</div>
        <div class="card-body">
          <div style="height:280px">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-light">أفضل العملاء</div>
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
              <tr><th>العميل</th><th class="text-end">الإنفاق</th></tr>
            </thead>
            <tbody>
              {% for name, spent in top_customers %}
                <tr>
                  <td>{{ name }}</td>
                  <td class="text-end">{{ (spent or 0)|float|round(2) }}</td>
                </tr>
              {% else %}
                <tr><td colspan="2" class="text-center text-muted">لا توجد بيانات</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-light">أفضل المنتجات</div>
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
              <tr><th>المنتج</th><th class="text-center">المباع</th><th class="text-end">الإيراد</th></tr>
            </thead>
            <tbody>
              {% for name, sold, rev in top_products %}
                <tr>
                  <td>{{ name }}</td>
                  <td class="text-center">{{ sold }}</td>
                  <td class="text-end">{{ (rev or 0)|float|round(2) }}</td>
                </tr>
              {% else %}
                <tr><td colspan="3" class="text-center text-muted">لا توجد بيانات</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function () {
  const labels = {{ months|tojson }};
  const countData = {{ sales_count|tojson }};
  const revenueData = {{ revenue|tojson }};

  if (window.Chart) {
    const ctx1 = document.getElementById('salesCountChart').getContext('2d');
    new Chart(ctx1, {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: 'عدد الفواتير', data: countData, borderWidth: 2, fill: true }] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    const ctx2 = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx2, {
      type: 'line',
      data: { labels: labels, datasets: [{ label: 'الإيراد', data: revenueData, borderWidth: 2, fill: true }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
})();
</script>
{% endblock %}
