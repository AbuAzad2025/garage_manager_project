{# File: templates/sales/dashboard.html #}
{% extends 'base.html' %}
{% block title %}لوحة المبيعات{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
  <style>
    .small-box{border-radius:1rem;box-shadow:0 0.5rem 1rem rgba(0,0,0,.08)}
    .small-box .icon{opacity:.25}
    .card{border:0;border-radius:1rem;box-shadow:0 0.5rem 1rem rgba(0,0,0,.08)}
    .table thead th{white-space:nowrap}
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <div class="row g-3">
    <div class="col-xl-4 col-md-6">
      <div class="small-box bg-primary text-white p-3 position-relative overflow-hidden">
        <div class="d-flex justify-content-between align-items-center">
          <div class="inner">
            <h3 class="mb-1">{{ total_sales }}</h3>
            <p class="mb-0">إجمالي عدد الفواتير</p>
          </div>
          <div class="icon fs-1"><i class="fas fa-receipt"></i></div>
        </div>
        <a href="{{ url_for('sales_bp.list_sales') }}" class="small-box-footer text-white-50 d-block mt-2">إلى الفواتير <i class="fas fa-arrow-left ms-1"></i></a>
      </div>
    </div>

    <div class="col-xl-4 col-md-6">
      <div class="small-box bg-success text-white p-3 position-relative overflow-hidden">
        <div class="d-flex justify-content-between align-items-center">
          <div class="inner">
            <h3 class="mb-1">{{ (total_revenue or 0)|float|round(2) }}</h3>
            <p class="mb-0">إجمالي الإيرادات</p>
          </div>
          <div class="icon fs-1"><i class="fas fa-dollar-sign"></i></div>
        </div>
        <span class="small-box-footer text-white-50 d-block mt-2">إجمالي عبر كل الشهور</span>
      </div>
    </div>

    <div class="col-xl-4 col-md-6">
      <div class="small-box bg-warning text-dark p-3 position-relative overflow-hidden">
        <div class="d-flex justify-content-between align-items-center">
          <div class="inner">
            <h3 class="mb-1">{{ pending_sales }}</h3>
            <p class="mb-0">فواتير مسودة</p>
          </div>
          <div class="icon fs-1"><i class="fas fa-hourglass-half"></i></div>
        </div>
        <a href="{{ url_for('sales_bp.list_sales', status='DRAFT') }}" class="small-box-footer text-dark d-block mt-2">اعرض المسودات</a>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header bg-light fw-bold"><i class="fas fa-chart-bar me-2"></i> عدد الفواتير شهريًا</div>
        <div class="card-body">
          <div style="height:320px"><canvas id="salesCountChart" aria-label="عدد الفواتير"></canvas></div>
        </div>
      </div>
    </div>

    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header bg-light fw-bold"><i class="fas fa-chart-line me-2"></i> الإيراد الشهري</div>
        <div class="card-body">
          <div style="height:320px"><canvas id="revenueChart" aria-label="الإيراد"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header bg-light fw-bold"><i class="fas fa-user-tie me-2"></i> أفضل العملاء</div>
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-dark">
              <tr><th>العميل</th><th class="text-end">الإنفاق</th></tr>
            </thead>
            <tbody>
              {% for name, spent in top_customers %}
                <tr>
                  <td>{{ name }}</td>
                  <td class="text-end">{{ (spent or 0)|float|round(2) }}</td>
                </tr>
              {% else %}
                <tr><td colspan="2" class="text-center text-muted">لا توجد بيانات</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header bg-light fw-bold"><i class="fas fa-cubes me-2"></i> أفضل المنتجات</div>
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-dark">
              <tr><th>المنتج</th><th class="text-center">المباع</th><th class="text-end">الإيراد</th></tr>
            </thead>
            <tbody>
              {% for name, sold, rev in top_products %}
                <tr>
                  <td>{{ name }}</td>
                  <td class="text-center">{{ sold }}</td>
                  <td class="text-end">{{ (rev or 0)|float|round(2) }}</td>
                </tr>
              {% else %}
                <tr><td colspan="3" class="text-center text-muted">لا توجد بيانات</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function ensureChart(cb){
      if(window.Chart) return cb();
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      s.onload=cb; document.head.appendChild(s);
    })(function(){
      const labels = {{ months|tojson }};
      const countData = {{ sales_count|tojson }};
      const revenueData = {{ revenue|tojson }};

      const ctx1 = document.getElementById('salesCountChart');
      if (ctx1) {
        new Chart(ctx1, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'عدد الفواتير', data: countData, borderWidth: 2 }]
          },
          options: {
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false} },
            scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
          }
        });
      }

      const ctx2 = document.getElementById('revenueChart');
      if (ctx2) {
        new Chart(ctx2, {
          type: 'line',
          data: {
            labels,
            datasets: [{ label: 'الإيراد', data: revenueData, borderWidth: 3, tension:.35, fill:true }]
          },
          options: {
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false}, tooltip:{ mode:'index', intersect:false } },
            scales:{ y:{ beginAtZero:true } }
          }
        });
      }
    });
  </script>
{% endblock %}
