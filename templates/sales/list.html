<!-- File: templates/sales/list.html -->
{% extends 'base_print.html' if print_mode else 'base.html' %}
{% block title %}Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª{% endblock %}

{% block head_extra %}
  {{ super() }}
  {% if not print_mode %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
  <style>
    .card{border:0;border-radius:1rem;box-shadow:0 0.5rem 1rem rgba(0,0,0,.08)}
    /* Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¶Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ */
    .btn-create{
      background:#ffc107;        /* Ø£ØµÙØ± ÙˆØ§Ø¶Ø­ */
      color:#1b2a4e;             /* Ù†Øµ ØºØ§Ù…Ù‚ Ù…Ù‚Ø±ÙˆØ¡ */
      border:none;
      font-weight:700;
      border-radius:.65rem;
      padding:.55rem 1rem;
      box-shadow:0 .35rem .9rem rgba(0,0,0,.12);
      transition:transform .08s ease, box-shadow .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn-create i{margin-left:.35rem}
    .btn-create:hover{background:#ffb300;color:#12203a;transform:translateY(-1px)}
    .btn-create:active{transform:translateY(0);box-shadow:0 .25rem .7rem rgba(0,0,0,.16)}
    .btn-create:focus{outline:0;box-shadow:0 0 0 .2rem rgba(255,193,7,.35)}
    /* ØªØ­Ø³ÙŠÙ† ØªØ¨Ø§ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± */
    .btn-filter{padding:.45rem .9rem;border-radius:.55rem}
    .sales-summary-card h3{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sales-summary-card .card-title{color:rgba(0,0,0,.85);font-size:1.05rem;font-weight:700}
    .sales-summary-card small{font-size:0.95rem;font-weight:600;color:rgba(0,0,0,.7)}
    .table thead th{white-space:nowrap}
    .sort-buttons{display:flex;flex-direction:column;gap:2px;margin-right:4px}
    .btn-sort{background:none;border:none;padding:2px 4px;cursor:pointer;color:#6c757d;font-size:0.75rem;line-height:1}
    .btn-sort:hover{color:#495057}
    .btn-sort.active{color:#007bff}
    .table thead th .d-flex{width:100%}
  </style>
  {% else %}
  <style>
@page { size: A4 portrait; margin: 4mm 4mm 6mm 4mm; }
html, body { background:#fff; direction:rtl; font-family:"Segoe UI","Tahoma",sans-serif; font-size:11px; margin:0; padding:0; width:100%; }
.print-sheet { width:100%; margin:0; padding:4mm 2mm; box-sizing:border-box; }
.print-header { text-align:center; margin:0 0 8mm 0; }
.print-header h1 { margin:0; font-size:18pt; font-weight:700; }
.print-subtitle { margin:4px 0 0 0; font-size:11px; }
.print-meta { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6mm; font-size:11px; }
.print-meta-item { border:1px solid #b5b5b5; padding:4px 8px; min-width:55mm; }
.print-meta-label { display:block; font-weight:600; margin-bottom:2px; }
.print-meta-value { font-size:11px; direction:ltr; unicode-bidi:embed; }
.print-summary { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; font-size:11px; }
.print-summary-item { min-width:45mm; }
.print-summary-item .label { font-weight:600; display:inline-block; margin-left:4px; }
.print-summary-item .value { direction:ltr; unicode-bidi:embed; }
.print-table-container { width:100%; overflow:visible; direction:rtl; }
.print-table { width:100%; margin:0; border-collapse:collapse; table-layout:auto; }
.print-table thead { background:#f3f3f3; }
.print-table th, .print-table td { border:1px solid #c4c4c4; padding:4px 5px; text-align:center; font-size:11px; line-height:1.35; word-break:break-word; }
.print-table th:nth-child(3), .print-table td:nth-child(3) { text-align:right; }
.print-table th:nth-child(6), .print-table td:nth-child(6) { text-align:right; font-weight:600; }
.print-table a { color:inherit; text-decoration:none; }
.print-table tfoot td { font-weight:600; text-align:right; }
.print-controls { text-align:left; margin-bottom:6mm; }
@media print { .print-controls { display:none; } }
  </style>
  {% endif %}
{% endblock %}

{% block content %}
{% if print_mode %}
  <div class="print-sheet">
    <div class="print-header">
      <h1>Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
      <p class="print-subtitle">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {{ generated_at.strftime("%Y-%m-%d %H:%M") }}</p>
    </div>
    <div class="print-meta">
      <div class="print-meta-item">
        <span class="print-meta-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span>
        <span class="print-meta-value">{{ summary.sales_count }}</span>
      </div>
      <div class="print-meta-item">
        <span class="print-meta-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
        <span class="print-meta-value">{{ "{:.2f}".format(summary.total_sales) }} â‚ª</span>
      </div>
      <div class="print-meta-item">
        <span class="print-meta-label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span>
        <span class="print-meta-value">{{ "{:.2f}".format(summary.total_paid) }} â‚ª</span>
      </div>
      <div class="print-meta-item">
        <span class="print-meta-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
        <span class="print-meta-value">{{ "{:.2f}".format(summary.total_pending) }} â‚ª</span>
      </div>
    </div>
    {% if not pdf_export %}
    <div class="print-controls">
      <button type="button" class="print-trigger" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
    {% endif %}
    <div class="print-table-wrapper">
      <table class="print-table">
        <colgroup>
          <col style="width:6%">
          <col style="width:12%">
          <col style="width:28%">
          <col style="width:18%">
          <col style="width:12%">
          <col style="width:24%">
        </colgroup>
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ù…Ø¯ÙÙˆØ¹</th>
            <th>Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in sales %}
          <tr>
            <td>{{ loop.index0 + row_offset + 1 }}</td>
            <td>{{ sale.date_iso }}</td>
            <td>{{ sale.customer_name }}</td>
            <td>{{ sale.total_fmt }}</td>
            <td>{{ sale.paid_fmt }}</td>
            <td>{{ sale.balance_fmt }}</td>
            <td>{{ sale.currency or 'ILS' }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</td>
            <td>{{ "{:.2f}".format(summary.total_sales) }} â‚ª</td>
            <td>{{ "{:.2f}".format(summary.total_paid) }} â‚ª</td>
            <td>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {{ "{:.2f}".format(summary.total_pending) }} â‚ª</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="print-summary">
      <div class="print-summary-item"><span class="label">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</span><span class="value">{{ summary.sales_count }}</span></div>
      <div class="print-summary-item"><span class="label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span><span class="value">{{ "{:.2f}".format(summary.average_sale) }} â‚ª</span></div>
    </div>
  </div>
{% else %}
<div class="container-fluid py-4">
  <div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h3 class="mb-0"><i class="fas fa-file-invoice mr-2"></i> ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
      <div>
        <button type="button" class="btn btn-light ml-2" data-toggle="modal" data-target="#printSalesModal"><i class="fas fa-print mr-1"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
        <a href="{{ url_for('returns.list_returns') }}" class="btn btn-danger ml-2" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª" data-no-confirm="true" data-no-danger="true">
          <i class="fas fa-undo-alt"></i> Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
        </a>
        <a href="{{ url_for('sales_bp.create_sale') }}" class="btn btn-create" title="Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©">
          <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©
        </a>
      </div>
    </div>

    <div class="card-body bg-light">
      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ù…Ø­Ø³Ù‘Ù†Ø© -->
      <div id="sales-summary-wrapper">
      {% if summary %}
      <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
          <div class="card border-0 shadow-sm bg-primary text-white sales-summary-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h6>
                  <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(summary.total_sales) }} â‚ª</h3>
                  <small class="opacity-75">{{ summary.sales_count }} ÙØ§ØªÙˆØ±Ø©</small>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-file-invoice fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
          <div class="card border-0 shadow-sm bg-success text-white sales-summary-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h6>
                  <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(summary.total_paid) }} â‚ª</h3>
                  <small class="opacity-75">{{ "{:.1f}".format((summary.total_paid / summary.total_sales * 100) if summary.total_sales > 0 else 0) }}%</small>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-check-circle fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
          <div class="card border-0 shadow-sm bg-warning text-white sales-summary-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Ø§Ù„Ù…Ø³ØªØ­Ù‚</h6>
                  <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(summary.total_pending) }} â‚ª</h3>
                  <small class="opacity-75">{{ "{:.1f}".format((summary.total_pending / summary.total_sales * 100) if summary.total_sales > 0 else 0) }}%</small>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-clock fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
          <div class="card border-0 shadow-sm bg-info text-white sales-summary-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title mb-1">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h6>
                  <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(summary.average_sale) }} â‚ª</h3>
                  <small class="opacity-75">Ù„ÙƒÙ„ ÙØ§ØªÙˆØ±Ø©</small>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-chart-line fa-2x opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-lg-6 col-md-7">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="sales-search" class="form-control" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" value="{{ request.args.get('q','') }}">
              </div>
            </div>
            <div class="col-lg-6 col-md-5 text-md-left text-sm-right mt-3 mt-md-0">
              <span class="text-muted d-inline-block" id="sales-search-summary">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {{ total_filtered }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ÙÙ„Ø§ØªØ± -->
      <form id="filterForm" class="form-row mb-4" method="get" action="{{ url_for('sales_bp.list_sales') }}">
        <div class="form-group col-md-3">
          <input type="text" name="invoice_no" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©" value="{{ request.args.get('invoice_no','') }}">
        </div>
        <div class="form-group col-md-3">
          <input type="text" name="customer" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù‡Ø§ØªÙ" value="{{ request.args.get('customer','') }}">
        </div>
        <div class="form-group col-md-2">
          <input type="date" name="date_from" class="form-control" value="{{ request.args.get('date_from','') }}">
        </div>
        <div class="form-group col-md-2">
          <input type="date" name="date_to" class="form-control" value="{{ request.args.get('date_to','') }}">
        </div>
        <div class="form-group col-12 d-flex flex-wrap">
          <button type="submit" class="btn btn-primary btn-filter"><i class="fas fa-filter mr-1"></i> ÙÙ„ØªØ±Ø©</button>
          <button type="reset" class="btn btn-secondary btn-filter mr-2"><i class="fas fa-undo mr-1"></i> Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
      </form>

      <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
      <div id="sales-table-wrapper" class="table-responsive">
        <table id="salesTable" class="table table-hover align-middle">
          <thead class="thead-light">
            <tr>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Ø±Ù‚Ù…</span>
                  <div class="sort-buttons">
                    <button type="button" class="btn-sort" data-sort="invoice_no" data-order="asc" title="ØªØµØ§Ø¹Ø¯ÙŠ">
                      <i class="fas fa-sort-up"></i>
                    </button>
                    <button type="button" class="btn-sort" data-sort="invoice_no" data-order="desc" title="ØªÙ†Ø§Ø²Ù„ÙŠ">
                      <i class="fas fa-sort-down"></i>
                    </button>
                  </div>
                </div>
              </th>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                  <div class="sort-buttons">
                    <button type="button" class="btn-sort" data-sort="date" data-order="asc" title="ØªØµØ§Ø¹Ø¯ÙŠ">
                      <i class="fas fa-sort-up"></i>
                    </button>
                    <button type="button" class="btn-sort" data-sort="date" data-order="desc" title="ØªÙ†Ø§Ø²Ù„ÙŠ">
                      <i class="fas fa-sort-down"></i>
                    </button>
                  </div>
                </div>
              </th>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                  <div class="sort-buttons">
                    <button type="button" class="btn-sort" data-sort="customer" data-order="asc" title="ØªØµØ§Ø¹Ø¯ÙŠ">
                      <i class="fas fa-sort-up"></i>
                    </button>
                    <button type="button" class="btn-sort" data-sort="customer" data-order="desc" title="ØªÙ†Ø§Ø²Ù„ÙŠ">
                      <i class="fas fa-sort-down"></i>
                    </button>
                  </div>
                </div>
              </th>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                  <div class="sort-buttons">
                    <button type="button" class="btn-sort" data-sort="total" data-order="asc" title="ØªØµØ§Ø¹Ø¯ÙŠ">
                      <i class="fas fa-sort-up"></i>
                    </button>
                    <button type="button" class="btn-sort" data-sort="total" data-order="desc" title="ØªÙ†Ø§Ø²Ù„ÙŠ">
                      <i class="fas fa-sort-down"></i>
                    </button>
                  </div>
                </div>
              </th>
              <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
              <th>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</th>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Ù…Ø¯ÙÙˆØ¹</span>
                  <div class="sort-buttons">
                    <button type="button" class="btn-sort" data-sort="paid" data-order="asc" title="ØªØµØ§Ø¹Ø¯ÙŠ">
                      <i class="fas fa-sort-up"></i>
                    </button>
                    <button type="button" class="btn-sort" data-sort="paid" data-order="desc" title="ØªÙ†Ø§Ø²Ù„ÙŠ">
                      <i class="fas fa-sort-down"></i>
                    </button>
                  </div>
                </div>
              </th>
              <th>
                <div class="d-flex align-items-center justify-content-between">
                  <span>Ù…ØªØ¨Ù‚ÙŠ</span>
                  <div class="sort-buttons">
                    <button type="button" class="btn-sort" data-sort="balance" data-order="asc" title="ØªØµØ§Ø¹Ø¯ÙŠ">
                      <i class="fas fa-sort-up"></i>
                    </button>
                    <button type="button" class="btn-sort" data-sort="balance" data-order="desc" title="ØªÙ†Ø§Ø²Ù„ÙŠ">
                      <i class="fas fa-sort-down"></i>
                    </button>
                  </div>
                </div>
              </th>
              <th class="text-center" data-sortable="false">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for sale in sales %}
            <tr>
              <td>{{ sale.sale_number }}</td>
              <td>{{ sale.date_iso }}</td>
              <td>{{ sale.customer_name }}</td>
              <td data-sort-value="{{ sale.total_amount or 0 }}">{{ sale.total_fmt }}</td>
              <td class="text-center"><span class="badge badge-secondary">{{ sale.currency or 'ILS' }}</span></td>
              <td class="text-center">
                {% if sale.fx_rate_used and sale.currency != 'ILS' %}
                  <small class="text-muted">
                    {{ "%.4f"|format(sale.fx_rate_used) }}
                    {% if sale.fx_rate_source %}
                      {% if sale.fx_rate_source == 'online' %}ğŸŒ{% elif sale.fx_rate_source == 'manual' %}âœï¸{% else %}âš™ï¸{% endif %}
                    {% endif %}
                  </small>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td data-sort-value="{{ sale.total_paid or 0 }}">{{ sale.paid_fmt }}</td>
              <td data-sort-value="{{ sale.balance_due or 0 }}">
                <span class="badge {{ 'bg-success' if (sale.balance_due or 0) == 0 else 'bg-danger' }}">
                  {{ sale.balance_fmt }}
                </span>
              </td>
              <td class="text-center">
                <div class="table-actions">
                  <a href="{{ url_for('sales_bp.sale_detail', id=sale.id) }}" class="btn btn-action-view btn-action-sm" title="Ø¹Ø±Ø¶">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{{ url_for('sales_bp.edit_sale', id=sale.id) }}" class="btn btn-action-edit btn-action-sm" title="ØªØ¹Ø¯ÙŠÙ„">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{{ url_for('sales_bp.generate_invoice', id=sale.id) }}" class="btn btn-action-print btn-action-sm" title="ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©" target="_blank">
                    <i class="fas fa-file-invoice-dollar"></i>
                  </a>
                  {% if sale.is_archived %}
                  <button type="button" class="btn btn-action-restore btn-action-sm" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø©" onclick="restoreSale({{ sale.id }})">
                    <i class="fas fa-undo"></i>
                  </button>
                  {% else %}
                  <button type="button" class="btn btn-action-archive btn-action-sm" title="Ø£Ø±Ø´ÙØ©" onclick="archiveSale({{ sale.id }})">
                    <i class="fas fa-archive"></i>
                  </button>
                  {% endif %}
                  {% if sale.balance_due and sale.balance_due > 0 %}
                  <a href="{{ url_for('payments.create_payment', 
                                     entity_type='SALE', 
                                     entity_id=sale.id,
                                     amount=sale.balance_due,
                                     currency=sale.currency if sale.currency else 'ILS',
                                     reference='Ø¯ÙØ¹ Ù…Ø¨ÙŠØ¹Ø© Ù…Ù† ' ~ (sale.customer.name if sale.customer else 'Ø¹Ù…ÙŠÙ„') ~ ' - ' ~ (sale.sale_number or sale.id),
                                     notes='Ø¯ÙØ¹ Ù…Ø¨ÙŠØ¹Ø©: ' ~ (sale.sale_number or sale.id) ~ ' - Ø§Ù„Ø¹Ù…ÙŠÙ„: ' ~ (sale.customer.name if sale.customer else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
                                     customer_id=sale.customer_id) }}" class="btn btn-sm btn-success" title="Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©"><i class="fas fa-money-bill-wave"></i></a>
                  {% endif %}
                  {% if current_user.has_permission('manage_sales') %}
                    <form method="post" action="{{ url_for('sales_bp.delete_sale', id=sale.id) }}" class="d-inline">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-sm btn-danger" title="Ø­Ø°Ù Ø¹Ø§Ø¯ÙŠ" onclick="return confirm('Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ');">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                    <a href="{{ url_for('hard_delete_bp.delete_sale', sale_id=sale.id) }}"
                       class="btn btn-sm btn-outline-danger" title="Ø­Ø°Ù Ù‚ÙˆÙŠ"
                       onclick="return confirm('Ø­Ø°Ù Ù‚ÙˆÙŠ - Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©!')">
                      <i class="fas fa-bomb"></i>
                    </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª -->
      <div id="sales-pagination-wrapper">
        {% if pagination and pagination.pages > 1 %}
        <nav class="mt-3">
          <ul class="pagination justify-content-center">
            {% if pagination.has_prev %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('sales_bp.list_sales', page=pagination.prev_num, **query_args) }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
              </li>
            {% endif %}
            {% for num in pagination.iter_pages() %}
              {% if num %}
                <li class="page-item {% if num == pagination.page %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('sales_bp.list_sales', page=num, **query_args) }}">{{ num }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">â€¦</span></li>
              {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('sales_bp.list_sales', page=pagination.next_num, **query_args) }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
              </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}
{% if not print_mode %}
<div class="modal fade" id="printSalesModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
      <form id="print-sales-form" method="get" action="{{ url_for('sales_bp.list_sales') }}" target="_blank">
        <div class="modal-body">
          <input type="hidden" name="print" value="1">
          {% for key, value in query_args.items() %}
          <input type="hidden" name="{{ key }}" value="{{ value }}">
          {% endfor %}
          <div class="form-group">
            <label class="d-block font-weight-bold mb-2">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</label>
            <div class="custom-control custom-radio mb-2">
              <input class="custom-control-input" type="radio" name="scope" id="print-scope-all" value="all" {% if print_scope == 'all' %}checked{% endif %}>
              <label class="custom-control-label" for="print-scope-all">ÙƒÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ({{ total_filtered }} ÙØ§ØªÙˆØ±Ø©)</label>
            </div>
            <div class="custom-control custom-radio mb-2">
              <input class="custom-control-input" type="radio" name="scope" id="print-scope-range" value="range" {% if print_scope == 'range' %}checked{% endif %}>
              <label class="custom-control-label" for="print-scope-range">ØªØ­Ø¯ÙŠØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙÙˆÙ</label>
            </div>
            <div class="custom-control custom-radio">
              <input class="custom-control-input" type="radio" name="scope" id="print-scope-page" value="page" {% if print_scope == 'page' %}checked{% endif %}>
              <label class="custom-control-label" for="print-scope-page">Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©</label>
            </div>
          </div>
          <div class="form-row" id="print-range-fields">
            <div class="form-group col">
              <label>Ù…Ù† Ø±Ù‚Ù…</label>
              <input type="number" class="form-control" name="range_start" min="1" max="{{ total_filtered if total_filtered else 1 }}" value="{{ range_start }}" {% if print_scope != 'range' %}disabled{% endif %}>
            </div>
            <div class="form-group col">
              <label>Ø¥Ù„Ù‰ Ø±Ù‚Ù…</label>
              <input type="number" class="form-control" name="range_end" min="1" max="{{ total_filtered if total_filtered else 1 }}" value="{{ range_end }}" {% if print_scope != 'range' %}disabled{% endif %}>
            </div>
          </div>
          <div class="form-group" id="print-page-fields">
            <label>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© (1 - {{ total_pages if total_pages else 1 }})</label>
            <input type="number" class="form-control" name="page_number" min="1" max="{{ total_pages if total_pages else 1 }}" value="{{ target_page }}" {% if print_scope != 'page' %}disabled{% endif %}>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary">Ø¹Ø±Ø¶ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if not print_mode %}
  <script>
    (function(){
      const form = document.getElementById('print-sales-form');
      if(!form) return;
      const scopeInputs = form.querySelectorAll('input[name="scope"]');
      const rangeInputs = form.querySelectorAll('#print-range-fields input');
      const pageInputs = form.querySelectorAll('#print-page-fields input');
      const toggleFields = () => {
        const selected = form.querySelector('input[name="scope"]:checked');
        const scope = selected ? selected.value : 'all';
        rangeInputs.forEach(inp => { inp.disabled = scope !== 'range'; if(scope !== 'range') inp.value = inp.getAttribute('value'); });
        pageInputs.forEach(inp => { inp.disabled = scope !== 'page'; if(scope !== 'page') inp.value = inp.getAttribute('value'); });
      };
      scopeInputs.forEach(inp => inp.addEventListener('change', toggleFields));
      toggleFields();
    })();
  </script>
  <script>
    (function(){
      function bindSortButtons() {
        const currentSort = new URL(window.location.href).searchParams.get('sort') || 'date';
        const currentOrder = new URL(window.location.href).searchParams.get('order') || 'desc';
        const sortButtons = document.querySelectorAll('.btn-sort');
        
        sortButtons.forEach(btn => {
          const sort = btn.dataset.sort;
          const order = btn.dataset.order;
          btn.classList.toggle('active', sort === currentSort && order === currentOrder);
          btn.onclick = handleSortClick;
        });
      }
      
      function handleSortClick(e) {
        e.preventDefault();
        const btn = e.currentTarget;
        const sort = btn.dataset.sort;
        const order = btn.dataset.order;
        console.log('Sort clicked:', sort, order);
        const url = new URL(window.location.href);
        url.searchParams.set('sort', sort);
        url.searchParams.set('order', order);
        url.searchParams.delete('page');
        url.searchParams.set('page', '1');
        console.log('URL:', url.toString());
        
        const salesTableWrapper = document.getElementById('sales-table-wrapper');
        const paginationWrapper = document.getElementById('sales-pagination-wrapper');
        const salesSummaryWrapper = document.getElementById('sales-summary-wrapper');
        const salesSearchSummary = document.getElementById('sales-search-summary');
        
        if(!salesTableWrapper) {
          window.location.href = url.toString();
          return;
        }
        
        url.searchParams.set('ajax', '1');
        const previousTable = salesTableWrapper.innerHTML;
        const previousPagination = paginationWrapper ? paginationWrapper.innerHTML : '';
        const previousSummary = salesSummaryWrapper ? salesSummaryWrapper.innerHTML : '';
        const tbody = salesTableWrapper.querySelector('tbody');
        
        if(tbody && typeof window.setLoading === 'function') {
          window.setLoading(tbody, true);
        }
        
        fetch(url.toString(), {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        })
        .then(res => {
          if(!res.ok) throw res;
          return res.json();
        })
        .then(data => {
          console.log('Received data:', data);
          if(typeof data.table_html === 'string') {
            salesTableWrapper.innerHTML = data.table_html;
          }
          if(paginationWrapper) {
            paginationWrapper.innerHTML = data.pagination_html || '';
          }
          if(salesSummaryWrapper) {
            salesSummaryWrapper.innerHTML = data.summary_html || '';
          }
          if(salesSearchSummary && typeof data.total_filtered === 'number') {
            salesSearchSummary.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${data.total_filtered}`;
          }
          
          bindSortButtons();
          
          if(typeof window.initSalesTable === 'function') {
            window.initSalesTable();
          }
          
          url.searchParams.delete('ajax');
          const qstr = url.searchParams.toString();
          const nextUrl = qstr ? `${url.pathname}?${qstr}` : url.pathname;
          window.history.replaceState({}, '', nextUrl);
        })
        .catch(() => {
          salesTableWrapper.innerHTML = previousTable;
          if(paginationWrapper) {
            paginationWrapper.innerHTML = previousPagination;
          }
          if(salesSummaryWrapper) {
            salesSummaryWrapper.innerHTML = previousSummary;
          }
          if(typeof window.showNotification === 'function') {
            window.showNotification('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'danger');
          } else {
            alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
          }
        });
      }
      
      bindSortButtons();
    })();
  </script>
  <script src="{{ url_for('static', filename='js/sales.js') }}"></script>
  {% endif %}
{% endblock %}
