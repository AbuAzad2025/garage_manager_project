<!-- File: templates/sales/receipt.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>فاتورة مبيعات - {{ sale.sale_number }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
  <style>
    @page { size: A4; margin: 0; }
    @media print { body { margin: 1cm; } .no-print { display: none !important; } }
    body{font-family:Arial, sans-serif;background:#f8f9fa;color:#333;line-height:1.7}
    .receipt{max-width:900px;margin:20px auto;background:#fff;border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 .75rem 1.5rem rgba(0,0,0,.08)}
    .receipt .header{display:flex;justify-content:space-between;gap:16px;padding:20px 24px;border-bottom:2px solid #111}
    .company{text-align:left}
    .company .logo{max-height:72px}
    .title{font-size:28px;margin:0;font-weight:800}
    .meta p{margin:.25rem 0}
    .block{padding:16px 24px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e5e7eb;padding:10px;text-align:center}
    thead th{background:#f1f3f5}
    tfoot td{background:#f8f9fa;font-weight:700}
    .notes{margin:16px 24px;background:#f8f9fa;border:1px dashed #ccc;border-radius:.5rem;padding:12px}
    .sign{display:flex;gap:24px;justify-content:space-between;margin:24px}
    .sign .box{flex:1;border-top:2px solid #111;text-align:center;padding-top:24px}
    .actions{padding:16px 24px;text-align:center}
    .btn{display:inline-block;margin:5px;padding:10px 16px;border-radius:8px;text-decoration:none}
    .btn-primary{background:#0d6efd;color:#fff}
    .btn-secondary{background:#6c757d;color:#fff}
  </style>
</head>
<body>
  <div class="receipt">
    <div class="header">
      <div>
        <h1 class="title">فاتورة مبيعات</h1>
        <div class="meta">
          <p><strong>رقم الفاتورة:</strong> {{ sale.sale_number }}</p>
          <p><strong>التاريخ:</strong> {{ sale.date.strftime('%Y-%m-%d') if sale.date else '—' }}</p>
        </div>
      </div>
      <div class="company">
        <img src="{{ url_for('static', filename='img/logo.png') }}" class="logo" alt="Logo">
        <p><strong>{{ config.SITE_NAME if config and config.SITE_NAME else 'شركتنا' }}</strong></p>
        <p>{{ config.SITE_ADDRESS if config and config.SITE_ADDRESS else '' }}</p>
        <p>{{ config.SITE_PHONE if config and config.SITE_PHONE else '' }}</p>
      </div>
    </div>
    <div class="block">
      <p><strong>اسم العميل:</strong> {{ sale.customer.name if sale.customer else '-' }}</p>
      <p><strong>هاتف العميل:</strong> {{ sale.customer.phone if sale.customer else '-' }}</p>
    </div>
    {% set ns = namespace(sub=0.0, tax=0.0, total=0.0) %}
    <div class="block">
      <table>
        <thead>
          <tr>
            <th>#</th><th>الصنف</th><th>المخزن</th><th>الكمية</th>
            <th>سعر الوحدة</th><th>خصم (%)</th><th>ضريبة (%)</th><th>الإجمالي</th>
          </tr>
        </thead>
        <tbody>
          {% for line in sale.lines %}
            {% set line_sub = (line.quantity or 0)*(line.unit_price or 0)*(1 - (line.discount_rate or 0)/100) %}
            {% set line_tax = line_sub * ((line.tax_rate or 0)/100) %}
            {% set line_total = line_sub + line_tax %}
            {% set ns.sub   = ns.sub + line_sub %}
            {% set ns.tax   = ns.tax + line_tax %}
            {% set ns.total = ns.total + line_total %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ line.product.name if line.product else '-' }}</td>
              <td>{{ line.warehouse.name if line.warehouse else '-' }}</td>
              <td>{{ line.quantity }}</td>
              <td>{{ '%.2f'|format(line.unit_price or 0) }} {{ sale.currency }}</td>
              <td>{{ line.discount_rate or 0 }}</td>
              <td>{{ line.tax_rate or 0 }}</td>
              <td>{{ '%.2f'|format(line_total) }} {{ sale.currency }}</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr><td colspan="7" class="text-end">المجموع الفرعي:</td><td>{{ '%.2f'|format(ns.sub) }} {{ sale.currency }}</td></tr>
          <tr><td colspan="7" class="text-end">الضريبة:</td><td>{{ '%.2f'|format(ns.tax) }} {{ sale.currency }}</td></tr>
          <tr><td colspan="7" class="text-end">الشحن:</td><td>{{ '%.2f'|format(sale.shipping_cost or 0) }} {{ sale.currency }}</td></tr>
          <tr><td colspan="7" class="text-end"><strong>الإجمالي النهائي:</strong></td><td><strong>{{ '%.2f'|format(ns.total + (sale.shipping_cost or 0)) }} {{ sale.currency }}</strong></td></tr>
        </tfoot>
      </table>
    </div>
    <div class="notes"><p><strong>ملاحظات:</strong> {{ sale.notes or 'لا توجد ملاحظات' }}</p></div>
    <div class="sign">
      <div class="box">توقيع البائع<br>الاسم: {{ sale.seller.username if sale.seller else '________' }}</div>
      <div class="box">توقيع العميل<br>الاسم: _____________</div>
    </div>
    <div class="actions no-print">
      <button onclick="window.print()" class="btn btn-primary"><i class="fas fa-print"></i> طباعة</button>
      <a href="{{ url_for('sales_bp.sale_detail', id=sale.id) }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> رجوع</a>
    </div>
  </div>
</body>
</html>
