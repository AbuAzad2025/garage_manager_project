{% extends "base_print.html" %}
{% block title %}ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª{% endblock %}

{% block head_extra %}
{% set _size = (request.args.get('s','a4')|lower) %}
{% set _ori  = (request.args.get('o','portrait')|lower) %}
{% if _size == 'a5' %}{% set W=148 %}{% set H=210 %}{% else %}{% set W=210 %}{% set H=297 %}{% endif %}
{% if _ori == 'landscape' %}{% set PW=H %}{% set PH=W %}{% else %}{% set PW=W %}{% set PH=H %}{% endif %}
{% set MT=12 %}{% set MR=12 %}{% set ML=12 %}{% set footer_h=14 %}
{% set MB = MT + footer_h %}
{% set content_w = PW - (ML + MR) %}

<style>
  @page { size: A4; margin: {{MT}}mm {{MR}}mm {{MB}}mm {{ML}}mm; }
  @media print { .no-print{display:none!important} }

  html,body{background:#fff;font-family:"DejaVu Sans","Amiri","Tahoma","Arial",sans-serif;direction:rtl;text-align:right;font-size:10px;line-height:1.3;margin:0;color:#000}
  #receipt{width:100%;max-width:{{content_w}}mm;margin:0 auto;box-sizing:border-box;padding-bottom:{{footer_h}}mm}

  .receipt-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{height:48px;object-fit:contain}
  .brand-name{font-weight:800;font-size:16px}
  .brand-sub{font-size:12px;color:#555}
  .brand-line{height:3px;background:linear-gradient(90deg,#0d6efd,#20c997);border-radius:6px;margin:6px 0 14px}

  .box{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:8px;page-break-inside:auto}

  table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:9px}
  thead{display:table-header-group}
  tfoot{display:table-footer-group}
  th,td{border:1px solid #d9d9d9;padding:3px 4px;vertical-align:middle;font-size:9px}
  thead th{background:#f3f6fb;border-color:#e6e6e6;font-weight:800;color:#394b6a;white-space:nowrap}
  .wrap{overflow-wrap:anywhere;word-break:normal;white-space:normal}
  .num{font-variant-numeric:tabular-nums;text-align:end}

  /* ØªÙˆØ²ÙŠØ¹ Ù†Ø³Ø¨ÙŠ 100% Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
  col.col-item{ width: 32%; }
  col.col-qty { width: 10%; }
  col.col-unit{ width: 14%; }
  col.col-disc{ width: 14%; }
  col.col-sum { width: 14%; }
  col.col-receiver{ width: 8%; }
  col.col-notes { width: 8%; }

  .kv th{width:38mm;background:#f8f9fa;color:#555;font-weight:700;white-space:nowrap}

  .sign-row{display:flex;gap:14px;margin-top:18px}
  .sign{flex:1;text-align:center;border-top:1px solid #bbb;padding-top:10px;min-height:40px}

  .receipt-footer{position:fixed;left:{{ML}}mm;right:{{MR}}mm;bottom:{{MT}}mm;height:{{footer_h}}mm;text-align:center;font-size:11px;border-top:1px solid #777;padding-top:3mm;background:transparent}

  @media print{
    html,body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .btn,nav,.navbar,.sidebar,.actions,a.no-print{display:none!important}
    a[href]:after{content:""!important}
    .receipt-header{break-inside:avoid;page-break-inside:avoid}
    table{page-break-inside:auto}
    tr{page-break-inside:avoid;page-break-after:auto}
    thead{display:table-header-group}
    tfoot{display:table-footer-group}
  }
  .totals-box{background:#f9fbff;border:1px solid #e0e6ef;border-radius:10px;padding:8px;margin-top:8px}
  .totals-title{font-size:12px;font-weight:800;color:#394b6a;margin-bottom:6px}
  .totals-list{width:100%;border-collapse:collapse}
  .totals-list th{width:60%;text-align:end;border:none;color:#555;background:transparent;font-weight:700}
  .totals-list td{width:40%;text-align:end;border:none;vertical-align:middle}
  .totals-list tr{border-bottom:1px dashed #d0d6e0}
  .totals-list tr:last-child{border-bottom:none}
  .totals-total td{font-weight:800;color:#0d6efd}
  .totals-words{margin-top:6px;font-size:11px;color:#394b6a}
  .totals-list .row-no-label td{width:100%;}
  .words-cell{text-align:start}
</style>
{% endblock %}

{% block content %}
<div id="receipt">
  <div class="receipt-header">
    <div class="brand">
      <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
      <div>
        <div class="brand-name">Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</div>
        <div class="brand-sub">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
      </div>
    </div>
    <div class="text-muted">
      Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <strong>{{ sale.sale_number or sale.id }}</strong><br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ sale.sale_date and sale.sale_date.strftime('%Y-%m-%d') or 'â€”' }}
    </div>
  </div>
  <div class="brand-line"></div>

  <div class="box">
    <table class="kv">
      <tr><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><td>{{ sale.customer.name  if sale.customer else 'â€”' }}</td></tr>
      <tr><th>Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</th><td>{{ sale.customer.phone if sale.customer else 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø¨Ø§Ø¦Ø¹</th><td>{% if sale.seller_employee %}{{ sale.seller_employee.name }}{% elif sale.seller %}{{ sale.seller.username }}{% else %}â€”{% endif %}</td></tr>
    </table>
  </div>

  <div class="box">
    <table>
      <colgroup>
        <col class="col-item"><col class="col-qty"><col class="col-unit"><col class="col-disc">
        <col class="col-sum"><col class="col-receiver"><col class="col-notes">
      </colgroup>
      <thead>
        <tr>
          <th>Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
          <th>Ø§Ù„Ø®ØµÙ…</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for item in lines %}
          {% set ln = item.obj %}
          <tr>
            <td class="wrap">{{ ln.product.name if ln.product else 'â€”' }}</td>
            <td class="num">{{ ln.quantity }}</td>
            <td class="num">{{ money_fmt(ln.unit_price) }} {{ sale.currency }}</td>
            <td class="num">
              {{ money_fmt(item.discount_amount) }} {{ sale.currency }}
              <div style="font-size:8px">{{ item.discount_rate_display }}%</div>
            </td>
            <td class="num">{{ money_fmt(item.line_total) }} {{ sale.currency }}</td>
            <td style="font-size:8px">{{ ln.line_receiver or 'â€”' }}</td>
            <td class="wrap" style="font-size:8px">{{ ln.note or 'â€”' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    <tfoot>
      <tr><td colspan="6" class="text-right"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong></td><td class="num"><strong>{{ money_fmt(grand_total) }} {{ sale.currency }}</strong></td></tr>
    </tfoot>
    </table>
  </div>

  <div class="totals-box">
    <div class="totals-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</div>
    <table class="totals-list">
      <tr><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th><td class="num">{{ money_fmt(subtotal) }} {{ sale.currency }}</td></tr>
      {% if sale_shipping and sale_shipping != 0 %}
      <tr><th>ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†</th><td class="num">{{ money_fmt(sale_shipping) }} {{ sale.currency }}</td></tr>
      {% endif %}
      <tr><th>Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><td class="num">{{ money_fmt(sale_discount_total) }} {{ sale.currency }}</td></tr>
      <tr><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th><td class="num">{{ money_fmt(subtotal_after_discount + sale_shipping) }} {{ sale.currency }}</td></tr>
      {% if invoice_tax_amount and invoice_tax_amount != 0 %}
      <tr><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th><td class="num">{{ "%.2f"|format(sale_tax_rate) }}%</td></tr>
      <tr><th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th><td class="num">{{ money_fmt(invoice_tax_amount) }} {{ sale.currency }}</td></tr>
      {% endif %}
      <tr class="totals-total"><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><td class="num">{{ money_fmt(grand_total) }} {{ sale.currency }}</td></tr>
    </table>
    <table class="totals-list" style="margin-top:6px">
      <tr><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø­Ø±ÙˆÙ</th><td class="words-cell"><strong>{{ grand_total|amount_in_words(sale.currency) }}</strong> <span class="text-muted">({{ currency_name_ar(sale.currency) }} ÙÙ‚Ø· Ù„Ø§ ØºÙŠØ±)</span></td></tr>
    </table>
  </div>

  <div class="box"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ sale.notes or 'â€”' }}</div>
  
  {% if sale.fx_rate_used and sale.fx_rate_used > 0 and sale.currency != 'ILS' %}
  <div class="box" style="background:#e3f2fd; border:1px solid #2196f3; border-radius:8px;">
    <strong>ğŸ’± Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> 
    1 {{ sale.currency }} = {{ "%.4f"|format(sale.fx_rate_used) }} ILS
    <small style="color:#666;">({{ sale.fx_rate_source or 'ØªÙ„Ù‚Ø§Ø¦ÙŠ' }} - {{ sale.fx_rate_timestamp.strftime('%Y-%m-%d') if sale.fx_rate_timestamp else 'Ø§Ù„ÙŠÙˆÙ…' }})</small>
  </div>
  {% endif %}

  <div class="sign-row">
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹<br><br>{{ sale.seller_employee.name if sale.seller_employee else (sale.seller.username if sale.seller else '________') }}</div>
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„<br><br>__________</div>
  </div>

  <div class="text-center mt-3 no-print">
    <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('sales_bp.sale_receipt', id=sale.id, simple=1) }}">ğŸ“„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©</a>
    <a class="btn btn-secondary" href="{{ url_for('sales_bp.sale_detail', id=sale.id) }}">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>
  </div>
</div>

<div class="receipt-footer">
  Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ â€” Ù†ØªØ´Ø±Ù Ø¨Ø®Ø¯Ù…ØªÙƒÙ… â€” Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† â€” Ø¬ÙˆØ§Ù„: 0592800646 â€” ÙˆØ§ØªØ³Ø§Ø¨: +970592800646
</div>
{% endblock %}
