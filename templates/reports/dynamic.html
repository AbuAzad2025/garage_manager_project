{% extends 'base.html' %}

{% block title %}ØªÙ‚Ø±ÙŠØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ{% endblock %}
{% block page_title %}ØªÙ‚Ø±ÙŠØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
<li class="breadcrumb-item active">ØªÙ‚Ø±ÙŠØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</li>
{% endblock %}

{% block content %}
<div class="container-fluid" dir="rtl">

  <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
  <div class="mb-3">
    <h4 class="fw-bold">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</h4>
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
    <div class="card-body">
      <form id="report-form" method="post" action="{{ url_for('reports_bp.dynamic_report') }}">
        {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}

        <div class="row g-3">
          <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
          <div class="col-md-3">
            <label class="form-label fw-semibold">Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
            <select name="table" id="table" class="form-select" required>
              {% for m in model_names %}
                <option value="{{ m }}" {% if selected_table == m %}selected{% endif %}>
                  {{ MODEL_LABELS.get(m, m) }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
          <div class="col-md-3">
            <label class="form-label fw-semibold">Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <select
              name="date_field"
              id="date_field"
              class="form-select"
              data-default="{{ defaults.get(selected_table) }}"
              data-selected="{{ date_field or '' }}"
            >
              <option value="">â€”</option>
            </select>
          </div>

          <!-- Ù…Ù† -->
          <div class="col-md-3">
            <label class="form-label fw-semibold">Ù…Ù†</label>
            <input type="date" name="start_date" value="{{ start_date or '' }}" class="form-control">
          </div>

          <!-- Ø¥Ù„Ù‰ -->
          <div class="col-md-3">
            <label class="form-label fw-semibold">Ø¥Ù„Ù‰</label>
            <input type="date" name="end_date" value="{{ end_date or '' }}" class="form-control">
          </div>

          <!-- Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© -->
          <div class="col-md-12">
            <label class="form-label fw-semibold">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</label>
            <select
              name="selected_fields"
              id="selected_fields"
              multiple
              size="8"
              class="form-select"
              data-selected='{{ (columns or [])|tojson }}'
            ></select>
          </div>

          <!-- ÙÙ„Ø§ØªØ± LIKE -->
          <div class="col-12">
            <label class="form-label fw-semibold">ÙÙ„Ø§ØªØ± LIKE</label>
            <div id="like_filters" class="row g-2" data-initial-like='{{ (like_filters or {})|tojson }}'></div>
          </div>

          <!-- Ø§Ù„Ø­Ø¯ -->
          <div class="col-md-2">
            <label class="form-label fw-semibold">Ø§Ù„Ø­Ø¯</label>
            <input type="number" name="limit" min="1" max="5000" value="{{ limit or 1000 }}" class="form-control">
          </div>

          <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
          <div class="col-12 d-flex gap-2 mt-3">
            <button class="btn btn-primary"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶</button>
            <button formaction="{{ url_for('reports_bp.export_dynamic_csv') }}" class="btn btn-outline-secondary">
              <i class="fas fa-file-csv"></i> ØªØµØ¯ÙŠØ± CSV
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
  {% if data %}
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table id="report-table" class="table table-striped table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              {% set header_cols = columns if columns else data[0].keys() %}
              {% for c in header_cols %}
                <th>{{ FIELD_LABELS.get(c, c) }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
              {% set row_cols = columns if columns else row.keys() %}
              <tr>
                {% for c in row_cols %}
                  {% set v = row.get(c) %}
                  <td class="text-nowrap">
                    {% if v is number %}
                      {{ "{:,.2f}".format(v) }}
                    {% else %}
                      {{ v if v is not none else "â€”" }}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
  {% if summary and summary|length %}
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-light fw-bold">ğŸ“Œ Ù…Ù„Ø®Øµ</div>
    <div class="card-body">
      <ul class="mb-0">
        {% for k,v in summary.items() %}
          <li><strong>{{ FIELD_LABELS.get(k, k) }}:</strong> {{ "{:,.2f}".format(v) if v is number else (v if v is not none else "â€”") }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  window.FIELD_LABELS = {{ FIELD_LABELS|tojson }};
  // ØªÙ…Ø±ÙŠØ± Ø¨Ø¹Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ù€ JS (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø³ÙƒØ±Ø¨ØªÙƒ ÙŠØ­ØªØ§Ø¬Ù‡Ø§)
  window.__selectedTable = "{{ selected_table or '' }}";
  window.__selectedDateField = "{{ date_field or '' }}";
  window.__selectedColumns = {{ (columns or [])|tojson }};
</script>
<script src="{{ url_for('static', filename='js/reporting.js') }}"></script>
{% endblock %}
