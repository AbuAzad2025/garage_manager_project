<!-- File: templates/reports/dynamic.html -->
{% extends 'base.html' %}
{% block title %}تقرير ديناميكي{% endblock %}
{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/reporting.css') }}">
{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">تقرير ديناميكي</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} mb-2">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form id="dynamic-form" class="row g-3" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="col-md-3">
      <label class="form-label">الجدول</label>
      <select name="table" id="table" class="form-select" required>
        {% for m in model_names %}
          <option value="{{ m }}" {% if selected_table==m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">حقل التاريخ (اختياري)</label>
      <select name="date_field" id="date_field" class="form-select">
        <option value="">—</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">من</label>
      <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">إلى</label>
      <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
    </div>

    <div class="col-12">
      <label class="form-label">الحقول</label>
      <select name="selected_fields" id="selected_fields" class="form-select" multiple size="8"></select>
      <small class="text-muted">اتركها فارغة لجلب كل الحقول.</small>
    </div>

    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary" type="submit"><i class="fas fa-filter"></i> تطبيق</button>
      {% if data %}
        <button class="btn btn-outline-secondary" formaction="{{ url_for('reports_bp.export_dynamic_csv') }}" formmethod="post"><i class="fas fa-file-csv"></i> تصدير CSV</button>
      {% endif %}
    </div>
  </form>

  {% if data %}
  <hr>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle" id="report-table">
      <thead class="table-light">
        <tr>
          {% for c in columns %}
            <th>{{ c }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in data %}
          <tr>
            {% for c in columns %}
              <td>{{ row.get(c) }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if summary %}
  <div class="mt-3">
    <h6>ملخص</h6>
    <pre class="bg-light p-2 border rounded">{{ summary | tojson(indent=2) }}</pre>
  </div>
  {% endif %}
  {% endif %}
</div>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/reporting.js') }}"></script>
{% endblock %}
