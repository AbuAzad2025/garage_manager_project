{% extends 'reports/_base.html' %}
{% block title %}أفضل المنتجات{% endblock %}
{% block page_title %}أفضل المنتجات{% endblock %}

{% block reports_breadcrumb_extra %}
<li class="breadcrumb-item active">{{ FIELD_LABELS.get("top_products", "أفضل المنتجات") }}</li>
{% endblock %}

{% block report_content %}
<div class="container-fluid" dir="rtl">
  <style>
    .rank-badge {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-weight: 700
    }

    .rank-1 {
      background: linear-gradient(90deg, #FFD700, #ffef9a);
      color: #5b4b00
    }

    .rank-2 {
      background: linear-gradient(90deg, #C0C0C0, #e9e9e9);
      color: #3f3f3f
    }

    .rank-3 {
      background: linear-gradient(90deg, #CD7F32, #e2a06b);
      color: #4b2a12
    }

    .mini-bar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: #e9ecef
    }

    .mini-bar>span {
      display: block;
      height: 100%
    }

    .table tfoot tr {
      background: #f8f9fa
    }

    #chartWrap {
      height: 360px;
      max-height: 360px;
      position: relative;
      background: #fff;
      padding: 1rem;
      border: 1px solid #dee2e6;
      border-radius: .5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .table-sticky thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #212529;
      color: #fff
    }

    @media print {
      .no-print {
        display: none !important
      }
    }
  </style>

  <div class="d-flex align-items-center justify-content-between mb-3 no-print">
    <h4 class="fw-bold m-0">
      <i class="fas fa-crown text-warning"></i>
      {{ FIELD_LABELS.get("top_products", "أفضل المنتجات") }}
    </h4>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-primary btn-sm" id="btn-export" onclick="exportTableToCSV('top_products_report.csv')">
        <i class="fas fa-file-csv"></i> تصدير CSV
      </button>
    </div>
  </div>

  <form class="card mb-3 no-print" method="get">
    <div class="card-body row g-3 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label">{{ FIELD_LABELS.get("start_date", "من") }}</label>
        <input type="date" class="form-control" name="start" value="{{ start }}">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">{{ FIELD_LABELS.get("end_date", "إلى") }}</label>
        <input type="date" class="form-control" name="end" value="{{ end }}">
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label">العدد</label>
        <input type="number" class="form-control" name="limit" min="1" max="1000" value="{{ limit }}">
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label">{{ FIELD_LABELS.get("warehouse", "المستودع") }}</label>
        <select class="custom-select" name="warehouse_id" {% if not can_group_by_warehouse %}disabled title="لا يتوفر ربط بالمستودع في هذا المخطط"{% endif %}>
          <option value="">الكل</option>
          {% for w in warehouses %}
          <option value="{{ w.id }}" {% if selected_warehouse_id and w.id == selected_warehouse_id %}selected{% endif %}>{{ w.name }}</option>
          {% endfor %}
        </select>
        {% if not can_group_by_warehouse %}
        <small class="text-muted d-block mt-1">التجميع حسب المستودع غير مدعوم حالياً</small>
        {% endif %}
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label d-block">تجميع حسب المستودع</label>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="gbw" name="group_by" value="warehouse" {% if group_by_warehouse %}checked{% endif %} {% if not can_group_by_warehouse %}disabled{% endif %}>
          <label class="form-check-label" for="gbw">{% if can_group_by_warehouse %}تفعيل{% else %}غير متاح{% endif %}</label>
        </div>
        {% if forced_grouping and can_group_by_warehouse %}
        <small class="text-muted">تم تفعيل التجميع تلقائياً لعرض مستودع محدد.</small>
        {% endif %}
      </div>
      <div class="col-12 d-flex gap-2 justify-content-end">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-sync-alt"></i> {{ FIELD_LABELS.get("refresh", "تحديث") }}
        </button>
        <a href="{{ url_for('reports_bp.top_products') }}" class="btn btn-light">مسح</a>
      </div>
    </div>
  </form>

  {% set total_qty = (data | sum(attribute='qty')) if data else 0 %}
  {% set total_rev = (data | sum(attribute='revenue')) if data else 0.0 %}
  {% set first = data[0] if data and data|length>0 else None %}
  {% set first_share = ((first.revenue/total_rev*100) if first and total_rev else 0) %}

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <span class="text-muted">عدد الصفوف</span>
          <span class="fs-5 fw-bold">{{ data|length }}</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <span class="text-muted">إجمالي الكمية</span>
          <span class="fs-5 fw-bold">{{ total_qty|format_number }}</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <span class="text-muted">إجمالي الإيراد</span>
          <span class="fs-5 fw-bold">{{ total_rev|format_number }}</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="rank-badge rank-1"><i class="fas fa-trophy"></i> الأول</div>
            <small class="text-muted">حصة الإيراد</small>
          </div>
          <div class="fw-bold">
            {{ first.name if first else "—" }}
            {% if group_by_warehouse and first and first.warehouse_name %}
            <span class="text-muted">— {{ first.warehouse_name }}</span>
            {% endif %}
          </div>
          <div class="mini-bar mt-2" title="{{ '%.2f' % first_share }}%">
            <span style="width: {{ '%.2f' % first_share }}%; background:#ffc107;"></span>
          </div>
          <div class="text-muted small mt-1">{{ '%.2f' % first_share }}%</div>
        </div>
      </div>
    </div>
  </div>

  {% set chart_labels = [] %}
  {% set chart_values = [] %}
  {% for r in data[:10] %}
    {% if group_by_warehouse %}
      {% set _ = chart_labels.append(r.name ~ ' — ' ~ (r.warehouse_name or '—')) %}
    {% else %}
      {% set _ = chart_labels.append(r.name) %}
    {% endif %}
    {% set _ = chart_values.append(r.revenue) %}
  {% endfor %}

  <div class="card shadow-sm mb-3 no-print">
    <div class="card-body">
      <h5 class="mb-3 text-center fw-bold">أعلى 10 منتجات حسب الإيراد</h5>
      <div id="chartWrap" class="mx-auto" style="max-width: 800px;">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

  {% set ns = namespace(cum=0) %}

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table id="report-table" class="table table-striped table-bordered table-hover table-sticky align-middle">
          <thead>
            <tr>
              <th style="width:120px">الترتيب</th>
              <th>{{ FIELD_LABELS.get("name", "المنتج") }}</th>
              {% if group_by_warehouse %}<th>{{ FIELD_LABELS.get("warehouse", "المستودع") }}</th>{% endif %}
              <th class="text-end">{{ FIELD_LABELS.get("qty", "الكمية") }}</th>
              <th class="text-end">{{ FIELD_LABELS.get("revenue", "الإيراد") }}</th>
              <th class="text-end">متوسط السعر</th>
              <th class="text-end">نسبة الإيراد</th>
              <th class="text-end">تراكمي %</th>
            </tr>
          </thead>
          <tbody>
            {% if data and data|length %}
              {% for r in data %}
                {% set rank = loop.index %}
                {% set share = (r.revenue/total_rev*100) if total_rev else 0 %}
                {% set avg = (r.revenue/r.qty) if r.qty else 0 %}
                {% set ns.cum = ns.cum + share %}
                <tr>
                  <td>
                    {% if rank == 1 %}
                      <span class="rank-badge rank-1"><i class="fas fa-trophy"></i> الأول</span>
                    {% elif rank == 2 %}
                      <span class="rank-badge rank-2"><i class="fas fa-medal"></i> الثاني</span>
                    {% elif rank == 3 %}
                      <span class="rank-badge rank-3"><i class="fas fa-medal"></i> الثالث</span>
                    {% else %}
                      <span class="badge bg-light text-dark">#{{ rank }}</span>
                    {% endif %}
                  </td>
                  <td>{{ r.name }}</td>
                  {% if group_by_warehouse %}<td>{{ r.warehouse_name or '—' }}</td>{% endif %}
                  <td class="text-end">{{ r.qty|format_number }}</td>
                  <td class="text-end">{{ r.revenue|format_number }}</td>
                  <td class="text-end">{{ avg|format_number }}</td>
                  <td class="text-end">{{ '%.2f' % share }}%</td>
                  <td class="text-end">{{ '%.2f' % ns.cum }}%</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{{ 7 + (1 if group_by_warehouse else 0) }}" class="text-center text-muted py-4">لا توجد بيانات ضمن النطاق المحدد.</td>
              </tr>
            {% endif %}
          </tbody>
          <tfoot>
            <tr class="fw-bold">
              <td colspan="{{ 2 + (1 if group_by_warehouse else 0) }}" class="text-end">الإجماليات</td>
              <td class="text-end">{{ total_qty|format_number }}</td>
              <td class="text-end">{{ total_rev|format_number }}</td>
              <td class="text-end">
                {% set avg_all = (total_rev/total_qty) if total_qty else 0 %}
                {{ avg_all|format_number }}
              </td>
              <td class="text-end">100.00%</td>
              <td class="text-end">100.00%</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
(function(){
  const labels = {{ chart_labels|tojson }};
  const values = {{ chart_values|tojson }};
  const el = document.getElementById('chart');
  if (el && labels.length){
    new Chart(el, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'الإيراد',
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0,
              callback: (val) => new Intl.NumberFormat('en-US').format(val)
            }
          },
          x: {
            ticks: {
              autoSkip: false,
              maxRotation: 45,
              minRotation: 0
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(ctx.parsed.y || 0)
            }
          }
        }
      }
    });
  }
})();
</script>
{% endblock %}
