{% extends 'reports/_base.html' %}
{% block title %}{{ FIELD_LABELS.get("service_reports", "تقارير الصيانة") }}{% endblock %}
{% block page_title %}{{ FIELD_LABELS.get("service_reports", "تقارير الصيانة") }}{% endblock %}

{% block reports_breadcrumb_extra %}
<li class="breadcrumb-item active">{{ FIELD_LABELS.get("service_reports", "تقارير الصيانة") }}</li>
{% endblock %}

{% block report_content %}
<div class="container-fluid" dir="rtl">

  

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      {{ FIELD_LABELS.get("date_range", "نطاق التاريخ") }}
    </div>
    <div class="card-body">
      <form class="row g-3" method="get" action="{{ url_for('reports_bp.service_reports') }}">
        <div class="col-md-3">
          <label class="form-label fw-semibold">{{ FIELD_LABELS.get("start_date", "من") }}</label>
          <input type="date" name="start" value="{{ start or '' }}" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">{{ FIELD_LABELS.get("end_date", "إلى") }}</label>
          <input type="date" name="end" value="{{ end or '' }}" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">الحالة</label>
          <select name="status" class="form-select">
            <option value="">الكل</option>
            {% for value,label in status_choices %}
            <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">الميكانيكي</label>
          <select name="mechanic_id" class="form-select">
            <option value="">جميع الفنيين</option>
            {% for mech in mechanics %}
            <option value="{{ mech.id }}" {% if selected_mechanic_id == mech.id %}selected{% endif %}>
              {{ mech.username }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">العميل</label>
          <select name="customer_id" class="form-select">
            <option value="">جميع العملاء</option>
            {% for cust in customers %}
            <option value="{{ cust.id }}" {% if selected_customer_id == cust.id %}selected{% endif %}>
              {{ cust.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3 align-self-end d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-fill">
            <i class="fas fa-sync-alt"></i> {{ FIELD_LABELS.get("refresh", "تحديث") }}
          </button>
          <a href="{{ url_for('reports_bp.service_reports') }}" class="btn btn-outline-secondary">
            <i class="fas fa-times"></i>
          </a>
        </div>
      </form>
    </div>
  </div>

  

  <div class="row g-3 mb-3">
    <div class="col-md-2">
      <div class="card summary-card h-100">
        <div class="card-body text-center">
          <div class="text-muted small">{{ FIELD_LABELS.get("total_requests", "عدد الطلبات") }}</div>
          <div class="fs-5 fw-bold">{{ total }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card summary-card h-100">
        <div class="card-body text-center">
          <div class="text-muted small">{{ FIELD_LABELS.get("completed", "مكتملة") }}</div>
          <div class="fs-5 fw-bold">{{ completed }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card summary-card h-100">
        <div class="card-body text-center">
          <div class="text-muted small">{{ FIELD_LABELS.get("revenue", "الإيراد") }}</div>
          <div class="fs-5 fw-bold {{ 'positive' if revenue < 0 else 'negative' if revenue > 0 else 'zero' }}">
            {{ "{:,.2f}".format(revenue) }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card summary-card h-100">
        <div class="card-body text-center">
          <div class="text-muted small">{{ FIELD_LABELS.get("parts", "قطع") }}</div>
          <div class="fs-5 fw-bold {{ 'positive' if parts < 0 else 'negative' if parts > 0 else 'zero' }}">
            {{ "{:,.2f}".format(parts) }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card summary-card h-100">
        <div class="card-body text-center">
          <div class="text-muted small">{{ FIELD_LABELS.get("labor", "أجور") }}</div>
          <div class="fs-5 fw-bold {{ 'positive' if labor < 0 else 'negative' if labor > 0 else 'zero' }}">
            {{ "{:,.2f}".format(labor) }}
          </div>
        </div>
      </div>
    </div>
  </div>

  

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-end mb-3">
        <a class="btn btn-outline-success btn-sm"
           href="{{ url_for('reports_bp.service_reports', start=start, end=end, status=selected_status, mechanic_id=selected_mechanic_id, customer_id=selected_customer_id, format='csv') }}">
          <i class="fas fa-file-csv"></i> تصدير CSV
        </a>
      </div>
      {% if not data %}
        <div class="alert alert-info m-0">لا توجد بيانات لعرضها.</div>
      {% else %}
      <div class="table-responsive">
        <table id="report-table" class="table table-striped table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>{{ FIELD_LABELS.get("number", "رقم") }}</th>
              <th>{{ FIELD_LABELS.get("status", "الحالة") }}</th>
              <th>{{ FIELD_LABELS.get("priority", "الأولوية") }}</th>
              <th>{{ FIELD_LABELS.get("received_at", "تاريخ الاستلام") }}</th>
              <th>{{ FIELD_LABELS.get("customer_id", "العميل") }}</th>
              <th>{{ FIELD_LABELS.get("mechanic_id", "الميكانيكي") }}</th>
              <th class="text-end">{{ FIELD_LABELS.get("total", "الإجمالي") }}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in data %}
              <tr>
                <td>{{ r.number }}</td>
                <td>
                  {% if r.status == 'COMPLETED' %}<span class="badge bg-success">مكتملة</span>
                  {% elif r.status == 'IN_PROGRESS' %}<span class="badge bg-primary">قيد التنفيذ</span>
                  {% elif r.status == 'PENDING' %}<span class="badge bg-warning">معلقة</span>
                  {% elif r.status == 'CANCELLED' %}<span class="badge bg-danger">ملغاة</span>
                  {% else %}{{ r.status }}{% endif %}
                </td>
                <td>
                  {% if r.priority == 'URGENT' %}<span class="badge bg-danger">عاجل</span>
                  {% elif r.priority == 'HIGH' %}<span class="badge bg-warning">عالية</span>
                  {% elif r.priority == 'MEDIUM' %}<span class="badge bg-info">متوسطة</span>
                  {% elif r.priority == 'LOW' %}<span class="badge bg-secondary">منخفضة</span>
                  {% else %}{{ r.priority }}{% endif %}
                </td>
                <td>{{ r.received_at[:10] if r.received_at else '-' }}</td>
                <td>{{ r.customer_name }}</td>
                <td>{{ r.mechanic_name or '-' }}</td>
                <td class="text-end">{{ "{:,.2f}".format(r.total or 0) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
