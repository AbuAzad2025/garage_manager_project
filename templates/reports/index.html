{% extends 'base.html' %}
{% block title %}Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endblock %}
{% block page_title %}Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
<li class="breadcrumb-item active">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</li>
{% endblock %}

{% block content %}
<div class="container-fluid" dir="rtl">

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
  <div class="card report-form mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</span>
      <div class="btn-group">
        <button type="submit" form="report-form" class="btn btn-primary btn-sm">
          <i class="fas fa-filter"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
        </button>
        <button type="reset" form="report-form" class="btn btn-secondary btn-sm">
          <i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
        </button>
        <button type="submit" form="report-form"
                formaction="{{ url_for('reports_bp.export_dynamic_csv') }}"
                formmethod="post"
                class="btn btn-success btn-sm">
          <i class="fas fa-file-csv"></i> ØªØµØ¯ÙŠØ± CSV
        </button>
        <button type="button" class="btn btn-outline-dark btn-sm" onclick="window.print()">
          <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
        </button>
      </div>
    </div>

    <div class="card-body">
      <form id="report-form"
            action="{{ url_for('reports_bp.dynamic_report') }}"
            method="post"
            class="row g-3">
        {% if csrf_token is defined %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„Ø¬Ø¯ÙˆÙ„ / Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
          <select name="table" id="table" class="form-select" required>
            {% for m in model_names or [] %}
              <option value="{{ m }}" {{ 'selected' if m == (selected_table or '') else '' }}>
                {{ MODEL_LABELS.get(m, m) }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
        <div class="col-md-3">
          <label class="form-label">Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <select name="date_field" id="date_field" class="form-select" data-default="{{ defaults.get(selected_table) }}">
            <option value="">â€”</option>
            {% if date_fields %}
              {% for d in date_fields %}
              <option value="{{ d }}" {{ 'selected' if d == (request.form.get('date_field') or '') else '' }}>
                {{ FIELD_LABELS.get(d, d) }}
              </option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

        <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
        <div class="col-md-3">
          <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© -->
        <div class="col-12">
          <label class="form-label">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</label>
          <select name="selected_fields" id="selected_fields" class="form-select" multiple size="6"></select>
          <div class="form-text">
            Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¹Ø±Ø¶Ù‡Ø§. Ø¥Ù† ØªØ±ÙƒØªÙ‡Ø§ ÙØ§Ø±ØºØ© Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.
          </div>
        </div>

        <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label mb-0">ÙÙ„Ø§ØªØ± Ø¥Ø¶Ø§ÙÙŠØ©</label>
            <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#advFilters">
              Ø¥Ø¸Ù‡Ø§Ø± / Ø¥Ø®ÙØ§Ø¡
            </button>
          </div>
          <div id="advFilters" class="collapse show mt-2">
            <div id="like_filters"
                 class="row g-2"
                 data-initial-like='{{ (like_filters or {})|tojson }}'></div>
            <div class="form-text">Ø§Ù„ÙÙ„Ø§ØªØ± ØªÙØ·Ø¨Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ (contains).</div>
          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„Ø®Øµ -->
  {% if summary %}
  <div class="row" id="summary-cards">
    {% for k,v in summary.items() %}
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card text-center h-100 shadow-sm">
          <div class="card-body">
            <div class="text-muted small">{{ FIELD_LABELS.get(k, k) }}</div>
            <div class="fs-4 fw-bold">
              {% if v is number %}
                {{ "{:,.2f}".format(v) }}
              {% else %}
                {{ v }}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
  <div class="card">
    <div class="card-header">ğŸ“‹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
    <div class="card-body">
      {% if data and (columns or (data|length > 0 and data[0].keys())) %}
        {% set hdr = columns if columns else data[0].keys() %}
        <div class="table-responsive">
          <table id="report-table" class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
              <tr>
                {% for c in hdr %}
                  <th>{{ FIELD_LABELS.get(c, c) }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in data %}
              <tr>
                {% for c in hdr %}
                  {% set val = row.get(c) %}
                  <td class="{{ 'text-end' if (val is number) else '' }}">
                    {% if val is number %}
                      {{ "{:,.2f}".format(val) }}
                    {% else %}
                      {{ val if val is not none else 'â€”' }}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reporting.css') }}">
{% endblock %}

{% block scripts %}
<script>
  window.FIELD_LABELS = {{ FIELD_LABELS|tojson }};
</script>
<script src="{{ url_for('static', filename='js/reporting.js') }}"></script>
{% endblock %}
