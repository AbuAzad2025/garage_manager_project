{% extends "base.html" %}

{% block title %}ÙƒØ´Ù Ù…ÙØµÙ„ Ù„Ù„Ø¹Ù…ÙŠÙ„ - {{ customer.name }}{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-user text-primary ml-2"></i>
            ÙƒØ´Ù Ù…ÙØµÙ„ Ù„Ù„Ø¹Ù…ÙŠÙ„: {{ customer.name }}
        </h2>
        <div class="btn-group">
            <a href="{{ url_for('reports_bp.customers_report') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right ml-1"></i>
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            </a>
        </div>
    </div>

    

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle ml-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ customer.name }}<br>
                            <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ customer.phone or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}<br>
                            <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> {{ customer.email or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                        </div>
                        <div class="col-sm-6">
                            <strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> 
                            <span class="badge {% if current_balance > 0 %}bg-success{% elif current_balance < 0 %}bg-danger{% else %}bg-secondary{% endif %} fs-6">
                                {{ current_balance|format_currency }}
                            </span><br>
                            <strong>Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†:</strong> {{ customer.credit_limit|format_currency if customer.credit_limit else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}<br>
                            <strong>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…:</strong> {{ customer.discount_rate or 0 }}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar ml-2"></i>Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</h5>
                </div>
                <div class="card-body">
                    {% if balance_data and balance_data.success %}
                    <div class="row text-center g-3 mb-3">
                        <div class="col-6 col-lg-4">
                            <div class="p-2 border rounded">
                                <strong class="text-success d-block">ğŸŸ¢ Ø§Ù„Ø­Ù‚ÙˆÙ‚</strong>
                                <span class="fs-5 fw-bold text-success">{{ balance_data.rights.total|format_currency }}</span>
                            </div>
                        </div>
                        <div class="col-6 col-lg-4">
                            <div class="p-2 border rounded">
                                <strong class="text-danger d-block">ğŸ”´ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</strong>
                                <span class="fs-5 fw-bold text-danger">{{ balance_data.obligations.total|format_currency }}</span>
                            </div>
                        </div>
                        <div class="col-12 col-lg-4">
                            <div class="p-2 border rounded">
                                <strong class="text-primary d-block">ğŸ¯ Ø§Ù„Ø±ØµÙŠØ¯</strong>
                                <span class="fs-4 fw-bold {% if balance_data.balance.amount > 0 %}text-danger{% elif balance_data.balance.amount < 0 %}text-success{% else %}text-secondary{% endif %}">
                                    {{ balance_data.balance.amount|format_currency }}
                                </span>
                                <small class="text-muted d-block">{{ balance_data.balance.action }}</small>
                            </div>
                        </div>
                        <div class="col-6 col-lg-6">
                            <div class="p-2 border rounded">
                                <strong class="text-info d-block">ğŸ’° Ù‚Ø¨Ø¶Ù†Ø§ Ù…Ù†Ù‡</strong>
                                <span class="fs-5 fw-bold text-info">{{ balance_data.payments.received|format_currency }}</span>
                            </div>
                        </div>
                        <div class="col-6 col-lg-6">
                            <div class="p-2 border rounded">
                                <strong class="text-warning d-block">ğŸ’¸ Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡</strong>
                                <span class="fs-5 fw-bold text-warning">{{ balance_data.payments.paid|format_currency }}</span>
                            </div>
                        </div>
                    </div>
                    <hr class="my-2">
                    {% endif %}
                    <div class="row text-center g-3">
                        <div class="col-6 col-lg-4">
                            <strong class="text-success d-block">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</strong>
                            <span class="fs-5">{{ total_sales|format_currency }}</span>
                        </div>
                        <div class="col-6 col-lg-4">
                            <strong class="text-primary d-block">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</strong>
                            <span class="fs-5">{{ total_invoices|format_currency }}</span>
                        </div>
                        <div class="col-6 col-lg-4">
                            <strong class="text-warning d-block">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©</strong>
                            <span class="fs-5">{{ total_services|format_currency }}</span>
                        </div>
                        <div class="col-6 col-lg-4">
                            <strong class="text-info d-block">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</strong>
                            <span class="fs-5">{{ total_payments|format_currency }}</span>
                        </div>
                        <div class="col-6 col-lg-4">
                            <strong class="text-secondary d-block">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©</strong>
                            <span class="fs-5">{{ total_preorders|format_currency }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="col-md-4">
                    <label for="start" class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" class="form-control" id="start" name="start" value="{{ start_date }}">
                </div>
                <div class="col-md-4">
                    <label for="end" class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" class="form-control" id="end" name="end" value="{{ end_date }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary ml-2">
                        <i class="fas fa-search ml-1"></i>ØªØµÙÙŠØ©
                    </button>
                    <a href="{{ url_for('reports_bp.customer_detail_report', customer_id=customer.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times ml-1"></i>Ø¥Ù„ØºØ§Ø¡
                    </a>
                </div>
            </form>
        </div>
    </div>

    

    {% if balance_data and balance_data.success %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-scale-balanced ml-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</h5>
            <small class="text-muted">{{ balance_data.balance.formula }}</small>
        </div>
        <div class="card-body">
            <div class="row gy-4">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-success mb-0">ğŸŸ¢ Ø§Ù„Ø­Ù‚ÙˆÙ‚</h6>
                        <span class="badge bg-success text-white">{{ balance_data.rights.total|format_currency }}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless align-middle mb-0">
                            <tbody>
                                {% for item in balance_data.rights.items %}
                                    {% if item.amount %}
                                    <tr>
                                        <td>{{ item.label }}</td>
                                        <td class="text-end text-success fw-semibold">{{ item.amount|format_currency }}</td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-danger mb-0">ğŸ”´ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</h6>
                        <span class="badge bg-danger text-white">{{ balance_data.obligations.total|format_currency }}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless align-middle mb-0">
                            <tbody>
                                {% for item in balance_data.obligations.items %}
                                    {% if item.amount %}
                                    <tr>
                                        <td>{{ item.label }}</td>
                                        <td class="text-end text-danger fw-semibold">{{ item.amount|format_currency }}</td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row mt-4 g-3">
                <div class="col-md-4">
                    <div class="alert alert-secondary mb-0">
                        <div class="small text-muted">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</div>
                        <div class="fw-bold">{{ balance_data.opening_balance.amount|format_currency }}</div>
                        <small class="text-muted">{{ balance_data.opening_balance.direction }}</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info mb-0">
                        <div class="small text-muted">Ø´ÙŠÙƒØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„</div>
                        <div class="fw-bold">{{ balance_data.checks.in_progress|format_currency }}</div>
                        <small class="text-muted">Ø´ÙŠÙƒØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„: {{ balance_data.checks.outstanding|format_currency }}</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-light border mb-0">
                        <div class="small text-muted">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                        <div class="fw-bold {% if balance_data.balance.amount > 0 %}text-danger{% elif balance_data.balance.amount < 0 %}text-success{% else %}text-secondary{% endif %}">
                            {{ balance_data.balance.amount|format_currency }}
                        </div>
                        <small class="text-muted">{{ balance_data.balance.action }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    

    {% if sales %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-shopping-cart ml-2"></i>
                Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ({{ sales|length }} Ø¹Ù…Ù„ÙŠØ©)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ¹</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in sales %}
                        <tr>
                            <td>{{ sale.sale_number or sale.id }}</td>
                            <td>{{ sale.sale_date.strftime('%Y-%m-%d') if sale.sale_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>
                                <span class="badge bg-{% if sale.status == 'CONFIRMED' %}success{% elif sale.status == 'PENDING' %}warning{% else %}secondary{% endif %}">
                                    {{ sale.status }}
                                </span>
                            </td>
                            <td>{{ sale.payment_method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>{{ sale.total_amount|format_currency }}</td>
                            <td>{{ sale.currency or 'ILS' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    

    {% if invoices %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-file-invoice ml-2"></i>
                Ø§Ù„ÙÙˆØ§ØªÙŠØ± ({{ invoices|length }} ÙØ§ØªÙˆØ±Ø©)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr>
                            <td>{{ invoice.invoice_number or invoice.id }}</td>
                            <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') if invoice.invoice_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>
                                
                                {% if invoice.cancelled_at %}
                                    <span class="badge bg-dark">Ù…Ù„ØºØ§Ø©</span>
                                {% elif invoice.status == 'PAID' %}
                                    <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹Ø©</span>
                                {% elif invoice.status == 'PARTIAL' %}
                                    <span class="badge bg-warning">Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>
                                {% else %}
                                    <span class="badge bg-danger">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</span>
                                {% endif %}
                            </td>
                            <td>{{ invoice.total_amount|format_currency }}</td>
                            <td>{{ invoice.total_paid|format_currency }}</td>
                            <td>{{ (invoice.total_amount - invoice.total_paid)|format_currency }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    

    {% if services %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-tools ml-2"></i>
                Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© ({{ services|length }} Ø·Ù„Ø¨)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                            <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th>
                            <th>Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ</th>
                            <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in services %}
                        <tr>
                            <td>{{ service.id }}</td>
                            <td>{{ service.received_at.strftime('%Y-%m-%d') if service.received_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>
                                <span class="badge bg-{% if service.priority == 'HIGH' %}danger{% elif service.priority == 'MEDIUM' %}warning{% else %}info{% endif %}">
                                    {{ service.priority }}
                                </span>
                            </td>
                            <td>{{ service.mechanic_id or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>{{ service.service_cost|format_currency }}</td>
                            <td>
                                <span class="badge bg-{% if service.status == 'COMPLETED' %}success{% elif service.status == 'IN_PROGRESS' %}warning{% else %}secondary{% endif %}">
                                    {{ service.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    

    {% if payments %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-credit-card ml-2"></i>
                Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ({{ payments|length }} Ø¯ÙØ¹Ø©)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.id }}</td>
                            <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>{{ payment.method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>{{ payment.total_amount|format_currency }}</td>
                            <td>
                                <span class="badge bg-{% if payment.status == 'COMPLETED' %}success{% elif payment.status == 'PENDING' %}warning{% else %}danger{% endif %}">
                                    {{ payment.status }}
                                </span>
                            </td>
                            <td>{{ payment.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    

    {% if preorders %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
                <i class="fas fa-shopping-bag ml-2"></i>
                Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© ({{ preorders|length }} Ø·Ù„Ø¨)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for preorder in preorders %}
                        <tr>
                            <td>{{ preorder.id }}</td>
                            <td>{{ preorder.created_at.strftime('%Y-%m-%d') if preorder.created_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            <td>{{ preorder.total_amount|format_currency }}</td>
                            <td>
                                <span class="badge bg-{% if preorder.status == 'CONFIRMED' %}success{% elif preorder.status == 'PENDING' %}warning{% else %}secondary{% endif %}">
                                    {{ preorder.status }}
                                </span>
                            </td>
                            <td>{{ preorder.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    

    {% if not sales and not invoices and not services and not payments and not preorders %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h5>
            <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>
        </div>
    </div>
    {% endif %}

{% endblock %}
