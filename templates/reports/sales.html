{% extends 'reports/_base.html' %}

{% block page_title %}تقرير المبيعات الشامل{% endblock %}
{% block reports_breadcrumb_extra %}
<li class="breadcrumb-item active">تقرير المبيعات</li>
{% endblock %}

{% block report_content %}
<div class="container-fluid" dir="rtl">

<div class="mb-3">
  <h4 class="fw-bold m-0"><i class="fas fa-shopping-cart"></i> تقرير المبيعات الشامل</h4>
</div>
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="card summary-card border-primary h-100">
      <div class="card-body text-center">
        <div class="text-primary mb-2"><i class="fas fa-shopping-cart fa-2x"></i></div>
        <h3 class="mb-0 text-primary">{{ summary.total_sales }}</h3>
        <small class="text-muted">عدد المبيعات</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card summary-card border-success h-100">
      <div class="card-body text-center">
        <div class="text-success mb-2"><i class="fas fa-dollar-sign fa-2x"></i></div>
        <h5 class="mb-0 text-success">{{ "{:,.2f}".format(summary.total_revenue) }} ₪</h5>
        <small class="text-muted">إجمالي الإيرادات</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card summary-card border-info h-100">
      <div class="card-body text-center">
        <div class="text-info mb-2"><i class="fas fa-chart-line fa-2x"></i></div>
        <h5 class="mb-0 text-info">{{ "{:,.2f}".format(summary.avg_sale) }} ₪</h5>
        <small class="text-muted">متوسط الفاتورة</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card summary-card border-warning h-100">
      <div class="card-body text-center">
        <div class="text-warning mb-2"><i class="fas fa-boxes fa-2x"></i></div>
        <h3 class="mb-0 text-warning">{{ summary.total_items }}</h3>
        <small class="text-muted">عدد الأصناف</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card summary-card border-danger h-100">
      <div class="card-body text-center">
        <div class="text-danger mb-2"><i class="fas fa-cubes fa-2x"></i></div>
        <h3 class="mb-0 text-danger">{{ summary.total_quantity }}</h3>
        <small class="text-muted">إجمالي الكميات</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card summary-card border-secondary h-100">
      <div class="card-body text-center">
        <div class="text-secondary mb-2"><i class="fas fa-star fa-2x"></i></div>
        <h5 class="mb-0">{{ "{:,.2f}".format(summary.avg_item_value) }} ₪</h5>
        <small class="text-muted">متوسط قيمة الصنف</small>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-header bg-info text-white">
    <i class="fas fa-filter"></i> فلاتر التقرير
  </div>
  <div class="card-body">
    <form method="get" class="row g-3">
<div class="col-md-3">
  <label class="form-label"><i class="fas fa-calendar"></i> من تاريخ</label>
  <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}" class="form-control">
</div>
<div class="col-md-3">
  <label class="form-label"><i class="fas fa-calendar"></i> إلى تاريخ</label>
  <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}" class="form-control">
</div>
<div class="col-md-3">
  <label class="form-label"><i class="fas fa-user"></i> العميل</label>
  <select name="customer_id" class="form-select">
    <option value="">جميع العملاء</option>
    {% for cust in all_customers %}
    <option value="{{ cust.id }}" {% if request.args.get('customer_id') == cust.id|string %}selected{% endif %}>{{ cust.name }}</option>
    {% endfor %}
  </select>
</div>
<div class="col-md-3">
  <label class="form-label"><i class="fas fa-tag"></i> الحالة</label>
  <select name="status" class="form-select">
    <option value="">جميع الحالات</option>
    <option value="CONFIRMED" {% if request.args.get('status') == 'CONFIRMED' %}selected{% endif %}>مؤكد</option>
    <option value="PENDING" {% if request.args.get('status') == 'PENDING' %}selected{% endif %}>معلق</option>
    <option value="CANCELLED" {% if request.args.get('status') == 'CANCELLED' %}selected{% endif %}>ملغي</option>
  </select>
</div>
<div class="col-md-3">
  <label class="form-label"><i class="fas fa-user-tie"></i> البائع (الموظف)</label>
  <select name="employee_id" class="form-select">
    <option value="">جميع الموظفين</option>
    {% for emp in employees %}
    <option value="{{ emp.id }}" {% if selected_employee_id and selected_employee_id == emp.id %}selected{% endif %}>{{ emp.name }}</option>
    {% endfor %}
  </select>
</div>
<div class="col-md-12">
  <button type="submit" class="btn btn-primary">
    <i class="fas fa-sync-alt"></i> تحديث
  </button>
</div>
</form>
</div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0"><i class="fas fa-list"></i> قائمة المبيعات التفصيلية</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-striped table-hover" id="salesTable">
        <thead class="table-dark">
<tr>
  <th class="text-center">#</th>
  <th>رقم الفاتورة</th>
  <th>التاريخ</th>
  <th>العميل</th>
  <th class="text-center">عدد الأصناف</th>
  <th class="text-end">الإجمالي</th>
  <th class="text-center">الحالة</th>
  <th class="text-center">البائع</th>
  <th class="text-center no-print">إجراءات</th>
</tr>
</thead>
<tbody>
{% for sale in sales %}
<tr>
  <td class="text-center">{{ loop.index }}</td>
  <td>
    <strong>{{ sale.sale_number }}</strong>
  </td>
  <td>
    {{ sale.sale_date.strftime('%Y-%m-%d %H:%M') if sale.sale_date else '-' }}
  </td>
  <td>
    {% if sale.customer %}
    <strong>{{ sale.customer.name }}</strong>
    {% if sale.customer.phone %}
    <br><small class="text-muted"><i class="fas fa-phone"></i> {{ sale.customer.phone }}</small>
    {% endif %}
    {% else %}
    <span class="text-muted">بدون عميل</span>
    {% endif %}
  </td>
  <td class="text-center">
    <span class="badge bg-info">{{ sale.lines|length }}</span>
  </td>
  <td class="text-end">
    <strong>{{ "{:,.2f}".format(sale.total_amount) }} ₪</strong>
  </td>
  <td class="text-center">
    {% if sale.status.value == 'CONFIRMED' %}
    <span class="badge bg-success">مؤكد</span>
    {% elif sale.status.value == 'PENDING' %}
    <span class="badge bg-warning">معلق</span>
    {% elif sale.status.value == 'CANCELLED' %}
    <span class="badge bg-danger">ملغي</span>
    {% else %}
    <span class="badge bg-secondary">{{ sale.status.value }}</span>
    {% endif %}
  </td>
  <td class="text-center">
    {% if sale.seller_employee %}
      <small>{{ sale.seller_employee.name }}</small>
    {% elif sale.seller %}
      <small>{{ sale.seller.username }}</small>
    {% else %}
      <span class="text-muted">-</span>
    {% endif %}
  </td>
  <td class="text-center no-print">
    <a href="{{ url_for('sales_bp.sale_detail', id=sale.id) }}" 
       class="btn btn-info btn-sm" 
       title="التفاصيل">
      <i class="fas fa-eye"></i>
    </a>
  </td>
</tr>
{% endfor %}
{% if not sales %}
<tr>
  <td colspan="9" class="text-center text-muted">لا توجد بيانات</td>
</tr>
{% endif %}
</tbody>
<tfoot>
<tr class="table-success fw-bold">
  <td colspan="4" class="text-center">الإجماليات</td>
  <td class="text-center">{{ summary.total_items }}</td>
  <td class="text-end">{{ "{:,.2f}".format(summary.total_revenue) }} ₪</td>
  <td colspan="3"></td>
</tr>
</tfoot>
</table>
</div>
</div>
</div>

</div>
<div class="row g-3 mt-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> المبيعات اليومية</h5>
      </div>
      <div class="card-body">
        <canvas id="dailySalesChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-trophy"></i> أفضل 5 منتجات</h5>
      </div>
      <div class="card-body">
        <canvas id="topProductsChart"></canvas>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script type="application/json" id="daily-sales-data">{{ daily_sales|tojson|safe }}</script>
<script type="application/json" id="top-products-data">{{ top_products|tojson|safe }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const dailyCtx = document.getElementById('dailySalesChart');
  if (dailyCtx && typeof Chart !== 'undefined') {
    let dailyData = [];
    try {
      const dailyEl = document.getElementById('daily-sales-data');
      if (dailyEl) {
        dailyData = JSON.parse(dailyEl.textContent || '[]');
      }
    } catch (e) {
      dailyData = [];
    }
    const dailyLabels = dailyData.map(d => d.date);
    const dailyValues = dailyData.map(d => d.total);
    new Chart(dailyCtx, {
      type: 'line',
      data: {
        labels: dailyLabels,
        datasets: [{
          label: 'المبيعات',
          data: dailyValues,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0, 123, 255, 0.1)',
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  const topProductsCtx = document.getElementById('topProductsChart');
  if (topProductsCtx && typeof Chart !== 'undefined') {
    let topProducts = [];
    try {
      const topEl = document.getElementById('top-products-data');
      if (topEl) {
        topProducts = JSON.parse(topEl.textContent || '[]');
      }
    } catch (e) {
      topProducts = [];
    }
    const productLabels = topProducts.map(p => p.name);
    const productQuantities = topProducts.map(p => p.quantity);
    new Chart(topProductsCtx, {
      type: 'bar',
      data: {
        labels: productLabels,
        datasets: [{
          label: 'الكمية المباعة',
          data: productQuantities,
          backgroundColor: '#28a745'
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        scales: {
          x: {
            beginAtZero: true
          }
        }
      }
    });
  }
});
</script>
{% endblock %}

