{# templates/reports/payments_summary.html #}
{% extends 'reports/_base.html' %}
{% block title %}{{ FIELD_LABELS['payments_summary'] }}{% endblock %}
{% block page_title %}{{ FIELD_LABELS['payments_summary'] }}{% endblock %}

{% block reports_breadcrumb_extra %}
<li class="breadcrumb-item active">{{ FIELD_LABELS.get("payments_summary", "ملخص المدفوعات") }}</li>
{% endblock %}

{% block report_content %}
<div class="container-fluid" dir="rtl">

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h4 class="fw-bold m-0"><i class="fas fa-wallet"></i> {{ FIELD_LABELS['payments_summary'] }}</h4>
    <form action="{{ url_for('reports_bp.payments_summary') }}" method="get" class="row g-2 align-items-end">
      <div class="col-auto">
        <label for="start" class="form-label">{{ FIELD_LABELS['start_date'] }}</label>
        <input type="date" id="start" name="start" class="form-control form-control-sm" value="{{ start }}">
      </div>
      <div class="col-auto">
        <label for="end" class="form-label">{{ FIELD_LABELS['end_date'] }}</label>
        <input type="date" id="end" name="end" class="form-control form-control-sm" value="{{ end }}">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="fas fa-sync-alt"></i> {{ FIELD_LABELS['refresh'] }}
        </button>
      </div>
    </form>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small">{{ FIELD_LABELS['grand_total'] }}</div>
            <div class="fs-4 fw-bold">{{ '%.2f' % (grand_total or 0) }}</div>
          </div>
          <div class="display-6">💵</div>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">{{ FIELD_LABELS['date_range'] }}</div>
          <div class="fw-semibold">{{ start or '—' }} — {{ end or '—' }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header">{{ FIELD_LABELS['payments_summary'] }}</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th style="width:60%">{{ FIELD_LABELS['payment_method'] }}</th>
                  <th class="text-start">{{ FIELD_LABELS['total'] }}</th>
                </tr>
              </thead>
<tbody>
  {% for m in methods or [] %}
    {% set i = loop.index0 %}
    {% set t = totals[i] if totals and totals|length > i else 0 %}
    <tr>
      <td class="fw-semibold">{{ METHOD_LABELS[m] if METHOD_LABELS and m in METHOD_LABELS else m }}</td>
      <td class="text-start">{{ '%.2f' % (t or 0) }}</td>
    </tr>
  {% endfor %}
</tbody>
              <tfoot>
                <tr class="fw-bold">
                  <td>{{ FIELD_LABELS['grand_total'] }}</td>
                  <td class="text-start">{{ '%.2f' % (grand_total or 0) }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
          {% if not methods %}
            <div class="text-muted text-center py-3">لا توجد بيانات ضمن هذا النطاق.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header">رسم بياني</div>
        <div class="card-body">
          <div id="paymentsChartWrap" class="position-relative" style="height: 340px; width: 100%;">
            <canvas id="paymentsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const methodsRaw = {{ methods | default([]) | tojson }};
  const totalsRaw = {{ totals | default([]) | tojson }};
  const methodLabelsMap = {{ METHOD_LABELS | default({}) | tojson }};
  const labels = methodsRaw.map(m => methodLabelsMap[m] || m);
  const totals = totalsRaw.map(v => Number(v || 0));

  const ctx = document.getElementById('paymentsChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '{{ FIELD_LABELS["payments_summary"] }}',
        data: totals,
        backgroundColor: '#0d6efd'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.x || 0;
              return new Intl.NumberFormat('ar', { maximumFractionDigits: 2 }).format(v);
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: (val, i, ticks) => {
              const v = ticks[i]?.value ?? val;
              return new Intl.NumberFormat('ar', { maximumFractionDigits: 2 }).format(v);
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
