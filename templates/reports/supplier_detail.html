{% extends "base.html" %}

{% block title %}كشف مفصل للمورد - {{ supplier.name }}{% endblock %}

{% block head_extra %}
<style>
/* تنسيقات الطباعة */
@media print {
    .no-print { display: none !important; }
    .print-section { page-break-after: always; }
    .print-section:last-child { page-break-after: auto; }
    body { font-size: 12pt; }
    .card { border: 1px solid #000 !important; box-shadow: none !important; }
}

/* تنسيقات الأقسام القابلة للطي */
.collapsible-section {
    cursor: pointer;
    transition: all 0.3s ease;
}
.collapsible-section:hover {
    background-color: rgba(0,0,0,0.03);
}
.section-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}
.section-content.show {
    max-height: 2000px;
}
.collapse-icon {
    transition: transform 0.3s ease;
}
.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

/* ألوان الأقسام */
.bg-exchange-in { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.bg-exchange-out { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.bg-sales { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.bg-services { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.bg-preorders { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.bg-payments-in { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
.bg-payments-out { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
.bg-expenses { background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%); }

.detail-row {
    background-color: #f8f9fa;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h2 class="mb-0">
            <i class="fas fa-truck text-primary me-2"></i>
            كشف مفصل للمورد: {{ supplier.name }}
        </h2>
        <div class="btn-group">
            <a href="{{ url_for('reports_bp.suppliers_report') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-1"></i>
                العودة
            </a>
            <button onclick="printFullReport()" class="btn btn-outline-primary">
                <i class="fas fa-print me-1"></i>
                طباعة الكل
            </button>
        </div>
    </div>

    <!-- معلومات المورد -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>معلومات المورد</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>الاسم:</strong> {{ supplier.name }}<br>
                            <strong>الهاتف:</strong> {{ supplier.phone or 'غير محدد' }}<br>
                            <strong>البريد الإلكتروني:</strong> {{ supplier.email or 'غير محدد' }}
                        </div>
                        <div class="col-sm-6">
                            <strong>الرصيد الحالي:</strong> 
                            <span class="badge {% if current_balance > 0 %}bg-danger{% elif current_balance < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                {{ current_balance|format_currency }}
                            </span><br>
                            <strong>العنوان:</strong> {{ supplier.address or 'غير محدد' }}<br>
                            <strong>ملاحظات:</strong> {{ supplier.notes or 'لا توجد' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ملخص الإجماليات</h5>
                </div>
                <div class="card-body">
                    {% if balance_data and balance_data.get('success') %}
                    {# البيانات الذكية #}
                    <div class="row text-center">
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-success">🟢 قطع أخذناها</strong><br>
                            <span class="fs-5 fw-bold text-success">{{ "%.2f"|format(balance_data.get('rights', {}).get('exchange_items', {}).get('total_value_ils', 0)) }} ₪</span><br>
                            <small class="text-muted">{{ balance_data.get('rights', {}).get('exchange_items', {}).get('count', 0) }} منتج</small>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-danger">🔴 التزاماته</strong><br>
                            <span class="fs-5 fw-bold text-danger">{{ "%.2f"|format(balance_data.get('obligations', {}).get('total', 0)) }} ₪</span><br>
                            <small class="text-muted">مبيعات + صيانة</small>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-warning">💰 دفعنا له</strong><br>
                            <span class="fs-5 fw-bold text-warning">{{ "%.2f"|format(balance_data.get('payments', {}).get('total_paid', 0)) }} ₪</span>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-success">💵 دفع لنا</strong><br>
                            <span class="fs-5 fw-bold text-success">{{ "%.2f"|format(balance_data.get('payments', {}).get('total_received', 0)) }} ₪</span>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-primary">🎯 الرصيد</strong><br>
                            <span class="fs-4 fw-bold {{ balance_data.get('balance', {}).get('amount', 0) > 0 and 'text-success' or balance_data.get('balance', {}).get('amount', 0) < 0 and 'text-danger' or '' }}">
                                {{ "%.2f"|format((balance_data.get('balance', {}).get('amount', 0)|abs)) }} ₪
                            </span><br>
                            <small class="text-muted">{{ balance_data.get('balance', {}).get('action', '') }}</small>
                        </div>
                    </div>
                    {% else %}
                    {# القديم #}
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-primary">توريدات</strong><br>
                            <span class="fs-6">{{ total_exchange_in|format_currency }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-danger">دفعنا له</strong><br>
                            <span class="fs-6">{{ total_payments_out|format_currency }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-success">دفع لنا</strong><br>
                            <span class="fs-6">{{ total_payments_in|format_currency }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-primary">الرصيد</strong><br>
                            <span class="fs-6">{{ current_balance|format_currency }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- فلتر التاريخ -->
    <div class="card border-0 shadow-sm mb-4 no-print">
        <div class="card-body">
            <form method="GET" class="row g-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="col-md-4">
                    <label for="start" class="form-label">من تاريخ</label>
                    <input type="date" class="form-control" id="start" name="start" value="{{ start_date }}">
                </div>
                <div class="col-md-4">
                    <label for="end" class="form-label">إلى تاريخ</label>
                    <input type="date" class="form-control" id="end" name="end" value="{{ end_date }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>تصفية
                    </button>
                    <a href="{{ url_for('reports_bp.supplier_detail_report', supplier_id=supplier.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>إلغاء
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- 📦 حركات التوريد (IN) -->
    {% if exchange_transactions %}
    {% set exchange_in = exchange_transactions|selectattr('direction', 'in', ['IN', 'PURCHASE', 'CONSIGN_IN'])|list %}
    {% if exchange_in %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-exchange-in text-white collapsible-section" data-bs-toggle="collapse" data-bs-target="#exchangeInSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-box-open me-2"></i>
                    📦 حركات التوريد (IN) - {{ exchange_in|length }} حركة
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_exchange_in|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('exchangeInSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="exchangeInSection" class="collapse show section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>التاريخ</th>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>سعر الوحدة</th>
                                <th>الإجمالي</th>
                                <th>الاتجاه</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in exchange_in %}
                            <tr>
                                <td>{{ tx.id }}</td>
                                <td>{{ tx.created_at.strftime('%Y-%m-%d %H:%M') if tx.created_at else '-' }}</td>
                                <td><strong>{{ tx.product.name if tx.product else 'غير محدد' }}</strong></td>
                                <td><span class="badge bg-primary">{{ tx.quantity }}</span></td>
                                <td>{{ tx.unit_cost|format_currency }}</td>
                                <td><strong>{{ (tx.quantity * tx.unit_cost)|format_currency }}</strong></td>
                                <td><span class="badge bg-success">{{ tx.direction }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5" class="text-end">الإجمالي:</th>
                                <th colspan="2">{{ total_exchange_in|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- 📤 حركات المرتجعات (OUT) -->
    {% if exchange_transactions %}
    {% set exchange_out = exchange_transactions|selectattr('direction', 'in', ['OUT', 'RETURN', 'CONSIGN_OUT'])|list %}
    {% if exchange_out %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-exchange-out text-white collapsible-section collapsed" data-bs-toggle="collapse" data-bs-target="#exchangeOutSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-undo me-2"></i>
                    📤 المرتجعات للمورد (OUT) - {{ exchange_out|length }} حركة
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_exchange_out|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('exchangeOutSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="exchangeOutSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>التاريخ</th>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>سعر الوحدة</th>
                                <th>الإجمالي</th>
                                <th>الاتجاه</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in exchange_out %}
                            <tr>
                                <td>{{ tx.id }}</td>
                                <td>{{ tx.created_at.strftime('%Y-%m-%d %H:%M') if tx.created_at else '-' }}</td>
                                <td><strong>{{ tx.product.name if tx.product else 'غير محدد' }}</strong></td>
                                <td><span class="badge bg-danger">{{ tx.quantity }}</span></td>
                                <td>{{ tx.unit_cost|format_currency }}</td>
                                <td><strong>{{ (tx.quantity * tx.unit_cost)|format_currency }}</strong></td>
                                <td><span class="badge bg-danger">{{ tx.direction }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5" class="text-end">الإجمالي:</th>
                                <th colspan="2">{{ total_exchange_out|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- 🛒 المبيعات -->
    {% if sales %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-sales text-white collapsible-section collapsed" data-bs-toggle="collapse" data-bs-target="#salesSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>
                    🛒 المبيعات للمورد - {{ sales|length }} فاتورة
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_sales|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('salesSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="salesSection" class="collapse section-content">
            <div class="card-body">
                {% for sale in sales %}
                <div class="mb-3 border rounded p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>
                            <i class="fas fa-file-invoice text-primary"></i>
                            {{ sale.sale_number }}
                        </strong>
                        <div>
                            <span class="badge bg-secondary">{{ sale.sale_date.strftime('%Y-%m-%d') if sale.sale_date else '-' }}</span>
                            <span class="badge bg-success">{{ sale.total_amount|format_currency }}</span>
                        </div>
                    </div>
                    {% if sale.lines %}
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless mb-0 detail-row">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in sale.lines %}
                                <tr>
                                    <td>{{ line.product.name if line.product else '-' }}</td>
                                    <td>{{ line.quantity }}</td>
                                    <td>{{ line.unit_price|format_currency }}</td>
                                    <td>{{ (line.quantity * line.unit_price)|format_currency }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                <div class="text-end mt-3">
                    <strong>إجمالي المبيعات: {{ total_sales|format_currency }}</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 🔧 الصيانة -->
    {% if services %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-services text-white collapsible-section collapsed" data-bs-toggle="collapse" data-bs-target="#servicesSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-wrench me-2"></i>
                    🔧 الصيانة للمورد - {{ services|length }} طلب
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_services|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('servicesSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="servicesSection" class="collapse section-content">
            <div class="card-body">
                {% for service in services %}
                <div class="mb-3 border rounded p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>
                            <i class="fas fa-tools text-success"></i>
                            {{ service.service_number or 'صيانة #' ~ service.id }}
                        </strong>
                        <div>
                            <span class="badge bg-secondary">{{ service.received_at.strftime('%Y-%m-%d') if service.received_at else '-' }}</span>
                            <span class="badge bg-success">{{ service.total_amount|format_currency }}</span>
                        </div>
                    </div>
                    {% if service.parts or service.tasks %}
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless mb-0 detail-row">
                            <thead>
                                <tr>
                                    <th>النوع</th>
                                    <th>الوصف</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part in service.parts %}
                                <tr>
                                    <td><span class="badge bg-info">قطعة</span></td>
                                    <td>{{ part.product.name if part.product else '-' }}</td>
                                    <td>{{ part.quantity }}</td>
                                    <td>{{ part.unit_price|format_currency }}</td>
                                    <td>{{ (part.quantity * part.unit_price)|format_currency }}</td>
                                </tr>
                                {% endfor %}
                                {% for task in service.tasks %}
                                <tr>
                                    <td><span class="badge bg-warning">خدمة</span></td>
                                    <td>{{ task.description or '-' }}</td>
                                    <td>{{ task.quantity or 1 }}</td>
                                    <td>{{ task.unit_price|format_currency }}</td>
                                    <td>{{ ((task.quantity or 1) * task.unit_price)|format_currency }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                <div class="text-end mt-3">
                    <strong>إجمالي الصيانة: {{ total_services|format_currency }}</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 📅 الحجوزات المسبقة -->
    {% if preorders %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-preorders text-white collapsible-section collapsed" data-bs-toggle="collapse" data-bs-target="#preordersSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-check me-2"></i>
                    📅 الحجوزات المسبقة - {{ preorders|length }} حجز
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_preorders|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('preordersSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="preordersSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>التاريخ</th>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for preorder in preorders %}
                            <tr>
                                <td>{{ preorder.id }}</td>
                                <td>{{ preorder.preorder_date.strftime('%Y-%m-%d') if preorder.preorder_date else '-' }}</td>
                                <td><strong>{{ preorder.product.name if preorder.product else 'غير محدد' }}</strong></td>
                                <td><span class="badge bg-primary">{{ preorder.quantity }}</span></td>
                                <td>{{ preorder.unit_price|format_currency }}</td>
                                <td><strong>{{ preorder.total_amount|format_currency }}</strong></td>
                                <td><span class="badge bg-info">{{ preorder.status }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5" class="text-end">الإجمالي:</th>
                                <th colspan="2">{{ total_preorders|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 💰 الدفعات الواردة (IN) -->
    {% if payments_in %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-payments-in text-white collapsible-section collapsed" data-bs-toggle="collapse" data-bs-target="#paymentsInSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-hand-holding-usd me-2"></i>
                    💰 الدفعات الواردة (دفع لنا) - {{ payments_in|length }} دفعة
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_payments_in|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('paymentsInSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="paymentsInSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>رقم الدفعة</th>
                                <th>التاريخ</th>
                                <th>طريقة الدفع</th>
                                <th>المبلغ</th>
                                <th>المرجع</th>
                                <th>ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments_in %}
                            <tr>
                                <td><strong>{{ payment.payment_number or payment.id }}</strong></td>
                                <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else '-' }}</td>
                                <td><span class="badge bg-primary">{{ payment.method or 'نقدي' }}</span></td>
                                <td><strong class="text-success">{{ payment.total_amount|format_currency }}</strong></td>
                                <td>{{ payment.reference or '-' }}</td>
                                <td>{{ payment.notes or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="3" class="text-end">الإجمالي:</th>
                                <th colspan="3">{{ total_payments_in|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 💸 الدفعات الصادرة (OUT) -->
    {% if payments_out %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-payments-out text-white collapsible-section collapsed" data-bs-toggle="collapse" data-bs-target="#paymentsOutSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    💸 الدفعات الصادرة (دفعنا له) - {{ payments_out|length }} دفعة
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_payments_out|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('paymentsOutSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="paymentsOutSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>رقم الدفعة</th>
                                <th>التاريخ</th>
                                <th>طريقة الدفع</th>
                                <th>المبلغ</th>
                                <th>المرجع</th>
                                <th>ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments_out %}
                            <tr>
                                <td><strong>{{ payment.payment_number or payment.id }}</strong></td>
                                <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else '-' }}</td>
                                <td><span class="badge bg-danger">{{ payment.method or 'نقدي' }}</span></td>
                                <td><strong class="text-danger">{{ payment.total_amount|format_currency }}</strong></td>
                                <td>{{ payment.reference or '-' }}</td>
                                <td>{{ payment.notes or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="3" class="text-end">الإجمالي:</th>
                                <th colspan="3">{{ total_payments_out|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 💼 المصاريف -->
    {% if expenses %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-expenses text-white collapsible-section collapsed" data-bs-toggle="collapse" data-bs-target="#expensesSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-receipt me-2"></i>
                    💼 المصاريف - {{ expenses|length }} مصروف
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ total_expenses|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('expensesSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="expensesSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>المبلغ</th>
                                <th>الوصف</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td>{{ expense.id }}</td>
                                <td>{{ expense.date.strftime('%Y-%m-%d') if expense.date else '-' }}</td>
                                <td><span class="badge bg-warning">{{ expense.type_id or 'غير محدد' }}</span></td>
                                <td><strong>{{ expense.amount|format_currency }}</strong></td>
                                <td>{{ expense.desc or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="3" class="text-end">الإجمالي:</th>
                                <th colspan="2">{{ total_expenses|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- رسالة في حالة عدم وجود بيانات -->
    {% if not exchange_transactions and not sales and not services and not preorders and not payments_in and not payments_out and not expenses %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">لا توجد معاملات في الفترة المحددة</h5>
            <p class="text-muted">لم يتم العثور على أي معاملات للمورد في الفترة المحددة.</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
// دالة لطباعة التقرير الكامل
function printFullReport() {
    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write('<html><head><title>كشف مفصل - {{ supplier.name }}</title>');
    printWindow.document.write('<meta charset="UTF-8">');
    printWindow.document.write('<style>');
    printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
    printWindow.document.write('body { font-family: Arial, sans-serif; direction: rtl; padding: 10px; font-size: 7pt; line-height: 1.2; }');
    printWindow.document.write('h2 { text-align: center; color: #333; margin-bottom: 8px; border-bottom: 2px solid #000; padding-bottom: 5px; font-size: 12pt; }');
    printWindow.document.write('h3 { font-size: 9pt; margin: 8px 0 4px 0; padding: 3px 5px; background-color: #e0e0e0; border-right: 4px solid #667eea; }');
    printWindow.document.write('.supplier-info { border: 1px solid #000; padding: 6px; margin: 8px 0; background-color: #f8f9fa; font-size: 6.5pt; }');
    printWindow.document.write('.supplier-info table { width: 100%; border-collapse: collapse; }');
    printWindow.document.write('.supplier-info td { padding: 2px 4px; border: none; vertical-align: top; }');
    printWindow.document.write('.supplier-info strong { font-weight: bold; }');
    printWindow.document.write('.balance-box { background-color: #e0ffe0; border: 1px solid #000; padding: 3px; margin-top: 3px; font-size: 7pt; }');
    printWindow.document.write('.balance-box.negative { background-color: #ffe0e0; }');
    printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 6px 0; font-size: 6.5pt; }');
    printWindow.document.write('th, td { border: 1px solid #999; padding: 2px 3px; text-align: right; line-height: 1.1; }');
    printWindow.document.write('th { background-color: #e0e0e0; font-weight: bold; text-align: center; font-size: 7pt; }');
    printWindow.document.write('tfoot th, tfoot td { background-color: #f0f0f0; font-weight: bold; padding: 3px; }');
    printWindow.document.write('.badge { display: inline-block; padding: 1px 4px; font-size: 6pt; border-radius: 2px; }');
    printWindow.document.write('.bg-primary { background-color: #007bff; color: white; }');
    printWindow.document.write('.bg-success { background-color: #28a745; color: white; }');
    printWindow.document.write('.bg-danger { background-color: #dc3545; color: white; }');
    printWindow.document.write('.bg-warning { background-color: #ffc107; color: black; }');
    printWindow.document.write('.bg-info { background-color: #17a2b8; color: white; }');
    printWindow.document.write('.section { margin-bottom: 10px; page-break-inside: avoid; }');
    printWindow.document.write('.footer { text-align: center; font-size: 6pt; color: #666; margin-top: 10px; border-top: 1px solid #ccc; padding-top: 5px; }');
    printWindow.document.write('@page { margin: 0.8cm; size: A4 portrait; }');
    printWindow.document.write('</style></head><body>');
    
    // الترويسة
    printWindow.document.write('<h2>كشف مفصل للمورد: {{ supplier.name }}</h2>');
    
    // معلومات المورد
    printWindow.document.write('<div class="supplier-info">');
    printWindow.document.write('<table><tr>');
    printWindow.document.write('<td style="width: 50%;">');
    printWindow.document.write('<div><strong>الاسم:</strong> {{ supplier.name }}</div>');
    printWindow.document.write('<div><strong>الهاتف:</strong> {{ supplier.phone or "غير محدد" }}</div>');
    printWindow.document.write('<div><strong>البريد:</strong> {{ supplier.email or "غير محدد" }}</div>');
    printWindow.document.write('</td>');
    printWindow.document.write('<td style="width: 50%; border-right: 1px solid #000;">');
    {% if start_date and end_date %}
    printWindow.document.write('<div><strong>الفترة:</strong> من {{ start_date }} إلى {{ end_date }}</div>');
    {% endif %}
    printWindow.document.write('<div class="balance-box {% if current_balance < 0 %}negative{% endif %}"><strong>الرصيد:</strong> {{ current_balance|format_currency }}');
    {% if current_balance > 0 %}
    printWindow.document.write(' <strong>(له علينا)</strong>');
    {% elif current_balance < 0 %}
    printWindow.document.write(' <strong>(لنا عليه)</strong>');
    {% endif %}
    printWindow.document.write('</div>');
    printWindow.document.write('<div style="font-size: 6pt; margin-top: 2px;"><strong>طُبع:</strong> ' + new Date().toLocaleDateString('ar-EG') + '</div>');
    printWindow.document.write('</td>');
    printWindow.document.write('</tr></table>');
    printWindow.document.write('</div>');
    
    {% if exchange_transactions %}
    {% set exchange_in = exchange_transactions|selectattr('direction', 'in', ['IN', 'PURCHASE', 'CONSIGN_IN'])|list %}
    {% if exchange_in %}
    // حركات التوريد
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>📦 حركات التوريد ({{ exchange_in|length }} حركة) - {{ total_exchange_in|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>التاريخ</th><th>المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for tx in exchange_in %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ tx.id }}</td>');
    printWindow.document.write('<td>{{ tx.created_at.strftime("%Y-%m-%d") if tx.created_at else "-" }}</td>');
    printWindow.document.write('<td>{{ tx.product.name if tx.product else "غير محدد" }}</td>');
    printWindow.document.write('<td>{{ tx.quantity }}</td>');
    printWindow.document.write('<td>{{ tx.unit_cost|format_currency }}</td>');
    printWindow.document.write('<td>{{ (tx.quantity * tx.unit_cost)|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">الإجمالي:</th><th>{{ total_exchange_in|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    {% endif %}
    
    {% if sales %}
    // المبيعات
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>🛒 المبيعات ({{ sales|length }} فاتورة) - {{ total_sales|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>رقم البيع</th><th>التاريخ</th><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for sale in sales %}
    {% if sale.lines %}
    {% for line in sale.lines %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ sale.sale_number }}</td>');
    printWindow.document.write('<td>{{ sale.sale_date.strftime("%Y-%m-%d") if sale.sale_date else "-" }}</td>');
    printWindow.document.write('<td>{{ line.product.name if line.product else "-" }}</td>');
    printWindow.document.write('<td>{{ line.quantity }}</td>');
    printWindow.document.write('<td>{{ line.unit_price|format_currency }}</td>');
    printWindow.document.write('<td>{{ (line.quantity * line.unit_price)|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    {% endif %}
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">الإجمالي:</th><th>{{ total_sales|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if payments_out %}
    // الدفعات الصادرة
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>💸 الدفعات الصادرة ({{ payments_out|length }} دفعة) - {{ total_payments_out|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>رقم الدفعة</th><th>التاريخ</th><th>طريقة الدفع</th><th>المبلغ</th><th>ملاحظات</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for payment in payments_out %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ payment.payment_number or payment.id }}</td>');
    printWindow.document.write('<td>{{ payment.payment_date.strftime("%Y-%m-%d") if payment.payment_date else "-" }}</td>');
    printWindow.document.write('<td>{{ payment.method or "نقدي" }}</td>');
    printWindow.document.write('<td>{{ payment.total_amount|format_currency }}</td>');
    printWindow.document.write('<td>{{ payment.notes or "-" }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="3">الإجمالي:</th><th colspan="2">{{ total_payments_out|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if payments_in %}
    // الدفعات الواردة
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>💰 الدفعات الواردة ({{ payments_in|length }} دفعة) - {{ total_payments_in|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>رقم الدفعة</th><th>التاريخ</th><th>طريقة الدفع</th><th>المبلغ</th><th>ملاحظات</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for payment in payments_in %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ payment.payment_number or payment.id }}</td>');
    printWindow.document.write('<td>{{ payment.payment_date.strftime("%Y-%m-%d") if payment.payment_date else "-" }}</td>');
    printWindow.document.write('<td>{{ payment.method or "نقدي" }}</td>');
    printWindow.document.write('<td>{{ payment.total_amount|format_currency }}</td>');
    printWindow.document.write('<td>{{ payment.notes or "-" }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="3">الإجمالي:</th><th colspan="2">{{ total_payments_in|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if services %}
    // الصيانة
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>🔧 الصيانة ({{ services|length }} طلب) - {{ total_services|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>رقم الصيانة</th><th>التاريخ</th><th>النوع</th><th>الوصف</th><th>المبلغ</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for service in services %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ service.service_number or service.id }}</td>');
    printWindow.document.write('<td>{{ service.received_at.strftime("%Y-%m-%d") if service.received_at else "-" }}</td>');
    printWindow.document.write('<td colspan="2">خدمة صيانة</td>');
    printWindow.document.write('<td>{{ service.total_amount|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="4">الإجمالي:</th><th>{{ total_services|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if preorders %}
    // الحجوزات المسبقة
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>📅 الحجوزات المسبقة ({{ preorders|length }} حجز) - {{ total_preorders|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>التاريخ</th><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for preorder in preorders %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ preorder.id }}</td>');
    printWindow.document.write('<td>{{ preorder.preorder_date.strftime("%Y-%m-%d") if preorder.preorder_date else "-" }}</td>');
    printWindow.document.write('<td>{{ preorder.product.name if preorder.product else "غير محدد" }}</td>');
    printWindow.document.write('<td>{{ preorder.quantity }}</td>');
    printWindow.document.write('<td>{{ preorder.unit_price|format_currency }}</td>');
    printWindow.document.write('<td>{{ preorder.total_amount|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">الإجمالي:</th><th>{{ total_preorders|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if exchange_transactions %}
    {% set exchange_out = exchange_transactions|selectattr('direction', 'in', ['OUT', 'RETURN', 'CONSIGN_OUT'])|list %}
    {% if exchange_out %}
    // المرتجعات
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>📤 المرتجعات ({{ exchange_out|length }} حركة) - {{ total_exchange_out|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>التاريخ</th><th>المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for tx in exchange_out %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ tx.id }}</td>');
    printWindow.document.write('<td>{{ tx.created_at.strftime("%Y-%m-%d") if tx.created_at else "-" }}</td>');
    printWindow.document.write('<td>{{ tx.product.name if tx.product else "غير محدد" }}</td>');
    printWindow.document.write('<td>{{ tx.quantity }}</td>');
    printWindow.document.write('<td>{{ tx.unit_cost|format_currency }}</td>');
    printWindow.document.write('<td>{{ (tx.quantity * tx.unit_cost)|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">الإجمالي:</th><th>{{ total_exchange_out|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    {% endif %}
    
    {% if expenses %}
    // المصاريف
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>💼 المصاريف ({{ expenses|length }} مصروف) - {{ total_expenses|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>الوصف</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for expense in expenses %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ expense.id }}</td>');
    printWindow.document.write('<td>{{ expense.date.strftime("%Y-%m-%d") if expense.date else "-" }}</td>');
    printWindow.document.write('<td>{{ expense.type_id or "غير محدد" }}</td>');
    printWindow.document.write('<td>{{ expense.amount|format_currency }}</td>');
    printWindow.document.write('<td>{{ expense.desc or "-" }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="3">الإجمالي:</th><th colspan="2">{{ total_expenses|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    // التذييل
    printWindow.document.write('<div class="footer">');
    printWindow.document.write('طُبع بتاريخ: ' + new Date().toLocaleString('en-US'));
    printWindow.document.write('</div>');
    
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    
    setTimeout(function() {
        printWindow.print();
    }, 250);
}

// دالة لطباعة قسم محدد فقط
function printSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;
    
    // فتح القسم إذا كان مطوياً
    const bsCollapse = new bootstrap.Collapse(section, {toggle: false});
    bsCollapse.show();
    
    // انتظار فتح القسم ثم الطباعة
    setTimeout(() => {
        const printWindow = window.open('', '_blank');
        const content = `
            <!DOCTYPE html>
            <html dir="rtl" lang="ar">
            <head>
                <meta charset="UTF-8">
                <title>طباعة - {{ supplier.name }}</title>
                <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/css/adminlte.min.css') }}">
                <style>
                    body { font-family: 'Tajawal', Arial, sans-serif; direction: rtl; }
                    .table { width: 100%; margin-top: 20px; }
                    .table th { background-color: #f8f9fa; }
                    @media print {
                        .no-print { display: none; }
                        body { font-size: 12pt; }
                    }
                </style>
            </head>
            <body>
                <div class="container-fluid p-4">
                    <div class="text-center mb-4">
                        <h2>{{ supplier.name }}</h2>
                        <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                    ${section.innerHTML}
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(() => window.close(), 100);
                    };
                <\/script>
            </body>
            </html>
        `;
        printWindow.document.write(content);
        printWindow.document.close();
    }, 300);
}

// Toggle collapse icons
document.addEventListener('DOMContentLoaded', function() {
    const collapsibles = document.querySelectorAll('.collapsible-section');
    collapsibles.forEach(section => {
        const target = section.getAttribute('data-bs-target');
        if (target) {
            const targetEl = document.querySelector(target);
            if (targetEl) {
                targetEl.addEventListener('shown.bs.collapse', () => {
                    section.classList.remove('collapsed');
                });
                targetEl.addEventListener('hidden.bs.collapse', () => {
                    section.classList.add('collapsed');
                });
            }
        }
    });
});
</script>
{% endblock %}
