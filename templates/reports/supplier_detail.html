{% extends "base.html" %}

{% block title %}ÙƒØ´Ù Ù…ÙØµÙ„ Ù„Ù„Ù…ÙˆØ±Ø¯ - {{ supplier.name }}{% endblock %}

{% block head_extra %}
<style>
/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
    .no-print { display: none !important; }
    .print-section { page-break-after: always; }
    .print-section:last-child { page-break-after: auto; }
    body { font-size: 12pt; }
    .card { border: 1px solid #000 !important; box-shadow: none !important; }
}

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ */
.collapsible-section {
    cursor: pointer;
    transition: all 0.3s ease;
}
.collapsible-section:hover {
    background-color: rgba(0,0,0,0.03);
}
.section-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}
.section-content.show {
    max-height: 2000px;
}
.collapse-icon {
    transition: transform 0.3s ease;
}
.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
.bg-exchange-in { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.bg-exchange-out { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.bg-sales { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.bg-services { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.bg-preorders { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.bg-payments-in { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
.bg-payments-out { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
.bg-expenses { background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%); }

.detail-row {
    background-color: #f8f9fa;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h2 class="mb-0">
            <i class="fas fa-truck text-primary ml-2"></i>
            ÙƒØ´Ù Ù…ÙØµÙ„ Ù„Ù„Ù…ÙˆØ±Ø¯: {{ supplier.name }}
        </h2>
        <div class="btn-group">
            <a href="{{ url_for('reports_bp.suppliers_report') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right ml-1"></i>
                Ø§Ù„Ø¹ÙˆØ¯Ø©
            </a>
            <button onclick="printFullReport()" class="btn btn-outline-primary">
                <i class="fas fa-print ml-1"></i>
                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„
            </button>
        </div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle ml-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ supplier.name }}<br>
                            <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ supplier.phone or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}<br>
                            <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> {{ supplier.email or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                        </div>
                        <div class="col-sm-6">
                            <strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> 
                            <span class="badge {% if current_balance > 0 %}bg-danger{% elif current_balance < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                {{ current_balance|format_currency }}
                            </span><br>
                            <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> {{ supplier.address or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}<br>
                            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ supplier.notes or 'Ù„Ø§ ØªÙˆØ¬Ø¯' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar ml-2"></i>Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</h5>
                </div>
                <div class="card-body">
                    {% if balance_data and balance_data.get('success') %}
                    {# Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© #}
                    <div class="row text-center">
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-success">ğŸŸ¢ Ù‚Ø·Ø¹ Ø£Ø®Ø°Ù†Ø§Ù‡Ø§</strong><br>
                            <span class="fs-5 fw-bold text-success">{{ "%.2f"|format(balance_data.get('rights', {}).get('exchange_items', {}).get('total_value_ils', 0)) }} â‚ª</span><br>
                            <small class="text-muted">{{ balance_data.get('rights', {}).get('exchange_items', {}).get('count', 0) }} Ù…Ù†ØªØ¬</small>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-danger">ğŸ”´ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªÙ‡</strong><br>
                            <span class="fs-5 fw-bold text-danger">{{ "%.2f"|format(balance_data.get('obligations', {}).get('total', 0)) }} â‚ª</span><br>
                            <small class="text-muted">Ù…Ø¨ÙŠØ¹Ø§Øª + ØµÙŠØ§Ù†Ø©</small>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-warning">ğŸ’° Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡</strong><br>
                            <span class="fs-5 fw-bold text-warning">{{ "%.2f"|format(balance_data.get('payments', {}).get('total_paid', 0)) }} â‚ª</span>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-success">ğŸ’µ Ø¯ÙØ¹ Ù„Ù†Ø§</strong><br>
                            <span class="fs-5 fw-bold text-success">{{ "%.2f"|format(balance_data.get('payments', {}).get('total_received', 0)) }} â‚ª</span>
                        </div>
                        <div class="col-6 col-md-4 mb-3">
                            <strong class="text-primary">ğŸ¯ Ø§Ù„Ø±ØµÙŠØ¯</strong><br>
                            <span class="fs-4 fw-bold {{ balance_data.get('balance', {}).get('amount', 0) > 0 and 'text-success' or balance_data.get('balance', {}).get('amount', 0) < 0 and 'text-danger' or '' }}">
                                {{ "%.2f"|format((balance_data.get('balance', {}).get('amount', 0)|abs)) }} â‚ª
                            </span><br>
                            <small class="text-muted">{{ balance_data.get('balance', {}).get('action', '') }}</small>
                        </div>
                    </div>
                    {% else %}
                    {# Ø§Ù„Ù‚Ø¯ÙŠÙ… #}
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-primary">ØªÙˆØ±ÙŠØ¯Ø§Øª</strong><br>
                            <span class="fs-6">{{ total_exchange_in|format_currency }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-danger">Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡</strong><br>
                            <span class="fs-6">{{ total_payments_out|format_currency }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-success">Ø¯ÙØ¹ Ù„Ù†Ø§</strong><br>
                            <span class="fs-6">{{ total_payments_in|format_currency }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong class="text-primary">Ø§Ù„Ø±ØµÙŠØ¯</strong><br>
                            <span class="fs-6">{{ current_balance|format_currency }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
    <div class="card border-0 shadow-sm mb-4 no-print">
        <div class="card-body">
            <form method="GET" class="row g-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="col-md-4">
                    <label for="start" class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" class="form-control" id="start" name="start" value="{{ start_date }}">
                </div>
                <div class="col-md-4">
                    <label for="end" class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" class="form-control" id="end" name="end" value="{{ end_date }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary ml-2">
                        <i class="fas fa-search ml-1"></i>ØªØµÙÙŠØ©
                    </button>
                    <a href="{{ url_for('reports_bp.supplier_detail_report', supplier_id=supplier.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times ml-1"></i>Ø¥Ù„ØºØ§Ø¡
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- ğŸ“¦ Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØ±ÙŠØ¯ (IN) -->
    {% if exchange_transactions %}
    {% set exchange_in = exchange_transactions|selectattr('direction', 'in', ['IN', 'PURCHASE', 'CONSIGN_IN'])|list %}
    {% if exchange_in %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-exchange-in text-white collapsible-section" data-toggle="collapse" data-target="#exchangeInSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-box-open ml-2"></i>
                    ğŸ“¦ Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØ±ÙŠØ¯ (IN) - {{ exchange_in|length }} Ø­Ø±ÙƒØ©
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_exchange_in|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('exchangeInSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="exchangeInSection" class="collapse show section-content">
            <div class="card-body">
                <div class="alert alert-info alert-sm mb-3">
                    <i class="fas fa-info-circle"></i> <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø©. Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø¹Ù„Ø§Ù‡ Ù…Ø­Ø³ÙˆØ¨ Ø¨Ø¹Ø¯ ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø´ÙŠÙƒÙ„ (ILS).
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in exchange_in %}
                            <tr>
                                <td>{{ tx.id }}</td>
                                <td>{{ tx.created_at.strftime('%Y-%m-%d %H:%M') if tx.created_at else '-' }}</td>
                                <td><strong>{{ tx.product.name if tx.product else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</strong></td>
                                <td><span class="badge bg-primary">{{ tx.quantity }}</span></td>
                                <td>{{ tx.unit_cost|format_currency }}</td>
                                <td><strong>{{ (tx.quantity * tx.unit_cost)|format_currency }}</strong></td>
                                <td><span class="badge bg-success">{{ tx.direction }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¹Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø¥Ù„Ù‰ ILS):</th>
                                <th colspan="2"><strong class="text-success">{{ total_exchange_in|format_currency }} â‚ª</strong></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- ğŸ“¤ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª (OUT) -->
    {% if exchange_transactions %}
    {% set exchange_out = exchange_transactions|selectattr('direction', 'in', ['OUT', 'RETURN', 'CONSIGN_OUT'])|list %}
    {% if exchange_out %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-exchange-out text-white collapsible-section collapsed" data-toggle="collapse" data-target="#exchangeOutSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-undo ml-2"></i>
                    ğŸ“¤ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù„Ù„Ù…ÙˆØ±Ø¯ (OUT) - {{ exchange_out|length }} Ø­Ø±ÙƒØ©
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_exchange_out|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('exchangeOutSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="exchangeOutSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in exchange_out %}
                            <tr>
                                <td>{{ tx.id }}</td>
                                <td>{{ tx.created_at.strftime('%Y-%m-%d %H:%M') if tx.created_at else '-' }}</td>
                                <td><strong>{{ tx.product.name if tx.product else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</strong></td>
                                <td><span class="badge bg-danger">{{ tx.quantity }}</span></td>
                                <td>{{ tx.unit_cost|format_currency }}</td>
                                <td><strong>{{ (tx.quantity * tx.unit_cost)|format_currency }}</strong></td>
                                <td><span class="badge bg-danger">{{ tx.direction }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th>
                                <th colspan="2">{{ total_exchange_out|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- ğŸ›’ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
    {% if sales %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-sales text-white collapsible-section collapsed" data-toggle="collapse" data-target="#salesSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart ml-2"></i>
                    ğŸ›’ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ù…ÙˆØ±Ø¯ - {{ sales|length }} ÙØ§ØªÙˆØ±Ø©
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_sales|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('salesSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="salesSection" class="collapse section-content">
            <div class="card-body">
                {% for sale in sales %}
                <div class="mb-3 border rounded p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>
                            <i class="fas fa-file-invoice text-primary"></i>
                            {{ sale.sale_number }}
                        </strong>
                        <div>
                            <span class="badge bg-secondary">{{ sale.sale_date.strftime('%Y-%m-%d') if sale.sale_date else '-' }}</span>
                            <span class="badge bg-success">{{ sale.total_amount|format_currency }}</span>
                        </div>
                    </div>
                    {% if sale.lines %}
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless mb-0 detail-row">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in sale.lines %}
                                <tr>
                                    <td>{{ line.product.name if line.product else '-' }}</td>
                                    <td>{{ line.quantity }}</td>
                                    <td>{{ line.unit_price|format_currency }}</td>
                                    <td>{{ (line.quantity * line.unit_price)|format_currency }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                <div class="text-end mt-3">
                    <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: {{ total_sales|format_currency }}</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ğŸ”§ Ø§Ù„ØµÙŠØ§Ù†Ø© -->
    {% if services %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-services text-white collapsible-section collapsed" data-toggle="collapse" data-target="#servicesSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-wrench ml-2"></i>
                    ğŸ”§ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„Ù…ÙˆØ±Ø¯ - {{ services|length }} Ø·Ù„Ø¨
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_services|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('servicesSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="servicesSection" class="collapse section-content">
            <div class="card-body">
                {% for service in services %}
                <div class="mb-3 border rounded p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>
                            <i class="fas fa-tools text-success"></i>
                            {{ service.service_number or 'ØµÙŠØ§Ù†Ø© #' ~ service.id }}
                        </strong>
                        <div>
                            <span class="badge bg-secondary">{{ service.received_at.strftime('%Y-%m-%d') if service.received_at else '-' }}</span>
                            <span class="badge bg-success">{{ service.total_amount|format_currency }}</span>
                        </div>
                    </div>
                    {% if service.parts or service.tasks %}
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless mb-0 detail-row">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part in service.parts %}
                                <tr>
                                    <td><span class="badge bg-info">Ù‚Ø·Ø¹Ø©</span></td>
                                    <td>{{ part.product.name if part.product else '-' }}</td>
                                    <td>{{ part.quantity }}</td>
                                    <td>{{ part.unit_price|format_currency }}</td>
                                    <td>{{ (part.quantity * part.unit_price)|format_currency }}</td>
                                </tr>
                                {% endfor %}
                                {% for task in service.tasks %}
                                <tr>
                                    <td><span class="badge bg-warning">Ø®Ø¯Ù…Ø©</span></td>
                                    <td>{{ task.description or '-' }}</td>
                                    <td>{{ task.quantity or 1 }}</td>
                                    <td>{{ task.unit_price|format_currency }}</td>
                                    <td>{{ ((task.quantity or 1) * task.unit_price)|format_currency }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                <div class="text-end mt-3">
                    <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©: {{ total_services|format_currency }}</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© -->
    {% if preorders %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-preorders text-white collapsible-section collapsed" data-toggle="collapse" data-target="#preordersSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-check ml-2"></i>
                    ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© - {{ preorders|length }} Ø­Ø¬Ø²
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_preorders|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('preordersSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="preordersSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for preorder in preorders %}
                            <tr>
                                <td>{{ preorder.id }}</td>
                                <td>{{ preorder.preorder_date.strftime('%Y-%m-%d') if preorder.preorder_date else '-' }}</td>
                                <td><strong>{{ preorder.product.name if preorder.product else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</strong></td>
                                <td><span class="badge bg-primary">{{ preorder.quantity }}</span></td>
                                <td>{{ preorder.unit_price|format_currency }}</td>
                                <td><strong>{{ preorder.total_amount|format_currency }}</strong></td>
                                <td><span class="badge bg-info">{{ preorder.status }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="5" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th>
                                <th colspan="2">{{ total_preorders|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (IN) -->
    {% if payments_in %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-payments-in text-white collapsible-section collapsed" data-toggle="collapse" data-target="#paymentsInSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-hand-holding-usd ml-2"></i>
                    ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ø¯ÙØ¹ Ù„Ù†Ø§) - {{ payments_in|length }} Ø¯ÙØ¹Ø©
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_payments_in|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('paymentsInSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="paymentsInSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments_in %}
                            <tr>
                                <td><strong>{{ payment.payment_number or payment.id }}</strong></td>
                                <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else '-' }}</td>
                                <td><span class="badge bg-primary">{{ payment.method or 'Ù†Ù‚Ø¯ÙŠ' }}</span></td>
                                <td><strong class="text-success">{{ payment.total_amount|format_currency }}</strong></td>
                                <td>{{ payment.reference or '-' }}</td>
                                <td>{{ payment.notes or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="3" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th>
                                <th colspan="3">{{ total_payments_in|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ğŸ’¸ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§Ø¯Ø±Ø© (OUT) -->
    {% if payments_out %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-payments-out text-white collapsible-section collapsed" data-toggle="collapse" data-target="#paymentsOutSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-money-bill-wave ml-2"></i>
                    ğŸ’¸ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§Ø¯Ø±Ø© (Ø¯ÙØ¹Ù†Ø§ Ù„Ù‡) - {{ payments_out|length }} Ø¯ÙØ¹Ø©
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_payments_out|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('paymentsOutSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="paymentsOutSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments_out %}
                            <tr>
                                <td><strong>{{ payment.payment_number or payment.id }}</strong></td>
                                <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else '-' }}</td>
                                <td><span class="badge bg-danger">{{ payment.method or 'Ù†Ù‚Ø¯ÙŠ' }}</span></td>
                                <td><strong class="text-danger">{{ payment.total_amount|format_currency }}</strong></td>
                                <td>{{ payment.reference or '-' }}</td>
                                <td>{{ payment.notes or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="3" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th>
                                <th colspan="3">{{ total_payments_out|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ğŸ’¼ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
    {% if expenses %}
    <div class="card border-0 shadow-sm mb-4 print-section">
        <div class="card-header bg-expenses text-white collapsible-section collapsed" data-toggle="collapse" data-target="#expensesSection">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-receipt ml-2"></i>
                    ğŸ’¼ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ - {{ expenses|length }} Ù…ØµØ±ÙˆÙ
                </h5>
                <div>
                    <span class="badge bg-light text-dark ml-2">{{ total_expenses|format_currency }}</span>
                    <button class="btn btn-sm btn-light no-print" onclick="printSection('expensesSection')">
                        <i class="fas fa-print"></i>
                    </button>
                    <i class="fas fa-chevron-down collapse-icon ms-2"></i>
                </div>
            </div>
        </div>
        <div id="expensesSection" class="collapse section-content">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td>{{ expense.id }}</td>
                                <td>{{ expense.date.strftime('%Y-%m-%d') if expense.date else '-' }}</td>
                                <td><span class="badge bg-warning">{{ expense.type_id or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span></td>
                                <td><strong>{{ expense.amount|format_currency }}</strong></td>
                                <td>{{ expense.desc or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="3" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th>
                                <th colspan="2">{{ total_expenses|format_currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª -->
    {% if not exchange_transactions and not sales and not services and not preorders and not payments_in and not payments_out and not expenses %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h5>
            <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ù„Ù…ÙˆØ±Ø¯ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Ø¯Ø§Ù„Ø© Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„
function printFullReport() {
    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write('<html><head><title>ÙƒØ´Ù Ù…ÙØµÙ„ - {{ supplier.name }}</title>');
    printWindow.document.write('<meta charset="UTF-8">');
    printWindow.document.write('<style>');
    printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
    printWindow.document.write('body { font-family: Arial, sans-serif; direction: rtl; padding: 10px; font-size: 7pt; line-height: 1.2; }');
    printWindow.document.write('h2 { text-align: center; color: #333; margin-bottom: 8px; border-bottom: 2px solid #000; padding-bottom: 5px; font-size: 12pt; }');
    printWindow.document.write('h3 { font-size: 9pt; margin: 8px 0 4px 0; padding: 3px 5px; background-color: #e0e0e0; border-right: 4px solid #667eea; }');
    printWindow.document.write('.supplier-info { border: 1px solid #000; padding: 6px; margin: 8px 0; background-color: #f8f9fa; font-size: 6.5pt; }');
    printWindow.document.write('.supplier-info table { width: 100%; border-collapse: collapse; }');
    printWindow.document.write('.supplier-info td { padding: 2px 4px; border: none; vertical-align: top; }');
    printWindow.document.write('.supplier-info strong { font-weight: bold; }');
    printWindow.document.write('.balance-box { background-color: #e0ffe0; border: 1px solid #000; padding: 3px; margin-top: 3px; font-size: 7pt; }');
    printWindow.document.write('.balance-box.negative { background-color: #ffe0e0; }');
    printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 6px 0; font-size: 6.5pt; }');
    printWindow.document.write('th, td { border: 1px solid #999; padding: 2px 3px; text-align: right; line-height: 1.1; }');
    printWindow.document.write('th { background-color: #e0e0e0; font-weight: bold; text-align: center; font-size: 7pt; }');
    printWindow.document.write('tfoot th, tfoot td { background-color: #f0f0f0; font-weight: bold; padding: 3px; }');
    printWindow.document.write('.badge { display: inline-block; padding: 1px 4px; font-size: 6pt; border-radius: 2px; }');
    printWindow.document.write('.bg-primary { background-color: #007bff; color: white; }');
    printWindow.document.write('.bg-success { background-color: #28a745; color: white; }');
    printWindow.document.write('.bg-danger { background-color: #dc3545; color: white; }');
    printWindow.document.write('.bg-warning { background-color: #ffc107; color: black; }');
    printWindow.document.write('.bg-info { background-color: #17a2b8; color: white; }');
    printWindow.document.write('.section { margin-bottom: 10px; page-break-inside: avoid; }');
    printWindow.document.write('.footer { text-align: center; font-size: 6pt; color: #666; margin-top: 10px; border-top: 1px solid #ccc; padding-top: 5px; }');
    printWindow.document.write('@page { margin: 0.8cm; size: A4 portrait; }');
    printWindow.document.write('</style></head><body>');
    
    // Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
    printWindow.document.write('<h2>ÙƒØ´Ù Ù…ÙØµÙ„ Ù„Ù„Ù…ÙˆØ±Ø¯: {{ supplier.name }}</h2>');
    
    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
    printWindow.document.write('<div class="supplier-info">');
    printWindow.document.write('<table><tr>');
    printWindow.document.write('<td style="width: 50%;">');
    printWindow.document.write('<div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ supplier.name }}</div>');
    printWindow.document.write('<div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ supplier.phone or "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</div>');
    printWindow.document.write('<div><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> {{ supplier.email or "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</div>');
    printWindow.document.write('</td>');
    printWindow.document.write('<td style="width: 50%; border-right: 1px solid #000;">');
    {% if start_date and end_date %}
    printWindow.document.write('<div><strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† {{ start_date }} Ø¥Ù„Ù‰ {{ end_date }}</div>');
    {% endif %}
    printWindow.document.write('<div class="balance-box {% if current_balance < 0 %}negative{% endif %}"><strong>Ø§Ù„Ø±ØµÙŠØ¯:</strong> {{ current_balance|format_currency }}');
    {% if current_balance > 0 %}
    printWindow.document.write(' <strong>(Ù„Ù‡ Ø¹Ù„ÙŠÙ†Ø§)</strong>');
    {% elif current_balance < 0 %}
    printWindow.document.write(' <strong>(Ù„Ù†Ø§ Ø¹Ù„ÙŠÙ‡)</strong>');
    {% endif %}
    printWindow.document.write('</div>');
    printWindow.document.write('<div style="font-size: 6pt; margin-top: 2px;"><strong>Ø·ÙØ¨Ø¹:</strong> ' + new Date().toLocaleDateString('ar-EG') + '</div>');
    printWindow.document.write('</td>');
    printWindow.document.write('</tr></table>');
    printWindow.document.write('</div>');
    
    {% if exchange_transactions %}
    {% set exchange_in = exchange_transactions|selectattr('direction', 'in', ['IN', 'PURCHASE', 'CONSIGN_IN'])|list %}
    {% if exchange_in %}
    // Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØ±ÙŠØ¯
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ“¦ Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØ±ÙŠØ¯ ({{ exchange_in|length }} Ø­Ø±ÙƒØ©) - {{ total_exchange_in|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for tx in exchange_in %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ tx.id }}</td>');
    printWindow.document.write('<td>{{ tx.created_at.strftime("%Y-%m-%d") if tx.created_at else "-" }}</td>');
    printWindow.document.write('<td>{{ tx.product.name if tx.product else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</td>');
    printWindow.document.write('<td>{{ tx.quantity }}</td>');
    printWindow.document.write('<td>{{ tx.unit_cost|format_currency }}</td>');
    printWindow.document.write('<td>{{ (tx.quantity * tx.unit_cost)|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th>{{ total_exchange_in|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    {% endif %}
    
    {% if sales %}
    // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ›’ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ({{ sales|length }} ÙØ§ØªÙˆØ±Ø©) - {{ total_sales|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for sale in sales %}
    {% if sale.lines %}
    {% for line in sale.lines %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ sale.sale_number }}</td>');
    printWindow.document.write('<td>{{ sale.sale_date.strftime("%Y-%m-%d") if sale.sale_date else "-" }}</td>');
    printWindow.document.write('<td>{{ line.product.name if line.product else "-" }}</td>');
    printWindow.document.write('<td>{{ line.quantity }}</td>');
    printWindow.document.write('<td>{{ line.unit_price|format_currency }}</td>');
    printWindow.document.write('<td>{{ (line.quantity * line.unit_price)|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    {% endif %}
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th>{{ total_sales|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if payments_out %}
    // Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§Ø¯Ø±Ø©
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ’¸ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§Ø¯Ø±Ø© ({{ payments_out|length }} Ø¯ÙØ¹Ø©) - {{ total_payments_out|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for payment in payments_out %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ payment.payment_number or payment.id }}</td>');
    printWindow.document.write('<td>{{ payment.payment_date.strftime("%Y-%m-%d") if payment.payment_date else "-" }}</td>');
    printWindow.document.write('<td>{{ payment.method or "Ù†Ù‚Ø¯ÙŠ" }}</td>');
    printWindow.document.write('<td>{{ payment.total_amount|format_currency }}</td>');
    printWindow.document.write('<td>{{ payment.notes or "-" }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th colspan="2">{{ total_payments_out|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if payments_in %}
    // Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ({{ payments_in|length }} Ø¯ÙØ¹Ø©) - {{ total_payments_in|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for payment in payments_in %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ payment.payment_number or payment.id }}</td>');
    printWindow.document.write('<td>{{ payment.payment_date.strftime("%Y-%m-%d") if payment.payment_date else "-" }}</td>');
    printWindow.document.write('<td>{{ payment.method or "Ù†Ù‚Ø¯ÙŠ" }}</td>');
    printWindow.document.write('<td>{{ payment.total_amount|format_currency }}</td>');
    printWindow.document.write('<td>{{ payment.notes or "-" }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th colspan="2">{{ total_payments_in|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if services %}
    // Ø§Ù„ØµÙŠØ§Ù†Ø©
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ”§ Ø§Ù„ØµÙŠØ§Ù†Ø© ({{ services|length }} Ø·Ù„Ø¨) - {{ total_services|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for service in services %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ service.service_number or service.id }}</td>');
    printWindow.document.write('<td>{{ service.received_at.strftime("%Y-%m-%d") if service.received_at else "-" }}</td>');
    printWindow.document.write('<td colspan="2">Ø®Ø¯Ù…Ø© ØµÙŠØ§Ù†Ø©</td>');
    printWindow.document.write('<td>{{ service.total_amount|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th>{{ total_services|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if preorders %}
    // Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© ({{ preorders|length }} Ø­Ø¬Ø²) - {{ total_preorders|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for preorder in preorders %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ preorder.id }}</td>');
    printWindow.document.write('<td>{{ preorder.preorder_date.strftime("%Y-%m-%d") if preorder.preorder_date else "-" }}</td>');
    printWindow.document.write('<td>{{ preorder.product.name if preorder.product else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</td>');
    printWindow.document.write('<td>{{ preorder.quantity }}</td>');
    printWindow.document.write('<td>{{ preorder.unit_price|format_currency }}</td>');
    printWindow.document.write('<td>{{ preorder.total_amount|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th>{{ total_preorders|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    {% if exchange_transactions %}
    {% set exchange_out = exchange_transactions|selectattr('direction', 'in', ['OUT', 'RETURN', 'CONSIGN_OUT'])|list %}
    {% if exchange_out %}
    // Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ“¤ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª ({{ exchange_out|length }} Ø­Ø±ÙƒØ©) - {{ total_exchange_out|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for tx in exchange_out %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ tx.id }}</td>');
    printWindow.document.write('<td>{{ tx.created_at.strftime("%Y-%m-%d") if tx.created_at else "-" }}</td>');
    printWindow.document.write('<td>{{ tx.product.name if tx.product else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</td>');
    printWindow.document.write('<td>{{ tx.quantity }}</td>');
    printWindow.document.write('<td>{{ tx.unit_cost|format_currency }}</td>');
    printWindow.document.write('<td>{{ (tx.quantity * tx.unit_cost)|format_currency }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="5">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th>{{ total_exchange_out|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    {% endif %}
    
    {% if expenses %}
    // Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
    printWindow.document.write('<div class="section">');
    printWindow.document.write('<h3>ğŸ’¼ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ({{ expenses|length }} Ù…ØµØ±ÙˆÙ) - {{ total_expenses|format_currency }}</h3>');
    printWindow.document.write('<table>');
    printWindow.document.write('<thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ÙˆØµÙ</th></tr></thead>');
    printWindow.document.write('<tbody>');
    {% for expense in expenses %}
    printWindow.document.write('<tr>');
    printWindow.document.write('<td>{{ expense.id }}</td>');
    printWindow.document.write('<td>{{ expense.date.strftime("%Y-%m-%d") if expense.date else "-" }}</td>');
    printWindow.document.write('<td>{{ expense.type_id or "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</td>');
    printWindow.document.write('<td>{{ expense.amount|format_currency }}</td>');
    printWindow.document.write('<td>{{ expense.desc or "-" }}</td>');
    printWindow.document.write('</tr>');
    {% endfor %}
    printWindow.document.write('</tbody>');
    printWindow.document.write('<tfoot><tr><th colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</th><th colspan="2">{{ total_expenses|format_currency }}</th></tr></tfoot>');
    printWindow.document.write('</table>');
    printWindow.document.write('</div>');
    {% endif %}
    
    // Ø§Ù„ØªØ°ÙŠÙŠÙ„
    printWindow.document.write('<div class="footer">');
    printWindow.document.write('Ø·ÙØ¨Ø¹ Ø¨ØªØ§Ø±ÙŠØ®: ' + new Date().toLocaleString('en-US'));
    printWindow.document.write('</div>');
    
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    
    setTimeout(function() {
        printWindow.print();
    }, 250);
}

// Ø¯Ø§Ù„Ø© Ù„Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
function printSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;
    
    // ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø·ÙˆÙŠØ§Ù‹
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… jQuery Ù„Ù„Ù€ collapse
    bsCollapse.show();
    
    // Ø§Ù†ØªØ¸Ø§Ø± ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    setTimeout(() => {
        const printWindow = window.open('', '_blank');
        const content = `
            <!DOCTYPE html>
            <html dir="rtl" lang="ar">
            <head>
                <meta charset="UTF-8">
                <title>Ø·Ø¨Ø§Ø¹Ø© - {{ supplier.name }}</title>
                <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/css/adminlte.min.css') }}">
                <style>
                    body { font-family: 'Tajawal', Arial, sans-serif; direction: rtl; }
                    .table { width: 100%; margin-top: 20px; }
                    .table th { background-color: #f8f9fa; }
                    @media print {
                        .no-print { display: none; }
                        body { font-size: 12pt; }
                    }
                </style>
            </head>
            <body>
                <div class="container-fluid p-4">
                    <div class="text-center mb-4">
                        <h2>{{ supplier.name }}</h2>
                        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                    ${section.innerHTML}
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(() => window.close(), 100);
                    };
                <\/script>
            </body>
            </html>
        `;
        printWindow.document.write(content);
        printWindow.document.close();
    }, 300);
}

// Toggle collapse icons
document.addEventListener('DOMContentLoaded', function() {
    const collapsibles = document.querySelectorAll('.collapsible-section');
    collapsibles.forEach(section => {
        const target = section.getAttribute('data-target');
        if (target) {
            const targetEl = document.querySelector(target);
            if (targetEl) {
                targetEl.addEventListener('shown.bs.collapse', () => {
                    section.classList.remove('collapsed');
                });
                targetEl.addEventListener('hidden.bs.collapse', () => {
                    section.classList.add('collapsed');
                });
            }
        }
    });
});
</script>
{% endblock %}
