{% set has_actions = show_actions if show_actions is defined else True %}
{% set row_offset = row_offset if row_offset is defined else 0 %}
{% set print_flag = 1 if print_mode is defined and print_mode else 0 %}
{% set table_id = table_id if table_id is defined else 'customersTable' %}
{% set table_classes = table_classes if table_classes is defined else 'table table-hover table-bordered table-striped align-middle mb-0 text-center table-mobile-friendly' %}
{% set current_sort = current_sort if current_sort is defined else 'balance' %}
{% set current_order = current_order if current_order is defined else 'asc' %}
<div class="table-responsive">
  <table id="{{ table_id }}" class="{{ table_classes }}" data-dt-skip="true" data-print-mode="{{ print_flag }}" data-has-actions="{{ 1 if has_actions else 0 }}">
    <thead class="table-primary">
      <tr>
        <th class="hide-mobile">#</th>
        <th class="hide-mobile">
          <div class="d-flex align-items-center justify-content-between">
            <span>تاريخ الإنشاء</span>
            <div class="sort-buttons">
              <button type="button" class="btn-sort {% if current_sort == 'created_at' and current_order == 'asc' %}active{% endif %}" data-sort="created_at" data-order="asc" title="تصاعدي">
                <i class="fas fa-sort-up"></i>
              </button>
              <button type="button" class="btn-sort {% if current_sort == 'created_at' and current_order == 'desc' %}active{% endif %}" data-sort="created_at" data-order="desc" title="تنازلي">
                <i class="fas fa-sort-down"></i>
              </button>
            </div>
          </div>
        </th>
        <th>
          <div class="d-flex align-items-center justify-content-between">
            <span>الاسم</span>
            <div class="sort-buttons">
              <button type="button" class="btn-sort {% if current_sort == 'name' and current_order == 'asc' %}active{% endif %}" data-sort="name" data-order="asc" title="تصاعدي">
                <i class="fas fa-sort-up"></i>
              </button>
              <button type="button" class="btn-sort {% if current_sort == 'name' and current_order == 'desc' %}active{% endif %}" data-sort="name" data-order="desc" title="تنازلي">
                <i class="fas fa-sort-down"></i>
              </button>
            </div>
          </div>
        </th>
        <th>
          <div class="d-flex align-items-center justify-content-between">
            <span>الجوال</span>
            <div class="sort-buttons">
              <button type="button" class="btn-sort {% if current_sort == 'phone' and current_order == 'asc' %}active{% endif %}" data-sort="phone" data-order="asc" title="تصاعدي">
                <i class="fas fa-sort-up"></i>
              </button>
              <button type="button" class="btn-sort {% if current_sort == 'phone' and current_order == 'desc' %}active{% endif %}" data-sort="phone" data-order="desc" title="تنازلي">
                <i class="fas fa-sort-down"></i>
              </button>
            </div>
          </div>
        </th>
        <th class="hide-mobile">
          <div class="d-flex align-items-center justify-content-between">
            <span>التصنيف</span>
            <div class="sort-buttons">
              <button type="button" class="btn-sort {% if current_sort == 'category' and current_order == 'asc' %}active{% endif %}" data-sort="category" data-order="asc" title="تصاعدي">
                <i class="fas fa-sort-up"></i>
              </button>
              <button type="button" class="btn-sort {% if current_sort == 'category' and current_order == 'desc' %}active{% endif %}" data-sort="category" data-order="desc" title="تنازلي">
                <i class="fas fa-sort-down"></i>
              </button>
            </div>
          </div>
        </th>
        <th>
          <div class="d-flex align-items-center justify-content-between">
            <span>الرصيد</span>
            <div class="sort-buttons">
              <button type="button" class="btn-sort {% if current_sort == 'balance' and current_order == 'asc' %}active{% endif %}" data-sort="balance" data-order="asc" title="تصاعدي">
                <i class="fas fa-sort-up"></i>
              </button>
              <button type="button" class="btn-sort {% if current_sort == 'balance' and current_order == 'desc' %}active{% endif %}" data-sort="balance" data-order="desc" title="تنازلي">
                <i class="fas fa-sort-down"></i>
              </button>
            </div>
          </div>
        </th>
        {% if has_actions %}
        <th data-sortable="false">العمليات</th>
        {% endif %}
      </tr>
    </thead>
    <tbody id="customersTableBody">
      {% for customer in customers %}
      <tr class="{% if not customer.is_active %}table-secondary{% endif %}">
        <td class="hide-mobile">{{ loop.index + row_offset }}</td>
        <td class="hide-mobile">{{ customer.created_at|format_date }}</td>
        <td class="text-start">
          <a href="{{ url_for('customers_bp.customer_detail', customer_id=customer.id) }}" class="fw-bold text-primary">
            {{ customer.name }}
          </a>
          {% if customer.supplier_link %}
            <span class="badge bg-purple text-white ms-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" title="مرتبط بالمورد: {{ customer.supplier_link[0].name }}">
              <i class="fas fa-truck ml-1"></i>مورد
            </span>
          {% elif customer.partner_link %}
            <span class="badge bg-pink text-white ms-2" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" title="مرتبط بالشريك: {{ customer.partner_link[0].name }}">
              <i class="fas fa-handshake ml-1"></i>شريك
            </span>
          {% endif %}
        </td>
        <td>{{ customer.phone or '-' }}</td>
        <td class="hide-mobile">{{ customer.category or '-' }}</td>
        {% set display_balance = customer.calculated_balance if customer.calculated_balance is defined else customer.current_balance %}
        {% set display_balance = display_balance if display_balance is not none else 0 %}
        <td class="fw-bold {% if display_balance > 0 %}text-success{% elif display_balance < 0 %}text-danger{% else %}text-secondary{% endif %}" data-sort-value="{{ display_balance }}" data-balance-customer="{{ customer.id }}">
          {{ display_balance|format_currency }}
        </td>
        {% if has_actions %}
        <td class="text-nowrap">
          <div class="table-actions">
            <a href="{{ url_for('customers_bp.customer_detail', customer_id=customer.id) }}" class="btn btn-action-view btn-action-sm" title="عرض">
              <i class="fas fa-eye"></i>
            </a>
            <a href="{{ url_for('customers_bp.edit_customer', customer_id=customer.id) }}" class="btn btn-action-edit btn-action-sm" title="تعديل">
              <i class="fas fa-edit"></i>
            </a>
            <a href="{{ url_for('payments.create_payment') }}?entity_type=CUSTOMER&entity_id={{ customer.id }}&entity_name={{ customer.name|urlencode }}" 
               class="btn btn-action-primary btn-action-sm" title="إضافة دفعة">
              <i class="fas fa-money-bill-wave"></i>
            </a>
            <a href="{{ url_for('customers_bp.account_statement', customer_id=customer.id) }}" class="btn btn-action-report btn-action-sm" title="كشف">
              <i class="fas fa-file-invoice"></i>
            </a>
            <a href="{{ url_for('customers_bp.customer_whatsapp', customer_id=customer.id) }}" class="btn btn-success btn-action-sm" title="واتساب">
              <i class="fab fa-whatsapp"></i>
            </a>
            {% if customer.is_archived %}
            <button type="button" class="btn btn-action-restore btn-action-sm restore-btn"
                    data-id="{{ customer.id }}"
                    data-restore-url="{{ url_for('customers_bp.restore_customer', customer_id=customer.id) }}" title="استعادة">
              <i class="fas fa-undo"></i>
            </button>
            {% else %}
            <button type="button" class="btn btn-action-archive btn-action-sm archive-btn"
                    data-id="{{ customer.id }}"
                    data-archive-url="{{ url_for('customers_bp.archive_customer', customer_id=customer.id) }}" title="أرشفة">
              <i class="fas fa-archive"></i>
            </button>
            {% endif %}
            <button type="button" class="btn btn-warning btn-action-sm delete-btn"
                    data-id="{{ customer.id }}" 
                    data-url="{{ url_for('customers_bp.delete_customer', id=customer.id) }}"
                    title="حذف عادي">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
        {% endif %}
      </tr>
      {% else %}
      <tr><td colspan="{{ 7 if has_actions else 6 }}" class="text-muted text-center">لا توجد نتائج.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
