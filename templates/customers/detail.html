{% extends 'base.html' %}

{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-white px-3 py-2 rounded mb-4">
    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('customers_bp.list_customers') }}">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
    <li class="breadcrumb-item active">ØªÙØ§ØµÙŠÙ„ {{ customer.name }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
  {% set balance_view = balance_breakdown if balance_breakdown and balance_breakdown.success else None %}
  {% if balance_rights_items is not defined %}
    {% set balance_rights_items = [] %}
  {% endif %}
  {% if balance_obligations_items is not defined %}
    {% set balance_obligations_items = [] %}
  {% endif %}
  {% set live_balance = balance_view.balance.amount if balance_view else customer.balance %}
  
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="dashboard-stats-card text-white h-100" style="background:linear-gradient(135deg,#667eea,#764ba2)">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50 mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h6>
            <h3 class="mb-0 fw-bold" data-balance-customer="{{ customer.id }}">{{ live_balance|format_currency }}</h3>
          </div>
          <i class="fas fa-wallet fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="dashboard-stats-card text-white h-100" style="background:linear-gradient(135deg,#00c6ff,#0072ff)">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h6>
            <h3 class="mb-0 fw-bold">{{ (customer.invoices|default([], true))|length }}</h3>
          </div>
          <i class="fas fa-file-invoice fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="dashboard-stats-card text-white h-100" style="background:linear-gradient(135deg,#11998e,#38ef7d)">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h6>
            <h3 class="mb-0 fw-bold">{{ (customer.payments|default([], true))|length }}</h3>
          </div>
          <i class="fas fa-money-bill-wave fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="dashboard-stats-card text-white h-100" style="background:linear-gradient(135deg,#f7971e,#ffd200)">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1" style="color:rgba(0,0,0,0.7)">Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†</h6>
            <h3 class="mb-0 fw-bold" style="color:#000">{{ customer.credit_limit|format_currency }}</h3>
          </div>
          <i class="fas fa-credit-card fa-2x" style="opacity:0.5;color:#000"></i>
        </div>
      </div>
    </div>
  </div>
  
  {% if balance_view %}
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="dashboard-stats-card h-100 text-white" style="background:linear-gradient(135deg,#0ba360,#3cba92)">
        <div class="card-body text-center">
          <h6 class="text-white-50 mb-1">ğŸŸ¢ Ø§Ù„Ø­Ù‚ÙˆÙ‚</h6>
          <h3 class="mb-0 fw-bold">{{ balance_view.rights.total|format_currency }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="dashboard-stats-card h-100 text-white" style="background:linear-gradient(135deg,#f12711,#f5af19)">
        <div class="card-body text-center">
          <h6 class="text-white-50 mb-1">ğŸ”´ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</h6>
          <h3 class="mb-0 fw-bold">{{ balance_view.obligations.total|format_currency }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="dashboard-stats-card h-100 text-white" style="background:linear-gradient(135deg,#141e30,#243b55)">
        <div class="card-body text-center">
          <h6 class="text-white-50 mb-1">ğŸ¯ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</h6>
          <h3 class="mb-0 fw-bold {% if balance_view.balance.amount > 0 %}text-danger{% elif balance_view.balance.amount < 0 %}text-success{% endif %}">
            {{ balance_view.balance.amount|format_currency }}
          </h3>
          <small class="text-white-50">{{ balance_view.balance.action }}</small>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm rounded mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-scale-balanced ml-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</h5>
      <small class="text-muted">{{ balance_view.balance.formula }}</small>
    </div>
    <div class="card-body">
      <div class="row gy-4">
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-success mb-0">ğŸŸ¢ Ø§Ù„Ø­Ù‚ÙˆÙ‚</h6>
            <span class="badge bg-success text-white">{{ balance_view.rights.total|format_currency }}</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-borderless align-middle mb-0">
              <tbody>
                {% if balance_rights_items %}
                  {% for item in balance_rights_items %}
                  {% if item.amount %}
                  <tr>
                    <td>{{ item.label }}</td>
                    <td class="text-end text-success fw-semibold">{{ item.amount|format_currency }}</td>
                  </tr>
                  {% endif %}
                {% endfor %}
                {% else %}
                  <tr><td class="text-muted" colspan="2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-danger mb-0">ğŸ”´ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</h6>
            <span class="badge bg-danger text-white">{{ balance_view.obligations.total|format_currency }}</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-borderless align-middle mb-0">
              <tbody>
                {% if balance_obligations_items %}
                  {% for item in balance_obligations_items %}
                  {% if item.amount %}
                  <tr>
                    <td>{{ item.label }}</td>
                    <td class="text-end text-danger fw-semibold">{{ item.amount|format_currency }}</td>
                  </tr>
                  {% endif %}
                {% endfor %}
                {% else %}
                  <tr><td class="text-muted" colspan="2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="row mt-4 g-3">
        <div class="col-md-4">
          <div class="alert alert-secondary mb-0">
            <div class="small text-muted">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</div>
            <div class="fw-bold">{{ balance_view.opening_balance.amount|format_currency }}</div>
            <small class="text-muted">{{ balance_view.opening_balance.direction }}</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="alert alert-info mb-0">
            <div class="small text-muted">Ø´ÙŠÙƒØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„</div>
            <div class="fw-bold">{{ balance_view.checks.in_progress|format_currency }}</div>
            <small class="text-muted">Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„: {{ balance_view.checks.outstanding|format_currency }}</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="alert alert-light border mb-0">
            <div class="small text-muted">Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
            <div class="fw-bold text-info">Ù‚Ø¨Ø¶Ù†Ø§: {{ balance_view.payments.received|format_currency }}</div>
            <div class="fw-bold text-warning">Ø¯ÙØ¹Ù†Ø§: {{ balance_view.payments.paid|format_currency }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="card shadow-sm rounded">
    <div class="card-header bg-primary text-white">
      <h3 class="card-title"><i class="fas fa-user ml-2"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: {{ customer.name }}</h3>
    </div>

    <div class="card-body">
      <dl class="row mb-4">
        <dt class="col-sm-4 text-end"><i class="fas fa-id-card ml-1"></i> Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</dt>
        <dd class="col-sm-8">{{ customer.name }}</dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-phone ml-1"></i> Ø§Ù„Ø¬ÙˆØ§Ù„</dt>
        <dd class="col-sm-8">{{ customer.phone or '-' }}</dd>

        <dt class="col-sm-4 text-end"><i class="fab fa-whatsapp ml-1"></i> ÙˆØ§ØªØ³Ø§Ø¨</dt>
        <dd class="col-sm-8">
          {% if customer.whatsapp %}
            {% set whatsapp_clean = customer.whatsapp|replace(' ', '') %}
            <a href="https://wa.me/{{ whatsapp_clean }}" target="_blank" class="text-success">
              <i class="fab fa-whatsapp"></i> {{ customer.whatsapp }}
            </a>
          {% else %}
            -
          {% endif %}
        </dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-envelope ml-1"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</dt>
        <dd class="col-sm-8">{{ customer.email or '-' }}</dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-map-marker-alt ml-1"></i> Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</dt>
        <dd class="col-sm-8">{{ customer.address or '-' }}</dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-tags ml-1"></i> Ø§Ù„ØªØµÙ†ÙŠÙ</dt>
        <dd class="col-sm-8">{{ customer.category or '-' }}</dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-credit-card ml-1"></i> Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†</dt>
        <dd class="col-sm-8">{{ customer.credit_limit|format_currency }}</dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-percent ml-1"></i> Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ…</dt>
        <dd class="col-sm-8">{{ customer.discount_rate|format_percent }}</dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-wallet ml-1"></i> Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</dt>
        <dd class="col-sm-8">
          <span class="fw-bold {% if live_balance > 0 %}text-success{% elif live_balance < 0 %}text-danger{% else %}text-secondary{% endif %}" data-balance-customer="{{ customer.id }}">
            {{ live_balance|format_currency }}
          </span>
        </dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-toggle-on ml-1"></i> Ø§Ù„Ø­Ø§Ù„Ø©</dt>
        <dd class="col-sm-8">
          {% if customer.is_active %}
            <span class="badge bg-success">Ù†Ø´Ø·</span>
          {% else %}
            <span class="badge bg-secondary">ØºÙŠØ± Ù†Ø´Ø·</span>
          {% endif %}
        </dd>

        <dt class="col-sm-4 text-end"><i class="fas fa-sticky-note ml-1"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª</dt>
        <dd class="col-sm-8">{{ customer.notes or '-' }}</dd>
      </dl>

      <hr>
      <h5 class="mb-3"><i class="fas fa-chart-pie ml-2"></i> Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
      <ul class="list-group mb-4">
        <li class="list-group-item"><b>Ø¢Ø®Ø± Ø¨ÙŠØ¹:</b> 
          {% set last_sale = (customer.sales|default([], true))[-1] if (customer.sales|default([], true)) else None %}
          {% if last_sale and last_sale.sale_date %}
            {{ last_sale.sale_date|format_date }}
          {% else %}
            â€”
          {% endif %}
        </li>
        <li class="list-group-item"><b>Ø¢Ø®Ø± Ø¯ÙØ¹Ø©:</b> 
          {% set last_payment = (customer.payments|default([], true))[-1] if (customer.payments|default([], true)) else None %}
          {% if last_payment and last_payment.payment_date %}
            {{ last_payment.payment_date|format_date }}
          {% else %}
            â€”
          {% endif %}
        </li>
        <li class="list-group-item"><b>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</b> {{ (customer.invoices|default([], true))|length }}</li>
        <li class="list-group-item"><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª:</b> {{ (customer.payments|default([], true))|length }}</li>
      </ul>

      {% if logs %}
      <h5 class="mb-3"><i class="fas fa-history ml-2"></i> Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</h5>
      <ul class="list-group mb-4">
        {% for log in logs %}
        <li class="list-group-item small">
          <b>{{ log.action|capitalize }}</b> Ø¨ÙˆØ§Ø³Ø·Ø© {{ log.user.username if log.user else 'system' }} â€”
          <span title="{{ log.timestamp }}">{{ log.timestamp|format_datetime if log.timestamp else 'â€”' }}</span>
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('customers_bp.customer_whatsapp', customer_id=customer.id) }}" class="btn btn-success">
          <i class="fab fa-whatsapp ml-1"></i> ÙˆØ§ØªØ³Ø§Ø¨
        </a>
        <a href="{{ url_for('customers_bp.edit_customer', customer_id=customer.id) }}" class="btn btn-warning">
          <i class="fas fa-edit ml-1"></i> ØªØ¹Ø¯ÙŠÙ„
        </a>
        {% if customer.balance and customer.balance > 0 %}
        {% set payment_reference = 'Ø¯ÙØ¹ Ù…Ù† Ø¹Ù…ÙŠÙ„: ' ~ customer.name %}
        {% set payment_notes = 'Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„: ' ~ customer.name %}
        {% if customer.phone %}
          {% set payment_notes = payment_notes ~ ' - Ù‡Ø§ØªÙ: ' ~ customer.phone %}
        {% endif %}
        <a href="{{ url_for('payments.create_payment', 
                           entity_type='CUSTOMER', 
                           entity_id=customer.id,
                           amount=customer.balance,
                           currency=customer.currency if customer.currency else 'ILS',
                           reference=payment_reference,
                           notes=payment_notes,
                           customer_id=customer.id) }}" class="btn btn-outline-success">
          <i class="fas fa-coins ml-1"></i> Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© ({{ customer.balance|number_format(2) }} â‚ª)
        </a>
        {% endif %}
        <button type="button" class="btn btn-warning delete-btn" 
                data-id="{{ customer.id }}"
                data-url="{{ url_for('customers_bp.delete_customer', id=customer.id) }}"
                title="Ø­Ø°Ù Ø¹Ø§Ø¯ÙŠ">
          <i class="fas fa-trash ml-1"></i> Ø­Ø°Ù
        </button>
        <a href="{{ url_for('customers_bp.export_customer_vcf', customer_id=customer.id) }}" class="btn btn-outline-success">
          <i class="fas fa-download ml-1"></i> VCF
        </a>
        <a href="{{ url_for('customers_bp.account_statement', customer_id=customer.id) }}" class="btn btn-outline-primary">
          <i class="fas fa-file-invoice ml-1"></i> ÙƒØ´Ù Ø­Ø³Ø§Ø¨
        </a>
        <a href="{{ url_for('customers_bp.customer_analytics', customer_id=customer.id) }}" class="btn btn-outline-info">
          <i class="fas fa-chart-line ml-1"></i> ØªØ­Ù„ÙŠÙ„Ø§Øª
        </a>
        <a href="{{ url_for('customers_bp.list_customers') }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left ml-1"></i> Ø¹ÙˆØ¯Ø©
        </a>
      </div>
    </div>
  </div>

{% endblock %}

<form id="deleteForm" method="post" style="display:none;">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

{% block scripts %}
  {{ super() }}
  <script>
    // ===== Ø­Ø°Ù Ø¨Ø³ÙŠØ· - confirm ÙÙ‚Ø· =====
    $(document).ready(function() {
      $('.delete-btn').off('click').on('click', function(e) {
        e.preventDefault();
        var customerId = $(this).data('id');
        var url = '/customers/' + customerId + '/delete';
        
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø£Ùˆ Ø±ØµÙŠØ¯.')) {
          $('#deleteForm').attr('action', url).submit();
        }
      });
    });
  </script>
  <script src="{{ url_for('static', filename='js/customers.js') }}"></script>
{% endblock %}
