{% extends 'base.html' %}

{% block title %}تحليلات العميل{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-white px-3 py-2 rounded mb-4">
    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('customers_bp.list_customers') }}">العملاء</a></li>
    <li class="breadcrumb-item active">تحليلات {{ customer.name }}</li>
  </ol>
</nav>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  /* تمنع تمدد الرسوم: نحدد ارتفاع الحاوية، ونجعل الـ canvas يملأها بدون تجاوز */
  .chart-wrap{position:relative;height:300px}
  @media (min-width:768px){.chart-wrap{height:340px}}
  .chart-wrap canvas{width:100%!important;height:100%!important;display:block}
</style>
{% endblock %}

{% block content %}
  <div class="row g-4">

    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <div class="h6 text-muted mb-2">إجمالي المشتريات</div>
          <div class="display-6 fw-bold">{{ total_purchases|format_currency }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <div class="h6 text-muted mb-2">إجمالي الدفعات</div>
          <div class="display-6 fw-bold">{{ total_payments|format_currency }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <div class="h6 text-muted mb-2">متوسط قيمة الفاتورة</div>
          <div class="display-6 fw-bold">{{ avg_purchase|format_currency }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm rounded h-100">
        <div class="card-body">
          <h6 class="mb-3"><i class="fas fa-chart-line me-1"></i>مخطط المشتريات الشهري</h6>
          <div class="chart-wrap">
            <canvas id="purchasesChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm rounded h-100">
        <div class="card-body">
          <h6 class="mb-3"><i class="fas fa-chart-line me-1"></i>مخطط الدفعات الشهري</h6>
          <div class="chart-wrap">
            <canvas id="paymentsChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm rounded">
        <div class="card-body">
          <h5 class="mb-3"><i class="fas fa-list-ul me-1"></i>فئات المشتريات</h5>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>الفئة</th>
                  <th>عدد العمليات</th>
                  <th>الإجمالي</th>
                  <th>النسبة المئوية</th>
                </tr>
              </thead>
              <tbody>
                {% for cat in purchase_categories %}
                <tr>
                  <td>{{ cat.name }}</td>
                  <td>{{ cat.count }}</td>
                  <td>{{ cat.total|format_currency }}</td>
                  <td>{{ cat.percentage|round(2) }}%</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted">لا توجد بيانات.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const monthsP = {{ purchases_months|map(attribute='month')|list|tojson }};
  const dataP   = {{ purchases_months|map(attribute='total')|list|tojson }};
  const monthsPay = {{ payments_months|map(attribute='month')|list|tojson }};
  const dataPay   = {{ payments_months|map(attribute='total')|list|tojson }};

  if (window.Chart) {
    // نتأكد من عدم إنشاء الرسوم مرتين عند إعادة الدخول للصفحة
    window.__charts__ = window.__charts__ || {};
    const destroyIf = (k) => { if (window.__charts__[k]) { window.__charts__[k].destroy(); window.__charts__[k] = null; } };

    const ctx1 = document.getElementById('purchasesChart');
    destroyIf('p');
    window.__charts__['p'] = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: monthsP,
        datasets: [{
          label: 'مشتريات',
          data: dataP,
          borderColor: '#17a2b8',
          backgroundColor: 'rgba(23, 162, 184, 0.2)',
          fill: true,
          tension: 0.35,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,   // يملأ ارتفاع الحاوية المحدد في CSS
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true } }
      }
    });

    const ctx2 = document.getElementById('paymentsChart');
    destroyIf('pay');
    window.__charts__['pay'] = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: monthsPay,
        datasets: [{
          label: 'دفعات',
          data: dataPay,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.2)',
          fill: true,
          tension: 0.35,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>
{% endblock %}
