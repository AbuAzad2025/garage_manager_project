{% extends 'base.html' %}

{% block title %}تحليلات العميل{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-white px-3 py-2 rounded mb-4">
    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('customers_bp.list_customers') }}">العملاء</a></li>
    <li class="breadcrumb-item active">تحليلات {{ customer.name }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="row g-4">

    <div class="col-md-4">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ total_purchases|format_currency }}</h3>
          <p>إجمالي المشتريات</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ total_payments|format_currency }}</h3>
          <p>إجمالي الدفعات</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ avg_purchase|format_currency }}</h3>
          <p>متوسط قيمة الفاتورة</p>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm rounded">
        <div class="card-body">
          <h6 class="mb-3"><i class="fas fa-chart-line me-1"></i>مخطط المشتريات الشهري</h6>
          <canvas id="purchasesChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm rounded">
        <div class="card-body">
          <h6 class="mb-3"><i class="fas fa-chart-line me-1"></i>مخطط الدفعات الشهري</h6>
          <canvas id="paymentsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm rounded">
        <div class="card-body">
          <h5 class="mb-3"><i class="fas fa-list-ul me-1"></i>فئات المشتريات</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="thead-light">
                <tr>
                  <th>الفئة</th>
                  <th>عدد العمليات</th>
                  <th>الإجمالي</th>
                  <th>النسبة المئوية</th>
                </tr>
              </thead>
              <tbody>
                {% for cat in purchase_categories %}
                <tr>
                  <td>{{ cat.name }}</td>
                  <td>{{ cat.count }}</td>
                  <td>{{ cat.total|format_currency }}</td>
                  <td>{{ cat.percentage|round(2) }}%</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const monthsP = {{ purchases_months|map(attribute='month')|list|tojson }};
    const dataP   = {{ purchases_months|map(attribute='total')|list|tojson }};
    const ctx1    = document.getElementById('purchasesChart');
    new Chart(ctx1, {
      type: 'line',
      data: {
        labels: monthsP,
        datasets: [{
          label: 'مشتريات',
          data: dataP,
          borderColor: '#17a2b8',
          backgroundColor: 'rgba(23, 162, 184, 0.2)',
          fill: true,
          tension: 0.4
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    const monthsPay = {{ payments_months|map(attribute='month')|list|tojson }};
    const dataPay   = {{ payments_months|map(attribute='total')|list|tojson }};
    const ctx2      = document.getElementById('paymentsChart');
    new Chart(ctx2, {
      type: 'line',
      data: {
        labels: monthsPay,
        datasets: [{
          label: 'دفعات',
          data: dataPay,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.2)',
          fill: true,
          tension: 0.4
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  </script>
{% endblock %}
