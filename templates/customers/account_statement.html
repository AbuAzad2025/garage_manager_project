{% extends 'base.html' %}

{% block title %}ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„{% endblock %}

{% block head_extra %}
<style>
  /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© */
  .print-header-info,
  .print-customer-info,
  .print-footer-info {
    display: none !important;
  }
  
  /* === ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© === */
  @media print {
    /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ© */
    .no-print,
    .btn,
    .table-export-btn,
    .breadcrumb,
    nav,
    .main-sidebar,
    .main-header,
    .main-footer,
    .d-flex.gap-2,
    .card.shadow-sm,
    .row.g-3 {
      display: none !important;
    }
    
    /* Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .print-header-info,
    .print-customer-info,
    .print-footer-info {
      display: block !important;
    }
    
    /* Ø§Ù„ØµÙØ­Ø© */
    @page {
      margin: 1cm;
      size: A4 portrait;
    }
    
    body, html {
      font-size: 7pt !important;
      line-height: 1 !important;
      margin: 0;
      padding: 0;
    }
    
    .content-wrapper {
      margin: 0 !important;
      padding: 0 !important;
      max-width: 100% !important;
    }
    
    /* ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .print-header-info {
      display: block !important;
      margin-bottom: 8px;
      padding: 8px;
      border: 2px solid #000;
      background-color: #f8f9fa !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .print-header-info .company-name {
      font-size: 10pt !important;
      font-weight: bold;
      text-align: center;
      margin-bottom: 4px;
    }
    
    .print-header-info .statement-type h2 {
      font-size: 9pt !important;
      font-weight: bold;
      text-align: center;
      margin: 2px 0 4px 0;
      border-bottom: 1px solid #666;
      padding-bottom: 2px;
    }
    
    .print-header-info .statement-date,
    .print-header-info .user-info {
      font-size: 6pt !important;
      text-align: center;
    }
    
    /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .print-customer-info {
      display: block !important;
      font-size: 6pt !important;
      border: 1px solid #000;
      padding: 5px;
      margin-bottom: 5px;
      background-color: #ffffff !important;
    }
    
    .print-customer-info table {
      width: 100%;
      font-size: 6pt !important;
    }
    
    .print-customer-info td {
      padding: 2px 4px;
      border: none;
      vertical-align: top;
    }
    
    .print-customer-info strong {
      font-weight: bold;
    }
    
    /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯ */
    .print-customer-info .balance-box {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ù…Ø¶ØºÙˆØ· */
    .table {
      font-size: 5pt !important;
      width: 100% !important;
      border-collapse: collapse !important;
      margin: 0 !important;
    }
    #statementTable {
      font-size: 5pt !important;
      width: 100% !important;
      border-collapse: collapse !important;
      margin: 0 !important;
      table-layout: auto !important;
    }
    
    .table th,
    .table td,
    #statementTable th,
    #statementTable td {
      padding: 1px 2px !important;
      line-height: 1 !important;
      border: 0.5px solid #000 !important;
      font-size: 5pt !important;
    }
    
    .table thead th,
    #statementTable thead th {
      font-size: 6pt !important;
      padding: 2px !important;
      font-weight: bold !important;
      background-color: #e0e0e0 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      text-align: center !important;
    }
    
    .table tfoot th,
    .table tfoot td,
    #statementTable tfoot th,
    #statementTable tfoot td {
      font-size: 6pt !important;
      padding: 2px !important;
      font-weight: bold !important;
      background-color: #f0f0f0 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© - Ø£ØµØºØ± */
    .sale-items-details {
      padding: 0 !important;
      margin: 0 !important;
      background-color: #fafafa !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .sale-items-details table {
      font-size: 4pt !important;
      width: 100% !important;
    }
    
    .sale-items-details th,
    .sale-items-details td {
      padding: 1px !important;
      font-size: 4pt !important;
      line-height: 1 !important;
      border: 0.5px solid #999 !important;
    }
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© */
    .card-body > .row.g-3,
    .card.shadow-sm {
      display: none !important;
    }
  }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-white px-3 py-2 rounded mb-4">
    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('customers_bp.list_customers') }}">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
    <li class="breadcrumb-item active">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ {{ customer.name }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-header-info">
  <div class="statement-type">
    <h2>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„</h2>
  </div>
</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø±ØµÙŠØ¯ - Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-customer-info">
  <table style="width: 100%; border-collapse: collapse;">
    <tr>
      <td style="width: 55%; padding: 4px; vertical-align: top;">
        <div style="margin-bottom: 3px;">
          <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ customer.name }}
        </div>
        <div>
          <strong>Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> {{ customer.phone or 'â€”' }}
        </div>
        {% if customer.address %}
        <div style="margin-top: 2px;">
          <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> {{ customer.address }}
        </div>
        {% endif %}
      </td>
      <td style="width: 45%; padding: 4px; border-right: 1px solid #000; vertical-align: top;">
        <div style="margin-bottom: 3px;">
          <strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† {{ start_date|format_date }} Ø¥Ù„Ù‰ {{ end_date|format_date }}
        </div>
        <div class="balance-box" style="margin-bottom: 3px; font-size: 7pt; padding: 3px; background-color: {% if balance > 0 %}#e0ffe0{% elif balance < 0 %}#ffe0e0{% else %}#f0f0f0{% endif %}; border: 1px solid #000; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
          <strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> {{ balance|format_currency }}
          {% if balance > 0 %}
            <strong style="color: #28a745;">(Ù„Ù‡ Ø¹Ù„ÙŠÙ†Ø§)</strong>
          {% elif balance < 0 %}
            <strong style="color: #dc3545;">(Ø¹Ù„ÙŠÙ‡ Ù„Ù†Ø§)</strong>
          {% else %}
            (Ù…ØªÙˆØ§Ø²Ù†)
          {% endif %}
        </div>
        <div style="font-size: 5pt;">
          <strong>Ø·ÙØ¨Ø¹:</strong> {{ now()|format_date }} - {{ current_user.username if current_user.is_authenticated else 'Ø§Ù„Ù†Ø¸Ø§Ù…' }}
        </div>
      </td>
    </tr>
  </table>
</div>

<!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· -->
<div class="print-footer-info">
  <div class="footer-line print-time">
    ØµÙØ­Ø© <span class="page-number"></span>
  </div>
</div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
  <div class="d-flex flex-wrap gap-2 mb-3 no-print">
    <a class="btn btn-outline-secondary" href="{{ url_for('customers_bp.customer_detail', customer_id=customer.id) }}">
      <i class="fas fa-arrow-right ms-1"></i> Ø±Ø¬ÙˆØ¹
    </a>
    {% if not pdf_export %}
    <a class="btn btn-outline-primary" href="{{ url_for('customers_bp.account_statement', customer_id=customer.id, format='pdf') }}" target="_blank">
      <i class="fas fa-file-pdf ms-1"></i> ØªØµØ¯ÙŠØ± PDF
    </a>
    {% endif %}
  </div>

  <!-- ğŸ‘¤ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
  <div class="card shadow-sm border mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h3 class="mb-2"><i class="fas fa-user-circle"></i> {{ customer.name }}</h3>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><i class="fas fa-phone"></i> <strong>Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> {{ customer.phone or 'â€”' }}</p>
              <p class="mb-1"><i class="fas fa-envelope"></i> <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> {{ customer.email or 'â€”' }}</p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><i class="fas fa-map-marker-alt"></i> <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> {{ customer.address or 'â€”' }}</p>
              <p class="mb-1"><i class="fas fa-tag"></i> <strong>Ø§Ù„ØªØµÙ†ÙŠÙ:</strong> {{ customer.category or 'Ø¹Ø§Ø¯ÙŠ' }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-center">
          <div class="p-3 rounded border" style="background: #f8f9fa;">
            <h6 class="mb-1 text-muted">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h6>
            <h2 class="mb-0 fw-bold" data-balance-customer="{{ customer.id }}">
              {% if balance > 0 %}
                <span class="text-success">{{ balance|format_currency }}</span>
                <br><small style="font-size: 0.6em;">Ù„Ù‡ Ø¹Ù„ÙŠÙ†Ø§</small>
              {% elif balance < 0 %}
                <span class="text-danger">{{ balance|abs|format_currency }}</span>
                <br><small style="font-size: 0.6em;">Ø¹Ù„ÙŠÙ‡ Ù„Ù†Ø§</small>
              {% else %}
                <span class="text-secondary">{{ balance|format_currency }}</span>
                <br><small style="font-size: 0.6em;">Ù…ØªÙˆØ§Ø²Ù†</small>
              {% endif %}
            </h2>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
  <div class="row g-3 mb-4">
    {% set stats = [
      ('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠÙ†', total_debit, 'text-danger', 'fa-arrow-down'),
      ('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯Ø§Ø¦Ù†', total_credit, 'text-success', 'fa-arrow-up'),
      ('Ø§Ù„Ø±ØµÙŠØ¯', balance, balance > 0 and 'text-success' or (balance < 0 and 'text-danger' or ''), 'fa-balance-scale')
    ] %}
    {% for label, value, color_class, icon in stats %}
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">{{ label }}</div>
              <div class="fs-5 fw-bold {{ color_class }}">{{ value|format_currency }}</div>
            </div>
            <i class="fas {{ icon }} fs-4 {{ color_class or 'text-secondary' }}"></i>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙØ¦Ø§Øª -->
  <div class="row g-3 mb-4">
    {% set categories = [
      ('ÙÙˆØ§ØªÙŠØ±', total_invoices),
      ('Ù…Ø¨ÙŠØ¹Ø§Øª', total_sales),
      ('Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª', total_sale_returns),
      ('Ø§Ù„ØµÙŠØ§Ù†Ø©', total_services),
      ('Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø³Ø¨Ù‚Ø©', total_preorders),
      ('Ø­Ø¬ÙˆØ²Ø§Øª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', total_online_preorders),
    ] %}
    {% for label, value in categories %}
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">{{ label }}</div>
          <div class="fs-6 fw-bold">{{ (value or 0)|format_currency }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª -->
  {% set type_labels = {
    'INVOICE': 'ÙØ§ØªÙˆØ±Ø©',
    'SALE': 'Ø¨ÙŠØ¹',
    'SALE_RETURN': 'Ù…Ø±ØªØ¬Ø¹ Ø¨ÙŠØ¹',
    'SERVICE': 'ØµÙŠØ§Ù†Ø©',
    'PREORDER': 'Ø­Ø¬Ø² Ù…Ø³Ø¨Ù‚',
    'ONLINE_PREORDER': 'Ø­Ø¬Ø² Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†',
    'PAYMENT': 'Ø¯ÙØ¹Ø©',
    'CHECK_PENDING': 'Ø´ÙŠÙƒ Ù…Ø¹Ù„Ù‚',
    'CHECK_BOUNCED': 'Ø´ÙŠÙƒ Ù…Ø±ØªØ¯',
    'CHECK_CASHED': 'Ø´ÙŠÙƒ Ù…Ø³Ø­ÙˆØ¨',
    'CHECK_RESUBMITTED': 'Ø´ÙŠÙƒ Ø£Ø¹ÙŠØ¯ Ù„Ù„Ø¨Ù†Ùƒ',
    'CHECK_CANCELLED': 'Ø´ÙŠÙƒ Ù…Ù„ØºÙŠ',
    'CHECK_LEGAL': 'Ø´ÙŠÙƒ Ø¯Ø§Ø¦Ø±Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©',
    'CHECK_SETTLED': 'Ø´ÙŠÙƒ Ù…Ø³ÙˆÙ‘Ù‰',
    'OPENING_BALANCE': 'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ',
    'ONLINE_PREORDER': 'Ø·Ù„Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†',
    'ONLINE_PREPAID': 'Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†'
  } %}
  {% set type_badges = {
    'INVOICE': 'bg-secondary',
    'SALE': 'bg-info',
    'SALE_RETURN': 'bg-secondary',
    'SERVICE': 'bg-warning text-dark',
    'PREORDER': 'bg-dark',
    'ONLINE_PREORDER': 'bg-primary',
    'PAYMENT': 'bg-success',
    'CHECK_PENDING': 'bg-warning text-dark',
    'CHECK_BOUNCED': 'bg-danger',
    'CHECK_CASHED': 'bg-success',
    'CHECK_RESUBMITTED': 'bg-info',
    'CHECK_CANCELLED': 'bg-secondary',
    'CHECK_LEGAL': 'bg-dark text-white',
    'CHECK_SETTLED': 'bg-success text-white',
    'OPENING_BALANCE': 'bg-purple text-white'
  } %}

  <div class="card shadow-sm rounded" style="overflow-x:auto;">
    <div class="card-header bg-primary text-white">
      <h5 class="card-title m-0">
        <i class="fas fa-file-invoice ms-2"></i> ÙƒØ´Ù Ø­Ø³Ø§Ø¨: {{ customer.name }}
      </h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h5 class="mb-0">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h5>
        <button class="btn btn-sm btn-primary" onclick="printStatementTable()">
          <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle" id="statementTable" style="border: 2px solid #dee2e6; border-collapse: collapse;">
          <thead class="table-light" style="background-color: #f8f9fa;">
            <tr>
              <th style="width: 100px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th style="width: 180px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th style="width: 110px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">Ù…Ø¯ÙŠÙ†</th>
              <th style="width: 110px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">Ø¯Ø§Ø¦Ù†</th>
              <th style="width: 110px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">Ø§Ù„Ø±ØµÙŠØ¯</th>
            </tr>
          </thead>
          <tbody>
            {% for e in ledger_entries %}
            <tr>
              {# Ø§Ù„ØªØ§Ø±ÙŠØ® #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">{{ e.date|format_date }}</td>
              
              {# Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: start;">
                {# Ù„Ù„Ø¯ÙØ¹Ø§Øª - Ø¯ÙØ¹Ø© (Ø·Ø±ÙŠÙ‚Ø©) Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ - Ù„ÙŠØ¬ (Ø§Ù„Ù…Ø³ØªÙ„Ù…) #}
                {% if (e.type in ['PAYMENT', 'CHECK_BOUNCED', 'CHECK_PENDING', 'CHECK_CASHED', 'CHECK_RESUBMITTED', 'CHECK_CANCELLED', 'CHECK_LEGAL', 'CHECK_SETTLED']) and e.get('payment_details') %}
                  {% set pd = e.payment_details %}
                  
                  {# Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´ÙŠÙƒ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© #}
                  {% if e.type == 'CHECK_LEGAL' %}
                    <span class="badge bg-dark text-white"><i class="fas fa-gavel"></i> Ø´ÙŠÙƒ Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</span>
                  {% elif e.type == 'CHECK_SETTLED' %}
                    <span class="badge bg-success text-white"><i class="fas fa-handshake"></i> Ø´ÙŠÙƒ Ù…Ø³ÙˆÙ‘Ù‰</span>
                  {% elif e.type == 'CHECK_BOUNCED' %}
                    <span class="badge bg-danger"><i class="fas fa-ban"></i> Ø´ÙŠÙƒ Ù…Ø±ÙÙˆØ¶</span>
                  {% elif e.type == 'CHECK_RESUBMITTED' %}
                    <span class="badge bg-info"><i class="fas fa-sync"></i> Ø´ÙŠÙƒ Ø£Ø¹ÙŠØ¯ Ù„Ù„Ø¨Ù†Ùƒ</span>
                  {% elif e.type == 'CHECK_CASHED' %}
                    <span class="badge bg-success"><i class="fas fa-check-circle"></i> Ø´ÙŠÙƒ Ù…Ø³Ø­ÙˆØ¨</span>
                  {% elif e.type == 'CHECK_CANCELLED' %}
                    <span class="badge bg-secondary"><i class="fas fa-times-circle"></i> Ø´ÙŠÙƒ Ù…Ù„ØºÙŠ</span>
                  {% elif e.type == 'CHECK_PENDING' %}
                    <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Ø´ÙŠÙƒ Ù…Ø¹Ù„Ù‚</span>
                  {% else %}
                    Ø¯ÙØ¹Ø©
                  {% endif %}
                  
                  {# Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ - Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø¯ÙˆÙ† Ø£Ù„ÙˆØ§Ù† #}
                  {% set method = pd.method_raw|lower if pd.method_raw else '' %}
                  {% if method == 'cash' %}
                    (Ù†Ù‚Ø¯Ø§Ù‹)
                  {% elif method == 'card' %}
                    (Ø¨Ø·Ø§Ù‚Ø©)
                  {% elif method == 'cheque' %}
                    (Ø´ÙŠÙƒ
                    {% if pd.check_number %} #{{ pd.check_number }}{% endif %}
                    {% if pd.check_due_date %} - Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ pd.check_due_date|format_date }}{% endif %}
                    {% if pd.check_bank %} - {{ pd.check_bank }}{% endif %})
                  {% elif method == 'bank' %}
                    (ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ)
                  {% elif method == 'online' %}
                    (Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ)
                  {% elif pd.method %}
                    ({{ pd.method }})
                  {% else %}
                    (Ù†Ù‚Ø¯Ø§Ù‹)
                  {% endif %}
                  
                  {% if e.type != 'CHECK_BOUNCED' %}
                    Ø³Ù†Ø¯ Ù‚Ø¨Ø¶
                  {% endif %}
                  
                  {# Ø§Ù„Ù…Ø³ØªÙ„Ù… - Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ #}
                  {% if pd.deliverer_name %}
                    - Ø³Ù„ÙÙ‘Ù… ({{ pd.deliverer_name }})
                  {% endif %}
                  {% if pd.receiver_name %}
                    - Ù„Ù€ÙŠÙ€Ø¯ ({{ pd.receiver_name }})
                  {% endif %}
                  
                  {# ØªÙØ§ØµÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙŠÙƒ #}
                  {% if e.type == 'CHECK_LEGAL' %}
                    <br><span class="text-dark"><strong>âš–ï¸ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´ÙŠÙƒ Ù„Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</strong></span>
                  {% elif e.type == 'CHECK_SETTLED' %}
                    <br><span class="text-success"><strong>âœ… ØªÙ… ØªØ³ÙˆÙŠØ© Ø§Ù„Ø´ÙŠÙƒ Ù…Ø§Ù„ÙŠØ§Ù‹</strong></span>
                  {% elif e.type == 'CHECK_BOUNCED' %}
                    <br><span class="text-danger"><strong>âš ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø±ØµÙŠØ¯</strong></span>
                  {% elif e.type == 'CHECK_RESUBMITTED' %}
                    <br><span class="text-info"><strong>ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø´ÙŠÙƒ Ù„Ù„Ø¨Ù†Ùƒ</strong></span>
                  {% elif e.type == 'CHECK_CASHED' %}
                    <br><span class="text-success"><strong>âœ… ØªÙ… ØµØ±Ù Ø§Ù„Ø´ÙŠÙƒ Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ</strong></span>
                  {% elif e.type == 'CHECK_CANCELLED' %}
                    <br><span class="text-secondary"><strong>ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´ÙŠÙƒ</strong></span>
                  {% elif e.type == 'CHECK_PENDING' %}
                    <br><span class="text-warning"><strong>â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ</strong></span>
                  {% endif %}
                  
                  {# Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¯ÙØ¹Ø© #}
                  {% if pd.all_checks and pd.all_checks|length > 1 %}
                    <br><div class="mt-2 p-2" style="background-color: #f8f9fa; border-left: 3px solid #007bff; font-size: 0.9em;">
                      <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:</strong>
                      <ul class="mb-0 mt-1" style="padding-right: 20px;">
                        {% for chk in pd.all_checks %}
                        <li>
                          <strong>Ø´ÙŠÙƒ #{{ chk.check_number or 'â€”' }}</strong>
                          {% if chk.check_bank %} - {{ chk.check_bank }}{% endif %}
                          {% if chk.check_due_date %} - Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ chk.check_due_date|format_date }}{% endif %}
                          <span class="badge badge-{{ 'danger' if chk.status in ['RETURNED','BOUNCED'] else 'warning' if chk.status == 'PENDING' else 'success' if chk.status == 'CASHED' else 'info' if chk.status == 'RESUBMITTED' else 'secondary' }}">
                            {{ chk.status }}
                          </span>
                          {% if chk.is_legal %}<span class="badge badge-dark">Ø¯Ø§Ø¦Ø±Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</span>{% endif %}
                          {% if chk.is_settled %}<span class="badge badge-success">Ù…Ø³ÙˆÙ‘Ù‰</span>{% endif %}
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                
                {# Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª #}
                {% elif e.type == 'SALE' %}
                  Ø¨ÙŠØ¹ - Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹
                  {% if e.get('items') and e.get('items')|length > 0 %}
                    {{ e.get('items')|length }} ØµÙ†Ù
                  {% endif %}
                
                {% elif e.type == 'SALE_RETURN' %}
                  Ù…Ø±ØªØ¬Ø¹ Ø¨ÙŠØ¹
                  {% if e.ref %}
                    - {{ e.ref }}
                  {% endif %}
                
                {# Ù„Ù„ÙÙˆØ§ØªÙŠØ± #}
                {% elif e.type == 'INVOICE' %}
                  ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹
                  {% if e.ref %}
                    - {{ e.ref }}
                  {% endif %}
                
                {# Ù„Ù„Ø®Ø¯Ù…Ø§Øª #}
                {% elif e.type == 'SERVICE' %}
                  ØµÙŠØ§Ù†Ø© - Ø®Ø¯Ù…Ø© ØµÙŠØ§Ù†Ø©
                
                {# Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª #}
                {% elif e.type == 'PREORDER' %}
                  Ø­Ø¬Ø² Ù…Ø³Ø¨Ù‚
                  {% if e.ref %}
                    - {{ e.ref }}
                  {% endif %}
                
                {# Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† #}
                {% elif e.type == 'ONLINE_PREORDER' %}
                  Ø·Ù„Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                  {% if e.ref %}
                    - {{ e.ref }}
                  {% endif %}
                
                {# Ù„Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† #}
                {% elif e.type == 'ONLINE_PREPAID' %}
                  Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© - Ø·Ù„Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                  {% if e.ref %}
                    - {{ e.ref }}
                  {% endif %}
                
                {# Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ #}
                {% elif e.type == 'OPENING_BALANCE' %}
                  Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ
                
                {# Ø£ÙŠ Ù†ÙˆØ¹ Ø¢Ø®Ø± #}
                {% else %}
                  {{ e.statement }}
                {% endif %}
              </td>
              
              {# Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: start;">
                {% if e.notes %}
                  {{ e.notes[:80] }}{% if e.notes|length > 80 %}...{% endif %}
                {% else %}
                  â€”
                {% endif %}
              </td>
              
              {# Ø§Ù„Ù…Ø¯ÙŠÙ† #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: end; font-weight: 500;">{{ e.debit|format_currency }}</td>
              
              {# Ø§Ù„Ø¯Ø§Ø¦Ù† #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: end; font-weight: 500;">{{ e.credit|format_currency }}</td>
              
              {# Ø§Ù„Ø±ØµÙŠØ¯ #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: end; font-weight: bold; {% if e.balance > 0 %}color: #28a745;{% elif e.balance < 0 %}color: #dc3545;{% endif %}">
                {{ e.balance|format_currency }}
              </td>
            </tr>
            
            {% if (e.type in ['PAYMENT','CHECK_BOUNCED','CHECK_PENDING']) and e.get('payment_details') and e.payment_details.get('splits') %}
            <tr class="payment-splits-row">
              <td colspan="6" class="p-0">
                <div class="payment-split-details" style="background-color:#f9fbff; padding:10px; margin:5px;">
                  <table class="table table-sm table-bordered mb-0" style="font-size:0.85em; border:1px solid #dee2e6;">
                    <thead style="background-color:#e9ecef;">
                      <tr>
                        <th style="width:25%; text-align:start;">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                        <th style="width:18%; text-align:end;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th style="width:12%; text-align:center;">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                        <th style="width:18%; text-align:end;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„</th>
                        <th style="width:12%; text-align:center;">Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³</th>
                        <th style="width:15%; text-align:center;">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for split in e.payment_details.splits %}
                      <tr>
                        <td style="text-align:start;">{{ split.method }}</td>
                        <td style="text-align:end;">{{ split.amount|format_currency }}</td>
                        <td style="text-align:center;">{{ split.currency }}</td>
                        <td style="text-align:end;">{{ split.converted_amount|format_currency }}</td>
                        <td style="text-align:center;">{{ split.converted_currency }}</td>
                        <td style="text-align:center;">
                          {% if split.fx_rate %}
                            {{ "%.6f"|format(split.fx_rate) }}
                          {% else %}
                            â€”
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
            {% endif %}
            
            {# Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ØªØ­Øª ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ #}
            {% if e.type == 'SALE' and e.get('items') %}
            <tr class="sale-items-row">
              <td colspan="6" class="p-0">
                <div class="sale-items-details" style="background-color: #f8f9fa; padding: 10px; margin: 5px;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 0.85em; border: 1px solid #dee2e6;">
                    <thead style="background-color: #e9ecef;">
                      <tr>
                        <th style="width: 35%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">Ø§Ù„Ø¨Ù†Ø¯</th>
                        <th style="width: 10%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th style="width: 12%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th style="width: 13%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th style="width: 15%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                        <th style="width: 15%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in e.get('items', []) %}
                      <tr>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: start;">{{ item.name }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">{{ item.quantity }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: end;">{{ item.unit_price|format_currency }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: end; font-weight: 500;">{{ item.total|format_currency }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: start;">{{ item.receiver or 'â€”' }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: start;">{{ item.note or 'â€”' }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
            {% endif %}
            
            {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª.</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot style="background-color: #f8f9fa;">
            <tr>
              <th colspan="3" style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; text-align: end; font-weight: bold;">{{ total_debit|format_currency }}</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; text-align: end; font-weight: bold;">{{ total_credit|format_currency }}</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; text-align: end; font-weight: bold; {% if balance > 0 %}color: #28a745;{% elif balance < 0 %}color: #dc3545;{% endif %}">
                {{ balance|format_currency }}
              </th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
{% if not pdf_export %}
<script>
  {% if ledger_entries|length > 10 %}
  try {
    $('#statementTable').DataTable({
      language: {
        url: '{{ url_for("static", filename="datatables/Arabic.json") }}'
      },
      pageLength: 25,
      order: [[0, 'desc']],
      dom: 'frtip',
      searching: true,
      paging: true,
      info: true
    });
  } catch (err) {
    console.warn('DataTables initialization skipped:', err);
  }
  {% endif %}
  window.printStatementTable = function() {
    const table = document.getElementById('statementTable');
    if (!table) return;

    const printData = {
      customerName: {{ customer.name|tojson }},
      customerPhone: {{ (customer.phone or '')|tojson }},
      customerAddress: {{ (customer.address or '')|tojson }},
      periodStart: {{ (start_date|format_date if start_date else '')|tojson }},
      periodEnd: {{ (end_date|format_date if end_date else '')|tojson }},
      balanceText: {{ balance|format_currency|tojson }},
      balanceState: {% if balance > 0 %}'due'{% elif balance < 0 %}'owed'{% else %}'balanced'{% endif %},
      printedDate: {{ now()|format_date|tojson }}
    };

    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write('<html><head><title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ - ' + printData.customerName + '</title>');
    printWindow.document.write('<meta charset="UTF-8">');
    printWindow.document.write('<style>');
    printWindow.document.write('.no-print, .table-export-btn{display:none !important;}');
    printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
    printWindow.document.write('body { font-family: Arial, sans-serif; direction: rtl; padding: 10px; font-size: 8pt; line-height: 1.2; }');
    printWindow.document.write('h2 { text-align: center; color: #333; margin-bottom: 6px; border-bottom: 2px solid #000; padding-bottom: 4px; font-size: 11pt; }');
    printWindow.document.write('.customer-info { border: 1px solid #000; padding: 6px; margin: 8px 0; background-color: #f8f9fa; font-size: 7pt; }');
    printWindow.document.write('.customer-info table { width: 100%; border-collapse: collapse; }');
    printWindow.document.write('.customer-info td { padding: 2px 4px; border: none; }');
    printWindow.document.write('.customer-info strong { font-weight: bold; }');
    printWindow.document.write('.balance-box { background-color: #ffe0e0; border: 1px solid #000; padding: 3px; margin-top: 3px; font-size: 7pt; }');
    printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 7pt; }');
    printWindow.document.write('th, td { border: 1px solid #000; padding: 3px 4px; text-align: right; line-height: 1.1; }');
    printWindow.document.write('th { background-color: #e0e0e0; font-weight: bold; text-align: center; font-size: 7.5pt; }');
    printWindow.document.write('tfoot th, tfoot td { background-color: #f0f0f0; font-weight: bold; padding: 4px; }');
    printWindow.document.write('.text-end { text-align: left; }');
    printWindow.document.write('.sale-items-details { background-color: #fafafa; padding: 4px; margin: 2px 0; }');
    printWindow.document.write('.sale-items-details table { font-size: 6pt; margin: 0; }');
    printWindow.document.write('.sale-items-details th, .sale-items-details td { padding: 2px 3px; font-size: 6pt; }');
    printWindow.document.write('.footer { text-align: center; font-size: 6pt; color: #666; margin-top: 15px; border-top: 1px solid #ccc; padding-top: 5px; }');
    printWindow.document.write('@page { margin: 0.8cm; size: A4 portrait; }');
    printWindow.document.write('</style></head><body>');
    
    printWindow.document.write('<h2>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„</h2>');
    printWindow.document.write('<div class="customer-info">');
    printWindow.document.write('<table><tr>');
    printWindow.document.write('<td style="width: 55%;">');
    printWindow.document.write('<div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ' + printData.customerName + '</div>');
    if (printData.customerPhone) {
      printWindow.document.write('<div><strong>Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ' + printData.customerPhone + '</div>');
    }
    if (printData.customerAddress) {
      printWindow.document.write('<div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ' + printData.customerAddress + '</div>');
    }
    printWindow.document.write('</td>');
    printWindow.document.write('<td style="width: 45%; border-right: 1px solid #000;">');
    if (printData.periodStart && printData.periodEnd) {
      printWindow.document.write('<div><strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† ' + printData.periodStart + ' Ø¥Ù„Ù‰ ' + printData.periodEnd + '</div>');
    }
    let balanceSuffix = '';
    if (printData.balanceState === 'owed') {
      balanceSuffix = ' <strong style="color: #dc3545;">(Ø¹Ù„ÙŠÙ‡ Ù„Ù†Ø§)</strong>';
    } else if (printData.balanceState === 'due') {
      balanceSuffix = ' <strong style="color: #28a745;">(Ù„Ù‡ Ø¹Ù„ÙŠÙ†Ø§)</strong>';
    } else {
      balanceSuffix = ' (Ù…ØªÙˆØ§Ø²Ù†)';
    }
    printWindow.document.write('<div class="balance-box"><strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> ' + printData.balanceText + balanceSuffix + '</div>');
    printWindow.document.write('<div style="font-size: 9pt; margin-top: 5px;"><strong>Ø·ÙØ¨Ø¹:</strong> ' + printData.printedDate + '</div>');
    printWindow.document.write('</td>');
    printWindow.document.write('</tr></table>');
    printWindow.document.write('</div>');
    printWindow.document.write(table.outerHTML);
    printWindow.document.write('<div class="footer">');
    printWindow.document.write('Ø·ÙØ¨Ø¹ Ø¨ØªØ§Ø±ÙŠØ®: ' + new Date().toLocaleString('en-US'));
    printWindow.document.write('</div>');
    
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    
    setTimeout(function() {
      printWindow.print();
    }, 250);
  }
</script>
{% endif %}
{% endblock %}
