{% extends 'base.html' %}

{% block title %}كشف حساب العميل{% endblock %}

{% block head_extra %}
<style>
  /* إخفاء عناصر الطباعة في الشاشة */
  .print-header-info,
  .print-customer-info,
  .print-footer-info {
    display: none !important;
  }
  
  /* === تنسيق الطباعة === */
  @media print {
    /* إخفاء عناصر غير ضرورية */
    .no-print,
    .btn,
    .breadcrumb,
    nav,
    .main-sidebar,
    .main-header,
    .main-footer,
    .d-flex.gap-2,
    .card.shadow-sm,
    .row.g-3 {
      display: none !important;
    }
    
    /* إظهار عناصر الطباعة */
    .print-header-info,
    .print-customer-info,
    .print-footer-info {
      display: block !important;
    }
    
    /* الصفحة */
    @page {
      margin: 1cm;
      size: A4 portrait;
    }
    
    body, html {
      font-size: 7pt !important;
      line-height: 1 !important;
      margin: 0;
      padding: 0;
    }
    
    .content-wrapper {
      margin: 0 !important;
      padding: 0 !important;
      max-width: 100% !important;
    }
    
    /* ترويسة الطباعة */
    .print-header-info {
      display: block !important;
      margin-bottom: 8px;
      padding: 8px;
      border: 2px solid #000;
      background-color: #f8f9fa !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .print-header-info .company-name {
      font-size: 10pt !important;
      font-weight: bold;
      text-align: center;
      margin-bottom: 4px;
    }
    
    .print-header-info .statement-type h2 {
      font-size: 9pt !important;
      font-weight: bold;
      text-align: center;
      margin: 2px 0 4px 0;
      border-bottom: 1px solid #666;
      padding-bottom: 2px;
    }
    
    .print-header-info .statement-date,
    .print-header-info .user-info {
      font-size: 6pt !important;
      text-align: center;
    }
    
    /* معلومات العميل للطباعة */
    .print-customer-info {
      display: block !important;
      font-size: 6pt !important;
      border: 1px solid #000;
      padding: 5px;
      margin-bottom: 5px;
      background-color: #ffffff !important;
    }
    
    .print-customer-info table {
      width: 100%;
      font-size: 6pt !important;
    }
    
    .print-customer-info td {
      padding: 2px 4px;
      border: none;
      vertical-align: top;
    }
    
    .print-customer-info strong {
      font-weight: bold;
    }
    
    /* خلفية الرصيد */
    .print-customer-info .balance-box {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    /* الجدول الرئيسي - مضغوط */
    .table,
    #statementTable {
      font-size: 5pt !important;
      width: 100% !important;
      border-collapse: collapse !important;
      margin: 0 !important;
    }
    
    .table th,
    .table td,
    #statementTable th,
    #statementTable td {
      padding: 1px 2px !important;
      line-height: 1 !important;
      border: 0.5px solid #000 !important;
      font-size: 5pt !important;
    }
    
    .table thead th,
    #statementTable thead th {
      font-size: 6pt !important;
      padding: 2px !important;
      font-weight: bold !important;
      background-color: #e0e0e0 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      text-align: center !important;
    }
    
    .table tfoot th,
    .table tfoot td,
    #statementTable tfoot th,
    #statementTable tfoot td {
      font-size: 6pt !important;
      padding: 2px !important;
      font-weight: bold !important;
      background-color: #f0f0f0 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    /* جدول البنود المباعة - أصغر */
    .sale-items-details {
      padding: 0 !important;
      margin: 0 !important;
      background-color: #fafafa !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .sale-items-details table {
      font-size: 4pt !important;
      width: 100% !important;
    }
    
    .sale-items-details th,
    .sale-items-details td {
      padding: 1px !important;
      font-size: 4pt !important;
      line-height: 1 !important;
      border: 0.5px solid #999 !important;
    }
    
    /* إخفاء العناصر غير الضرورية */
    .card-body > .row.g-3,
    .card.shadow-sm {
      display: none !important;
    }
  }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-white px-3 py-2 rounded mb-4">
    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('customers_bp.list_customers') }}">العملاء</a></li>
    <li class="breadcrumb-item active">كشف حساب {{ customer.name }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- رأس الصفحة للطباعة فقط -->
<div class="print-header-info">
  <div class="statement-type">
    <h2>كشف حساب عميل</h2>
  </div>
</div>

<!-- معلومات العميل والرصيد - للطباعة فقط -->
<div class="print-customer-info">
  <table style="width: 100%; border-collapse: collapse;">
    <tr>
      <td style="width: 55%; padding: 4px; vertical-align: top;">
        <div style="margin-bottom: 3px;">
          <strong>العميل:</strong> {{ customer.name }}
        </div>
        <div>
          <strong>الجوال:</strong> {{ customer.phone or '—' }}
          {% if customer.email %} | <strong>البريد:</strong> {{ customer.email }}{% endif %}
        </div>
        {% if customer.address %}
        <div style="margin-top: 2px;">
          <strong>العنوان:</strong> {{ customer.address }}
        </div>
        {% endif %}
      </td>
      <td style="width: 45%; padding: 4px; border-right: 1px solid #000; vertical-align: top;">
        <div style="margin-bottom: 3px;">
          <strong>الفترة:</strong> من {{ start_date|format_date }} إلى {{ end_date|format_date }}
        </div>
        <div class="balance-box" style="margin-bottom: 3px; font-size: 7pt; padding: 3px; background-color: {% if balance > 0 %}#ffe0e0{% elif balance < 0 %}#e0ffe0{% else %}#f0f0f0{% endif %}; border: 1px solid #000; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
          <strong>الرصيد الحالي:</strong> {{ balance|format_currency }}
          {% if balance > 0 %}
            <strong style="color: #dc3545;">(عليه لنا)</strong>
          {% elif balance < 0 %}
            <strong style="color: #28a745;">(له علينا)</strong>
          {% else %}
            (متوازن)
          {% endif %}
        </div>
        <div style="font-size: 5pt;">
          <strong>طُبع:</strong> {{ now()|format_date }} - {{ current_user.username if current_user.is_authenticated else 'النظام' }}
        </div>
      </td>
    </tr>
  </table>
</div>

<!-- تذييل الصفحة للطباعة فقط -->
<div class="print-footer-info">
  <div class="footer-line print-time">
    صفحة <span class="page-number"></span>
  </div>
</div>

  <!-- أزرار الإجراءات -->
  <div class="d-flex flex-wrap gap-2 mb-3 no-print">
    <a class="btn btn-outline-secondary" href="{{ url_for('customers_bp.customer_detail', customer_id=customer.id) }}">
      <i class="fas fa-arrow-right ms-1"></i> رجوع
    </a>
    <button type="button" class="btn btn-outline-primary" onclick="window.print()">
      <i class="fas fa-print ms-1"></i> طباعة
    </button>
  </div>

  <!-- 👤 بطاقة معلومات العميل -->
  <div class="card shadow-sm border mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h3 class="mb-2"><i class="fas fa-user-circle"></i> {{ customer.name }}</h3>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><i class="fas fa-phone"></i> <strong>الجوال:</strong> {{ customer.phone or '—' }}</p>
              <p class="mb-1"><i class="fas fa-envelope"></i> <strong>البريد:</strong> {{ customer.email or '—' }}</p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><i class="fas fa-map-marker-alt"></i> <strong>العنوان:</strong> {{ customer.address or '—' }}</p>
              <p class="mb-1"><i class="fas fa-tag"></i> <strong>التصنيف:</strong> {{ customer.category or 'عادي' }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-center">
          <div class="p-3 rounded border" style="background: #f8f9fa;">
            <h6 class="mb-1 text-muted">الرصيد الحالي</h6>
            <h2 class="mb-0 fw-bold">
              {% if balance > 0 %}
                <span class="text-warning">{{ balance|format_currency }}</span>
                <br><small style="font-size: 0.6em;">عليه لنا</small>
              {% elif balance < 0 %}
                <span class="text-info">{{ balance|abs|format_currency }}</span>
                <br><small style="font-size: 0.6em;">له علينا</small>
              {% else %}
                <span class="text-white">{{ balance|format_currency }}</span>
                <br><small style="font-size: 0.6em;">متوازن</small>
              {% endif %}
            </h2>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ملخص الحساب -->
  <div class="row g-3 mb-4">
    {% set stats = [
      ('إجمالي مدين', total_debit, 'text-danger', 'fa-arrow-down'),
      ('إجمالي دائن', total_credit, 'text-success', 'fa-arrow-up'),
      ('الرصيد', balance, balance < 0 and 'text-danger' or 'text-success', 'fa-balance-scale')
    ] %}
    {% for label, value, color_class, icon in stats %}
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">{{ label }}</div>
              <div class="fs-5 fw-bold {{ color_class }}">{{ value|format_currency }}</div>
            </div>
            <i class="fas {{ icon }} fs-4 {{ color_class or 'text-secondary' }}"></i>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ملخص الفئات -->
  <div class="row g-3 mb-4">
    {% set categories = [
      ('فواتير', total_invoices),
      ('مبيعات', total_sales),
      ('الصيانة', total_services),
      ('حجوزات مسبقة', total_preorders),
      ('حجوزات أونلاين', total_online_preorders),
    ] %}
    {% for label, value in categories %}
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">{{ label }}</div>
          <div class="fs-6 fw-bold">{{ (value or 0)|format_currency }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- جدول الحركات -->
  {% set type_labels = {
    'INVOICE': 'فاتورة',
    'SALE': 'بيع',
    'SERVICE': 'صيانة',
    'PREORDER': 'حجز مسبق',
    'ONLINE_PREORDER': 'حجز أونلاين',
    'PAYMENT': 'دفعة',
    'OPENING_BALANCE': 'رصيد افتتاحي'
  } %}
  {% set type_badges = {
    'INVOICE': 'bg-secondary',
    'SALE': 'bg-info',
    'SERVICE': 'bg-warning text-dark',
    'PREORDER': 'bg-dark',
    'ONLINE_PREORDER': 'bg-primary',
    'PAYMENT': 'bg-success',
    'OPENING_BALANCE': 'bg-purple text-white'
  } %}

  <div class="card shadow-sm rounded">
    <div class="card-header bg-primary text-white">
      <h5 class="card-title m-0">
        <i class="fas fa-file-invoice ms-2"></i> كشف حساب: {{ customer.name }}
      </h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h5 class="mb-0">سجل الحركات</h5>
        <button class="btn btn-sm btn-primary" onclick="printStatementTable()">
          <i class="fas fa-print"></i> طباعة الكشف
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle" id="statementTable" style="border: 2px solid #dee2e6; border-collapse: collapse;">
          <thead class="table-light" style="background-color: #f8f9fa;">
            <tr>
              <th style="width: 100px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">التاريخ</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">البيان</th>
              <th style="width: 180px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">ملاحظات</th>
              <th style="width: 110px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">مدين</th>
              <th style="width: 110px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">دائن</th>
              <th style="width: 110px; border: 1px solid #dee2e6; padding: 12px; font-weight: bold; text-align: center;">الرصيد</th>
            </tr>
          </thead>
          <tbody>
            {% for e in ledger_entries %}
            <tr>
              {# التاريخ #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">{{ e.date|format_date }}</td>
              
              {# البيان الديناميكي #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: start;">
                {# للدفعات - دفعة (طريقة) سند قبض - ليج (المستلم) #}
                {% if (e.type == 'PAYMENT' or e.type == 'CHECK_BOUNCED') and e.get('payment_details') %}
                  {% set pd = e.payment_details %}
                  
                  {# إذا كان شيك مرتد #}
                  {% if e.type == 'CHECK_BOUNCED' %}
                    <span class="badge bg-danger"><i class="fas fa-ban"></i> شيك مرفوض</span>
                  {% else %}
                    دفعة
                  {% endif %}
                  
                  {# طريقة الدفع - بالعربي بدون ألوان #}
                  {% set method = pd.method_raw|lower if pd.method_raw else '' %}
                  {% if method == 'cash' %}
                    (نقداً)
                  {% elif method == 'card' %}
                    (بطاقة)
                  {% elif method == 'cheque' %}
                    (شيك
                    {% if pd.check_number %} #{{ pd.check_number }}{% endif %}
                    {% if pd.check_due_date %} - استحقاق: {{ pd.check_due_date|format_date }}{% endif %}
                    {% if pd.check_bank %} - {{ pd.check_bank }}{% endif %})
                  {% elif method == 'bank' %}
                    (تحويل بنكي)
                  {% elif method == 'online' %}
                    (إلكتروني)
                  {% elif pd.method %}
                    ({{ pd.method }})
                  {% else %}
                    (نقداً)
                  {% endif %}
                  
                  {% if e.type != 'CHECK_BOUNCED' %}
                    سند قبض
                  {% endif %}
                  
                  {# المستلم - إذا موجود #}
                  {% if pd.receiver_name %}
                    - لـيـد ({{ pd.receiver_name }})
                  {% endif %}
                  
                  {# إذا مرتد، إضافة تنبيه #}
                  {% if e.type == 'CHECK_BOUNCED' %}
                    <br><span class="text-danger"><strong>⚠️ تم إلغاء الدفعة وإرجاع المبلغ للرصيد</strong></span>
                  {% endif %}
                
                {# للمبيعات #}
                {% elif e.type == 'SALE' %}
                  بيع - عملية بيع
                  {% if e.get('items') and e.get('items')|length > 0 %}
                    {{ e.get('items')|length }} صنف
                  {% endif %}
                
                {# للفواتير #}
                {% elif e.type == 'INVOICE' %}
                  فاتورة بيع
                  {% if e.ref %}
                    - {{ e.ref }}
                  {% endif %}
                
                {# للخدمات #}
                {% elif e.type == 'SERVICE' %}
                  صيانة - خدمة صيانة
                
                {# للحجوزات #}
                {% elif e.type == 'PREORDER' %}
                  حجز مسبق
                  {% if e.ref %}
                    - {{ e.ref }}
                  {% endif %}
                
                {# الرصيد الافتتاحي #}
                {% elif e.type == 'OPENING_BALANCE' %}
                  الرصيد الافتتاحي
                
                {# أي نوع آخر #}
                {% else %}
                  {{ e.statement }}
                {% endif %}
              </td>
              
              {# الملاحظات #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: start;">
                {% if e.notes %}
                  {{ e.notes[:80] }}{% if e.notes|length > 80 %}...{% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
              
              {# المدين #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: end; font-weight: 500;">{{ e.debit|format_currency }}</td>
              
              {# الدائن #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: end; font-weight: 500;">{{ e.credit|format_currency }}</td>
              
              {# الرصيد #}
              <td style="border: 1px solid #dee2e6; padding: 8px; text-align: end; font-weight: bold; {% if e.balance > 0 %}color: #dc3545;{% elif e.balance < 0 %}color: #28a745;{% endif %}">
                {{ e.balance|format_currency }}
              </td>
            </tr>
            
            {# عرض البنود المباعة تحت كل عملية بيع #}
            {% if e.type == 'SALE' and e.get('items') %}
            <tr class="sale-items-row">
              <td colspan="6" class="p-0">
                <div class="sale-items-details" style="background-color: #f8f9fa; padding: 10px; margin: 5px;">
                  <table class="table table-sm table-bordered mb-0" style="font-size: 0.85em; border: 1px solid #dee2e6;">
                    <thead style="background-color: #e9ecef;">
                      <tr>
                        <th style="width: 35%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">البند</th>
                        <th style="width: 10%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">الكمية</th>
                        <th style="width: 12%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">السعر</th>
                        <th style="width: 13%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">الإجمالي</th>
                        <th style="width: 15%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">المستلم</th>
                        <th style="width: 15%; border: 1px solid #dee2e6; padding: 8px; text-align: center;">ملاحظات</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in e.get('items', []) %}
                      <tr>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: start;">{{ item.name }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">{{ item.quantity }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: end;">{{ item.unit_price|format_currency }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: end; font-weight: 500;">{{ item.total|format_currency }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: start;">{{ item.receiver or '—' }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 6px; text-align: start;">{{ item.note or '—' }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
            {% endif %}
            
            {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted">لا توجد حركات.</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot style="background-color: #f8f9fa;">
            <tr>
              <th colspan="3" style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: bold;">الإجمالي</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; text-align: end; font-weight: bold;">{{ total_debit|format_currency }}</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; text-align: end; font-weight: bold;">{{ total_credit|format_currency }}</th>
              <th style="border: 1px solid #dee2e6; padding: 12px; text-align: end; font-weight: bold; {% if balance > 0 %}color: #dc3545;{% elif balance < 0 %}color: #28a745;{% endif %}">
                {{ balance|format_currency }}
              </th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // DataTables إذا كان الجدول كبير
  {% if ledger_entries|length > 10 %}
  $('#statementTable').DataTable({
    language: {
      url: '{{ url_for("static", filename="datatables/Arabic.json") }}'
    },
    pageLength: 25,
    order: [[0, 'desc']],
    dom: 'frtip',
    searching: true,
    paging: true,
    info: true
  });
  {% endif %}
  
  // دالة طباعة كشف الحساب
  window.printStatementTable = function() {
    const table = document.getElementById('statementTable');
    if (!table) return;
    
    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write('<html><head><title>كشف حساب - {{ customer.name }}</title>');
    printWindow.document.write('<meta charset="UTF-8">');
    printWindow.document.write('<style>');
    printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
    printWindow.document.write('body { font-family: Arial, sans-serif; direction: rtl; padding: 10px; font-size: 8pt; line-height: 1.2; }');
    printWindow.document.write('h2 { text-align: center; color: #333; margin-bottom: 6px; border-bottom: 2px solid #000; padding-bottom: 4px; font-size: 11pt; }');
    printWindow.document.write('.customer-info { border: 1px solid #000; padding: 6px; margin: 8px 0; background-color: #f8f9fa; font-size: 7pt; }');
    printWindow.document.write('.customer-info table { width: 100%; border-collapse: collapse; }');
    printWindow.document.write('.customer-info td { padding: 2px 4px; border: none; }');
    printWindow.document.write('.customer-info strong { font-weight: bold; }');
    printWindow.document.write('.balance-box { background-color: #ffe0e0; border: 1px solid #000; padding: 3px; margin-top: 3px; font-size: 7pt; }');
    printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 7pt; }');
    printWindow.document.write('th, td { border: 1px solid #000; padding: 3px 4px; text-align: right; line-height: 1.1; }');
    printWindow.document.write('th { background-color: #e0e0e0; font-weight: bold; text-align: center; font-size: 7.5pt; }');
    printWindow.document.write('tfoot th, tfoot td { background-color: #f0f0f0; font-weight: bold; padding: 4px; }');
    printWindow.document.write('.text-end { text-align: left; }');
    printWindow.document.write('.sale-items-details { background-color: #fafafa; padding: 4px; margin: 2px 0; }');
    printWindow.document.write('.sale-items-details table { font-size: 6pt; margin: 0; }');
    printWindow.document.write('.sale-items-details th, .sale-items-details td { padding: 2px 3px; font-size: 6pt; }');
    printWindow.document.write('.footer { text-align: center; font-size: 6pt; color: #666; margin-top: 15px; border-top: 1px solid #ccc; padding-top: 5px; }');
    printWindow.document.write('@page { margin: 0.8cm; size: A4 portrait; }');
    printWindow.document.write('</style></head><body>');
    
    // الترويسة
    printWindow.document.write('<h2>كشف حساب عميل</h2>');
    
    // معلومات العميل
    printWindow.document.write('<div class="customer-info">');
    printWindow.document.write('<table><tr>');
    printWindow.document.write('<td style="width: 55%;">');
    printWindow.document.write('<div><strong>العميل:</strong> {{ customer.name }}</div>');
    {% if customer.phone %}
    printWindow.document.write('<div><strong>الجوال:</strong> {{ customer.phone }}</div>');
    {% endif %}
    {% if customer.email %}
    printWindow.document.write('<div><strong>البريد:</strong> {{ customer.email }}</div>');
    {% endif %}
    printWindow.document.write('</td>');
    printWindow.document.write('<td style="width: 45%; border-right: 1px solid #000;">');
    {% if start_date and end_date %}
    printWindow.document.write('<div><strong>الفترة:</strong> من {{ start_date|format_date }} إلى {{ end_date|format_date }}</div>');
    {% endif %}
    printWindow.document.write('<div class="balance-box"><strong>الرصيد الحالي:</strong> {{ balance|format_currency }}');
    {% if balance > 0 %}
    printWindow.document.write(' <strong style="color: #dc3545;">(عليه لنا)</strong>');
    {% elif balance < 0 %}
    printWindow.document.write(' <strong style="color: #28a745;">(له علينا)</strong>');
    {% else %}
    printWindow.document.write(' (متوازن)');
    {% endif %}
    printWindow.document.write('</div>');
    printWindow.document.write('<div style="font-size: 9pt; margin-top: 5px;"><strong>طُبع:</strong> {{ now()|format_date }}</div>');
    printWindow.document.write('</td>');
    printWindow.document.write('</tr></table>');
    printWindow.document.write('</div>');
    
    // الجدول
    printWindow.document.write(table.outerHTML);
    
    // التذييل
    printWindow.document.write('<div class="footer">');
    printWindow.document.write('طُبع بتاريخ: ' + new Date().toLocaleString('en-US'));
    printWindow.document.write('</div>');
    
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    
    // انتظر تحميل المحتوى ثم اطبع
    setTimeout(function() {
      printWindow.print();
    }, 250);
  }
</script>
{% endblock %}
