{% extends 'base_print.html' if print_mode else 'base.html' %}

{% block title %}قائمة العملاء{% endblock %}

{% block extra_css %}
{% if print_mode %}
<style>
@page {
    size: A4 portrait;
    margin: 4mm 4mm 6mm 4mm;
}
html, body {
    background: #fff;
    direction: rtl;
    font-family: "Segoe UI", "Tahoma", sans-serif;
    font-size: 11px;
    margin: 0;
    padding: 0;
    width: 100%;
    max-width: none;
}
body.print-mode .main-header,
body.print-mode .main-sidebar,
body.print-mode .main-footer,
body.print-mode .navbar,
body.print-mode .sidebar,
body.print-mode .control-sidebar,
body.print-mode .content-header,
body.print-mode .no-print,
body.print-mode .btn,
body.print-mode button {
    display: none !important;
}
body.print-mode .content-wrapper,
body.print-mode .content {
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
}
body.print-mode .wrapper,
body.print-mode .main-header,
body.print-mode .main-sidebar,
body.print-mode .main-footer,
body.print-mode .navbar,
body.print-mode .sidebar,
body.print-mode .control-sidebar,
body.print-mode .content-header,
body.print-mode .no-print,
body.print-mode .btn,
body.print-mode button {
    display: none !important;
}
body.print-mode .content-wrapper,
body.print-mode .content {
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
}
.print-sheet {
    width: 100%;
    margin: 0;
    padding: 4mm 2mm 4mm 2mm;
    box-sizing: border-box;
}
.print-sheet .content-wrapper,
.print-sheet .content,
.print-sheet .container,
.print-sheet .container-fluid,
.print-sheet .row,
.print-sheet .col,
.print-sheet .card,
.print-sheet .card-body,
.print-sheet .table-responsive {
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
    max-width: none !important;
    box-shadow: none !important;
    border: 0 !important;
}
.print-header {
    text-align: center;
    margin: 0 0 8mm 0;
}
.print-header h1 {
    margin: 0;
    font-size: 18pt;
    font-weight: 700;
}
.print-subtitle {
    margin: 4px 0 0 0;
    font-size: 11px;
}
.print-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 6mm;
    font-size: 11px;
}
.print-meta-item {
    border: 1px solid #b5b5b5;
    padding: 4px 8px;
    min-width: 55mm;
}
.print-meta-label {
    display: block;
    font-weight: 600;
    margin-bottom: 2px;
}
.print-meta-value {
    font-size: 11px;
}
.print-controls {
    text-align: left;
    margin-bottom: 6mm;
}
@media print {
    .print-controls {
        display: none;
    }
}
.print-table-container {
    width: 100%;
    overflow: visible;
    direction: rtl;
}
.print-table {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
    table-layout: fixed;
}
.print-table thead {
    background: #f3f3f3;
}
.print-table th,
.print-table td {
    border: 1px solid #c4c4c4;
    padding: 4px 6px;
    text-align: center;
    font-size: 11px;
    line-height: 1.35;
    word-break: break-word;
}
.print-table .hide-mobile {
    display: table-cell !important;
}
.print-table th:nth-child(1),
.print-table td:nth-child(1) { width: 8%; }
.print-table th:nth-child(2),
.print-table td:nth-child(2) { width: 15%; }
.print-table th:nth-child(3),
.print-table td:nth-child(3) {
    width: 34%;
    text-align: right;
}
.print-table th:nth-child(4),
.print-table td:nth-child(4) { width: 18%; }
.print-table th:nth-child(5),
.print-table td:nth-child(5) { width: 12%; }
.print-table th:nth-child(6),
.print-table td:nth-child(6) { width: 13%; }
.print-table td:nth-child(3) {
    text-align: right;
}
.print-table td:nth-child(6) {
    text-align: right;
    font-weight: 600;
}
.print-table a {
    color: inherit;
    text-decoration: none;
}
.print-table tfoot td {
    font-weight: 600;
    text-align: right;
}
.print-summary {
    margin-top: 12px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    font-size: 11px;
}
.print-summary-item {
    min-width: 45mm;
}
.print-summary-item .label {
    font-weight: 600;
    display: inline-block;
    margin-left: 4px;
}
.print-summary-item .value {
    direction: ltr;
    unicode-bidi: embed;
}
.print-summary span {
    font-weight: 600;
}
@media screen {
    body { background: #f5f6fa; padding: 20px; }
    .print-sheet {
        box-shadow: 0 0 12px rgba(0,0,0,0.12);
        background: #fff;
    }
}
</style>
{% else %}
<style>
.customer-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 15px;
    overflow: hidden;
}
.customer-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
.customer-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
}
.balance-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
}
.balance-positive {
    background: linear-gradient(45deg, #56ab2f, #a8e6cf);
    color: white;
}
.balance-negative {
    background: linear-gradient(45deg, #ff416c, #ff4b2b);
    color: white;
}
.balance-zero {
    background: linear-gradient(45deg, #bdc3c7, #2c3e50);
    color: white;
}
.print-wrapper {
    max-width: 100%;
    margin: 0 auto;
}
.no-print-inline {
    display: inline-flex;
}
</style>
{% endif %}
{% endblock %}

{% block content %}
  {% if print_mode %}
  <div class="print-sheet">
    <div class="print-header">
      <h1>قائمة العملاء</h1>
      <p class="print-subtitle">تاريخ الطباعة: {{ generated_at.strftime("%Y-%m-%d %H:%M") }}</p>
    </div>
    <div class="print-meta">
      <div class="print-meta-item">
        <span class="print-meta-label">عدد العملاء</span>
        <span class="print-meta-value">{{ summary.total_customers }}</span>
      </div>
      <div class="print-meta-item">
        <span class="print-meta-label">إجمالي الرصيد</span>
        <span class="print-meta-value">{{ "%.2f"|format(summary.total_balance) }} ₪</span>
      </div>
      <div class="print-meta-item">
        <span class="print-meta-label">إجمالي المدفوعات</span>
        <span class="print-meta-value">{{ "%.2f"|format(summary.total_payments) }} ₪</span>
      </div>
    </div>
    {% if not pdf_export %}
    <div class="print-controls">
      <button type="button" class="print-trigger" onclick="window.print()">طباعة</button>
    </div>
    {% endif %}
    <div class="print-table-wrapper">
      <table class="print-table">
        <thead>
          <tr>
            <th>#</th>
            <th>تاريخ الإنشاء</th>
            <th>الاسم</th>
            <th>الجوال</th>
            <th>التصنيف</th>
            <th>الرصيد</th>
          </tr>
        </thead>
        <tbody>
          {% for customer in customers %}
          <tr>
            <td>{{ loop.index0 + row_offset + 1 }}</td>
            <td>{{ customer.created_at|format_date }}</td>
            <td>{{ customer.name }}</td>
            <td>{{ customer.phone or '-' }}</td>
            <td>{{ customer.category or '-' }}</td>
            <td>{{ customer.balance|format_currency }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5">إجمالي الرصيد</td>
            <td>{{ "%.2f"|format(summary.total_balance) }} ₪</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="print-summary">
      <div class="print-summary-item"><span class="label">عملاء بذمة:</span> <span class="value">{{ summary.customers_with_debt }}</span></div>
      <div class="print-summary-item"><span class="label">عملاء لهم رصيد:</span> <span class="value">{{ summary.customers_with_credit }}</span></div>
      <div class="print-summary-item"><span class="label">متوسط الرصيد:</span> <span class="value">{{ "%.2f"|format(summary.average_balance) }} ₪</span></div>
    </div>
  </div>
  {% else %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="close" data-dismiss="alert" aria-label="إغلاق">
            <span aria-hidden="true">×</span>
          </button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 m-0 text-dark"><i class="fas fa-users ml-2"></i> قائمة العملاء</h2>
    <div class="btn-group-actions-end no-print">
      <div class="no-print-inline">
        <a href="{{ url_for('customers_bp.create_form') }}" class="btn btn-action-add mr-2">
          <i class="fas fa-user-plus"></i> إضافة عميل
        </a>
        <button type="button" class="btn btn-outline-secondary mr-2" id="open-print-modal">
          <i class="fas fa-print"></i> طباعة
        </button>
        <div class="btn-group mr-2" role="group">
          <button type="button" class="btn btn-action-export dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-download"></i> تصدير
          </button>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="{{ url_for('customers_bp.export_customers', format='excel') }}"><i class="fas fa-file-excel"></i> Excel</a>
            <a class="dropdown-item" href="{{ url_for('customers_bp.export_contacts') }}"><i class="fas fa-address-book"></i> جهات الاتصال</a>
          </div>
        </div>
        <a href="{{ url_for('customers_bp.import_customers') }}" class="btn btn-outline-info mr-2"><i class="fas fa-file-csv"></i> استيراد</a>
        <a href="{{ url_for('customers_bp.advanced_filter') }}" class="btn btn-outline-warning"><i class="fas fa-filter"></i> بحث متقدم</a>
      </div>
    </div>
  </div>

  <div class="row mb-4 g-3">
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="dashboard-stats-card text-white h-100" style="background:linear-gradient(135deg,#667eea,#764ba2)">
        <div class="card-body د-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50 mb-1">إجمالي العملاء</h6>
            <h3 class="mb-0 fw-bold">{{ summary.total_customers }}</h3>
          </div>
          <i class="fas fa-users fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm {% if summary.total_balance > 0 %}bg-danger{% elif summary.total_balance < 0 %}bg-success{% else %}bg-secondary{% endif %} text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">الرصيد الصافي</h6>
              <h3 class="mb-0 fw-bold">{{ "%.2f"|format(summary.total_balance) }} ₪</h3>
            </div>
            <i class="fas fa-balance-scale fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm bg-info text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">عملاء لهم رصيد</h6>
              <h3 class="mb-0 fw-bold">{{ summary.customers_with_credit }}</h3>
            </div>
            <i class="fas fa-hand-holding-heart fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm bg-danger text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">عملاء بذمة</h6>
              <h3 class="mb-0 fw-bold">{{ summary.customers_with_debt }}</h3>
            </div>
            <i class="fas fa-exclamation-triangle fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm text-white h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">متوسط الرصيد</h6>
              <h3 class="mb-0 fw-bold">{{ "%.2f"|format(summary.average_balance) }} ₪</h3>
            </div>
            <i class="fas fa-chart-line fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form id="customer-adv-search" class="mb-4" method="get" action="{{ url_for('customers_bp.list_customers') }}">
    <div class="form-row">
      <div class="col-md-3 mb-2">
        <input type="text" name="name" class="form-control form-control-sm" placeholder="اسم العميل" value="{{ args.get('name','') }}">
      </div>
      <div class="col-md-3 mb-2">
        <input type="text" name="phone" class="form-control form-control-sm" placeholder="جوال" value="{{ args.get('phone','') }}">
      </div>
      <div class="col-md-3 mb-2">
        <select name="category" class="form-control form-control-sm">
          <option value="">كل التصنيفات</option>
          {% for cat in ['ذهبي','فضي','مميز','عادي'] %}
            <option value="{{ cat }}" {% if args.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 mb-2">
        <select name="is_active" class="form-control form-control-sm">
          <option value="">كل الحالات</option>
          <option value="1" {% if args.get('is_active') == '1' %}selected{% endif %}>نشط</option>
          <option value="0" {% if args.get('is_active') == '0' %}selected{% endif %}>غير نشط</option>
        </select>
      </div>
      <div class="col-md-1 mb-2 d-flex">
        <button class="btn btn-primary btn-sm flex-fill mr-1" type="submit"><i class="fas fa-search mr-1"></i> بحث</button>
        <button class="btn btn-light btn-sm flex-fill" type="button" id="reset-adv-filter">مسح</button>
      </div>
    </div>
  </form>

  <div class="card shadow-sm rounded">
    <div class="card-body p-0">
      <div class="p-3 border-bottom bg-light">
        <div class="row align-items-center">
          <div class="col-lg-6 col-md-7">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" id="customers-search" class="form-control" placeholder="بحث في العملاء" value="{{ args.get('q','') }}">
            </div>
          </div>
          <div class="col-lg-6 col-md-5 text-md-left text-sm-right mt-3 mt-md-0">
            <span class="text-muted d-inline-block" id="customers-search-summary">إجمالي النتائج: {{ total_filtered }}</span>
          </div>
        </div>
      </div>
      <div id="customers-table-wrapper">
        {% include 'customers/_table.html' %}
      </div>
      <div id="customers-pagination-wrapper" class="px-3 pb-3">
        {% if pagination %}
        <nav class="mt-3 no-print">
          <ul class="pagination justify-content-center mb-0">
            {% if pagination.has_prev %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('customers_bp.list_customers', page=pagination.prev_num, **args) }}">السابق</a>
              </li>
            {% endif %}
            {% for p in pagination.iter_pages() %}
              {% if p %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('customers_bp.list_customers', page=p, **args) }}">{{ p }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('customers_bp.list_customers', page=pagination.next_num, **args) }}">التالي</a>
              </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>

  {% set scope_value = print_scope if print_scope in ['all','range','page'] else 'all' %}
  <div class="modal fade" id="printCustomersModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">طباعة قائمة العملاء</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="إغلاق">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <form id="print-options-form" method="get" action="{{ url_for('customers_bp.list_customers') }}" target="_blank">
          <div class="modal-body">
            <input type="hidden" name="print" value="1">
            {% for key, value in args.items() %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
            <div class="form-group">
              <label class="d-block font-weight-bold mb-2">نطاق الطباعة</label>
              <div class="custom-control custom-radio mb-2">
                <input class="custom-control-input" type="radio" name="scope" id="print-scope-all" value="all" {% if scope_value == 'all' %}checked{% endif %}>
                <label class="custom-control-label" for="print-scope-all">كل القائمة ({{ total_filtered }} عميل)</label>
              </div>
              <div class="custom-control custom-radio mb-2">
                <input class="custom-control-input" type="radio" name="scope" id="print-scope-range" value="range" {% if scope_value == 'range' %}checked{% endif %}>
                <label class="custom-control-label" for="print-scope-range">تحديد أرقام الصفوف</label>
              </div>
              <div class="custom-control custom-radio">
                <input class="custom-control-input" type="radio" name="scope" id="print-scope-page" value="page" {% if scope_value == 'page' %}checked{% endif %}>
                <label class="custom-control-label" for="print-scope-page">حسب رقم الصفحة</label>
              </div>
            </div>
            <div class="form-row" id="print-range-fields">
              <div class="form-group col">
                <label>من رقم</label>
                <input type="number" class="form-control" name="range_start" min="1" max="{{ total_filtered if total_filtered else 1 }}" value="{{ range_start }}" {% if scope_value != 'range' %}disabled{% endif %}>
              </div>
              <div class="form-group col">
                <label>إلى رقم</label>
                <input type="number" class="form-control" name="range_end" min="1" max="{{ total_filtered if total_filtered else 1 }}" value="{{ range_end }}" {% if scope_value != 'range' %}disabled{% endif %}>
              </div>
            </div>
            <div class="form-group" id="print-page-fields">
              <label>رقم الصفحة (1 - {{ total_pages if total_pages else 1 }})</label>
              <input type="number" class="form-control" name="page_number" min="1" max="{{ total_pages if total_pages else 1 }}" value="{{ target_page }}" {% if scope_value != 'page' %}disabled{% endif %}>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">إلغاء</button>
            <button type="submit" class="btn btn-primary">عرض للطباعة</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <form id="deleteForm" method="post" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  </form>

  {% endif %}

{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if print_mode and not pdf_export %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      window.print();
    });
  </script>
  {% endif %}
  <script>
    // ===== حذف بسيط - confirm فقط =====
    $(document).ready(function() {
      $('.delete-btn').off('click').on('click', function(e) {
        e.preventDefault();
        var customerId = $(this).data('id');
        var url = '/customers/' + customerId + '/delete';
        
        if (confirm('هل أنت متأكد من حذف هذا العميل؟\n\nملاحظة: سيتم الحذف فقط إذا لم يكن له معاملات أو رصيد.')) {
          $('#deleteForm').attr('action', url).submit();
        }
      });
    });
  </script>
  <script src="{{ url_for('static', filename='js/customers.js') }}"></script>
{% endblock %}
