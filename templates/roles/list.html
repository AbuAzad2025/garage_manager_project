{% extends 'base.html' %}
{% block title %}إدارة الأدوار{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">إدارة الأدوار</h2>

  {% if current_user.has_permission('manage_roles') %}
    <a href="{{ url_for('roles.create_role') }}" class="btn btn-primary mb-3">إضافة دور جديد</a>
  {% endif %}

  <table id="roles-table" class="table table-striped table-bordered align-middle">
    <thead>
      <tr>
        <th>اسم الدور</th>
        <th>الوصف</th>
        <th>الصلاحيات</th>
        <th style="width:180px">الإجراءات</th>
      </tr>
    </thead>
    <tbody>
      {% for r in roles %}
      <tr>
        <td>{{ r.name }}</td>
        <td>{{ r.description or '-' }}</td>
        <td>
          {% set perms = r.permissions %}
          {% if perms|length %}
            {% for p in perms %}
              <span class="badge bg-secondary me-1">{{ p.name }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted">لا توجد</span>
          {% endif %}
        </td>
        <td class="text-nowrap">
          {% if current_user.has_permission('manage_roles') %}
            <a href="{{ url_for('roles.edit_role', role_id=r.id) }}" class="btn btn-sm btn-outline-primary">تعديل</a>
            {% if r.name|lower not in ['admin','developer','manager'] %}
            <form method="post" action="{{ url_for('roles.delete_role', role_id=r.id) }}" class="d-inline"
                  onsubmit="return confirm('هل أنت متأكد من حذف هذا الدور؟');">
              {{ csrf_token() }}
              <button type="submit" class="btn btn-sm btn-outline-danger">حذف</button>
            </form>
            {% endif %}
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  if (window.$ && $('#roles-table').DataTable) {
    $('#roles-table').DataTable({
      language: { url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Arabic.json' }
    });
  }
});
</script>
{% endblock %}
