<form id="noteForm" method="post"
      action="{{ url_for('notes_bp.create_note') if mode != 'edit' else url_for('notes_bp.update_note', note_id=note_id) }}"
      novalidate autocomplete="off">

  {{ form.hidden_tag() }}

  <div class="mb-3">
    <label class="form-label d-flex justify-content-between align-items-center">
      <span>{{ form.content.label.text }}</span>
      <small class="text-muted"><span id="charCount">0</span>/1000</small>
    </label>
    {{ form.content(class="form-control autosize", rows=3, placeholder="أضف ملاحظة…", dir="auto", maxlength="1000") }}
    {% for e in form.content.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
  </div>

  <div class="form-row">
    <div class="form-group col-md-4">
      {{ form.entity_type.label(class="form-label") }}
      {{ form.entity_type(class="custom-select") }}
      {% for e in form.entity_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="form-group col-md-4">
      {{ form.entity_id.label(class="form-label") }}
      {{ form.entity_id(class="form-control", placeholder="ID", inputmode="numeric") }}
      {% for e in form.entity_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="form-group col-md-4">
      {{ form.priority.label(class="form-label") }}
      {{ form.priority(class="custom-select") }}
      {% for e in form.priority.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
  </div>

  <div class="form-check my-3">
    {{ form.is_pinned(class="form-check-input", id="isPinned") }}
    <label class="form-check-label" for="isPinned">{{ form.is_pinned.label.text }}</label>
    {% for e in form.is_pinned.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
  </div>

  <div class="mt-3">
    {{ form.submit(class="btn btn-primary px-4") }}
    <button type="button" class="btn btn-outline-secondary ml-2" data-dismiss="modal">إلغاء</button>
  </div>
</form>

<script>
(function () {
  var ta = document.querySelector('#noteForm textarea[name="content"]');
  var cnt = document.getElementById('charCount');
  if (ta && cnt) {
    function update(){ cnt.textContent = ta.value.length; }
    ta.addEventListener('input', update);
    update();
    function resize(){ ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; }
    ta.addEventListener('input', resize);
    ta.addEventListener('change', resize);
    setTimeout(resize, 0);
  }
})();
</script>
