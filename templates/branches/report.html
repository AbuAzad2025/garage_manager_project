{% extends 'base.html' %}
{% block title %}تقرير الفرع - {{ branch.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4" dir="rtl">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      <i class="fas fa-chart-line me-2 text-primary"></i>
      تقرير الفرع: {{ branch.name }}
    </h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('branches_bp.list_branches') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-right me-1"></i> رجوع
      </a>
      <button class="btn btn-primary" onclick="window.print()">
        <i class="fas fa-print me-1"></i> طباعة
      </button>
    </div>
  </div>

  <!-- الإحصائيات العامة -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <i class="fas fa-users fa-2x text-info mb-2"></i>
          <h5>الموظفين</h5>
          <h3 class="text-primary">{{ stats.employees_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <i class="fas fa-map-marker-alt fa-2x text-secondary mb-2"></i>
          <h5>المواقع</h5>
          <h3 class="text-primary">{{ stats.sites_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <i class="fas fa-warehouse fa-2x text-warning mb-2"></i>
          <h5>المستودعات</h5>
          <h3 class="text-primary">{{ stats.warehouses_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <i class="fas fa-receipt fa-2x text-success mb-2"></i>
          <h5>النفقات</h5>
          <h3 class="text-primary">{{ stats.expenses_count }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- إجمالي النفقات -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-danger text-white">
      <i class="fas fa-money-bill-wave me-1"></i> إجمالي النفقات
    </div>
    <div class="card-body text-center">
      <h2 class="text-danger">{{ "%.2f"|format(stats.expenses_total) }} ₪</h2>
    </div>
  </div>

  <!-- أعلى 5 نفقات -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-white">
      <i class="fas fa-trophy me-1"></i> أعلى 5 نفقات
    </div>
    <div class="card-body p-0">
      {% if top_expenses %}
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>النوع</th>
            <th>المبلغ</th>
            <th>الوصف</th>
          </tr>
        </thead>
        <tbody>
          {% for exp in top_expenses %}
          <tr>
            <td>{{ exp.date.strftime('%Y-%m-%d') if exp.date else '—' }}</td>
            <td>{{ exp.type.name if exp.type else '—' }}</td>
            <td class="fw-bold">{{ "%.2f"|format(exp.amount) }} {{ exp.currency }}</td>
            <td>{{ exp.description or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-center text-muted py-3 mb-0">لا توجد نفقات</p>
      {% endif %}
    </div>
  </div>

  <!-- النفقات حسب النوع -->
  <div class="card shadow-sm">
    <div class="card-header bg-info text-white">
      <i class="fas fa-chart-pie me-1"></i> النفقات حسب النوع
    </div>
    <div class="card-body p-0">
      {% if expense_by_type %}
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>نوع المصروف</th>
            <th class="text-center">العدد</th>
            <th class="text-end">الإجمالي</th>
          </tr>
        </thead>
        <tbody>
          {% for row in expense_by_type %}
          <tr>
            <td>{{ row[0] }}</td>
            <td class="text-center"><span class="badge bg-primary">{{ row[1] }}</span></td>
            <td class="text-end fw-bold">{{ "%.2f"|format(row[2] or 0) }} ₪</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-center text-muted py-3 mb-0">لا توجد نفقات</p>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

