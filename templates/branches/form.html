{% extends 'base.html' %}
{% block title %}{{ branch and 'ØªØ¹Ø¯ÙŠÙ„ ÙØ±Ø¹' or 'Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹' }}{% endblock %}

{% block content %}
<div class="container mt-4" dir="rtl">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      <i class="fas fa-{{ branch and 'edit' or 'plus' }} me-2"></i>
      {{ branch and 'ØªØ¹Ø¯ÙŠÙ„ ÙØ±Ø¹' or 'Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯' }}
    </h3>
    <a href="{{ url_for('branches_bp.list_branches') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-right me-1"></i> Ø±Ø¬ÙˆØ¹
    </a>
  </div>

  <form method="post" class="needs-validation" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-info-circle me-1"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      </div>
      <div class="card-body">
        <div class="row g-3">
          
          <div class="col-md-4">
            <label class="form-label fw-bold">
              Ø§Ù„Ø§Ø³Ù… <span class="text-danger">*</span>
            </label>
            <input type="text" name="name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ÙØ±Ø¹ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡" value="{{ branch.name if branch else '' }}" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">
              Ø§Ù„Ø±Ù…Ø² <span class="text-danger">*</span>
            </label>
            <input type="text" name="code" class="form-control" placeholder="Ù…Ø«Ø§Ù„: RAMALLAH" value="{{ branch.code if branch else '' }}" required {% if branch and branch.code == 'MAIN' %}readonly{% endif %}>
            <small class="text-muted">Ø±Ù…Ø² ÙØ±ÙŠØ¯ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</small>
          </div>

          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
            <input type="text" name="city" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø±Ø§Ù… Ø§Ù„Ù„Ù‡" value="{{ branch.city if branch else '' }}">
          </div>

          <div class="col-md-12">
            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" name="address" class="form-control" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„" value="{{ branch.address if branch else '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="text" name="phone" class="form-control" placeholder="02-xxxxxxx" value="{{ branch.phone if branch else '' }}">
          </div>

          <!-- Ø­Ù‚ÙˆÙ„ GPS Ù…Ø®ÙÙŠØ© -->
          <input type="hidden" name="geo_lat" value="{{ branch.geo_lat if branch else '' }}">
          <input type="hidden" name="geo_lng" value="{{ branch.geo_lng if branch else '' }}">

          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" name="email" class="form-control" placeholder="branch@company.com" value="{{ branch.email if branch else '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹</label>
            <select name="manager_user_id" class="form-select">
              <option value="0">-- Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠØ± --</option>
              {% for u in users %}
              <option value="{{ u.id }}" {% if branch and branch.manager_user_id == u.id %}selected{% endif %}>
                {{ u.username }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
            <select name="currency" class="form-select">
              <option value="ILS" {% if not branch or branch.currency == 'ILS' %}selected{% endif %}>Ø´ÙŠÙƒÙ„ (ILS)</option>
              <option value="USD" {% if branch and branch.currency == 'USD' %}selected{% endif %}>Ø¯ÙˆÙ„Ø§Ø± (USD)</option>
              <option value="JOD" {% if branch and branch.currency == 'JOD' %}selected{% endif %}>Ø¯ÙŠÙ†Ø§Ø± (JOD)</option>
              <option value="EUR" {% if branch and branch.currency == 'EUR' %}selected{% endif %}>ÙŠÙˆØ±Ùˆ (EUR)</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
            <input type="text" name="tax_id" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ" value="{{ branch.tax_id if branch else '' }}">
          </div>

          <div class="col-md-12">
            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea name="notes" class="form-control" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¹Ù† Ø§Ù„ÙØ±Ø¹">{{ branch.notes if branch else '' }}</textarea>
          </div>

          <div class="col-md-12">
            <div class="form-check form-switch">
              <input type="checkbox" name="is_active" class="form-check-input" id="is_active" value="1" {% if not branch or branch.is_active %}checked{% endif %}>
              <label class="form-check-label fw-bold" for="is_active">
                <i class="fas fa-toggle-on me-1"></i> ÙØ±Ø¹ Ù†Ø´Ø·
              </label>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ GPS -->
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-success text-white">
        <i class="fas fa-map-marked-alt me-1"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        <small class="float-end">Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ±Ø¹ Ø¨Ø¯Ù‚Ø©</small>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-3">
          <i class="fas fa-info-circle me-2"></i>
          <strong>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong>
          <ul class="mb-0 mt-2">
            <li>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙƒØ§Ù† ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¨Ø­Ø«</li>
            <li>ğŸ“ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</li>
            <li>ğŸ¯ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ" Ø¥Ø°Ø§ ÙƒÙ†Øª ÙÙŠ Ø§Ù„ÙØ±Ø¹</li>
            <li>ğŸ“‹ Ø§Ù†Ø³Ø® Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†</li>
          </ul>
        </div>
        <div id="location-map" style="height: 450px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"></div>
        
        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <div class="mt-3 text-center">
          <span class="badge bg-primary p-2" style="font-size: 14px;" id="coords-display">
            <i class="fas fa-crosshairs me-1"></i>
            Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯
          </span>
        </div>
      </div>

      <div class="card-footer">
        <div class="d-flex gap-2 justify-content-start">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i> {{ branch and 'ØªØ­Ø¯ÙŠØ«' or 'Ø­ÙØ¸' }}
          </button>
          <a href="{{ url_for('branches_bp.list_branches') }}" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</a>
        </div>
      </div>
    </div>

  </form>

</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places&language=ar&region=PS"></script>
<script src="{{ url_for('static', filename='js/gps-location-picker.js') }}"></script>
<script>
// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
document.addEventListener('DOMContentLoaded', function() {
    const latInput = document.querySelector('input[name="geo_lat"]');
    const lngInput = document.querySelector('input[name="geo_lng"]');
    const coordsDisplay = document.getElementById('coords-display');
    
    function updateCoordsDisplay() {
        const lat = latInput.value;
        const lng = lngInput.value;
        
        if (lat && lng) {
            coordsDisplay.innerHTML = `
                <i class="fas fa-map-marker-alt me-1"></i>
                ${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}
                <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="text-white ms-2">
                    <i class="fas fa-external-link-alt"></i> Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Google Maps
                </a>
            `;
            coordsDisplay.className = 'badge bg-success p-2';
        } else {
            coordsDisplay.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯';
            coordsDisplay.className = 'badge bg-secondary p-2';
        }
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    updateCoordsDisplay();
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    const observer = new MutationObserver(updateCoordsDisplay);
    observer.observe(latInput, { attributes: true, attributeFilter: ['value'] });
    observer.observe(lngInput, { attributes: true, attributeFilter: ['value'] });
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
    setInterval(updateCoordsDisplay, 1000);
});
</script>
{% endblock %}

