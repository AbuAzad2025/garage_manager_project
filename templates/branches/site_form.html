{% extends 'base.html' %}
{% block title %}{{ site and 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆÙ‚Ø¹' or 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹' }}{% endblock %}

{% block content %}
<div class="container mt-4" dir="rtl">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      <i class="fas fa-{{ site and 'edit' or 'plus' }} me-2"></i>
      {{ site and 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆÙ‚Ø¹' or 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯' }} - ÙØ±Ø¹: {{ branch.name }}
    </h3>
    <a href="{{ url_for('branches_bp.list_sites', branch_id=branch.id) }}" class="btn btn-secondary">
      <i class="fas fa-arrow-right me-1"></i> Ø±Ø¬ÙˆØ¹
    </a>
  </div>

  <form method="post" class="needs-validation" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3">
          
          <div class="col-md-6">
            <label class="form-label fw-bold">
              Ø§Ù„Ø§Ø³Ù… <span class="text-danger">*</span>
            </label>
            <input type="text" name="name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ" value="{{ site.name if site else '' }}" required>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-bold">
              Ø§Ù„Ø±Ù…Ø² <span class="text-danger">*</span>
            </label>
            <input type="text" name="code" class="form-control" placeholder="Ù…Ø«Ø§Ù„: NORTH" value="{{ site.code if site else '' }}" required>
            <small class="text-muted">Ø±Ù…Ø² ÙØ±ÙŠØ¯ Ø¶Ù…Ù† Ø§Ù„ÙØ±Ø¹</small>
          </div>

          <div class="col-md-12">
            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" name="address" class="form-control" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ" value="{{ site.address if site else '' }}">
          </div>

          <!-- Ø­Ù‚ÙˆÙ„ GPS Ù…Ø®ÙÙŠØ© -->
          <input type="hidden" name="geo_lat" value="{{ site.geo_lat if site else '' }}">
          <input type="hidden" name="geo_lng" value="{{ site.geo_lng if site else '' }}">

          <div class="col-md-6">
            <label class="form-label">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…ÙˆØ¸Ù)</label>
            <select name="manager_employee_id" class="form-select">
              <option value="0">-- Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠØ± --</option>
              {% for emp in employees %}
              <option value="{{ emp.id }}" {% if site and site.manager_employee_id == emp.id %}selected{% endif %}>
                {{ emp.name }} - {{ emp.position or 'Ù…ÙˆØ¸Ù' }}
              </option>
              {% endfor %}
            </select>
            <small class="text-muted">Ø§Ø®ØªØ± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ù…ÙˆØ¸ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹</small>
          </div>

          <div class="col-md-12">
            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea name="notes" class="form-control" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹">{{ site.notes if site else '' }}</textarea>
          </div>

          <div class="col-md-12">
            <div class="form-check form-switch">
              <input type="checkbox" name="is_active" class="form-check-input" id="is_active" value="1" {% if not site or site.is_active %}checked{% endif %}>
              <label class="form-check-label fw-bold" for="is_active">
                <i class="fas fa-toggle-on me-1"></i> Ù…ÙˆÙ‚Ø¹ Ù†Ø´Ø·
              </label>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ GPS -->
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-success text-white">
        <i class="fas fa-map-marked-alt me-1"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        <small class="float-end">Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø©</small>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-3">
          <i class="fas fa-info-circle me-2"></i>
          <strong>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong>
          <ul class="mb-0 mt-2">
            <li>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙƒØ§Ù† ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¨Ø­Ø«</li>
            <li>ğŸ“ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</li>
            <li>ğŸ¯ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ" Ø¥Ø°Ø§ ÙƒÙ†Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹</li>
            <li>ğŸ“‹ Ø§Ù†Ø³Ø® Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†</li>
          </ul>
        </div>
        <div id="location-map" style="height: 450px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"></div>
        
        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <div class="mt-3 text-center">
          <span class="badge bg-primary p-2" style="font-size: 14px;" id="coords-display">
            <i class="fas fa-crosshairs me-1"></i>
            Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯
          </span>
        </div>
      </div>

      <div class="card-footer">
        <div class="d-flex gap-2 justify-content-start">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i> {{ site and 'ØªØ­Ø¯ÙŠØ«' or 'Ø­ÙØ¸' }}
          </button>
          <a href="{{ url_for('branches_bp.list_sites', branch_id=branch.id) }}" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</a>
        </div>
      </div>
    </div>

  </form>

</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places&language=ar&region=PS"></script>
<script src="{{ url_for('static', filename='js/gps-location-picker.js') }}"></script>
<script>
// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
document.addEventListener('DOMContentLoaded', function() {
    const latInput = document.querySelector('input[name="geo_lat"]');
    const lngInput = document.querySelector('input[name="geo_lng"]');
    const coordsDisplay = document.getElementById('coords-display');
    
    function updateCoordsDisplay() {
        const lat = latInput.value;
        const lng = lngInput.value;
        
        if (lat && lng) {
            coordsDisplay.innerHTML = `
                <i class="fas fa-map-marker-alt me-1"></i>
                ${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}
                <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="text-white ms-2">
                    <i class="fas fa-external-link-alt"></i> Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Google Maps
                </a>
            `;
            coordsDisplay.className = 'badge bg-success p-2';
        } else {
            coordsDisplay.innerHTML = '<i class="fas fa-crosshairs me-1"></i> Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯';
            coordsDisplay.className = 'badge bg-secondary p-2';
        }
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    updateCoordsDisplay();
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
    setInterval(updateCoordsDisplay, 1000);
});
</script>
{% endblock %}

