{% extends 'base.html' %}
{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h3>ğŸ’° ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}</h3>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</strong> {{ payment.total_amount }} {{ payment.currency }}</p>
          <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ payment.payment_date.strftime('%Y-%m-%d %H:%M') }}</p>
          <p><strong>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</strong> {{ payment.method }}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
            <span class="badge 
              {% if payment.status == 'COMPLETED' %}bg-success
              {% elif payment.status == 'PENDING' %}bg-warning
              {% elif payment.status == 'FAILED' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ payment.status }}
            </span>
          </p>
        </div>
        <div class="col-md-6">
          <p><strong>Ø§Ù„Ø§ØªØ¬Ø§Ù‡:</strong>
            <span class="badge {% if payment.direction == 'IN' %}bg-success{% else %}bg-danger{% endif %}">
              {{ 'ÙˆØ§Ø±Ø¯' if payment.direction == 'IN' else 'ØµØ§Ø¯Ø±' }}
            </span>
          </p>
          <p><strong>Ø§Ù„Ø¬Ù‡Ø©:</strong>
            {% if payment.entity_type == 'customer' and payment.customer %}
              Ø¹Ù…ÙŠÙ„: {{ payment.customer.name }}
            {% elif payment.entity_type == 'supplier' and payment.supplier %}
              Ù…ÙˆØ±Ø¯: {{ payment.supplier.name }}
            {% elif payment.entity_type == 'partner' and payment.partner %}
              Ø´Ø±ÙŠÙƒ: {{ payment.partner.name }}
            {% elif payment.entity_type == 'shipment' and payment.shipment %}
              Ø´Ø­Ù†Ø©: #{{ payment.shipment.shipment_number }}
            {% elif payment.entity_type == 'expense' and payment.expense %}
              Ù…ØµØ±ÙˆÙ: {{ payment.expense.description }}
            {% elif payment.entity_type == 'loan' and payment.loan_settlement %}
              ØªØ³ÙˆÙŠØ© Ø¯ÙŠÙ†: #{{ payment.loan_settlement.id }}
            {% else %}
              {{ payment.entity_type }}
            {% endif %}
          </p>
          <p><strong>Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong> {{ payment.reference or '---' }}</p>
          <p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ payment.notes or '---' }}</p>
        </div>
      </div>

      <h4 class="mt-4">ğŸ’³ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©:</h4>
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="splitsTable">
          {% for s in payment.splits %}
            {% include "payments/_split_row.html" %}
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-4 d-flex justify-content-between">
        <div>
          <a href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}" class="btn btn-info">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„</a>
          <a href="{{ url_for('payments.edit_payment', payment_id=payment.id) }}" class="btn btn-warning">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©</a>
        </div>
        <form method="POST" action="{{ url_for('payments.delete_payment', payment_id=payment.id) }}">
          <button type="submit" class="btn btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.querySelectorAll('.remove-split').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©ØŸ')) return;
      const splitId = btn.dataset.splitId;
      fetch(`/payments/split/${splitId}/delete`, { method: 'DELETE' })
        .then(r => r.json()).then(j => {
          if (j.status==='success') btn.closest('tr').remove();
          else alert('ÙØ´Ù„: ' + j.message);
        });
    });
  });
</script>
{% endblock %}
