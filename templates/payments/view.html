{% extends 'base.html' %}
{% block title %}تفاصيل الدفعة #{{ payment.id }}{% endblock %}
{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}
{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">
      <i class="fas fa-money-check-alt me-2"></i>
      تفاصيل الدفعة #{{ payment.id }}
    </h2>
    <div class="btn-group">
      <a href="{{ url_for('payments.index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right me-1"></i> العودة للقائمة
      </a>
      <a href="{{ url_for('payments.view_receipt', payment_id=payment.id) }}" class="btn btn-primary">
        <i class="fas fa-receipt me-1"></i> عرض الإيصال
      </a>
      {% if payment.status == 'PENDING' %}
        <button id="completePayment" class="btn btn-success" data-payment-id="{{ payment.id }}">
          <i class="fas fa-check me-1"></i> تأكيد الدفعة
        </button>
        <button id="failPayment" class="btn btn-danger" data-payment-id="{{ payment.id }}">
          <i class="fas fa-times me-1"></i> رفض الدفعة
        </button>
      {% elif payment.status == 'COMPLETED' %}
        <button id="refundPayment" class="btn btn-warning" data-payment-id="{{ payment.id }}">
          <i class="fas fa-undo me-1"></i> إرجاع الدفعة
        </button>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>معلومات الدفعة</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">رقم الدفعة</label>
              <p class="form-control-plaintext">{{ payment.id }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">تاريخ الدفعة</label>
              <p class="form-control-plaintext">{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else 'غير محدد' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">المبلغ</label>
              <p class="form-control-plaintext fw-bold text-primary">{{ "%.2f"|format(payment.total_amount) }} {{ payment.currency }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">الاتجاه</label>
              <p class="form-control-plaintext">
                {% if payment.direction == 'IN' %}
                  <span class="badge bg-success">وارد</span>
                {% else %}
                  <span class="badge bg-danger">صادر</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">الطريقة</label>
              <p class="form-control-plaintext">{{ payment.method or 'غير محدد' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">الحالة</label>
              <p class="form-control-plaintext">
                {% if payment.status == 'COMPLETED' %}
                  <span class="badge bg-success">مكتملة</span>
                {% elif payment.status == 'PENDING' %}
                  <span class="badge bg-warning text-dark">قيد الانتظار</span>
                {% elif payment.status == 'FAILED' %}
                  <span class="badge bg-danger">فاشلة</span>
                {% elif payment.status == 'REFUNDED' %}
                  <span class="badge bg-secondary">مُرجعة</span>
                {% else %}
                  <span class="badge bg-secondary">{{ payment.status or 'غير محدد' }}</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">نوع الكيان</label>
              <p class="form-control-plaintext">{{ payment.entity_type or 'غير محدد' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">المرجع</label>
              <p class="form-control-plaintext">{{ payment.reference or 'غير محدد' }}</p>
            </div>
            {% if payment.notes %}
            <div class="col-12">
              <label class="form-label fw-bold">الملاحظات</label>
              <p class="form-control-plaintext">{{ payment.notes }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-link me-2"></i>الجهة المرتبطة</h5>
        </div>
        <div class="card-body">
          {% if payment.customer %}
            <div class="d-flex align-items-center">
              <i class="fas fa-user text-primary me-2"></i>
              <div>
                <strong>عميل:</strong> {{ payment.customer.name }}
                {% if payment.customer.phone %}
                  <br><small class="text-muted">{{ payment.customer.phone }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.supplier %}
            <div class="d-flex align-items-center">
              <i class="fas fa-truck text-warning me-2"></i>
              <div>
                <strong>مورد:</strong> {{ payment.supplier.name }}
                {% if payment.supplier.contact %}
                  <br><small class="text-muted">{{ payment.supplier.contact }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.partner %}
            <div class="d-flex align-items-center">
              <i class="fas fa-handshake text-success me-2"></i>
              <div>
                <strong>شريك:</strong> {{ payment.partner.name }}
                {% if payment.partner.contact %}
                  <br><small class="text-muted">{{ payment.partner.contact }}</small>
                {% endif %}
              </div>
            </div>
          {% else %}
            <p class="text-muted">لا توجد جهة مرتبطة</p>
          {% endif %}
        </div>
      </div>

      {% if payment.splits %}
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-list me-2"></i>تفاصيل الدفع</h5>
        </div>
        <div class="card-body">
          {% for split in payment.splits %}
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
              <div>
                <strong>{{ split.method or 'غير محدد' }}</strong>
                {% if split.reference %}
                  <br><small class="text-muted">{{ split.reference }}</small>
                {% endif %}
              </div>
              <span class="fw-bold">{{ "%.2f"|format(split.amount) }} {{ payment.currency }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // تأكيد الدفعة
  const completeBtn = document.getElementById('completePayment');
  if (completeBtn) {
    completeBtn.addEventListener('click', function() {
      if (confirm('هل أنت متأكد من تأكيد هذه الدفعة؟')) {
        updatePaymentStatus(this.dataset.paymentId, 'COMPLETED');
      }
    });
  }

  // رفض الدفعة
  const failBtn = document.getElementById('failPayment');
  if (failBtn) {
    failBtn.addEventListener('click', function() {
      if (confirm('هل أنت متأكد من رفض هذه الدفعة؟')) {
        updatePaymentStatus(this.dataset.paymentId, 'FAILED');
      }
    });
  }

  // إرجاع الدفعة
  const refundBtn = document.getElementById('refundPayment');
  if (refundBtn) {
    refundBtn.addEventListener('click', function() {
      if (confirm('هل أنت متأكد من إرجاع هذه الدفعة؟')) {
        updatePaymentStatus(this.dataset.paymentId, 'REFUNDED');
      }
    });
  }

  function updatePaymentStatus(paymentId, status) {
    fetch(`/payments/${paymentId}/status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ status: status })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert('تم تحديث حالة الدفعة بنجاح');
        location.reload();
      } else {
        alert('خطأ: ' + (data.message || 'فشل في تحديث الحالة'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('خطأ في الاتصال بالخادم: ' + error.message);
    });
  }
});
</script>
{% endblock %}