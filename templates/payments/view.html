{% extends 'base.html' %}
{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card">
    <div class="card-header bg-primary text-white">
      <h3>ğŸ’° ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}</h3>
    </div>
    <div class="card-body">
      <div class="row mb-4">
        <div class="col-md-6">
          <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</strong> {{ '%.2f'|format(payment.total_amount or 0) }} {{ payment.currency }}</p>
          <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d') or 'â€”' }}</p>
          <p><strong>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© (Ø±Ø¦ÙŠØ³ÙŠØ©):</strong> {{ (payment.method.value if payment.method and payment.method.value else payment.method) or 'â€”' }}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
            {% set st = payment.status.value if payment.status and payment.status.value else payment.status %}
            <span class="badge
              {% if st == 'COMPLETED' %}bg-success
              {% elif st == 'PENDING' %}bg-warning
              {% elif st == 'FAILED' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ st }}
            </span>
          </p>
        </div>
        <div class="col-md-6">
          <p><strong>Ø§Ù„Ø§ØªØ¬Ø§Ù‡:</strong>
            {% set d = payment.direction.value if payment.direction and payment.direction.value else payment.direction %}
            <span class="badge {% if d in ['IN','INCOMING'] %}bg-success{% else %}bg-danger{% endif %}">
              {{ 'ÙˆØ§Ø±Ø¯' if d in ['IN','INCOMING'] else 'ØµØ§Ø¯Ø±' }}
            </span>
          </p>
          <p><strong>Ø§Ù„Ø¬Ù‡Ø©:</strong> {{ payment.entity_label() or (payment.entity_type|capitalize) }}</p>
          <p><strong>Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong> {{ payment.reference or 'â€”' }}</p>
          <p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ payment.notes or 'â€”' }}</p>
        </div>
      </div>

      <h4 class="mt-4">ğŸ’³ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©:</h4>
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="splitsTable">
          {% for s in payment.splits %}
          {% set method = s.method.value if s.method and s.method.value else s.method %}
          {% set d = s.details or {} %}
          <tr id="split-{{ s.id }}">
            <td>{{ loop.index }}.</td>
            <td>{{ '%.2f'|format(s.amount or 0) }} {{ payment.currency }}</td>
            <td>{{ (method or 'â€”')|upper }}</td>
            <td>
              {% if method == 'cheque' %}
                Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ: {{ d.get('check_number','â€”') }}<br>
                Ø§Ù„Ø¨Ù†Ùƒ: {{ d.get('check_bank','â€”') }}<br>
                Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ d.get('check_due_date') or d.get('due_date') or 'â€”' }}
              {% elif method == 'bank' %}
                Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„: {{ d.get('bank_transfer_ref','â€”') }}
              {% elif method == 'card' %}
                Ø¨Ø·Ø§Ù‚Ø© Ø±Ù‚Ù…: ****{{ (d.get('card_last4','') or (d.get('card_number','')|string)[-4:]) }}<br>
                Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: {{ d.get('card_holder','â€”') }}<br>
                Ø§Ù†ØªÙ‡Ø§Ø¡: {{ d.get('card_expiry','â€”') }}
              {% elif method == 'online' %}
                Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ({{ d.get('gateway','â€”') }})
              {% else %}
                â€”
              {% endif %}
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-danger remove-split" data-split-id="{{ s.id }}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-4 d-flex justify-content-between">
        <div>
          <a href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}" class="btn btn-info">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„</a>
        </div>
        <form method="POST" action="{{ url_for('payments.delete_payment', payment_id=payment.id) }}">
          {{ csrf_token() }}
          <button type="submit" class="btn btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.remove-split').forEach(btn => {
  btn.addEventListener('click', () => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©ØŸ')) return;
    fetch(`/payments/split/${btn.dataset.splitId}/delete`, { method: 'DELETE' })
      .then(r => r.json())
      .then(j => {
        if (j.status === 'success') {
          document.getElementById(`split-${btn.dataset.splitId}`).remove();
          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©');
        } else {
          alert('ÙØ´Ù„: ' + (j.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      })
      .catch(() => alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'));
  });
});
</script>
{% endblock %}
