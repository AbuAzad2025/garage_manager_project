{% extends 'base.html' %}
{% block title %}تفاصيل الدفعة #{{ payment.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card">
    <div class="card-header bg-primary text-white">
      <h3>💰 تفاصيل الدفعة #{{ payment.id }}</h3>
    </div>
    <div class="card-body">
      <div class="row mb-4">
        <div class="col-md-6">
          <p><strong>المبلغ الكلي:</strong> {{ '%.2f'|format(payment.total_amount or 0) }} {{ payment.currency }}</p>
          <p><strong>التاريخ:</strong> {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d') or '—' }}</p>
          <p><strong>الطريقة (رئيسية):</strong> {{ (payment.method.value if payment.method and payment.method.value else payment.method) or '—' }}</p>
          <p><strong>الحالة:</strong>
            {% set st = payment.status.value if payment.status and payment.status.value else payment.status %}
            <span class="badge
              {% if st == 'COMPLETED' %}bg-success
              {% elif st == 'PENDING' %}bg-warning
              {% elif st == 'FAILED' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ st }}
            </span>
          </p>
        </div>
        <div class="col-md-6">
          <p><strong>الاتجاه:</strong>
            {% set d = payment.direction.value if payment.direction and payment.direction.value else payment.direction %}
            <span class="badge {% if d in ['IN','INCOMING'] %}bg-success{% else %}bg-danger{% endif %}">
              {{ 'وارد' if d in ['IN','INCOMING'] else 'صادر' }}
            </span>
          </p>
          <p><strong>الجهة:</strong> {{ payment.entity_label() or (payment.entity_type|capitalize) }}</p>
          <p><strong>المرجع:</strong> {{ payment.reference or '—' }}</p>
          <p><strong>الملاحظات:</strong> {{ payment.notes or '—' }}</p>
        </div>
      </div>

      <h4 class="mt-4">💳 الدفعات الجزئية:</h4>
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>المبلغ</th>
            <th>الطريقة</th>
            <th>التفاصيل</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="splitsTable">
          {% for s in payment.splits %}
          {% set method = s.method.value if s.method and s.method.value else s.method %}
          {% set d = s.details or {} %}
          <tr id="split-{{ s.id }}">
            <td>{{ loop.index }}.</td>
            <td>{{ '%.2f'|format(s.amount or 0) }} {{ payment.currency }}</td>
            <td>{{ (method or '—')|upper }}</td>
            <td>
              {% if method == 'cheque' %}
                رقم الشيك: {{ d.get('check_number','—') }}<br>
                البنك: {{ d.get('check_bank','—') }}<br>
                الاستحقاق: {{ d.get('check_due_date') or d.get('due_date') or '—' }}
              {% elif method == 'bank' %}
                مرجع التحويل: {{ d.get('bank_transfer_ref','—') }}
              {% elif method == 'card' %}
                بطاقة رقم: ****{{ (d.get('card_last4','') or (d.get('card_number','')|string)[-4:]) }}<br>
                حامل البطاقة: {{ d.get('card_holder','—') }}<br>
                انتهاء: {{ d.get('card_expiry','—') }}
              {% elif method == 'online' %}
                دفع إلكتروني ({{ d.get('gateway','—') }})
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-danger remove-split" data-split-id="{{ s.id }}">🗑️ حذف</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-4 d-flex justify-content-between">
        <div>
          <a href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}" class="btn btn-info">📄 تحميل الوصل</a>
        </div>
        <form method="POST" action="{{ url_for('payments.delete_payment', payment_id=payment.id) }}">
          {{ csrf_token() }}
          <button type="submit" class="btn btn-danger" onclick="return confirm('هل أنت متأكد؟')">🗑️ حذف</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.remove-split').forEach(btn => {
  btn.addEventListener('click', () => {
    if (!confirm('هل أنت متأكد من حذف هذه الدفعة الجزئية؟')) return;
    fetch(`/payments/split/${btn.dataset.splitId}/delete`, { method: 'DELETE' })
      .then(r => r.json())
      .then(j => {
        if (j.status === 'success') {
          document.getElementById(`split-${btn.dataset.splitId}`).remove();
          alert('✅ تم حذف الدفعة الجزئية');
        } else {
          alert('فشل: ' + (j.message || 'خطأ غير معروف'));
        }
      })
      .catch(() => alert('خطأ في الاتصال بالخادم'));
  });
});
</script>
{% endblock %}
