{% extends 'base.html' %}
{% block title %}تفاصيل الدفعة #{{ payment.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card">
    <div class="card-header bg-primary text-white">
      <h3>💰 تفاصيل الدفعة #{{ payment.id }}</h3>
    </div>
    <div class="card-body">
      <div class="row mb-4">
        <div class="col-md-6">
          <p><strong>المبلغ الكلي:</strong> {{ '%.2f'|format(payment.total_amount or 0) }} {{ payment.currency }}</p>
          <p><strong>التاريخ:</strong> {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d') or '—' }}</p>
          <p><strong>الطريقة (رئيسية):</strong> {{ (payment.method.value if payment.method and payment.method.value else payment.method) or '—' }}</p>
          <p><strong>الحالة:</strong>
            {% set st = payment.status.value if payment.status and payment.status.value else payment.status %}
            <span class="badge
              {% if st == 'COMPLETED' %}bg-success
              {% elif st == 'PENDING' %}bg-warning text-dark
              {% elif st == 'FAILED' %}bg-danger
              {% else %}bg-secondary{% endif %}">{{ st }}</span>
          </p>
        </div>
        <div class="col-md-6">
          <p><strong>الاتجاه:</strong>
            {% set d = payment.direction.value if payment.direction and payment.direction.value else payment.direction %}
            <span class="badge {% if d in ['IN','INCOMING'] %}bg-success{% else %}bg-danger{% endif %}">
              {{ 'وارد' if d in ['IN','INCOMING'] else 'صادر' }}
            </span>
          </p>
          <p><strong>الجهة:</strong> {{ payment.entity_label() or (payment.entity_type|capitalize) }}</p>
          <p><strong>المرجع:</strong> {{ payment.reference or '—' }}</p>
          <p><strong>الملاحظات:</strong> {{ payment.notes or '—' }}</p>
        </div>
      </div>

      <h4 class="mt-4">💳 الدفعات الجزئية:</h4>
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>المبلغ</th>
            <th>الطريقة</th>
            <th>التفاصيل</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="splitsTable">
          {% for s in payment.splits %}
          {% set method = s.method.value if s.method and s.method.value else s.method %}
          {% set d = s.details or {} %}
          <tr id="split-{{ s.id }}">
            <td>{{ loop.index }}.</td>
            <td>{{ '%.2f'|format(s.amount or 0) }} {{ payment.currency }}</td>
            <td>{{ (method or '—')|upper }}</td>
            <td>
              {% if method == 'cheque' %}
                رقم الشيك: {{ d.get('check_number','—') }}<br>
                البنك: {{ d.get('check_bank','—') }}<br>
                الاستحقاق: {{ d.get('check_due_date') or d.get('due_date') or '—' }}
              {% elif method == 'bank' %}
                مرجع التحويل: {{ d.get('bank_transfer_ref','—') }}
              {% elif method == 'card' %}
                بطاقة رقم: ****{{ (d.get('card_last4','') or (d.get('card_number','')|string)[-4:]) }}<br>
                حامل البطاقة: {{ d.get('card_holder','—') }}<br>
                انتهاء: {{ d.get('card_expiry','—') }}
              {% elif method == 'online' %}
                دفع إلكتروني ({{ d.get('gateway','—') }})
              {% else %}
                — 
              {% endif %}
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-danger remove-split" data-split-id="{{ s.id }}">🗑️ حذف</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="btn-group">
          <a href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}" class="btn btn-info">📄 تحميل الوصل</a>
          <button type="button" class="btn btn-outline-secondary" id="btn-view-receipt">👁️ عرض الوصل</button>
        </div>
        <form method="POST" action="{{ url_for('payments.delete_payment', payment_id=payment.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger" onclick="return confirm('هل أنت متأكد؟')">🗑️ حذف</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.remove-split').forEach(function(btn){
  btn.addEventListener('click', function(){
    if (!confirm('هل أنت متأكد من حذف هذه الدفعة الجزئية؟')) return;
    fetch('/payments/split/' + btn.dataset.splitId + '/delete', { method: 'DELETE' })
      .then(function(r){ return r.json(); })
      .then(function(j){
        if (j.status === 'success') {
          var row = document.getElementById('split-' + btn.dataset.splitId);
          if (row) row.remove();
          alert('✅ تم حذف الدفعة الجزئية');
        } else {
          alert('فشل: ' + (j.message || 'خطأ غير معروف'));
        }
      })
      .catch(function(){ alert('خطأ في الاتصال بالخادم'); });
  });
});

(function(){
  var btn = document.getElementById('btn-view-receipt');
  if (!btn) return;
  btn.addEventListener('click', function(){
    try {
      var data = {
        id: {{ payment.id }},
        currency: "{{ payment.currency or '' }}",
        total: "{{ '%.2f'|format(payment.total_amount or 0) }}",
        date: "{{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or '' }}",
        method: "{{ (payment.method.value if payment.method and payment.method.value else payment.method) or '' }}",
        status: "{{ (payment.status.value if payment.status and payment.status.value else payment.status) or '' }}",
        direction: "{{ (payment.direction.value if payment.direction and payment.direction.value else payment.direction) or '' }}",
        entity: "{{ (payment.entity_label() or payment.entity_type)|replace('\"','&quot;') }}"
      };
      var rows = Array.from(document.querySelectorAll('#splitsTable tr')).map(function(tr){
        var tds = tr.querySelectorAll('td');
        return {
          idx: (tds[0] && tds[0].textContent.trim()) || '',
          amount: (tds[1] && tds[1].textContent.trim()) || '',
          method: (tds[2] && tds[2].textContent.trim()) || '',
          details: (tds[3] && tds[3].innerHTML) || '—'
        };
      });
      var items = rows.map(function(r){
        return '<tr><td>'+r.idx+'</td><td class="text-end">'+r.amount+'</td><td>'+r.method+'</td><td>'+r.details+'</td></tr>';
      }).join('');
      var title = 'وصل دفعة #' + data.id;
      var w = window.open('', 'receipt'+data.id);
      w.document.write(
        '<html dir="rtl" lang="ar"><head><meta charset="utf-8"><title>'+title+'</title>'+
        '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">'+
        '<style>body{padding:24px} .h{color:#666} .table{font-size:12px}</style>'+
        '</head><body>'+
        '<div class="d-flex justify-content-between align-items-start mb-3">'+
          '<div><h4 class="mb-1">'+title+'</h4><div class="h">التاريخ: '+(data.date||'—')+'</div></div>'+
          '<div class="text-end"><div class="h">المبلغ الكلي</div><div class="fs-5 fw-bold">'+data.total+' '+(data.currency||'')+'</div></div>'+
        '</div>'+
        '<div class="row g-2 mb-3">'+
          '<div class="col"><div class="h">الجهة</div><div>'+data.entity+'</div></div>'+
          '<div class="col"><div class="h">الطريقة</div><div>'+(data.method||'—')+'</div></div>'+
          '<div class="col"><div class="h">الحالة</div><div>'+(data.status||'—')+'</div></div>'+
          '<div class="col"><div class="h">الاتجاه</div><div>'+(data.direction||'—')+'</div></div>'+
        '</div>'+
        '<table class="table table-bordered table-sm"><thead class="table-light"><tr>'+
          '<th style="width:60px">#</th><th class="text-end" style="width:180px">المبلغ</th><th style="width:140px">الطريقة</th><th>التفاصيل</th>'+
        '</tr></thead><tbody>'+items+'</tbody></table>'+
        '<div class="mt-3 text-center"><button onclick="window.print()" class="btn btn-primary">طباعة</button></div>'+
        '</body></html>'
      );
      w.document.close();
      w.focus();
    } catch (e) {
      alert('تعذر عرض الوصل الآن');
    }
  });
})();
</script>
{% endblock %}
