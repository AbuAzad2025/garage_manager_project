{% extends 'base.html' %}
{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}{% endblock %}
{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}
{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">
      <i class="fas fa-money-check-alt ml-2"></i>
      ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}
    </h2>
    <div class="btn-group">
      <a href="{{ url_for('payments.index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right ml-1"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
      </a>
      <a href="{{ url_for('payments.payment_receipt', payment_id=payment.id) }}" class="btn btn-primary">
        <i class="fas fa-receipt ml-1"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„
      </a>
      <a href="{{ url_for('ledger.index') }}?q={{ 'PAY-' ~ payment.id }}" class="btn btn-outline-info">
        <i class="fas fa-book ml-1"></i> Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°
      </a>
      {% if not active_split %}
        {% if payment.status == 'PENDING' %}
          <button id="completePayment" class="btn btn-success" data-payment-id="{{ payment.id }}">
            <i class="fas fa-check ml-1"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹Ø©
          </button>
          <button id="failPayment" class="btn btn-danger" data-payment-id="{{ payment.id }}">
            <i class="fas fa-times ml-1"></i> Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹Ø©
          </button>
        {% endif %}
        
      {% endif %}
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-info-circle ml-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø©</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</label>
              <p class="form-control-plaintext">{{ payment.id }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</label>
              <p class="form-control-plaintext">{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <p class="form-control-plaintext fw-bold text-primary">{{ "%.2f"|format(payment.total_amount) }} {{ payment.currency }}</p>
              {% if payment.fx_rate_used and payment.currency != 'ILS' %}
              <small class="text-muted d-block mt-1">
                <i class="fas fa-exchange-alt"></i>
                Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: {{ "%.4f"|format(payment.fx_rate_used) }}
                {% if payment.fx_rate_source %}
                  {% if payment.fx_rate_source == 'online' %}ğŸŒ{% elif payment.fx_rate_source == 'manual' %}âœï¸{% else %}âš™ï¸{% endif %}
                {% endif %}
                <br>
                Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø´ÙŠÙƒÙ„: <strong class="text-success">{{ "%.2f"|format(payment.total_amount * payment.fx_rate_used) }} â‚ª</strong>
              </small>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label>
              <p class="form-control-plaintext">
                {% if payment.direction == 'IN' %}
                  <span class="badge bg-success">ÙˆØ§Ø±Ø¯</span>
                {% else %}
                  <span class="badge bg-danger">ØµØ§Ø¯Ø±</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</label>
              <p class="form-control-plaintext">{{ payment.method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <p class="form-control-plaintext">
                {% if payment.status == 'COMPLETED' %}
                  <span class="badge bg-success">Ù…ÙƒØªÙ…Ù„Ø©</span>
                {% elif payment.status == 'PENDING' %}
                  <span class="badge bg-warning text-dark">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
                {% elif payment.status == 'FAILED' %}
                  <span class="badge bg-danger">ÙØ§Ø´Ù„Ø©</span>
                {% elif payment.status == 'REFUNDED' %}
                  <span class="badge bg-secondary">Ù…ÙØ±Ø¬Ø¹Ø©</span>
                {% else %}
                  <span class="badge bg-secondary">{{ payment.status or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù†</label>
              <p class="form-control-plaintext">{{ payment.entity_type or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Ø§Ù„Ù…Ø±Ø¬Ø¹</label>
              <p class="form-control-plaintext">{{ payment.reference or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            </div>
            {% if payment.notes %}
            <div class="col-12">
              <label class="form-label fw-bold">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <p class="form-control-plaintext">{{ payment.notes }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-link ml-2"></i>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</h5>
        </div>
        <div class="card-body">
          {% if payment.customer %}
            <div class="d-flex align-items-center">
              <i class="fas fa-user text-primary ml-2"></i>
              <div>
                <strong>Ø¹Ù…ÙŠÙ„:</strong> {{ payment.customer.name }}
                {% if payment.customer.phone %}
                  <br><small class="text-muted">{{ payment.customer.phone }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.supplier %}
            <div class="d-flex align-items-center">
              <i class="fas fa-truck text-warning ml-2"></i>
              <div>
                <strong>Ù…ÙˆØ±Ø¯:</strong> {{ payment.supplier.name }}
                {% if payment.supplier.contact %}
                  <br><small class="text-muted">{{ payment.supplier.contact }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.partner %}
            <div class="d-flex align-items-center">
              <i class="fas fa-handshake text-success ml-2"></i>
              <div>
                <strong>Ø´Ø±ÙŠÙƒ:</strong> {{ payment.partner.name }}
                {% if payment.partner.contact %}
                  <br><small class="text-muted">{{ payment.partner.contact }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.invoice %}
            <div class="d-flex align-items-center">
              <i class="fas fa-file-invoice text-info ml-2"></i>
              <div>
                <strong>ÙØ§ØªÙˆØ±Ø©:</strong> {{ payment.invoice.invoice_number or payment.invoice.id }}
                {% if payment.invoice.customer %}
                  <br><small class="text-muted">Ø¹Ù…ÙŠÙ„: {{ payment.invoice.customer.name }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.sale %}
            <div class="d-flex align-items-center">
              <i class="fas fa-shopping-cart text-info ml-2"></i>
              <div>
                <strong>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> {{ payment.sale.sale_number or payment.sale.id }}
                {% if payment.sale.customer %}
                  <br><small class="text-muted">Ø¹Ù…ÙŠÙ„: {{ payment.sale.customer.name }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.service %}
            <div class="d-flex align-items-center">
              <i class="fas fa-tools text-secondary ml-2"></i>
              <div>
                <strong>Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©:</strong> {{ payment.service.service_number or payment.service.id }}
                {% if payment.service.customer %}
                  <br><small class="text-muted">Ø¹Ù…ÙŠÙ„: {{ payment.service.customer.name }}</small>
                {% endif %}
              </div>
            </div>
          {% elif payment.shipment %}
            <div class="d-flex align-items-center">
              <i class="fas fa-dolly text-secondary ml-2"></i>
              <div>
                <strong>Ø´Ø­Ù†Ø©:</strong> {{ payment.shipment.shipment_number or payment.shipment.id }}
              </div>
            </div>
          {% elif payment.expense %}
            <div class="d-flex align-items-center">
              <i class="fas fa-file-invoice-dollar text-secondary ml-2"></i>
              <div>
                <strong>Ù…ØµØ±ÙˆÙ:</strong> {{ payment.expense.description or ('#' ~ payment.expense.id) }}
              </div>
            </div>
          {% elif payment.preorder %}
            <div class="d-flex align-items-center">
              <i class="fas fa-clipboard-list text-secondary ml-2"></i>
              <div>
                <strong>Ø·Ù„Ø¨ Ù…Ø³Ø¨Ù‚:</strong> {{ payment.preorder.reference or payment.preorder.id }}
              </div>
            </div>
          {% elif payment.loan_settlement %}
            <div class="d-flex align-items-center">
              <i class="fas fa-hand-holding-usd text-secondary ml-2"></i>
              <div>
                <strong>ØªØ³ÙˆÙŠØ© Ù‚Ø±Ø¶:</strong> {{ payment.loan_settlement.id }}
              </div>
            </div>
          {% else %}
            <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø© Ù…Ø±ØªØ¨Ø·Ø©</p>
          {% endif %}
        </div>
      </div>

      {% if active_split %}
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-credit-card ml-2"></i>Ø¬Ø²Ø¡ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ #{{ active_split.id }}</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ active_split.method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</strong>
              {% if active_split.reference %}
                <br><small class="text-muted">{{ active_split.reference }}</small>
              {% endif %}
            </div>
            <div class="text-end">
              {% set base_currency = active_split.currency or payment.currency %}
              {% set main_currency = payment.currency %}
              <span class="fw-bold">{{ "%.2f"|format(active_split.amount or 0) }} {{ base_currency }}</span>
              {% if base_currency and main_currency and base_currency.upper() != main_currency.upper() %}
                <div class="text-muted small">â‰ˆ {{ "%.2f"|format(active_split.converted_amount or 0) }} {{ main_currency }}</div>
              {% endif %}
            </div>
        </div>
          <div class="mt-2 text-end">
            <a href="{{ url_for('ledger.index') }}?q={{ 'SPLIT-' ~ active_split.id }}" class="btn btn-sm btn-outline-info"><i class="fas fa-book ml-1"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠØ¯</a>
          </div>
        </div>
      </div>
      {% endif %}

      {% if payment.splits %}
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-list ml-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h5>
        </div>
        <div class="card-body">
          {% for split in payment.splits %}
            <a href="{{ url_for('payments.view_payment_split', payment_id=payment.id, split_id=split.id) }}" class="d-flex justify-content-between align-items-center border-bottom py-2 text-decoration-none {% if active_split and split.id == active_split.id %}bg-warning{% endif %}" style="border-radius: 6px;">
              <div>
                <strong class="text-dark">{{ split.method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</strong>
                {% if split.reference %}
                  <br><small class="text-muted">{{ split.reference }}</small>
                {% endif %}
              </div>
              <div class="text-end">
                {% set base_currency = split.currency or payment.currency %}
                {% set main_currency = payment.currency %}
                <span class="fw-bold text-dark">{{ "%.2f"|format(split.amount or 0) }} {{ base_currency }}</span>
                {% if base_currency and main_currency and base_currency.upper() != main_currency.upper() %}
                  <div class="text-muted small">â‰ˆ {{ "%.2f"|format(split.converted_amount or 0) }} {{ main_currency }}</div>
                {% endif %}
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹Ø©
  const completeBtn = document.getElementById('completePayment');
  if (completeBtn) {
    completeBtn.addEventListener('click', function() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) {
        updatePaymentStatus(this.dataset.paymentId, 'COMPLETED');
      }
    });
  }

  // Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹Ø©
  const failBtn = document.getElementById('failPayment');
  if (failBtn) {
    failBtn.addEventListener('click', function() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) {
        updatePaymentStatus(this.dataset.paymentId, 'FAILED');
      }
    });
  }

  

  

  function updatePaymentStatus(paymentId, status) {
    const token = document.querySelector('meta[name="csrf-token"]')?.content || '';
    fetch(`/payments/${paymentId}/status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRFToken': token
      },
      body: JSON.stringify({ status: status, csrf_token: token })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
        location.reload();
      } else {
        alert('Ø®Ø·Ø£: ' + (data.message || 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©'));
      }
    })
    .catch(error => {

      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + error.message);
    });
  }

  const refundSplitBtn = document.getElementById('refundSplit');
  

  
});
</script>
{% endblock %}
