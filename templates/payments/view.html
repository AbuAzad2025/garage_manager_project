{% extends 'base.html' %}
{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# Ø§Ø³ØªØ®Ø¯Ù… enum_val Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† attribute('value') #}
  {% set st = enum_val(payment.status) %}
  {% set is_completed = (st == 'COMPLETED') %}
  {% set dirv = enum_val(payment.direction) %}
  {% set methodv = enum_val(payment.method) %}

  <div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h3 class="mb-0">ğŸ’° ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© #{{ payment.id }}</h3>
      <div class="d-flex gap-2 flex-wrap">
        {% if payment.payment_number %}
          <span class="badge bg-light text-dark">Ø§Ù„Ø³Ù†Ø¯: {{ payment.payment_number }}</span>
        {% endif %}
        {% if payment.receipt_number %}
          <span class="badge bg-light text-dark">Ø§Ù„ÙˆØµÙ„: {{ payment.receipt_number }}</span>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <div class="row mb-4">
        <div class="col-md-6">
          <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</strong>
            <span id="totalAmountValue">{{ '%.0f'|format(payment.total_amount or 0) }}</span> {{ payment.currency or '' }}
          </p>
          <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d') or 'â€”' }}</p>
          <p><strong>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© (Ø±Ø¦ÙŠØ³ÙŠØ©):</strong> {{ methodv or 'â€”' }}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
            <span class="badge
              {% if st == 'COMPLETED' %}bg-success
              {% elif st == 'PENDING' %}bg-warning text-dark
              {% elif st == 'FAILED' %}bg-danger
              {% else %}bg-secondary{% endif %}">{{ st or 'â€”' }}</span>
          </p>
        </div>
        <div class="col-md-6">
          <p><strong>Ø§Ù„Ø§ØªØ¬Ø§Ù‡:</strong>
            <span class="badge {% if dirv in ['IN','INCOMING'] %}bg-success{% else %}bg-danger{% endif %}">
              {{ 'ÙˆØ§Ø±Ø¯' if dirv in ['IN','INCOMING'] else 'ØµØ§Ø¯Ø±' }}
            </span>
          </p>
          <p><strong>Ø§Ù„Ø¬Ù‡Ø©:</strong> {{ payment.entity_label() or (payment.entity_type|capitalize) }}</p>
          <p><strong>Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong> {{ payment.reference or 'â€”' }}</p>
          <p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ payment.notes or 'â€”' }}</p>
        </div>
      </div>

      <h4 class="mt-4">ğŸ’³ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©:</h4>
      <table class="table table-bordered table-hover" id="splitsTableWrap">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="splitsTable">
          {% for s in payment.splits %}
            {% set m = enum_val(s.method)|string|lower %}
            {% set d = s.details if s.details is mapping else {} %}
            <tr id="split-{{ s.id }}">
              <td>{{ loop.index }}.</td>
              <td class="amount-cell" data-amount="{{ '%.0f'|format(s.amount or 0) }}">
                {{ '%.0f'|format(s.amount or 0) }} {{ payment.currency or '' }}
              </td>
              <td>{{ m|upper }}</td>
              <td>
                {% if m in ['cheque', 'check'] %}
                  Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ: {{ d.get('check_number') or 'â€”' }}<br>
                  Ø§Ù„Ø¨Ù†Ùƒ: {{ d.get('check_bank') or 'â€”' }}<br>
                  Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ d.get('check_due_date') or d.get('due_date') or 'â€”' }}
                {% elif m in ['bank', 'transfer', 'bank_transfer'] %}
                  Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„: {{ d.get('bank_transfer_ref') or d.get('reference') or 'â€”' }}
                {% elif m in ['card', 'credit'] %}
                  Ø¨Ø·Ø§Ù‚Ø©: {{
                    (d.get('card_last4') and ('****' ~ (d.get('card_last4')|string)))
                    or (d.get('card_number') and ('****' ~ ((d.get('card_number')|string)[-4:])))
                    or 'â€”'
                  }}<br>
                  Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: {{ d.get('card_holder') or 'â€”' }}<br>
                  Ø§Ù†ØªÙ‡Ø§Ø¡: {{ d.get('card_expiry') or 'â€”' }}
                {% elif m in ['online', 'mobile'] %}
                  Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©: {{ d.get('online_gateway') or d.get('gateway') or 'â€”' }}<br>
                  Ø§Ù„Ù…Ø±Ø¬Ø¹: {{ d.get('online_ref') or d.get('reference') or 'â€”' }}
                {% elif m == 'cash' %}
                  Ù†Ù‚Ø¯Ø§Ù‹
                {% else %}
                  â€”
                {% endif %}
              </td>
              <td>
                <button type="button" class="btn btn-sm btn-danger remove-split"
                        data-split-id="{{ s.id }}" {% if is_completed %}disabled{% endif %}>
                  ğŸ—‘ï¸ Ø­Ø°Ù
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="btn-group">
          <a href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}" class="btn btn-info">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„</a>
          <button type="button" class="btn btn-outline-secondary" id="btn-view-receipt">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙ„</button>
        </div>
        <form method="POST" action="{{ url_for('payments.delete_payment', payment_id=payment.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')" {% if is_completed %}disabled{% endif %}>ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  function toNumber(s){
    return parseFloat(String(s||'')
      .replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d))
      .replace(/[Ù¬ØŒ\s]/g,'')
      .replace(',', '.')) || 0;
  }

  function recalcTotalFromSplits() {
    const cells = document.querySelectorAll('#splitsTable .amount-cell');
    let sum = 0;
    cells.forEach(td => { sum += toNumber(td.dataset.amount || '0'); });
    const el = document.getElementById('totalAmountValue');
    if (el) el.textContent = sum.toFixed(0);
  }

  function ensurePlaceholderRow() {
    const tbody = document.getElementById('splitsTable');
    if (!tbody) return;
    const hasRows = !!tbody.querySelector('tr');
    if (!hasRows) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="5" class="text-center text-muted py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ø¬Ø²Ø¦ÙŠØ©</td>';
      tbody.appendChild(tr);
    } else {
      const lone = tbody.querySelector('td[colspan="5"]');
      if (lone && tbody.querySelectorAll('tr').length > 1) lone.parentElement.remove();
    }
  }

  const table = document.getElementById('splitsTable');
  if (table) {
    table.addEventListener('click', async function(e){
      const btn = e.target.closest('.remove-split');
      if (!btn) return;
      if (btn.hasAttribute('disabled')) return;
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©ØŸ')) return;
      try {
        const r = await fetch('/payments/split/' + btn.dataset.splitId + '/delete', {
          method: 'DELETE',
          headers: { 'Accept': 'application/json' }
        });
        const j = await r.json();
        if (j.status === 'success') {
          const row = document.getElementById('split-' + btn.dataset.splitId);
          if (row) row.remove();
          recalcTotalFromSplits();
          ensurePlaceholderRow();
          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©');
        } else {
          alert('ÙØ´Ù„: ' + (j.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (_) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
    });
  }

  const btnView = document.getElementById('btn-view-receipt');
  if (btnView) {
    btnView.addEventListener('click', function(){
      try {
        const data = {
          id: {{ payment.id }},
          currency: "{{ payment.currency or '' }}",
          total: (document.getElementById('totalAmountValue')?.textContent.trim()) || "{{ '%.0f'|format(payment.total_amount or 0) }}",
          date: "{{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or '' }}",
          method: "{{ methodv or '' }}",
          status: "{{ st or '' }}",
          direction: "{{ dirv or '' }}",
          entity: "{{ (payment.entity_label() or payment.entity_type)|e }}"
        };
        const rows = Array.from(document.querySelectorAll('#splitsTable tr')).map((tr, idx) => {
          const tds = tr.querySelectorAll('td');
          if (!tds.length) return null;
          return {
            idx: (idx+1),
            amount: (tds[1]?.textContent.trim()) || '',
            method: (tds[2]?.textContent.trim()) || '',
            details: (tds[3]?.innerHTML) || 'â€”'
          };
        }).filter(Boolean);
        const items = rows.map(r =>
          '<tr><td>'+r.idx+'</td><td class="text-end">'+r.amount+'</td><td>'+r.method+'</td><td>'+r.details+'</td></tr>'
        ).join('');
        const title = 'ÙˆØµÙ„ Ø¯ÙØ¹Ø© #' + data.id;
        const w = window.open('', 'receipt'+data.id);
        w.document.write(
          '<html dir="rtl" lang="ar"><head><meta charset="utf-8"><title>'+title+'</title>'+
          '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">'+
          '<style>body{padding:24px} .h{color:#666} .table{font-size:12px}</style>'+
          '</head><body>'+
          '<div class="d-flex justify-content-between align-items-start mb-3">'+
            '<div><h4 class="mb-1">'+title+'</h4><div class="h">Ø§Ù„ØªØ§Ø±ÙŠØ®: '+(data.date||'â€”')+'</div></div>'+
            '<div class="text-end"><div class="h">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</div><div class="fs-5 fw-bold">'+data.total+' '+(data.currency||'')+'</div></div>'+
          '</div>'+
          '<div class="row g-2 mb-3">'+
            '<div class="col"><div class="h">Ø§Ù„Ø¬Ù‡Ø©</div><div>'+data.entity+'</div></div>'+
            '<div class="col"><div class="h">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</div><div>'+(data.method||'â€”')+'</div></div>'+
            '<div class="col"><div class="h">Ø§Ù„Ø­Ø§Ù„Ø©</div><div>'+(data.status||'â€”')+'</div></div>'+
            '<div class="col"><div class="h">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</div><div>'+(data.direction||'â€”')+'</div></div>'+
          '</div>'+
          '<table class="table table-bordered table-sm"><thead class="table-light"><tr>'+
            '<th style="width:60px">#</th><th class="text-end" style="width:180px">Ø§Ù„Ù…Ø¨Ù„Øº</th><th style="width:140px">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>'+
          '</tr></thead><tbody>'+items+'</tbody></table>'+
          '<div class="mt-3 text-center"><button onclick="window.print()" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø©</button></div>'+
          '</body></html>'
        );
        w.document.close();
        w.focus();
      } catch (e) {
        alert('ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙ„ Ø§Ù„Ø¢Ù†');
      }
    });
  }

  ensurePlaceholderRow();
});
</script>
{% endblock %}
