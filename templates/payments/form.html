{% extends "base.html" %}
{% block title %}{{ payment and 'ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø©' or 'Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø©' }}{% endblock %}

{% block head_extra %}
<style>
/* ğŸ¨ Modern Gradient Design - ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ */

/* Page Background */
.content-wrapper {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
}

/* Payment Cards - ØªØ¯Ø±Ø¬Ø§Øª Ø¹ØµØ±ÙŠØ© */
.payment-form-card {
    border-radius: 20px !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12) !important;
    margin-bottom: 25px;
    border: none !important;
    background: white;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease !important;
}

.payment-form-card:hover {
    transform: translateY(-5px) !important;
    box-shadow: 0 15px 40px rgba(0,0,0,0.18) !important;
}

/* Card Headers - ØªØ¯Ø±Ø¬Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ù„ÙƒÙ„ Ù‚Ø³Ù… */
/* Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: 3 cards */
/* Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© */
form .row:nth-of-type(1) .col-md-4:nth-child(1) .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

/* Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® */
form .row:nth-of-type(1) .col-md-4:nth-child(2) .card-header {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
}

/* ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© */
form .row:nth-of-type(1) .col-md-4:nth-child(3) .card-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

/* Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© */
/* Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© */
form .row:nth-of-type(2) .col-md-6:nth-child(1) .card-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
}

/* Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© */
form .row:nth-of-type(2) .col-md-6:nth-child(2) .card-header {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%) !important;
    color: #2c3e50 !important;
}

/* Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«: Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
form .row:nth-of-type(3) .card-header {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important;
}

/* ØªØ­Ø³ÙŠÙ† Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ© */
#addSplit {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
    padding: 10px 25px !important;
    border-radius: 10px !important;
    transition: all 0.3s ease !important;
}

#addSplit:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3) !important;
}

.card-header {
    color: white !important;
    font-weight: 700 !important;
    font-size: 1.1rem !important;
    border-radius: 20px 20px 0 0 !important;
    padding: 18px 25px !important;
    border: none !important;
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
}

.card-header i {
    font-size: 1.4rem !important;
    opacity: 0.95;
}

.card-body {
    padding: 25px !important;
    overflow: visible !important;
}

/* Form Labels - Ø£ÙˆØ¶Ø­ ÙˆØ£Ø¬Ù…Ù„ */
.form-label {
    color: #2c3e50 !important;
    font-weight: 700 !important;
    margin-bottom: 10px !important;
    font-size: 0.95rem !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
}

/* Required Fields - Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© */
.required-field {
    position: relative !important;
}

.required-field i {
    margin-left: 6px !important;
}

.required-field .text-danger {
    font-size: 1.1rem !important;
    margin-right: 4px !important;
}

/* Optional Fields - Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© */
.optional-field i {
    margin-left: 6px !important;
}

.optional-field .badge {
    padding: 3px 8px !important;
    border-radius: 10px !important;
    font-weight: 600 !important;
}

/* Help Text - Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
.form-text {
    font-size: 0.85rem !important;
    color: #6c757d !important;
    margin-top: 6px !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.form-text i {
    color: #667eea !important;
}

/* Amount Input - Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº */
.amount-input {
    font-size: 1.2rem !important;
    font-weight: 700 !important;
    text-align: center !important;
    color: #11998e !important;
}

/* Form Controls - Ø¹ØµØ±ÙŠØ© ÙˆÙ…Ø±ÙŠØ­Ø© */
.form-control, .custom-select {
    border: 2px solid #e8ecf1 !important;
    border-radius: 12px !important;
    padding: 12px 18px !important;
    transition: all 0.3s ease !important;
    color: #2c3e50 !important;
    font-weight: 500 !important;
    font-size: 0.95rem !important;
    background: #f8f9fa !important;
}

.form-control:focus, .custom-select:focus {
    border-color: #667eea !important;
    background: white !important;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
    transform: scale(1.01) !important;
}

/* Split Forms - ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø£Ù†ÙŠÙ‚ */
.split-form {
    background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%) !important;
    border: 2px solid #e0e7ff !important;
    border-radius: 16px !important;
    padding: 20px !important;
    margin-bottom: 18px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06) !important;
    transition: all 0.3s ease !important;
}

.split-form:hover {
    border-color: #667eea !important;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15) !important;
}

.split-form h5 {
    color: #667eea !important;
    font-weight: 800 !important;
    font-size: 1.05rem !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
}

.split-form h5 i {
    color: #667eea !important;
}

/* Buttons - Ø£Ø²Ø±Ø§Ø± Ø¹ØµØ±ÙŠØ© */
.btn-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    border: none !important;
    font-weight: 700 !important;
    padding: 14px 35px !important;
    border-radius: 12px !important;
    box-shadow: 0 6px 20px rgba(17, 153, 142, 0.3) !important;
    transition: all 0.3s ease !important;
    font-size: 1.05rem !important;
}

.btn-success:hover {
    transform: translateY(-3px) scale(1.02) !important;
    box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4) !important;
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%) !important;
    border: none !important;
    font-weight: 700 !important;
    border-radius: 10px !important;
    transition: all 0.3s ease !important;
}

.btn-danger:hover {
    transform: scale(1.05) !important;
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3) !important;
}

.btn-secondary {
    background: linear-gradient(135deg, #868f96 0%, #596164 100%) !important;
    border: none !important;
    font-weight: 600 !important;
    border-radius: 10px !important;
}

/* Entity Info Card */
.entity-info-card {
    background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%) !important;
    border: 3px solid #00bcd4 !important;
    border-radius: 16px !important;
    box-shadow: 0 6px 20px rgba(0, 188, 212, 0.2) !important;
}

.entity-info-card .card-header {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%) !important;
}

#splitSum {
    color: #667eea !important;
    font-weight: 700 !important;
    font-size: 1rem !important;
    margin-top: 8px !important;
    padding: 8px 12px !important;
    background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%) !important;
    border-radius: 8px !important;
    display: inline-block !important;
}

/* Badges - Ø¹ØµØ±ÙŠØ© */
.badge {
    padding: 8px 16px !important;
    border-radius: 20px !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
}

.badge-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
    border: none !important;
}

.badge-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
}

.badge-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%) !important;
}

.badge-warning {
    background: linear-gradient(135deg, #f7b733 0%, #fc4a1a 100%) !important;
}

/* Alerts - ØªØµÙ…ÙŠÙ… Ø­Ø¯ÙŠØ« */
.alert {
    border-radius: 12px !important;
    border: none !important;
    padding: 15px 20px !important;
    font-weight: 500 !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
}

.alert-danger {
    background: linear-gradient(135deg, #ffe0e0 0%, #ffd0d0 100%) !important;
    color: #d32f2f !important;
}

.alert-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffe4a3 100%) !important;
    color: #856404 !important;
}

.alert-info {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%) !important;
    color: #0c5460 !important;
}

.alert-success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
    color: #155724 !important;
}

/* Input Groups - Ø¹ØµØ±ÙŠ */
.input-group {
    border-radius: 12px !important;
    overflow: hidden !important;
}

.input-group .btn {
    border-radius: 0 12px 12px 0 !important;
    padding: 12px 20px !important;
    font-weight: 600 !important;
}

/* Search Results - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠØ© */
.search-results {
    position: absolute !important;
    top: calc(100% + 5px) !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    max-height: 500px !important; /* âœ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù…Ù† 350 Ø¥Ù„Ù‰ 500 */
    overflow-y: auto !important;
    z-index: 9999 !important;
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.35) !important;
    border: 3px solid #667eea !important;
    background: white !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Dropdown Toggle Button - Ø²Ø± Ø§Ù„Ø³Ù‡Ù… */
.dropdown-toggle-btn {
    border-left: none !important;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    color: #495057 !important;
    font-size: 0.9rem !important;
    padding: 0.5rem 1rem !important;
    transition: all 0.3s ease !important;
    border: 1px solid #ced4da !important;
}

.dropdown-toggle-btn:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%) !important;
    color: #667eea !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
}

.dropdown-toggle-btn:active {
    transform: translateY(0);
}

.dropdown-toggle-btn i {
    transition: transform 0.3s ease;
}

.dropdown-toggle-btn:hover i {
    transform: rotate(180deg);
}

/* Search Dropdown Field */
.search-dropdown-field {
    border-right: none !important;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø¹Ø¬Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª */
.toast,
.toastr,
[class*="toast-"],
[class*="notification-"],
.alert-toast,
.swal2-container {
    display: none !important;
}

/* Ø¶Ù…Ø§Ù† positioning ØµØ­ÙŠØ­ */
.entity-field-container {
    position: relative !important;
    z-index: 1 !important;
    overflow: visible !important; /* âœ… Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ù‚Ø·Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
}

.entity-field-container .input-group {
    position: relative !important;
    z-index: 1 !important;
    overflow: visible !important; /* âœ… Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ù‚Ø·Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
}

/* âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ card ÙŠØ³Ù…Ø­ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¸Ù‡ÙˆØ± */
.payment-form-card {
    overflow: visible !important;
}

.payment-form-card .card-body {
    overflow: visible !important;
}

.search-results .list-group-item {
    border: none !important;
    border-bottom: 1px solid #f0f0f0 !important;
    padding: 8px 12px !important; /* âœ… Ù…Ø¶ØºÙˆØ· - Ø¹Ø´Ø§Ù† Ù†Ø´ÙˆÙ Ø¨Ù†ÙˆØ¯ Ø£ÙƒØ«Ø± */
    transition: all 0.25s ease !important;
    background: transparent !important; /* âœ… Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ© - Ø§Ù„Ù†Øµ ÙˆØ§Ø¶Ø­ */
}

/* âœ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.search-results .text-primary,
.search-results .fw-bold,
.search-results .list-group-item div,
.search-results .list-group-item span {
    background: transparent !important;
    background-color: transparent !important;
}

.search-results .list-group-item:hover {
    background: linear-gradient(135deg, #f8f9ff 0%, #ededff 100%) !important;
    transform: translateX(-3px) !important; /* âœ… Ø­Ø±ÙƒØ© Ø£Ù‚Ù„ */
    padding-right: 15px !important; /* âœ… padding Ø£Ù‚Ù„ */
    cursor: pointer !important;
}

.search-results .list-group-item:last-child {
    border-bottom: none !important;
}

/* Input Fields Ù„Ù„Ø¨Ø­Ø« */
input[name$="_search"] {
    border: 2px solid #e8ecf1 !important;
    transition: all 0.3s ease !important;
}

input[name$="_search"]:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
}

input[name$="_search"]::placeholder {
    color: #adb5bd !important;
    font-style: italic !important;
}

/* Page Title */
h2, h3, h4 {
    color: #2c3e50 !important;
    font-weight: 700 !important;
}

/* ØªÙ… Ø­Ø°Ù Animation Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ */
</style>
{% endblock %}

{% block content %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-money-bill-wave"></i>
                        {% if payment %}
                            ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø© #{{ payment.id }}
                        {% else %}
                            Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        {% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('payments.index') }}">Ø§Ù„Ø¯ÙØ¹Ø§Øª</a></li>
                        <li class="breadcrumb-item active">{{ payment and 'ØªØ¹Ø¯ÙŠÙ„' or 'Ø¥Ù†Ø´Ø§Ø¡' }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">

  {% if entity_info %}
  <div class="card mb-4 entity-info-card">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø±ØªØ¨Ø·Ø©</h5>
    </div>
    <div class="card-body">
      <div class="row gy-3">
        {% if entity_info.number %}
          <div class="col-md-4"><strong>Ø§Ù„Ø±Ù‚Ù…:</strong> {{ entity_info.number }}</div>
          {% if entity_info.date %}
            <div class="col-md-4"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ entity_info.date }}</div>
          {% endif %}
          {% if entity_info.total is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> {{ '%.0f'|format(entity_info.total) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.paid is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> {{ '%.0f'|format(entity_info.paid) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> {{ '%.0f'|format(entity_info.balance) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance_due is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> {{ '%.0f'|format(entity_info.balance_due) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.amount is defined and not entity_info.total %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
          {% endif %}
        {% elif entity_info.name %}
          <div class="col-md-6"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ entity_info.name }}</div>
          {% if entity_info.balance is defined %}
            <div class="col-md-6"><strong>Ø§Ù„Ø±ØµÙŠØ¯:</strong> {{ '%.0f'|format(entity_info.balance) }}</div>
          {% endif %}
        {% elif entity_info.type == 'expense' %}
          <div class="col-md-4"><strong>Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong> {{ entity_info.number }}</div>
          <div class="col-md-4"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ entity_info.date }}</div>
          <div class="col-md-4"><strong>Ø§Ù„Ù‚ÙŠÙ…Ø©:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
        {% endif %}
        {% if entity_info.type_name %}
          <div class="col-md-4"><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong> {{ entity_info.type_name }}</div>
        {% endif %}
        {% if entity_info.employee_name %}
          <div class="col-md-4"><strong>Ø§Ù„Ù…ÙˆØ¸Ù‘Ù:</strong> {{ entity_info.employee_name }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <form method="POST" id="paymentForm" action="{{ url_for('payments.create_payment') }}" autocomplete="off">
    {{ form.hidden_tag() }}
    {% if form.request_token is not none %}
      {{ form.request_token }}
    {% endif %}

    <div class="row">
      <!-- Card 1: Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ù„Ø¬Ù‡Ø© -->
      <div class="col-md-4">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-tags"></i> Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
          </div>
          <div class="card-body">
            
            <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø© - Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
            {% if form.entity_type is not none %}
            <div class="mb-4">
              <label class="form-label required-field">
                <i class="fas fa-building text-primary"></i>
                {{ form.entity_type.label.text }}
                <span class="text-danger fw-bold">*</span>
              </label>
              {{ form.entity_type(class="custom-select") }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§
              </small>
              {% for e in form.entity_type.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Ø§Ù„Ø§ØªØ¬Ø§Ù‡ - Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
            {% if form.direction is not none %}
            <div class="mb-4">
              <label class="form-label required-field">
                <i class="fas fa-exchange-alt text-success"></i>
                {{ form.direction.label.text }}
                <span class="text-danger fw-bold">*</span>
              </label>
              {{ form.direction(class="custom-select") }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> ÙˆØ§Ø±Ø¯ (Ù‚Ø¨Ø¶ Ù…Ù†Ù‡Ù…) Ø£Ùˆ ØµØ§Ø¯Ø± (Ø¯ÙØ¹ Ù„Ù‡Ù…)
              </small>
              {% for e in form.direction.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Ø§Ù„Ø­Ø§Ù„Ø© - Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
            {% if form.status is not none %}
            <div class="mb-4">
              <label class="form-label required-field">
                <i class="fas fa-check-circle text-info"></i>
                {{ form.status.label.text }}
                <span class="text-danger fw-bold">*</span>
              </label>
              {{ form.status(class="custom-select") }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø© (Ù…ÙƒØªÙ…Ù„Ø©ØŒ Ù…Ø¹Ù„Ù‚Ø©ØŒ Ø¥Ù„Ø®)
              </small>
              {% for e in form.status.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

          </div>
        </div>
      </div>

      <!-- Card 2: Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® -->
      <div class="col-md-4">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
          </div>
          <div class="card-body">
            
            <!-- Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ - Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
            {% if form.total_amount is not none %}
            <div class="mb-4">
              <label class="form-label required-field">
                <i class="fas fa-dollar-sign text-success"></i>
                {{ form.total_amount.label.text }}
                <span class="text-danger fw-bold">*</span>
              </label>
              {{ form.total_amount(class="form-control amount-input", step="1", min="0", placeholder="0") }}
              <div id="splitSum" class="form-text"></div>
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙØ¹Ø© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
              </small>
              {% for e in form.total_amount.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Ø§Ù„Ø¹Ù…Ù„Ø© - Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
            {% if form.currency is not none %}
            <div class="mb-4">
              <label class="form-label required-field">
                <i class="fas fa-coins text-warning"></i>
                {{ form.currency.label.text }}
                <span class="text-danger fw-bold">*</span>
              </label>
              {{ form.currency(class="custom-select") }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Ø¹Ù…Ù„Ø© Ø§Ù„Ø¯ÙØ¹ (Ø´ÙŠÙƒÙ„ØŒ Ø¯ÙˆÙ„Ø§Ø±ØŒ Ø¯ÙŠÙ†Ø§Ø±)
              </small>
              {% for e in form.currency.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø© - Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
            {% if form.payment_date is not none %}
            <div class="mb-4">
              <label class="form-label required-field">
                <i class="fas fa-calendar-alt text-primary"></i>
                {{ form.payment_date.label.text }}
                <span class="text-danger fw-bold">*</span>
              </label>
              {% set _pd = form.payment_date.data %}
              {% set _val = (_pd if _pd is string else (_pd.strftime("%Y-%m-%dT%H:%M") if _pd else "")) %}
              {{ form.payment_date(type="datetime-local", class="form-control", value=_val) }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹Ø©
              </small>
              {% for e in form.payment_date.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

          </div>
        </div>
      </div>

      <!-- Card 3: ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© -->
      <div class="col-md-4">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-info-circle"></i> ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©
          </div>
          <div class="card-body">
            
            <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ - Ù…Ø®ÙÙŠ (ÙŠÙØ³ØªØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©) -->
            {% if form.method is not none %}
            <div class="mb-4" style="display: none;">
              {{ form.method(class="custom-select", value="cash") }}
            </div>
            {% endif %}

            <!-- Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ - Ø§Ø®ØªÙŠØ§Ø±ÙŠ -->
            {% if form.reference is not none %}
            <div class="mb-4">
              <label class="form-label optional-field">
                <i class="fas fa-hashtag text-secondary"></i>
                {{ form.reference.label.text }}
                <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span>
              </label>
              {{ form.reference(class="form-control", placeholder="Ù…Ø«Ø§Ù„: INV-2024-001") }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ù…Ø±Ø¬Ø¹ Ø®Ø§Ø±Ø¬ÙŠ
              </small>
              {% for e in form.reference.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„ - Ø§Ø®ØªÙŠØ§Ø±ÙŠ -->
            {% if form.receipt_number is not none %}
            <div class="mb-4">
              <label class="form-label optional-field">
                <i class="fas fa-receipt text-secondary"></i>
                {{ form.receipt_number.label.text }}
                <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span>
              </label>
              {{ form.receipt_number(class="form-control", placeholder="Ù…Ø«Ø§Ù„: RCP-001") }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Ø±Ù‚Ù… Ø¥ÙŠØµØ§Ù„ Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ØªÙˆØ«ÙŠÙ‚
              </small>
              {% for e in form.receipt_number.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… - Ø§Ø®ØªÙŠØ§Ø±ÙŠ -->
            {% if form.receiver_name is not none %}
            <div class="mb-4">
              <label class="form-label optional-field">
                <i class="fas fa-user text-secondary"></i>
                {{ form.receiver_name.label.text }}
                <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span>
              </label>
              {{ form.receiver_name(class="form-control", placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³ØªÙ„Ù…") }}
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ„Ù… Ø§Ù„Ù…Ø¨Ù„Øº
              </small>
              {% for e in form.receiver_name.errors %}
                <div class="text-danger small mt-1">{{ e }}</div>
              {% endfor %}
            </div>
            {% endif %}

          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© -->
    <div class="row">
      <!-- Card 4: Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© -->
      <div class="col-md-6">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-user-tie"></i> Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
            <span class="text-danger fw-bold ms-2">* Ù…Ø·Ù„ÙˆØ¨</span>
          </div>
          <div class="card-body" id="entityFields">
            {% include "payments/_entity_fields.html" %}
            <small class="form-text text-muted d-block mt-2">
              <i class="fas fa-info-circle"></i> Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ (Ø¹Ù…ÙŠÙ„ØŒ Ù…ÙˆØ±Ø¯ØŒ Ø´Ø±ÙŠÙƒØŒ Ø¥Ù„Ø®)
            </small>
          </div>
        </div>
      </div>

      <!-- Card 5: Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© -->
      <div class="col-md-6">
        <div class="card mb-4 payment-form-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-layer-group"></i> Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</span>
            <small class="badge badge-info">Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 3 Ø·Ø±Ù‚ Ø¯ÙØ¹</small>
          </div>
          <div class="card-body">
            <div class="alert alert-info mb-3" style="border-radius: 10px; padding: 12px;">
              <i class="fas fa-lightbulb"></i>
              <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù„ÙƒÙ„ Ø¬Ø²Ø¡. ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ù…Ø¬ Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ø±ÙŠÙ‚Ø© (Ù…Ø«Ù„: Ù†Ù‚Ø¯ + Ø´ÙŠÙƒ).
            </div>
        {% if form.splits and form.splits.errors %}
          <div class="alert alert-danger py-2">
            {% for err in form.splits.errors %}
              <div>â€¢ {{ err }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div id="splitsContainer" data-max-splits="3">
          {% for split in form.splits %}
          <div class="split-form border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="fas fa-credit-card ml-2"></i>
                Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ #{{ loop.index }}
              </h5>
              <button type="button" class="btn btn-danger btn-sm remove-split" {% if loop.first %}disabled{% endif %}>
                <i class="fas fa-trash ml-1"></i>Ø­Ø°Ù
              </button>
            </div>

            <div class="row gy-2">
              <div class="col-md-6">
                <label class="form-label required-field">
                  <i class="fas fa-wallet text-primary"></i>
                  {{ split.method.label.text }}
                  <span class="text-danger fw-bold">*</span>
                </label>
                {{ split.method(class="custom-select split-method") }}
                <small class="form-text text-muted">
                  <i class="fas fa-info-circle"></i> ÙƒÙŠÙ Ø³ØªØ¯ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡
                </small>
                {% for e in split.method.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label required-field">
                  <i class="fas fa-dollar-sign text-success"></i>
                  {{ split.amount.label.text }}
                  <span class="text-danger fw-bold">*</span>
                </label>
                {{ split.amount(class="form-control amount-input", step="1", min="0", placeholder="0") }}
                <small class="form-text text-muted">
                  <i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
                </small>
                {% for e in split.amount.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
            </div>

            {% set _detail_fields = [
              'check_number','check_bank','check_due_date',
              'bank_transfer_ref',
              'card_number','card_holder','card_expiry',
              'online_gateway','online_ref'
            ] %}

            <div class="split-details mt-3" style="display:none;">
              <div class="alert alert-info mb-2" style="display:none;" data-cheque-info>
                <i class="fas fa-money-check-alt"></i> <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´ÙŠÙƒ:</strong> ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯Ù‚Ø©
              </div>
              <div class="row gy-2">
                {% for fname in _detail_fields %}
                  {% set field = split|attr(fname) %}
                  {% if field is not none %}
                  <div class="col-md-4" data-field="{{ fname }}">
                    <label class="form-label">
                      {% if fname == 'check_number' %}<i class="fas fa-hashtag text-primary"></i>{% endif %}
                      {% if fname == 'check_bank' %}<i class="fas fa-university text-info"></i>{% endif %}
                      {% if fname == 'check_due_date' %}<i class="fas fa-calendar-alt text-warning"></i>{% endif %}
                      {{ field.label.text }}
                    </label>
                    {% if fname == 'check_due_date' %}
                      {{ field(type="date", class="form-control") }}
                    {% else %}
                      {{ field(class="form-control") }}
                    {% endif %}
                    {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <button type="button" id="addSplit" class="btn btn-secondary">
          <i class="fas fa-plus-circle ml-1"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ Ø£Ø®Ø±Ù‰
        </button>
        <small class="form-text text-muted d-block mt-2">
          <i class="fas fa-info-circle"></i> Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ø±ÙŠÙ‚Ø©ØŒ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø±ÙŠÙ‚Ø© Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø«Ø§Ù„Ø«Ø©
        </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 6: Ù…Ù„Ø§Ø­Ø¸Ø§Øª - ØµÙ ÙƒØ§Ù…Ù„ -->
    {% if form.notes is not none %}
    <div class="row">
      <div class="col-12">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            <span class="badge bg-secondary ms-2" style="font-size: 0.8rem;">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span>
          </div>
          <div class="card-body">
            {{ form.notes(class="form-control", rows="3", placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©...") }}
            <small class="form-text text-muted">
              <i class="fas fa-info-circle"></i> Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„ØªÙˆØ¶ÙŠØ­
            </small>
            {% for e in form.notes.errors %}
              <div class="text-danger small mt-1">{{ e }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="card payment-form-card" style="border: none; box-shadow: none; background: transparent;">
      <div class="card-body text-center" style="padding: 30px 0;">
        <div class="d-flex justify-content-center align-items-center gap-3">
          <button type="button" id="submitPaymentBtn" class="btn btn-success btn-lg px-5 py-3">
            <i class="fas fa-save ml-2"></i>
            <span class="fw-bold">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</span>
          </button>
          <a href="{{ url_for('payments.index') }}" class="btn btn-secondary btn-lg px-5 py-3">
            <i class="fas fa-times ml-2"></i>
            <span class="fw-bold">Ø¥Ù„ØºØ§Ø¡</span>
          </a>
        </div>
        <small class="text-muted d-block mt-3">
          <i class="fas fa-info-circle"></i>
          ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (*) Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
        </small>
        {% if payment %}
        <div class="mt-3">
          <button type="button" class="btn btn-warning btn-lg px-4 py-2" data-toggle="modal" data-target="#archiveModal">
            <i class="fas fa-archive ml-2"></i> Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </form>

  <!-- ğŸ”” Modal ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹Ø© -->
  <!-- âœ… Ù„Ø§ Ù…ÙˆØ¯Ø§Ù„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… confirm() Ø¨Ø³ÙŠØ· -->

        </div>
    </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/payment_form.js') }}"></script>
  
  <script>
    // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ø¬Ù‡Ø§Øª
    let searchTimeout = {};
    
    function searchEntities(entityType, searchTerm) {
      console.log(`ğŸ” Ø¨Ø­Ø« Ø¹Ù† ${entityType}: "${searchTerm}"`);
      
      if (!searchTerm || searchTerm.length < 2) {
        hideEntityResults(entityType);
        return;
      }
      
      clearTimeout(searchTimeout[entityType]);
      searchTimeout[entityType] = setTimeout(() => {
        console.log(`ğŸ“¡ Ø¬Ù„Ø¨ Ù†ØªØ§Ø¦Ø¬ ${entityType}...`);
        fetch(`/payments/api/entities/${entityType}?search=${encodeURIComponent(searchTerm)}`)
          .then(response => {
            if (response.status === 302 || response.status === 401) {
              hideEntityResults(entityType);
              return;
            }
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data && data.success && data.results) {
              console.log(`âœ… ÙˆØ¬Ø¯ ${data.results.length} Ù†ØªÙŠØ¬Ø©`);
              showEntityResults(entityType, data.results);
            }
          })
          .catch(error => {

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
            if (searchField) {
              searchField.style.borderColor = '#dc3545';
              setTimeout(() => {
                searchField.style.borderColor = '';
              }, 3000);
            }
          });
      }, 300);
    }
    
    function showEntityResults(entityType, entities) {
      console.log(`ğŸ“‹ showEntityResults: ${entityType}, ${entities.length} Ù†ØªÙŠØ¬Ø©`);
      
      const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
      if (!searchField) {
        console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ searchField: ${entityType.toLowerCase()}_search`);
        return;
      }
      
      console.log(`âœ… ÙˆÙØ¬Ø¯ searchField: ${searchField.name}`);
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      hideEntityResults(entityType);
      
      if (entities.length === 0) {
        console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬');
        return;
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ - ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ
      const resultsDiv = document.createElement('div');
      resultsDiv.className = 'search-results list-group';
      resultsDiv.id = `${entityType.toLowerCase()}_results`;
      // Ù„Ø§ Ù†Ø¶Ø¹ inline styles - Ù†Ø³ØªØ®Ø¯Ù… CSS classes ÙÙ‚Ø·
      console.log(`ğŸ¨ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ resultsDiv Ø¨Ù€ class: ${resultsDiv.className}`);
      
      entities.forEach(entity => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold text-primary">
                <i class="fas fa-user-circle ml-1"></i>
                ${entity.name || entity.display}
              </div>
              ${entity.phone ? `<small class="text-muted"><i class="fas fa-phone ml-1"></i>${entity.phone}</small>` : ''}
              ${entity.email ? `<small class="text-muted d-block"><i class="fas fa-envelope ml-1"></i>${entity.email}</small>` : ''}
              ${entity.balance !== undefined ? `<small class="badge bg-info mt-1">Ø§Ù„Ø±ØµÙŠØ¯: ${parseFloat(entity.balance).toFixed(0)}</small>` : ''}
            </div>
            <i class="fas fa-check-circle text-success"></i>
          </div>
        `;
        
        item.addEventListener('click', () => {
          selectEntity(entityType, entity);
          hideEntityResults(entityType);
        });
        
        resultsDiv.appendChild(item);
      });
      
      // âœ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ input-group (Ø®Ø§Ø±Ø¬Ù‡Ø§!) Ù„ØªØ¬Ù†Ø¨ overflow
      const inputGroup = searchField.closest('.input-group');
      const entityContainer = searchField.closest('.entity-field-container');
      
      console.log(`ğŸ” inputGroup: ${inputGroup ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ù…ÙÙ‚ÙˆØ¯'}`);
      console.log(`ğŸ” entityContainer: ${entityContainer ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ù…ÙÙ‚ÙˆØ¯'}`);
      
      if (entityContainer && inputGroup) {
        // Ø¬Ø¹Ù„ entityContainer relative positioning
        entityContainer.style.position = 'relative';
        entityContainer.style.overflow = 'visible';
        entityContainer.style.zIndex = '10';
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ input-group (Ù„ÙŠØ³ Ø¯Ø§Ø®Ù„Ù‡Ø§!)
        if (inputGroup.nextSibling) {
          entityContainer.insertBefore(resultsDiv, inputGroup.nextSibling);
        } else {
          entityContainer.appendChild(resultsDiv);
        }
        
        console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù€ DOM (Ø¨Ø¹Ø¯ input-group)`);
        console.log(`ğŸ“Š resultsDiv ÙÙŠ DOM: ${document.getElementById(resultsDiv.id) ? 'Ù†Ø¹Ù… âœ…' : 'Ù„Ø§ âŒ'}`);
        console.log(`ğŸ¨ resultsDiv display: ${window.getComputedStyle(resultsDiv).display}`);
        console.log(`ğŸ¨ resultsDiv z-index: ${window.getComputedStyle(resultsDiv).zIndex}`);
      } else {
        console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ containers`);
      }
    }
    
    function hideEntityResults(entityType) {
      const resultsDiv = document.getElementById(`${entityType.toLowerCase()}_results`);
      if (resultsDiv) {
        resultsDiv.remove();
      }
    }
    
    function selectEntity(entityType, entity) {
      const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
      const hiddenField = document.querySelector(`input[name="${entityType.toLowerCase()}_id"]`);
      const entityIdField = document.querySelector(`input[name="entity_id"]`);
      
      if (searchField && hiddenField) {
        searchField.value = entity.name || entity.display;
        hiddenField.value = entity.id;
        
        // ØªØ­Ø¯ÙŠØ« entity_id Ø£ÙŠØ¶Ø§Ù‹
        if (entityIdField) {
          entityIdField.value = entity.id;
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        hideEntityResults(entityType);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        updateEntityFields();
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯) Ù„Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø´Ø­Ù†Ø§Øª
        if (['SALE', 'INVOICE', 'PREORDER', 'SERVICE', 'SHIPMENT'].includes(entityType.toUpperCase())) {
          fetchRelatedParty(entityType, entity.id);
        }
      }
    }
    
    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ±Ø¯)
    function fetchRelatedParty(entityType, entityId) {
      fetch(`/payments/api/related-party?entity_type=${entityType}&entity_id=${entityId}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.success) {
            // Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¨Ø·
            if (data.customer_id && data.customer_name) {
              const customerSearchField = document.getElementById('customer_search');
              const customerIdField = document.getElementById('customer_id');
              if (customerSearchField) customerSearchField.value = data.customer_name;
              if (customerIdField) customerIdField.value = data.customer_id;
            }
            
            // Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·
            if (data.supplier_id && data.supplier_name) {
              const supplierSearchField = document.getElementById('supplier_search');
              const supplierIdField = document.getElementById('supplier_id');
              if (supplierSearchField) supplierSearchField.value = data.supplier_name;
              if (supplierIdField) supplierIdField.value = data.supplier_id;
            }
          }
        })
        .catch(error => {

        });
    }
    
    // âœ… Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø± (Ù…ÙˆØ­Ù‘Ø¯Ø© ÙˆÙ…Ø­Ø³Ù‘Ù†Ø©)
    function updateEntityFields() {
      const entityTypeSelect = document.querySelector('select[name="entity_type"]');
      if (!entityTypeSelect) return;
      
      const selectedType = entityTypeSelect.value.toUpperCase();

      const entityFieldsContainer = document.getElementById('entityFields');
      if (!entityFieldsContainer) {

        return;
      }
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
      const allContainers = entityFieldsContainer.querySelectorAll('.entity-field-container');

      allContainers.forEach(container => {
        container.style.display = 'none';

      });
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
      const targetContainer = entityFieldsContainer.querySelector(`[data-entity-type="${selectedType.toLowerCase()}"]`);
      if (targetContainer) {
        targetContainer.style.display = 'block';
      }
      
      // âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      setTimeout(function() {
        attachSearchListeners();
      }, 100);
    }
    
    // âœ… Ø¯Ø§Ù„Ø© Ø±Ø¨Ø· event listeners Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
    function attachSearchListeners() {
      const searchFields = document.querySelectorAll('input[name$="_search"]');
      searchFields.forEach(field => {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø¹Ù†ØµØ±
        const newField = field.cloneNode(true);
        field.parentNode.replaceChild(newField, field);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¨Ø­Ø«
        newField.addEventListener('input', function() {
          const entityType = newField.name.replace('_search', '').toUpperCase();
          searchEntities(entityType, this.value);
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ±ÙƒÙŠØ² (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬)
        newField.addEventListener('focus', function() {
          const val = this.value.trim();
          if (val.length >= 2) {
            const entityType = newField.name.replace('_search', '').toUpperCase();
            searchEntities(entityType, val);
          }
        });
        
        console.log(`âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ù€: ${newField.name}`);
      });
      
      // âœ… Ø¥Ø¶Ø§ÙØ© listeners Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù‡Ù…
      const dropdownBtns = document.querySelectorAll('.dropdown-toggle-btn');
      dropdownBtns.forEach(btn => {
        const entityType = btn.getAttribute('data-entity');
        if (entityType) {
          // Ø¥Ø²Ø§Ù„Ø© listener Ø§Ù„Ù‚Ø¯ÙŠÙ…
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          
          // Ø¥Ø¶Ø§ÙØ© listener Ø¬Ø¯ÙŠØ¯
          newBtn.addEventListener('click', function() {
            console.log(`ğŸ”½ Ø§Ù„Ø³Ù‡Ù…: Ø¹Ø±Ø¶ ÙƒÙ„ ${entityType}`);
            loadAllEntities(entityType.toUpperCase());
          });
        }
      });
    }
    
    // ğŸ”½ ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù‡Ù…
    async function loadAllEntities(entityType) {
      try {
        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ù€ endpoint Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ searchEntities
        const url = `/payments/api/entities/${entityType}?search=`;
        
        console.log(`ğŸ“¡ Ø¬Ù„Ø¨ ÙƒÙ„ ${entityType}...`);
        const res = await fetch(url);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const data = await res.json();
        
        if (data.success && data.results) {
          console.log(`âœ… ÙˆØ¬Ø¯ ${data.results.length} Ù†ØªÙŠØ¬Ø©`);
          showEntityResults(entityType, data.results);
        }
      } catch (err) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ${entityType}:`, err);
      }
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
      const entityTypeSelect = document.querySelector('select[name="entity_type"]');
      if (entityTypeSelect) {
        entityTypeSelect.addEventListener('change', function() {
          updateEntityFields();
          // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
          updateDirectionOptions();
        });
        
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
      setTimeout(function() {
        updateEntityFields();
        updateDirectionOptions(); // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø£ÙŠØ¶Ø§Ù‹
        attachSearchListeners(); // âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
        
        // âœ… Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† query parameters (Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…)
        const urlParams = new URLSearchParams(window.location.search);
        const entityType = urlParams.get('entity_type');
        const entityId = urlParams.get('entity_id');
        const entityName = urlParams.get('entity_name');
        
        if (entityType && entityId && entityName) {
          console.log('ğŸ¯ Ù…Ù„Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ:', entityType, entityId, entityName);
          
          // ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
          if (entityTypeSelect) {
            entityTypeSelect.value = entityType;
            entityTypeSelect.dispatchEvent(new Event('change'));
          }
          
          // ØªØ£Ø®ÙŠØ± Ù‚Ù„ÙŠÙ„ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„
          setTimeout(function() {
            // Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù€ ID
            const searchField = document.getElementById(entityType.toLowerCase() + '_search');
            const idField = document.getElementById(entityType.toLowerCase() + '_id');
            
            if (searchField) {
              searchField.value = entityName;
              console.log('âœ… Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«:', entityName);
            }
            if (idField) {
              idField.value = entityId;
              console.log('âœ… ØªØ¹ÙŠÙŠÙ† ID:', entityId);
            }
          }, 200);
        }
      }, 100);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡
      const directionSelect = document.querySelector('select[name="direction"]');
      if (directionSelect) {
        directionSelect.addEventListener('change', validateDirection);
      }
      
      // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
      initPaymentMethodFields();
      
      // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©
      function addSplitRow() {

        const container = document.getElementById('splitsContainer');
        if (!container) {

          return;
        }

        const currentSplits = container.querySelectorAll('.split-form');
        const maxSplits = parseInt(container.getAttribute('data-max-splits')) || 3;

        if (currentSplits.length >= maxSplits) {
          alert('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© Ù‡Ùˆ ' + maxSplits);

          return;
        }
        
        const newIndex = currentSplits.length;

        const template = currentSplits[0].cloneNode(true);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø±Ø³
        template.setAttribute('data-index', newIndex);
        template.querySelector('h5').textContent = 'Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© #' + (newIndex + 1);
        
        // Ù…Ø³Ø­ Ø§Ù„Ù‚ÙŠÙ…
        template.querySelectorAll('input, select').forEach(function(input) {
          if (input.type === 'checkbox') {
            input.checked = false;
          } else {
            input.value = '';
          }
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
          const name = input.name;
          if (name) {
            input.name = name.replace(/splits-\d+/, 'splits-' + newIndex);
            input.id = input.id.replace(/splits-\d+/, 'splits-' + newIndex);
          }
        });
        
        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­Ø°Ù
        const removeBtn = template.querySelector('.remove-split');
        if (removeBtn) {
          removeBtn.disabled = false;
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        const details = template.querySelector('.split-details');
        if (details) {
          details.style.display = 'none';
        }
        
        container.appendChild(template);

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
        setTimeout(function() {
          initPaymentMethodFields();
          updateSplitSum();
        }, 100);
      }
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©
      const addSplitBtn = document.getElementById('addSplit');

      if (addSplitBtn) {
        addSplitBtn.addEventListener('click', addSplitRow);

      } else {

      }
      
      // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©
      function removeSplitRow(btn) {
        const container = document.getElementById('splitsContainer');
        if (!container) return;
        
        const currentSplits = container.querySelectorAll('.split-form');
        if (currentSplits.length <= 1) {
          alert('ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ù‚Ù‰ Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
          return;
        }
        
        const splitForm = btn.closest('.split-form');
        if (splitForm) {
          splitForm.remove();
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
          const remainingSplits = container.querySelectorAll('.split-form');
          remainingSplits.forEach(function(split, index) {
            split.setAttribute('data-index', index);
            split.querySelector('h5').textContent = 'Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© #' + (index + 1);
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
            split.querySelectorAll('input, select').forEach(function(input) {
              const name = input.name;
              if (name && name.includes('splits-')) {
                input.name = name.replace(/splits-\d+/, 'splits-' + index);
                input.id = input.id.replace(/splits-\d+/, 'splits-' + index);
              }
            });
          });
          
          updateSplitSum();
          initPaymentMethodFields();
        }
      }
      
      // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
      function updateSplitSum() {
        let sum = 0;
        document.querySelectorAll('.split-form input[name*="amount"]').forEach(function(input) {
          const val = parseFloat(input.value) || 0;
          sum += val;
        });
        
        const splitSumEl = document.getElementById('splitSum');
        if (splitSumEl) {
          const totalAmount = parseFloat(document.getElementById('total_amount')?.value) || 0;
          const diff = totalAmount - sum;
          
          if (Math.abs(diff) < 0.01) {
            splitSumEl.innerHTML = '<i class="fas fa-check-circle text-success"></i> Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©: <strong>' + sum.toFixed(2) + '</strong> (Ù…Ø·Ø§Ø¨Ù‚)';
            splitSumEl.className = 'form-text text-success';
          } else if (diff > 0) {
            splitSumEl.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª: <strong>' + sum.toFixed(2) + '</strong> | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <strong>' + diff.toFixed(2) + '</strong>';
            splitSumEl.className = 'form-text text-warning';
          } else {
            splitSumEl.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª: <strong>' + sum.toFixed(2) + '</strong> | Ø§Ù„Ø²ÙŠØ§Ø¯Ø©: <strong>' + Math.abs(diff).toFixed(2) + '</strong>';
            splitSumEl.className = 'form-text text-danger';
          }
        }
      }
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
      document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.includes('amount')) {
          updateSplitSum();
        }
      });
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
      const splitsContainer = document.getElementById('splitsContainer');
      if (splitsContainer) {
        splitsContainer.addEventListener('click', function(e) {
          if (e.target.classList.contains('remove-split')) {
            removeSplitRow(e.target);
          }
        });
      }
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      updateSplitSum();
    });
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    function initPaymentMethodFields() {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
      const splitMethodSelects = document.querySelectorAll('.split-method');
      
      splitMethodSelects.forEach(select => {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);
        
        updateMethodFields(newSelect);
        
        newSelect.addEventListener('change', function() {
          updateMethodFields(this);
        });
      });
    }
    
    function updateMethodFields(methodSelect) {
      const splitForm = methodSelect.closest('.split-form');
      if (!splitForm) return;
      
      const detailsContainer = splitForm.querySelector('.split-details');
      if (!detailsContainer) return;
      
      const selectedMethod = methodSelect.value.toUpperCase();
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
      const allDetailFields = detailsContainer.querySelectorAll('[data-field]');
      allDetailFields.forEach(field => {
        field.style.display = 'none';
      });
      const chequeInfo = detailsContainer.querySelector('[data-cheque-info]');
      if (chequeInfo) chequeInfo.style.display = 'none';
      
      // Ø¥Ø¸Ù‡Ø§Ø± detailsContainer ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© ØªØ­ØªØ§Ø¬ ØªÙØ§ØµÙŠÙ„
      const methodsWithDetails = ['CHECK', 'CHEQUE', 'BANK', 'BANK_TRANSFER', 'CARD', 'ONLINE'];
      const needsDetails = methodsWithDetails.some(m => selectedMethod.includes(m));
      
      if (needsDetails) {
        detailsContainer.style.display = 'block';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
        if (selectedMethod.includes('CHECK') || selectedMethod.includes('CHEQUE')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´ÙŠÙƒ
          const chequeInfo = detailsContainer.querySelector('[data-cheque-info]');
          if (chequeInfo) chequeInfo.style.display = 'block';
          showField(detailsContainer, 'check_number');
          showField(detailsContainer, 'check_bank');
          showField(detailsContainer, 'check_due_date');
        } else if (selectedMethod.includes('BANK')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ
          showField(detailsContainer, 'bank_transfer_ref');
        } else if (selectedMethod.includes('CARD')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
          showField(detailsContainer, 'card_number');
          showField(detailsContainer, 'card_holder');
          showField(detailsContainer, 'card_expiry');
        } else if (selectedMethod.includes('ONLINE')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          showField(detailsContainer, 'online_gateway');
          showField(detailsContainer, 'online_ref');
        }
      } else {
        detailsContainer.style.display = 'none';
      }
    }
    
    function showField(container, fieldName) {
      const field = container.querySelector(`[data-field="${fieldName}"]`);
      if (field) {
        field.style.display = 'block';
      }
    }
    
    function updateDirectionOptions() {
      const entityType = document.querySelector('select[name="entity_type"]').value;
      const directionSelect = document.querySelector('select[name="direction"]');
      
      if (!directionSelect) return;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      directionSelect.innerHTML = '';
      
      if (entityType === 'EXPENSE') {
        // Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØµØ§Ø¯Ø±Ø©
        directionSelect.innerHTML = '<option value="OUT">ØµØ§Ø¯Ø± (Ù…Ù†Ù†Ø§)</option>';
        directionSelect.value = 'OUT';
      } else {
        // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØ¯Ø¹Ù… ÙƒÙ„Ø§ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ÙŠÙ†
        directionSelect.innerHTML = `
          <option value="IN">ÙˆØ§Ø±Ø¯ (Ø¥Ù„ÙŠÙ†Ø§)</option>
          <option value="OUT">ØµØ§Ø¯Ø± (Ù…Ù†Ù†Ø§)</option>
        `;
      }
    }
    
    function validateDirection() {
      const entityType = document.querySelector('select[name="entity_type"]').value;
      const direction = document.querySelector('select[name="direction"]').value;
      
      if (entityType === 'EXPENSE' && direction !== 'OUT') {
        alert('Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØµØ§Ø¯Ø±Ø© ÙÙ‚Ø·');
        document.querySelector('select[name="direction"]').value = 'OUT';
      }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.entity-search-results') && !e.target.closest('input[name$="_search"]')) {
        const allResults = document.querySelectorAll('.entity-search-results');
        allResults.forEach(result => result.remove());
      }
    });
    
    // âœ… ØªØ£ÙƒÙŠØ¯ Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ - Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¹Ù‚Ø¯!
    const submitBtn = document.getElementById('submitPaymentBtn');
    const paymentForm = document.getElementById('paymentForm'); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ID Ù…Ø­Ø¯Ø¯
    
    if (submitBtn && paymentForm) {
      submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const direction = document.querySelector('select[name="direction"]')?.value || '';
        const directionText = direction === 'IN' ? 'ÙˆØ§Ø±Ø¯ (Ø¥Ù„ÙŠÙ†Ø§)' : direction === 'OUT' ? 'ØµØ§Ø¯Ø± (Ù…Ù†Ù†Ø§)' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const entityType = document.querySelector('select[name="entity_type"]')?.value || '';
        const currency = document.querySelector('select[name="currency"]')?.value || 'ILS';
        
        // âœ… Ø§Ù„Ù…Ø¨Ù„Øº = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ¹Ù„ÙŠ!)
        let totalAmount = 0;
        const splitAmounts = document.querySelectorAll('input[name^="splits-"][name$="-amount"]');
        splitAmounts.forEach(input => {
          totalAmount += parseFloat(input.value || 0);
        });
        
        // âœ… Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ø¬Ø²Ø¦ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… total_amount
        if (totalAmount === 0) {
          totalAmount = parseFloat(document.querySelector('input[name="total_amount"]')?.value || 0);
        }
        
        // Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©
        let entityName = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if (entityType === 'CUSTOMER') entityName = document.getElementById('customer_search')?.value || 'Ø¹Ù…ÙŠÙ„';
        else if (entityType === 'SUPPLIER') entityName = document.getElementById('supplier_search')?.value || 'Ù…ÙˆØ±Ø¯';
        else if (entityType === 'PARTNER') entityName = document.getElementById('partner_search')?.value || 'Ø´Ø±ÙŠÙƒ';
        else if (entityType === 'MISCELLANEOUS') entityName = 'Ù…ØªÙØ±Ù‚Ø§Øª';
        else if (entityType === 'OTHER') entityName = 'Ø£Ø®Ø±Ù‰';
        else if (entityType === 'EXPENSE') entityName = 'Ù…ØµØ±ÙˆÙ';
        else entityName = entityType;
        
        // âœ… Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¨Ø³ÙŠØ·Ø©
        const message = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ\n\n` +
                       `ğŸ“Œ Ø§Ù„Ø§ØªØ¬Ø§Ù‡: ${directionText}\n` +
                       `ğŸ‘¤ Ø§Ù„Ø¬Ù‡Ø©: ${entityName}\n` +
                       `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙØ¹Ù„ÙŠØ§Ù‹: ${totalAmount.toFixed(2)} ${currency}`;
        
        if (confirm(message)) {
          console.log('âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ - Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...');
          console.log('ğŸ“¤ Form action:', paymentForm.action);
          console.log('ğŸ“¤ Form method:', paymentForm.method);
          paymentForm.submit();
        } else {
          console.log('âŒ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
        }
      });
    } else {
      console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ submitBtn Ø£Ùˆ paymentForm!');
    }
  </script>
  
  <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù JavaScript Ù„Ù„Ø¯ÙØ¹Ø§Øª -->
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>

  <!-- Archive Modal -->
  {% if payment %}
  <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="archiveModalLabel">
            <i class="fas fa-archive"></i> Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>ØªØ­Ø°ÙŠØ±:</strong> Ø³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©. ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ.
          </div>
          
          <div class="mb-3">
            <label for="archiveReason" class="form-label">Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø±Ø´ÙØ©:</label>
            <textarea class="form-control" id="archiveReason" name="reason" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø£Ø±Ø´ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©..."></textarea>
          </div>
          
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="mb-0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø£Ø±Ø´ÙØªÙ‡Ø§:</h6>
            </div>
            <div class="card-body">
              <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©:</strong> {{ payment.payment_number }}</p>
              <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ payment.total_amount }} {{ payment.currency }}</p>
              <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
              <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> {{ payment.status }}</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
          </button>
          <form method="POST" action="{{ url_for('payments.archive_payment', payment_id=payment.id) }}" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="reason" id="hiddenReason">
            <button type="submit" class="btn btn-warning" onclick="document.getElementById('hiddenReason').value = document.getElementById('archiveReason').value;">
              <i class="fas fa-archive"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£Ø±Ø´ÙØ©
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}
