{% extends "base.html" %}
{% block title %}{{ payment and 'تعديل دفعة' or 'إنشاء دفعة' }}{% endblock %}
{% block content %}

<div class="container mt-4">
  <h3 class="mb-4">
    {% if payment %}
      تعديل دفعة #{{ payment.id }}
    {% else %}
      إضافة دفعة جديدة
    {% endif %}
  </h3>

  {% if entity_info %}
  <div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">معلومات مرتبطة</h5>
    </div>
    <div class="card-body">
      <div class="row gy-2">
        {% if entity_info.number %}
          <div class="col-md-4"><strong>الرقم:</strong> {{ entity_info.number }}</div>
          {% if entity_info.date %}
            <div class="col-md-4"><strong>التاريخ:</strong> {{ entity_info.date }}</div>
          {% endif %}
          {% if entity_info.total is defined %}
            <div class="col-md-4"><strong>الإجمالي:</strong> {{ '%.0f'|format(entity_info.total) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.paid is defined %}
            <div class="col-md-4"><strong>المدفوع:</strong> {{ '%.0f'|format(entity_info.paid) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance is defined %}
            <div class="col-md-4"><strong>المتبقي:</strong> {{ '%.0f'|format(entity_info.balance) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance_due is defined %}
            <div class="col-md-4"><strong>المتبقي:</strong> {{ '%.0f'|format(entity_info.balance_due) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.amount is defined and not entity_info.total %}
            <div class="col-md-4"><strong>المبلغ:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
          {% endif %}
        {% elif entity_info.name %}
          <div class="col-md-6"><strong>الاسم:</strong> {{ entity_info.name }}</div>
          {% if entity_info.balance is defined %}
            <div class="col-md-6"><strong>الرصيد:</strong> {{ '%.0f'|format(entity_info.balance) }}</div>
          {% endif %}
        {% elif entity_info.type == 'expense' %}
          <div class="col-md-4"><strong>رقم المصروف:</strong> {{ entity_info.number }}</div>
          <div class="col-md-4"><strong>التاريخ:</strong> {{ entity_info.date }}</div>
          <div class="col-md-4"><strong>القيمة:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
        {% endif %}
        {% if entity_info.type_name %}
          <div class="col-md-4"><strong>نوع المصروف:</strong> {{ entity_info.type_name }}</div>
        {% endif %}
        {% if entity_info.employee_name %}
          <div class="col-md-4"><strong>الموظّف:</strong> {{ entity_info.employee_name }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <form method="POST" id="paymentForm" action="{{ url_for('payments.create_payment') }}" autocomplete="off">
    {{ form.hidden_tag() }}
    {% if form.request_token is not none %}
      {{ form.request_token }}
    {% endif %}

    <div class="row">
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">المعلومات الأساسية</div>
          <div class="card-body">
            {% for field in [form.entity_type, form.direction, form.status, form.payment_date, form.total_amount, form.currency, form.method, form.reference, form.receipt_number, form.notes] %}
              {% if field is not none %}
              <div class="mb-3">
                {{ field.label(class="form-label") }}
                {% if field.type in ["SelectField", "QuerySelectField"] %}
                  {{ field(class="form-select") }}
                {% elif field.name == "payment_date" %}
                  {% set _pd = field.data %}
                  {% set _val = (_pd if _pd is string else (_pd.strftime("%Y-%m-%dT%H:%M") if _pd else "")) %}
                  {{ field(type="datetime-local", class="form-control", value=_val) }}
                {% elif field.type == "TextAreaField" %}
                  {{ field(class="form-control") }}
                {% else %}
                  {% if field.name == "total_amount" %}
                    {{ field(class="form-control", step="1", min="0") }}
                  {% else %}
                    {{ field(class="form-control") }}
                  {% endif %}
                {% endif %}
                {% if field.name == 'total_amount' %}
                  <div id="splitSum" class="form-text"></div>
                {% endif %}
                {% for e in field.errors %}
                  <div class="text-danger small">{{ e }}</div>
                {% endfor %}
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">الجهة المرتبطة</div>
          <div class="card-body" id="entityFields">
            {% include "payments/_entity_fields.html" %}
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>الدفعات الجزئية</span>
        <small class="text-muted">بحد أقصى 3 طرق دفع</small>
      </div>
      <div class="card-body">
        {% if form.splits and form.splits.errors %}
          <div class="alert alert-danger py-2">
            {% for err in form.splits.errors %}
              <div>• {{ err }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div id="splitsContainer" data-max-splits="3">
          {% for split in form.splits %}
          <div class="split-form border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
            <h5>الدفعة الجزئية #{{ loop.index }}</h5>

            <div class="row gy-2">
              <div class="col-md-4">
                {{ split.method.label(class="form-label") }}
                {{ split.method(class="form-select split-method") }}
                {% for e in split.method.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4">
                {{ split.amount.label(class="form-label") }}
                {{ split.amount(class="form-control", step="1", min="0") }}
                {% for e in split.amount.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-danger remove-split" {% if loop.first %}disabled{% endif %}>حذف</button>
              </div>
            </div>

            {% set _detail_fields = [
              'check_number','check_bank','check_due_date',
              'bank_transfer_ref',
              'card_number','card_holder','card_expiry',
              'online_gateway','online_ref'
            ] %}

            <div class="split-details mt-3" style="display:none;">
              <div class="row gy-2">
                {% for fname in _detail_fields %}
                  {% set field = split|attr(fname) %}
                  {% if field is not none %}
                  <div class="col-md-4" data-field="{{ fname }}">
                    {{ field.label(class="form-label") }}
                    {% if fname == 'check_due_date' %}
                      {{ field(type="date", class="form-control") }}
                    {% else %}
                      {{ field(class="form-control") }}
                    {% endif %}
                    {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <button type="button" id="addSplit" class="btn btn-secondary">+ إضافة دفعة جزئية</button>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-success btn-lg">حفظ الدفعة</button>
      <a href="{{ url_for('payments.index') }}" class="btn btn-outline-secondary">إلغاء</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/payment_form.js') }}"></script>
{% endblock %}
