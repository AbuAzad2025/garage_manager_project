{% extends "base.html" %}
{% block title %}{{ payment and 'تعديل دفعة' or 'إنشاء دفعة' }}{% endblock %}

{% block head_extra %}
<style>
/* تحسين تباين الألوان والتصميم */
.payment-form-card {
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    border: none;
}

.payment-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.form-label {
    color: #343a40 !important;
    font-weight: 600 !important;
    margin-bottom: 8px !important;
    font-size: 0.9rem;
}

.form-control, .form-select {
    border: 2px solid #e0e0e0 !important;
    border-radius: 8px !important;
    padding: 10px 15px !important;
    transition: all 0.3s !important;
    color: #343a40 !important;
    font-weight: 500 !important;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 600 !important;
    border-radius: 12px 12px 0 0 !important;
    padding: 15px 20px !important;
}

.split-form {
    background: #f8f9fa;
    border: 2px solid #dee2e6 !important;
    border-radius: 12px !important;
    padding: 20px !important;
    margin-bottom: 15px !important;
}

.split-form h5 {
    color: #667eea !important;
    font-weight: 700 !important;
    margin-bottom: 15px !important;
}

.btn-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
    border: none !important;
    font-weight: 600 !important;
    padding: 12px 30px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
}

.btn-success:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 12px rgba(0,0,0,0.15) !important;
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%) !important;
    border: none !important;
    font-weight: 600 !important;
}

.btn-secondary {
    background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%) !important;
    border: none !important;
    font-weight: 600 !important;
}

.entity-info-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #2196f3;
    border-radius: 12px;
}

.entity-info-card .card-header {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%) !important;
}

#splitSum {
    color: #667eea !important;
    font-weight: 600 !important;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-money-bill-wave"></i>
                        {% if payment %}
                            تعديل دفعة #{{ payment.id }}
                        {% else %}
                            إنشاء دفعة جديدة
                        {% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('payments.index') }}">الدفعات</a></li>
                        <li class="breadcrumb-item active">{{ payment and 'تعديل' or 'إنشاء' }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">

  {% if entity_info %}
  <div class="card mb-4 entity-info-card">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-info-circle"></i> معلومات مرتبطة</h5>
    </div>
    <div class="card-body">
      <div class="row gy-3">
        {% if entity_info.number %}
          <div class="col-md-4"><strong>الرقم:</strong> {{ entity_info.number }}</div>
          {% if entity_info.date %}
            <div class="col-md-4"><strong>التاريخ:</strong> {{ entity_info.date }}</div>
          {% endif %}
          {% if entity_info.total is defined %}
            <div class="col-md-4"><strong>الإجمالي:</strong> {{ '%.0f'|format(entity_info.total) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.paid is defined %}
            <div class="col-md-4"><strong>المدفوع:</strong> {{ '%.0f'|format(entity_info.paid) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance is defined %}
            <div class="col-md-4"><strong>المتبقي:</strong> {{ '%.0f'|format(entity_info.balance) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance_due is defined %}
            <div class="col-md-4"><strong>المتبقي:</strong> {{ '%.0f'|format(entity_info.balance_due) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.amount is defined and not entity_info.total %}
            <div class="col-md-4"><strong>المبلغ:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
          {% endif %}
        {% elif entity_info.name %}
          <div class="col-md-6"><strong>الاسم:</strong> {{ entity_info.name }}</div>
          {% if entity_info.balance is defined %}
            <div class="col-md-6"><strong>الرصيد:</strong> {{ '%.0f'|format(entity_info.balance) }}</div>
          {% endif %}
        {% elif entity_info.type == 'expense' %}
          <div class="col-md-4"><strong>رقم المصروف:</strong> {{ entity_info.number }}</div>
          <div class="col-md-4"><strong>التاريخ:</strong> {{ entity_info.date }}</div>
          <div class="col-md-4"><strong>القيمة:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
        {% endif %}
        {% if entity_info.type_name %}
          <div class="col-md-4"><strong>نوع المصروف:</strong> {{ entity_info.type_name }}</div>
        {% endif %}
        {% if entity_info.employee_name %}
          <div class="col-md-4"><strong>الموظّف:</strong> {{ entity_info.employee_name }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <form method="POST" id="paymentForm" action="{{ url_for('payments.create_payment') }}" autocomplete="off">
    {{ form.hidden_tag() }}
    {% if form.request_token is not none %}
      {{ form.request_token }}
    {% endif %}

    <div class="row">
      <div class="col-md-6">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-file-invoice-dollar"></i> المعلومات الأساسية
          </div>
          <div class="card-body">
            {% for field in [form.entity_type, form.direction, form.status, form.payment_date, form.total_amount, form.currency, form.method, form.reference, form.receipt_number, form.notes] %}
              {% if field is not none %}
              <div class="mb-3">
                {{ field.label(class="form-label") }}
                {% if field.type in ["SelectField", "QuerySelectField"] %}
                  {{ field(class="form-select") }}
                {% elif field.name == "payment_date" %}
                  {% set _pd = field.data %}
                  {% set _val = (_pd if _pd is string else (_pd.strftime("%Y-%m-%dT%H:%M") if _pd else "")) %}
                  {{ field(type="datetime-local", class="form-control", value=_val) }}
                {% elif field.type == "TextAreaField" %}
                  {{ field(class="form-control") }}
                {% else %}
                  {% if field.name == "total_amount" %}
                    {{ field(class="form-control", step="1", min="0") }}
                  {% else %}
                    {{ field(class="form-control") }}
                  {% endif %}
                {% endif %}
                {% if field.name == 'total_amount' %}
                  <div id="splitSum" class="form-text"></div>
                {% endif %}
                {% for e in field.errors %}
                  <div class="text-danger small">{{ e }}</div>
                {% endfor %}
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-user-tie"></i> الجهة المرتبطة
          </div>
          <div class="card-body" id="entityFields">
            {% include "payments/_entity_fields.html" %}
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4 payment-form-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-layer-group"></i> الدفعات الجزئية</span>
        <small class="badge badge-info">بحد أقصى 3 طرق دفع</small>
      </div>
      <div class="card-body">
        {% if form.splits and form.splits.errors %}
          <div class="alert alert-danger py-2">
            {% for err in form.splits.errors %}
              <div>• {{ err }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div id="splitsContainer" data-max-splits="3">
          {% for split in form.splits %}
          <div class="split-form border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
            <h5>الدفعة الجزئية #{{ loop.index }}</h5>

            <div class="row gy-2">
              <div class="col-md-4">
                {{ split.method.label(class="form-label") }}
                {{ split.method(class="form-select split-method") }}
                {% for e in split.method.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4">
                {{ split.amount.label(class="form-label") }}
                {{ split.amount(class="form-control", step="1", min="0") }}
                {% for e in split.amount.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-danger remove-split" {% if loop.first %}disabled{% endif %}>حذف</button>
              </div>
            </div>

            {% set _detail_fields = [
              'check_number','check_bank','check_due_date',
              'bank_transfer_ref',
              'card_number','card_holder','card_expiry',
              'online_gateway','online_ref'
            ] %}

            <div class="split-details mt-3" style="display:none;">
              <div class="alert alert-info mb-2" style="display:none;" data-cheque-info>
                <i class="fas fa-money-check-alt"></i> <strong>معلومات الشيك:</strong> يرجى ملء جميع البيانات بدقة
              </div>
              <div class="row gy-2">
                {% for fname in _detail_fields %}
                  {% set field = split|attr(fname) %}
                  {% if field is not none %}
                  <div class="col-md-4" data-field="{{ fname }}">
                    <label class="form-label">
                      {% if fname == 'check_number' %}<i class="fas fa-hashtag text-primary"></i>{% endif %}
                      {% if fname == 'check_bank' %}<i class="fas fa-university text-info"></i>{% endif %}
                      {% if fname == 'check_due_date' %}<i class="fas fa-calendar-alt text-warning"></i>{% endif %}
                      {{ field.label.text }}
                    </label>
                    {% if fname == 'check_due_date' %}
                      {{ field(type="date", class="form-control") }}
                    {% else %}
                      {{ field(class="form-control") }}
                    {% endif %}
                    {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <button type="button" id="addSplit" class="btn btn-secondary">+ إضافة دفعة جزئية</button>
      </div>
    </div>

    <div class="card payment-form-card">
      <div class="card-body text-center">
        <button type="submit" class="btn btn-success btn-lg">
          <i class="fas fa-save"></i> حفظ الدفعة
        </button>
        {% if payment %}
        <button type="button" class="btn btn-warning btn-lg" data-toggle="modal" data-target="#archiveModal">
          <i class="fas fa-archive"></i> أرشفة الدفعة
        </button>
        {% endif %}
        <a href="{{ url_for('payments.index') }}" class="btn btn-secondary btn-lg">
          <i class="fas fa-times"></i> إلغاء
        </a>
      </div>
    </div>
  </form>

        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/payment_form.js') }}"></script>
  
  <script>
    // الفلاتر الذكية للجهات
    let searchTimeout = {};
    
    function searchEntities(entityType, searchTerm) {
      if (!searchTerm || searchTerm.length < 2) {
        hideEntityResults(entityType);
        return;
      }
      
      clearTimeout(searchTimeout[entityType]);
      searchTimeout[entityType] = setTimeout(() => {
        fetch(`/payments/api/entities/${entityType}?search=${encodeURIComponent(searchTerm)}`)
          .then(response => {
            if (response.status === 302 || response.status === 401) {
              // المستخدم لم يسجل دخول بعد
              hideEntityResults(entityType);
              return;
            }
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              showEntityResults(entityType, data);
            }
          })
          .catch(error => {
            console.error('خطأ في البحث:', error);
            // إظهار رسالة خطأ للمستخدم
            const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
            if (searchField) {
              searchField.style.borderColor = '#dc3545';
              setTimeout(() => {
                searchField.style.borderColor = '';
              }, 3000);
            }
          });
      }, 300);
    }
    
    function showEntityResults(entityType, entities) {
      const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
      if (!searchField) return;
      
      // إزالة النتائج السابقة
      hideEntityResults(entityType);
      
      if (entities.length === 0) {
        return;
      }
      
      // إنشاء قائمة النتائج
      const resultsDiv = document.createElement('div');
      resultsDiv.className = 'entity-search-results';
      resultsDiv.id = `${entityType.toLowerCase()}_results`;
      resultsDiv.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      `;
      
      entities.forEach(entity => {
        const item = document.createElement('div');
        item.className = 'entity-result-item';
        item.style.cssText = `
          padding: 8px 12px;
          cursor: pointer;
          border-bottom: 1px solid #eee;
        `;
        item.innerHTML = `
          <div class="fw-bold">${entity.name || entity.display}</div>
          ${entity.phone ? `<small class="text-muted">${entity.phone}</small>` : ''}
          ${entity.email ? `<small class="text-muted">${entity.email}</small>` : ''}
        `;
        
        item.addEventListener('click', () => {
          selectEntity(entityType, entity);
        });
        
        item.addEventListener('mouseenter', () => {
          item.style.backgroundColor = '#f8f9fa';
        });
        
        item.addEventListener('mouseleave', () => {
          item.style.backgroundColor = 'white';
        });
        
        resultsDiv.appendChild(item);
      });
      
      // إدراج النتائج
      searchField.parentNode.style.position = 'relative';
      searchField.parentNode.appendChild(resultsDiv);
    }
    
    function hideEntityResults(entityType) {
      const resultsDiv = document.getElementById(`${entityType.toLowerCase()}_results`);
      if (resultsDiv) {
        resultsDiv.remove();
      }
    }
    
    function selectEntity(entityType, entity) {
      const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
      const hiddenField = document.querySelector(`input[name="${entityType.toLowerCase()}_id"]`);
      const entityIdField = document.querySelector(`input[name="entity_id"]`);
      
      if (searchField && hiddenField) {
        searchField.value = entity.name || entity.display;
        hiddenField.value = entity.id;
        
        // تحديث entity_id أيضاً
        if (entityIdField) {
          entityIdField.value = entity.id;
        }
        
        // إخفاء النتائج
        hideEntityResults(entityType);
        
        // تحديث النموذج
        updateEntityFields();
        
        // جلب الجهة المرتبطة (العميل/المورد) للفواتير والصيانة والشحنات
        if (['SALE', 'INVOICE', 'PREORDER', 'SERVICE', 'SHIPMENT'].includes(entityType.toUpperCase())) {
          fetchRelatedParty(entityType, entity.id);
        }
      }
    }
    
    // دالة جلب الجهة المرتبطة (العميل أو المورد)
    function fetchRelatedParty(entityType, entityId) {
      fetch(`/payments/api/related-party?entity_type=${entityType}&entity_id=${entityId}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.success) {
            // ملء حقل العميل المرتبط
            if (data.customer_id && data.customer_name) {
              const customerSearchField = document.getElementById('customer_search');
              const customerIdField = document.getElementById('customer_id');
              if (customerSearchField) customerSearchField.value = data.customer_name;
              if (customerIdField) customerIdField.value = data.customer_id;
            }
            
            // ملء حقل المورد المرتبط
            if (data.supplier_id && data.supplier_name) {
              const supplierSearchField = document.getElementById('supplier_search');
              const supplierIdField = document.getElementById('supplier_id');
              if (supplierSearchField) supplierSearchField.value = data.supplier_name;
              if (supplierIdField) supplierIdField.value = data.supplier_id;
            }
          }
        })
        .catch(error => {
          console.error('خطأ في جلب الجهة المرتبطة:', error);
        });
    }
    
    function updateEntityFields() {
      const entityType = document.querySelector('select[name="entity_type"]');
      if (!entityType) return;
      
      const selectedType = entityType.value;
      const entityFieldsContainer = document.getElementById('entityFields');
      
      if (!selectedType) {
        entityFieldsContainer.innerHTML = '<div class="text-muted">اختر نوع الجهة لرؤية الحقول المناسبة</div>';
        return;
      }
      
      // إظهار مؤشر التحميل
      entityFieldsContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري تحميل الحقول...</div>';
      
      // جلب الحقول المناسبة عبر AJAX
      fetch(`/payments/entity-fields?type=${selectedType.toLowerCase()}`)
        .then(response => {
          if (response.status === 302 || response.status === 401) {
            // المستخدم لم يسجل دخول بعد
            entityFieldsContainer.innerHTML = '<div class="alert alert-warning">يجب تسجيل الدخول أولاً</div>';
            return;
          }
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          if (html) {
            entityFieldsContainer.innerHTML = html;
            
            // تحديث الفلاتر الذكية للحقول الجديدة
            updateSmartFilters(selectedType);
          }
        })
        .catch(error => {
          console.error('خطأ في تحميل الحقول:', error);
          entityFieldsContainer.innerHTML = '<div class="alert alert-danger">خطأ في تحميل الحقول: ' + error.message + '</div>';
        });
    }
    
    function updateSmartFilters(entityType) {
      // تحديث الفلاتر الذكية حسب نوع الجهة
      const searchFields = document.querySelectorAll('input[name$="_search"]');
      searchFields.forEach(field => {
        const fieldName = field.name;
        const expectedEntityType = fieldName.replace('_search', '').toUpperCase();
        
        if (expectedEntityType === entityType) {
          // إزالة المستمعين السابقين
          field.removeEventListener('keyup', searchEntities);
          
          // تفعيل البحث الذكي لهذا الحقل
          field.addEventListener('keyup', function() {
            searchEntities(entityType, this.value);
          });
        }
      });
    }
    
    // دالة تحديث حقول الجهة حسب النوع المختار
    function updateEntityFields() {
      const entityTypeSelect = document.querySelector('select[name="entity_type"]');
      if (!entityTypeSelect) {
        console.log('⚠️ لم يتم العثور على حقل entity_type');
        return;
      }
      
      const selectedType = entityTypeSelect.value.toLowerCase();
      console.log('✅ نوع الجهة المختار:', selectedType);
      
      const entityFieldsContainer = document.getElementById('entityFields');
      if (!entityFieldsContainer) {
        console.log('⚠️ لم يتم العثور على entityFields container');
        return;
      }
      
      // إخفاء جميع الحقول أولاً
      const allContainers = entityFieldsContainer.querySelectorAll('.entity-field-container');
      console.log('📦 عدد الحاويات الموجودة:', allContainers.length);
      
      allContainers.forEach(container => {
        container.style.display = 'none';
        console.log('🔒 إخفاء حاوية:', container.getAttribute('data-entity-type'));
      });
      
      // إظهار الحقول المناسبة
      const targetContainer = entityFieldsContainer.querySelector(`[data-entity-type="${selectedType}"]`);
      if (targetContainer) {
        targetContainer.style.display = 'block';
        console.log('✅ إظهار حاوية:', selectedType);
      } else {
        console.log('⚠️ لم يتم العثور على حاوية لنوع:', selectedType);
        
        // محاولة البحث بدون toLowerCase
        const allTypes = Array.from(allContainers).map(c => c.getAttribute('data-entity-type'));
        console.log('📋 الأنواع المتاحة:', allTypes);
      }
      
      // إعادة تهيئة البحث الذكي للحقول الجديدة
      setTimeout(function() {
        if (typeof initSmartSearch === 'function') {
          smartSearchInitialized = false;
          initSmartSearch();
        }
      }, 100);
    }
    
    // تهيئة الحقول عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      // إضافة مستمع لتغيير نوع الجهة
      const entityTypeSelect = document.querySelector('select[name="entity_type"]');
      if (entityTypeSelect) {
        entityTypeSelect.addEventListener('change', function() {
          updateEntityFields();
          // تحديث خيارات الاتجاه حسب نوع الجهة
          updateDirectionOptions();
        });
        
      // تحديث الحقول عند التحميل الأولي
      setTimeout(function() {
        updateEntityFields();
        updateDirectionOptions(); // تحديث خيارات الاتجاه أيضاً
      }, 100);
      }
      
      // إضافة مستمع لتغيير الاتجاه
      const directionSelect = document.querySelector('select[name="direction"]');
      if (directionSelect) {
        directionSelect.addEventListener('change', validateDirection);
      }
      
      // تهيئة حقول طرق الدفع الديناميكية
      initPaymentMethodFields();
      
      // دالة إضافة دفعة جزئية
      function addSplitRow() {
        console.log('🔵 زر إضافة دفعة جزئية تم الضغط عليه');
        const container = document.getElementById('splitsContainer');
        if (!container) {
          console.error('❌ لم يتم العثور على splitsContainer');
          return;
        }
        console.log('✅ splitsContainer موجود');
        
        const currentSplits = container.querySelectorAll('.split-form');
        const maxSplits = parseInt(container.getAttribute('data-max-splits')) || 3;
        
        console.log('📊 عدد الدفعات الحالية:', currentSplits.length, '| الحد الأقصى:', maxSplits);
        
        if (currentSplits.length >= maxSplits) {
          alert('الحد الأقصى للدفعات الجزئية هو ' + maxSplits);
          console.warn('⚠️ تم الوصول للحد الأقصى');
          return;
        }
        
        const newIndex = currentSplits.length;
        console.log('➕ إضافة دفعة جزئية جديدة - الفهرس:', newIndex);
        const template = currentSplits[0].cloneNode(true);
        
        // تحديث الفهرس
        template.setAttribute('data-index', newIndex);
        template.querySelector('h5').textContent = 'الدفعة الجزئية #' + (newIndex + 1);
        
        // مسح القيم
        template.querySelectorAll('input, select').forEach(function(input) {
          if (input.type === 'checkbox') {
            input.checked = false;
          } else {
            input.value = '';
          }
          // تحديث الأسماء
          const name = input.name;
          if (name) {
            input.name = name.replace(/splits-\d+/, 'splits-' + newIndex);
            input.id = input.id.replace(/splits-\d+/, 'splits-' + newIndex);
          }
        });
        
        // تفعيل زر الحذف
        const removeBtn = template.querySelector('.remove-split');
        if (removeBtn) {
          removeBtn.disabled = false;
        }
        
        // إخفاء التفاصيل
        const details = template.querySelector('.split-details');
        if (details) {
          details.style.display = 'none';
        }
        
        container.appendChild(template);
        console.log('✅ تم إضافة الدفعة الجزئية بنجاح');
        
        // إعادة تهيئة الحقول
        setTimeout(function() {
          initPaymentMethodFields();
          updateSplitSum();
        }, 100);
      }
      
      // مراقبة زر إضافة دفعة جزئية
      const addSplitBtn = document.getElementById('addSplit');
      console.log('🔍 البحث عن زر addSplit:', addSplitBtn ? 'موجود ✅' : 'غير موجود ❌');
      
      if (addSplitBtn) {
        addSplitBtn.addEventListener('click', addSplitRow);
        console.log('✅ تم ربط الزر بالدالة addSplitRow');
      } else {
        console.error('❌ زر addSplit غير موجود في الصفحة!');
      }
      
      // دالة حذف دفعة جزئية
      function removeSplitRow(btn) {
        const container = document.getElementById('splitsContainer');
        if (!container) return;
        
        const currentSplits = container.querySelectorAll('.split-form');
        if (currentSplits.length <= 1) {
          alert('يجب أن تبقى دفعة جزئية واحدة على الأقل');
          return;
        }
        
        const splitForm = btn.closest('.split-form');
        if (splitForm) {
          splitForm.remove();
          
          // إعادة ترقيم الدفعات المتبقية
          const remainingSplits = container.querySelectorAll('.split-form');
          remainingSplits.forEach(function(split, index) {
            split.setAttribute('data-index', index);
            split.querySelector('h5').textContent = 'الدفعة الجزئية #' + (index + 1);
            
            // تحديث أسماء الحقول
            split.querySelectorAll('input, select').forEach(function(input) {
              const name = input.name;
              if (name && name.includes('splits-')) {
                input.name = name.replace(/splits-\d+/, 'splits-' + index);
                input.id = input.id.replace(/splits-\d+/, 'splits-' + index);
              }
            });
          });
          
          updateSplitSum();
          initPaymentMethodFields();
        }
      }
      
      // دالة حساب مجموع الدفعات الجزئية
      function updateSplitSum() {
        let sum = 0;
        document.querySelectorAll('.split-form input[name*="amount"]').forEach(function(input) {
          const val = parseFloat(input.value) || 0;
          sum += val;
        });
        
        const splitSumEl = document.getElementById('splitSum');
        if (splitSumEl) {
          const totalAmount = parseFloat(document.getElementById('total_amount')?.value) || 0;
          const diff = totalAmount - sum;
          
          if (Math.abs(diff) < 0.01) {
            splitSumEl.innerHTML = '<i class="fas fa-check-circle text-success"></i> مجموع الدفعات الجزئية: <strong>' + sum.toFixed(2) + '</strong> (مطابق)';
            splitSumEl.className = 'form-text text-success';
          } else if (diff > 0) {
            splitSumEl.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> مجموع الدفعات: <strong>' + sum.toFixed(2) + '</strong> | المتبقي: <strong>' + diff.toFixed(2) + '</strong>';
            splitSumEl.className = 'form-text text-warning';
          } else {
            splitSumEl.innerHTML = '<i class="fas fa-times-circle text-danger"></i> مجموع الدفعات: <strong>' + sum.toFixed(2) + '</strong> | الزيادة: <strong>' + Math.abs(diff).toFixed(2) + '</strong>';
            splitSumEl.className = 'form-text text-danger';
          }
        }
      }
      
      // مراقبة التغييرات في مبالغ الدفعات الجزئية
      document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.includes('amount')) {
          updateSplitSum();
        }
      });
      
      // مراقبة أزرار حذف الدفعة الجزئية
      const splitsContainer = document.getElementById('splitsContainer');
      if (splitsContainer) {
        splitsContainer.addEventListener('click', function(e) {
          if (e.target.classList.contains('remove-split')) {
            removeSplitRow(e.target);
          }
        });
      }
      
      // حساب المجموع عند التحميل
      updateSplitSum();
    });
    
    // دالة لإظهار/إخفاء حقول طرق الدفع حسب الطريقة المختارة
    function initPaymentMethodFields() {
      // البحث عن جميع حقول طرق الدفع في الدفعات الجزئية
      const splitMethodSelects = document.querySelectorAll('.split-method');
      
      splitMethodSelects.forEach(select => {
        // إزالة مستمع الحدث القديم إن وجد
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);
        
        updateMethodFields(newSelect);
        
        newSelect.addEventListener('change', function() {
          updateMethodFields(this);
        });
      });
    }
    
    function updateMethodFields(methodSelect) {
      const splitForm = methodSelect.closest('.split-form');
      if (!splitForm) return;
      
      const detailsContainer = splitForm.querySelector('.split-details');
      if (!detailsContainer) return;
      
      const selectedMethod = methodSelect.value.toUpperCase();
      
      // إخفاء جميع الحقول والتنبيهات أولاً
      const allDetailFields = detailsContainer.querySelectorAll('[data-field]');
      allDetailFields.forEach(field => {
        field.style.display = 'none';
      });
      const chequeInfo = detailsContainer.querySelector('[data-cheque-info]');
      if (chequeInfo) chequeInfo.style.display = 'none';
      
      // إظهار detailsContainer فقط إذا كانت الطريقة تحتاج تفاصيل
      const methodsWithDetails = ['CHECK', 'CHEQUE', 'BANK', 'BANK_TRANSFER', 'CARD', 'ONLINE'];
      const needsDetails = methodsWithDetails.some(m => selectedMethod.includes(m));
      
      if (needsDetails) {
        detailsContainer.style.display = 'block';
        
        // إظهار الحقول المناسبة حسب الطريقة
        if (selectedMethod.includes('CHECK') || selectedMethod.includes('CHEQUE')) {
          // حقول الشيك
          const chequeInfo = detailsContainer.querySelector('[data-cheque-info]');
          if (chequeInfo) chequeInfo.style.display = 'block';
          showField(detailsContainer, 'check_number');
          showField(detailsContainer, 'check_bank');
          showField(detailsContainer, 'check_due_date');
        } else if (selectedMethod.includes('BANK')) {
          // حقول التحويل البنكي
          showField(detailsContainer, 'bank_transfer_ref');
        } else if (selectedMethod.includes('CARD')) {
          // حقول البطاقة
          showField(detailsContainer, 'card_number');
          showField(detailsContainer, 'card_holder');
          showField(detailsContainer, 'card_expiry');
        } else if (selectedMethod.includes('ONLINE')) {
          // حقول الدفع الإلكتروني
          showField(detailsContainer, 'online_gateway');
          showField(detailsContainer, 'online_ref');
        }
      } else {
        detailsContainer.style.display = 'none';
      }
    }
    
    function showField(container, fieldName) {
      const field = container.querySelector(`[data-field="${fieldName}"]`);
      if (field) {
        field.style.display = 'block';
      }
    }
    
    function updateDirectionOptions() {
      const entityType = document.querySelector('select[name="entity_type"]').value;
      const directionSelect = document.querySelector('select[name="direction"]');
      
      if (!directionSelect) return;
      
      // إزالة الخيارات الحالية
      directionSelect.innerHTML = '';
      
      if (entityType === 'EXPENSE') {
        // المصاريف دائماً صادرة
        directionSelect.innerHTML = '<option value="OUT">صادر (مننا)</option>';
        directionSelect.value = 'OUT';
      } else {
        // جميع الجهات الأخرى تدعم كلا الاتجاهين
        directionSelect.innerHTML = `
          <option value="IN">وارد (إلينا)</option>
          <option value="OUT">صادر (مننا)</option>
        `;
      }
    }
    
    function validateDirection() {
      const entityType = document.querySelector('select[name="entity_type"]').value;
      const direction = document.querySelector('select[name="direction"]').value;
      
      if (entityType === 'EXPENSE' && direction !== 'OUT') {
        alert('المصاريف يجب أن تكون صادرة فقط');
        document.querySelector('select[name="direction"]').value = 'OUT';
      }
    }
    
    // إخفاء النتائج عند النقر خارجها
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.entity-search-results') && !e.target.closest('input[name$="_search"]')) {
        const allResults = document.querySelectorAll('.entity-search-results');
        allResults.forEach(result => result.remove());
      }
    });
  </script>
  
  <!-- تحميل ملف JavaScript للدفعات -->
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>

  <!-- Archive Modal -->
  {% if payment %}
  <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="archiveModalLabel">
            <i class="fas fa-archive"></i> أرشفة الدفعة
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>تحذير:</strong> سيتم أرشفة هذه الدفعة وحذفها من القائمة الرئيسية. يمكن استعادتها لاحقاً من الأرشيف.
          </div>
          
          <div class="mb-3">
            <label for="archiveReason" class="form-label">سبب الأرشفة:</label>
            <textarea class="form-control" id="archiveReason" name="reason" rows="3" placeholder="أدخل سبب أرشفة هذه الدفعة..."></textarea>
          </div>
          
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="mb-0">تفاصيل الدفعة المراد أرشفتها:</h6>
            </div>
            <div class="card-body">
              <p><strong>رقم الدفعة:</strong> {{ payment.payment_number }}</p>
              <p><strong>المبلغ:</strong> {{ payment.total_amount }} {{ payment.currency }}</p>
              <p><strong>التاريخ:</strong> {{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else 'غير محدد' }}</p>
              <p><strong>الحالة:</strong> {{ payment.status }}</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> إلغاء
          </button>
          <form method="POST" action="{{ url_for('payments.archive_payment', payment_id=payment.id) }}" style="display: inline;">
            <input type="hidden" name="reason" id="hiddenReason">
            <button type="submit" class="btn btn-warning" onclick="document.getElementById('hiddenReason').value = document.getElementById('archiveReason').value;">
              <i class="fas fa-archive"></i> تأكيد الأرشفة
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}
