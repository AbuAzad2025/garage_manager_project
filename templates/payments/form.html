{% extends "base.html" %}
{% block title %}{{ payment and 'ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø©' or 'Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø©' }}{% endblock %}

{% block head_extra %}
<style>
/* ØªØ­Ø³ÙŠÙ† ØªØ¨Ø§ÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… */
.payment-form-card {
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    border: none;
}

.payment-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.form-label {
    color: #343a40 !important;
    font-weight: 600 !important;
    margin-bottom: 8px !important;
    font-size: 0.9rem;
}

.form-control, .form-select {
    border: 2px solid #e0e0e0 !important;
    border-radius: 8px !important;
    padding: 10px 15px !important;
    transition: all 0.3s !important;
    color: #343a40 !important;
    font-weight: 500 !important;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 600 !important;
    border-radius: 12px 12px 0 0 !important;
    padding: 15px 20px !important;
}

.split-form {
    background: #f8f9fa;
    border: 2px solid #dee2e6 !important;
    border-radius: 12px !important;
    padding: 20px !important;
    margin-bottom: 15px !important;
}

.split-form h5 {
    color: #667eea !important;
    font-weight: 700 !important;
    margin-bottom: 15px !important;
}

.btn-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
    border: none !important;
    font-weight: 600 !important;
    padding: 12px 30px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
}

.btn-success:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 12px rgba(0,0,0,0.15) !important;
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%) !important;
    border: none !important;
    font-weight: 600 !important;
}

.btn-secondary {
    background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%) !important;
    border: none !important;
    font-weight: 600 !important;
}

.entity-info-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #2196f3;
    border-radius: 12px;
}

.entity-info-card .card-header {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%) !important;
}

#splitSum {
    color: #667eea !important;
    font-weight: 600 !important;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-money-bill-wave"></i>
                        {% if payment %}
                            ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø© #{{ payment.id }}
                        {% else %}
                            Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        {% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('payments.index') }}">Ø§Ù„Ø¯ÙØ¹Ø§Øª</a></li>
                        <li class="breadcrumb-item active">{{ payment and 'ØªØ¹Ø¯ÙŠÙ„' or 'Ø¥Ù†Ø´Ø§Ø¡' }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">

  {% if entity_info %}
  <div class="card mb-4 entity-info-card">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø±ØªØ¨Ø·Ø©</h5>
    </div>
    <div class="card-body">
      <div class="row gy-3">
        {% if entity_info.number %}
          <div class="col-md-4"><strong>Ø§Ù„Ø±Ù‚Ù…:</strong> {{ entity_info.number }}</div>
          {% if entity_info.date %}
            <div class="col-md-4"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ entity_info.date }}</div>
          {% endif %}
          {% if entity_info.total is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> {{ '%.0f'|format(entity_info.total) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.paid is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> {{ '%.0f'|format(entity_info.paid) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> {{ '%.0f'|format(entity_info.balance) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.balance_due is defined %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> {{ '%.0f'|format(entity_info.balance_due) }} {{ entity_info.currency or '' }}</div>
          {% endif %}
          {% if entity_info.amount is defined and not entity_info.total %}
            <div class="col-md-4"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
          {% endif %}
        {% elif entity_info.name %}
          <div class="col-md-6"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ entity_info.name }}</div>
          {% if entity_info.balance is defined %}
            <div class="col-md-6"><strong>Ø§Ù„Ø±ØµÙŠØ¯:</strong> {{ '%.0f'|format(entity_info.balance) }}</div>
          {% endif %}
        {% elif entity_info.type == 'expense' %}
          <div class="col-md-4"><strong>Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong> {{ entity_info.number }}</div>
          <div class="col-md-4"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ entity_info.date }}</div>
          <div class="col-md-4"><strong>Ø§Ù„Ù‚ÙŠÙ…Ø©:</strong> {{ '%.0f'|format(entity_info.amount) }}</div>
        {% endif %}
        {% if entity_info.type_name %}
          <div class="col-md-4"><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong> {{ entity_info.type_name }}</div>
        {% endif %}
        {% if entity_info.employee_name %}
          <div class="col-md-4"><strong>Ø§Ù„Ù…ÙˆØ¸Ù‘Ù:</strong> {{ entity_info.employee_name }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <form method="POST" id="paymentForm" action="{{ url_for('payments.create_payment') }}" autocomplete="off">
    {{ form.hidden_tag() }}
    {% if form.request_token is not none %}
      {{ form.request_token }}
    {% endif %}

    <div class="row">
      <div class="col-md-6">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-file-invoice-dollar"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          </div>
          <div class="card-body">
            {% for field in [form.entity_type, form.direction, form.status, form.payment_date, form.total_amount, form.currency, form.method, form.reference, form.receipt_number, form.notes] %}
              {% if field is not none %}
              <div class="mb-3">
                {{ field.label(class="form-label") }}
                {% if field.type in ["SelectField", "QuerySelectField"] %}
                  {{ field(class="form-select") }}
                {% elif field.name == "payment_date" %}
                  {% set _pd = field.data %}
                  {% set _val = (_pd if _pd is string else (_pd.strftime("%Y-%m-%dT%H:%M") if _pd else "")) %}
                  {{ field(type="datetime-local", class="form-control", value=_val) }}
                {% elif field.type == "TextAreaField" %}
                  {{ field(class="form-control") }}
                {% else %}
                  {% if field.name == "total_amount" %}
                    {{ field(class="form-control", step="1", min="0") }}
                  {% else %}
                    {{ field(class="form-control") }}
                  {% endif %}
                {% endif %}
                {% if field.name == 'total_amount' %}
                  <div id="splitSum" class="form-text"></div>
                {% endif %}
                {% for e in field.errors %}
                  <div class="text-danger small">{{ e }}</div>
                {% endfor %}
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-4 payment-form-card">
          <div class="card-header">
            <i class="fas fa-user-tie"></i> Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
          </div>
          <div class="card-body" id="entityFields">
            {% include "payments/_entity_fields.html" %}
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4 payment-form-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-layer-group"></i> Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©</span>
        <small class="badge badge-info">Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 3 Ø·Ø±Ù‚ Ø¯ÙØ¹</small>
      </div>
      <div class="card-body">
        {% if form.splits and form.splits.errors %}
          <div class="alert alert-danger py-2">
            {% for err in form.splits.errors %}
              <div>â€¢ {{ err }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div id="splitsContainer" data-max-splits="3">
          {% for split in form.splits %}
          <div class="split-form border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
            <h5>Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© #{{ loop.index }}</h5>

            <div class="row gy-2">
              <div class="col-md-4">
                {{ split.method.label(class="form-label") }}
                {{ split.method(class="form-select split-method") }}
                {% for e in split.method.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4">
                {{ split.amount.label(class="form-label") }}
                {{ split.amount(class="form-control", step="1", min="0") }}
                {% for e in split.amount.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-danger remove-split" {% if loop.first %}disabled{% endif %}>Ø­Ø°Ù</button>
              </div>
            </div>

            {% set _detail_fields = [
              'check_number','check_bank','check_due_date',
              'bank_transfer_ref',
              'card_number','card_holder','card_expiry',
              'online_gateway','online_ref'
            ] %}

            <div class="split-details mt-3" style="display:none;">
              <div class="alert alert-info mb-2" style="display:none;" data-cheque-info>
                <i class="fas fa-money-check-alt"></i> <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´ÙŠÙƒ:</strong> ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯Ù‚Ø©
              </div>
              <div class="row gy-2">
                {% for fname in _detail_fields %}
                  {% set field = split|attr(fname) %}
                  {% if field is not none %}
                  <div class="col-md-4" data-field="{{ fname }}">
                    <label class="form-label">
                      {% if fname == 'check_number' %}<i class="fas fa-hashtag text-primary"></i>{% endif %}
                      {% if fname == 'check_bank' %}<i class="fas fa-university text-info"></i>{% endif %}
                      {% if fname == 'check_due_date' %}<i class="fas fa-calendar-alt text-warning"></i>{% endif %}
                      {{ field.label.text }}
                    </label>
                    {% if fname == 'check_due_date' %}
                      {{ field(type="date", class="form-control") }}
                    {% else %}
                      {{ field(class="form-control") }}
                    {% endif %}
                    {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <button type="button" id="addSplit" class="btn btn-secondary">+ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©</button>
      </div>
    </div>

    <div class="card payment-form-card">
      <div class="card-body text-center">
        <button type="submit" class="btn btn-success btn-lg">
          <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©
        </button>
        <a href="{{ url_for('payments.index') }}" class="btn btn-secondary btn-lg">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </a>
      </div>
    </div>
  </form>

        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/payment_form.js') }}"></script>
  
  <script>
    // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ø¬Ù‡Ø§Øª
    let searchTimeout = {};
    
    function searchEntities(entityType, searchTerm) {
      if (!searchTerm || searchTerm.length < 2) {
        hideEntityResults(entityType);
        return;
      }
      
      clearTimeout(searchTimeout[entityType]);
      searchTimeout[entityType] = setTimeout(() => {
        fetch(`/payments/api/entities/${entityType}?search=${encodeURIComponent(searchTerm)}`)
          .then(response => {
            if (response.status === 302 || response.status === 401) {
              // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯
              hideEntityResults(entityType);
              return;
            }
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              showEntityResults(entityType, data);
            }
          })
          .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
            if (searchField) {
              searchField.style.borderColor = '#dc3545';
              setTimeout(() => {
                searchField.style.borderColor = '';
              }, 3000);
            }
          });
      }, 300);
    }
    
    function showEntityResults(entityType, entities) {
      const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
      if (!searchField) return;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      hideEntityResults(entityType);
      
      if (entities.length === 0) {
        return;
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      const resultsDiv = document.createElement('div');
      resultsDiv.className = 'entity-search-results';
      resultsDiv.id = `${entityType.toLowerCase()}_results`;
      resultsDiv.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      `;
      
      entities.forEach(entity => {
        const item = document.createElement('div');
        item.className = 'entity-result-item';
        item.style.cssText = `
          padding: 8px 12px;
          cursor: pointer;
          border-bottom: 1px solid #eee;
        `;
        item.innerHTML = `
          <div class="fw-bold">${entity.name || entity.display}</div>
          ${entity.phone ? `<small class="text-muted">${entity.phone}</small>` : ''}
          ${entity.email ? `<small class="text-muted">${entity.email}</small>` : ''}
        `;
        
        item.addEventListener('click', () => {
          selectEntity(entityType, entity);
        });
        
        item.addEventListener('mouseenter', () => {
          item.style.backgroundColor = '#f8f9fa';
        });
        
        item.addEventListener('mouseleave', () => {
          item.style.backgroundColor = 'white';
        });
        
        resultsDiv.appendChild(item);
      });
      
      // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      searchField.parentNode.style.position = 'relative';
      searchField.parentNode.appendChild(resultsDiv);
    }
    
    function hideEntityResults(entityType) {
      const resultsDiv = document.getElementById(`${entityType.toLowerCase()}_results`);
      if (resultsDiv) {
        resultsDiv.remove();
      }
    }
    
    function selectEntity(entityType, entity) {
      const searchField = document.querySelector(`input[name="${entityType.toLowerCase()}_search"]`);
      const hiddenField = document.querySelector(`input[name="${entityType.toLowerCase()}_id"]`);
      const entityIdField = document.querySelector(`input[name="entity_id"]`);
      
      if (searchField && hiddenField) {
        searchField.value = entity.name || entity.display;
        hiddenField.value = entity.id;
        
        // ØªØ­Ø¯ÙŠØ« entity_id Ø£ÙŠØ¶Ø§Ù‹
        if (entityIdField) {
          entityIdField.value = entity.id;
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        hideEntityResults(entityType);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        updateEntityFields();
      }
    }
    
    function updateEntityFields() {
      const entityType = document.querySelector('select[name="entity_type"]');
      if (!entityType) return;
      
      const selectedType = entityType.value;
      const entityFieldsContainer = document.getElementById('entityFields');
      
      if (!selectedType) {
        entityFieldsContainer.innerHTML = '<div class="text-muted">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</div>';
        return;
      }
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      entityFieldsContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„...</div>';
      
      // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¹Ø¨Ø± AJAX
      fetch(`/payments/entity-fields?type=${selectedType.toLowerCase()}`)
        .then(response => {
          if (response.status === 302 || response.status === 401) {
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯
            entityFieldsContainer.innerHTML = '<div class="alert alert-warning">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>';
            return;
          }
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          if (html) {
            entityFieldsContainer.innerHTML = html;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            updateSmartFilters(selectedType);
          }
        })
        .catch(error => {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„:', error);
          entityFieldsContainer.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„: ' + error.message + '</div>';
        });
    }
    
    function updateSmartFilters(entityType) {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø°ÙƒÙŠØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
      const searchFields = document.querySelectorAll('input[name$="_search"]');
      searchFields.forEach(field => {
        const fieldName = field.name;
        const expectedEntityType = fieldName.replace('_search', '').toUpperCase();
        
        if (expectedEntityType === entityType) {
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†
          field.removeEventListener('keyup', searchEntities);
          
          // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„
          field.addEventListener('keyup', function() {
            searchEntities(entityType, this.value);
          });
        }
      });
    }
    
    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
    function updateEntityFields() {
      const entityTypeSelect = document.querySelector('select[name="entity_type"]');
      if (!entityTypeSelect) {
        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ entity_type');
        return;
      }
      
      const selectedType = entityTypeSelect.value.toLowerCase();
      console.log('âœ… Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±:', selectedType);
      
      const entityFieldsContainer = document.getElementById('entityFields');
      if (!entityFieldsContainer) {
        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ entityFields container');
        return;
      }
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
      const allContainers = entityFieldsContainer.querySelectorAll('.entity-field-container');
      console.log('ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', allContainers.length);
      
      allContainers.forEach(container => {
        container.style.display = 'none';
        console.log('ğŸ”’ Ø¥Ø®ÙØ§Ø¡ Ø­Ø§ÙˆÙŠØ©:', container.getAttribute('data-entity-type'));
      });
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
      const targetContainer = entityFieldsContainer.querySelector(`[data-entity-type="${selectedType}"]`);
      if (targetContainer) {
        targetContainer.style.display = 'block';
        console.log('âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§ÙˆÙŠØ©:', selectedType);
      } else {
        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ù„Ù†ÙˆØ¹:', selectedType);
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¯ÙˆÙ† toLowerCase
        const allTypes = Array.from(allContainers).map(c => c.getAttribute('data-entity-type'));
        console.log('ğŸ“‹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØªØ§Ø­Ø©:', allTypes);
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      setTimeout(function() {
        if (typeof initSmartSearch === 'function') {
          smartSearchInitialized = false;
          initSmartSearch();
        }
      }, 100);
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
      const entityTypeSelect = document.querySelector('select[name="entity_type"]');
      if (entityTypeSelect) {
        entityTypeSelect.addEventListener('change', function() {
          updateEntityFields();
          // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
          updateDirectionOptions();
        });
        
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
      setTimeout(function() {
        updateEntityFields();
        updateDirectionOptions(); // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø£ÙŠØ¶Ø§Ù‹
      }, 100);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡
      const directionSelect = document.querySelector('select[name="direction"]');
      if (directionSelect) {
        directionSelect.addEventListener('change', validateDirection);
      }
      
      // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
      initPaymentMethodFields();
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©
      const addSplitBtn = document.getElementById('addSplit');
      if (addSplitBtn) {
        addSplitBtn.addEventListener('click', function() {
          setTimeout(function() {
            initPaymentMethodFields();
          }, 100);
        });
      }
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
      const splitsContainer = document.getElementById('splitsContainer');
      if (splitsContainer) {
        splitsContainer.addEventListener('click', function(e) {
          if (e.target.classList.contains('remove-split')) {
            setTimeout(function() {
              initPaymentMethodFields();
            }, 100);
          }
        });
      }
    });
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    function initPaymentMethodFields() {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
      const splitMethodSelects = document.querySelectorAll('.split-method');
      
      splitMethodSelects.forEach(select => {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);
        
        updateMethodFields(newSelect);
        
        newSelect.addEventListener('change', function() {
          updateMethodFields(this);
        });
      });
    }
    
    function updateMethodFields(methodSelect) {
      const splitForm = methodSelect.closest('.split-form');
      if (!splitForm) return;
      
      const detailsContainer = splitForm.querySelector('.split-details');
      if (!detailsContainer) return;
      
      const selectedMethod = methodSelect.value.toUpperCase();
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
      const allDetailFields = detailsContainer.querySelectorAll('[data-field]');
      allDetailFields.forEach(field => {
        field.style.display = 'none';
      });
      const chequeInfo = detailsContainer.querySelector('[data-cheque-info]');
      if (chequeInfo) chequeInfo.style.display = 'none';
      
      // Ø¥Ø¸Ù‡Ø§Ø± detailsContainer ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© ØªØ­ØªØ§Ø¬ ØªÙØ§ØµÙŠÙ„
      const methodsWithDetails = ['CHECK', 'CHEQUE', 'BANK', 'BANK_TRANSFER', 'CARD', 'ONLINE'];
      const needsDetails = methodsWithDetails.some(m => selectedMethod.includes(m));
      
      if (needsDetails) {
        detailsContainer.style.display = 'block';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
        if (selectedMethod.includes('CHECK') || selectedMethod.includes('CHEQUE')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´ÙŠÙƒ
          const chequeInfo = detailsContainer.querySelector('[data-cheque-info]');
          if (chequeInfo) chequeInfo.style.display = 'block';
          showField(detailsContainer, 'check_number');
          showField(detailsContainer, 'check_bank');
          showField(detailsContainer, 'check_due_date');
        } else if (selectedMethod.includes('BANK')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ
          showField(detailsContainer, 'bank_transfer_ref');
        } else if (selectedMethod.includes('CARD')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
          showField(detailsContainer, 'card_number');
          showField(detailsContainer, 'card_holder');
          showField(detailsContainer, 'card_expiry');
        } else if (selectedMethod.includes('ONLINE')) {
          // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          showField(detailsContainer, 'online_gateway');
          showField(detailsContainer, 'online_ref');
        }
      } else {
        detailsContainer.style.display = 'none';
      }
    }
    
    function showField(container, fieldName) {
      const field = container.querySelector(`[data-field="${fieldName}"]`);
      if (field) {
        field.style.display = 'block';
      }
    }
    
    function updateDirectionOptions() {
      const entityType = document.querySelector('select[name="entity_type"]').value;
      const directionSelect = document.querySelector('select[name="direction"]');
      
      if (!directionSelect) return;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      directionSelect.innerHTML = '';
      
      if (entityType === 'EXPENSE') {
        // Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØµØ§Ø¯Ø±Ø©
        directionSelect.innerHTML = '<option value="OUT">ØµØ§Ø¯Ø± (Ù…Ù†Ù†Ø§)</option>';
        directionSelect.value = 'OUT';
      } else {
        // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØ¯Ø¹Ù… ÙƒÙ„Ø§ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ÙŠÙ†
        directionSelect.innerHTML = `
          <option value="IN">ÙˆØ§Ø±Ø¯ (Ø¥Ù„ÙŠÙ†Ø§)</option>
          <option value="OUT">ØµØ§Ø¯Ø± (Ù…Ù†Ù†Ø§)</option>
        `;
      }
    }
    
    function validateDirection() {
      const entityType = document.querySelector('select[name="entity_type"]').value;
      const direction = document.querySelector('select[name="direction"]').value;
      
      if (entityType === 'EXPENSE' && direction !== 'OUT') {
        alert('Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØµØ§Ø¯Ø±Ø© ÙÙ‚Ø·');
        document.querySelector('select[name="direction"]').value = 'OUT';
      }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.entity-search-results') && !e.target.closest('input[name$="_search"]')) {
        const allResults = document.querySelectorAll('.entity-search-results');
        allResults.forEach(result => result.remove());
      }
    });
  </script>
  
  <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù JavaScript Ù„Ù„Ø¯ÙØ¹Ø§Øª -->
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>
{% endblock %}
