{% set etype_raw = form.entity_type.data or request.args.get('type') or request.args.get('entity_type') or '' %}
{% set etype = etype_raw | lower %}

<!-- ✅ Hidden Fields - خارج الـ containers لضمان الإرسال مع الفورم -->
<div style="display: none;">
  {% if form.customer_id is defined %}{{ form.customer_id(id="customer_id") }}{% endif %}
  {% if form.supplier_id is defined %}{{ form.supplier_id(id="supplier_id") }}{% endif %}
  {% if form.partner_id is defined %}{{ form.partner_id(id="partner_id") }}{% endif %}
  {% if form.shipment_id is defined %}{{ form.shipment_id(id="shipment_id") }}{% endif %}
  {% if form.expense_id is defined %}{{ form.expense_id(id="expense_id") }}{% endif %}
  {% if form.loan_settlement_id is defined %}{{ form.loan_settlement_id(id="loan_settlement_id") }}{% endif %}
  {% if form.sale_id is defined %}{{ form.sale_id(id="sale_id") }}{% endif %}
  {% if form.invoice_id is defined %}{{ form.invoice_id(id="invoice_id") }}{% endif %}
  {% if form.preorder_id is defined %}{{ form.preorder_id(id="preorder_id") }}{% endif %}
  {% if form.service_id is defined %}{{ form.service_id(id="service_id") }}{% endif %}
  {% if form.entity_id is defined %}{{ form.entity_id(id="entity_id") }}{% endif %}
</div>

<!-- حاوية العميل -->
    <div class="entity-field-container" data-entity-type="customer" style="display: {% if etype == 'customer' %}block{% else %}none{% endif %};">
      {% if form.customer_search is defined %}
        <label class="form-label required-field">
          <i class="fas fa-user-circle text-primary"></i>
          {{ form.customer_search.label.text }}
          <span class="text-danger fw-bold">*</span>
        </label>
        <div class="input-group" style="position: relative;">
          {{ form.customer_search(class="form-control search-dropdown-field", placeholder="🔍 ابحث أو اختر عميل...", autocomplete="off", id="customer_search") }}
          <button type="button" class="btn btn-outline-secondary dropdown-toggle-btn" data-entity="customer">
            <i class="fas fa-chevron-down"></i>
          </button>
          <a class="btn btn-outline-primary" href="{{ url_for('customers_bp.create_form') }}" target="_blank">
            <i class="fas fa-plus me-1"></i>عميل جديد
          </a>
        </div>
        <small class="form-text text-muted">
          <i class="fas fa-info-circle"></i> اكتب للبحث أو اضغط السهم لعرض الكل
        </small>
        {% for e in form.customer_search.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      {% endif %}
    </div>

<!-- حاوية المورد -->
<div class="entity-field-container" data-entity-type="supplier" style="display: {% if etype == 'supplier' %}block{% else %}none{% endif %};">
  {% if form.supplier_search is defined %}
    <label class="form-label required-field">
      <i class="fas fa-truck text-success"></i>
      {{ form.supplier_search.label.text }}
      <span class="text-danger fw-bold">*</span>
    </label>
    <div class="input-group" style="position: relative;">
      {{ form.supplier_search(class="form-control search-dropdown-field", placeholder="🔍 ابحث أو اختر مورد...", autocomplete="off", id="supplier_search") }}
      <button type="button" class="btn btn-outline-secondary dropdown-toggle-btn" data-entity="supplier">
        <i class="fas fa-chevron-down"></i>
      </button>
      <a class="btn btn-outline-primary" href="{{ url_for('vendors_bp.suppliers_create') }}" target="_blank">
        <i class="fas fa-plus me-1"></i>مورد جديد
      </a>
    </div>
    <small class="form-text text-muted">
      <i class="fas fa-info-circle"></i> اكتب للبحث أو اضغط السهم لعرض الكل
    </small>
    {% for e in form.supplier_search.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
  {% endif %}
</div>

<!-- حاوية الشريك -->
<div class="entity-field-container" data-entity-type="partner" style="display: {% if etype == 'partner' %}block{% else %}none{% endif %};">
  {% if form.partner_search is defined %}
    <label class="form-label required-field">
      <i class="fas fa-handshake text-warning"></i>
      {{ form.partner_search.label.text }}
      <span class="text-danger fw-bold">*</span>
    </label>
    <div class="input-group" style="position: relative;">
      {{ form.partner_search(class="form-control search-dropdown-field", placeholder="🔍 ابحث أو اختر شريك...", autocomplete="off", id="partner_search") }}
      <button type="button" class="btn btn-outline-secondary dropdown-toggle-btn" data-entity="partner">
        <i class="fas fa-chevron-down"></i>
      </button>
      <a class="btn btn-outline-primary" href="{{ url_for('vendors_bp.partners_create') }}" target="_blank">
        <i class="fas fa-plus me-1"></i>شريك جديد
      </a>
    </div>
    <small class="form-text text-muted">
      <i class="fas fa-info-circle"></i> اكتب للبحث أو اضغط السهم لعرض الكل
    </small>
    {% for e in form.partner_search.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
  {% endif %}
</div>

<!-- حاوية البيع -->
<div class="entity-field-container" data-entity-type="sale" style="display: {% if etype == 'sale' %}block{% else %}none{% endif %};">
  {% if form.sale_search is defined %}
    {{ form.sale_search.label(class="form-label") }}
    {{ form.sale_search(class="form-control", placeholder="رقم البيع", autocomplete="off") }}
    {% for e in form.sale_search.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
  {% endif %}
  <div class="mb-3">
    {% if form.customer_search is defined %}
      <label class="form-label">العميل المرتبط</label>
      {{ form.customer_search(class="form-control", placeholder="العميل المرتبط بالبيع", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- حاوية الصيانة -->
<div class="entity-field-container" data-entity-type="service" style="display: {% if etype == 'service' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    {% if form.service_search is defined %}
      {{ form.service_search.label(class="form-label") }}
      {{ form.service_search(class="form-control", placeholder="رقم الصيانة", autocomplete="off") }}
      {% for e in form.service_search.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    {% endif %}
  </div>
  <div class="mb-3">
    {% if form.customer_search is defined %}
      <label class="form-label">العميل المرتبط</label>
      {{ form.customer_search(class="form-control", placeholder="العميل المرتبط بالصيانة", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- حاوية الشحنة -->
<div class="entity-field-container" data-entity-type="shipment" style="display: {% if etype == 'shipment' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    {% if form.shipment_search is defined %}
      {{ form.shipment_search.label(class="form-label") }}
      {{ form.shipment_search(class="form-control", placeholder="رقم الشحنة", autocomplete="off") }}
      {% for e in form.shipment_search.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    {% endif %}
  </div>
  <div class="mb-3">
    {% if form.supplier_search is defined %}
      <label class="form-label">المورد المرتبط</label>
      {{ form.supplier_search(class="form-control", placeholder="المورد المرتبط بالشحنة", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- حاوية المصروف -->
<div class="entity-field-container" data-entity-type="expense" style="display: {% if etype == 'expense' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    {% if form.expense_search is defined %}
      {{ form.expense_search.label(class="form-label") }}
      {{ form.expense_search(class="form-control", placeholder="رقم المصروف", autocomplete="off") }}
      {% for e in form.expense_search.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    {% endif %}
  </div>
  <div class="mb-3">
    {% if form.supplier_search is defined %}
      <label class="form-label">المورد أو الموظف</label>
      {{ form.supplier_search(class="form-control", placeholder="المورد/الموظف المرتبط بالمصروف", autocomplete="off") }}
    {% endif %}
    {% if form.employee_id is defined %}{{ form.employee_id(id="employee_id") }}{% endif %}
  </div>
</div>

<!-- حاوية القرض/التسوية -->
<div class="entity-field-container" data-entity-type="loan" style="display: {% if etype == 'loan' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    {% if form.loan_settlement_search is defined %}
      {{ form.loan_settlement_search.label(class="form-label") }}
      {{ form.loan_settlement_search(class="form-control", placeholder="رقم التسوية", autocomplete="off") }}
      {% for e in form.loan_settlement_search.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    {% endif %}
  </div>
  <div class="mb-3">
    {% if form.supplier_search is defined %}
      <label class="form-label">المورد المرتبط</label>
      {{ form.supplier_search(class="form-control", placeholder="المورد المرتبط بالتسوية", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- حاوية الحجز المسبق (قطع غيار) -->
<div class="entity-field-container" data-entity-type="preorder" style="display: {% if etype == 'preorder' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    {% if form.preorder_search is defined %}
      {{ form.preorder_search.label(class="form-label") }}
      {{ form.preorder_search(class="form-control", placeholder="رقم الحجز (قطع غيار)", autocomplete="off") }}
      {% for e in form.preorder_search.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    {% endif %}
  </div>
  <div class="mb-3">
    {% if form.customer_search is defined %}
      <label class="form-label">العميل المرتبط</label>
      {{ form.customer_search(class="form-control", placeholder="العميل المرتبط بالحجز", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- حاوية الحجز المسبق (متجر أونلاين) -->
<div class="entity-field-container" data-entity-type="preorder_shop" style="display: {% if etype == 'preorder_shop' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    <label class="form-label"><i class="fas fa-shopping-cart"></i> رقم الطلب (متجر)</label>
    <input type="text" name="shop_preorder_number" class="form-control" placeholder="رقم طلب المتجر" autocomplete="off">
  </div>
  <div class="mb-3">
    {% if form.customer_search is defined %}
      <label class="form-label">العميل المرتبط</label>
      {{ form.customer_search(class="form-control", placeholder="العميل المرتبط بالطلب", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- حاوية المشتريات -->
<div class="entity-field-container" data-entity-type="purchase" style="display: {% if etype == 'purchase' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    <label class="form-label"><i class="fas fa-shopping-bag"></i> رقم المشتريات</label>
    <input type="text" name="purchase_number" class="form-control" placeholder="رقم المشتريات" autocomplete="off">
  </div>
  <div class="mb-3">
    {% if form.supplier_search is defined %}
      <label class="form-label">المورد المرتبط</label>
      {{ form.supplier_search(class="form-control", placeholder="المورد المرتبط بالمشتريات", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- حاوية الفاتورة -->
<div class="entity-field-container" data-entity-type="invoice" style="display: {% if etype == 'invoice' %}block{% else %}none{% endif %};">
  <div class="mb-3">
    {% if form.invoice_search is defined %}
      {{ form.invoice_search.label(class="form-label") }}
      {{ form.invoice_search(class="form-control", placeholder="رقم الفاتورة", autocomplete="off") }}
      {% for e in form.invoice_search.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    {% endif %}
  </div>
  <div class="mb-3">
    {% if form.customer_search is defined %}
      <label class="form-label">العميل المرتبط</label>
      {{ form.customer_search(class="form-control", placeholder="العميل المرتبط بالفاتورة", autocomplete="off", readonly=true) }}
    {% endif %}
  </div>
</div>

<!-- رسالة افتراضية -->
<div class="entity-field-container" data-entity-type="" style="display: {% if not etype %}block{% else %}none{% endif %};">
  <div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    اختر نوع الجهة من القائمة أعلاه لعرض الحقول المناسبة
  </div>
</div>
