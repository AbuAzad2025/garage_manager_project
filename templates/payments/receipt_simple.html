{% extends "base_print.html" %}
{% block title %}ÙˆØµÙ„ Ø¯ÙØ¹{% endblock %}

{% block head_extra %}
{% set _size = (request.args.get('s', 'a4')|lower) %}
{% set _ori  = (request.args.get('o', 'portrait')|lower) %}
{% set W,H = (148,210) if _size == 'a5' else (210,297) %}
{% set PW,PH = (H,W) if _ori == 'landscape' else (W,H) %}
{% set MT = 8 %}{% set MR = 8 %}{% set ML = 8 %}{% set MB = 8 %}
{% set content_w = PW - (ML + MR) %}

<style>
  @page { size: {{ PW }}mm {{ PH }}mm; margin: {{ MT }}mm {{ MR }}mm {{ MB }}mm {{ ML }}mm; }
  @media print { .no-print { display: none !important; } }

  html,body{background:#fff;font-family:"DejaVu Sans","Amiri","Tahoma","Arial",sans-serif;direction:rtl;text-align:right;font-size:12px;line-height:1.4;margin:0;color:#000}
  #receipt { width: {{ content_w }}mm; margin: 0 auto; }

  .simple-header{text-align:center;margin-bottom:12px;border-bottom:2px solid #333;padding-bottom:8px}
  .simple-header h2{font-size:18px;font-weight:800;margin:0 0 4px 0}
  .simple-header .subtitle{font-size:11px;color:#555;margin:0}

  .info-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:11px}
  .info-row div{flex:1}

  .kv { width: 100%; border-collapse: collapse; margin-bottom:10px; }
  .kv th, .kv td { padding: 6px 8px; vertical-align: top; border:1px solid #999; font-size:11px; }
  .kv th { width: 30%; white-space: nowrap; background:#f5f5f5; color: #333; font-weight:700; }
  .kv td { width: 70%; }
  .num { text-align: end; white-space: nowrap; }
  .wrap { word-break: break-word; }

  table { width: 100%; border-collapse: collapse; margin-bottom:10px; }
  thead th { background: #f0f0f0; border:1px solid #777; font-size:11px; }
  td, th { padding: 5px 6px; border: 1px solid #999; font-size:11px; }

  .sign-row { display:flex; gap:14px; margin-top:18px; }
  .sign { flex:1; border-top: 1px solid #888; padding-top: 10px; text-align: center; min-height:35px; font-size:11px; }

  @media print{
    html,body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .btn,nav,.navbar,.sidebar,.actions,a.no-print{display:none!important}
    a[href]:after{content:""!important}
    tr,.info-row{break-inside:avoid;page-break-inside:avoid}
  }
</style>
{% endblock %}

{% block content %}
{% set _receipt_no = payment.receipt_number or payment.payment_number or payment.id %}
{% set _dir    = ((payment.direction.value if payment.direction and payment.direction.value else payment.direction) or '')|string|upper %}
{% set _method = (payment.method.value   if payment.method   and payment.method.value   else payment.method) %}
{% set _status = (payment.status.value   if payment.status   and payment.status.value   else payment.status) %}
{% set _curr   = payment.currency or '' %}

<div id="receipt">
  <div class="simple-header">
    <h2>ÙˆØµÙ„ Ø¯ÙØ¹</h2>
    <p class="subtitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</p>
  </div>

  <div class="info-row">
    <div><strong>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„:</strong> {{ _receipt_no }}</div>
    <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</div>
  </div>


  <table class="kv">
    <tr><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</th><td class="num"><strong>{{ '%.0f'|format(payment.total_amount or 0) }} {{ _curr }}</strong></td></tr>
    <tr><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><td>{{ _method or 'â€”' }}</td></tr>
    <tr><th>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th><td>{{ 'ÙˆØ§Ø±Ø¯' if _dir in ['IN','INCOMING'] else 'ØµØ§Ø¯Ø±' }}</td></tr>
    <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>{{ _status or 'â€”' }}</td></tr>
    <tr><th>Ø§Ù„Ø¬Ù‡Ø©</th><td>{{ payment.entity_label() or payment.entity_type or 'â€”' }}</td></tr>
    <tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><td>{{ payment.reference or 'â€”' }}</td></tr>
    {% if payment.receiver_name %}
    <tr><th>Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th><td><strong>{{ payment.receiver_name }}</strong></td></tr>
    {% endif %}
    <tr><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>{{ payment.notes or 'â€”' }}</td></tr>
  </table>


  {% if sale_info %}
  <table class="kv">
    {% set s_curr = sale_info.currency or '' %}
    <tr><th colspan="2" style="text-align:center;background:#e8e8e8"><strong>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</strong></th></tr>
    <tr><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><td>#{{ sale_info.number or 'â€”' }}</td></tr>
    <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹</th><td>{{ sale_info.date or 'â€”' }}</td></tr>
    <tr><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><td class="num">{{ sale_info.total is not none and ('%.0f'|format(sale_info.total)) or 'â€”' }} {{ s_curr }}</td></tr>
    <tr><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><td class="num">{{ sale_info.paid is not none and ('%.0f'|format(sale_info.paid)) or 'â€”' }} {{ s_curr }}</td></tr>
    <tr><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><td class="num">{{ sale_info.balance is not none and ('%.0f'|format(sale_info.balance)) or 'â€”' }} {{ s_curr }}</td></tr>
  </table>
  {% endif %}


  {% if payment.splits %}
  <table>
    <colgroup>
      <col style="width:50px"><col style="width:160px"><col style="width:120px"><col>
    </colgroup>
    <thead>
      <tr>
        <th>#</th>
        <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
        <th>ØªÙØ§ØµÙŠÙ„</th>
      </tr>
    </thead>
    <tbody>
      {% for s in payment.splits %}
        {% set m = ((s.method.value if s.method and s.method.value else s.method) or '')|lower %}
        {% set d = s.details if s.details is mapping else {} %}
        {% set split_curr = (s.currency or _curr) %}
        <tr>
          <td class="text-center">{{ loop.index }}</td>
          <td class="num">
            {{ '%.0f'|format(s.amount or 0) }} {{ split_curr }}
            {% if split_curr and _curr and split_curr.upper() != _curr.upper() %}
              <div class="text-muted small">â‰ˆ {{ '%.0f'|format(s.converted_amount or 0) }} {{ _curr }}</div>
            {% endif %}
          </td>
          <td class="text-center">{{ (m or 'â€”')|upper }}</td>
          <td class="wrap">
            {% if m in ['cheque','check'] %}
              Ø´ÙŠÙƒ: {{ d.get('check_number','â€”') }}ØŒ Ø¨Ù†Ùƒ: {{ d.get('check_bank','â€”') }}ØŒ Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ d.get('check_due_date') or d.get('due_date') or 'â€”' }}
            {% elif m in ['bank','transfer','bank_transfer'] %}
              ØªØ­ÙˆÙŠÙ„: {{ d.get('bank_transfer_ref', d.get('reference','â€”')) }}
            {% elif m in ['card','credit'] %}
              Ø¨Ø·Ø§Ù‚Ø©: ****{{ d.get('card_last4') or (d.get('card_number','')|string)[-4:] }}ØŒ Ø­Ø§Ù…Ù„: {{ d.get('card_holder','â€”') }}ØŒ Ø§Ù†ØªÙ‡Ø§Ø¡: {{ d.get('card_expiry','â€”') }}
            {% elif m in ['online','mobile'] %}
              Ø¨ÙˆØ§Ø¨Ø©: {{ d.get('online_gateway', d.get('gateway','â€”')) }}ØŒ Ù…Ø±Ø¬Ø¹: {{ d.get('online_ref', d.get('reference','â€”')) }}
            {% elif m == 'cash' %}
              Ù†Ù‚Ø¯Ø§Ù‹
            {% else %}
              â€”
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="1" class="text-end">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
        <th class="num">{{ '%.0f'|format((payment.splits | map(attribute='converted_amount') | sum) or payment.total_amount or 0) }} {{ _curr }}</th>
        <th colspan="2"></th>
      </tr>
    </tfoot>
  </table>
  {% endif %}


  <div class="sign-row">
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
  </div>

  <div class="text-center mt-3 no-print" style="padding:8px 0">
    <button class="btn btn-dark btn-sm" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <a class="btn btn-info btn-sm" href="{{ url_for('payments.payment_receipt', payment_id=payment.id) }}">ğŸ¨ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}">ØªØ­Ù…ÙŠÙ„ PDF</a>
  </div>
</div>
{% endblock %}

