<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8">
  <title>وصل دفع #{{ payment.id }}</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; direction: rtl; text-align: right; }
    .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    .company-info { margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    th { background: #f2f2f2; }
    .total-row { background: #f8f9fa; font-weight: bold; }
    .footer { text-align: center; font-size: 0.9em; color: #6c757d; border-top: 1px solid #ddd; padding-top: 10px; }
    .signature { margin-top: 50px; text-align: left; }
  </style>
</head>
<body>
  <div class="header">
    <h1>وصل دفع</h1>
    <h2>رقم الوصل: #{{ payment.id }}</h2>
  </div>

  <div class="company-info">
    <p><strong>شركة:</strong> شركة المتجر الذكي</p>
    <p><strong>عنوان:</strong> غزة، فلسطين</p>
    <p><strong>هاتف:</strong> 123456789</p>
    <p><strong>تاريخ الطباعة:</strong> {{ now.strftime('%Y-%m-%d %H:%M') }}</p>
  </div>

  {% set method_main = payment.method.value if payment.method and payment.method.value else payment.method %}
  {% set status_main = payment.status.value if payment.status and payment.status.value else payment.status %}
  {% set dir_main    = payment.direction.value if payment.direction and payment.direction.value else payment.direction %}

  <table>
    <tr><th>المبلغ الكلي</th><td>{{ '%.2f'|format(payment.total_amount or 0) }} {{ payment.currency }}</td></tr>
    <tr><th>التاريخ</th><td>{{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d') or '—' }}</td></tr>
    <tr><th>طريقة الدفع (رئيسية)</th><td>{{ method_main or '—' }}</td></tr>
    <tr><th>الجهة</th><td>{{ payment.entity_label() or (payment.entity_type|capitalize) }}</td></tr>
    <tr><th>الحالة</th><td>{{ status_main }}</td></tr>
    <tr><th>الاتجاه</th><td>{{ 'وارد' if dir_main in ['IN','INCOMING'] else 'صادر' }}</td></tr>
    <tr><th>المرجع</th><td>{{ payment.reference or '—' }}</td></tr>
    <tr><th>الملاحظات</th><td>{{ payment.notes or '—' }}</td></tr>
  </table>

  <h3>💳 تفاصيل الدفعات الجزئية:</h3>
  <table>
    <thead>
      <tr><th>#</th><th>المبلغ</th><th>طريقة</th><th>تفاصيل</th></tr>
    </thead>
    <tbody>
      {% for split in payment.splits %}
      {% set m = split.method.value if split.method and split.method.value else split.method %}
      {% set d = split.details or {} %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ '%.2f'|format(split.amount or 0) }} {{ payment.currency }}</td>
        <td>{{ (m or '—')|upper }}</td>
        <td>
          {% if m == 'cheque' %}
            رقم شيك: {{ d.get('check_number','—') }}<br>
            بنك: {{ d.get('check_bank','—') }}<br>
            استحقاق: {{ d.get('check_due_date') or d.get('due_date') or '—' }}
          {% elif m == 'bank' %}
            تحويل: {{ d.get('bank_transfer_ref','—') }}
          {% elif m == 'card' %}
            بطاقة: ****{{ (d.get('card_number','')|string)[-4:] }}<br>
            حامل: {{ d.get('card_holder','—') }}<br>
            انتهاء: {{ d.get('card_expiry','—') }}
          {% elif m == 'online' %}
            دفع إلكتروني ({{ d.get('gateway','—') }})
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      <tr class="total-row">
        <td colspan="3">المجموع</td>
        <td>{{ '%.2f'|format(payment.total_amount or 0) }} {{ payment.currency }}</td>
      </tr>
    </tbody>
  </table>

  <div class="signature">
    <p>توقيع المستلم: ____________</p>
    <p>الاسم: ____________</p>
    <p>التاريخ: ____________</p>
  </div>

  <div class="footer">
    <p>© {{ now.year }} نظام إدارة المدفوعات - شركة المتجر الذكي</p>
  </div>
</body>
</html>
