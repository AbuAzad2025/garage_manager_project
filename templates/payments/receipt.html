{% extends "base_print.html" %}
{% block title %}ÙˆØµÙ„ Ø¯ÙØ¹{% endblock %}

{% block head_extra %}
{% set _size = (request.args.get('s','a4')|lower) %}
{% set _ori  = (request.args.get('o','portrait')|lower) %}
{% if _size == 'a5' %}{% set W=148 %}{% set H=210 %}{% else %}{% set W=210 %}{% set H=297 %}{% endif %}
{% if _ori == 'landscape' %}{% set PW=H %}{% set PH=W %}{% else %}{% set PW=W %}{% set PH=H %}{% endif %}
{% set MT=12 %}{% set MR=12 %}{% set ML=12 %}{% set footer_h=14 %}
{% set MB = MT + footer_h %}
{% set content_w = PW - (ML + MR) %}

<style>
  @page { size: {{PW}}mm {{PH}}mm; margin: {{MT}}mm {{MR}}mm {{MB}}mm {{ML}}mm; }
  @media print { .no-print{display:none!important} }

  html,body{background:#fff;font-family:"DejaVu Sans","Amiri","Tahoma","Arial",sans-serif;direction:rtl;text-align:right;font-size:13px;line-height:1.5;margin:0;color:#000}
  #receipt{width:{{content_w}}mm;margin:0 auto;box-sizing:border-box;padding-bottom:{{footer_h}}mm}

  .receipt-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{height:48px;object-fit:contain}
  .brand-name{font-weight:800;font-size:16px}
  .brand-sub{font-size:12px;color:#555}
  .brand-line{height:3px;background:linear-gradient(90deg,#0d6efd,#20c997);border-radius:6px;margin:6px 0 14px}

  .box{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:12px;page-break-inside:avoid}

  table{width:100%;border-collapse:collapse;table-layout:fixed}
  thead{display:table-header-group}
  tfoot{display:table-footer-group}
  th,td{border:1px solid #d9d9d9;padding:6px 8px;vertical-align:middle}
  thead th{background:#f3f6fb;border-color:#e6e6e6;font-weight:800;color:#394b6a;white-space:nowrap}
  .wrap{overflow-wrap:anywhere;white-space:normal}
  .num{font-variant-numeric:tabular-nums;text-align:end}

  .kv th{width:38mm;background:#f8f9fa;color:#555;font-weight:700;white-space:nowrap}

  col.col-s-idx{width:10%}
  col.col-s-amt{width:22%}
  col.col-s-mth{width:20%}
  col.col-s-det{width:48%}

  .sign-row{display:flex;gap:14px;margin-top:18px}
  .sign{flex:1;text-align:center;border-top:1px solid #bbb;padding-top:10px;min-height:40px}

  .receipt-footer{position:fixed;left:{{ML}}mm;right:{{MR}}mm;bottom:{{MT}}mm;height:{{footer_h}}mm;text-align:center;font-size:11px;border-top:1px solid #777;padding-top:3mm;background:transparent}

  @media print{
    html,body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .btn,nav,.navbar,.sidebar,.actions,a.no-print{display:none!important}
    a[href]:after{content:""!important}
    tr,.receipt-header,.box{break-inside:avoid;page-break-inside:avoid}
  }
</style>
{% endblock %}

{% block content %}
{% set _receipt_no = payment.receipt_number or payment.payment_number or payment.id %}
{% set _dir = ((payment.direction.value if payment.direction and payment.direction.value else payment.direction) or '')|string|upper %}

<div id="receipt">
  <div class="receipt-header">
    <div class="brand">
      <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
      <div>
        <div class="brand-name">Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</div>
        <div class="brand-sub">ÙˆØµÙ„ Ø¯ÙØ¹</div>
      </div>
    </div>
    <div class="text-muted">
      Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„: <strong>{{ _receipt_no }}</strong><br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or 'â€”' }}
    </div>
  </div>
  <div class="brand-line"></div>

  <div class="box">
    <table class="kv">
      <tr><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</th><td>{{ '%.2f'|format(payment.total_amount or 0) }} {{ payment.currency }}</td></tr>
      <tr><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><td>{{ (payment.method.value if payment.method and payment.method.value else payment.method) or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th><td>{{ 'ÙˆØ§Ø±Ø¯' if _dir in ['IN','INCOMING'] else 'ØµØ§Ø¯Ø±' }}</td></tr>
      <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>{{ payment.status.value if payment.status and payment.status.value else payment.status or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø¬Ù‡Ø©</th><td>{{ payment.entity_label() or payment.entity_type }}</td></tr>
      <tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><td>{{ payment.reference or 'â€”' }}</td></tr>
      <tr><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>{{ payment.notes or 'â€”' }}</td></tr>
    </table>
  </div>

  {% if payment.splits %}
  <div class="box">
    <h5 style="margin-top:0;margin-bottom:8px">ğŸ’³ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©</h5>
    <table>
      <colgroup><col class="col-s-idx"><col class="col-s-amt"><col class="col-s-mth"><col class="col-s-det"></colgroup>
      <thead>
        <tr><th>#</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th><th>ØªÙØ§ØµÙŠÙ„</th></tr>
      </thead>
      <tbody>
        {% for s in payment.splits %}
          {% set m = s.method.value if s.method and s.method.value else s.method %}
          {% set d = s.details or {} %}
          <tr>
            <td style="text-align:center">{{ loop.index }}</td>
            <td class="num">{{ '%.2f'|format(s.amount or 0) }} {{ payment.currency }}</td>
            <td style="text-align:center">{{ (m or 'â€”')|upper }}</td>
            <td class="wrap">
              {% if m == 'cheque' %}
                Ø´ÙŠÙƒ: {{ d.get('check_number','â€”') }}ØŒ Ø¨Ù†Ùƒ: {{ d.get('check_bank','â€”') }}ØŒ Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ d.get('check_due_date') or d.get('due_date') or 'â€”' }}
              {% elif m == 'bank' %}
                ØªØ­ÙˆÙŠÙ„: {{ d.get('bank_transfer_ref','â€”') }}
              {% elif m == 'card' %}
                Ø¨Ø·Ø§Ù‚Ø©: ****{{ d.get('card_last4') or (d.get('card_number','')|string)[-4:] }}ØŒ Ø­Ø§Ù…Ù„: {{ d.get('card_holder','â€”') }}ØŒ Ø§Ù†ØªÙ‡Ø§Ø¡: {{ d.get('card_expiry','â€”') }}
              {% elif m == 'online' %}
                Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ({{ d.get('gateway','â€”') }})
              {% else %} â€” {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <div class="sign-row">
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
  </div>

  <div class="text-center mt-3 no-print">
    <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <a class="btn btn-secondary" href="{{ url_for('payments.view_payment', payment_id=payment.id) }}">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>
  </div>
</div>

<div class="receipt-footer">
  Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ â€” Ù†ØªØ´Ø±Ù Ø¨Ø®Ø¯Ù…ØªÙƒÙ… â€” Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† â€” Ø¬ÙˆØ§Ù„: 0592800646 â€” ÙˆØ§ØªØ³Ø§Ø¨: +970592800646
</div>
{% endblock %}
