{% extends "base_print.html" %}
{% block title %}وصل دفع{% endblock %}

{% block head_extra %}
{% set _size = (request.args.get('s', 'a4')|lower) %}
{% set _ori  = (request.args.get('o', 'portrait')|lower) %}
{% set W,H = (148,210) if _size == 'a5' else (210,297) %}
{% set PW,PH = (H,W) if _ori == 'landscape' else (W,H) %}
{% set MT = 12 %}{% set MR = 12 %}{% set ML = 12 %}{% set footer_h = 14 %}
{% set MB = MT + footer_h %}
{% set content_w = PW - (ML + MR) %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">

<style>
  @page { size: {{ PW }}mm {{ PH }}mm; margin: {{ MT }}mm {{ MR }}mm {{ MB }}mm {{ ML }}mm; }
  #receipt { width: {{ content_w }}mm; margin: 0 auto; padding-bottom: {{ footer_h }}mm; }
  .receipt-footer { position: fixed; left: {{ ML }}mm; right: {{ MR }}mm; bottom: {{ MT }}mm; height: {{ footer_h }}mm; padding-top: 3mm; }
  .kv { width: 100%; border-collapse: collapse; }
  .kv th, .kv td { padding: .35rem .5rem; vertical-align: top; }
  .kv th { width: 28%; white-space: nowrap; color: #555; }
  .kv td { width: 72%; }
  .num { text-align: end; white-space: nowrap; }
  .wrap { word-break: break-word; }
  .brand-line { height: 2px; background: var(--print-accent,#0d6efd); margin: .5rem 0; }
  .box { border: 1px solid #e5e5e5; border-radius: 6px; padding: .75rem; }
  .logo { height: 36px; }
  table { width: 100%; border-collapse: collapse; }
  thead th { background: #f8f9fa; }
  td, th { padding: .5rem; border: 1px solid #e9ecef; }
  .no-border td, .no-border th { border: 0; }
  .sign-row .sign { width: 45%; border-top: 1px dashed #888; padding-top: .5rem; text-align: center; }
  .no-print { margin-top: 1rem; }
  @media print { .no-print { display: none !important; } }
</style>
{% endblock %}

{% block content %}
{% set _receipt_no = payment.receipt_number or payment.payment_number or payment.id %}
{% set _dir    = ((payment.direction.value if payment.direction and payment.direction.value else payment.direction) or '')|string|upper %}
{% set _method = (payment.method.value   if payment.method   and payment.method.value   else payment.method) %}
{% set _status = (payment.status.value   if payment.status   and payment.status.value   else payment.status) %}
{% set _curr   = payment.currency or '' %}

<div id="receipt">
  <div class="receipt-header d-flex justify-content-between align-items-start">
    <div class="brand d-flex align-items-center gap-3">
      <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" onerror="this.style.display='none'">
      <div class="brand-text">
        <div class="brand-name fw-bold fs-5">المهندس الفلسطيني للمعدات الثقيلة</div>
        <div class="brand-sub text-muted">وصل دفع</div>
      </div>
    </div>
    <div class="text-muted small text-end">
      رقم الوصل: <strong>{{ _receipt_no }}</strong><br>
      التاريخ: {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or '—' }}
    </div>
  </div>

  <div class="brand-line"></div>

  <div class="box">
    <table class="kv no-border">
      <tr><th>المبلغ الكلي</th><td class="num">{{ '%.0f'|format(payment.total_amount or 0) }} {{ _curr }}</td></tr>
      <tr><th>طريقة الدفع</th><td>{{ _method or '—' }}</td></tr>
      <tr><th>الاتجاه</th><td>{{ 'وارد' if _dir in ['IN','INCOMING'] else 'صادر' }}</td></tr>
      <tr><th>الحالة</th><td>{{ _status or '—' }}</td></tr>
      <tr><th>الجهة</th><td>{{ payment.entity_label() or payment.entity_type or '—' }}</td></tr>
      <tr><th>المرجع</th><td>{{ payment.reference or '—' }}</td></tr>
      {% if payment.receiver_name %}
      <tr><th>مستلم الدفعة</th><td><strong>{{ payment.receiver_name }}</strong></td></tr>
      {% endif %}
      <tr><th>ملاحظات</th><td>{{ payment.notes or '—' }}</td></tr>
    </table>
  </div>

  {% if sale_info %}
  <div class="box mt-2">
    {% set s_curr = sale_info.currency or '' %}
    <table class="kv no-border">
      <tr><th>فاتورة بيع</th><td>#{{ sale_info.number or '—' }}</td></tr>
      <tr><th>تاريخ البيع</th><td>{{ sale_info.date or '—' }}</td></tr>
      <tr><th>الإجمالي</th><td class="num">{{ sale_info.total is not none and ('%.0f'|format(sale_info.total)) or '—' }} {{ s_curr }}</td></tr>
      <tr><th>المدفوع</th><td class="num">{{ sale_info.paid is not none and ('%.0f'|format(sale_info.paid)) or '—' }} {{ s_curr }}</td></tr>
      <tr><th>المتبقي</th><td class="num">{{ sale_info.balance is not none and ('%.0f'|format(sale_info.balance)) or '—' }} {{ s_curr }}</td></tr>
    </table>
  </div>
  {% endif %}

  {% if payment.splits %}
  <div class="box mt-2">
    <h5 class="mb-2">تفاصيل الدفعات الجزئية</h5>
    <table>
      <colgroup>
        <col style="width:50px"><col style="width:160px"><col style="width:120px"><col>
      </colgroup>
      <thead>
        <tr>
          <th>#</th>
          <th class="text-end">المبلغ</th>
          <th>الطريقة</th>
          <th>تفاصيل</th>
        </tr>
      </thead>
      <tbody>
        {% for s in payment.splits %}
          {% set m = ((s.method.value if s.method and s.method.value else s.method) or '')|lower %}
          {% set d = s.details if s.details is mapping else {} %}
          <tr>
            <td class="text-center">{{ loop.index }}</td>
            <td class="num">{{ '%.0f'|format(s.amount or 0) }} {{ _curr }}</td>
            <td class="text-center">{{ (m or '—')|upper }}</td>
            <td class="wrap">
              {% if m in ['cheque','check'] %}
                شيك: {{ d.get('check_number','—') }}، بنك: {{ d.get('check_bank','—') }}، استحقاق: {{ d.get('check_due_date') or d.get('due_date') or '—' }}
              {% elif m in ['bank','transfer','bank_transfer'] %}
                تحويل: {{ d.get('bank_transfer_ref', d.get('reference','—')) }}
              {% elif m in ['card','credit'] %}
                بطاقة: ****{{ d.get('card_last4') or (d.get('card_number','')|string)[-4:] }}، حامل: {{ d.get('card_holder','—') }}، انتهاء: {{ d.get('card_expiry','—') }}
              {% elif m in ['online','mobile'] %}
                بوابة: {{ d.get('online_gateway', d.get('gateway','—')) }}، مرجع: {{ d.get('online_ref', d.get('reference','—')) }}
              {% elif m == 'cash' %}
                نقداً
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="1" class="text-end">المجموع</th>
          <th class="num">{{ '%.0f'|format((payment.splits | map(attribute='amount') | sum) or 0) }} {{ _curr }}</th>
          <th colspan="2"></th>
        </tr>
      </tfoot>
    </table>
  </div>
  {% endif %}

  <div class="sign-row mt-3 d-flex justify-content-between">
    <div class="sign">توقيع المستلم</div>
    <div class="sign">توقيع المسؤول</div>
  </div>

  <div class="text-center mt-3 no-print">
    <button class="btn btn-dark" onclick="window.print()">طباعة</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}">تحميل PDF</a>
  </div>
</div>
{% endblock %}
