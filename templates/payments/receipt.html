{% extends "base_print.html" %}
{% block title %}ÙˆØµÙ„ Ø¯ÙØ¹{% endblock %}

{% block head_extra %}
{% set _size = (request.args.get('s', 'a4')|lower) %}
{% set _ori  = (request.args.get('o', 'portrait')|lower) %}
{% set W,H = (148,210) if _size == 'a5' else (210,297) %}
{% set PW,PH = (H,W) if _ori == 'landscape' else (W,H) %}
{% set MT = 12 %}{% set MR = 12 %}{% set ML = 12 %}{% set footer_h = 14 %}
{% set MB = MT + footer_h %}
{% set content_w = PW - (ML + MR) %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">

<style>
  @page { size: {{ PW }}mm {{ PH }}mm; margin: {{ MT }}mm {{ MR }}mm {{ MB }}mm {{ ML }}mm; }
  #receipt { width: {{ content_w }}mm; margin: 0 auto; padding-bottom: {{ footer_h }}mm; }
  .receipt-footer { position: fixed; left: {{ ML }}mm; right: {{ MR }}mm; bottom: {{ MT }}mm; height: {{ footer_h }}mm; padding-top: 3mm; }
  .kv { width: 100%; border-collapse: collapse; }
  .kv th, .kv td { padding: .35rem .5rem; vertical-align: top; }
  .kv th { width: 28%; white-space: nowrap; color: #555; }
  .kv td { width: 72%; }
  .num { text-align: end; white-space: nowrap; }
  .wrap { word-break: break-word; }
  .brand-line { height: 2px; background: var(--print-accent,#0d6efd); margin: .5rem 0; }
  .box { border: 1px solid #e5e5e5; border-radius: 6px; padding: .75rem; }
  .logo { height: 36px; }
  table { width: 100%; border-collapse: collapse; }
  thead th { background: #f8f9fa; }
  td, th { padding: .5rem; border: 1px solid #e9ecef; }
  .no-border td, .no-border th { border: 0; }
  .sign-row .sign { width: 45%; border-top: 1px dashed #888; padding-top: .5rem; text-align: center; }
  .no-print { margin-top: 1rem; }
  @media print { .no-print { display: none !important; } }
</style>
{% endblock %}

{% block content %}
{% set _receipt_no = payment.receipt_number or payment.payment_number or payment.id %}
{% set _dir    = ((payment.direction.value if payment.direction and payment.direction.value else payment.direction) or '')|string|upper %}
{% set _method = (payment.method.value   if payment.method   and payment.method.value   else payment.method) %}
{% set _status = (payment.status.value   if payment.status   and payment.status.value   else payment.status) %}
{% set _curr   = payment.currency or '' %}

<div id="receipt">
  <div class="receipt-header d-flex justify-content-between align-items-start">
    <div class="brand d-flex align-items-center gap-3">
      <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" onerror="this.style.display='none'">
      <div class="brand-text">
        <div class="brand-name fw-bold fs-5">Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</div>
        <div class="brand-sub text-muted">ÙˆØµÙ„ Ø¯ÙØ¹</div>
      </div>
    </div>
    <div class="text-muted small text-end">
      Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„: <strong>{{ _receipt_no }}</strong><br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or 'â€”' }}
    </div>
  </div>

  <div class="brand-line"></div>

  <div class="box">
    <table class="kv no-border">
      <tr><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</th><td class="num">{{ '%.0f'|format(payment.total_amount or 0) }} {{ _curr }}</td></tr>
      <tr><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><td>{{ _method or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th><td>{{ 'ÙˆØ§Ø±Ø¯' if _dir in ['IN','INCOMING'] else 'ØµØ§Ø¯Ø±' }}</td></tr>
      <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>{{ _status or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø¬Ù‡Ø©</th><td>{{ payment.entity_label() or payment.entity_type or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><td>{{ payment.reference or 'â€”' }}</td></tr>
      {% if payment.receiver_name %}
      <tr><th>Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th><td><strong>{{ payment.receiver_name }}</strong></td></tr>
      {% endif %}
      <tr><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>{{ payment.notes or 'â€”' }}</td></tr>
    </table>
  </div>

  {% if sale_info %}
  <div class="box mt-2">
    {% set s_curr = sale_info.currency or '' %}
    <table class="kv no-border">
      <tr><th>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</th><td>#{{ sale_info.number or 'â€”' }}</td></tr>
      <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹</th><td>{{ sale_info.date or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><td class="num">{{ sale_info.total is not none and ('%.0f'|format(sale_info.total)) or 'â€”' }} {{ s_curr }}</td></tr>
      <tr><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><td class="num">{{ sale_info.paid is not none and ('%.0f'|format(sale_info.paid)) or 'â€”' }} {{ s_curr }}</td></tr>
      <tr><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><td class="num">{{ sale_info.balance is not none and ('%.0f'|format(sale_info.balance)) or 'â€”' }} {{ s_curr }}</td></tr>
    </table>
  </div>
  {% endif %}

  {% if payment.splits %}
  <div class="box mt-2">
    <h5 class="mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©</h5>
    <table>
      <colgroup>
        <col style="width:50px"><col style="width:160px"><col style="width:120px"><col>
      </colgroup>
      <thead>
        <tr>
          <th>#</th>
          <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
          <th>ØªÙØ§ØµÙŠÙ„</th>
        </tr>
      </thead>
      <tbody>
        {% for s in payment.splits %}
          {% set m = ((s.method.value if s.method and s.method.value else s.method) or '')|lower %}
          {% set d = s.details if s.details is mapping else {} %}
          <tr>
            <td class="text-center">{{ loop.index }}</td>
            <td class="num">{{ '%.0f'|format(s.amount or 0) }} {{ _curr }}</td>
            <td class="text-center">{{ (m or 'â€”')|upper }}</td>
            <td class="wrap">
              {% if m in ['cheque','check'] %}
                Ø´ÙŠÙƒ: {{ d.get('check_number','â€”') }}ØŒ Ø¨Ù†Ùƒ: {{ d.get('check_bank','â€”') }}ØŒ Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ d.get('check_due_date') or d.get('due_date') or 'â€”' }}
              {% elif m in ['bank','transfer','bank_transfer'] %}
                ØªØ­ÙˆÙŠÙ„: {{ d.get('bank_transfer_ref', d.get('reference','â€”')) }}
              {% elif m in ['card','credit'] %}
                Ø¨Ø·Ø§Ù‚Ø©: ****{{ d.get('card_last4') or (d.get('card_number','')|string)[-4:] }}ØŒ Ø­Ø§Ù…Ù„: {{ d.get('card_holder','â€”') }}ØŒ Ø§Ù†ØªÙ‡Ø§Ø¡: {{ d.get('card_expiry','â€”') }}
              {% elif m in ['online','mobile'] %}
                Ø¨ÙˆØ§Ø¨Ø©: {{ d.get('online_gateway', d.get('gateway','â€”')) }}ØŒ Ù…Ø±Ø¬Ø¹: {{ d.get('online_ref', d.get('reference','â€”')) }}
              {% elif m == 'cash' %}
                Ù†Ù‚Ø¯Ø§Ù‹
              {% else %}
                â€”
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="1" class="text-end">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th class="num">{{ '%.0f'|format((payment.splits | map(attribute='amount') | sum) or 0) }} {{ _curr }}</th>
          <th colspan="2"></th>
        </tr>
      </tfoot>
    </table>
  </div>
  {% endif %}

  <div class="sign-row mt-3 d-flex justify-content-between">
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
    <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
  </div>

  <div class="text-center mt-3 no-print">
    <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('payments.payment_receipt', payment_id=payment.id, simple=1) }}">ğŸ“„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}">ØªØ­Ù…ÙŠÙ„ PDF</a>
  </div>
</div>
{% endblock %}
