{% extends "base_print.html" %}
{% block title %}وصل دفع{% endblock %}

{% block head_extra %}
{# إعدادات الورقة والهوامش #}
{% set _size = (request.args.get('s', 'a4')|lower) %}
{% set _ori = (request.args.get('o', 'portrait')|lower) %}
{% if _size == 'a5' %}
  {% set W = 148 %}{% set H = 210 %}
{% else %}
  {% set W = 210 %}{% set H = 297 %}
{% endif %}
{% if _ori == 'landscape' %}
  {% set PW = H %}{% set PH = W %}
{% else %}
  {% set PW = W %}{% set PH = H %}
{% endif %}
{% set MT = 12 %}{% set MR = 12 %}{% set ML = 12 %}{% set footer_h = 14 %}
{% set MB = MT + footer_h %}
{% set content_w = PW - (ML + MR) %}

{# ملف CSS الأساسي #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">

{# تنسيقات ديناميكية حسب الحجم والاتجاه #}
<style>
  @page {
    size: {{ PW }}mm {{ PH }}mm;
    margin: {{ MT }}mm {{ MR }}mm {{ MB }}mm {{ ML }}mm;
  }

  #receipt {
    width: {{ content_w }}mm;
    margin: 0 auto;
    padding-bottom: {{ footer_h }}mm;
  }

  .receipt-footer {
    position: fixed;
    left: {{ ML }}mm;
    right: {{ MR }}mm;
    bottom: {{ MT }}mm;
    height: {{ footer_h }}mm;
    padding-top: 3mm;
  }
</style>
{% endblock %}

{% block content %}
{% set _receipt_no = payment.receipt_number or payment.payment_number or payment.id %}
{% set _dir = ((payment.direction.value if payment.direction and payment.direction.value else payment.direction) or '')|string|upper %}

<div id="receipt">
  <div class="receipt-header">
    <div class="brand">
      <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
      <div class="brand-text">
        <div class="brand-name">المهندس الفلسطيني للمعدات الثقيلة</div>
        <div class="brand-sub">وصل دفع</div>
      </div>
    </div>
    <div class="text-muted">
      رقم الوصل: <strong>{{ _receipt_no }}</strong><br>
      التاريخ: {{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or '—' }}
    </div>
  </div>

  <div class="brand-line"></div>

  <div class="box">
    <table class="kv">
      <tr><th>المبلغ الكلي</th><td>{{ '%.2f'|format(payment.total_amount or 0) }} {{ payment.currency }}</td></tr>
      <tr><th>طريقة الدفع</th><td>{{ (payment.method.value if payment.method and payment.method.value else payment.method) or '—' }}</td></tr>
      <tr><th>الاتجاه</th><td>{{ 'وارد' if _dir in ['IN', 'INCOMING'] else 'صادر' }}</td></tr>
      <tr><th>الحالة</th><td>{{ payment.status.value if payment.status and payment.status.value else payment.status or '—' }}</td></tr>
      <tr><th>الجهة</th><td>{{ payment.entity_label() or payment.entity_type }}</td></tr>
      <tr><th>المرجع</th><td>{{ payment.reference or '—' }}</td></tr>
      <tr><th>ملاحظات</th><td>{{ payment.notes or '—' }}</td></tr>
    </table>
  </div>

  {% if sale_info %}
  <div class="box" style="margin-top:10px">
    <table class="kv">
      <tr><th>فاتورة بيع</th><td>#{{ sale_info.number or '—' }}</td></tr>
      <tr><th>تاريخ البيع</th><td>{{ sale_info.date or '—' }}</td></tr>
      <tr><th>الإجمالي</th><td>{{ sale_info.total is not none and ('%.2f'|format(sale_info.total)) or '—' }} {{ sale_info.currency or '' }}</td></tr>
      <tr><th>المدفوع</th><td>{{ sale_info.paid is not none and ('%.2f'|format(sale_info.paid)) or '—' }} {{ sale_info.currency or '' }}</td></tr>
      <tr><th>المتبقي</th><td>{{ sale_info.balance is not none and ('%.2f'|format(sale_info.balance)) or '—' }} {{ sale_info.currency or '' }}</td></tr>
    </table>
  </div>
  {% endif %}

  {% if payment.splits %}
  <div class="box" style="margin-top:10px">
    <h5 style="margin:0 0 8px">تفاصيل الدفعات الجزئية</h5>
    <table>
      <colgroup>
        <col class="col-s-idx">
        <col class="col-s-amt">
        <col class="col-s-mth">
        <col class="col-s-det">
      </colgroup>
      <thead>
        <tr>
          <th>#</th>
          <th>المبلغ</th>
          <th>الطريقة</th>
          <th>تفاصيل</th>
        </tr>
      </thead>
      <tbody>
        {% for s in payment.splits %}
          {% set m = ((s.method.value if s.method and s.method.value else s.method) or '')|lower %}
          {% set d = s.details if s.details is mapping else {} %}
          <tr>
            <td style="text-align:center">{{ loop.index }}</td>
            <td class="num">{{ '%.2f'|format(s.amount or 0) }} {{ payment.currency }}</td>
            <td style="text-align:center">{{ (m or '—')|upper }}</td>
            <td class="wrap">
              {% if m in ['cheque', 'check'] %}
                شيك: {{ d.get('check_number','—') }}، بنك: {{ d.get('check_bank','—') }}، استحقاق: {{ d.get('check_due_date') or d.get('due_date') or '—' }}
              {% elif m in ['bank','transfer'] %}
                تحويل: {{ d.get('bank_transfer_ref', d.get('reference','—')) }}
              {% elif m in ['card','credit'] %}
                بطاقة: ****{{ d.get('card_last4') or (d.get('card_number','')|string)[-4:] }}، حامل: {{ d.get('card_holder','—') }}، انتهاء: {{ d.get('card_expiry','—') }}
              {% elif m in ['online','mobile'] %}
                بوابة: {{ d.get('online_gateway', d.get('gateway','—')) }}، مرجع: {{ d.get('online_ref', d.get('reference','—')) }}
              {% elif m == 'cash' %}
                نقداً
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <div class="sign-row">
    <div class="sign">توقيع المستلم</div>
    <div class="sign">توقيع المسؤول</div>
  </div>

  <div class="text-center mt-3 no-print">
    <button class="btn btn-dark" onclick="window.print()">طباعة</button>
    <a class="btn btn-secondary" href="{{ url_for('payments.view_payment', payment_id=payment.id) }}">رجوع</a>
  </div>
</div>

<div class="receipt-footer">
  مع تحياتنا — نتشرف بخدمتكم — رام الله - فلسطين — جوال: 0592800646 — واتساب: +970592800646
</div>
{% endblock %}
