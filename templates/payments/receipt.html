{% extends "base_print.html" %}
{% block title %}ÙˆØµÙ„ Ø¯ÙØ¹{% endblock %}

{% block head_extra %}
{% set _size = (request.args.get('s', 'a4')|lower) %}
{% set _ori  = (request.args.get('o', 'portrait')|lower) %}
{% set W,H = (148,210) if _size == 'a5' else (210,297) %}
{% set PW,PH = (H,W) if _ori == 'landscape' else (W,H) %}
{% set MT = 12 %}{% set MR = 12 %}{% set ML = 12 %}{% set footer_h = 14 %}
{% set MB = MT + footer_h %}
{% set content_w = PW - (ML + MR) %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">

<style>
  @page { size: {{ PW }}mm {{ PH }}mm; margin: {{ MT }}mm {{ MR }}mm {{ MB }}mm {{ ML }}mm; }
  #receipt { width: {{ content_w }}mm; margin: 0 auto; padding-bottom: {{ footer_h }}mm; font-family:"DejaVu Sans","Amiri","Tahoma","Arial",sans-serif; color:#1f2937; font-size:11px; }
  .hero { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:10px 0 12px; border-bottom:1px solid #d1d5db; }
  .hero-brand { display:flex; align-items:center; gap:10px; }
  .hero-logo { width:42px; height:42px; border:1px solid #cbd5e1; border-radius:6px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#f8fafc; }
  .hero-logo img { max-height:32px; max-width:32px; display:block; }
  .hero-text { display:flex; flex-direction:column; gap:4px; }
  .hero-name { font-size:14px; font-weight:700; }
  .hero-sub { font-size:11px; color:#475569; text-transform:uppercase; letter-spacing:.5px; }
  .hero-meta { display:grid; gap:6px; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); }
  .meta-item { border:1px solid #e2e8f0; border-radius:6px; padding:6px 8px; background:#f8fafc; }
  .meta-label { font-size:10px; color:#64748b; text-transform:uppercase; letter-spacing:.5px; }
  .meta-value { font-size:12px; font-weight:600; margin-top:2px; color:#1e293b; }
  .summary-strip { display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); margin-top:12px; }
  .summary-pill { border:1px solid #dbeafe; background:#f1f5f9; border-radius:6px; padding:8px 10px; display:flex; flex-direction:column; gap:4px; }
  .summary-label { font-size:10px; color:#475569; text-transform:uppercase; letter-spacing:.4px; }
  .summary-value { font-size:13px; font-weight:700; color:#0f172a; }
  .summary-meta { font-size:10px; color:#64748b; }
  .section { margin-top:12px; border:1px solid #e2e8f0; border-radius:6px; padding:10px 12px; background:#fff; }
  .section-title { font-size:12px; font-weight:700; margin-bottom:8px; color:#0f172a; display:flex; align-items:center; justify-content:space-between; }
  .badge-chip { display:inline-flex; align-items:center; gap:4px; padding:3px 8px; border-radius:999px; background:#e0f2fe; color:#0f172a; font-size:10px; font-weight:600; }
  .grid-two { display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); margin-bottom:8px; }
  .data-card { border:1px solid #e2e8f0; border-radius:6px; padding:8px; background:#f8fafc; display:flex; flex-direction:column; gap:2px; }
  .data-label { font-size:10px; color:#64748b; text-transform:uppercase; letter-spacing:.4px; }
  .data-value { font-size:12px; font-weight:600; color:#0f172a; }
  .kv { width:100%; border-collapse:collapse; margin-top:4px; }
  .kv th, .kv td { padding:6px 8px; border-bottom:1px solid #eef2f7; font-size:11px; vertical-align:top; }
  .kv th { width:28%; color:#475569; font-weight:600; white-space:nowrap; }
  .kv td { color:#111827; }
  .num { text-align:end; white-space:nowrap; font-variant-numeric:tabular-nums; }
  .wrap { word-break:break-word; }
  table { width:100%; border-collapse:collapse; margin-top:8px; }
  thead th { background:#1f2937; color:#f8fafc; border:0; font-size:11px; padding:6px 8px; text-align:center; }
  td, th { padding:6px 8px; border-bottom:1px solid #d1d5db; font-size:11px; color:#1f2937; }
  tbody td { background:#f8fafc; }
  tfoot td, tfoot th { background:#e2e8f0; font-weight:600; }
  .signatures { display:flex; gap:16px; margin-top:16px; }
  .signatures .sign { flex:1; border-top:1px dashed #94a3b8; padding-top:10px; text-align:center; font-size:11px; letter-spacing:.4px; }
  .actions { margin-top:14px; display:flex; justify-content:center; gap:8px; }
  .actions .btn { padding:8px 14px; font-weight:600; font-size:11px; text-transform:uppercase; }
  .receipt-footer { position: fixed; left: {{ ML }}mm; right: {{ MR }}mm; bottom: {{ MT }}mm; height: {{ footer_h }}mm; padding-top: 2mm; text-align:center; font-size:10px; color:#64748b; }
  .no-print { margin-top:0.75rem; }
  @media print {
    .no-print { display:none !important; }
    body { background:#fff; }
  }
</style>
{% endblock %}

{% block content %}
{% set _receipt_no = payment.receipt_number or payment.payment_number or payment.id %}
{% set _dir    = ((payment.direction.value if payment.direction and payment.direction.value else payment.direction) or '')|string|upper %}
{% set _method = (payment.method.value   if payment.method   and payment.method.value   else payment.method) %}
{% set _status = (payment.status.value   if payment.status   and payment.status.value   else payment.status) %}
{% set _curr   = payment.currency or '' %}

<div id="receipt">
  <div class="hero">
    <div class="hero-brand">
      <div class="hero-logo">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="" onerror="this.closest('.hero-logo').style.display='none'">
      </div>
      <div class="hero-text">
        <div class="hero-name">{{ system_settings.company_name or 'Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©' }}</div>
        <div class="hero-sub">Payment Receipt</div>
      </div>
    </div>
    <div class="hero-meta">
      <div class="meta-item">
        <span class="meta-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</span>
        <span class="meta-value">{{ _receipt_no }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span>
        <span class="meta-value">{{ payment.payment_date and payment.payment_date.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
        <span class="meta-value">{{ current_user.username if current_user else 'â€”' }}</span>
      </div>
    </div>
  </div>

  <div class="summary-strip">
    <div class="summary-pill">
      <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø©</div>
      <div class="summary-value">{{ '%.0f'|format(payment.total_amount or 0) }} {{ _curr }}</div>
      <div class="summary-meta">{{ _method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
    </div>
    <div class="summary-pill">
      <div class="summary-label">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</div>
      <div class="summary-value">{{ 'ÙˆØ§Ø±Ø¯' if _dir in ['IN','INCOMING'] else 'ØµØ§Ø¯Ø±' }}</div>
      <div class="summary-meta">{{ _status or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
    </div>
    <div class="summary-pill">
      <div class="summary-label">Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©</div>
      <div class="summary-value">{{ payment.entity_label() or payment.entity_type or 'â€”' }}</div>
      <div class="summary-meta">{{ payment.reference or 'Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø¬Ø¹' }}</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">
      ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©
      <span class="badge-chip">{{ payment.status or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
    </div>
    <div class="grid-two">
      <div class="data-card">
        <span class="data-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</span>
        <span class="data-value">{{ '%.2f'|format(payment.total_amount or 0) }} {{ _curr }}</span>
      </div>
      <div class="data-card">
        <span class="data-label">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø£Ùˆ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span>
        <span class="data-value">{{ payment.tax_amount is not none and ('%.2f'|format(payment.tax_amount)) or '0.00' }} {{ _curr }}</span>
      </div>
      <div class="data-card">
        <span class="data-label">Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</span>
        <span class="data-value">{{ payment.subtotal is not none and ('%.2f'|format(payment.subtotal)) or ('%.2f'|format(payment.total_amount or 0)) }} {{ _curr }}</span>
      </div>
      <div class="data-card">
        <span class="data-label">Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span>
        <span class="data-value">{{ payment.payment_number or 'â€”' }}</span>
      </div>
    </div>
    <table class="kv">
      <tr><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><td>{{ _method or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th><td>{{ 'ÙˆØ§Ø±Ø¯' if _dir in ['IN','INCOMING'] else 'ØµØ§Ø¯Ø±' }}</td></tr>
      <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>{{ _status or 'â€”' }}</td></tr>
      {% if payment.deliverer_name %}
      <tr><th>Ù…Ø³Ù„Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th><td>{{ payment.deliverer_name }}</td></tr>
      {% endif %}
      {% if payment.receiver_name %}
      <tr><th>Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th><td>{{ payment.receiver_name }}</td></tr>
      {% endif %}
      <tr><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>{{ payment.notes or 'â€”' }}</td></tr>
    </table>
  </div>

  {% if sale_info %}
  <div class="section">
    <div class="section-title">
      Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
      <span class="badge-chip">Sale</span>
    </div>
    {% set s_curr = sale_info.currency or '' %}
    <table class="kv">
      <tr><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><td>#{{ sale_info.number or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><td>{{ sale_info.date or 'â€”' }}</td></tr>
      <tr><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><td class="num">{{ sale_info.total is not none and ('%.2f'|format(sale_info.total)) or 'â€”' }} {{ s_curr }}</td></tr>
      <tr><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><td class="num">{{ sale_info.paid is not none and ('%.2f'|format(sale_info.paid)) or 'â€”' }} {{ s_curr }}</td></tr>
      <tr><th>Ø§Ù„Ù…ØªÙØ¨Ù‚ÙŠ</th><td class="num">{{ sale_info.balance is not none and ('%.2f'|format(sale_info.balance)) or 'â€”' }} {{ s_curr }}</td></tr>
    </table>
  </div>
  {% endif %}

  {% if payment.splits %}
  <div class="section">
    <div class="section-title">
      ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¬Ø²Ø¦Ø©
      <span class="badge-chip">{{ payment.splits|length }} Ø¯ÙØ¹Ø©</span>
    </div>
    <table>
      <colgroup>
        <col style="width:60px"><col style="width:160px"><col style="width:140px"><col>
      </colgroup>
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
          <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
        </tr>
      </thead>
      <tbody>
        {% for s in payment.splits %}
          {% set m = ((s.method.value if s.method and s.method.value else s.method) or '')|lower %}
          {% set d = s.details if s.details is mapping else {} %}
          {% set split_curr = (s.currency or _curr) %}
          <tr>
            <td class="text-center">{{ loop.index }}</td>
            <td class="num">
              {{ '%.2f'|format(s.amount or 0) }} {{ split_curr }}
              {% if split_curr and _curr and split_curr.upper() != _curr.upper() %}
                <div class="text-muted small">â‰ˆ {{ '%.2f'|format(s.converted_amount or 0) }} {{ _curr }}</div>
              {% endif %}
            </td>
            <td class="text-center">{{ (m or 'â€”')|upper }}</td>
            <td class="wrap">
              {% if m in ['cheque','check'] %}
                Ø´ÙŠÙƒ {{ d.get('check_number','â€”') }} | Ø¨Ù†Ùƒ {{ d.get('check_bank','â€”') }} | Ø§Ø³ØªØ­Ù‚Ø§Ù‚ {{ d.get('check_due_date') or d.get('due_date') or 'â€”' }}
              {% elif m in ['bank','transfer','bank_transfer'] %}
                ØªØ­ÙˆÙŠÙ„ {{ d.get('bank_transfer_ref', d.get('reference','â€”')) }}
              {% elif m in ['card','credit'] %}
                Ø¨Ø·Ø§Ù‚Ø© ****{{ d.get('card_last4') or (d.get('card_number','')|string)[-4:] }} | Ø­Ø§Ù…Ù„ {{ d.get('card_holder','â€”') }} | Ø§Ù†ØªÙ‡Ø§Ø¡ {{ d.get('card_expiry','â€”') }}
              {% elif m in ['online','mobile'] %}
                Ø¨ÙˆØ§Ø¨Ø© {{ d.get('online_gateway', d.get('gateway','â€”')) }} | Ù…Ø±Ø¬Ø¹ {{ d.get('online_ref', d.get('reference','â€”')) }}
              {% elif m == 'cash' %}
                Ù†Ù‚Ø¯Ø§Ù‹
              {% else %}
                â€”
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="2" class="text-end">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</th>
          <th class="num">{{ '%.2f'|format((payment.splits | map(attribute='converted_amount') | sum) or payment.total_amount or 0) }} {{ _curr }}</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
  {% endif %}

  <div class="section">
    <div class="section-title">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</div>
    <div class="signatures">
      <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
      <div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
    </div>
  </div>

  <div class="actions no-print">
    <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <a class="btn btn-outline-light" href="{{ url_for('payments.payment_receipt', payment_id=payment.id, simple=1) }}">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('payments.download_receipt', payment_id=payment.id) }}">ØªØ­Ù…ÙŠÙ„ PDF</a>
  </div>
</div>
{% endblock %}
