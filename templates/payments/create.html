{# File: templates/payments/create.html #}
{% extends 'base.html' %}

{% block title %}
  {% if payment %}ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø©{% else %}Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø©{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4">
    {% if payment %}
      âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø© #{{ payment.id }}
    {% else %}
      â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
    {% endif %}
  </h3>

  {% if entity_info %}
  <div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">ğŸ“„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª {{ entity_info.type|capitalize }} Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</h5>
    </div>
    <div class="card-body">
      <div class="row gy-2">
        {% if entity_info.type in ['sale','invoice'] %}
          <div class="col-md-4"><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> {{ entity_info.number }}</div>
          <div class="col-md-4"><strong>ØªØ§Ø±ÙŠØ®Ù‡Ø§:</strong> {{ entity_info.date }}</div>
          <div class="col-md-4"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> {{ entity_info.total|number_format }} {{ entity_info.currency }}</div>
          <div class="col-md-4"><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> {{ entity_info.paid|number_format }} {{ entity_info.currency }}</div>
          <div class="col-md-4"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> {{ entity_info.balance|number_format }} {{ entity_info.currency }}</div>
        {% elif entity_info.type=='customer' %}
          <div class="col-md-6"><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ entity_info.name }}</div>
          <div class="col-md-6"><strong>Ø±ØµÙŠØ¯Ù‡:</strong> {{ entity_info.balance|number_format }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <form method="POST" id="paymentForm">
    {{ form.hidden_tag() }}
    <input type="hidden"
           id="current_entity_id"
           name="current_entity_id"
           value="{{ form.entity_id.data }}">

    <div class="row">
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">ğŸ“ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
          <div class="card-body">
            <div class="mb-3">
              {{ form.entity_type.label(class="form-label") }}
              {{ form.entity_type(id="entity_type", class="form-select") }}
              {% for e in form.entity_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              {{ form.direction.label(class="form-label") }}
              {{ form.direction(class="form-select") }}
              {% for e in form.direction.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              {{ form.status.label(class="form-label") }}
              {{ form.status(class="form-select") }}
              {% for e in form.status.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              {{ form.payment_date.label(class="form-label") }}
              {{ form.payment_date(class="form-control") }}
              {% for e in form.payment_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              {{ form.total_amount.label(class="form-label") }}
              {{ form.total_amount(class="form-control", step="0.01") }}
              {% for e in form.total_amount.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              {{ form.currency.label(class="form-label") }}
              {{ form.currency(class="form-control") }}
              {% for e in form.currency.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              {{ form.method.label(class="form-label") }}
              {{ form.method(class="form-select") }}
              {% for e in form.method.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              {{ form.notes.label(class="form-label") }}
              {{ form.notes(class="form-control", rows="3") }}
              {% for e in form.notes.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">ğŸ‘¥ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</div>
          <div class="card-body" id="entityFields">
            {% include 'payments/_entity_fields.html' %}
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">ğŸ’³ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©</div>
      <div class="card-body">
        <div id="splitsContainer">
          {% for split in form.splits %}
          <div class="split-form border p-3 mb-3">
            <h5>Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© #{{ loop.index }}</h5>
            <div class="row gy-2">
              <div class="col-md-4">
                {{ split.method.label(class="form-label") }}
                {{ split.method(class="form-select") }}
                {% for e in split.method.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4">
                {{ split.amount.label(class="form-label") }}
                {{ split.amount(class="form-control", step="0.01") }}
                {% for e in split.amount.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-danger remove-split" {% if loop.first %}disabled{% endif %}>Ø­Ø°Ù</button>
              </div>
            </div>
            <div class="split-details mt-3" style="display: none;">
              <div class="row gy-2">
                <div class="col-md-4">
                  {{ split.check_number.label(class="form-label") }}
                  {{ split.check_number(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ split.check_bank.label(class="form-label") }}
                  {{ split.check_bank(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ split.check_due_date.label(class="form-label") }}
                  {{ split.check_due_date(class="form-control") }}
                </div>
              </div>
              <div class="row gy-2 mt-2">
                <div class="col-md-6">
                  {{ split.card_number.label(class="form-label") }}
                  {{ split.card_number(class="form-control") }}
                </div>
                <div class="col-md-6">
                  {{ split.bank_transfer_ref.label(class="form-label") }}
                  {{ split.bank_transfer_ref(class="form-control") }}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        <button type="button" id="addSplit" class="btn btn-secondary">+ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©</button>
      </div>
    </div>

    <button type="submit" class="btn btn-success btn-lg">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/payment_form.js') }}"></script>
{% endblock %}
