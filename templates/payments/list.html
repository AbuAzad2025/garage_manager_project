{% extends 'base.html' %}
{% block title %}سندات الدفع{% if supplier %} — {{ supplier.name }}{% endif %}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold mb-0">
      <i class="fas fa-money-check-alt me-2"></i>
      {% if supplier %}
        سندات دفع المورد: <span class="text-primary">{{ supplier.name }}</span>
      {% else %}
        جميع سندات الدفع
      {% endif %}
    </h2>
    <a id="btnAddPayment" href="{% if supplier %}{{ url_for('payments.create_payment', entity_type='SUPPLIER', entity_id=supplier.id) }}{% else %}{{ url_for('payments.create_payment') }}{% endif %}" class="btn btn-success">
      <i class="fas fa-plus"></i> إضافة سند دفع
    </a>
  </div>

  {% if total_paid is not none %}
    <div class="alert alert-info">إجمالي المدفوع: {{ '%.2f'|format(total_paid) }}</div>
  {% endif %}

  {% if supplier %}
    <input type="hidden" id="prefilter_entity_type" value="SUPPLIER">
    <input type="hidden" id="prefilter_entity_id" value="{{ supplier.id }}">
  {% endif %}

  <div class="row mb-4 g-2 align-items-end">
    <div class="col-auto">
      <label for="filterEntity" class="form-label">الكيان</label>
      <select id="filterEntity" class="form-select">
        <option value="">الكل</option>
        <option value="CUSTOMER">عميل</option>
        <option value="SUPPLIER">مورد</option>
        <option value="PARTNER">شريك</option>
        <option value="SALE">بيع</option>
        <option value="SERVICE">صيانة</option>
        <option value="EXPENSE">مصروف</option>
        <option value="LOAN">تسوية قرض</option>
        <option value="PREORDER">طلب مسبق</option>
        <option value="SHIPMENT">شحنة</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterStatus" class="form-label">الحالة</label>
      <select id="filterStatus" class="form-select">
        <option value="">الكل</option>
        <option value="COMPLETED">مكتملة</option>
        <option value="PENDING">قيد الانتظار</option>
        <option value="FAILED">فاشلة</option>
        <option value="REFUNDED">مُرجعة</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterDirection" class="form-label">الاتجاه</label>
      <select id="filterDirection" class="form-select">
        <option value="">الكل</option>
        <option value="INCOMING">وارد</option>
        <option value="OUTGOING">صادر</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterMethod" class="form-label">الطريقة</label>
      <select id="filterMethod" class="form-select">
        <option value="">الكل</option>
        <option value="cash">نقداً</option>
        <option value="cheque">شيك</option>
        <option value="bank">تحويل بنكي</option>
        <option value="card">بطاقة</option>
        <option value="online">إلكتروني</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="startDate" class="form-label">من تاريخ</label>
      <input type="date" id="startDate" class="form-control">
    </div>
    <div class="col-auto">
      <label for="endDate" class="form-label">إلى تاريخ</label>
      <input type="date" id="endDate" class="form-control">
    </div>
  </div>

  <div class="card shadow-sm rounded-4">
    <div class="card-body p-0">
      <table id="paymentsTable" class="table table-hover table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:70px">#</th>
            <th>التاريخ</th>
            <th>المبلغ</th>
            <th>العملة</th>
            <th>الطريقة</th>
            <th>الاتجاه</th>
            <th>الحالة</th>
            <th>الكيان</th>
            <th style="width:110px">إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card-footer">
      <nav>
        <ul id="pagination" class="pagination justify-content-center mb-0"></ul>
      </nav>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var etHidden = document.getElementById('prefilter_entity_type');
      if (etHidden && etHidden.value && document.getElementById('filterEntity')) {
        document.getElementById('filterEntity').value = etHidden.value;
      }
      var btn = document.getElementById('btnAddPayment');
      if (btn) {
        var hidType = document.getElementById('prefilter_entity_type') ? document.getElementById('prefilter_entity_type').value : '';
        var hidId = document.getElementById('prefilter_entity_id') ? document.getElementById('prefilter_entity_id').value : '';
        var qs = new URLSearchParams(location.search);
        var qsType = (qs.get('entity_type') || '').toUpperCase();
        var qsId = qs.get('entity_id') || '';
        var et = hidType || qsType;
        var eid = hidId || qsId;
        if (et && eid) {
          var u = new URL(btn.href, location.origin);
          if (!u.searchParams.get('entity_type')) u.searchParams.set('entity_type', et);
          if (!u.searchParams.get('entity_id')) u.searchParams.set('entity_id', eid);
          btn.href = u.toString();
        }
      }
    });
  </script>
{% endblock %}
