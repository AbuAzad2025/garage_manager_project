{% extends 'base.html' %}
{% block title %}Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ø¯ÙØ¹{% if supplier %} â€” {{ supplier.name }}{% endif %}{% endblock %}

{% block head_extra %}
<style>
/* ØªØ­Ø³ÙŠÙ† ØªØ¨Ø§ÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
.table thead th {
    background-color: #343a40 !important;
    color: white !important;
    font-weight: 600 !important;
    border-color: #454d55 !important;
}

.table tbody td {
    color: #343a40 !important;
    font-weight: 500 !important;
    vertical-align: middle !important;
}

.badge {
    padding: 6px 12px !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
}

.btn-group-sm .btn {
    font-weight: 600 !important;
}
</style>
{% endblock %}

{% block content %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-money-check-alt"></i>
                        {% if supplier %}
                            Ø³Ù†Ø¯Ø§Øª Ø¯ÙØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯: <span class="text-primary">{{ supplier.name }}</span>
                        {% else %}
                            Ø¬Ù…ÙŠØ¹ Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ø¯ÙØ¹
                        {% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li class="breadcrumb-item active">Ø§Ù„Ø¯ÙØ¹Ø§Øª</li>
                    </ol>
                </div>
            </div>
            
            <!-- Ø§Ù„Ù…Ù„Ø®ØµØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
            {% if total_incoming is defined and total_outgoing is defined %}
            <div class="row mb-3 g-3">
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white bg-success h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">ğŸ’° Ø¯ÙØ¹Ø§Øª ÙˆØ§Ø±Ø¯Ø©</h6>
                                    <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(total_incoming) }} â‚ª</h3>
                                    <small class="opacity-75">Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small>
                                </div>
                                <i class="fas fa-arrow-down fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white bg-danger h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">ğŸ’¸ Ø¯ÙØ¹Ø§Øª ØµØ§Ø¯Ø±Ø©</h6>
                                    <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(total_outgoing) }} â‚ª</h3>
                                    <small class="opacity-75">Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ø´Ø±ÙƒØ§Ø¡</small>
                                </div>
                                <i class="fas fa-arrow-up fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white {% if net_total >= 0 %}bg-primary{% else %}bg-warning{% endif %} h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">ğŸ“Š ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚</h6>
                                    <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(net_total) }} â‚ª</h3>
                                    <small class="opacity-75">ÙˆØ§Ø±Ø¯Ø© - ØµØ§Ø¯Ø±Ø©</small>
                                </div>
                                <i class="fas fa-balance-scale fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white bg-info h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">ğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h6>
                                    <h3 class="mb-0 fw-bold">{{ payments|length if payments else 0 }}</h3>
                                    <small class="opacity-75">Ø¯ÙØ¹Ø©</small>
                                </div>
                                <i class="fas fa-list fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a id="btnAddPayment"
       href="{% if supplier %}{{ url_for('payments.create_payment', entity_type='SUPPLIER', entity_id=supplier.id) }}{% else %}{{ url_for('payments.create_payment') }}{% endif %}"
       class="btn btn-success btn-lg">
      <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø¯ Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯
    </a>
  </div>
  {% if total_paid is not none %}
    <div class="alert alert-info">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: {{ '%.0f'|format(total_paid) }}</div>
  {% endif %}
  {% if supplier %}
    <input type="hidden" id="prefilter_entity_type" value="SUPPLIER">
    <input type="hidden" id="prefilter_entity_id" value="{{ supplier.id }}">
  {% endif %}
  <div class="row mb-4 g-2 align-items-end">
    <div class="col-auto">
      <label for="filterEntity" class="form-label">Ø§Ù„ÙƒÙŠØ§Ù†</label>
      <select id="filterEntity" class="form-select">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="CUSTOMER">Ø¹Ù…ÙŠÙ„</option>
        <option value="SUPPLIER">Ù…ÙˆØ±Ø¯</option>
        <option value="PARTNER">Ø´Ø±ÙŠÙƒ</option>
        <option value="SALE">Ø¨ÙŠØ¹</option>
        <option value="INVOICE">ÙØ§ØªÙˆØ±Ø©</option>
        <option value="SERVICE">ØµÙŠØ§Ù†Ø©</option>
        <option value="EXPENSE">Ù†ÙÙ‚Ø©/Ù…ØµØ±ÙˆÙ</option>
        <option value="LOAN">ØªØ³ÙˆÙŠØ© Ù‚Ø±Ø¶</option>
        <option value="PREORDER">Ø­Ø¬Ø² Ù…Ø³Ø¨Ù‚ (Ù‚Ø·Ø¹ ØºÙŠØ§Ø±)</option>
        <option value="PREORDER_SHOP">Ø­Ø¬Ø² Ù…Ø³Ø¨Ù‚ (Ù…ØªØ¬Ø±)</option>
        <option value="SHIPMENT">Ø´Ø­Ù†Ø©</option>
        <option value="PURCHASE">Ù…Ø´ØªØ±ÙŠØ§Øª</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterStatus" class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
      <select id="filterStatus" class="form-select">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="COMPLETED">Ù…ÙƒØªÙ…Ù„Ø©</option>
        <option value="PENDING">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
        <option value="FAILED">ÙØ§Ø´Ù„Ø©</option>
        <option value="REFUNDED">Ù…ÙØ±Ø¬Ø¹Ø©</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterDirection" class="form-label">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label>
      <select id="filterDirection" class="form-select">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="INCOMING">ÙˆØ§Ø±Ø¯</option>
        <option value="OUTGOING">ØµØ§Ø¯Ø±</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterMethod" class="form-label">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</label>
      <select id="filterMethod" class="form-select">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="cash">Ù†Ù‚Ø¯Ø§Ù‹</option>
        <option value="cheque">Ø´ÙŠÙƒ</option>
        <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
        <option value="card">Ø¨Ø·Ø§Ù‚Ø©</option>
        <option value="online">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
        <option value="mobile">Ù…Ø­ÙØ¸Ø©/Ù…ÙˆØ¨Ø§ÙŠÙ„</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="startDate" class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="startDate" class="form-control">
    </div>
    <div class="col-auto">
      <label for="endDate" class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="endDate" class="form-control">
    </div>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ÙƒØªÙ…Ù„</div>
          <div id="totalIncoming" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">Ø§Ù„ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙƒØªÙ…Ù„</div>
          <div id="totalOutgoing" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">Ø§Ù„ØµØ§ÙÙŠ</div>
          <div id="netTotal" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div>
          <div id="grandTotal" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
  </div>
  <div class="card shadow-sm rounded-4">
    <div class="card-body p-0">
      <table id="paymentsTable" class="table table-hover table-bordered align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th style="width:60px">#</th>
            <th style="width:110px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th style="width:120px">Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th style="width:70px">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
            <th style="width:100px">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</th>
            <th style="width:130px">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø´ÙŠÙƒÙ„</th>
            <th style="width:150px">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
            <th style="width:90px">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</th>
            <th style="width:100px">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th style="min-width:250px">Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ù…Ø±Ø¬Ø¹</th>
            <th style="width:200px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card-footer">
      <nav><ul id="pagination" class="pagination justify-content-center mb-0"></ul></nav>
    </div>
  </div>

        </div>
    </section>
</div>

<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">
<div id="vendors-config" data-pay-url="{{ url_for('payments.create_payment') }}">{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>
  <script src="{{ url_for('static', filename='js/vendors.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var etHidden = document.getElementById('prefilter_entity_type');
      if (etHidden && etHidden.value && document.getElementById('filterEntity')) {
        document.getElementById('filterEntity').value = etHidden.value;
      }
      var btn = document.getElementById('btnAddPayment');
      if (btn) {
        var hidType = document.getElementById('prefilter_entity_type')?.value || '';
        var hidId   = document.getElementById('prefilter_entity_id')?.value   || '';
        var qs = new URLSearchParams(location.search);
        var qsType = (qs.get('entity_type') || '').toUpperCase();
        var qsId   = qs.get('entity_id') || '';
        var et  = hidType || qsType;
        var eid = hidId   || qsId;
        if (et && eid) {
          var u = new URL(btn.href, location.origin);
          if (!u.searchParams.get('entity_type')) u.searchParams.set('entity_type', et);
          if (!u.searchParams.get('entity_id'))   u.searchParams.set('entity_id', eid);
          btn.href = u.toString();
        }
      }
    });
  </script>
{% endblock %}
