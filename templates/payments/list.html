{% extends 'base.html' %}
{% block title %}ุณูุฏุงุช ุงูุฏูุน{% if supplier %} โ {{ supplier.name }}{% endif %}{% endblock %}

{% block head_extra %}
<style>
/* ุชุญุณูู ุชุจุงูู ุงูุฃููุงู */
.table thead th {
    background-color: #343a40 !important;
    color: white !important;
    font-weight: 600 !important;
    border-color: #454d55 !important;
}

.table tbody td {
    color: #343a40 !important;
    font-weight: 500 !important;
    vertical-align: middle !important;
}

.badge {
    padding: 6px 12px !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
}

.btn-group-sm .btn {
    font-weight: 600 !important;
}
</style>
{% endblock %}

{% block content %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-money-check-alt"></i>
                        {% if supplier %}
                            ุณูุฏุงุช ุฏูุน ุงูููุฑุฏ: <span class="text-primary">{{ supplier.name }}</span>
                        {% else %}
                            ุฌููุน ุณูุฏุงุช ุงูุฏูุน
                        {% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">ุงูุฑุฆูุณูุฉ</a></li>
                        <li class="breadcrumb-item active">ุงูุฏูุนุงุช</li>
                    </ol>
                </div>
            </div>
            
            <!-- ุงูููุฎุตุงุช ุงููุงููุฉ -->
            {% if total_incoming is defined and total_outgoing is defined %}
            <div class="row mb-3 g-3">
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white bg-success h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">๐ฐ ุฏูุนุงุช ูุงุฑุฏุฉ</h6>
                                    <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(total_incoming) }} โช</h3>
                                    <small class="opacity-75">ูู ุงูุนููุงุก</small>
                                </div>
                                <i class="fas fa-arrow-down fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white bg-danger h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">๐ธ ุฏูุนุงุช ุตุงุฏุฑุฉ</h6>
                                    <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(total_outgoing) }} โช</h3>
                                    <small class="opacity-75">ููููุฑุฏูู ูุงูุดุฑูุงุก</small>
                                </div>
                                <i class="fas fa-arrow-up fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white {% if net_total >= 0 %}bg-primary{% else %}bg-warning{% endif %} h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">๐ ุตุงูู ุงูุชุฏูู</h6>
                                    <h3 class="mb-0 fw-bold">{{ "{:,.2f}".format(net_total) }} โช</h3>
                                    <small class="opacity-75">ูุงุฑุฏุฉ - ุตุงุฏุฑุฉ</small>
                                </div>
                                <i class="fas fa-balance-scale fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-white bg-info h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">๐ณ ุฅุฌูุงูู ุงูุฏูุนุงุช</h6>
                                    <h3 class="mb-0 fw-bold">{{ payments|length if payments else 0 }}</h3>
                                    <small class="opacity-75">ุฏูุนุฉ</small>
                                </div>
                                <i class="fas fa-list fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a id="btnAddPayment"
       href="{% if supplier %}{{ url_for('payments.create_payment', entity_type='SUPPLIER', entity_id=supplier.id) }}{% else %}{{ url_for('payments.create_payment') }}{% endif %}"
       class="btn btn-success btn-lg">
      <i class="fas fa-plus-circle"></i> ุฅูุดุงุก ุณูุฏ ุฏูุน ุฌุฏูุฏ
    </a>
  </div>
  {% if total_paid is not none %}
    <div class="alert alert-info">ุฅุฌูุงูู ุงููุฏููุน: {{ '%.0f'|format(total_paid) }}</div>
  {% endif %}
  {% if supplier %}
    <input type="hidden" id="prefilter_entity_type" value="SUPPLIER">
    <input type="hidden" id="prefilter_entity_id" value="{{ supplier.id }}">
  {% endif %}
  <div class="row mb-4 g-2 align-items-end">
    <div class="col-auto">
      <label for="filterEntity" class="form-label">ุงูููุงู</label>
      <select id="filterEntity" class="form-select">
        <option value="">ุงููู</option>
        <option value="CUSTOMER">ุนููู</option>
        <option value="SUPPLIER">ููุฑุฏ</option>
        <option value="PARTNER">ุดุฑูู</option>
        <option value="SALE">ุจูุน</option>
        <option value="INVOICE">ูุงุชูุฑุฉ</option>
        <option value="SERVICE">ุตูุงูุฉ</option>
        <option value="EXPENSE">ูููุฉ/ูุตุฑูู</option>
        <option value="LOAN">ุชุณููุฉ ูุฑุถ</option>
        <option value="PREORDER">ุญุฌุฒ ูุณุจู (ูุทุน ุบูุงุฑ)</option>
        <option value="PREORDER_SHOP">ุญุฌุฒ ูุณุจู (ูุชุฌุฑ)</option>
        <option value="SHIPMENT">ุดุญูุฉ</option>
        <option value="PURCHASE">ูุดุชุฑูุงุช</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterStatus" class="form-label">ุงูุญุงูุฉ</label>
      <select id="filterStatus" class="form-select">
        <option value="">ุงููู</option>
        <option value="COMPLETED">ููุชููุฉ</option>
        <option value="PENDING">ููุฏ ุงูุงูุชุธุงุฑ</option>
        <option value="FAILED">ูุงุดูุฉ</option>
        <option value="REFUNDED">ููุฑุฌุนุฉ</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterDirection" class="form-label">ุงูุงุชุฌุงู</label>
      <select id="filterDirection" class="form-select">
        <option value="">ุงููู</option>
        <option value="INCOMING">ูุงุฑุฏ</option>
        <option value="OUTGOING">ุตุงุฏุฑ</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterMethod" class="form-label">ุงูุทุฑููุฉ</label>
      <select id="filterMethod" class="form-select">
        <option value="">ุงููู</option>
        <option value="cash">ููุฏุงู</option>
        <option value="cheque">ุดูู</option>
        <option value="bank">ุชุญููู ุจููู</option>
        <option value="card">ุจุทุงูุฉ</option>
        <option value="online">ุฅููุชุฑููู</option>
        <option value="mobile">ูุญูุธุฉ/ููุจุงูู</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="startDate" class="form-label">ูู ุชุงุฑูุฎ</label>
      <input type="date" id="startDate" class="form-control">
    </div>
    <div class="col-auto">
      <label for="endDate" class="form-label">ุฅูู ุชุงุฑูุฎ</label>
      <input type="date" id="endDate" class="form-control">
    </div>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">ุงููุงุฑุฏ ุงูููุชูู</div>
          <div id="totalIncoming" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">ุงูุตุงุฏุฑ ุงูููุชูู</div>
          <div id="totalOutgoing" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">ุงูุตุงูู</div>
          <div id="netTotal" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">ุงูุฅุฌูุงูู ุงูููู</div>
          <div id="grandTotal" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
  </div>
  <div class="card shadow-sm rounded-4">
    <div class="card-body p-0">
      <table id="paymentsTable" class="table table-hover table-bordered align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th style="width:60px">#</th>
            <th style="width:110px">ุงูุชุงุฑูุฎ</th>
            <th style="width:120px">ุงููุจูุบ</th>
            <th style="width:70px">ุงูุนููุฉ</th>
            <th style="width:100px">ุณุนุฑ ุงูุตุฑู</th>
            <th style="width:130px">ุงููุจูุบ ุจุงูุดููู</th>
            <th style="width:150px">ุงูุทุฑููุฉ</th>
            <th style="width:90px">ุงูุงุชุฌุงู</th>
            <th style="width:100px">ุงูุญุงูุฉ</th>
            <th style="min-width:250px">ุงูุชูุงุตูู ูุงููุฑุฌุน</th>
            <th style="width:200px">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card-footer">
      <nav><ul id="pagination" class="pagination justify-content-center mb-0"></ul></nav>
    </div>
  </div>

        </div>
    </section>
</div>

<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">
<div id="vendors-config" data-pay-url="{{ url_for('payments.create_payment') }}">{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>
  <script src="{{ url_for('static', filename='js/vendors.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var etHidden = document.getElementById('prefilter_entity_type');
      if (etHidden && etHidden.value && document.getElementById('filterEntity')) {
        document.getElementById('filterEntity').value = etHidden.value;
      }
      var btn = document.getElementById('btnAddPayment');
      if (btn) {
        var hidType = document.getElementById('prefilter_entity_type')?.value || '';
        var hidId   = document.getElementById('prefilter_entity_id')?.value   || '';
        var qs = new URLSearchParams(location.search);
        var qsType = (qs.get('entity_type') || '').toUpperCase();
        var qsId   = qs.get('entity_id') || '';
        var et  = hidType || qsType;
        var eid = hidId   || qsId;
        if (et && eid) {
          var u = new URL(btn.href, location.origin);
          if (!u.searchParams.get('entity_type')) u.searchParams.set('entity_type', et);
          if (!u.searchParams.get('entity_id'))   u.searchParams.set('entity_id', eid);
          btn.href = u.toString();
        }
      }
    });
  </script>
{% endblock %}
