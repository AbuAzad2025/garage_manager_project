{% extends 'base.html' %}
{% block title %}سندات الدفع{% if supplier %} — {{ supplier.name }}{% endif %}{% endblock %}

{% block head_extra %}
<style>
/* تحسين تباين الألوان */
.table thead th {
    background-color: #343a40 !important;
    color: white !important;
    font-weight: 600 !important;
    border-color: #454d55 !important;
}

.table tbody td {
    color: #343a40 !important;
    font-weight: 500 !important;
    vertical-align: middle !important;
}

.badge {
    padding: 6px 12px !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
}

.btn-group-sm .btn {
    font-weight: 600 !important;
}
.print-controls { display: flex; gap: .5rem; }
.screen-only { display: block; }
.print-only { display: none !important; }
.print-header-info,
.print-partner-info,
.print-footer-info { display: none !important; }
.print-partner-info .label { font-weight: 600; white-space: nowrap; }
.print-partner-info .value { font-weight: 500; }
@media print {
  @page { size: A4 portrait; margin: 12mm 10mm; }
  html, body { margin: 0; padding: 0 6mm; font-family: "Cairo", system-ui, Arial, sans-serif; font-size: 6pt; line-height: 1.2; background: white; }
  .no-print, .screen-only { display: none !important; }
  .print-only,
  .print-header-info,
  .print-partner-info,
  .print-footer-info { display: block !important; }
  .print-header-info { border: 1px solid #000; padding: 6px; margin: 8mm 0 4mm; text-align: center; background: #f8f9fa; font-size: 7pt; }
  .print-header-info h2 { margin: 0 0 2px; font-size: 12pt; }
  .print-partner-info { border: 1px solid #000; padding: 6px; margin-bottom: 6mm; font-size: 6pt; background: #fff; }
  .print-partner-info table { width: 100%; border-collapse: collapse; }
  .print-partner-info td { padding: 2px 4px; border: none; }
  table.printable-table { width: 100% !important; border-collapse: collapse !important; font-size: 5.5pt !important; table-layout: fixed; word-wrap: break-word; margin: 0 auto !important; }
  table.printable-table th, table.printable-table td { border: 0.4px solid #454545 !important; padding: 1px 2px !important; word-break: break-word; white-space: normal; }
  table.printable-table thead th { background: #e0e0e0 !important; font-size: 6pt !important; }
  #partnerLedgerTable th:nth-child(1), #partnerLedgerTable td:nth-child(1) { width: 10%; }
  #partnerLedgerTable th:nth-child(2), #partnerLedgerTable td:nth-child(2) { width: 36%; }
  #partnerLedgerTable th:nth-child(3), #partnerLedgerTable td:nth-child(3) { width: 9%; }
  #partnerLedgerTable th:nth-child(4), #partnerLedgerTable td:nth-child(4) { width: 11%; }
  #partnerLedgerTable th:nth-child(5), #partnerLedgerTable td:nth-child(5) { width: 17%; }
  #partnerLedgerTable th:nth-child(6), #partnerLedgerTable td:nth-child(6) { width: 17%; }
  #paymentsTable th:nth-child(1), #paymentsTable td:nth-child(1) { width: 4%; }
  #paymentsTable th:nth-child(2), #paymentsTable td:nth-child(2) { width: 8%; }
  #paymentsTable th:nth-child(3), #paymentsTable td:nth-child(3) { width: 8%; }
  #paymentsTable th:nth-child(4), #paymentsTable td:nth-child(4) { width: 6%; }
  #paymentsTable th:nth-child(5), #paymentsTable td:nth-child(5) { width: 7%; }
  #paymentsTable th:nth-child(6), #paymentsTable td:nth-child(6) { width: 9%; }
  #paymentsTable th:nth-child(7), #paymentsTable td:nth-child(7) { width: 9%; }
  #paymentsTable th:nth-child(8), #paymentsTable td:nth-child(8) { width: 7%; }
  #paymentsTable th:nth-child(9), #paymentsTable td:nth-child(9) { width: 7%; }
  #paymentsTable th:nth-child(10), #paymentsTable td:nth-child(10) { width: 15%; }
  #paymentsTable th:nth-child(11), #paymentsTable td:nth-child(11) { width: 10%; }
  .printable-table tbody tr:nth-child(even) { background: #fafafa !important; }
}
</style>
{% endblock %}

{% block content %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="print-header-info">
                <h2>كشف حساب الشريك</h2>
                <div class="meta">بتاريخ: {{ now()|format_datetime }}</div>
            </div>
            {% if selected_partner %}
            <div class="print-partner-info">
                <table>
                    <tr>
                        <td class="label">اسم الشريك</td>
                        <td class="value">{{ selected_partner.name }}</td>
                        <td class="label">رقم الشريك</td>
                        <td class="value">{{ selected_partner.id }}</td>
                    </tr>
                    <tr>
                        <td class="label">الرصيد الحالي</td>
                        <td class="value">{{ '%.2f'|format(selected_partner.balance) }} ₪</td>
                        {% if partner_ledger %}
                        <td class="label">الفترة</td>
                        <td class="value">{{ partner_ledger.date_from.strftime('%Y-%m-%d') }} → {{ partner_ledger.date_to.strftime('%Y-%m-%d') }}</td>
                        {% else %}
                        <td class="label"></td>
                        <td class="value"></td>
                        {% endif %}
                    </tr>
                </table>
            </div>
            {% endif %}
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-money-check-alt"></i>
                        {% if supplier %}
                            سندات دفع المورد: <span class="text-primary">{{ supplier.name }}</span>
                        {% else %}
                            جميع سندات الدفع
                        {% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item active">الدفعات</li>
                    </ol>
                </div>
            </div>
            
            <!-- الملخصات المالية -->
            {% if total_incoming is defined and total_outgoing is defined %}
            <div class="row g-3 mb-3">
                <div class="col-md-3 col-6">
                    <div class="card border-0 shadow-sm text-white bg-success">
                        <div class="card-body">
                            <div class="text-white-50 small mb-1">دفعات واردة</div>
                            <div class="display-6 fw-bold">{{ "{:,.2f}".format(total_incoming) }} ₪</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card border-0 shadow-sm text-white bg-danger">
                        <div class="card-body">
                            <div class="text-white-50 small mb-1">دفعات صادرة</div>
                            <div class="display-6 fw-bold">{{ "{:,.2f}".format(total_outgoing) }} ₪</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card border-0 shadow-sm text-white {% if net_total >= 0 %}bg-primary{% else %}bg-warning text-dark{% endif %}">
                        <div class="card-body">
                            <div class="text-white-50 small mb-1">صافي التدفق</div>
                            <div class="display-6 fw-bold">{{ "{:,.2f}".format(net_total) }} ₪</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card border-0 shadow-sm text-white bg-info">
                        <div class="card-body">
                            <div class="text-white-50 small mb-1">عدد السندات</div>
                            <div class="display-6 fw-bold">{{ payments|length if payments else 0 }}</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
{% if selected_partner %}
  <div class="alert {% if selected_partner.balance >= 0 %}alert-success{% else %}alert-danger{% endif %} shadow-sm d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
    <div>
      <strong>الشريك:</strong> {{ selected_partner.name }} (ID: {{ selected_partner.id }})
    </div>
    <div class="d-flex align-items-center gap-2">
      <div><strong>الرصيد الحالي:</strong> {{ '%.2f'|format(selected_partner.balance) }} ₪</div>
      {% if selected_partner.balance_source == 'smart' %}
        <span class="badge bg-success">احتساب ذكي</span>
      {% else %}
        <span class="badge bg-secondary">رصيد مخزن</span>
      {% endif %}
      <button type="button" class="btn btn-outline-light btn-sm btn-print-section" data-print-target="partnerLedgerTable" data-print-title="كشف حساب الشريك">طباعة</button>
    </div>
  </div>
  {% if partner_ledger and partner_ledger.entries %}
  <div class="card shadow-sm mb-4 screen-only" id="partnerLedgerCard">
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom bg-light no-print">
        <h5 class="mb-0">كشف حساب الشريك</h5>
        <button type="button" class="btn btn-outline-primary btn-sm btn-print-section" data-print-target="partnerLedgerPrintTable" data-print-title="كشف حساب الشريك">طباعة الجدول</button>
      </div>
      <div class="table-responsive">
        <table class="table table-striped mb-0 table-sm printable-table" id="partnerLedgerTable">
          <thead class="table-light">
            <tr>
              <th style="width:140px">التاريخ</th>
              <th>البيان</th>
              <th style="width:120px">النوع</th>
              <th style="width:130px">المبلغ</th>
              <th style="width:150px">الرصيد بعد الحركة</th>
              <th style="width:160px">مرجع</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in partner_ledger.entries %}
            {% set entry_date = entry.date %}
            {% if entry_date is not none and entry_date.__class__.__name__ == 'datetime' %}
              {% set date_text = entry_date.strftime('%Y-%m-%d') %}
            {% else %}
              {% set date_text = entry_date if entry_date else '' %}
            {% endif %}
            <tr>
              <td>{{ date_text }}</td>
              <td>{{ entry.label }}</td>
              <td>
                {% if entry.direction == 'credit' %}
                  <span class="badge bg-success">له</span>
                {% elif entry.direction == 'debit' %}
                  <span class="badge bg-danger">عليه</span>
                {% else %}
                  <span class="badge bg-secondary">رصيد افتتاحي</span>
                {% endif %}
              </td>
              <td>{{ '%.2f'|format(entry.amount) }} ₪</td>
              <td>{{ '%.2f'|format(entry.running_balance) }} ₪</td>
              <td>{{ entry.reference or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="print-only" id="partnerLedgerPrint">
    {% set totals = namespace(debit=0.0, credit=0.0) %}
    <table id="partnerLedgerPrintTable" class="printable-table">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>البيان</th>
          <th>مدين</th>
          <th>دائن</th>
          <th>الرصيد</th>
          <th>مرجع</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in partner_ledger.entries %}
        {% set totals.debit = totals.debit + (entry.debit or 0) %}
        {% set totals.credit = totals.credit + (entry.credit or 0) %}
        <tr>
          <td>{{ entry.date.strftime('%Y-%m-%d') if entry.date and entry.date.__class__.__name__ == 'datetime' else entry.date }}</td>
          <td>
            {% if entry.direction == 'credit' %}له{% elif entry.direction == 'debit' %}عليه{% else %}رصيد افتتاحي{% endif %} - {{ entry.label }}
          </td>
          <td style="text-align:end;">{{ '%.2f'|format(entry.debit or 0) }}</td>
          <td style="text-align:end;">{{ '%.2f'|format(entry.credit or 0) }}</td>
          <td style="text-align:end;">{{ '%.2f'|format(entry.running_balance or 0) }}</td>
          <td>{{ entry.reference or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="2">الإجمالي</th>
          <th style="text-align:end;">{{ '%.2f'|format(totals.debit) }}</th>
          <th style="text-align:end;">{{ '%.2f'|format(totals.credit) }}</th>
          <th style="text-align:end;">{{ '%.2f'|format(partner_ledger.closing_balance) }}</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
  {% endif %}
{% endif %}
  <div class="screen-only">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a id="btnAddPayment"
       href="{% if supplier %}{{ url_for('payments.create_payment', entity_type='SUPPLIER', entity_id=supplier.id) }}{% else %}{{ url_for('payments.create_payment') }}{% endif %}"
       class="btn btn-success btn-lg">
      <i class="fas fa-plus-circle"></i> إنشاء سند دفع جديد
    </a>
  </div>
  {% if total_paid is not none %}
    <div class="alert alert-info">إجمالي المدفوع: {{ '%.0f'|format(total_paid) }}</div>
  {% endif %}
  {% if supplier %}
    <input type="hidden" id="prefilter_entity_type" value="SUPPLIER">
    <input type="hidden" id="prefilter_entity_id" value="{{ supplier.id }}">
  {% endif %}
  <div class="row mb-4 g-2 align-items-end">
    <div class="col-auto">
      <label for="filterEntity" class="form-label">الكيان</label>
      <select id="filterEntity" class="custom-select">
        <option value="">الكل</option>
        <option value="CUSTOMER">عميل</option>
        <option value="SUPPLIER">مورد</option>
        <option value="PARTNER">شريك</option>
        <option value="SALE">بيع</option>
        <option value="INVOICE">فاتورة</option>
        <option value="SERVICE">صيانة</option>
        <option value="EXPENSE">نفقة/مصروف</option>
        <option value="LOAN">تسوية قرض</option>
        <option value="PREORDER">حجز مسبق (قطع غيار)</option>
        <option value="PREORDER_SHOP">حجز مسبق (متجر)</option>
        <option value="SHIPMENT">شحنة</option>
        <option value="PURCHASE">مشتريات</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterStatus" class="form-label">الحالة</label>
      <select id="filterStatus" class="custom-select">
        <option value="">الكل</option>
        <option value="COMPLETED">مكتملة</option>
        <option value="PENDING">قيد الانتظار</option>
        <option value="FAILED">فاشلة</option>
        <option value="REFUNDED">مُرجعة</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterDirection" class="form-label">الاتجاه</label>
      <select id="filterDirection" class="custom-select">
        <option value="">الكل</option>
        <option value="INCOMING">وارد</option>
        <option value="OUTGOING">صادر</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="filterMethod" class="form-label">الطريقة</label>
      <select id="filterMethod" class="custom-select">
        <option value="">الكل</option>
        <option value="cash">نقداً</option>
        <option value="cheque">شيك</option>
        <option value="bank">تحويل بنكي</option>
        <option value="card">بطاقة</option>
        <option value="online">إلكتروني</option>
        <option value="mobile">محفظة/موبايل</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="startDate" class="form-label">من تاريخ</label>
      <input type="date" id="startDate" class="form-control">
    </div>
    <div class="col-auto">
      <label for="endDate" class="form-label">إلى تاريخ</label>
      <input type="date" id="endDate" class="form-control">
    </div>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">الوارد المكتمل</div>
          <div id="totalIncoming" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">الصادر المكتمل</div>
          <div id="totalOutgoing" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">الصافي</div>
          <div id="netTotal" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted small mb-1">الإجمالي الكلي</div>
          <div id="grandTotal" class="fs-5 fw-bold">0</div>
        </div>
      </div>
    </div>
  </div>
  <div class="card shadow-sm rounded-4" id="paymentsCard" {% if not payments %}style="display:none"{% endif %}>
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom bg-light no-print">
        <h5 class="mb-0">سندات الدفع</h5>
        <button type="button" class="btn btn-outline-primary btn-sm btn-print-section" data-print-target="paymentsTable" data-print-title="سندات الدفع">طباعة الجدول</button>
      </div>
      <table id="paymentsTable" class="table table-hover table-bordered align-middle mb-0 table-sm printable-table">
        <thead class="table-dark">
          <tr>
            <th style="width:60px">#</th>
            <th style="width:110px">التاريخ</th>
            <th style="width:120px">المبلغ</th>
            <th style="width:70px">العملة</th>
            <th style="width:100px">سعر الصرف</th>
            <th style="width:130px">المبلغ بالشيكل</th>
            <th style="width:150px">الطريقة</th>
            <th style="width:90px">الاتجاه</th>
            <th style="width:100px">الحالة</th>
            <th style="min-width:250px">التفاصيل والمرجع</th>
            <th style="width:200px">إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card-footer">
      <nav><ul id="pagination" class="pagination justify-content-center mb-0"></ul></nav>
    </div>
  </div>

        </div>
    </section>
</div>

<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">
<div id="vendors-config" data-pay-url="{{ url_for('payments.create_payment') }}">{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/payments.js') }}"></script>
  <script src="{{ url_for('static', filename='js/vendors.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var etHidden = document.getElementById('prefilter_entity_type');
      if (etHidden && etHidden.value && document.getElementById('filterEntity')) {
        document.getElementById('filterEntity').value = etHidden.value;
      }
      var btn = document.getElementById('btnAddPayment');
      if (btn) {
        var hidType = document.getElementById('prefilter_entity_type')?.value || '';
        var hidId   = document.getElementById('prefilter_entity_id')?.value   || '';
        var qs = new URLSearchParams(location.search);
        var qsType = (qs.get('entity_type') || '').toUpperCase();
        var qsId   = qs.get('entity_id') || '';
        var et  = hidType || qsType;
        var eid = hidId   || qsId;
        if (et && eid) {
          var u = new URL(btn.href, location.origin);
          if (!u.searchParams.get('entity_type')) u.searchParams.set('entity_type', et);
          if (!u.searchParams.get('entity_id'))   u.searchParams.set('entity_id', eid);
          btn.href = u.toString();
        }
      }
    });
  </script>
{% endblock %}
