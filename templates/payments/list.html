{# File: templates/payments/list.html #}
{% extends 'base.html' %}
{% block title %}سندات الدفع{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">
      <i class="fas fa-file-invoice-dollar me-2"></i>
      سندات الدفع لـ {{ entity_name }} «{{ entity.name }}»
    </h2>
    <a href="{{ url_for('payments.create_payment', entity_type=entity_type, entity_id=entity.id, direction='OUT') }}"
       class="btn btn-success">
      <i class="fas fa-plus"></i> إضافة دفعة
    </a>
  </div>

  {# نجمع كل برامترات الفلترة لتمريرها في روابط الترحيل #}
  {% set args = request.args.to_dict() %}

  <div class="mb-3">
    <strong>إجمالي المدفوع:</strong>
    {{ total_paid|round(2) }}
    {% if pagination.total>0 %}{{ pagination.items[0].currency }}{% endif %}
  </div>

  <div class="card shadow-sm rounded-4">
    <div class="card-body p-0">
      {% if pagination.total == 0 %}
        <p class="p-4 text-center">لا توجد دفعات حتى الآن.</p>
      {% else %}
        <table class="table table-hover table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>التاريخ</th>
              <th>المبلغ</th>
              <th>العملة</th>
              <th>طريقة الدفع</th>
              <th>اتجاه</th>
              <th>الحالة</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for pay in pagination.items %}
            <tr>
              <td>{{ loop.index + (pagination.page-1)*pagination.per_page }}</td>
              <td>{{ pay.payment_date.strftime('%Y-%m-%d') }}</td>
              <td>{{ pay.total_amount|round(2) }}</td>
              <td>{{ pay.currency }}</td>
              <td>{{ pay.method.value }}</td>
              <td>
                <span class="badge {{ pay.direction.value=='IN' and 'bg-success' or 'bg-danger' }}">
                  {{ pay.direction.value=='IN' and 'وارد' or 'صادر' }}
                </span>
              </td>
              <td>
                {% set st = pay.status.value %}
                <span class="badge
                  {% if st=='COMPLETED' %}bg-success
                  {% elif st=='PENDING'   %}bg-warning
                  {% elif st=='FAILED'    %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ st }}
                </span>
              </td>
              <td class="text-nowrap">
                <a href="{{ url_for('payments.view_payment', payment_id=pay.id) }}"
                   class="btn btn-sm btn-info">عرض</a>
                <a href="{{ url_for('payments.edit_payment', payment_id=pay.id) }}"
                   class="btn btn-sm btn-warning">تعديل</a>
                <form method="post"
                      action="{{ url_for('payments.delete_payment', payment_id=pay.id) }}"
                      style="display:inline;" onsubmit="return confirm('هل تريد حذف هذه الدفعة؟');">
                  {{ csrf_token() }}
                  <button type="submit" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <nav class="mt-3">
          <ul class="pagination justify-content-center mb-0">
            {% if pagination.has_prev %}
              <li class="page-item">
                <a class="page-link"
                   href="{{ url_for(request.endpoint, id=entity.id, page=pagination.prev_num, **args) }}">السابق</a>
              </li>
            {% endif %}
            {% for p in pagination.iter_pages() %}
              {% if p %}
                <li class="page-item {% if p==pagination.page %}active{% endif %}">
                  <a class="page-link"
                     href="{{ url_for(request.endpoint, id=entity.id, page=p, **args) }}">{{ p }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="{{ url_for(request.endpoint, id=entity.id, page=pagination.next_num, **args) }}">التالي</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
