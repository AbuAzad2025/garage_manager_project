{% extends 'base.html' %}
{% block title %}إدارة الأذونات{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap4.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4" dir="rtl">
  
  <!-- إحصائيات سريعة -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">إجمالي الصلاحيات</h6>
              <h3 class="mb-0 fw-bold">{{ permissions|length }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-key fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">صلاحيات محجوزة</h6>
              <h3 class="mb-0 fw-bold">{{ permissions|selectattr('protected', 'equalto', true)|list|length if permissions else 0 }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-shield-alt fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">صلاحيات مخصصة</h6>
              <h3 class="mb-0 fw-bold">{{ permissions|selectattr('protected', 'equalto', false)|list|length if permissions else 0 }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-user-cog fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">وحدات النظام</h6>
              <h3 class="mb-0 fw-bold">15+</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-th-large fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">الأذونات</h2>
    {% if has_perm('manage_permissions') %}
      <a href="{{ url_for('permissions.create') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> إضافة إذن جديد
      </a>
    {% endif %}
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="close" data-dismiss="alert" aria-label="إغلاق">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# الأكواد المحجوزة (تشمل الإضافات الجديدة) #}
  {% set reserved = [
    'backup_database','restore_database','manage_permissions','manage_roles','manage_users',
    'manage_customers','manage_sales','manage_service','manage_reports','view_reports',
    'manage_vendors','manage_shipments','manage_warehouses','view_warehouses','manage_exchange',
    'manage_payments','manage_expenses','view_inventory','manage_inventory','warehouse_transfer',
    'view_parts','view_preorders','add_preorder','edit_preorder','delete_preorder',
    'add_customer','add_supplier','add_partner','place_online_order','view_shop','browse_products','manage_shop',
    'access_api','manage_api','view_notes','manage_notes','view_barcode','manage_barcode'
  ] %}

  <div class="table-responsive">
    <table id="permissions-table" class="table table-bordered table-hover align-middle text-center">
      <thead class="thead-light">
        <tr>
          <th style="width:40%">الاسم</th>
          <th style="width:40%">الكود</th>
          <th style="width:20%">إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for p in permissions %}
        {% set code_norm = ((p.code or p.name)|lower).replace(' ', '_') %}
        {% set is_reserved = code_norm in reserved %}
        {% set is_protected = (p.protected if p is defined and p.protected is not none else false) or is_reserved %}
        <tr>
          <td class="text-right">
            {{ p.display_name or p.name }}
            {% if is_protected %}
              <span class="badge badge-secondary ml-2">محجوز</span>
            {% endif %}
          </td>
          <td class="text-monospace">{{ p.code or '-' }}</td>
          <td class="text-nowrap">
            {% if has_perm('manage_permissions') %}
              <a href="{{ url_for('permissions.edit', permission_id=p.id) }}" class="btn btn-sm btn-warning">
                <i class="fas fa-edit"></i> تعديل
              </a>
              <form action="{{ url_for('permissions.delete', permission_id=p.id) }}" method="post" class="d-inline" onsubmit="return confirm('هل تريد حذف هذا الإذن؟');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-danger" {% if is_protected %}disabled title="إذن محجوز"{% endif %}>
                  <i class="fas fa-trash"></i> حذف
                </button>
              </form>
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script>
$(function(){
  if ($.fn.DataTable) {
    $('#permissions-table').DataTable({
      dom: "<'row'<'col-sm-6'B><'col-sm-6'f>>" +
           "<'row'<'col-sm-12'tr>>" +
           "<'row'<'col-sm-5'i><'col-sm-7'p>>",
      buttons: [
        { extend: 'copyHtml5', text: 'نسخ' },
        { extend: 'excelHtml5', text: 'Excel' },
        { extend: 'pdfHtml5', text: 'PDF' },
        { extend: 'print', text: 'طباعة' }
      ],
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/ar.json' },
      order: [[0, 'asc']],
      pageLength: 25,
      lengthMenu: [[10, 25, 50, -1], ['10', '25', '50', 'الكل']]
    });
  }
});
</script>
{% endblock %}
