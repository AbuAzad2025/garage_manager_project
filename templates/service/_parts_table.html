<div class="card mb-3 shadow-sm">
  <div class="card-header bg-primary text-white fw-bold">
    <i class="fa fa-cogs"></i> قطع الغيار
  </div>
  <div class="card-body p-0">
    {% if service.parts %}
    <table class="table table-sm table-striped mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>المخزن</th>
          <th>القطعة</th>
          <th>الشريك</th>
          <th>نسبة الشريك</th>
          <th>الكمية</th>
          <th>سعر الوحدة</th>
          <th>الإجمالي</th>
          <th>بعد خصم الشريك</th>
          {% if current_user.has_permission('manage_service') %}
          <th style="width:80px">إجراء</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for part in service.parts %}
          {% set line = part.line_total
                        if part.line_total is not none
                        else ((part.quantity or 0) * (part.unit_price or 0) * (1 - (part.discount or 0)/100)) %}
          {% set net_line = line * (1 - (part.share_percentage or 0)/100) %}
          <tr>
            <td>{{ part.warehouse.name if part.warehouse else '—' }}</td>
            <td>{{ part.part.name      if part.part      else '—' }}</td>
            <td>{{ part.partner.name   if part.partner   else '—' }}</td>
            <td>{{ (part.share_percentage or 0)|round(0, 'floor') }}%</td>
            <td>{{ part.quantity or 0 }}</td>
            <td>{{ '%.2f'|format(part.unit_price or 0) }}</td>
            <td>{{ '%.2f'|format(line) }}</td>
            <td>{{ '%.2f'|format(net_line) }}</td>
            {% if current_user.has_permission('manage_service') %}
            <td>
              <form method="post" action="{{ url_for('service.delete_part', pid=part.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-danger btn-sm btn-delete"><i class="fa fa-trash"></i></button>
              </form>
            </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="p-3 text-center text-muted">لا توجد قطع مسجلة لهذا الطلب</div>
    {% endif %}
  </div>
</div>
