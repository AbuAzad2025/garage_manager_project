<div class="card mb-3 shadow-sm">
  <div class="card-header bg-primary text-white fw-bold">
    <i class="fa fa-cogs"></i> قطع الغيار
  </div>
  <div class="card-body p-0">
    {% if service.parts %}
    {% set parts_total = (service.parts | map(attribute='line_total') | sum) or 0 %}
    <table class="table table-sm table-striped mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>المستودع</th>
          <th>القطعة</th>
          <th>الكمية</th>
          <th>سعر الوحدة</th>
          <th>الخصم %</th>
          <th>الضريبة %</th>
          <th>الإجمالي</th>
          {% if current_user.has_permission('manage_service') %}
          <th style="width:80px">إجراء</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for part in service.parts %}
          {% set line = part.line_total %}
          <tr>
            <td>{{ part.warehouse.name if part.warehouse else '—' }}</td>
            <td>{{ part.part.name if part.part else '—' }}</td>
            <td>{{ part.quantity or 0 }}</td>
            <td>{{ '%.2f'|format((part.unit_price or 0)|float) }}</td>
            <td>{{ '%.2f'|format((part.discount or 0)|float) }}</td>
            <td>{{ '%.2f'|format((part.tax_rate or 0)|float) }}</td>
            <td>{{ '%.2f'|format((line or 0)|float) }}</td>
            {% if current_user.has_permission('manage_service') %}
            <td>
              <form method="post" action="{{ url_for('service.delete_part', pid=part.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-danger btn-sm btn-delete" title="حذف">
                  <i class="fa fa-trash"></i>
                </button>
              </form>
            </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
      <tfoot class="table-light">
        <tr>
          <th colspan="6" class="text-end">إجمالي قطع الغيار</th>
          <th>{{ '%.2f'|format((parts_total or 0)|float) }}</th>
          {% if current_user.has_permission('manage_service') %}<th></th>{% endif %}
        </tr>
      </tfoot>
    </table>
    {% else %}
    <div class="p-3 text-center text-muted">لا توجد قطع مسجلة لهذا الطلب</div>
    {% endif %}
  </div>
</div>
