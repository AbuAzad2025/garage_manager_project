{% extends "base.html" %}

{% block title %}طلبات الصيانة{% endblock %}
{% block page_header %}طلبات الصيانة{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item">
    <a href="{{ url_for('main.dashboard') }}">
      <i class="fas fa-home"></i> الرئيسية
    </a>
  </li>
  <li class="breadcrumb-item active">طلبات الصيانة</li>
{% endblock %}

{% block content %}
<div class="content">

  {% set PRIORITY_LABELS = {
    'LOW':'منخفضة','MEDIUM':'متوسطة','HIGH':'عالية','URGENT':'عاجلة'
  } %}
  {% set STATUS_LABELS = {
    'PENDING':'معلّق','DIAGNOSIS':'تشخيص','IN_PROGRESS':'قيد التنفيذ',
    'COMPLETED':'مكتمل','CANCELLED':'ملغي','ON_HOLD':'مؤجّل'
  } %}
  {% set PRIORITY_COLORS = {
    'LOW':'info','MEDIUM':'warning','HIGH':'danger','URGENT':'dark'
  } %}
  {% set STATUS_COLORS = {
    'PENDING':'secondary','DIAGNOSIS':'info','IN_PROGRESS':'primary',
    'COMPLETED':'success','CANCELLED':'danger','ON_HOLD':'warning'
  } %}

  {% if current_user.has_permission('manage_service') %}
  <div class="card border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card-body text-white">
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="d-flex gap-2">
          <a href="{{ url_for('service.create_request') }}" class="btn btn-light fw-bold">
            <i class="fas fa-plus-circle"></i> إضافة طلب صيانة جديد
          </a>
          <button id="bulkArchive" class="btn btn-outline-light" disabled title="قادم">
            <i class="fas fa-archive"></i> أرشفة جماعي
          </button>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button id="exportCsv" class="btn btn-outline-light">
            <i class="fas fa-file-csv"></i> تصدير CSV
          </button>
      </div>
    </div>
  </div>
  {% endif %}

  {% if stats %}
  <!-- إحصائيات سريعة محسّنة -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">طلبات معلّقة</h6>
              <h3 class="mb-0 fw-bold">{{ stats.pending }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-clock fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">أولوية عالية</h6>
              <h3 class="mb-0 fw-bold">{{ stats.high_priority }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-bolt fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">قيد التنفيذ</h6>
              <h3 class="mb-0 fw-bold">{{ stats.in_progress }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-tools fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50 mb-1">مكتملة</h6>
              <h3 class="mb-0 fw-bold">{{ stats.completed }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card card-outline card-secondary mb-3">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-filter"></i> تصفية النتائج</h3>
      <div class="card-tools">
        <button class="btn btn-tool" data-card-widget="collapse">
          <i class="fas fa-minus"></i>
        </button>
      </div>
    </div>

    <div class="card-body">
      <form class="row g-3 align-items-end" method="get" action="{{ url_for('service.list_requests') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="col-auto">
          <label for="customer" class="form-label small"><i class="fas fa-user"></i> العميل</label>
          <input id="customer" name="customer" class="form-control form-control-sm" style="width: 150px;" value="{{ filter_values.customer or '' }}" placeholder="اسم/جوال">
        </div>

        <div class="col-auto">
          <label for="mechanic" class="form-label small"><i class="fas fa-user-cog"></i> الميكانيكي</label>
          <select id="mechanic" name="mechanic" class="form-select form-select-sm" style="width: 120px;">
            <option value="">الكل</option>
            {% for m in mechanics %}
              <option value="{{ m.username }}" {% if filter_values.mechanic==m.username %}selected{% endif %}>{{ m.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <label for="vrn" class="form-label small"><i class="fas fa-car"></i> لوحة المركبة</label>
          <input id="vrn" name="vrn" class="form-control form-control-sm" style="width: 120px;" value="{{ filter_values.vrn or '' }}" placeholder="VRN">
        </div>

        <div class="col-auto">
          <label for="date" class="form-label small"><i class="fas fa-calendar-day"></i> الزمن</label>
          <select id="date" name="date" class="form-select form-select-sm" style="width: 120px;">
            <option value="">الكل</option>
            <option value="today" {% if filter_values.date=='today' %}selected{% endif %}>اليوم</option>
            <option value="week"  {% if filter_values.date=='week' %}selected{% endif %}>هذا الأسبوع</option>
            <option value="month" {% if filter_values.date=='month' %}selected{% endif %}>هذا الشهر</option>
          </select>
        </div>

        <div class="col-auto">
          <label for="sort" class="form-label small"><i class="fas fa-sort-amount-down"></i> الترتيب</label>
          <select id="sort" name="sort" class="form-select form-select-sm" style="width: 140px;">
            <option value="balance_due" {% if filter_values.sort=='balance_due' or not filter_values.sort %}selected{% endif %}>المتبقي</option>
            <option value="received_at" {% if filter_values.sort=='received_at' %}selected{% endif %}>تاريخ الاستلام</option>
            <option value="priority" {% if filter_values.sort=='priority' %}selected{% endif %}>الأولوية</option>
            <option value="status" {% if filter_values.sort=='status' %}selected{% endif %}>الحالة</option>
          </select>
        </div>

        <div class="col-auto">
          <label for="order" class="form-label small"><i class="fas fa-exchange-alt"></i> الاتجاه</label>
          <select id="order" name="order" class="form-select form-select-sm" style="width: 100px;">
            <option value="desc" {% if filter_values.order=='desc' or not filter_values.order %}selected{% endif %}>تنازلي</option>
            <option value="asc" {% if filter_values.order=='asc' %}selected{% endif %}>تصاعدي</option>
          </select>
        </div>

        <div class="col-auto d-flex align-items-end">
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="fas fa-search"></i> تصفية
          </button>
        </div>

      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-list"></i> النتائج
        <span class="badge bg-primary ms-2">{{ pagination.total }} طلب</span>
      </h3>
    </div>
    <div class="card-body table-responsive p-0">
      <table id="servicesTable" class="table table-hover table-striped mb-0">
        <thead class="table-light">
          <tr>
            <th><i class="fas fa-hashtag"></i> رقم الطلب</th>
            <th><i class="fas fa-user"></i> العميل</th>
            <th><i class="fas fa-car"></i> نوع المركبة</th>
            <th><i class="fas fa-calculator"></i> إجمالي السند</th>
            <th><i class="fas fa-balance-scale"></i> المتبقي</th>
            <th><i class="fas fa-bolt"></i> الأولوية</th>
            <th><i class="fas fa-traffic-light"></i> الحالة</th>
            <th style="width:180px"><i class="fas fa-ellipsis-h"></i> الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% if requests %}
            {% for s in requests %}
            <tr>
              <td class="text-nowrap"><i class="fas fa-receipt text-muted"></i> {{ s.service_number }}</td>
              <td>{{ s.customer.name if s.customer else (s.name or '—') }}</td>
              <td class="text-nowrap">{{ s.vehicle_type.name if s.vehicle_type else '—' }}</td>
              <td class="text-nowrap">
                <span class="badge badge-total-amount">
                  {{ '%.2f'|format(s.total or 0.0) }} ₪
                </span>
              </td>
              <td class="text-nowrap">
                {% set balance_value = s.balance_due or 0.0 %}
                <span class="badge {{ 'badge-balance-zero' if balance_value|float <= 0 else 'badge-balance-positive' }}">
                  {{ '%.2f'|format(balance_value) }} ₪
                </span>
              </td>
              <td>
                {% set p = (s.priority.value if s.priority is not string else s.priority)|upper %}
                <span class="badge badge-status bg-{{ priority_colors.get(p, 'secondary') }}">
                  {{ priority_labels.get(p, p) }}
                </span>
              </td>
              <td>
                {% set st = (s.status.value if s.status is not string else s.status)|upper %}
                {% set STATUS_COLORS = {
                  'PENDING':'secondary','DIAGNOSIS':'info','IN_PROGRESS':'primary',
                  'COMPLETED':'success','CANCELLED':'danger','ON_HOLD':'warning'
                } %}
                <span class="badge badge-status bg-{{ STATUS_COLORS.get(st,'secondary') }}">
                  {{ status_labels.get(st, st) }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{{ url_for('service.view_request', rid=s.id) }}" class="btn btn-info" title="عرض">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{{ url_for('service.view_receipt', rid=s.id) }}" class="btn btn-outline-secondary" target="_blank" title="إيصال">
                    <i class="fas fa-print"></i>
                  </a>
                  {% if s.is_archived %}
                  <form method="post" action="{{ url_for('service.restore_service', service_id=s.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-success" title="استعادة">
                      <i class="fas fa-undo"></i>
                    </button>
                  </form>
                  {% else %}
                  <form method="post" action="{{ url_for('service.archive_service', service_id=s.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-warning" title="أرشفة">
                      <i class="fas fa-archive"></i>
                    </button>
                  </form>
                  {% endif %}
                  {% if current_user.has_permission('manage_service') %}
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                لا توجد طلبات صيانة
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    
    {% if pagination and pagination.pages > 1 %}
    <div class="card-footer">
      <nav aria-label="تنقل الصفحات">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('service.list_requests', page=pagination.prev_num, **filter_values) if pagination.has_prev else '#' }}">
              <i class="fas fa-chevron-right"></i> السابق
            </a>
          </li>
          
          {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('service.list_requests', page=p, **filter_values) }}">{{ p }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
          {% endfor %}
          
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('service.list_requests', page=pagination.next_num, **filter_values) if pagination.has_next else '#' }}">
              التالي <i class="fas fa-chevron-left"></i>
            </a>
          </li>
        </ul>
      </nav>
      <div class="text-center text-muted mt-2">
        <small>عرض {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - {{ min(pagination.page * pagination.per_page, pagination.total) }} من {{ pagination.total }}</small>
      </div>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{{ url_for('static', filename='js/service.js') }}"></script>
{% endblock %}
