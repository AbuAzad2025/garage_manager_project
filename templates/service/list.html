{% extends "base.html" %}

{% block title %}طلبات الصيانة{% endblock %}
{% block page_header %}طلبات الصيانة{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item">
    <a href="{{ url_for('main.dashboard') }}">
      <i class="fas fa-home"></i> الرئيسية
    </a>
  </li>
  <li class="breadcrumb-item active">طلبات الصيانة</li>
{% endblock %}

{% block content %}
<div class="content">

  {% set PRIORITY_LABELS = {
    'LOW':'منخفضة','MEDIUM':'متوسطة','HIGH':'عالية','URGENT':'عاجلة'
  } %}
  {% set STATUS_LABELS = {
    'PENDING':'معلّق','DIAGNOSIS':'تشخيص','IN_PROGRESS':'قيد التنفيذ',
    'COMPLETED':'مكتمل','CANCELLED':'ملغي','ON_HOLD':'مؤجّل'
  } %}
  {% set PRIORITY_COLORS = {
    'LOW':'info','MEDIUM':'warning','HIGH':'danger','URGENT':'dark'
  } %}
  {% set STATUS_COLORS = {
    'PENDING':'secondary','DIAGNOSIS':'info','IN_PROGRESS':'primary',
    'COMPLETED':'success','CANCELLED':'danger','ON_HOLD':'warning'
  } %}

  {% if current_user.has_permission('manage_service') %}
  <div class="card card-outline card-primary mb-3">
    <div class="card-body d-flex flex-wrap gap-2 toolbar">
      <a href="{{ url_for('service.create_request') }}" class="btn btn-success">
        <i class="fas fa-plus-circle"></i> إضافة طلب صيانة جديد
      </a>
      <button id="bulkArchive" class="btn btn-secondary" disabled title="قادم">
        <i class="fas fa-archive"></i> أرشفة جماعي
      </button>
      <div class="ms-auto d-flex flex-wrap gap-2">
        <button id="exportCsv" class="btn btn-outline-primary">
          <i class="fas fa-file-csv"></i> تصدير CSV
        </button>
      </div>
    </div>
  </div>
  {% endif %}

  {% if stats %}
  <div class="row">
    <div class="col-sm-6 col-md-3">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ stats.pending }}</h3>
          <p>طلبات معلّقة</p>
        </div>
        <div class="icon"><i class="fas fa-clock"></i></div>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ stats.high_priority }}</h3>
          <p>أولوية عالية</p>
        </div>
        <div class="icon"><i class="fas fa-bolt"></i></div>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small-box bg-primary">
        <div class="inner">
          <h3>{{ stats.in_progress }}</h3>
          <p>قيد التنفيذ</p>
        </div>
        <div class="icon"><i class="fas fa-tools"></i></div>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ stats.completed }}</h3>
          <p>مكتملة</p>
        </div>
        <div class="icon"><i class="fas fa-check-circle"></i></div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card card-outline card-secondary mb-3">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-filter"></i> تصفية النتائج</h3>
      <div class="card-tools">
        <button class="btn btn-tool" data-card-widget="collapse">
          <i class="fas fa-minus"></i>
        </button>
      </div>
    </div>

    <div class="card-body">
      <form class="row g-3 align-items-end" method="get" action="{{ url_for('service.list_requests') }}">

        <div class="col-12">
          <div class="row g-3">
            <div class="col-md-6">
              <fieldset class="chip-fieldset">
                <legend><i class="fas fa-traffic-light"></i> الحالة</legend>
                {% set selected_status = filter_values.status or [] %}
                {% set status_opts = ['PENDING','DIAGNOSIS','IN_PROGRESS','COMPLETED','CANCELLED','ON_HOLD'] %}
                <div class="chip-group">
                  {% for st in status_opts %}
                    <input class="btn-check" type="checkbox" name="status" id="st_{{st}}" value="{{st}}" {% if st in selected_status %}checked{% endif %}>
                    <label class="btn btn-sm btn-outline-{{ STATUS_COLORS.get(st,'secondary') }} {% if st in selected_status %}active{% endif %}" for="st_{{st}}">
                      {{ STATUS_LABELS.get(st, st) }}
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
            </div>

            <div class="col-md-6">
              <fieldset class="chip-fieldset">
                <legend><i class="fas fa-bolt"></i> الأولوية</legend>
                {% set selected_pri = filter_values.priority or [] %}
                {% set pri_opts = ['LOW','MEDIUM','HIGH','URGENT'] %}
                <div class="chip-group">
                  {% for pr in pri_opts %}
                    <input class="btn-check" type="checkbox" name="priority" id="pr_{{pr}}" value="{{pr}}" {% if pr in selected_pri %}checked{% endif %}>
                    <label class="btn btn-sm btn-outline-{{ PRIORITY_COLORS.get(pr,'secondary') }} {% if pr in selected_pri %}active{% endif %}" for="pr_{{pr}}">
                      {{ PRIORITY_LABELS.get(pr, pr) }}
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6 col-xl-4">
          <label for="customer" class="form-label"><i class="fas fa-user"></i> العميل (اسم/جوال)</label>
          <input id="customer" name="customer" class="form-control" value="{{ filter_values.customer or '' }}" placeholder="اكتب جزءًا من الاسم أو الجوال">
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="mechanic" class="form-label"><i class="fas fa-user-cog"></i> الميكانيكي</label>
          <select id="mechanic" name="mechanic" class="form-select">
            <option value="">الكل</option>
            {% for m in mechanics %}
              <option value="{{ m.username }}" {% if filter_values.mechanic==m.username %}selected{% endif %}>{{ m.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="vrn" class="form-label"><i class="fas fa-car"></i> لوحة المركبة</label>
          <input id="vrn" name="vrn" class="form-control" value="{{ filter_values.vrn or '' }}" placeholder="VRN">
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="date" class="form-label"><i class="fas fa-calendar-day"></i> الزمن</label>
          <select id="date" name="date" class="form-select">
            <option value="">الكل</option>
            <option value="today" {% if filter_values.date=='today' %}selected{% endif %}>اليوم</option>
            <option value="week"  {% if filter_values.date=='week' %}selected{% endif %}>هذا الأسبوع</option>
            <option value="month" {% if filter_values.date=='month' %}selected{% endif %}>هذا الشهر</option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="sort" class="form-label"><i class="fas fa-sort-amount-down"></i> ترتيب حسب</label>
          <select id="sort" name="sort" class="form-select">
            <option value="received_at" {% if filter_values.sort=='received_at' or not filter_values.sort %}selected{% endif %}>تاريخ الاستلام</option>
            <option value="priority" {% if filter_values.sort=='priority' %}selected{% endif %}>الأولوية</option>
            <option value="status" {% if filter_values.sort=='status' %}selected{% endif %}>الحالة</option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label for="order" class="form-label"><i class="fas fa-exchange-alt"></i> الاتجاه</label>
          <select id="order" name="order" class="form-select">
            <option value="desc" {% if filter_values.order=='desc' or not filter_values.order %}selected{% endif %}>تنازلي</option>
            <option value="asc" {% if filter_values.order=='asc' %}selected{% endif %}>تصاعدي</option>
          </select>
        </div>

        <div class="col-12 col-xl-2">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search"></i> تصفية
          </button>
        </div>

      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-list"></i> النتائج
        <span class="badge bg-primary ms-2">{{ pagination.total }} طلب</span>
      </h3>
    </div>
    <div class="card-body table-responsive p-0">
      <table id="servicesTable" class="table table-hover table-striped mb-0">
        <thead class="table-light">
          <tr>
            {% if current_user.has_permission('manage_service') %}
              <th style="width:42px"><input type="checkbox" id="selectAll"></th>
            {% endif %}
            <th><i class="fas fa-hashtag"></i> رقم الطلب</th>
            <th><i class="fas fa-user"></i> العميل</th>
            <th><i class="fas fa-id-card"></i> لوحة المركبة</th>
            <th><i class="fas fa-bolt"></i> الأولوية</th>
            <th><i class="fas fa-traffic-light"></i> الحالة</th>
            <th style="width:260px"><i class="fas fa-ellipsis-h"></i> الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% if requests %}
            {% for s in requests %}
            <tr>
              {% if current_user.has_permission('manage_service') %}
                <td><input type="checkbox" class="row-select" value="{{ s.id }}"></td>
              {% endif %}
              <td class="text-nowrap"><i class="fas fa-receipt text-muted"></i> {{ s.service_number }}</td>
              <td>{{ s.customer.name if s.customer else (s.name or '—') }}</td>
              <td class="text-nowrap">{{ s.vehicle_vrn or '—' }}</td>
              <td>
                {% set p = (s.priority.value if s.priority is not string else s.priority)|upper %}
                <span class="badge badge-status bg-{{ priority_colors.get(p, 'secondary') }}">
                  {{ priority_labels.get(p, p) }}
                </span>
              </td>
              <td>
                {% set st = (s.status.value if s.status is not string else s.status)|upper %}
                {% set STATUS_COLORS = {
                  'PENDING':'secondary','DIAGNOSIS':'info','IN_PROGRESS':'primary',
                  'COMPLETED':'success','CANCELLED':'danger','ON_HOLD':'warning'
                } %}
                <span class="badge badge-status bg-{{ STATUS_COLORS.get(st,'secondary') }}">
                  {{ status_labels.get(st, st) }}
                </span>
              </td>
              <td class="d-flex flex-wrap gap-1">
                <a href="{{ url_for('service.view_request', rid=s.id) }}" class="btn btn-info btn-sm">
                  <i class="fas fa-eye"></i> عرض
                </a>
                <a href="{{ url_for('service.view_receipt', rid=s.id) }}" class="btn btn-outline-secondary btn-sm" target="_blank">
                  <i class="fas fa-print"></i> إيصال
                </a>
                {% if current_user.has_permission('manage_service') %}
                <a href="{{ url_for('hard_delete_bp.hard_delete_service', service_id=s.id) }}" class="btn btn-danger btn-sm" title="حذف قوي">
                  <i class="fas fa-trash-alt"></i>
                </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                لا توجد طلبات صيانة
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    
    {% if pagination and pagination.pages > 1 %}
    <div class="card-footer">
      <nav aria-label="تنقل الصفحات">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('service.list_requests', page=pagination.prev_num, **filter_values) if pagination.has_prev else '#' }}">
              <i class="fas fa-chevron-right"></i> السابق
            </a>
          </li>
          
          {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('service.list_requests', page=p, **filter_values) }}">{{ p }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
          {% endfor %}
          
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('service.list_requests', page=pagination.next_num, **filter_values) if pagination.has_next else '#' }}">
              التالي <i class="fas fa-chevron-left"></i>
            </a>
          </li>
        </ul>
      </nav>
      <div class="text-center text-muted mt-2">
        <small>عرض {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - {{ min(pagination.page * pagination.per_page, pagination.total) }} من {{ pagination.total }}</small>
      </div>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- DataTables معطّل لأن لدينا Pagination server-side -->
  <!-- <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script> -->
  <script src="{{ url_for('static', filename='js/service.js') }}"></script>
{% endblock %}
