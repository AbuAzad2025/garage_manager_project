{% extends "base.html" %}
{% block title %}طلبات الصيانة{% endblock %}
{% block page_header %}طلبات الصيانة{% endblock %}
{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
  <li class="breadcrumb-item active">طلبات الصيانة</li>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-4">طلبات الصيانة</h2>

  {% if current_user.has_permission('manage_services') %}
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <a href="{{ url_for('service.create_request') }}" class="btn btn-success">
      <i class="fa fa-plus"></i> إضافة طلب صيانة جديد
    </a>
    <button id="bulkDelete" class="btn btn-danger"><i class="fa fa-trash"></i> حذف جماعي</button>
    <button id="bulkArchive" class="btn btn-secondary"><i class="fa fa-archive"></i> أرشفة جماعي</button>
    <button id="exportCsv" class="btn btn-outline-primary">تصدير CSV</button>
    <button id="exportPdf" class="btn btn-outline-dark">تصدير PDF</button>
  </div>
  {% endif %}

  <!-- فلاتر البحث -->
  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-md-2">
      <label for="search" class="form-label">بحث حر</label>
      <input id="search" name="search" class="form-control" placeholder="ابحث..." value="{{ filter_values.search }}">
    </div>
    <div class="col-md-2">
      <label for="status" class="form-label">الحالة</label>
      <select id="status" name="status" class="form-select">
        <option value="">الكل</option>
        <option value="PENDING"    {% if filter_values.status=='PENDING' %}selected{% endif %}>معلق</option>
        <option value="IN_PROGRESS"{% if filter_values.status=='IN_PROGRESS' %}selected{% endif %}>قيد التنفيذ</option>
        <option value="COMPLETED"  {% if filter_values.status=='COMPLETED' %}selected{% endif %}>مكتمل</option>
        <option value="CANCELLED"  {% if filter_values.status=='CANCELLED' %}selected{% endif %}>ملغي</option>
      </select>
    </div>
    <div class="col-md-2">
      <label for="date_from" class="form-label">من تاريخ</label>
      <input type="date" id="date_from" name="date_from" class="form-control" value="{{ filter_values.date_from }}">
    </div>
    <div class="col-md-2">
      <label for="date_to" class="form-label">إلى تاريخ</label>
      <input type="date" id="date_to" name="date_to" class="form-control" value="{{ filter_values.date_to }}">
    </div>
    <div class="col-md-2">
      <label for="warehouse_id" class="form-label">المخزن</label>
      <select id="warehouse_id" name="warehouse_id" class="form-select">
        <option value="">الكل</option>
        {% for w in warehouses %}
        <option value="{{ w.id }}" {% if filter_values.warehouse_id==w.id|string %}selected{% endif %}>{{ w.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">تصفية</button>
    </div>
  </form>

  <!-- جدول الطلبات -->
  <div class="table-responsive">
    <table id="servicesTable" class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          {% if current_user.has_permission('manage_services') %}
          <th><input type="checkbox" id="selectAll"></th>
          {% endif %}
          <th>رقم الطلب</th>
          <th>العميل</th>
          <th>نوع المعدة</th>
          <th>الموديل</th>
          <th>الحالة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for s in requests %}
        <tr>
          {% if current_user.has_permission('manage_services') %}
          <td><input type="checkbox" class="row-select" value="{{ s.id }}"></td>
          {% endif %}
          <td>{{ s.service_number }}</td>
          <td>{{ s.customer.name if s.customer else '—' }}</td>
          <td>{{ s.vehicle_type.name if s.vehicle_type else '—' }}</td>
          <td>{{ s.vehicle_model or '—' }}</td>
          <td><span class="badge bg-{{ priority_colors[s.priority] }}">{{ status_labels[s.status] }}</span></td>
          <td>
            <a href="{{ url_for('service.view_request', rid=s.id) }}" class="btn btn-info btn-sm">عرض</a>
            {% if current_user.has_permission('manage_services') %}
            <a href="{{ url_for('service.edit_request', rid=s.id) }}" class="btn btn-warning btn-sm">تعديل</a>
            <button class="btn btn-danger btn-sm btn-delete" data-id="{{ s.id }}">حذف</button>
            <button class="btn btn-secondary btn-sm btn-archive" data-id="{{ s.id }}">أرشفة</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="{{ url_for('static', filename='js/services.js') }}"></script>
{% endblock %}
