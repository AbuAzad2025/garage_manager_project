{% extends "base.html" %}
{% set edit_mode = form._obj is defined %}
{% block title %}{{ edit_mode and 'تعديل طلب صيانة' or 'إضافة طلب صيانة' }}{% endblock %}
{% block page_header %}{{ edit_mode and 'تعديل طلب صيانة' or 'إضافة طلب صيانة' }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('service.list_requests') }}">طلبات الصيانة</a></li>
<li class="breadcrumb-item active">{{ edit_mode and 'تعديل' or 'جديد' }}</li>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">{{ edit_mode and 'تعديل' or 'إضافة' }} طلب صيانة</h2>

  <form method="POST" id="serviceForm" autocomplete="off" action="{{ url_for('service.create_request') }}">
    {{ form.hidden_tag() }}

    <div class="row">
      <div class="col-md-6 mb-3">
        {{ form.customer_id.label(class="form-label") }}
        <div class="input-group">
          {{ form.customer_id(class="form-select select2", id="customerSelect", data_endpoint=url_for('api.search_customers')) }}
          <a href="{{ url_for('customers_bp.create_form', return_to=url_for('service.create_request')) }}" 
             class="btn btn-outline-primary" 
             title="إضافة عميل جديد" 
             target="_blank">
            <i class="fa fa-user-plus"></i>
          </a>
        </div>
        {% for e in form.customer_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        <div class="form-text">اختر عميلًا أو أنشئ عميلًا جديدًا من زر (+).</div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-3 mb-3">
        {{ form.vehicle_type_id.label(class="form-label") }}
        <div class="input-group">
          {{ form.vehicle_type_id(class="form-select select2", id="vehicleTypeSelect", data_endpoint=url_for('api.search_equipment_types'), data_placeholder="اختر نوعًا أو أضف جديدًا") }}
          <button type="button" class="btn btn-outline-primary" id="addTypeBtn" title="إضافة نوع">
            <i class="fa fa-plus"></i>
          </button>
        </div>
        <div class="form-text">اكتب للبحث، وإن لم تجد النوع أضفه من زر (+).</div>
      </div>
      <div class="col-md-3 mb-3">
        {{ form.vehicle_model.label(class="form-label") }}
        {{ form.vehicle_model(class="form-control") }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.vehicle_vrn.label(class="form-label") }}
        {{ form.vehicle_vrn(class="form-control") }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.chassis_number.label(class="form-label") }}
        {{ form.chassis_number(class="form-control") }}
      </div>
    </div>

    <div class="mb-3">
      {{ form.problem_description.label(class="form-label") }}
      {{ form.problem_description(class="form-control", rows=2) }}
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        {{ form.priority.label(class="form-label") }}
        {{ form.priority(class="form-select") }}
      </div>
      <div class="col-md-4 mb-3">
        {{ form.estimated_duration.label(class="form-label") }}
        {{ form.estimated_duration(class="form-control", type="number", min="0", step="1") }}
      </div>
      <div class="col-md-4 mb-3">
        {{ form.status.label(class="form-label") }}
        {{ form.status(class="form-select") }}
      </div>
    </div>

    {# ✅ صف منفصل للشيك بوكس لعدم كسر الشبكة #}
    <div class="row">
      <div class="col-md-4 mb-3">
        <div class="form-check mt-2">
          {{ form.consume_stock(class="form-check-input", id="consume_stock") }}
          <label class="form-check-label" for="consume_stock">استهلاك من المخزون</label>
          <div class="form-text">فعِّل لخصم القطع من المخزون عند بدء/إكمال الطلب.</div>
        </div>
      </div>
    </div>

    {% if form.parts %}
    <div class="mb-3">
      <label class="form-label">القطع المستخدمة</label>
      <div id="parts-list">
        {% for part in form.parts %}
        <div class="row g-2 mb-2 part-line">
          <div class="col-md-3">{{ part.warehouse_id(class="form-select") }}</div>
          <div class="col-md-3">{{ part.part_id(class="form-select") }}</div>
          <div class="col-md-2">{{ part.quantity(class="form-control", min="1") }}</div>
          <div class="col-md-2">{{ part.unit_price(class="form-control", min="0", step="0.01") }}</div>
          <div class="col-auto d-flex align-items-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-part">&times;</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <button type="button" class="btn btn-outline-success btn-sm" id="addPartBtn"><i class="fa fa-plus"></i> إضافة قطعة</button>
    </div>
    {% endif %}

    {% if form.tasks %}
    <div class="mb-3">
      <label class="form-label">المهام المنفذة</label>
      <div id="tasks-list">
        {% for task in form.tasks %}
        <div class="row g-2 mb-2 task-line">
          <div class="col-md-6">{{ task.description(class="form-control") }}</div>
          <div class="col-md-2">{{ task.quantity(class="form-control", min="1") }}</div>
          <div class="col-md-2">{{ task.unit_price(class="form-control", min="0", step="0.01") }}</div>
          <div class="col-auto d-flex align-items-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-task">&times;</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <button type="button" class="btn btn-outline-success btn-sm" id="addTaskBtn"><i class="fa fa-plus"></i> إضافة مهمة</button>
    </div>
    {% endif %}

    <button type="submit" class="btn btn-primary">{{ edit_mode and 'تحديث' or 'حفظ' }}</button>
    <a href="{{ url_for('service.list_requests') }}" class="btn btn-secondary ms-2">إلغاء</a>
  </form>
</div>

<div class="modal fade" id="equipmentTypeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="equipmentTypeForm">
      <div class="modal-header">
        <h5 class="modal-title">إضافة نوع معدة/مركبة</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">الاسم *</label>
          <input type="text" class="form-control" id="et_name" required>
        </div>
        <div class="mb-2">
          <label class="form-label">الموديل</label>
          <input type="text" class="form-control" id="et_model">
        </div>
        <div class="mb-2">
          <label class="form-label">الفئة</label>
          <input type="text" class="form-control" id="et_category">
        </div>
        <div class="mb-2">
          <label class="form-label">وصف</label>
          <textarea class="form-control" id="et_notes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> حفظ وإختيار</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">إلغاء</button>
      </div>
    </form>
  </div>
</div>

<style>
  @media print { .btn, .breadcrumb, .page-header { display:none!important; } }
</style>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/service.js') }}"></script>
  <script>
    $(function () {
      $('.select2').each(function(){
        const ep = $(this).data('endpoint');
        if (ep) {
          $(this).select2({
            width: '100%',
            theme: 'bootstrap4',
            ajax: {
              url: ep, dataType: 'json', delay: 250,
              data: params => ({ q: params.term || '', limit: 20 }),
              processResults: data => ({ results: Array.isArray(data) ? data : (data.results || []) })
            },
            placeholder: $(this).data('placeholder') || 'اختر...'
          });
        } else {
          $(this).select2({ width: '100%', theme: 'bootstrap4', placeholder: 'اختر...' });
        }
      });

      $('#addTypeBtn').on('click', () => { $('#equipmentTypeModal').modal('show'); });
      $('#equipmentTypeForm').on('submit', async function(e){
        e.preventDefault();
        const btn = $(this).find('[type="submit"]')[0];
        if (btn) btn.disabled = true;
        const payload = {
          name: $('#et_name').val().trim(),
          model: $('#et_model').val().trim(),
          category: $('#et_category').val().trim(),
          notes: $('#et_notes').val().trim()
        };
        if (!payload.name) { alert('الاسم مطلوب'); if (btn) btn.disabled = false; return; }
        try {
          const res = await fetch("{{ url_for('api.create_equipment_type') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok || !data.id) throw new Error(data.error || 'فشل إنشاء النوع');
          const $type = $('#vehicleTypeSelect');
          const opt = new Option(data.text, data.id, true, true);
          $type.append(opt).trigger('change');
          $('#equipmentTypeModal').modal('hide');
        } catch (err) {
          alert(err.message || 'تعذّر إنشاء النوع');
        } finally {
          if (btn) btn.disabled = false;
        }
      });
    });
  </script>
{% endblock %}
