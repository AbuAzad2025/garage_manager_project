<!-- File: templates/service/new.html -->
{% extends "base.html" %}
{% set edit_mode = form._obj is defined %}
{% block title %}{{ edit_mode and 'تعديل طلب صيانة' or 'إضافة طلب صيانة' }}{% endblock %}
{% block page_header %}{{ edit_mode and 'تعديل طلب صيانة' or 'إضافة طلب صيانة' }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
  <!-- Select2 CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('service.list_requests') }}">طلبات الصيانة</a></li>
<li class="breadcrumb-item active">{{ edit_mode and 'تعديل' or 'جديد' }}</li>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">{{ edit_mode and 'تعديل' or 'إضافة' }} طلب صيانة</h2>

  <form method="POST" id="serviceForm" autocomplete="off" action="{{ url_for('service.create_request') }}">
    {{ form.hidden_tag() }}

    <!-- اختيار/تعريف العميل -->
    <div class="row">
      <div class="col-md-6 mb-3">
        {{ form.customer_id.label(class="form-label") }}
        {{ form.customer_id(class="form-select select2", id="customerSelect", data_endpoint=url_for('api.search_customers')) }}
        {% for e in form.customer_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addCustomerBtn">
          <i class="fa fa-user-plus"></i> إضافة عميل سريع
        </button>
        <div class="form-text">إن لم تختر عميلًا سيجري إنشاء عميل جديد من الحقول أدناه.</div>
      </div>

      <div class="col-md-6">
        <div class="row">
          <div class="col-md-4 mb-3">
            {{ customer_form.name.label(class="form-label") }}
            {{ customer_form.name(class="form-control", id="customer_name", placeholder="اسم العميل") }}
            {% for e in customer_form.name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4 mb-3">
            {{ customer_form.phone.label(class="form-label") }}
            {{ customer_form.phone(class="form-control", id="customer_phone", placeholder="رقم الجوال") }}
            {% for e in customer_form.phone.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4 mb-3">
            {{ customer_form.email.label(class="form-label") }}
            {{ customer_form.email(class="form-control", id="customer_email", placeholder="البريد الإلكتروني") }}
            {% for e in customer_form.email.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- بيانات المركبة -->
    <div class="row">
      <div class="col-md-3 mb-3">
        {{ form.vehicle_type_id.label(class="form-label") }}
        {{ form.vehicle_type_id(class="form-select select2", data_endpoint=url_for('api.search_equipment_types')) }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.vehicle_model.label(class="form-label") }}
        {{ form.vehicle_model(class="form-control") }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.vehicle_vrn.label(class="form-label") }}
        {{ form.vehicle_vrn(class="form-control") }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.chassis_number.label(class="form-label") }}
        {{ form.chassis_number(class="form-control") }}
      </div>
    </div>

    <!-- أوصاف -->
    <div class="mb-3">
      {{ form.problem_description.label(class="form-label") }}
      {{ form.problem_description(class="form-control", rows=2) }}
    </div>
    <div class="mb-3">
      {{ form.engineer_notes.label(class="form-label") }}
      {{ form.engineer_notes(class="form-control", rows=2) }}
    </div>

    <!-- الحقول المحاسبية والحالة -->
    <div class="row">
      <div class="col-md-3 mb-3">
        {{ form.priority.label(class="form-label") }}
        {{ form.priority(class="form-select") }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.estimated_duration.label(class="form-label") }}
        {{ form.estimated_duration(class="form-control", type="number", min="0", step="1") }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.estimated_cost.label(class="form-label") }}
        {{ form.estimated_cost(class="form-control", type="number", min="0", step="0.01") }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form.tax_rate.label(class="form-label") }}
        {{ form.tax_rate(class="form-control", type="number", min="0", step="0.01") }}
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        {{ form.status.label(class="form-label") }}
        {{ form.status(class="form-select") }}
      </div>
      <div class="col-md-6 mb-3">
        {{ form.description.label(class="form-label") }}
        {{ form.description(class="form-control", rows=2) }}
      </div>
    </div>

    <!-- (اختياري) سطور ديناميكية -->
    {% if form.parts %}
    <div class="mb-3">
      <label class="form-label">القطع المستخدمة</label>
      <div id="parts-list">
        {% for part in form.parts %}
        <div class="row g-2 mb-2 part-line">
          <div class="col-md-3">{{ part.warehouse_id(class="form-select") }}</div>
          <div class="col-md-3">{{ part.part_id(class="form-select") }}</div>
          <div class="col-md-2">{{ part.quantity(class="form-control", min="1") }}</div>
          <div class="col-md-2">{{ part.unit_price(class="form-control", min="0", step="0.01") }}</div>
          <div class="col-md-1">{{ part.partner_id(class="form-select") }}</div>
          <div class="col-md-1">{{ part.share_percentage(class="form-control", step="0.01") }}</div>
          <div class="col-auto d-flex align-items-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-part">&times;</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <button type="button" class="btn btn-outline-success btn-sm" id="addPartBtn"><i class="fa fa-plus"></i> إضافة قطعة</button>
    </div>
    {% endif %}

    {% if form.tasks %}
    <div class="mb-3">
      <label class="form-label">المهام المنفذة</label>
      <div id="tasks-list">
        {% for task in form.tasks %}
        <div class="row g-2 mb-2 task-line">
          <div class="col-md-6">{{ task.description(class="form-control") }}</div>
          <div class="col-md-2">{{ task.quantity(class="form-control", min="1") }}</div>
          <div class="col-md-2">{{ task.unit_price(class="form-control", min="0", step="0.01") }}</div>
          <div class="col-auto d-flex align-items-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-task">&times;</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <button type="button" class="btn btn-outline-success btn-sm" id="addTaskBtn"><i class="fa fa-plus"></i> إضافة مهمة</button>
    </div>
    {% endif %}

    <button type="submit" class="btn btn-primary">{{ edit_mode and 'تحديث' or 'حفظ' }}</button>
    <a href="{{ url_for('service.list_requests') }}" class="btn btn-secondary ms-2">إلغاء</a>
  </form>
</div>

<!-- مودال إضافة عميل سريع -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="newCustomerForm">
        <div class="modal-header">
          <h5 class="modal-title">إضافة عميل</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">الاسم</label>
            <input type="text" class="form-control" id="c_name" placeholder="اسم العميل">
          </div>
          <div class="mb-3">
            <label class="form-label">الجوال</label>
            <input type="text" class="form-control" id="c_phone" placeholder="05XXXXXXXX">
          </div>
          <div class="mb-3">
            <label class="form-label">البريد</label>
            <input type="email" class="form-control" id="c_email" placeholder="example@mail.com">
          </div>
          <div class="form-text">سيتم استخدام هذه البيانات لإنشاء العميل عند حفظ الطلب إذا لم تحدد عميلًا من القائمة.</div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">استخدام البيانات</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  @media print { .btn, .breadcrumb, .page-header { display:none!important; } }
</style>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Select2 JS قبل service.js -->
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>

  <script src="{{ url_for('static', filename='js/service.js') }}"></script>
  <script>
    // تفعيل Select2 عبر data-endpoint إن وُجد
    document.addEventListener('DOMContentLoaded', function () {
      if (window.jQuery && jQuery.fn.select2) {
        document.querySelectorAll('.select2').forEach(function(el){
          const $el = $(el);
          const ep = el.getAttribute('data-endpoint') || el.dataset.endpoint;
          if (ep) {
            $el.select2({
              width: '100%',
              theme: 'bootstrap4',
              ajax: {
                url: ep, dataType: 'json', delay: 250,
                data: params => ({ q: params.term || '', limit: 20 }),
                processResults: data => ({ results: Array.isArray(data) ? data : (data.results || []) })
              },
              placeholder: 'اختر...'
            });
          } else {
            $el.select2({ width: '100%', theme: 'bootstrap4', placeholder: 'اختر...' });
          }
        });
      } else {
        console.warn('Select2 لم يُحمّل. تأكد من المسارات إلى ملفات CSS/JS.');
      }
    });

    // فتح المودال
    document.getElementById('addCustomerBtn')?.addEventListener('click', () => {
      const modal = new bootstrap.Modal(document.getElementById('customerModal'));
      modal.show();
    });

    // نقل بيانات العميل من المودال إلى الحقول (باستخدام id ثابت)
    document.getElementById('newCustomerForm')?.addEventListener('submit', function(e){
      e.preventDefault();
      const name  = document.getElementById('c_name').value.trim();
      const phone = document.getElementById('c_phone').value.trim();
      const email = document.getElementById('c_email').value.trim();

      const setById = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
      setById('customer_name', name);
      setById('customer_phone', phone);
      setById('customer_email', email);

      // إفراغ اختيار العميل وإطلاق change (لـ Select2 أيضاً)
      const sel = document.getElementById('customerSelect');
      if (sel) {
        sel.value = '';
        sel.dispatchEvent(new Event('change'));
        if (window.jQuery && jQuery.fn.select2) { $(sel).val(null).trigger('change'); }
      }

      bootstrap.Modal.getInstance(document.getElementById('customerModal'))?.hide();
      Swal.fire('تم', 'تم إدراج بيانات العميل في الطلب. احفظ الطلب لإتمام الإنشاء.', 'success');
    });
  </script>
{% endblock %}
