{% extends "base.html" %}
{% set edit_mode = form._obj is defined %}
{% block title %}{{ edit_mode and 'تعديل طلب صيانة' or 'إضافة طلب صيانة' }}{% endblock %}
{% block page_header %}{{ edit_mode and 'تعديل طلب صيانة' or 'إضافة طلب صيانة' }}{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('service.list_requests') }}">طلبات الصيانة</a></li>
<li class="breadcrumb-item active">{{ edit_mode and 'تعديل' or 'جديد' }}</li>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">{{ edit_mode and 'تعديل' or 'إضافة' }} طلب صيانة</h2>
  <form method="POST" id="serviceForm" autocomplete="off">
    {{ form.hidden_tag() }}

    <!-- ✅ اختيار العميل مع Ajax -->
    <div class="mb-3">
      {{ form.customer_id.label(class="form-label") }}
      {{ form.customer_id(class="form-select", id="customerSelect") }}
      {% for e in form.customer_id.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
      <button type="button" class="btn btn-outline-primary btn-sm mt-1" id="addCustomerBtn">
        <i class="fa fa-user-plus"></i> إضافة عميل
      </button>
    </div>

    <!-- ✅ بيانات العميل الجديدة (اختياريّة) -->
    <div class="row">
      <div class="col-md-4 mb-3">
        {{ form.name.label(class="form-label") }}
        {{ form.name(class="form-control", placeholder="اسم العميل") }}
        {% for e in form.name.errors %}<small class="text-danger">{{ e }}</small>{% endfor %}
      </div>
      <div class="col-md-4 mb-3">
        {{ form.phone.label(class="form-label") }}
        {{ form.phone(class="form-control", placeholder="رقم الجوال") }}
        {% for e in form.phone.errors %}<small class="text-danger">{{ e }}</small>{% endfor %}
      </div>
      <div class="col-md-4 mb-3">
        {{ form.email.label(class="form-label") }}
        {{ form.email(class="form-control", placeholder="البريد الإلكتروني") }}
        {% for e in form.email.errors %}<small class="text-danger">{{ e }}</small>{% endfor %}
      </div>
    </div>

    <!-- ✅ بيانات المركبة -->
    <div class="row">
      <div class="col-md-3 mb-3">{{ form.vehicle_type_id.label }}{{ form.vehicle_type_id(class="form-select") }}</div>
      <div class="col-md-3 mb-3">{{ form.vehicle_model.label }}{{ form.vehicle_model(class="form-control") }}</div>
      <div class="col-md-3 mb-3">{{ form.vehicle_vrn.label }}{{ form.vehicle_vrn(class="form-control") }}</div>
      <div class="col-md-3 mb-3">{{ form.chassis_number.label }}{{ form.chassis_number(class="form-control") }}</div>
    </div>

    <!-- ✅ أوصاف -->
    <div class="mb-3">{{ form.problem_description.label }}{{ form.problem_description(class="form-control", rows=2) }}</div>
    <div class="mb-3">{{ form.engineer_notes.label }}{{ form.engineer_notes(class="form-control", rows=2) }}</div>

    <!-- ✅ الحالة والضريبة -->
    <div class="row">
      <div class="col-md-6 mb-3">{{ form.status.label }}{{ form.status(class="form-select") }}</div>
      <div class="col-md-6 mb-3">{{ form.tax_rate.label }}{{ form.tax_rate(class="form-control") }}</div>
    </div>

    <!-- ✅ قطع الغيار (ديناميكية) مع الشريك -->
    <div class="mb-3">
      <label class="form-label">القطع المستخدمة</label>
      <div id="parts-list">
        {% for part in form.parts %}
        <div class="row g-2 mb-2 part-line">
          <div class="col-md-3">{{ part.warehouse_id(class="form-select") }}</div>
          <div class="col-md-3">{{ part.part_id(class="form-select") }}</div>
          <div class="col-md-2">{{ part.quantity(class="form-control", min="1") }}</div>
          <div class="col-md-2">{{ part.unit_price(class="form-control", min="0", step="0.01") }}</div>
          <div class="col-md-1">{{ part.partner_id(class="form-select") }}</div>
          <div class="col-md-1">{{ part.share_percentage(class="form-control", step="0.01") }}</div>
          <div class="col-auto d-flex align-items-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-part">&times;</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <button type="button" class="btn btn-outline-success btn-sm" id="addPartBtn"><i class="fa fa-plus"></i> إضافة قطعة</button>
    </div>

    <!-- ✅ المهام (ديناميكية) -->
    <div class="mb-3">
      <label class="form-label">المهام المنفذة</label>
      <div id="tasks-list">
        {% for task in form.tasks %}
        <div class="row g-2 mb-2 task-line">
          <div class="col-md-6">{{ task.description(class="form-control") }}</div>
          <div class="col-md-2">{{ task.quantity(class="form-control", min="1") }}</div>
          <div class="col-md-2">{{ task.unit_price(class="form-control", min="0", step="0.01") }}</div>
          <div class="col-auto d-flex align-items-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-task">&times;</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <button type="button" class="btn btn-outline-success btn-sm" id="addTaskBtn"><i class="fa fa-plus"></i> إضافة مهمة</button>
    </div>

    <!-- ✅ ملاحظات عامة -->
    <div class="mb-3">{{ form.description.label }}{{ form.description(class="form-control", rows=2) }}</div>

    <button type="submit" class="btn btn-primary">{{ edit_mode and 'تحديث' or 'حفظ' }}</button>
    <a href="{{ url_for('service.list_requests') }}" class="btn btn-secondary ms-2">إلغاء</a>
  </form>
</div>

<!-- ✅ مودال إضافة عميل جديد -->
<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="newCustomerForm">
        <div class="modal-header"><h5 class="modal-title">إضافة عميل جديد</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <!-- استخدم جزء الفورم فقط بدون extends لتفادي تضارب القوالب -->
        <div class="modal-body">
          {%- with form=customer_form %}
            {%- include 'customers/_form.html' %}
          {%- endwith %}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">حفظ العميل</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/service_form.js') }}"></script>
<script>
$(function(){
  // ✅ Select2 Ajax للعميل
  $('#customerSelect').select2({
    theme: "bootstrap-5",
    ajax: {
      url: "{{ url_for('customers.api_customers') }}",
      dataType: 'json',
      delay: 250,
      data: params => ({ q: params.term }),
      processResults: data => ({ results: data })
    },
    placeholder: "ابحث عن عميل",
    allowClear: true,
    language: "ar"
  });

  // ✅ فتح مودال إضافة عميل
  $('#addCustomerBtn').click(()=> $('#customerModal').modal('show'));

  // ✅ حفظ عميل جديد عبر Ajax
  $('#newCustomerForm').submit(e=>{
    e.preventDefault();
    $.post("{{ url_for('customers.create_customer') }}", $(e.target).serialize())
      .done(resp=>{
        if(resp.success){
          let opt = new Option(resp.customer.name, resp.customer.id, true, true);
          $('#customerSelect').append(opt).trigger('change');
          $('#customerModal').modal('hide');
          toastr.success("تم إضافة العميل!");
        } else toastr.error("فشل إضافة العميل!");
      })
      .fail(()=> toastr.error("حدث خطأ أثناء إضافة العميل!"));
  });
});
</script>
{% endblock %}
