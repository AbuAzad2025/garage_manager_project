{% set ns = namespace(parts_total=0.0, tasks_total=0.0, net_sub=0.0) %}

{% for p in service.parts or [] %}
  {% set line = (p.line_total or 0)|float %}
  {% set ns.parts_total = ns.parts_total + line %}
  {% set ns.net_sub = ns.net_sub + line %}
{% endfor %}

{% for t in service.tasks or [] %}
  {% set line = (t.line_total or 0)|float %}
  {% set ns.tasks_total = ns.tasks_total + line %}
  {% set ns.net_sub = ns.net_sub + line %}
{% endfor %}

{% set subtotal = ns.parts_total + ns.tasks_total %}
{% set tax_rate = (service.tax_rate or 0)|float %}
{% set tax_amount = ns.net_sub * (tax_rate/100.0) %}
{% set total_amount = ns.net_sub + tax_amount %}

<div class="card mb-3 shadow-sm">
  <div class="card-header bg-info text-white fw-bold">
    <i class="fa fa-calculator"></i> ملخص الحساب
  </div>
  <div class="card-body">
    <div class="d-flex justify-content-between mb-2">
      <span>الإجمالي قبل الضريبة:</span>
      <span class="fw-bold">{{ '%.2f'|format(subtotal) }} ₪</span>
    </div>
    <div class="d-flex justify-content-between mb-2">
      <span>صافي قبل الضريبة:</span>
      <span class="fw-bold text-primary">{{ '%.2f'|format(ns.net_sub) }} ₪</span>
    </div>
    <div class="d-flex justify-content-between mb-2">
      <span>نسبة الضريبة:</span>
      <span class="fw-bold">{{ tax_rate|round(0, 'floor') }}%</span>
    </div>
    <div class="d-flex justify-content-between mb-3">
      <span>قيمة الضريبة:</span>
      <span class="fw-bold">{{ '%.2f'|format(tax_amount) }} ₪</span>
    </div>
    <hr>
    <div class="d-flex justify-content-between fs-5">
      <span>الإجمالي الكلي:</span>
      <span class="fw-bold text-success">{{ '%.2f'|format(total_amount) }} ₪</span>
    </div>
  </div>
</div>
