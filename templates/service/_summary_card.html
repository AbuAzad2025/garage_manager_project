{% set ns = namespace(parts_total=0.0, tasks_total=0.0, net_sub=0.0) %}

{% for p in service.parts or [] %}
  {% set line = (p.line_total or 0)|float %}
  {% set ns.parts_total = ns.parts_total + line %}
  {% set ns.net_sub = ns.net_sub + line %}
{% endfor %}

{% for t in service.tasks or [] %}
  {% set line = (t.line_total or 0)|float %}
  {% set ns.tasks_total = ns.tasks_total + line %}
  {% set ns.net_sub = ns.net_sub + line %}
{% endfor %}

{% set subtotal = ns.parts_total + ns.tasks_total %}
{% set tax_rate = (service.tax_rate or 0)|float %}
{% set tax_amount = ns.net_sub * (tax_rate/100.0) %}
{% set total_amount = ns.net_sub + tax_amount %}

<div class="card border-0 shadow-lg mb-4">
  <div class="card-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-calculator"></i> ملخص الحساب</h5>
      <span class="badge bg-light text-danger fs-6">{{ '%.2f'|format(total_amount) }} ₪</span>
    </div>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
          <div>
            <i class="fas fa-cogs text-primary"></i>
            <strong>قطع الغيار</strong>
          </div>
          <span class="fw-bold text-primary">{{ '%.2f'|format(ns.parts_total) }} ₪</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
          <div>
            <i class="fas fa-tasks text-warning"></i>
            <strong>المهام</strong>
          </div>
          <span class="fw-bold text-warning">{{ '%.2f'|format(ns.tasks_total) }} ₪</span>
        </div>
      </div>
    </div>
    
    <hr class="my-4">
    
    <div class="row g-2">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center p-2">
          <span><i class="fas fa-receipt text-info"></i> الإجمالي قبل الضريبة:</span>
          <span class="fw-bold">{{ '%.2f'|format(subtotal) }} ₪</span>
        </div>
      </div>
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center p-2">
          <span><i class="fas fa-percent text-secondary"></i> صافي قبل الضريبة:</span>
          <span class="fw-bold text-primary">{{ '%.2f'|format(ns.net_sub) }} ₪</span>
        </div>
      </div>
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center p-2">
          <span><i class="fas fa-receipt text-success"></i> نسبة الضريبة:</span>
          <span class="fw-bold">{{ tax_rate|round(0, 'floor') }}%</span>
        </div>
      </div>
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center p-2">
          <span><i class="fas fa-calculator text-warning"></i> قيمة الضريبة:</span>
          <span class="fw-bold">{{ '%.2f'|format(tax_amount) }} ₪</span>
        </div>
      </div>
    </div>
    
    <hr class="my-3">
    
    <div class="d-flex justify-content-between align-items-center p-3 bg-success bg-opacity-10 rounded">
      <div>
        <i class="fas fa-crown text-success"></i>
        <strong class="fs-5">الإجمالي الكلي</strong>
      </div>
      <span class="fw-bold text-success fs-4">{{ '%.2f'|format(total_amount) }} ₪</span>
    </div>
  </div>
</div>
