{% extends "base.html" %}
{% block title %}ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©{% endblock %}
{% block page_header %}Ø·Ù„Ø¨ {{ service.service_number or ('#' ~ service.id) }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{{ url_for('service.list_requests') }}">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</a></li>
  <li class="breadcrumb-item active">ØªÙØ§ØµÙŠÙ„</li>
{% endblock %}

{% block content %}
<div class="container my-4">
  {% set STATUS_LABELS = {
    'PENDING':'Ù…Ø¹Ù„Ù‚','DIAGNOSIS':'ØªØ´Ø®ÙŠØµ','IN_PROGRESS':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
    'COMPLETED':'Ù…ÙƒØªÙ…Ù„','CANCELLED':'Ù…Ù„ØºÙŠ','ON_HOLD':'Ù…Ø¤Ø¬Ù„'
  } %}

  <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ -->
  <div class="card border-0 shadow-lg mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="fas fa-tools"></i> Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø© {{ service.service_number or ('#' ~ service.id) }}</h4>
        {% set st = (service.status.value if service.status is not string else service.status)|upper %}
        <span class="badge bg-light text-primary fs-6">{{ STATUS_LABELS.get(st, st) }}</span>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="fw-bold text-primary"><i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h6>
              <table class="table table-sm table-borderless">
                <tr><th>Ø§Ù„Ø§Ø³Ù…:</th><td>{{ service.customer and service.customer.name or 'â€”' }}</td></tr>
                <tr><th>Ø§Ù„Ø¬ÙˆØ§Ù„:</th><td>{{ service.customer and service.customer.phone or 'â€”' }}</td></tr>
                <tr><th>Ø§Ù„Ø¨Ø±ÙŠØ¯:</th><td>{{ service.customer and service.customer.email or 'â€”' }}</td></tr>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="fw-bold text-success"><i class="fas fa-car"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h6>
              <table class="table table-sm table-borderless">
                <tr><th>Ø§Ù„Ù†ÙˆØ¹:</th><td>{{ service.vehicle_type and service.vehicle_type.name or 'â€”' }}</td></tr>
                <tr><th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:</th><td>{{ service.vehicle_model or 'â€”' }}</td></tr>
                <tr><th>Ø§Ù„Ù„ÙˆØ­Ø©:</th><td>{{ service.vehicle_vrn or 'â€”' }}</td></tr>
                <tr><th>Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡:</th><td>{{ service.chassis_number or 'â€”' }}</td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="fw-bold text-warning"><i class="fas fa-calendar"></i> Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h6>
              <table class="table table-sm table-borderless">
                <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</th><td>{{ service.received_at and service.received_at.strftime('%Y-%m-%d') or 'â€”' }}</td></tr>
                <tr><th>Ø¨Ø¯Ø£Øª:</th><td>{{ service.started_at and service.started_at.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</td></tr>
                <tr><th>Ø§ÙƒØªÙ…Ù„Øª:</th><td>{{ service.completed_at and service.completed_at.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</td></tr>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="fw-bold text-info"><i class="fas fa-exclamation-triangle"></i> ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</h6>
              <p class="mb-2">{{ service.problem_description or 'â€”' }}</p>
              <h6 class="fw-bold text-secondary">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</h6>
              <p class="mb-0">{{ service.description or 'â€”' }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-gradient-success text-white">
      <h5 class="mb-0"><i class="fas fa-cogs"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h5>
    </div>
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2">
        {% set due = due_amount|default(0.0) %}
        {% if due > 0 %}
        <a href="{{ url_for('service.add_payment', rid=service.id) }}" class="btn btn-primary fw-bold">
          <i class="fas fa-cash-register"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ({{ '%.2f'|format(due) }} {{ service.currency or 'â‚ª' }})
          {% if service.fx_rate_used and service.currency != 'ILS' %}
            <br><small class="text-white-50">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: {{ "%.4f"|format(service.fx_rate_used) }}
            {% if service.fx_rate_source %}
              {% if service.fx_rate_source == 'online' %}ğŸŒ{% elif service.fx_rate_source == 'manual' %}âœï¸{% else %}âš™ï¸{% endif %}
            {% endif %}
            </small>
          {% endif %}
        </a>
        {% else %}
        <span class="badge badge-success align-self-center px-4 py-2">
          <i class="fas fa-check-circle ml-1"></i> Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        </span>
        {% endif %}
        {% if service.status.value != 'COMPLETED' %}
        <form class="d-inline" method="post" action="{{ url_for('service.toggle_service', rid=service.id, action='start') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-outline-info fw-bold"><i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
        </form>
        <form class="d-inline" method="post" action="{{ url_for('service.toggle_service', rid=service.id, action='complete') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-outline-success fw-bold"><i class="fas fa-check"></i> Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
        </form>
        {% else %}
        <form class="d-inline" method="post" action="{{ url_for('service.toggle_service', rid=service.id, action='reopen') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-outline-warning fw-bold"><i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„ØµÙŠØ§Ù†Ù‡</button>
        </form>
        {% endif %}
        <button type="button" id="previewReceiptBtn" data-url="{{ url_for('service.view_receipt', rid=service.id) }}" class="btn btn-info fw-bold">
          <i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„
        </button>
        <button type="button" id="printReceiptBtn" data-url="{{ url_for('service.view_receipt', rid=service.id) }}" class="btn btn-secondary fw-bold">
          <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
        </button>
        {% if current_user.has_permission('manage_service') %}
        <button class="btn btn-warning fw-bold" data-toggle="modal" data-target="#archiveModal">
          <i class="fas fa-archive"></i> Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨
        </button>
        <form action="{{ url_for('service.delete_request', rid=service.id) }}" method="post" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-danger btn-delete fw-bold"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  {% if current_user.has_permission('manage_service') %}
  <div class="card mb-3 shadow-sm">
    <div class="card-header bg-light fw-bold"><i class="fa fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³/Ø§Ù„ØªØ´Ø®ÙŠØµ</div>
    <div class="card-body">
      <form method="post" action="{{ url_for('service.update_diagnosis', rid=service.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <textarea class="form-control" name="diagnosis" rows="3">{{ service.diagnosis or service.engineer_notes or '' }}</textarea>
        <div class="mt-2 text-end">
          <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="mb-3">{% include 'service/_parts_table.html' %}</div>

  <!-- Modal Ø§Ù„Ø£Ø±Ø´ÙØ© -->
  <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="archiveModalLabel">
            <i class="fas fa-archive"></i> Ø£Ø±Ø´ÙØ© Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="POST" action="{{ url_for('service.archive_request', rid=service.id) }}">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>ØªØ­Ø°ÙŠØ±:</strong> Ø³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©. 
              Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªÙØ­ÙØ¸ Ø¨Ø£Ù…Ø§Ù† ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©.
            </div>
            
            <div class="mb-3">
              <label for="archiveReason" class="form-label fw-bold">Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø±Ø´ÙØ©:</label>
              <textarea class="form-control" id="archiveReason" name="reason" rows="3" required placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø£Ø±Ø´ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨..."></textarea>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> {{ service.service_number or ('#' ~ service.id) }}
              </div>
              <div class="col-md-6">
                <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ service.customer.name if service.customer else 'â€”' }}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
            <button type="submit" class="btn btn-warning fw-bold">
              <i class="fas fa-archive"></i> Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% if current_user.has_permission('manage_service') and service.status.value != 'COMPLETED' %}
  <form method="post" action="{{ url_for('service.add_part', rid=service.id) }}" class="border rounded p-3 mb-3" id="form-add-part">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" id="service-currency" value="{{ service.currency or 'ILS' }}">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</label>
        <select class="custom-select" name="warehouse_id" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
          {% for wh in warehouses %}
            <option value="{{ wh.id }}">{{ wh.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
<select class="custom-select select2" name="part_id"
        data-endpoint-by-warehouse="{{ url_for('api.api_products_by_warehouse', wid=0) }}"
        data-product-info="{{ url_for('api.product_info', pid=0) }}"
        required></select>

      </div>
      <div class="col-md-2">
        <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input type="number" class="form-control" name="quantity" min="1" value="1" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <input type="number" class="form-control" name="unit_price" step="0.01" min="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Ø§Ù„Ø®ØµÙ… (â‚ª)</label>
        <input type="number" class="form-control" name="discount" step="0.01" min="0" max="999999" value="0" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…">
      </div>
      <div class="col-md-2">
        <label class="form-label">Ø¶Ø±ÙŠØ¨Ø© %</label>
        <input type="number" class="form-control" name="tax_rate" step="0.01" min="0" value="0">
      </div>
      <div class="col-md-5">
        <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input type="text" class="form-control" name="note">
      </div>
      <div class="col-auto">
        <label class="form-label d-block">&nbsp;</label>
        <button type="button" class="btn btn-action-add" id="add-part-service"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©</button>
      </div>
    </div>
  </form>
  {% endif %}

  <div class="mb-3">{% include 'service/_tasks_table.html' %}</div>
  <div class="mb-3">{% include 'service/_payments_table.html' %}</div>
  
  <!-- Ø®ØµÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ + Ø¶Ø±ÙŠØ¨Ø© -->
  {% if current_user.has_permission('manage_service') and service.status.value in ['PENDING', 'DIAGNOSIS', 'IN_PROGRESS'] %}
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-header bg-gradient-warning text-white">
      <h5 class="mb-0"><i class="fas fa-tags"></i> Ø®ØµÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ¶Ø±ÙŠØ¨Ø©</h5>
    </div>
    <div class="card-body">
      <form method="post" action="{{ url_for('service.update_discount_tax', rid=service.id) }}" id="form-discount-tax">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label fw-bold"><i class="fas fa-tag"></i> Ø®ØµÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ (â‚ª)</label>
            <input type="number" class="form-control" name="discount_total" id="discount_total" 
                   step="0.01" min="0" max="999999" 
                   value="{{ '%.2f'|format(service.discount_total or 0) }}" 
                   placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
            <small class="form-text text-muted">Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</small>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold"><i class="fas fa-receipt"></i> Ø¶Ø±ÙŠØ¨Ø© %</label>
            <input type="number" class="form-control" name="tax_rate" id="tax_rate" 
                   step="0.01" min="0" max="100" 
                   value="{{ '%.2f'|format(service.tax_rate or 0) }}" 
                   placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©">
            <small class="form-text text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</small>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success fw-bold w-100">
              <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
  
  <div class="mb-3">{% include 'service/_summary_card.html' %}</div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/service.js') }}"></script>
{% endblock %}
