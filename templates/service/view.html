{# templates/service/view.html #}
{% extends "base.html" %}
{% block title %}ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©{% endblock %}
{% block page_header %}Ø·Ù„Ø¨ {{ service.service_number or ('#' ~ service.id) }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">

  {# ğŸ”¹ Select2 CSS #}
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{{ url_for('service.list_requests') }}">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</a></li>
  <li class="breadcrumb-item active">ØªÙØ§ØµÙŠÙ„</li>
{% endblock %}

{% block content %}
<div class="container my-4">

  {% set STATUS_LABELS = {
    'PENDING':'Ù…Ø¹Ù„Ù‚','DIAGNOSIS':'ØªØ´Ø®ÙŠØµ','IN_PROGRESS':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
    'COMPLETED':'Ù…ÙƒØªÙ…Ù„','CANCELLED':'Ù…Ù„ØºÙŠ','ON_HOLD':'Ù…Ø¤Ø¬Ù„'
  } %}

  <div class="row mb-3">
    <div class="col-md-6">
      <table class="table table-bordered table-sm">
        <tr><th style="width:140px">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><td>{{ service.service_number or ('#' ~ service.id) }}</td></tr>
        <tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><td>{{ service.name or (service.customer.name if service.customer else 'â€”') }}</td></tr>
        <tr><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><td>{{ service.phone or (service.customer.phone if service.customer else 'â€”') }}</td></tr>
        <tr><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><td>{{ service.email or (service.customer.email if service.customer else 'â€”') }}</td></tr>
        <tr><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø©</th><td>{{ service.vehicle_type.name if service.vehicle_type else 'â€”' }}</td></tr>
        <tr><th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th><td>{{ service.vehicle_model or 'â€”' }}</td></tr>
        <tr><th>Ø§Ù„Ù„ÙˆØ­Ø©</th><td>{{ service.vehicle_vrn or 'â€”' }}</td></tr>
        {% set st = (service.status.value if service.status is not string else service.status)|upper %}
        <tr>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <td>
            <span class="badge badge-{{ st|lower|replace('_','') }} badge-status">
              {{ STATUS_LABELS.get(st, st) }}
            </span>
          </td>
        </tr>
        <tr><th>Ø¨Ø¯Ø£Øª</th><td>{{ service.start_time and service.start_time.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</td></tr>
        <tr><th>Ø§ÙƒØªÙ…Ù„Øª</th><td>{{ service.end_time and service.end_time.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</td></tr>
      </table>
    </div>
    <div class="col-md-6">
      <strong>ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong>
      <div class="border p-2 mb-2">{{ service.problem_description or 'â€”' }}</div>
      <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³/Ø§Ù„ØªØ´Ø®ÙŠØµ:</strong>
      <div class="border p-2 mb-2">{{ service.diagnosis or service.engineer_notes or 'â€”' }}</div>
      <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</strong>
      <div class="border p-2 bg-light">{{ service.description or 'â€”' }}</div>
    </div>
  </div>

  <div class="mb-3 d-flex flex-wrap gap-2 actions toolbar">
    <a href="{{ url_for('service.add_payment', rid=service.id) }}" class="btn btn-primary"><i class="fas fa-cash-register"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</a>

    <form class="d-inline" method="post" action="{{ url_for('service.toggle_service', rid=service.id, action='start') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-outline-info"><i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
    </form>
    <form class="d-inline" method="post" action="{{ url_for('service.toggle_service', rid=service.id, action='complete') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-outline-success"><i class="fas fa-check"></i> Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
    </form>

    <button id="previewReceiptBtn" data-url="{{ url_for('service.view_receipt', rid=service.id) }}" class="btn btn-info"><i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>
    <a href="{{ url_for('service.export_pdf', rid=service.id) }}" target="_blank" class="btn btn-dark"><i class="fas fa-file-pdf"></i> Ø·Ø¨Ø§Ø¹Ø© PDF</a>
    <button id="printReceiptBtn" data-url="{{ url_for('service.view_receipt', rid=service.id) }}" class="btn btn-secondary"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</button>
    <a href="{{ url_for('service.download_receipt', rid=service.id) }}" class="btn btn-outline-primary"><i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø¥ÙŠØµØ§Ù„ (PDF)</a>

    {% if current_user.has_permission('manage_service') %}
    <form action="{{ url_for('service.delete_request', rid=service.id) }}" method="post" class="d-inline">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-danger btn-delete"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
    </form>
    {% endif %}
  </div>

  <div class="mb-3">{% include 'service/_parts_table.html' %}</div>

  {% if current_user.has_permission('manage_service') %}
  <form method="post" action="{{ url_for('service.add_part', rid=service.id) }}" class="border rounded p-3 mb-3" id="form-add-part">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</label>
        <select class="form-select select2" name="warehouse_id" id="warehouse_id" data-endpoint="{{ url_for('api.search_warehouses') }}" required></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
        <select class="form-select select2" name="part_id" id="part_id" data-endpoint-by-warehouse="{{ url_for('api.products_by_warehouse', wid=0) }}" required></select>
      </div>
      <div class="col-md-2"><label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" class="form-control" name="quantity" min="1" value="1" required></div>
      <div class="col-md-2"><label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input type="number" class="form-control" name="unit_price" step="0.01" min="0" required></div>
      <div class="col-md-2"><label class="form-label">Ø®ØµÙ… %</label><input type="number" class="form-control" name="discount" step="0.01" min="0"></div>
      <div class="col-md-5"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="text" class="form-control" name="note"></div>
      <div class="col-auto"><button class="btn btn-success"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©</button></div>
    </div>
  </form>
  {% endif %}

  <div class="mb-3">{% include 'service/_tasks_table.html' %}</div>

  {% if current_user.has_permission('manage_service') %}
  <form method="post" action="{{ url_for('service.add_task', rid=service.id) }}" class="border rounded p-3 mb-3" id="form-add-task">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-2 align-items-end">
      <div class="col-md-6"><label class="form-label">Ø§Ù„ÙˆØµÙ</label><input type="text" class="form-control" name="description" required></div>
      <div class="col-md-2"><label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" class="form-control" name="quantity" min="1" value="1" required></div>
      <div class="col-md-2"><label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input type="number" class="form-control" name="unit_price" step="0.01" min="0" required></div>
      <div class="col-md-2"><label class="form-label">Ø®ØµÙ… %</label><input type="number" class="form-control" name="discount" step="0.01" min="0"></div>
      <div class="col-md-2"><label class="form-label">Ø¶Ø±ÙŠØ¨Ø© %</label><input type="number" class="form-control" name="tax_rate" step="0.01" min="0"></div>
      <div class="col-auto"><button class="btn btn-success"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button></div>
    </div>
  </form>
  {% endif %}

  <div class="mb-3">{% include 'service/_payments_table.html' %}</div>
  <div class="mb-3">{% include 'service/_summary_card.html' %}</div>

</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  {# ğŸ”¹ Select2 JS Ù‚Ø¨Ù„ service.js #}
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>

  <script src="{{ url_for('static', filename='js/service.js') }}"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function(){
      // ÙØ­Øµ Ø³Ø±ÙŠØ¹: Ù„Ùˆ Select2 Ù…Ø§ ØªØ­Ù…Ù„ Ù„Ø£ÙŠ Ø³Ø¨Ø¨
      if (!window.jQuery || !jQuery.fn.select2) {
        console.warn('Select2 Ù„Ù… ÙŠÙØ­Ù…Ù‘Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª CSS/JS.');
      }

      const btn = document.getElementById("printReceiptBtn");
      if(btn){
        btn.addEventListener("click", function(){
          const url = this.dataset.url;
          if(url){
            const win = window.open(url, "_blank");
            if (win) { win.onload = () => win.print(); }
          }
        });
      }
    });
  </script>
{% endblock %}
