{# File: templates/service/view.html #}
{% extends "base.html" %}
{% block title %}تفاصيل طلب الصيانة{% endblock %}
{% block page_header %}طلب {{ service.service_number or ('#' ~ service.id) }}{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/service.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
  {# Select2 CSS #}
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2/css/select2.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{{ url_for('service.list_requests') }}">طلبات الصيانة</a></li>
  <li class="breadcrumb-item active">تفاصيل</li>
{% endblock %}

{% block content %}
<div class="container my-4">

  {% set STATUS_LABELS = {
    'PENDING':'معلق','DIAGNOSIS':'تشخيص','IN_PROGRESS':'قيد التنفيذ',
    'COMPLETED':'مكتمل','CANCELLED':'ملغي','ON_HOLD':'مؤجل'
  } %}

  <div class="row mb-3">
    <div class="col-md-6">
      <table class="table table-bordered table-sm">
        <tr><th style="width:140px">رقم الطلب</th><td>{{ service.service_number or ('#' ~ service.id) }}</td></tr>
        <tr><th>العميل</th><td>{{ service.customer and service.customer.name or '—' }}</td></tr>
        <tr><th>الجوال</th><td>{{ service.customer and service.customer.phone or '—' }}</td></tr>
        <tr><th>البريد</th><td>{{ service.customer and service.customer.email or '—' }}</td></tr>
        <tr><th>نوع المعدة</th><td>{{ service.vehicle_type and service.vehicle_type.name or '—' }}</td></tr>
        <tr><th>الموديل</th><td>{{ service.vehicle_model or '—' }}</td></tr>
        <tr><th>اللوحة</th><td>{{ service.vehicle_vrn or '—' }}</td></tr>
        {% set st = (service.status.value if service.status is not string else service.status)|upper %}
        <tr>
          <th>الحالة</th>
          <td>
            <span class="badge badge-{{ st|lower|replace('_','') }} badge-status">
              {{ STATUS_LABELS.get(st, st) }}
            </span>
          </td>
        </tr>
        <tr><th>تاريخ الاستلام</th><td>{{ service.received_at and service.received_at.strftime('%Y-%m-%d') or '—' }}</td></tr>
        <tr><th>بدأت</th><td>{{ service.started_at and service.started_at.strftime('%Y-%m-%d %H:%M') or '—' }}</td></tr>
        <tr><th>اكتملت</th><td>{{ service.completed_at and service.completed_at.strftime('%Y-%m-%d %H:%M') or '—' }}</td></tr>
      </table>
    </div>
    <div class="col-md-6">
      <strong>وصف المشكلة:</strong>
      <div class="border p-2 mb-2">{{ service.problem_description or '—' }}</div>
      <strong>ملاحظات المهندس/التشخيص:</strong>
      <div class="border p-2 mb-2">{{ service.diagnosis or service.engineer_notes or '—' }}</div>
      <strong>ملاحظات إضافية:</strong>
      <div class="border p-2 bg-light">{{ service.description or '—' }}</div>
    </div>
  </div>

  <div class="mb-3 d-flex flex-wrap gap-2 actions toolbar">
    <a href="{{ url_for('service.add_payment', rid=service.id) }}" class="btn btn-primary">
      <i class="fas fa-cash-register"></i> تسجيل دفعة
    </a>

    <form class="d-inline" method="post" action="{{ url_for('service.toggle_service', rid=service.id, action='start') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-outline-info"><i class="fas fa-play"></i> بدء الصيانة</button>
    </form>
    <form class="d-inline" method="post" action="{{ url_for('service.toggle_service', rid=service.id, action='complete') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-outline-success"><i class="fas fa-check"></i> إكمال الصيانة</button>
    </form>

    <button id="previewReceiptBtn" data-url="{{ url_for('service.view_receipt', rid=service.id) }}" class="btn btn-info">
      <i class="fas fa-eye"></i> معاينة الإيصال
    </button>
    <a href="{{ url_for('service.export_pdf', rid=service.id) }}" target="_blank" class="btn btn-dark">
      <i class="fas fa-file-pdf"></i> طباعة PDF
    </a>
    <button id="printReceiptBtn" data-url="{{ url_for('service.view_receipt', rid=service.id) }}" class="btn btn-secondary">
      <i class="fas fa-print"></i> طباعة مباشرة
    </button>
    <a href="{{ url_for('service.download_receipt', rid=service.id) }}" class="btn btn-outline-primary">
      <i class="fas fa-download"></i> تحميل إيصال (PDF)
    </a>

    {% if current_user.has_permission('manage_service') %}
    <form action="{{ url_for('service.delete_request', rid=service.id) }}" method="post" class="d-inline">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-danger btn-delete"><i class="fas fa-trash-alt"></i> حذف الطلب</button>
    </form>
    {% endif %}
  </div>

  {# جداول #}
  <div class="mb-3">{% include 'service/_parts_table.html' %}</div>

  {% if current_user.has_permission('manage_service') %}
  <form method="post" action="{{ url_for('service.add_part', rid=service.id) }}" class="border rounded p-3 mb-3" id="form-add-part">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">المستودع</label>
        <select class="form-select select2" name="warehouse_id" id="warehouse_id"
                data-endpoint="{{ url_for('api.search_warehouses') }}" required></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">القطعة</label>
        <select class="form-select select2" name="part_id" id="part_id"
                data-endpoint-by-warehouse="{{ url_for('api.products_by_warehouse', wid=0) }}"
                data-product-info="{{ url_for('api.product_info', pid=0) }}"
                required></select>
      </div>
      <div class="col-md-2">
        <label class="form-label">الكمية</label>
        <input type="number" class="form-control" name="quantity" min="1" value="1" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">سعر الوحدة</label>
        <input type="number" class="form-control" name="unit_price" step="0.01" min="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">خصم %</label>
        <input type="number" class="form-control" name="discount" step="0.01" min="0">
      </div>
      <div class="col-md-2">
        <label class="form-label">ضريبة %</label>
        <input type="number" class="form-control" name="tax_rate" step="0.01" min="0">
      </div>
      <div class="col-md-3">
        <label class="form-label">الشريك</label>
        <select class="form-select select2" name="partner_id" data-endpoint="{{ url_for('api.partners') }}"></select>
      </div>
      <div class="col-md-2">
        <label class="form-label">نسبة الشريك %</label>
        <input type="number" class="form-control" name="share_percentage" step="0.01" min="0" max="100">
      </div>
      <div class="col-md-5">
        <label class="form-label">ملاحظة</label>
        <input type="text" class="form-control" name="note">
      </div>
      <div class="col-auto">
        <label class="form-label d-block">&nbsp;</label>
        <button class="btn btn-success"><i class="fas fa-plus-circle"></i> إضافة قطعة</button>
      </div>
    </div>
  </form>
  {% endif %}

  <div class="mb-3">{% include 'service/_tasks_table.html' %}</div>

  {% if current_user.has_permission('manage_service') %}
  <form method="post" action="{{ url_for('service.add_task', rid=service.id) }}" class="border rounded p-3 mb-3" id="form-add-task">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        <label class="form-label">الوصف</label>
        <input type="text" class="form-control" name="description" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">الكمية</label>
        <input type="number" class="form-control" name="quantity" min="1" value="1" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">سعر الوحدة</label>
        <input type="number" class="form-control" name="unit_price" step="0.01" min="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">خصم %</label>
        <input type="number" class="form-control" name="discount" step="0.01" min="0">
      </div>
      <div class="col-md-2">
        <label class="form-label">ضريبة %</label>
        <input type="number" class="form-control" name="tax_rate" step="0.01" min="0">
      </div>
      <div class="col-auto">
        <label class="form-label d-block">&nbsp;</label>
        <button class="btn btn-success"><i class="fas fa-plus-circle"></i> إضافة مهمة</button>
      </div>
    </div>
  </form>
  {% endif %}

  <div class="mb-3">{% include 'service/_payments_table.html' %}</div>
  <div class="mb-3">{% include 'service/_summary_card.html' %}</div>

</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  {# Select2 JS قبل service.js #}
  <script src="{{ url_for('static', filename='adminlte/plugins/select2/js/select2.full.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/service.js') }}"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function(){
      // فحص وتحميل Select2
      if (!window.jQuery || !jQuery.fn.select2) {
        console.warn('Select2 لم يُحمّل. تأكد من المسارات إلى ملفات CSS/JS.');
      } else {
        $('.select2').select2({ theme: 'bootstrap4', width: '100%' });

        // ربط اختيار المستودع: تحميل منتجات المستودع
        const $wh = $('#warehouse_id');
        const $part = $('#part_id');
        $wh.on('change', function(){
          const wid = $(this).val();
          const base = $part.data('endpoint-by-warehouse'); // مثال: /api/warehouses/0/products
          const url = base.replace(/\/0(\/)?$/, '') + '/' + wid + '/products';
          $part.empty();
          $.getJSON(url, function(rows){
            rows.forEach(r => {
              const label = r.text + (r.available != null ? ` (متاح: ${r.available})` : '');
              $part.append(new Option(label, r.id));
            });
            $part.trigger('change');
          });
        });

        // عند اختيار قطعة: جلب السعر المتوفر (اختياري)
        $part.on('change', function(){
          const pid = $(this).val();
          const wid = $wh.val();
          const infoBase = $part.data('product-info'); // مثال: /api/products/0/info
          if (pid && infoBase) {
            const infoUrl = infoBase.replace(/\/0(\/)?info$/, '') + '/' + pid + '/info' + (wid ? `?warehouse_id=${wid}` : '');
            $.getJSON(infoUrl, function(info){
              if (info && typeof info.price !== 'undefined') {
                const $price = $('[name="unit_price"]');
                if ($price.val() === '' || Number($price.val()) === 0) $price.val(info.price);
              }
            });
          }
        });
      }

      // معاينة الإيصال
      document.getElementById("previewReceiptBtn")?.addEventListener("click", function(){
        const url = this.dataset.url;
        if(url){ window.open(url, "_blank"); }
      });

      // طباعة مباشرة
      document.getElementById("printReceiptBtn")?.addEventListener("click", function(){
        const url = this.dataset.url;
        if(url){
          const win = window.open(url, "_blank");
          if (win) { win.onload = () => win.print(); }
        }
      });
    });
  </script>
{% endblock %}
