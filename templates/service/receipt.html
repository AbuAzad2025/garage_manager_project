{% extends "base_print.html" %}
{% block title %}Ø¥ÙŠØµØ§Ù„ ØµÙŠØ§Ù†Ø©{% endblock %}

{% block head_extra %}
  {# Ø¯Ø¹Ù… Ø§ØªØ¬Ø§Ù‡ Ø¹Ø±Ø¶ÙŠ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù‹ Ø¹Ø¨Ø± ?o=landscape #}
  {% if request.args.get('o') == 'landscape' %}
  <style>
    @media print { @page { size: 297mm 210mm; margin: 12mm; } }  /* A4 landscape */
    @media print { #receipt { width: 273mm !important; padding-bottom: 18mm !important; } }/* 297-24=273 */
  </style>
  {% endif %}
{% endblock %}

{% block content %}
<div id="receipt" class="container my-4">

  <!-- Ø±Ø£Ø³ Ù…Ø¹ Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† -->
  <div class="receipt-header">
    <div class="brand">
      <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
      <div class="brand-text">
        <div class="brand-name">Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</div>
        <div class="brand-sub">Ø³Ù†Ø¯ ØµÙŠØ§Ù†Ø© / Ø·Ù„Ø¨</div>
      </div>
    </div>
    <div class="text-muted">
      Ø±Ù‚Ù… Ø§Ù„Ø®Ø¯Ù…Ø©:
      <strong>{{ service.service_number or ('SRV-' ~ service.id) }}</strong><br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®:
      {{ service.received_at and service.received_at.strftime('%Y-%m-%d') or (service.created_at and service.created_at.strftime('%Y-%m-%d')) or '' }}
    </div>
  </div>

  <div class="brand-line"></div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="box">
        <table class="table table-sm kv mb-0">
          <tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><td>{{ service.name or (service.customer.name if service.customer else 'â€”') }}</td></tr>
          <tr><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><td>{{ service.phone or (service.customer.phone if service.customer else 'â€”') }}</td></tr>
          <tr><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><td>{{ service.email or (service.customer.email if service.customer else 'â€”') }}</td></tr>
          <tr><th>Ø§Ù„Ù…Ø¹Ø¯Ø©</th><td>{{ service.vehicle_type.name if service.vehicle_type else 'â€”' }} â€“ {{ service.vehicle_model or 'â€”' }}</td></tr>
          <tr><th>Ø§Ù„Ù„ÙˆØ­Ø©</th><td>{{ service.vehicle_vrn or 'â€”' }}</td></tr>
          {% set st = (service.status.value if service.status is not string else service.status)|upper %}
          <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>{{ STATUS_LABELS.get(st, st) }}</td></tr>
          <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th><td>{{ service.received_at and service.received_at.strftime('%Y-%m-%d') or 'â€”' }}</td></tr>
        </table>
      </div>
    </div>

    <div class="col-md-6">
      <div class="box">
        <div class="mb-2">
          <div class="fw-bold mb-1">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</div>
          <div class="border rounded p-2 minh">{{ service.problem_description or 'â€”' }}</div>
        </div>
        <div>
          <div class="fw-bold mb-1">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³:</div>
          <div class="border rounded p-2 minh">{{ service.diagnosis or service.engineer_notes or 'â€”' }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ -->
  <div class="box mt-3">
    <div class="table-responsive">
      <table class="table table-bordered table-sm mb-0 receipt-table">
        <thead>
          <tr>
            <th class="col-type">Ø§Ù„Ù†ÙˆØ¹</th>
            <th class="col-desc">Ø§Ù„ÙˆØµÙ</th>
            <th class="col-qty text-end">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th class="col-unit text-end">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th class="col-sum text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>  {# Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… #}
            <th class="col-net text-end">Ø§Ù„ØµØ§ÙÙŠ</th>    {# Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… + Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© #}
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(gross_total=0.0, net_total=0.0, tax_total=0.0) %}

          {# Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± #}
          {% for part in service.parts or [] %}
            {% set qty   = (part.quantity or 0)|float %}
            {% set price = (part.unit_price or 0)|float %}
            {% set discp = (part.discount or 0)|float %}
            {% set taxp  = (part.tax_rate or 0)|float %}

            {% set gross = qty * price %}
            {% set disc_amt = gross * (discp/100.0) %}
            {% set net_before_tax = gross - disc_amt %}
            {% set tax_amt = net_before_tax * (taxp/100.0) %}
            {% set line_total = net_before_tax + tax_amt %}

            {% set ns.gross_total = ns.gross_total + gross %}
            {% set ns.net_total   = ns.net_total + net_before_tax %}
            {% set ns.tax_total   = ns.tax_total + tax_amt %}

            <tr>
              <td>Ù‚Ø·Ø¹Ø©</td>
              <td>{{ part.part.name if part.part else ('#' ~ part.part_id) }}</td>
              <td class="text-end">{{ qty|round(2) }}</td>
              <td class="text-end">{{ '%.2f'|format(price) }}</td>
              <td class="text-end">{{ '%.2f'|format(gross) }}</td>
              <td class="text-end">{{ '%.2f'|format(line_total) }}</td>
            </tr>
          {% endfor %}

          {# Ø§Ù„Ù…Ù‡Ø§Ù…/Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ #}
          {% for task in service.tasks or [] %}
            {% set qty   = (task.quantity or 0)|float %}
            {% set price = (task.unit_price or 0)|float %}
            {% set discp = (task.discount or 0)|float %}
            {% set taxp  = (task.tax_rate or 0)|float %}

            {% set gross = qty * price %}
            {% set disc_amt = gross * (discp/100.0) %}
            {% set net_before_tax = gross - disc_amt %}
            {% set tax_amt = net_before_tax * (taxp/100.0) %}
            {% set line_total = net_before_tax + tax_amt %}

            {% set ns.gross_total = ns.gross_total + gross %}
            {% set ns.net_total   = ns.net_total + net_before_tax %}
            {% set ns.tax_total   = ns.tax_total + tax_amt %}

            <tr>
              <td>Ù…Ù‡Ù…Ø©</td>
              <td>{{ task.description or 'â€”' }}</td>
              <td class="text-end">{{ qty|round(2) }}</td>
              <td class="text-end">{{ '%.2f'|format(price) }}</td>
              <td class="text-end">{{ '%.2f'|format(gross) }}</td>
              <td class="text-end">{{ '%.2f'|format(line_total) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ #}
  {% set subtotal_before_discount = ns.gross_total %}
  {% set net_after_discount       = ns.net_total %}
  {% set tax_amount               = ns.tax_total %}
  {% set grand_total              = net_after_discount + tax_amount %}

  <div class="row g-3 mt-3">
    <div class="col-md-6"></div>
    <div class="col-md-6">
      <div class="box totals">
        <div class="rowline"><span class="label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span class="value">{{ '%.2f'|format(subtotal_before_discount) }} â‚ª</span></div>
        <div class="rowline"><span class="label">Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</span><span class="value text-primary">{{ '%.2f'|format(net_after_discount) }} â‚ª</span></div>
        <div class="rowline"><span class="label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©</span><span class="value">{{ '%.2f'|format(tax_amount) }} â‚ª</span></div>
        <hr class="my-2">
        <div class="rowline"><span class="label fw-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span class="value highlight">{{ '%.2f'|format(grand_total) }} â‚ª</span></div>
      </div>
    </div>
  </div>

  <!-- Ø²Ø± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· -->
  <div class="text-center mt-4 actions no-print">
    <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <a class="btn btn-secondary" href="{{ url_for('service.view_request', rid=service.id) }}">Ø±Ø¬ÙˆØ¹</a>
  </div>
</div>

<!-- ÙÙˆØªØ± Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø®Ø§Øµ (Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
<div class="receipt-footer text-center">
  Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ â€” Ù†ØªØ´Ø±Ù Ø¨Ø®Ø¯Ù…ØªÙƒÙ… â€” Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† â€” Ø¬ÙˆØ§Ù„: 0592800646 â€” ÙˆØ§ØªØ³Ø§Ø¨: +970592800646
</div>
{% endblock %}
