{% extends "base_print.html" %}
{% block title %}Ø¥ÙŠØµØ§Ù„ ØµÙŠØ§Ù†Ø©{% endblock %}

{% block head_extra %}
{% set STATUS_LABELS = {'PENDING':'Ù…Ø¹Ù„Ù‚','DIAGNOSIS':'ØªØ´Ø®ÙŠØµ','IN_PROGRESS':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','COMPLETED':'Ù…ÙƒØªÙ…Ù„','CANCELLED':'Ù…Ù„ØºÙŠ','ON_HOLD':'Ù…Ø¤Ø¬Ù„'} %}
{% set is_simple = (variant == 'simple') %}
<style>
@page { size:A4 portrait; margin:10mm 8mm 12mm 8mm; }
html,body{font-family:"DejaVu Sans","Amiri","Tahoma","Arial",sans-serif;direction:rtl;text-align:right;font-size:11.5px;line-height:1.4;background:#fff;color:#111;margin:0;padding:0;-webkit-print-color-adjust:exact;print-color-adjust:exact;box-sizing:border-box;}
*,*::before,*::after{box-sizing:border-box;}
#receipt{max-width:620px;margin:0 auto;padding:10mm 9mm;background:#fff;border:1px solid #ccc;}
.hero{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;border:1px solid #000;padding:10px;border-radius:8px;background:linear-gradient(#fff,#f3f3f3);color:#111;margin-bottom:10px;}
.hero-brand{display:flex;align-items:center;gap:10px;}
.hero-logo{width:40px;height:40px;border-radius:10px;border:1px solid #666;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fff;}
.hero-logo img{max-width:32px;max-height:32px;display:block;}
.hero-text{display:flex;flex-direction:column;gap:3px;}
.hero-name{font-size:15px;font-weight:700;}
.hero-sub{font-size:10px;text-transform:uppercase;letter-spacing:.4px;color:#333;}
.hero-meta{display:grid;gap:6px;min-width:160px;}
.meta-item{border:1px solid #999;border-radius:8px;padding:6px 8px;background:#fafafa;display:flex;flex-direction:column;}
.meta-label{font-size:9px;color:#555;text-transform:uppercase;letter-spacing:.3px;}
.meta-value{font-size:12px;font-weight:700;margin-top:3px;color:#111;}
.summary-strip{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0;}
.summary-pill{flex:1;min-width:150px;border:1px solid #aaa;border-radius:10px;background:#fdfdfd;padding:9px 10px;display:flex;flex-direction:column;gap:4px;}
.summary-label{font-size:10px;color:#444;}
.summary-value{font-size:15px;font-weight:700;color:#111;}
.summary-meta{font-size:9px;color:#666;}
.section{border:1px solid #cfd2d7;border-radius:10px;padding:11px 12px;background:#fff;margin-bottom:10px;}
.section-title{font-size:12.5px;font-weight:700;color:#202a38;display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.badge-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:20px;background:#f1f1f1;color:#333;font-size:9px;font-weight:700;border:1px solid #d5d8dd;}
.info-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));}
.data-card{border:1px solid #d4d7db;border-radius:8px;padding:9px;background:#fafbfc;display:flex;flex-direction:column;gap:4px;}
.data-label{font-size:9.5px;color:#54606e;text-transform:uppercase;}
.data-value{font-size:14px;font-weight:700;color:#181f27;}
.data-note{font-size:10px;color:#6f7a88;}
.table{width:100%;border-collapse:collapse;margin-top:8px;}
.table thead th{background:#f1f3f6;color:#1a1f2d;border:1px solid #cfd2d7;font-size:10.5px;padding:8px;text-align:center;}
.table td,.table th{padding:8px;border:1px solid #d4d7db;font-size:10.5px;}
.table tbody td{background:#fff;}
.table-empty{color:#8d97a6;padding:12px 0;text-align:center;font-style:italic;}
.totals{max-width:260px;margin:14px 0 0 auto;border:1px solid #cfd2d7;border-radius:10px;padding:11px 12px;background:#fafafa;}
.totals-row{display:flex;justify-content:space-between;padding:5px 0;font-size:10.5px;color:#202a38;}
.totals-row.final{border-top:1px solid #d4d7db;margin-top:8px;padding-top:9px;font-size:13px;font-weight:800;color:#111;}
.no-print{margin-top:12px;text-align:center;font-size:10.5px;}
.switcher{display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:6px;}
.switcher a{display:inline-flex;align-items:center;justify-content:center;padding:7px 13px;border-radius:20px;font-size:10.5px;font-weight:700;text-decoration:none;background:#e9edf3;color:#1f2d3d;border:1px solid #cfd2d7;}
.switcher a.active{background:#1f2d3d;color:#fff;}
.print-btn{padding:8px 16px;border-radius:20px;border:1px solid #1f2d3d;background:#1f2d3d;color:#fff;font-size:10.5px;font-weight:700;margin:0 6px;cursor:pointer;}
.back-btn{padding:8px 16px;border-radius:20px;border:1px solid #cfd2d7;background:#f1f3f6;color:#1f2d3d;font-size:10.5px;font-weight:700;margin:0 6px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;}
@media print{body{background:#fff;}#receipt{max-width:100%;padding:0 6mm;border:0;} .hero,.summary-strip,.section,.totals{margin-bottom:8px;} .switcher,.print-btn,.back-btn{display:none!important;}}
</style>
{% endblock %}

{% block content %}
{% set status_code = (service.status.value if service.status and service.status is not string else service.status) %}
{% set status_label = STATUS_LABELS.get((status_code or '')|upper, status_code or 'â€”') %}
{% set ns = namespace(gross_total=0.0, items_discount=0.0, net_total=0.0) %}
{% for part in (service.parts or []) %}
  {% set qty = (part.quantity or 0)|float %}
  {% set price = (part.unit_price or 0)|float %}
  {% set disc = (part.discount or 0)|float %}
  {% set gross = qty * price %}
  {% set net = gross - disc %}
  {% set ns.gross_total = ns.gross_total + gross %}
  {% set ns.items_discount = ns.items_discount + disc %}
  {% set ns.net_total = ns.net_total + net %}
{% endfor %}
{% for task in (service.tasks or []) %}
  {% set qty = (task.quantity or 0)|float %}
  {% set price = (task.unit_price or 0)|float %}
  {% set disc = (task.discount or 0)|float %}
  {% set gross = qty * price %}
  {% set net = gross - disc %}
  {% set ns.gross_total = ns.gross_total + gross %}
  {% set ns.items_discount = ns.items_discount + disc %}
  {% set ns.net_total = ns.net_total + net %}
{% endfor %}
{% set global_discount = (service.discount_total or 0)|float %}
{% set subtotal_after_all_disc = ns.net_total - global_discount %}
{% set tax_rate = (service.tax_rate or 0)|float %}
{% set tax_amount = subtotal_after_all_disc * (tax_rate/100.0) %}
{% set grand_total = subtotal_after_all_disc + tax_amount %}

<div id="receipt">
  <div class="switcher" style="margin-bottom:6px;">
    <a href="{{ url_for('service.view_receipt', rid=service.id) }}" class="{{ '' if is_simple else 'active' }}">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</a>
    <a href="{{ url_for('service.view_receipt', rid=service.id, simple=1) }}" class="{{ 'active' if is_simple else '' }}">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©</a>
  </div>
  <div class="hero">
    <div class="hero-brand">
      <div class="hero-logo">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" onerror="this.closest('.hero-logo').style.display='none'">
      </div>
      <div class="hero-text">
        {% set brand_name = system_settings.company_name %}
        {% if not brand_name or ('azad' in brand_name|lower) or ('Ø§Ø²Ø§Ø¯' in brand_name) or ('Ø£Ø²Ø§Ø¯' in brand_name) %}
        {% set brand_name = 'Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©' %}
        {% endif %}
        <div class="hero-name">{{ brand_name }}</div>
        <div class="hero-sub">Service Receipt</div>
      </div>
    </div>
    <div class="hero-meta">
      <div class="meta-item">
        <span class="meta-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</span>
        <span class="meta-value">{{ service.service_number or ('SRV-' ~ service.id) }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
        <span class="meta-value">{{ service.received_at.strftime('%Y-%m-%d') if service.received_at else 'â€”' }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
        <span class="meta-value">{{ status_label }}</span>
      </div>
    </div>
  </div>

  <div class="summary-strip">
    <div class="summary-pill">
      <span class="summary-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…Ù„</span>
      <span class="summary-value">{{ '%.2f'|format(ns.gross_total) }} {{ service.currency or 'â‚ª' }}</span>
      <span class="summary-meta">Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø³ÙˆÙ…Ø§Øª</span>
    </div>
    <div class="summary-pill">
      <span class="summary-label">Ø§Ù„Ø­Ø³ÙˆÙ…Ø§Øª</span>
      <span class="summary-value">{{ '%.2f'|format(ns.items_discount + global_discount) }} {{ service.currency or 'â‚ª' }}</span>
      <span class="summary-meta">Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
    </div>
    <div class="summary-pill">
      <span class="summary-label">Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
      <span class="summary-value">{{ '%.2f'|format(grand_total) }} {{ service.currency or 'â‚ª' }}</span>
      <span class="summary-meta">{{ tax_rate > 0 and ('ÙŠØ´Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø© ' ~ ('%.0f'|format(tax_rate)) ~ '%') or 'Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©' }}</span>
    </div>
  </div>

  <div class="section">
    <div class="section-title">
      Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø©
      <span class="badge-chip">{{ service.customer.name if service.customer else 'Ø¨Ø¯ÙˆÙ† Ø¹Ù…ÙŠÙ„' }}</span>
    </div>
    <div class="info-grid">
      <div class="data-card">
        <span class="data-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
        <span class="data-value">{{ service.customer.name if service.customer else 'â€”' }}</span>
        <span class="data-note">{{ service.customer.phone if service.customer else 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…' }}</span>
      </div>
      <div class="data-card">
        <span class="data-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</span>
        <span class="data-value">{{ service.vehicle_type.name if service.vehicle_type else 'â€”' }}</span>
        <span class="data-note">{{ service.vehicle_model or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
      </div>
      <div class="data-card">
        <span class="data-label">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</span>
        <span class="data-value">{{ service.vehicle_vrn or 'â€”' }}</span>
        <span class="data-note">{{ status_label }}</span>
      </div>
    </div>
    {% if service.problem_description or service.engineer_notes %}
    <div class="data-card" style="margin-top:12px;">
      <span class="data-label">Ø§Ù„ÙˆØµÙ Ø§Ù„ÙÙ†ÙŠ</span>
      <span class="data-value" style="font-size:13px;font-weight:600;">{{ service.problem_description or service.engineer_notes }}</span>
      {% if service.engineer_notes and service.problem_description %}
      <span class="data-note">{{ service.engineer_notes }}</span>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <div class="section">
    <div class="section-title">
      ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
      <span class="badge-chip">{{ (service.parts|length + service.tasks|length) if service.parts or service.tasks else 0 }} Ø¨Ù†ÙˆØ¯</span>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Ø§Ù„Ù†ÙˆØ¹</th>
          <th>Ø§Ù„ÙˆØµÙ</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø®ØµÙ…</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        </tr>
      </thead>
      <tbody>
        {% for part in (service.parts or []) %}
        {% set qty = (part.quantity or 0)|float %}
        {% set price = (part.unit_price or 0)|float %}
        {% set disc = (part.discount or 0)|float %}
        {% set gross = qty * price %}
        {% set net = gross - disc %}
        <tr>
          <td>Ù‚Ø·Ø¹Ø©</td>
          <td class="info-value">{{ part.part.name if part.part else 'â€”' }}</td>
          <td>{{ qty|int }}</td>
          <td class="num">{{ '%.2f'|format(price) }}</td>
          <td class="num">{{ disc > 0 and ('%.2f'|format(disc)) or 'â€”' }}</td>
          <td class="num">{{ '%.2f'|format(net) }}</td>
        </tr>
        {% endfor %}
        {% for task in (service.tasks or []) %}
        {% set qty = (task.quantity or 0)|float %}
        {% set price = (task.unit_price or 0)|float %}
        {% set disc = (task.discount or 0)|float %}
        {% set gross = qty * price %}
        {% set net = gross - disc %}
        <tr>
          <td>Ù…Ù‡Ù…Ø©</td>
          <td class="info-value">{{ task.description or 'â€”' }}</td>
          <td>{{ qty|int }}</td>
          <td class="num">{{ '%.2f'|format(price) }}</td>
          <td class="num">{{ disc > 0 and ('%.2f'|format(disc)) or 'â€”' }}</td>
          <td class="num">{{ '%.2f'|format(net) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      {% if not service.parts and not service.tasks %}
      <tbody>
        <tr>
          <td colspan="6" class="table-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø³Ø¬Ù„Ø©</td>
        </tr>
      </tbody>
      {% endif %}
    </table>
  </div>

  <div class="totals">
    <div class="totals-row">
      <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span>
      <span>{{ '%.2f'|format(ns.gross_total) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% if ns.items_discount > 0 %}
    <div class="totals-row">
      <span>Ø®ØµÙ… Ø§Ù„Ø¨Ù†ÙˆØ¯</span>
      <span>-{{ '%.2f'|format(ns.items_discount) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% endif %}
    {% if global_discount > 0 %}
    <div class="totals-row">
      <span>Ø®ØµÙ… Ø¥Ø¶Ø§ÙÙŠ</span>
      <span>-{{ '%.2f'|format(global_discount) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% endif %}
    <div class="totals-row">
      <span>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</span>
      <span>{{ '%.2f'|format(subtotal_after_all_disc) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% if tax_rate > 0 %}
    <div class="totals-row">
      <span>Ø¶Ø±ÙŠØ¨Ø© {{ '%.0f'|format(tax_rate) }}%</span>
      <span>{{ '%.2f'|format(tax_amount) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% endif %}
    <div class="totals-row final">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
      <span>{{ '%.2f'|format(grand_total) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
  </div>

  <div class="no-print">
    <div class="switcher" style="margin-bottom:6px;">
      <a href="{{ url_for('service.view_receipt', rid=service.id) }}" class="{{ '' if is_simple else 'active' }}">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</a>
      <a href="{{ url_for('service.view_receipt', rid=service.id, simple=1) }}" class="{{ 'active' if is_simple else '' }}">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©</a>
    </div>
    <div>
      <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <a class="back-btn" href="{{ url_for('service.view_request', rid=service.id) }}">Ø±Ø¬ÙˆØ¹</a>
    </div>
  </div>
</div>
{% endblock %}
