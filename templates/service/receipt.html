{% extends "base.html" %}
{% block title %}Ø¥ÙŠØµØ§Ù„ ØµÙŠØ§Ù†Ø©{% endblock %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
{% endblock %}

{% block content %}
<div class="container my-4">
  <h3 class="text-center mb-4">Ø³Ù†Ø¯ ØµÙŠØ§Ù†Ø© / Ø·Ù„Ø¨ {{ service.service_number or ('#' ~ service.id) }}</h3>

  {% set STATUS_LABELS = {
    'PENDING':'Ù…Ø¹Ù„Ù‚','DIAGNOSIS':'ØªØ´Ø®ÙŠØµ','IN_PROGRESS':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
    'COMPLETED':'Ù…ÙƒØªÙ…Ù„','CANCELLED':'Ù…Ù„ØºÙŠ','ON_HOLD':'Ù…Ø¤Ø¬Ù„'
  } %}

  <div class="row">
    <div class="col-md-6">
      <table class="table table-sm">
        <tr><th style="width:120px">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><td>{{ service.name or (service.customer.name if service.customer else 'â€”') }}</td></tr>
        <tr><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><td>{{ service.phone or (service.customer.phone if service.customer else 'â€”') }}</td></tr>
        <tr><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><td>{{ service.email or (service.customer.email if service.customer else 'â€”') }}</td></tr>
        <tr><th>Ø§Ù„Ù…Ø¹Ø¯Ø©</th><td>{{ service.vehicle_type.name if service.vehicle_type else 'â€”' }} â€“ {{ service.vehicle_model or 'â€”' }}</td></tr>
        <tr><th>Ø§Ù„Ù„ÙˆØ­Ø©</th><td>{{ service.vehicle_vrn or 'â€”' }}</td></tr>
        {% set st = (service.status.value if service.status is not string else service.status)|upper %}
        <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>{{ STATUS_LABELS.get(st, st) }}</td></tr>
      </table>
    </div>
    <div class="col-md-6">
      <strong>ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong>
      <div class="border p-2 mb-2">{{ service.problem_description or 'â€”' }}</div>
      <strong>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³:</strong>
      <div class="border p-2 mb-2">{{ service.diagnosis or service.engineer_notes or 'â€”' }}</div>
    </div>
  </div>

  <hr>

  <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø·ÙˆØ± -->
  <div class="table-responsive">
    <table class="table table-bordered table-sm">
      <thead>
        <tr>
          <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø´Ø±ÙŠÙƒ</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØµØ§ÙÙŠ</th>
        </tr>
      </thead>
      <tbody>
        {% set ns = namespace(parts_total=0.0, tasks_total=0.0, net_sub=0.0) %}

        {# Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± #}
        {% for part in service.parts or [] %}
          {% set qty   = (part.quantity or 0)|float %}
          {% set price = (part.unit_price or 0)|float %}
          {% set disc  = (part.discount or 0)|float %}
          {% set share = (part.share_percentage or 0)|float %}
          {% set line      = qty * price * (1 - (disc / 100.0)) %}
          {% set net_line  = line * (1 - (share / 100.0)) %}
          {% set ns.parts_total = ns.parts_total + line %}
          {% set ns.net_sub     = ns.net_sub + net_line %}
          <tr>
            <td>Ù‚Ø·Ø¹Ø©</td>
            <td>{{ part.part.name if part.part else ('#' ~ part.part_id) }}</td>
            <td>{{ part.partner.name if part.partner else 'â€”' }}</td>
            <td>{{ (share)|round(0, 'floor') }}%</td>
            <td>{{ qty|round(2) }}</td>
            <td>{{ '%.2f'|format(price) }}</td>
            <td>{{ '%.2f'|format(line) }}</td>
            <td>{{ '%.2f'|format(net_line) }}</td>
          </tr>
        {% endfor %}

        {# Ø§Ù„Ù…Ù‡Ø§Ù… #}
        {% for task in service.tasks or [] %}
          {% set qty   = (task.quantity or 0)|float %}
          {% set price = (task.unit_price or 0)|float %}
          {% set disc  = (task.discount or 0)|float %}
          {% set line  = qty * price * (1 - (disc / 100.0)) %}
          {% set ns.tasks_total = ns.tasks_total + line %}
          <tr>
            <td>Ù…Ù‡Ù…Ø©</td>
            <td>{{ task.description or 'â€”' }}</td>
            <td>â€”</td>
            <td>â€”</td>
            <td>{{ qty|round(2) }}</td>
            <td>{{ '%.2f'|format(price) }}</td>
            <td>{{ '%.2f'|format(line) }}</td>
            <td>{{ '%.2f'|format(line) }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% set subtotal     = (ns.parts_total + ns.tasks_total) %}
  {% set net_subtotal = (ns.net_sub + ns.tasks_total) %}
  {% set tax_rate     = (service.tax_rate or 0)|float %}
  {% set tax_amount   = net_subtotal * (tax_rate / 100.0) %}
  {% set total_amount = net_subtotal + tax_amount %}

  <div class="d-flex justify-content-end flex-column align-items-end">
    <div class="me-4"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø®ØµÙ… Ø§Ù„Ø´Ø±ÙŠÙƒ:</strong> {{ '%.2f'|format(subtotal) }} â‚ª</div>
    <div class="me-4 text-primary"><strong>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø´Ø±ÙŠÙƒ:</strong> {{ '%.2f'|format(net_subtotal) }} â‚ª</div>
    <div class="me-4"><strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ({{ tax_rate|round(0,'floor') }}%):</strong> {{ '%.2f'|format(tax_amount) }} â‚ª</div>
    <div class="fs-5"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> <span class="text-success">{{ '%.2f'|format(total_amount) }} â‚ª</span></div>
  </div>

  <div class="text-center mt-4 actions">
    <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>
{% endblock %}
