{% extends "base_print.html" %}
{% block title %}Ø¥ÙŠØµØ§Ù„ ØµÙŠØ§Ù†Ø©{% endblock %}

{% block head_extra %}
{% set STATUS_LABELS = {'PENDING':'Ù…Ø¹Ù„Ù‚','DIAGNOSIS':'ØªØ´Ø®ÙŠØµ','IN_PROGRESS':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','COMPLETED':'Ù…ÙƒØªÙ…Ù„','CANCELLED':'Ù…Ù„ØºÙŠ','ON_HOLD':'Ù…Ø¤Ø¬Ù„'} %}
<style>
@page { 
  size: A4 portrait; 
  margin: 15mm 15mm 20mm 15mm;
}

html, body {
  font-family: "Tahoma", "Arial", sans-serif;
  direction: rtl;
  text-align: right;
  font-size: 14px;
  line-height: 1.6;
  color: #000;
  background: #fff;
  margin: 0;
  padding: 0;
}

#receipt {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background: white;
}

.header {
  text-align: center;
  border-bottom: 3px solid #0d6efd;
  padding-bottom: 15px;
  margin-bottom: 20px;
}

.header h1 {
  color: #0d6efd;
  font-size: 24px;
  margin: 0 0 5px 0;
  font-weight: bold;
}

.header .subtitle {
  color: #666;
  font-size: 16px;
  margin: 5px 0;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 20px;
}

.info-box {
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 15px;
  background: #f8f9fa;
}

.info-box h3 {
  color: #0d6efd;
  font-size: 16px;
  margin: 0 0 10px 0;
  padding-bottom: 8px;
  border-bottom: 2px solid #0d6efd;
}

.info-row {
  display: flex;
  padding: 5px 0;
}

.info-row strong {
  min-width: 100px;
  color: #555;
}

.items-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

.items-table thead {
  background: #0d6efd;
  color: white;
}

.items-table th {
  padding: 12px 8px;
  text-align: center;
  font-weight: bold;
  border: 1px solid #0d6efd;
}

.items-table td {
  padding: 10px 8px;
  border: 1px solid #dee2e6;
  text-align: center;
}

.items-table tbody tr:nth-child(even) {
  background: #f8f9fa;
}

.items-table .num {
  text-align: left;
  font-family: monospace;
  font-weight: 600;
}

.totals-box {
  max-width: 400px;
  margin: 20px 0 20px auto;
  border: 2px solid #0d6efd;
  border-radius: 8px;
  padding: 15px;
  background: #f8f9fa;
}

.totals-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 15px;
}

.totals-row.discount {
  color: #dc3545;
  font-weight: bold;
}

.totals-row.final {
  border-top: 3px double #0d6efd;
  margin-top: 10px;
  padding-top: 15px;
  font-size: 18px;
  font-weight: bold;
  color: #0d6efd;
}

.signatures {
  display: flex;
  gap: 40px;
  margin-top: 50px;
  padding-top: 20px;
}

.signature {
  flex: 1;
  text-align: center;
}

.signature-line {
  border-top: 2px solid #000;
  margin-bottom: 8px;
  padding-top: 60px;
}

.footer {
  text-align: center;
  margin-top: 30px;
  padding-top: 15px;
  border-top: 2px solid #0d6efd;
  color: #666;
  font-size: 13px;
}

.no-print {
  text-align: center;
  margin: 20px 0;
}

@media print {
  body { margin: 0; padding: 0; }
  .no-print { display: none !important; }
  .btn { display: none !important; }
  @page { margin: 15mm; }
}
</style>
{% endblock %}

{% block content %}
<div id="receipt">
  <div class="header">
    <h1>ğŸ”§ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</h1>
    <div class="subtitle">Ø¥ÙŠØµØ§Ù„ Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©</div>
    <div style="margin-top:10px">
      <strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> {{ service.service_number or ('SRV-' ~ service.id) }} | 
      <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ service.received_at.strftime('%Y-%m-%d') if service.received_at else 'â€”' }}
    </div>
  </div>

  <div class="info-grid">
    <div class="info-box">
      <h3>ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
      <div class="info-row"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ service.customer.name if service.customer else 'â€”' }}</div>
      <div class="info-row"><strong>Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> {{ service.customer.phone if service.customer else 'â€”' }}</div>
      <div class="info-row"><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> {{ service.customer.email if service.customer else 'â€”' }}</div>
    </div>

    <div class="info-box">
      <h3>ğŸš— Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>
      <div class="info-row"><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> {{ service.vehicle_type.name if service.vehicle_type else 'â€”' }}</div>
      <div class="info-row"><strong>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:</strong> {{ service.vehicle_model or 'â€”' }}</div>
      <div class="info-row"><strong>Ø§Ù„Ù„ÙˆØ­Ø©:</strong> {{ service.vehicle_vrn or 'â€”' }}</div>
      {% set st = (service.status.value if service.status and service.status is not string else service.status) %}
      <div class="info-row"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> {{ STATUS_LABELS.get((st or '')|upper, st or 'â€”') }}</div>
    </div>
  </div>

  {% if service.problem_description or service.engineer_notes %}
  <div class="info-box" style="margin-bottom:20px">
    <h3>ğŸ“‹ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
    {% if service.problem_description %}
    <div class="info-row"><strong>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong> {{ service.problem_description }}</div>
    {% endif %}
    {% if service.engineer_notes %}
    <div class="info-row"><strong>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ:</strong> {{ service.engineer_notes }}</div>
    {% endif %}
  </div>
  {% endif %}

  <h3 style="color:#0d6efd; margin:20px 0 10px 0">ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©</h3>

  <table class="items-table">
    <thead>
      <tr>
        <th style="width:10%">Ø§Ù„Ù†ÙˆØ¹</th>
        <th style="width:40%">Ø§Ù„ÙˆØµÙ</th>
        <th style="width:10%">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th style="width:15%">Ø§Ù„Ø³Ø¹Ø±</th>
        <th style="width:12%">Ø§Ù„Ø®ØµÙ…</th>
        <th style="width:13%">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      </tr>
    </thead>
    <tbody>
      {% set ns = namespace(gross_total=0.0, items_discount=0.0, net_total=0.0) %}
      
      {% for part in (service.parts or []) %}
        {% set qty = (part.quantity or 0)|float %}
        {% set price = (part.unit_price or 0)|float %}
        {% set disc = (part.discount or 0)|float %}
        {% set gross = qty * price %}
        {% set net = gross - disc %}
        {% set ns.gross_total = ns.gross_total + gross %}
        {% set ns.items_discount = ns.items_discount + disc %}
        {% set ns.net_total = ns.net_total + net %}
        <tr>
          <td>Ù‚Ø·Ø¹Ø©</td>
          <td style="text-align:right">{{ part.part.name if part.part else 'â€”' }}</td>
          <td>{{ qty|int }}</td>
          <td class="num">{{ '%.2f'|format(price) }}</td>
          <td class="num">{{ '%.2f'|format(disc) if disc > 0 else 'â€”' }}</td>
          <td class="num"><strong>{{ '%.2f'|format(net) }}</strong></td>
        </tr>
      {% endfor %}
      
      {% for task in (service.tasks or []) %}
        {% set qty = (task.quantity or 0)|float %}
        {% set price = (task.unit_price or 0)|float %}
        {% set disc = (task.discount or 0)|float %}
        {% set gross = qty * price %}
        {% set net = gross - disc %}
        {% set ns.gross_total = ns.gross_total + gross %}
        {% set ns.items_discount = ns.items_discount + disc %}
        {% set ns.net_total = ns.net_total + net %}
        <tr>
          <td>Ù…Ù‡Ù…Ø©</td>
          <td style="text-align:right">{{ task.description or 'â€”' }}</td>
          <td>{{ qty|int }}</td>
          <td class="num">{{ '%.2f'|format(price) }}</td>
          <td class="num">{{ '%.2f'|format(disc) if disc > 0 else 'â€”' }}</td>
          <td class="num"><strong>{{ '%.2f'|format(net) }}</strong></td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% set global_discount = (service.discount_total or 0)|float %}
  {% set subtotal_after_all_disc = ns.net_total - global_discount %}
  {% set tax_rate = (service.tax_rate or 0)|float %}
  {% set tax_amount = subtotal_after_all_disc * (tax_rate/100.0) %}
  {% set grand_total = subtotal_after_all_disc + tax_amount %}

  <div class="totals-box">
    <div class="totals-row">
      <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span>
      <span class="num">{{ '%.2f'|format(ns.gross_total) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    
    {% if ns.items_discount > 0 %}
    <div class="totals-row discount">
      <span>Ø®ØµÙ… Ø§Ù„Ø¨Ù†ÙˆØ¯:</span>
      <span class="num">-{{ '%.2f'|format(ns.items_discount) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% endif %}
    
    {% if global_discount > 0 %}
    <div class="totals-row discount">
      <span>Ø®ØµÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
      <span class="num">-{{ '%.2f'|format(global_discount) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% endif %}
    
    <div class="totals-row">
      <span>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</span>
      <span class="num">{{ '%.2f'|format(subtotal_after_all_disc) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    
    {% if tax_rate > 0 %}
    <div class="totals-row">
      <span>Ø¶Ø±ÙŠØ¨Ø© ({{ '%.0f'|format(tax_rate) }}%):</span>
      <span class="num">{{ '%.2f'|format(tax_amount) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
    {% endif %}
    
    <div class="totals-row final">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
      <span class="num">{{ '%.2f'|format(grand_total) }} {{ service.currency or 'â‚ª' }}</span>
    </div>
  </div>

  <div class="signatures">
    <div class="signature">
      <div class="signature-line"></div>
      <strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</strong>
    </div>
    <div class="signature">
      <div class="signature-line"></div>
      <strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</strong>
    </div>
  </div>

  <div class="footer">
    <p><strong>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</strong></p>
    <p>Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ | Ø¬ÙˆØ§Ù„: 0592800646 | ÙˆØ§ØªØ³Ø§Ø¨: +970592800646</p>
    <p>Ù†Ø´ÙƒØ±ÙƒÙ… Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§ ÙˆÙ†ØªØ´Ø±Ù Ø¨Ø®Ø¯Ù…ØªÙƒÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹</p>
  </div>

  <div class="no-print">
    <button class="btn btn-primary btn-lg" onclick="window.print()" style="padding:12px 30px; font-size:16px; margin:10px">
      ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
    </button>
    <a class="btn btn-secondary btn-lg" href="{{ url_for('service.view_request', rid=service.id) }}" style="padding:12px 30px; font-size:16px; margin:10px">
      â†©ï¸ Ø±Ø¬ÙˆØ¹
    </a>
  </div>
</div>

<style>
@media print {
  body { 
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  .no-print, .btn { display: none !important; }
  .header { page-break-after: avoid; }
  .info-grid { page-break-inside: avoid; }
  .items-table { page-break-inside: avoid; }
  .totals-box { page-break-inside: avoid; }
}
</style>
{% endblock %}
