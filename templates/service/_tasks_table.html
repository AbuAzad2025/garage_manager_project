<div class="card border-0 shadow-lg mb-4">
  <div class="card-header" style="background: linear-gradient(135deg, #f12711 0%, #f5af19 100%); color: white;">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-tasks"></i> المهام</h5>
      <span class="badge bg-light text-warning fs-6">{{ service.tasks|length if service.tasks else 0 }} مهمة</span>
    </div>
  </div>
  <div class="card-body p-0">
    {% if service.tasks %}
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th><i class="fas fa-clipboard-list"></i> الوصف</th>
            <th><i class="fas fa-sticky-note"></i> الملاحظات</th>
            <th><i class="fas fa-hashtag"></i> الكمية</th>
            <th><i class="fas fa-dollar-sign"></i> سعر الوحدة</th>
            <th><i class="fas fa-calculator"></i> الإجمالي</th>
            {% if current_user.has_permission('manage_service') %}
            <th style="width:80px"><i class="fas fa-cogs"></i> إجراء</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for task in service.tasks %}
            {% set line = task.line_total
                          if task.line_total is not none
                          else ((task.quantity or 0) * (task.unit_price or 0) - (task.discount or 0)) %}
            <tr>
              <td>
                <strong>{{ task.description or '—' }}</strong>
                {% if task.discount and task.discount > 0 %}
                <br><small class="text-warning">خصم: {{ '%.2f'|format(task.discount) }} ₪</small>
                {% endif %}
              </td>
              <td>
                {% if task.note %}
                <span class="text-muted">{{ task.note }}</span>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                <span class="badge bg-warning">{{ task.quantity or 1 }}</span>
              </td>
              <td class="text-end">
                <strong>{{ '%.2f'|format(task.unit_price or 0) }} ₪</strong>
              </td>
              <td class="text-end">
                <strong class="text-success">{{ '%.2f'|format(line) }} ₪</strong>
              </td>
              {% if current_user.has_permission('manage_service') %}
              <td>
                <form method="post" action="{{ url_for('service.delete_task', tid=task.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-danger btn-sm btn-delete" title="حذف المهمة">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light">
          {% set tasks_total = (service.tasks | map(attribute='line_total') | sum) or 0 %}
          <tr>
            <th colspan="4" class="text-end">
              <i class="fas fa-calculator"></i> إجمالي المهام
            </th>
            <th class="text-end">
              <strong class="text-success fs-5">{{ '%.2f'|format(tasks_total) }} ₪</strong>
            </th>
            {% if current_user.has_permission('manage_service') %}<th></th>{% endif %}
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <div class="text-center p-4">
      <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">لا توجد مهام مسجلة</h5>
      <p class="text-muted">لم يتم إضافة أي مهام لهذا الطلب بعد</p>
    </div>
    {% endif %}
  </div>
</div>

{% if current_user.has_permission('manage_service') %}
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-gradient-info text-white">
    <h5 class="mb-0"><i class="fas fa-plus"></i> إضافة مهمة جديدة</h5>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('service.add_task', rid=service.id) }}" autocomplete="off">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="service_id" value="{{ service.id }}">
      
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-bold"><i class="fas fa-clipboard-list"></i> وصف المهمة</label>
          <input class="form-control" name="description" required placeholder="أدخل وصف المهمة...">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold"><i class="fas fa-sticky-note"></i> ملاحظات</label>
          <input class="form-control" name="note" placeholder="ملاحظات إضافية (اختياري)">
        </div>
      </div>
      
      <div class="row g-3 mt-2">
        <div class="col-md-3">
          <label class="form-label fw-bold"><i class="fas fa-hashtag"></i> الكمية</label>
          <input class="form-control" type="number" name="quantity" min="1" step="1" value="1">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold"><i class="fas fa-dollar-sign"></i> سعر الوحدة</label>
          <input class="form-control" type="number" name="unit_price" min="0" step="0.01" value="0" placeholder="0.00">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold"><i class="fas fa-tag"></i> الخصم (₪)</label>
          <input class="form-control" type="number" name="discount" min="0" max="999999" step="0.01" value="0" placeholder="مبلغ الخصم">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold"><i class="fas fa-receipt"></i> ضريبة %</label>
          <input class="form-control" type="number" name="tax_rate" min="0" max="100" step="0.01" value="{{ service.tax_rate or 0 }}" placeholder="0.00">
        </div>
      </div>
      
      <div class="mt-4 text-end">
        <button type="submit" class="btn btn-success fw-bold">
          <i class="fas fa-save"></i> حفظ المهمة
        </button>
        <button type="reset" class="btn btn-outline-secondary">
          <i class="fas fa-undo"></i> إعادة تعيين
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}
