<div class="card mb-3 shadow-sm">
  <div class="card-header bg-warning text-dark fw-bold">
    <i class="fa fa-tasks"></i> المهام
  </div>
  <div class="card-body p-0">
    {% if service.tasks %}
    <table class="table table-sm table-striped mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>الوصف</th>
          <th>الملاحظات</th>
          <th>الكمية</th>
          <th>سعر الوحدة</th>
          <th>الإجمالي</th>
          {% if current_user.has_permission('manage_service') %}
          <th style="width:80px">إجراء</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for task in service.tasks %}
          {% set line = task.line_total
                        if task.line_total is not none
                        else ((task.quantity or 0) * (task.unit_price or 0) * (1 - (task.discount or 0)/100)) %}
          <tr>
            <td>{{ task.description or '—' }}</td>
            <td>{{ task.note or '—' }}</td>
            <td>{{ task.quantity or 1 }}</td>
            <td>{{ '%.2f'|format(task.unit_price or 0) }}</td>
            <td>{{ '%.2f'|format(line) }}</td>
            {% if current_user.has_permission('manage_service') %}
            <td>
              <form method="post" action="{{ url_for('service.delete_task', tid=task.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-danger btn-sm btn-delete"><i class="fa fa-trash"></i></button>
              </form>
            </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="p-3 text-center text-muted">لا توجد مهام مسجلة لهذا الطلب</div>
    {% endif %}
  </div>
</div>

{% if current_user.has_permission('manage_service') %}
<div class="card mb-3 shadow-sm">
  <div class="card-header bg-light fw-bold"><i class="fa fa-plus"></i> إضافة مهمة</div>
  <div class="card-body">
    <form method="post" action="{{ url_for('service.add_task', rid=service.id) }}" autocomplete="off">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="service_id" value="{{ service.id }}">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">الوصف</label>
          <input class="form-control" name="description" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">الكمية</label>
          <input class="form-control" type="number" name="quantity" min="1" step="1" value="1">
        </div>
        <div class="col-md-2">
          <label class="form-label">سعر الوحدة</label>
          <input class="form-control" type="number" name="unit_price" min="0" step="0.01" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">خصم %</label>
          <input class="form-control" type="number" name="discount" min="0" max="100" step="0.01" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">ضريبة %</label>
          <input class="form-control" type="number" name="tax_rate" min="0" max="100" step="0.01" value="{{ service.tax_rate or 0 }}">
        </div>
        <div class="col-md-12">
          <label class="form-label">ملاحظات</label>
          <input class="form-control" name="note">
        </div>
      </div>
      <div class="mt-3 text-end">
        <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> حفظ</button>
      </div>
    </form>
  </div>
</div>
{% endif %}
