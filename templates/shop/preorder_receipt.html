{% extends 'shop/base.html' %}
{% block title %}وصل الطلب #{{ preorder.order_number }}{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">
  {% set _size = (request.args.get('s','a4')|lower) %}
  {% set _ori  = (request.args.get('o','portrait')|lower) %}
  {% if _size == 'a5' %}{% set W=148 %}{% set H=210 %}{% else %}{% set W=210 %}{% set H=297 %}{% endif %}
  {% if _ori == 'landscape' %}{% set PW=H %}{% set PH=W %}{% else %}{% set PW=W %}{% set PH=H %}{% endif %}
  {% set MT=12 %}{% set MR=12 %}{% set ML=12 %}

  <style>
    @page{size:{{PW}}mm {{PH}}mm;margin:{{MT}}mm {{MR}}mm {{MT}}mm {{ML}}mm}
    html,body{direction:rtl;text-align:right}
    .receipt-paper{max-width:960px;margin:0 auto}
    .num{font-variant-numeric:tabular-nums}
    .table-receipt{width:100%;border-collapse:collapse;table-layout:fixed}
    .table-receipt th,.table-receipt td{border:1px solid #e1e4e8;padding:8px;vertical-align:middle}
    .table-receipt thead th{background:#f7f9fc;font-weight:700;color:#394b6a;white-space:nowrap}
    .table-receipt col.col-prod{width:52%}
    .table-receipt col.col-qty {width:12%}
    .table-receipt col.col-price{width:18%}
    .table-receipt col.col-sum  {width:18%}

    @media print{
      nav,.navbar,.sidebar,.btn, .alert, .breadcrumb, .footer, .no-print{display:none!important}
      .card{box-shadow:none!important;border:0!important}
      .card-header{border:0!important}
      thead{display:table-header-group}
      tfoot{display:table-footer-group}
      .receipt-paper{max-width:none;width:100%}
    }
  </style>
{% endblock %}

{% block content %}
<div class="receipt-paper">
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-bold">وصل الطلب</div>
        <small class="text-muted">رقم: {{ preorder.order_number }}</small>
      </div>
      <span class="badge bg-{{ 
          'success' if preorder.status == 'FULFILLED' else 
          'warning' if preorder.status == 'CONFIRMED' else 
          'info'    if preorder.status == 'PENDING'   else 'danger' }}">
        {{ 
          'مكتمل' if preorder.status == 'FULFILLED' else 
          'مؤكد'  if preorder.status == 'CONFIRMED' else 
          'قيد الانتظار' if preorder.status == 'PENDING' else 'ملغي' }}
      </span>
    </div>

    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <h6 class="mb-2">تفاصيل الطلب</h6>
          <ul class="list-unstyled mb-0">
            <li><strong>رقم الطلب:</strong> {{ preorder.order_number }}</li>
            <li><strong>التاريخ:</strong> {{ preorder.created_at.strftime('%Y-%m-%d %H:%M') if preorder.created_at else '—' }}</li>
            <li><strong>الحالة:</strong> {{
              'مكتمل' if preorder.status == 'FULFILLED' else
              'مؤكد'  if preorder.status == 'CONFIRMED' else
              'قيد الانتظار' if preorder.status == 'PENDING' else 'ملغي' }}</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="mb-2">تفاصيل الزبون</h6>
          <ul class="list-unstyled mb-0">
            <li><strong>الاسم:</strong>  {{ preorder.customer.name  if preorder.customer else '—' }}</li>
            <li><strong>الهاتف:</strong> {{ preorder.customer.phone if preorder.customer else '—' }}</li>
            <li><strong>البريد:</strong> {{ preorder.customer.email if preorder.customer else '—' }}</li>
          </ul>
        </div>
      </div>

      <hr>
      <h6 class="mb-3">المنتجات</h6>
      <div class="table-responsive">
        <table class="table-receipt">
          <colgroup>
            <col class="col-prod"><col class="col-qty"><col class="col-price"><col class="col-sum">
          </colgroup>
          <thead>
            <tr>
              <th>المنتج</th>
              <th class="text-center">الكمية</th>
              <th class="text-end">السعر</th>
              <th class="text-end">الإجمالي</th>
            </tr>
          </thead>
          <tbody>
            {% for item in preorder.items or [] %}
            <tr>
              <td class="wrap">{{ item.product.name }}</td>
              <td class="text-center num">{{ item.quantity }}</td>
              <td class="text-end num">{{ '%.2f'|format(item.price or 0) }}</td>
              <td class="text-end num">{{ '%.2f'|format((item.quantity or 0) * (item.price or 0)) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between">
              <span>المبلغ المطلوب كعربون:</span>
              <span class="fw-bold num">{{ '%.2f'|format(preorder.prepaid_amount or 0) }} شيكل</span>
            </div>
            <small class="d-block text-muted mt-1">(لا يقل عن 20% من إجمالي قيمة الطلب)</small>
          </div>
        </div>
        <div class="col-md-6">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between">
              <strong>المجموع الكلي:</strong>
              <strong class="num">{{ '%.2f'|format(preorder.total_amount or 0) }} شيكل</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between no-print">
    <a href="{{ url_for('shop.preorder_list') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-right me-2"></i> الرجوع لقائمة الطلبات
    </a>
    <button onclick="window.print()" class="btn btn-primary">
      <i class="fas fa-print me-2"></i> طباعة الوصل
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}{{ super() }}{% endblock %}
