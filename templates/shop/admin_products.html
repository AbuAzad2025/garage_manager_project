{% extends 'shop/base.html' %}

{% block title %}إدارة المنتجات{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">
<style>
  .table thead th { background:#f5f6fa; color:#1a237e; font-weight:600 }
  .badge-active { background:linear-gradient(135deg,#43cea2,#185a9d); color:#fff }
  .badge-inactive { background:#b0bec5; color:#333 }
  .btn-action { border-radius:50%; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; font-size:.85rem }
  .btn-edit { background:linear-gradient(135deg,#ffb300,#ff7043); color:#fff }
  .btn-edit:hover { opacity:.9 }
  .btn-delete { background:linear-gradient(135deg,#e53935,#b71c1c); color:#fff }
  .btn-delete:hover { opacity:.9 }
  .btn-toggle { background:linear-gradient(135deg,#26a69a,#00897b); color:#fff }
  .btn-toggle.off { background:linear-gradient(135deg,#90a4ae,#607d8b) }
  .search-input { max-width:280px }
  .pill { font-size:.75rem; padding:.25rem .5rem; border-radius:.65rem; background:#eef2ff; color:#334155 }
</style>
{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">إدارة المنتجات</h1>
  <div class="d-flex align-items-center gap-3 ms-auto">
    <div id="onlineBadge" class="pill d-none">Online: ...</div>
    <div class="input-group search-input">
      <span class="input-group-text"><i class="fas fa-search"></i></span>
      <input id="searchBox" type="text" class="form-control" placeholder="ابحث بالاسم أو SKU...">
    </div>
    <a href="{{ url_for('shop.admin_product_new') }}" class="btn btn-primary">
      <i class="fas fa-plus ml-1"></i> إضافة منتج
    </a>
    <a href="{{ url_for('shop.catalog') }}" class="btn btn-outline-secondary">
      <i class="fas fa-store ml-1"></i> المتجر
    </a>
  </div>
</div>

<div id="noOnlineAlert" class="alert alert-warning d-none">
  لا يوجد مستودع أونلاين. يمكنك إنشاؤه من <a class="alert-link" href="{{ url_for('warehouse_bp.list') }}?type=ONLINE">المستودعات</a>.
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table align-middle table-hover" id="productsTable">
        <thead>
          <tr>
            <th>الصورة</th>
            <th>الاسم</th>
            <th class="text-end">السعر</th>
            <th class="text-end">سعر الأونلاين</th>
            <th class="text-center">المتوفر (كُلّي)</th>
            <th class="text-center">أونلاين</th>
            <th class="text-center">الحالة</th>
            <th class="text-center">أنشئ في</th>
            <th class="text-center">إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          {% set _img = (p.online_image or p.image) %}
          {% set _img_is_abs = _img and (_img.startswith('http') or _img.startswith('/')) %}
          {% set display_name = p.commercial_name or p.name %}
          <tr data-name="{{ (display_name or '')|lower }}" data-alt="{{ (p.name or '')|lower }}" data-sku="{{ (p.sku or '')|lower }}">
            <td style="width:84px;">
              {% if _img %}
                {% if _img_is_abs %}
                  <img src="{{ _img }}"
                       class="rounded" width="64" height="64" style="object-fit:cover;"
                       alt="صورة {{ display_name }}"
                       onerror="this.onerror=null;this.src='{{ url_for('static', filename='products/default.png') }}'">
                {% else %}
                  <img src="{{ url_for('static', filename=_img if _img else 'products/default.png') }}"
                       class="rounded" width="64" height="64" style="object-fit:cover;"
                       alt="صورة {{ display_name }}"
                       onerror="this.onerror=null;this.src='{{ url_for('static', filename='products/default.png') }}'">
                {% endif %}
              {% else %}
                <img src="{{ url_for('static', filename='products/default.png') }}"
                     class="rounded" width="64" height="64" style="object-fit:cover;"
                     alt="صورة {{ display_name }}">
              {% endif %}
            </td>
            <td class="fw-semibold">
              <div>{{ display_name }}</div>
              <div class="text-muted small">
                {{ p.sku or '' }}
                {% if p.commercial_name and p.name and p.commercial_name != p.name %}
                  <span class="ms-2">({{ p.name }})</span>
                {% endif %}
              </div>
            </td>
            <td class="text-end">
              <span class="price" data-id="{{ p.id }}">{{ '%.2f'|format(p.price or 0) }}</span> شيكل
            </td>
            <td class="text-end">
              <span class="online-price" data-id="{{ p.id }}">—</span>
            </td>
            <td class="text-center">
              <span class="badge bg-light text-dark">{{ avail_map.get(p.id, 0) }}</span>
            </td>
            <td class="text-center">
              <span class="badge bg-light text-dark online-qty" data-id="{{ p.id }}">—</span>
            </td>
            <td class="text-center">
              {% if p.is_active %}
                <span class="badge badge-active status" data-id="{{ p.id }}">مفعل</span>
              {% else %}
                <span class="badge badge-inactive status" data-id="{{ p.id }}">غير مفعل</span>
              {% endif %}
            </td>
            <td class="text-center">
              {{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}
            </td>
            <td class="text-center">
              <div class="d-flex justify-content-center gap-2">
                <button type="button" class="btn btn-action btn-toggle {% if not p.is_active %}off{% endif %}" data-id="{{ p.id }}" title="تفعيل/تعطيل">
                  <i class="fas fa-power-off"></i>
                </button>
                <button type="button" class="btn btn-action btn-edit edit-price" data-id="{{ p.id }}" title="تعديل السعر">
                  <i class="fas fa-dollar-sign"></i>
                </button>
                <button type="button" class="btn btn-action btn-edit edit-online-price" data-id="{{ p.id }}" title="تعديل سعر الأونلاين">
                  <i class="fas fa-globe-dollar"></i>
                </button>
                <button type="button" class="btn btn-action btn-edit edit-image" data-id="{{ p.id }}" title="رفع صورة أساسية جديدة">
                  <i class="fas fa-cloud-upload-alt"></i>
                </button>
                <button type="button" class="btn btn-action btn-edit edit-online-image" data-id="{{ p.id }}" title="رفع صورة أونلاين جديدة">
                  <i class="fas fa-globe-americas"></i>
                </button>
                <a href="{{ url_for('shop.admin_product_edit', pid=p.id) }}" class="btn btn-action btn-edit" title="تعديل كامل">
                  <i class="fas fa-edit"></i>
                </a>
                <form method="POST" action="{{ url_for('shop.admin_product_delete', pid=p.id) }}" onsubmit="return confirm('تأكيد حذف {{ display_name }}؟');" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-action btn-delete" title="حذف المنتج">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="9" class="text-center text-muted py-5">
              <i class="fas fa-box-open fa-2x mb-2"></i>
              <div>لا توجد منتجات مضافة بعد</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/shop.js') }}"></script>
<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const searchBox = document.getElementById('searchBox');
  const tbody = document.getElementById('productsTable').querySelector('tbody');
  const onlineBadge = document.getElementById('onlineBadge');
  const noOnlineAlert = document.getElementById('noOnlineAlert');

  // البحث بالاسم التجاري أو العلمي أو الـ SKU
  searchBox.addEventListener('input', function(){
    const q = this.value.trim().toLowerCase();
    tbody.querySelectorAll('tr').forEach(tr => {
      const name = tr.getAttribute('data-name') || '';
      const alt  = tr.getAttribute('data-alt')  || '';
      const sku  = tr.getAttribute('data-sku')  || '';
      tr.style.display = (name.includes(q) || alt.includes(q) || sku.includes(q)) ? '' : 'none';
    });
  });

  function normDecimalInput(v){
    if(v==null) return "";
    return String(v)
      .replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)])
      .replace(/[٬،]/g, ',')
      .replace(/[٫]/g, '.')
      .replace(',', '.')
      .replace(/[^\d.]/g, '')
      .trim();
  }

  async function postJSON(url, payload){
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify(payload || {})
    });
    let data; try{ data = await r.json(); } catch(e){ data = {}; }
    return { ok: r.ok, data };
  }

  tbody.addEventListener('click', async function(e){
    const btnToggle          = e.target.closest('.btn-toggle');
    const btnEditPrice       = e.target.closest('.edit-price');
    const btnEditOnlinePrice = e.target.closest('.edit-online-price');
    const btnEditImg         = e.target.closest('.edit-image');
    const btnEditOnlineImg   = e.target.closest('.edit-online-image');

    if(btnToggle){
      const id = btnToggle.getAttribute('data-id');
      try{
        const {ok, data} = await postJSON(`{{ url_for('shop.admin_product_toggle_active', pid=0) }}`.replace('0', id), {});
        if(ok){
          const st = tbody.querySelector(`.status[data-id="${id}"]`);
          btnToggle.classList.toggle('off');
          if(st){
            if(st.classList.contains('badge-active')){
              st.classList.remove('badge-active'); st.classList.add('badge-inactive'); st.textContent = 'غير مفعل';
            }else{
              st.classList.remove('badge-inactive'); st.classList.add('badge-active'); st.textContent = 'مفعل';
            }
          }
        }else{
          alert(data.message || 'تعذر تحديث الحالة');
        }
      }catch(err){
        alert('خطأ في الاتصال');
      }
      return;
    }

    if(btnEditPrice){
      const id = btnEditPrice.getAttribute('data-id');
      const priceEl = tbody.querySelector(`.price[data-id="${id}"]`);
      const cur = priceEl ? priceEl.textContent.trim() : '';
      const raw = prompt('أدخل السعر الجديد', cur);
      if(raw === null) return;
      const val = normDecimalInput(raw);
      if(val === '') { alert('قيمة غير صالحة'); return; }
      try{
        const {ok, data} = await postJSON(`{{ url_for('shop.admin_product_update_fields', pid=0) }}`.replace('0', id), {price: val});
        if(ok){
          if(priceEl) priceEl.textContent = (data.price !== undefined ? Number(data.price).toFixed(2) : Number(val).toFixed(2));
        }else{
          alert(data.message || 'تعذر تحديث السعر');
        }
      }catch(err){
        alert('خطأ في الاتصال');
      }
      return;
    }

    if(btnEditOnlinePrice){
      const id = btnEditOnlinePrice.getAttribute('data-id');
      const priceCell = tbody.querySelector(`.online-price[data-id="${id}"]`);
      const cur = priceCell ? priceCell.textContent.trim() : '';
      const raw = prompt('أدخل سعر الأونلاين الجديد', cur === '—' ? '' : cur);
      if(raw === null) return;
      const val = normDecimalInput(raw);
      if(val === '') { alert('قيمة غير صالحة'); return; }
      try{
        const {ok, data} = await postJSON(`{{ url_for('shop.admin_product_update_fields', pid=0) }}`.replace('0', id), {online_price: val});
        if(ok){
          if(priceCell) priceCell.textContent = (data.online_price !== undefined ? Number(data.online_price).toFixed(2) : Number(val).toFixed(2));
        }else{
          alert(data.message || 'تعذر تحديث سعر الأونلاين');
        }
      }catch(err){
        alert('خطأ في الاتصال');
      }
      return;
    }

    if (btnEditImg || btnEditOnlineImg) {
      const id = (btnEditImg || btnEditOnlineImg).getAttribute('data-id');
      const isOnline = !!btnEditOnlineImg;
      const tr = e.target.closest('tr');
      const imgTag = tr ? tr.querySelector('img') : null;
      
      // إنشاء input file مخفي
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.addEventListener('change', async function() {
        if (!this.files.length) return;
        
        const file = this.files[0];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('subdir', 'products');
        formData.append('max_side', '1200');
        formData.append('quality', '82');
        
        try {
          // رفع الصورة
          const uploadRes = await fetch('/warehouses/api/upload_product_image', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
          });
          
          const uploadData = await uploadRes.json();
          
          if (uploadRes.ok && uploadData.ok) {
            const imageUrl = uploadData.url || uploadData.thumb_url;
            
            // حفظ URL في قاعدة البيانات
            const payload = isOnline ? { online_image: imageUrl } : { image: imageUrl };
            console.log('Sending payload:', payload);
            console.log('Product ID:', id);
            const {ok, data} = await postJSON(`{{ url_for('shop.admin_product_update_fields', pid=0) }}`.replace('0', id), payload);
            console.log('Response:', {ok, data});
            
            if (ok) {
              // تحديث الصورة في الجدول
              if (imgTag && imageUrl) {
                if (imageUrl.startsWith('http') || imageUrl.startsWith('/')) {
                  imgTag.src = imageUrl;
                } else {
                  imgTag.src = `{{ url_for('static', filename='') }}` + imageUrl;
                }
              }
              alert(`✅ تم رفع ${isOnline ? 'صورة الأونلاين' : 'الصورة الأساسية'} بنجاح!`);
            } else {
              alert(data.message || 'تعذر حفظ الصورة في قاعدة البيانات');
            }
          } else {
            alert(uploadData.error || 'فشل رفع الصورة');
          }
        } catch (err) {
          alert('خطأ في الاتصال');
        }
        
        // إزالة input من DOM
        document.body.removeChild(fileInput);
      });
      
      // إضافة input إلى DOM وتشغيله
      document.body.appendChild(fileInput);
      fileInput.click();
      
      return;
    }
  });

  (async function fillOnline(){
    try{
      const res = await fetch(`{{ url_for('warehouse_bp.list') }}?type=ONLINE&format=json`, {headers:{'X-CSRFToken': csrfToken}});
      const js = await res.json();
      const rows = js?.data || [];
      if(!rows.length){
        noOnlineAlert.classList.remove('d-none');
        return;
      }
      const def = rows.find(w=>w.online_is_default) || rows[0];
      const wid = def.id;
      onlineBadge.textContent = `Online #${def.id} — ${def.name}`;
      onlineBadge.classList.remove('d-none');

      const res2 = await fetch(`{{ url_for('warehouse_bp.products', id=0) }}`.replace('0', String(wid)) + `?format=json`, {headers:{'X-CSRFToken': csrfToken}});
      const js2 = await res2.json();
      const list = js2?.data || [];
      const byId = {};
      list.forEach(p => { byId[p.id] = p; });

      tbody.querySelectorAll('tr').forEach(tr => {
        const priceCell = tr.querySelector('.online-price');
        const qtyCell   = tr.querySelector('.online-qty');
        if(!priceCell || !qtyCell) return;
        const id = Number(priceCell.getAttribute('data-id'));
        const row = byId[id];
        if(row){
          priceCell.textContent = (row.online_price != null ? Number(row.online_price).toFixed(2) : '—');
          qtyCell.textContent   = (row.quantity != null ? row.quantity : '—');
          qtyCell.classList.toggle('bg-warning-subtle', Number(row.quantity||0) === 0);
        }
      });
    }catch(e){}
  })();
</script>
{% endblock %}
