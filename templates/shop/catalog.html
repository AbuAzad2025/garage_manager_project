{% extends 'shop/base.html' %}
{% block title %}المنتجات المتاحة{% endblock %}
{% block styles %}<link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">المنتجات المتاحة</h1>
  <div class="input-group w-auto">
    <input type="text" id="search" class="form-control" placeholder="ابحث عن منتج...">
    <button class="btn btn-outline-primary" type="button"><i class="fas fa-search"></i></button>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="products-container">
  {% for product in products %}
  <div class="col product-card" data-name="{{ product.name|lower }}" data-desc="{{ (product.description or '')|lower }}">
    <div class="card h-100">
      <div class="position-relative">
        <img src="{{ url_for('static', filename='products/' + product.image) if product.image else url_for('static', filename='products/default.png') }}"
             class="card-img-top" alt="{{ product.name }}" style="height:200px;object-fit:cover;">
        <span class="position-absolute top-0 start-0 m-2 badge bg-success">{{ '%.2f'|format(product.price or 0) }} شيكل</span>
        {% if (product.on_hand or 0) <= 0 %}
          <span class="position-absolute top-0 end-0 m-2 badge bg-danger">غير متوفر</span>
        {% endif %}
      </div>
      <div class="card-body">
        <h5 class="card-title">{{ product.name }}</h5>
        <p class="card-text text-muted small">{{ (product.description or '')|truncate(80) }}</p>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted"><i class="fas fa-cubes me-1"></i> {{ product.on_hand or 0 }} متوفر</small>
          {% if (product.on_hand or 0) > 0 %}
          <form method="POST" action="{{ url_for('shop.add_to_cart', product_id=product.id) }}" class="d-flex gap-2 align-items-center">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="input-group input-group-sm w-auto">
              <button type="button" class="btn btn-outline-secondary btn-step" data-dir="-1"><i class="fas fa-minus"></i></button>
              <input type="number" name="quantity" class="form-control text-center qty-input"
                     value="1" min="1" data-max="{{ product.on_hand or 1 }}" style="width:60px">
              <button type="button" class="btn btn-outline-secondary btn-step" data-dir="1"><i class="fas fa-plus"></i></button>
            </div>
            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-cart-plus"></i></button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-12">
    <div class="alert alert-info text-center">لا توجد منتجات متاحة حالياً</div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/shop.js') }}"></script>
{% endblock %}
