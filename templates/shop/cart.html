{% extends 'shop/base.html' %}

{% block title %}Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">
<style>
  .card-header{background:linear-gradient(135deg,#1a237e,#311b92);color:#fff;font-weight:600}
  .table thead th{background:#f5f6fa;color:#1a237e;font-weight:600}
  .table tbody tr:hover{background:#fafafa}
  .btn-update{background:linear-gradient(135deg,#0066cc,#3ba3ff);color:#fff;border:none}
  .btn-update:hover{opacity:.9}
  .btn-remove{background:linear-gradient(135deg,#e53935,#b71c1c);color:#fff;border:none}
  .btn-remove:hover{opacity:.9}
  .summary-card .alert-info{background:linear-gradient(135deg,#36d1dc,#5b86e5);color:#fff;border:none}
  .summary-card .fw-bold{font-size:1.1rem}
  .empty-cart{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
  .qty-control .btn-step{min-width:36px}
</style>
{% endblock %}

{% block content %}
<h1 class="h3 mb-4">ğŸ›’ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h1>

{% if items %}
<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header py-3 d-flex justify-content-between">
        <h5 class="mb-0">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h5>
        {% if has_any('manage_shop','manage_sales') and 'shop.admin_orders' in current_app.view_functions %}
          <a href="{{ url_for('shop.admin_orders') }}" class="btn btn-sm btn-light text-dark">
            <i class="fas fa-list"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          </a>
        {% endif %}
      </div>

      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th class="text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="text-end">Ø§Ù„Ø³Ø¹Ø±</th>
                <th class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      src="{{ url_for('static', filename='products/' + (item.product.image or 'default.png')) }}"
                      class="rounded me-3"
                      width="60" height="60" loading="lazy"
                      alt="{{ item.product.name }}"
                      style="object-fit:cover;"
                      onerror="this.onerror=null;this.src='{{ url_for('static', filename='products/default.png') }}'">
                    <div>
                      <h6 class="mb-0">{{ item.product.name }}</h6>
                      {% if item.product.sku %}<small class="text-muted">{{ item.product.sku }}</small>{% endif %}
                    </div>
                  </div>
                </td>

                <td class="text-center">
                  <form method="POST" action="{{ url_for('shop.update_cart_item', item_id=item.id) }}" class="d-inline-flex align-items-center">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="input-group input-group-sm qty-control">
                      <button class="btn btn-outline-secondary btn-step" type="button" data-dir="-1" title="Ù†Ù‚Øµ">
                        <i class="fas fa-minus"></i>
                      </button>
                      <input type="number" name="quantity" class="form-control text-center qty-input"
                             value="{{ item.quantity }}" min="1" step="1" inputmode="numeric" pattern="[0-9]*" style="width:80px">
                      <button class="btn btn-outline-secondary btn-step" type="button" data-dir="1" title="Ø²ÙŠØ§Ø¯Ø©">
                        <i class="fas fa-plus"></i>
                      </button>
                      <button type="submit" class="btn btn-update ms-2">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                  </form>
                </td>

                <td class="text-end">{{ '%.2f' | format(item.price or 0) }} Ø´ÙŠÙƒÙ„</td>
                <td class="text-end">{{ '%.2f' | format((item.quantity or 0) * (item.price or 0)) }} Ø´ÙŠÙƒÙ„</td>

                <td class="text-center">
                  <form method="POST" action="{{ url_for('shop.remove_from_cart', item_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-remove" title="Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm sticky-top summary-card" style="top: 100px;">
      <div class="card-header py-3">
        <h5 class="mb-0">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
          <span>{{ '%.2f'|format(subtotal) }} Ø´ÙŠÙƒÙ„</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Ø§Ù„Ø´Ø­Ù†:</span>
          <span>0.00 Ø´ÙŠÙƒÙ„</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
          <span>0.00 Ø´ÙŠÙƒÙ„</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold mb-3">
          <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
          <span>{{ '%.2f'|format(subtotal) }} Ø´ÙŠÙƒÙ„</span>
        </div>

        <div class="alert alert-info">
          <div class="d-flex justify-content-between">
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø­Ø¬Ø²:</span>
            <span class="fw-bold">{{ '%.2f'|format(prepaid_amount) }} Ø´ÙŠÙƒÙ„</span>
          </div>
          <small class="d-block mt-1">(20% Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)</small>
        </div>

        {% if not has_any('manage_shop', 'manage_payments') %}
          <a href="{{ url_for('shop.checkout') }}" class="btn btn-primary w-100 py-3">Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡</a>
        {% endif %}
        <a href="{{ url_for('shop.catalog') }}" class="btn btn-outline-secondary w-100 mt-2">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³ÙˆÙ‚</a>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="empty-cart text-center py-5">
  <div class="card-body">
    <i class="fas fa-shopping-cart fa-4x text-muted mb-4"></i>
    <h4 class="mb-3">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</h4>
    <p class="text-muted mb-4">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
    <a href="{{ url_for('shop.catalog') }}" class="btn btn-primary px-4">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function(){
    document.querySelectorAll('.qty-control').forEach(group => {
      const input = group.querySelector('.qty-input');
      group.querySelectorAll('.btn-step').forEach(btn => {
        btn.addEventListener('click', () => {
          const dir = parseInt(btn.getAttribute('data-dir')) || 0;
          const cur = parseInt(input.value || '1') || 1;
          const next = Math.max(1, cur + dir);
          input.value = next;
        });
      });
      input.addEventListener('input', () => {
        input.value = String(input.value).replace(/[^\d]/g,'');
        if(!input.value || parseInt(input.value) < 1) input.value = '1';
      });
    });
  })();
</script>
<script src="{{ url_for('static', filename='js/shop.js') }}"></script>
{% endblock %}
