{% extends "base.html" %}

{% block title %}المسح الجماعي للمنتجات{% endblock %}

{% block extra_head %}
<style>
/* تحسين الألوان والتباين */
.form-group label {
    color: #343a40 !important;
    font-weight: 600 !important;
    margin-bottom: 5px !important;
}

.form-control {
    border: 2px solid #e9ecef !important;
    border-radius: 6px !important;
    padding: 10px 12px !important;
    font-size: 14px !important;
    transition: all 0.3s ease !important;
}

.form-control:focus {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border-bottom: none !important;
}

.card-header h3 {
    color: white !important;
    margin: 0 !important;
}

.alert-info {
    background-color: #e7f3ff !important;
    border-color: #b8daff !important;
    color: #004085 !important;
    border-radius: 8px !important;
    padding: 12px 16px !important;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border: none !important;
    border-radius: 6px !important;
    padding: 10px 20px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.btn-primary:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
}

.btn-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
    border: none !important;
    color: white !important;
}

.btn-danger {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%) !important;
    border: none !important;
    color: white !important;
}

/* تمييز الحقول المطلوبة */
.form-group.required label {
    color: #dc3545 !important;
    font-weight: bold !important;
}

.form-group.optional label {
    color: #28a745 !important;
    font-weight: bold !important;
}

.form-group.disabled {
    opacity: 0.6 !important;
}

/* تحسين Modal */
.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border-bottom: none !important;
}

.modal-title {
    color: white !important;
}

.modal-body {
    background-color: #f8f9fa !important;
}

/* تحسين الجدول */
.table {
    background-color: white !important;
    border-radius: 8px !important;
    overflow: hidden !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

.table thead th {
    background-color: #f8f9fa !important;
    color: #495057 !important;
    font-weight: 600 !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* تحسين الإحصائيات */
.card-body h3 {
    color: #495057 !important;
    font-weight: bold !important;
}

.card-body p {
    color: #6c757d !important;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">المسح الجماعي للمنتجات</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('barcode_scanner.index') }}">نظام الباركود</a></li>
                        <li class="breadcrumb-item active">المسح الجماعي</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- إحصائيات سريعة -->
            <div class="row mb-4">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3 id="scanned-count">0</h3>
                            <p>منتجات ممسوحة</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-barcode"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3 id="new-products">0</h3>
                            <p>منتجات جديدة</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3 id="updated-products">0</h3>
                            <p>منتجات محدثة</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3 id="errors-count">0</h3>
                            <p>أخطاء</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- إعدادات المسح -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-cog"></i> إعدادات المسح
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label style="color: #343a40 !important; font-weight: bold;">المستودع:</label>
                                <select class="form-control" id="warehouse-select" onchange="loadWarehouseFields()">
                                    <option value="">اختر المستودع...</option>
                                    <!-- سيتم ملؤها بالـ JavaScript -->
                                </select>
                                <small class="form-text" style="color: #6c757d !important;">
                                    سيتم تحديث الحقول المطلوبة حسب نوع المستودع المختار
                                </small>
                            </div>
                            
                            <div id="warehouse-info" class="alert alert-info" style="display: none; background-color: #e7f3ff !important; border-color: #b8daff !important; color: #004085 !important;">
                                <i class="fas fa-info-circle"></i>
                                <span id="warehouse-type-info"></span>
                            </div>
                            
                            <!-- حقول خاصة بمستودع الشركاء -->
                            <div id="partner-fields" class="card mb-3" style="display: none; border: 2px solid #17a2b8; background-color: #e7f9fc;">
                                <div class="card-header" style="background-color: #17a2b8; color: white;">
                                    <i class="fas fa-handshake"></i> معلومات الشريك
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label style="color: #343a40 !important; font-weight: bold;">الشريك: <span style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="default-partner-name" placeholder="اسم الشريك">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label style="color: #343a40 !important;">نسبة المساهمة (%):</label>
                                                <input type="number" class="form-control" id="default-partner-share" placeholder="50" min="0" max="100">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label style="color: #343a40 !important;">مبلغ المساهمة:</label>
                                                <input type="number" class="form-control" id="default-partner-amount" placeholder="0.00" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- حقول خاصة بمستودع التبادل -->
                            <div id="exchange-fields" class="card mb-3" style="display: none; border: 2px solid #ffc107; background-color: #fffbf0;">
                                <div class="card-header" style="background-color: #ffc107; color: #212529;">
                                    <i class="fas fa-exchange-alt"></i> معلومات التاجر/المورد
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label style="color: #343a40 !important; font-weight: bold;">التاجر/المورد: <span style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="default-vendor-name" placeholder="اسم التاجر أو المورد">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label style="color: #343a40 !important;">رقم الهاتف:</label>
                                                <input type="text" class="form-control" id="default-vendor-phone" placeholder="05xxxxxxxx">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label style="color: #343a40 !important;">المبلغ المدفوع:</label>
                                                <input type="number" class="form-control" id="default-vendor-paid" placeholder="0.00" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label style="color: #343a40 !important;">سعر التاجر:</label>
                                                <input type="number" class="form-control" id="default-vendor-price" placeholder="0.00" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- حقول خاصة بالمتجر الإلكتروني -->
                            <div id="online-fields" class="card mb-3" style="display: none; border: 2px solid #28a745; background-color: #f1f9f4;">
                                <div class="card-header" style="background-color: #28a745; color: white;">
                                    <i class="fas fa-shopping-cart"></i> معلومات المتجر الإلكتروني
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label style="color: #343a40 !important; font-weight: bold;">الاسم الإلكتروني:</label>
                                        <input type="text" class="form-control" id="default-online-name" placeholder="الاسم كما سيظهر في المتجر">
                                    </div>
                                    <div class="form-group">
                                        <label style="color: #343a40 !important; font-weight: bold;">السعر الإلكتروني:</label>
                                        <input type="number" class="form-control" id="default-online-price" placeholder="0.00" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label style="color: #343a40 !important;">رابط الصورة الإلكترونية:</label>
                                        <input type="text" class="form-control" id="default-online-image" placeholder="https://...">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>السعر الافتراضي:</label>
                                <input type="number" class="form-control" id="default-price" value="0" step="0.01">
                            </div>
                            
                            <div class="form-group">
                                <label>الكمية الافتراضية:</label>
                                <input type="number" class="form-control" id="default-quantity" value="1">
                            </div>
                            
                            <div class="form-group">
                                <label>الماركة الافتراضية:</label>
                                <input type="text" class="form-control" id="default-brand" placeholder="مثال: Toyota">
                            </div>
                            
                            <div class="form-group">
                                <label>رقم القطعة الافتراضي:</label>
                                <input type="text" class="form-control" id="default-part-number" placeholder="مثال: 12345">
                            </div>
                            
                            <div class="form-group">
                                <label>الاسم التجاري الافتراضي:</label>
                                <input type="text" class="form-control" id="default-commercial-name" placeholder="مثال: فلتر زيت">
                            </div>
                            
                            <div class="form-group">
                                <label>بلد المنشأ الافتراضي:</label>
                                <input type="text" class="form-control" id="default-origin" placeholder="مثال: اليابان">
                            </div>
                            
                            <div class="form-group">
                                <label>الوحدة الافتراضية:</label>
                                <input type="text" class="form-control" id="default-unit" placeholder="مثال: قطعة">
                            </div>
                            
                            <div class="form-group">
                                <label>مدة الضمان الافتراضية (شهور):</label>
                                <input type="number" class="form-control" id="default-warranty" placeholder="12" value="12">
                            </div>
                            
                            <div class="form-group">
                                <label>وضع المسح:</label>
                                <select class="form-control" id="scan-mode">
                                    <option value="add">إضافة منتجات جديدة فقط</option>
                                    <option value="update">تحديث المنتجات الموجودة</option>
                                    <option value="both" selected>إضافة وتحديث</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>نوع العملية للمنتجات الموجودة:</label>
                                <select class="form-control" id="existing-product-action">
                                    <option value="add_quantity" selected>إضافة الكمية (تراكمي)</option>
                                    <option value="replace_quantity">استبدال الكمية</option>
                                    <option value="update_info_only">تحديث المعلومات فقط (بدون تغيير الكمية)</option>
                                </select>
                                <small class="form-text" style="color: #6c757d !important; background-color: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 3px solid #007bff;">
                                    <strong style="color: #007bff !important;">إضافة الكمية:</strong> <span style="color: #495057 !important;">سيتم إضافة الكمية الجديدة إلى الكمية الموجودة</span><br>
                                    <strong style="color: #007bff !important;">استبدال الكمية:</strong> <span style="color: #495057 !important;">سيتم استبدال الكمية الموجودة بالكمية الجديدة</span><br>
                                    <strong style="color: #007bff !important;">تحديث المعلومات:</strong> <span style="color: #495057 !important;">سيتم تحديث بيانات المنتج فقط بدون تغيير الكمية</span>
                                </small>
                            </div>
                            
                            <button class="btn btn-primary btn-block" id="start-scan-btn">
                                <i class="fas fa-play"></i> بدء المسح
                            </button>
                            
                            <button class="btn btn-success btn-block mt-2" id="save-all-btn" disabled>
                                <i class="fas fa-save"></i> حفظ الكل
                            </button>
                            
                            <button class="btn btn-warning btn-block mt-2" id="clear-all-btn">
                                <i class="fas fa-trash"></i> مسح الكل
                            </button>
                        </div>
                    </div>
                </div>

                <!-- منطقة المسح -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-barcode"></i> منطقة المسح
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>امسح الباركود هنا:</label>
                                <input type="text" class="form-control form-control-lg" id="barcode-input" 
                                       placeholder="امسح الباركود أو اكتبه هنا..." autofocus>
                                <small class="form-text text-muted">
                                    امسح الباركود وستظهر معلومات المنتج تلقائياً
                                </small>
                            </div>
                            
                            <!-- قائمة المنتجات الممسوحة -->
                            <div class="table-responsive">
                                <table class="table table-striped" id="scanned-products-table">
                                    <thead>
                                        <tr>
                                            <th>الباركود</th>
                                            <th>اسم المنتج</th>
                                            <th>رقم القطعة</th>
                                            <th>الماركة</th>
                                            <th>الاسم التجاري</th>
                                            <th>بلد المنشأ</th>
                                            <th>الوحدة</th>
                                            <th>السعر</th>
                                            <th>الكمية</th>
                                            <th>الضمان</th>
                                            <th>الحالة</th>
                                            <th>إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scanned-products-body">
                                        <!-- سيتم ملؤها بالـ JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="no-products-message" class="text-center text-muted py-4" style="display: none;">
                                <i class="fas fa-barcode fa-3x mb-3"></i>
                                <p>لم يتم مسح أي منتج بعد</p>
                                <p>امسح الباركود لبدء إضافة المنتجات</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
let scannedProducts = [];
let isScanning = false;

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('barcode-input').focus();
    
    // بدء المسح
    document.getElementById('start-scan-btn').addEventListener('click', function() {
        isScanning = true;
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المسح...';
        document.getElementById('barcode-input').focus();
    });
    
    // حفظ الكل
    document.getElementById('save-all-btn').addEventListener('click', function() {
        saveAllProducts();
    });
    
    // مسح الكل
    document.getElementById('clear-all-btn').addEventListener('click', function() {
        if (confirm('هل تريد مسح جميع المنتجات الممسوحة؟')) {
            clearAllProducts();
        }
    });
    
    // معالجة إدخال الباركود
    document.getElementById('barcode-input').addEventListener('input', function() {
        const barcode = this.value.trim();
        if (barcode.length >= 8) { // الحد الأدنى لطول الباركود
            processBarcode(barcode);
            this.value = ''; // مسح الحقل
        }
    });
    
    // معالجة Enter
    document.getElementById('barcode-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const barcode = this.value.trim();
            if (barcode.length >= 8) {
                processBarcode(barcode);
                this.value = '';
            }
        }
    });
});

function processBarcode(barcode) {
    if (!isScanning) {
        alert('يرجى الضغط على "بدء المسح" أولاً');
        return;
    }
    
    // التحقق من عدم تكرار الباركود
    if (scannedProducts.find(p => p.barcode === barcode)) {
        alert('هذا الباركود ممسوح مسبقاً');
        return;
    }
    
    // إضافة المنتج للقائمة
    const product = {
        barcode: barcode,
        name: `منتج ${barcode}`,
        part_number: document.getElementById('default-part-number').value || '',
        brand: document.getElementById('default-brand').value || '',
        commercial_name: document.getElementById('default-commercial-name').value || '',
        origin_country: document.getElementById('default-origin').value || '',
        unit: document.getElementById('default-unit').value || 'قطعة',
        warranty_period: parseInt(document.getElementById('default-warranty').value) || 12,
        price: parseFloat(document.getElementById('default-price').value) || 0,
        quantity: parseInt(document.getElementById('default-quantity').value) || 1,
        status: 'جديد',
        isNew: true
    };
    
    scannedProducts.push(product);
    updateProductsTable();
    updateStats();
}

function updateProductsTable() {
    const tbody = document.getElementById('scanned-products-body');
    const noProductsMsg = document.getElementById('no-products-message');
    
    if (scannedProducts.length === 0) {
        tbody.innerHTML = '';
        noProductsMsg.style.display = 'block';
        return;
    }
    
    noProductsMsg.style.display = 'none';
    tbody.innerHTML = '';
    
    scannedProducts.forEach((product, index) => {
        const row = `
            <tr>
                <td>${product.barcode}</td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${product.name}" 
                           onchange="updateProduct(${index}, 'name', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${product.part_number || ''}" 
                           onchange="updateProduct(${index}, 'part_number', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${product.brand || ''}" 
                           onchange="updateProduct(${index}, 'brand', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${product.commercial_name || ''}" 
                           onchange="updateProduct(${index}, 'commercial_name', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${product.origin_country || ''}" 
                           onchange="updateProduct(${index}, 'origin_country', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${product.unit || ''}" 
                           onchange="updateProduct(${index}, 'unit', this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${product.price}" step="0.01"
                           onchange="updateProduct(${index}, 'price', this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${product.quantity}"
                           onchange="updateProduct(${index}, 'quantity', this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${product.warranty_period || 12}"
                           onchange="updateProduct(${index}, 'warranty_period', this.value)">
                </td>
                <td>
                    <span class="badge badge-${product.isNew ? 'success' : 'warning'}">
                        ${product.status}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeProduct(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

function updateProduct(index, field, value) {
    scannedProducts[index][field] = value;
    updateStats();
}

function removeProduct(index) {
    scannedProducts.splice(index, 1);
    updateProductsTable();
    updateStats();
}

function updateStats() {
    document.getElementById('scanned-count').textContent = scannedProducts.length;
    document.getElementById('new-products').textContent = scannedProducts.filter(p => p.isNew).length;
    document.getElementById('updated-products').textContent = scannedProducts.filter(p => !p.isNew).length;
    document.getElementById('errors-count').textContent = 0;
    
    // تفعيل زر الحفظ إذا كان هناك منتجات
    document.getElementById('save-all-btn').disabled = scannedProducts.length === 0;
}

function clearAllProducts() {
    scannedProducts = [];
    updateProductsTable();
    updateStats();
    const startBtn = document.getElementById('start-scan-btn');
    startBtn.disabled = false;
    startBtn.innerHTML = '<i class="fas fa-play"></i> بدء المسح';
    isScanning = false;
}

function saveAllProducts() {
    if (scannedProducts.length === 0) {
        alert('لا توجد منتجات للحفظ');
        return;
    }
    
    const warehouseId = document.getElementById('warehouse-select').value;
    
    // تحضير البيانات
    const productsData = scannedProducts.map(product => ({
        barcode: product.barcode,
        name: product.name,
        part_number: product.part_number || '',
        brand: product.brand || '',
        commercial_name: product.commercial_name || '',
        origin_country: product.origin_country || '',
        unit: product.unit || 'قطعة',
        warranty_period: parseInt(product.warranty_period) || 12,
        price: parseFloat(product.price),
        quantity: parseInt(product.quantity)
    }));
    
    // إرسال البيانات
    const existingProductAction = document.getElementById('existing-product-action').value;
    
    fetch('/barcode/bulk-import', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            products: productsData,
            warehouse_id: parseInt(warehouseId),
            existing_product_action: existingProductAction
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`تم حفظ ${data.imported_count} منتج جديد و ${data.updated_count} منتج محدث`);
            clearAllProducts();
        } else {
            alert('خطأ: ' + data.error);
        }
    })
    .catch(error => {
        alert('خطأ في الاتصال: ' + error.message);
    });
}

// متغيرات عامة للفلاتر الذكية
let currentProductData = null;
let currentBarcode = null;

// فحص وجود المنتج
async function checkProductExists(barcode) {
    const warehouseId = document.getElementById('warehouse-select').value;
    
    try {
        const response = await fetch(`/barcode/check-product?barcode=${encodeURIComponent(barcode)}&warehouse_id=${warehouseId}`);
        const data = await response.json();
        
        if (data.exists) {
            currentProductData = data.product;
            currentBarcode = barcode;
            showProductFiltersModal(data.product);
            return true;
        }
        return false;
    } catch (error) {
        console.error('خطأ في فحص المنتج:', error);
        return false;
    }
}

// عرض modal الفلاتر الذكية
function showProductFiltersModal(product) {
    // ملء معلومات المنتج الحالي
    const currentInfo = document.getElementById('current-product-info');
    currentInfo.innerHTML = `
        <strong>الاسم:</strong> ${product.name}<br>
        <strong>الباركود:</strong> ${product.barcode}<br>
        <strong>رقم القطعة:</strong> ${product.part_number || 'غير محدد'}<br>
        <strong>الماركة:</strong> ${product.brand || 'غير محدد'}<br>
        <strong>الاسم التجاري:</strong> ${product.commercial_name || 'غير محدد'}<br>
        <strong>بلد المنشأ:</strong> ${product.origin_country || 'غير محدد'}<br>
        <strong>الوحدة:</strong> ${product.unit || 'غير محدد'}<br>
        <strong>مدة الضمان:</strong> ${product.warranty_period || 'غير محدد'} شهر<br>
        <strong>السعر:</strong> ${product.price} شيكل<br>
        <strong>الكمية الحالية:</strong> ${product.current_quantity} ${product.unit || 'قطعة'}
    `;
    
    // ملء الحقول الجديدة
    const newInfo = document.getElementById('new-product-info');
    newInfo.innerHTML = `
        <strong>الاسم:</strong> ${document.getElementById('default-brand').value} ${document.getElementById('default-commercial-name').value || 'منتج'}<br>
        <strong>رقم القطعة:</strong> ${document.getElementById('default-part-number').value || 'غير محدد'}<br>
        <strong>الماركة:</strong> ${document.getElementById('default-brand').value || 'غير محدد'}<br>
        <strong>الاسم التجاري:</strong> ${document.getElementById('default-commercial-name').value || 'غير محدد'}<br>
        <strong>بلد المنشأ:</strong> ${document.getElementById('default-origin').value || 'غير محدد'}<br>
        <strong>الوحدة:</strong> ${document.getElementById('default-unit').value || 'غير محدد'}<br>
        <strong>مدة الضمان:</strong> ${document.getElementById('default-warranty').value} شهر<br>
        <strong>السعر:</strong> ${document.getElementById('default-price').value} شيكل<br>
        <strong>الكمية الجديدة:</strong> ${document.getElementById('default-quantity').value} ${document.getElementById('default-unit').value || 'قطعة'}
    `;
    
    // إظهار Modal
    const modal = document.getElementById('productFiltersModal');
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
}

// تأكيد تحديث المنتج
function setupConfirmButton() {
    const confirmBtn = document.getElementById('confirm-update-product');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            if (!currentProductData || !currentBarcode) return;
    
    // جمع الحقول المحددة للتحديث
    const fieldsToUpdate = {};
    if (document.getElementById('update-name').checked) {
        fieldsToUpdate.name = document.getElementById('default-brand').value + ' ' + (document.getElementById('default-commercial-name').value || 'منتج');
    }
    if (document.getElementById('update-part-number').checked) {
        fieldsToUpdate.part_number = document.getElementById('default-part-number').value;
    }
    if (document.getElementById('update-brand').checked) {
        fieldsToUpdate.brand = document.getElementById('default-brand').value;
    }
    if (document.getElementById('update-commercial-name').checked) {
        fieldsToUpdate.commercial_name = document.getElementById('default-commercial-name').value;
    }
    if (document.getElementById('update-origin').checked) {
        fieldsToUpdate.origin_country = document.getElementById('default-origin').value;
    }
    if (document.getElementById('update-unit').checked) {
        fieldsToUpdate.unit = document.getElementById('default-unit').value;
    }
    if (document.getElementById('update-warranty').checked) {
        fieldsToUpdate.warranty_period = parseInt(document.getElementById('default-warranty').value);
    }
    if (document.getElementById('update-price').checked) {
        fieldsToUpdate.price = parseFloat(document.getElementById('default-price').value);
    }
    
    // إضافة المنتج للقائمة مع البيانات المحدثة
    const updatedProduct = {
        ...currentProductData,
        ...fieldsToUpdate,
        barcode: currentBarcode,
        quantity: parseInt(document.getElementById('modal-quantity').value),
        status: 'محدث',
        isNew: false,
        update_fields: fieldsToUpdate  // الحقول المحددة للتحديث
    };
    
    // إضافة المنتج للقائمة
    scannedProducts.push(updatedProduct);
    updateProductsTable();
    updateStats();
    
    // إخفاء Modal
    const modal = document.getElementById('productFiltersModal');
    const modalInstance = bootstrap.Modal.getInstance(modal);
    if (modalInstance) {
        modalInstance.hide();
    }
    
    // إعادة تعيين المتغيرات
    currentProductData = null;
    currentBarcode = null;
        });
    }
}

// تعديل دالة processBarcode لفحص وجود المنتج أولاً
async function processBarcode(barcode) {
    if (!isScanning) return;
    
    // فحص وجود المنتج أولاً
    const exists = await checkProductExists(barcode);
    if (exists) {
        return; // سيتم التعامل معه في Modal
    }
    
    // إذا لم يكن موجود، إضافة منتج جديد
    const product = {
        barcode: barcode,
        name: document.getElementById('default-brand').value + ' ' + (document.getElementById('default-commercial-name').value || 'منتج'),
        part_number: document.getElementById('default-part-number').value || '',
        brand: document.getElementById('default-brand').value || '',
        commercial_name: document.getElementById('default-commercial-name').value || '',
        origin_country: document.getElementById('default-origin').value || '',
        unit: document.getElementById('default-unit').value || 'قطعة',
        warranty_period: parseInt(document.getElementById('default-warranty').value) || 12,
        price: parseFloat(document.getElementById('default-price').value) || 0,
        quantity: parseInt(document.getElementById('default-quantity').value) || 1,
        status: 'جديد',
        isNew: true
    };
    
    scannedProducts.push(product);
    updateProductsTable();
    updateStats();
}

// إعداد الأزرار عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setupConfirmButton();
    loadWarehouses();
});

// تحميل قائمة المستودعات
async function loadWarehouses() {
    try {
        const response = await fetch('/barcode/warehouses');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('warehouse-select');
            select.innerHTML = '<option value="">اختر المستودع...</option>';
            
            data.warehouses.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.id;
                option.textContent = `${warehouse.name} (${warehouse.type})`;
                option.dataset.type = warehouse.type;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('خطأ في تحميل المستودعات:', error);
    }
}

// تحميل الحقول حسب نوع المستودع
async function loadWarehouseFields() {
    const warehouseId = document.getElementById('warehouse-select').value;
    
    if (!warehouseId) {
        document.getElementById('warehouse-info').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`/barcode/warehouse-fields?warehouse_id=${warehouseId}`);
        const data = await response.json();
        
        if (data.success) {
            // عرض معلومات المستودع
            const warehouseInfo = document.getElementById('warehouse-info');
            const warehouseTypeInfo = document.getElementById('warehouse-type-info');
            
            const typeNames = {
                'MAIN': 'المستودع الرئيسي',
                'PARTNER': 'مستودع الشركاء',
                'INVENTORY': 'مستودع ملكيتي (الشركة)',
                'EXCHANGE': 'مستودع التبادل (التجار)',
                'ONLINE': 'المتجر الإلكتروني',
                'general': 'مستودع عام'
            };
            
            let infoText = `نوع المستودع: ${typeNames[data.warehouse_type] || data.warehouse_type}`;
            if (data.note) {
                infoText += ` - ${data.note}`;
            }
            warehouseTypeInfo.textContent = infoText;
            warehouseInfo.style.display = 'block';
            
            // إظهار/إخفاء الحقول الإضافية حسب نوع المستودع
            document.getElementById('partner-fields').style.display = data.show_partner_fields ? 'block' : 'none';
            document.getElementById('exchange-fields').style.display = data.show_exchange_fields ? 'block' : 'none';
            document.getElementById('online-fields').style.display = data.show_online_fields ? 'block' : 'none';
            
            // تحديث الحقول المطلوبة
            updateFieldRequirements(data.required_fields, data.recommended_fields, data.optional_fields);
            
            // تطبيق القيم الافتراضية
            applyDefaultValues(data.default_values);
        }
    } catch (error) {
        console.error('خطأ في تحميل حقول المستودع:', error);
    }
}

// تحديث متطلبات الحقول
function updateFieldRequirements(requiredFields, recommendedFields, optionalFields) {
    const allFields = {
        'name': { label: 'اسم المنتج', element: null },
        'price': { label: 'السعر الافتراضي', element: document.getElementById('default-price') },
        'quantity': { label: 'الكمية الافتراضية', element: document.getElementById('default-quantity') },
        'brand': { label: 'الماركة الافتراضية', element: document.getElementById('default-brand') },
        'part_number': { label: 'رقم القطعة الافتراضي', element: document.getElementById('default-part-number') },
        'commercial_name': { label: 'الاسم التجاري الافتراضي', element: document.getElementById('default-commercial-name') },
        'origin_country': { label: 'بلد المنشأ الافتراضي', element: document.getElementById('default-origin') },
        'unit': { label: 'الوحدة الافتراضية', element: document.getElementById('default-unit') },
        'warranty_period': { label: 'مدة الضمان الافتراضية', element: document.getElementById('default-warranty') }
    };
    
    // إعادة تعيين جميع الحقول
    Object.values(allFields).forEach(field => {
        if (field.element) {
            const parent = field.element.closest('.form-group');
            if (parent) {
                const label = parent.querySelector('label');
                if (label) {
                    label.style.color = '#6c757d';
                    label.style.fontWeight = 'normal';
                    // إزالة جميع العلامات
                    label.innerHTML = label.innerHTML.replace(/ <span style="color: red;">.*?<\/span>/g, '');
                    label.innerHTML = label.innerHTML.replace(/ <span style="color: orange;">.*?<\/span>/g, '');
                }
                parent.style.opacity = '0.5';
                parent.style.border = 'none';
            }
        }
    });
    
    // تمييز الحقول المطلوبة (أحمر)
    requiredFields.forEach(fieldName => {
        const field = allFields[fieldName];
        if (field && field.element) {
            const parent = field.element.closest('.form-group');
            if (parent) {
                const label = parent.querySelector('label');
                if (label) {
                    label.style.color = '#dc3545';
                    label.style.fontWeight = 'bold';
                    if (!label.innerHTML.includes('*')) {
                        label.innerHTML += ' <span style="color: red;">*</span>';
                    }
                }
                parent.style.opacity = '1';
                parent.style.border = '2px solid #dc3545';
                parent.style.borderRadius = '6px';
                parent.style.padding = '10px';
                parent.style.backgroundColor = '#fff5f5';
            }
        }
    });
    
    // تمييز الحقول الموصى بها (برتقالي)
    recommendedFields.forEach(fieldName => {
        const field = allFields[fieldName];
        if (field && field.element) {
            const parent = field.element.closest('.form-group');
            if (parent) {
                const label = parent.querySelector('label');
                if (label) {
                    label.style.color = '#fd7e14';
                    label.style.fontWeight = 'bold';
                    if (!label.innerHTML.includes('★')) {
                        label.innerHTML += ' <span style="color: orange;">★</span>';
                    }
                }
                parent.style.opacity = '1';
                parent.style.border = '2px solid #fd7e14';
                parent.style.borderRadius = '6px';
                parent.style.padding = '10px';
                parent.style.backgroundColor = '#fff8f0';
            }
        }
    });
    
    // تمييز الحقول الاختيارية (أخضر)
    optionalFields.forEach(fieldName => {
        const field = allFields[fieldName];
        if (field && field.element) {
            const parent = field.element.closest('.form-group');
            if (parent) {
                const label = parent.querySelector('label');
                if (label) {
                    label.style.color = '#28a745';
                    label.style.fontWeight = '600';
                }
                parent.style.opacity = '1';
                parent.style.border = '1px solid #d4edda';
                parent.style.borderRadius = '6px';
                parent.style.padding = '10px';
                parent.style.backgroundColor = '#f1f9f4';
            }
        }
    });
}

// تطبيق القيم الافتراضية
function applyDefaultValues(defaultValues) {
    Object.keys(defaultValues).forEach(fieldName => {
        const element = document.getElementById(`default-${fieldName.replace('_', '-')}`);
        if (element) {
            element.value = defaultValues[fieldName];
        }
    });
}
</script>

<!-- Modal للفلاتر الذكية -->
<div class="modal fade" id="productFiltersModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-filter"></i> فلاتر المنتج الموجود
        </h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          تم العثور على منتج موجود. اختر الحقول التي تريد تحديثها:
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <h6><i class="fas fa-info-circle"></i> معلومات المنتج الحالية:</h6>
            <div id="current-product-info" class="border p-3 mb-3 bg-light">
              <!-- سيتم ملؤها بالـ JavaScript -->
            </div>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-edit"></i> الحقول الجديدة:</h6>
            <div id="new-product-info" class="border p-3 mb-3">
              <!-- سيتم ملؤها بالـ JavaScript -->
            </div>
          </div>
        </div>
        
        <h6><i class="fas fa-check-square"></i> اختر الحقول المراد تحديثها:</h6>
        <div class="form-group">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-name" checked>
            <label class="form-check-label" for="update-name">اسم المنتج</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-part-number">
            <label class="form-check-label" for="update-part-number">رقم القطعة</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-brand">
            <label class="form-check-label" for="update-brand">الماركة</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-commercial-name">
            <label class="form-check-label" for="update-commercial-name">الاسم التجاري</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-origin">
            <label class="form-check-label" for="update-origin">بلد المنشأ</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-unit">
            <label class="form-check-label" for="update-unit">الوحدة</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-warranty">
            <label class="form-check-label" for="update-warranty">مدة الضمان</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="update-price" checked>
            <label class="form-check-label" for="update-price">السعر</label>
          </div>
        </div>
        
        <div class="form-group">
          <label>الكمية المراد إضافتها:</label>
          <input type="number" class="form-control" id="modal-quantity" value="1" min="1">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-primary" id="confirm-update-product">
          <i class="fas fa-save"></i> تأكيد التحديث
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
