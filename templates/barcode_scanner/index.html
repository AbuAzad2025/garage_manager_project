{% extends "base.html" %}

{% block title %}نظام الباركود المتكامل{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">نظام الباركود المتكامل</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item active">نظام الباركود</li>
                    </ol>
                    <div class="float-sm-right mt-2">
                        <a href="{{ url_for('barcode_scanner.bulk_scan_page') }}" class="btn btn-success btn-sm">
                            <i class="fas fa-layer-group"></i> مسح جماعي
                        </a>
                        <a href="{{ url_for('barcode_scanner.barcode_stats') }}" class="btn btn-info btn-sm">
                            <i class="fas fa-chart-bar"></i> إحصائيات
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- إحصائيات سريعة -->
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3 id="total-products">-</h3>
                            <p>إجمالي المنتجات</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3 id="products-with-barcode">-</h3>
                            <p>منتجات مع باركود</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-barcode"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3 id="products-without-barcode">-</h3>
                            <p>منتجات بدون باركود</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <a href="#" class="small-box-footer" id="auto-assign-btn">
                            إعطاء باركود تلقائي <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3 id="barcode-percentage">-</h3>
                            <p>نسبة الباركود</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- أدوات الباركود -->
            <div class="row">
                <!-- ماسح الباركود -->
                <div class="col-md-6">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-qrcode mr-2"></i>
                                ماسح الباركود
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="barcode-input">أدخل الباركود أو امسحه:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="barcode-input" 
                                           placeholder="أدخل الباركود أو SKU أو رقم القطعة">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="button" id="scan-btn">
                                            <i class="fas fa-search"></i> مسح
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- نتائج المسح -->
                            <div id="scan-results" class="mt-3" style="display: none;">
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-check-circle"></i> تم العثور على المنتج</h5>
                                    <div id="product-info"></div>
                                </div>
                            </div>
                            
                            <div id="scan-error" class="mt-3" style="display: none;">
                                <div class="alert alert-danger">
                                    <h5><i class="fas fa-times-circle"></i> المنتج غير موجود</h5>
                                    <p id="error-message"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- توليد الباركود -->
                <div class="col-md-6">
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-print mr-2"></i>
                                توليد الباركود
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="product-search">البحث عن المنتج:</label>
                                <input type="text" class="form-control" id="product-search" 
                                       placeholder="ابحث بالاسم أو SKU">
                                <div id="search-results" class="mt-2"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="barcode-type">نوع الباركود:</label>
                                <select class="form-control" id="barcode-type">
                                    <option value="CODE128">باركود خطي</option>
                                    <option value="QR">QR Code</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-success" id="generate-btn" disabled>
                                <i class="fas fa-barcode"></i> توليد الباركود
                            </button>
                            
                            <!-- معاينة الباركود -->
                            <div id="barcode-preview" class="mt-3" style="display: none;">
                                <div class="text-center">
                                    <img id="barcode-image" class="img-fluid" style="max-width: 300px;">
                                    <div class="mt-2">
                                        <button class="btn btn-info btn-sm" id="print-btn">
                                            <i class="fas fa-print"></i> طباعة
                                        </button>
                                        <button class="btn btn-secondary btn-sm" id="download-btn">
                                            <i class="fas fa-download"></i> تحميل
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- تحديث المخزون -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-warehouse mr-2"></i>
                                تحديث المخزون بالباركود
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inventory-barcode">باركود المنتج:</label>
                                        <input type="text" class="form-control" id="inventory-barcode" 
                                               placeholder="امسح أو أدخل الباركود">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="warehouse-select">المستودع:</label>
                                        <select class="form-control" id="warehouse-select">
                                            <option value="">اختر المستودع</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="quantity-change">الكمية:</label>
                                        <input type="number" class="form-control" id="quantity-change" 
                                               value="0" min="-9999" max="9999">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="operation-type">نوع العملية:</label>
                                        <select class="form-control" id="operation-type">
                                            <option value="adjust">تعديل</option>
                                            <option value="add">إضافة</option>
                                            <option value="subtract">طرح</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-warning" id="update-inventory-btn">
                                <i class="fas fa-sync"></i> تحديث المخزون
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- توليد متعدد -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-layer-group mr-2"></i>
                                توليد باركودات متعددة
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label>اختر المنتجات:</label>
                                        <div id="bulk-products-list" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                                            <p class="text-muted">استخدم البحث أعلاه لإضافة المنتجات</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="bulk-barcode-type">نوع الباركود:</label>
                                        <select class="form-control" id="bulk-barcode-type">
                                            <option value="CODE128">باركود خطي</option>
                                            <option value="QR">QR Code</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-info" id="bulk-generate-btn" disabled>
                                        <i class="fas fa-barcode"></i> توليد جميع الباركودات
                                    </button>
                                </div>
                            </div>
                            
                            <!-- نتائج التوليد المتعدد -->
                            <div id="bulk-results" class="mt-3" style="display: none;">
                                <h5>الباركودات المُولدة:</h5>
                                <div id="bulk-barcodes-grid" class="row"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Modal للتفاصيل -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تفاصيل المنتج</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="product-modal-body">
                <!-- سيتم ملؤها بالجافاسكريبت -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">إغلاق</button>
                <button type="button" class="btn btn-primary" id="modal-generate-btn">
                    <i class="fas fa-barcode"></i> توليد باركود
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let selectedProduct = null;
    let bulkProducts = [];
    
    // تحميل الإحصائيات
    loadStats();
    
    // تحميل المستودعات
    loadWarehouses();
    
    // مسح الباركود
    $('#scan-btn').click(function() {
        const barcode = $('#barcode-input').val().trim();
        if (barcode) {
            scanBarcode(barcode);
        }
    });
    
    $('#barcode-input').keypress(function(e) {
        if (e.which === 13) {
            $('#scan-btn').click();
        }
    });
    
    // البحث عن المنتجات
    let searchTimeout;
    $('#product-search').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val().trim();
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => {
                searchProducts(query);
            }, 300);
        } else {
            $('#search-results').empty();
        }
    });
    
    // توليد الباركود
    $('#generate-btn').click(function() {
        if (selectedProduct) {
            generateBarcode(selectedProduct.id, $('#barcode-type').val());
        }
    });
    
    // تحديث المخزون
    $('#update-inventory-btn').click(function() {
        updateInventory();
    });
    
    // توليد متعدد
    $('#bulk-generate-btn').click(function() {
        bulkGenerateBarcodes();
    });
    
    // طباعة الباركود
    $('#print-btn').click(function() {
        if (selectedProduct) {
            const barcodeType = $('#barcode-type').val();
            window.open(`/barcode/print/${selectedProduct.id}?type=${barcodeType}`, '_blank');
        }
    });
    
    // تحميل الباركود
    $('#download-btn').click(function() {
        const img = document.getElementById('barcode-image');
        const link = document.createElement('a');
        link.download = `barcode_${selectedProduct.sku}.png`;
        link.href = img.src;
        link.click();
    });
    
    // دوال JavaScript
    function loadStats() {
        fetch('/barcode/stats?format=json')
            .then(response => response.json())
            .then(data => {
                console.log('Stats data received:', data);
                $('#total-products').text(data.total_products || 0);
                $('#products-with-barcode').text(data.products_with_barcode || 0);
                $('#products-without-barcode').text(data.products_without_barcode || 0);
                $('#barcode-percentage').text((data.barcode_percentage || 0) + '%');
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                // تعيين قيم افتراضية في حالة الخطأ
                $('#total-products').text('0');
                $('#products-with-barcode').text('0');
                $('#products-without-barcode').text('0');
                $('#barcode-percentage').text('0%');
            });
    }
    
    function loadWarehouses() {
        // تحميل المستودعات من API
        fetch('/api/v1/warehouses')
            .then(response => response.json())
            .then(data => {
                const select = $('#warehouse-select');
                select.empty().append('<option value="">اختر المستودع</option>');
                if (data.results && Array.isArray(data.results)) {
                    data.results.forEach(warehouse => {
                        select.append(`<option value="${warehouse.id}">${warehouse.name}</option>`);
                    });
                }
            })
            .catch(error => console.error('Error loading warehouses:', error));
    }
    
    function scanBarcode(barcode) {
        fetch('/barcode/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ barcode: barcode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.found) {
                showProductInfo(data.product);
            } else {
                showScanError(data.message);
            }
        })
        .catch(error => {
            showScanError('حدث خطأ أثناء المسح');
            console.error('Error:', error);
        });
    }
    
    function showProductInfo(product) {
        const productInfo = `
            <div class="row">
                <div class="col-md-3">
                    <img src="${product.image || '/static/products/default.png'}" 
                         class="img-fluid" alt="صورة المنتج">
                </div>
                <div class="col-md-9">
                    <h6><strong>${product.name}</strong></h6>
                    <p><strong>SKU:</strong> ${product.sku}</p>
                    <p><strong>الباركود:</strong> ${product.barcode || 'غير محدد'}</p>
                    <p><strong>الماركة:</strong> ${product.brand || 'غير محدد'}</p>
                    <p><strong>الفئة:</strong> ${product.category || 'غير محدد'}</p>
                    <p><strong>السعر:</strong> ${product.selling_price} شيكل</p>
                    <p><strong>المخزون الإجمالي:</strong> ${product.total_stock}</p>
                </div>
            </div>
        `;
        
        $('#product-info').html(productInfo);
        $('#scan-results').show();
        $('#scan-error').hide();
    }
    
    function showScanError(message) {
        $('#error-message').text(message);
        $('#scan-error').show();
        $('#scan-results').hide();
    }
    
    function searchProducts(query) {
        fetch(`/barcode/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const results = $('#search-results');
                results.empty();
                
                if (data.products.length === 0) {
                    results.html('<p class="text-muted">لا توجد نتائج</p>');
                    return;
                }
                
                data.products.forEach(product => {
                    const productItem = $(`
                        <div class="search-result-item border-bottom p-2 cursor-pointer" 
                             data-product='${JSON.stringify(product)}'>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${product.name}</strong><br>
                                    <small class="text-muted">SKU: ${product.sku} | المخزون: ${product.total_stock}</small>
                                </div>
                                <div>
                                    <span class="badge ${product.has_barcode ? 'badge-success' : 'badge-warning'}">
                                        ${product.has_barcode ? 'له باركود' : 'بدون باركود'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                    
                    productItem.click(function() {
                        selectedProduct = product;
                        $('#product-search').val(product.name);
                        $('#generate-btn').prop('disabled', false);
                        results.empty();
                        updateBulkProductsList();
                    });
                    
                    results.append(productItem);
                });
            })
            .catch(error => console.error('Error searching products:', error));
    }
    
    function generateBarcode(productId, barcodeType) {
        fetch('/barcode/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                product_id: productId, 
                type: barcodeType 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#barcode-image').attr('src', data.image);
                $('#barcode-preview').show();
            } else {
                alert('خطأ في توليد الباركود: ' + data.error);
            }
        })
        .catch(error => {
            alert('حدث خطأ أثناء توليد الباركود');
            console.error('Error:', error);
        });
    }
    
    function updateInventory() {
        const barcode = $('#inventory-barcode').val().trim();
        const warehouseId = $('#warehouse-select').val();
        const quantityChange = parseInt($('#quantity-change').val());
        const operation = $('#operation-type').val();
        
        if (!barcode || !warehouseId) {
            alert('يرجى إدخال الباركود واختيار المستودع');
            return;
        }
        
        fetch('/barcode/inventory/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                barcode: barcode,
                warehouse_id: warehouseId,
                quantity_change: quantityChange,
                operation: operation
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`تم تحديث المخزون بنجاح. الكمية الجديدة: ${data.new_quantity}`);
                $('#inventory-barcode').val('');
                $('#quantity-change').val(0);
            } else {
                alert('خطأ في تحديث المخزون: ' + data.error);
            }
        })
        .catch(error => {
            alert('حدث خطأ أثناء تحديث المخزون');
            console.error('Error:', error);
        });
    }
    
    function updateBulkProductsList() {
        const list = $('#bulk-products-list');
        list.empty();
        
        if (bulkProducts.length === 0) {
            list.html('<p class="text-muted">استخدم البحث أعلاه لإضافة المنتجات</p>');
            $('#bulk-generate-btn').prop('disabled', true);
            return;
        }
        
        bulkProducts.forEach((product, index) => {
            const item = $(`
                <div class="d-flex justify-content-between align-items-center border-bottom p-2">
                    <div>
                        <strong>${product.name}</strong><br>
                        <small class="text-muted">SKU: ${product.sku}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeBulkProduct(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            list.append(item);
        });
        
        $('#bulk-generate-btn').prop('disabled', false);
    }
    
    function removeBulkProduct(index) {
        bulkProducts.splice(index, 1);
        updateBulkProductsList();
    }
    
    function bulkGenerateBarcodes() {
        if (bulkProducts.length === 0) {
            alert('يرجى إضافة منتجات أولاً');
            return;
        }
        
        const productIds = bulkProducts.map(p => p.id);
        const barcodeType = $('#bulk-barcode-type').val();
        
        fetch('/barcode/bulk-generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_ids: productIds,
                type: barcodeType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showBulkResults(data.barcodes);
            } else {
                alert('خطأ في توليد الباركودات: ' + data.error);
            }
        })
        .catch(error => {
            alert('حدث خطأ أثناء توليد الباركودات');
            console.error('Error:', error);
        });
    }
    
    function showBulkResults(barcodes) {
        const grid = $('#bulk-barcodes-grid');
        grid.empty();
        
        barcodes.forEach(barcode => {
            const item = $(`
                <div class="col-md-3 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <img src="${barcode.image}" class="img-fluid mb-2" style="max-height: 100px;">
                            <h6>${barcode.product_name}</h6>
                            <small class="text-muted">${barcode.sku}</small>
                        </div>
                    </div>
                </div>
            `);
            grid.append(item);
        });
        
        $('#bulk-results').show();
    }
    
    // إضافة منتج للقائمة المتعددة
    window.addToBulkList = function(product) {
        if (!bulkProducts.find(p => p.id === product.id)) {
            bulkProducts.push(product);
            updateBulkProductsList();
        }
    };
    
    // إزالة منتج من القائمة المتعددة
    window.removeBulkProduct = removeBulkProduct;
    
    // زر إعطاء باركود تلقائي
    $('#auto-assign-btn').click(function(e) {
        e.preventDefault();
        
        if (confirm('هل تريد إعطاء باركود فريد لجميع المنتجات التي لا تحتوي على باركود؟')) {
            const btn = $(this);
            const originalText = btn.html();
            btn.html('<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...');
            btn.prop('disabled', true);
            
            fetch('/barcode/auto-assign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadStats(); // تحديث الإحصائيات
                } else {
                    alert('خطأ: ' + data.error);
                }
            })
            .catch(error => {
                alert('حدث خطأ أثناء إعطاء الباركودات');
                console.error('Error:', error);
            })
            .finally(() => {
                btn.html(originalText);
                btn.prop('disabled', false);
            });
        }
    });
});
</script>
{% endblock %}