{% extends 'base.html' %}
{% block title %}ุงูุชุญูู ุจุงูุฃูุงู{% endblock %}
{% block page_title %}๐ ุงูุชุญูู ุจุงูุฃูุงู - IP Whitelist & Country Blocking{% endblock %}

{% block content %}
<div class="container-fluid">
  
  <form method="POST" action="{{ url_for('security_control.security_control') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="save_ip_settings">
    
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <h6 class="text-muted">ุงููุงุฆูุฉ ุงูุจูุถุงุก</h6>
            <h3 class="text-success">{{ stats.whitelist_count }}</h3>
            <small>ุนูุงููู IP</small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <h6 class="text-muted">ุงููุงุฆูุฉ ุงูุณูุฏุงุก</h6>
            <h3 class="text-danger">{{ stats.blacklist_count }}</h3>
            <small>ุนูุงููู IP</small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <h6 class="text-muted">ุฏูู ูุญุธูุฑุฉ</h6>
            <h3 class="text-warning">{{ stats.blocked_countries_count }}</h3>
            <small>ุฏููุฉ</small>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-shield-alt"></i> ุงููุงุฆูุฉ ุงูุจูุถุงุก (IP Whitelist)</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input type="checkbox" name="enable_ip_whitelist" class="form-check-input" 
                     {% if enable_whitelist %}checked{% endif %} id="enableWhitelist">
              <label class="form-check-label" for="enableWhitelist">
                <strong>ุชูุนูู ุงููุงุฆูุฉ ุงูุจูุถุงุก</strong>
                <br><small class="text-muted">ุงูุณูุงุญ ููุท ููู IPs ุงููุฏุฑุฌุฉ</small>
              </label>
            </div>
            
            <label class="form-label">ุนูุงููู IP ุงููุณููุญุฉ (ุณุทุฑ ููู IP):</label>
            <textarea name="whitelist_ips" class="form-control font-monospace" rows="8" 
                      style="font-size: 0.9rem;">{% for ip in whitelist %}{{ ip }}
{% endfor %}</textarea>
            <small class="form-text text-muted">
              <i class="fas fa-info-circle"></i> ูุซุงู: 192.168.1.100
            </small>
          </div>
        </div>
      </div>

      <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="fas fa-ban"></i> ุงููุงุฆูุฉ ุงูุณูุฏุงุก (IP Blacklist)</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input type="checkbox" name="enable_ip_blacklist" class="form-check-input" 
                     {% if enable_blacklist %}checked{% endif %} id="enableBlacklist">
              <label class="form-check-label" for="enableBlacklist">
                <strong>ุชูุนูู ุงููุงุฆูุฉ ุงูุณูุฏุงุก</strong>
                <br><small class="text-muted">ุญุธุฑ ุงูู IPs ุงููุฏุฑุฌุฉ</small>
              </label>
            </div>
            
            <label class="form-label">ุนูุงููู IP ุงููุญุธูุฑุฉ (ุณุทุฑ ููู IP):</label>
            <textarea name="blacklist_ips" class="form-control font-monospace" rows="8" 
                      style="font-size: 0.9rem;">{% for ip in blacklist %}{{ ip }}
{% endfor %}</textarea>
            <small class="form-text text-muted">
              <i class="fas fa-info-circle"></i> ูุซุงู: 1.2.3.4
            </small>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12 mb-4">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-globe"></i> ุญุธุฑ ุงูุฏูู (Country Blocking)</h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input type="checkbox" name="enable_country_blocking" class="form-check-input" 
                     {% if enable_country_block %}checked{% endif %} id="enableCountryBlock">
              <label class="form-check-label" for="enableCountryBlock">
                <strong>ุชูุนูู ุญุธุฑ ุงูุฏูู</strong>
                <br><small class="text-muted">ููุน ุงููุตูู ูู ุฏูู ูุญุฏุฏุฉ</small>
              </label>
            </div>
            
            <label class="form-label">ุงุฎุชุฑ ุงูุฏูู ุงููุญุธูุฑุฉ:</label>
            <div class="row">
              {% for country in all_countries %}
              <div class="col-md-3 mb-2">
                <div class="form-check">
                  <input type="checkbox" name="blocked_countries" value="{{ country.code }}" 
                         class="form-check-input" id="country_{{ country.code }}"
                         {% if country.code in blocked_countries %}checked{% endif %}>
                  <label class="form-check-label" for="country_{{ country.code }}">
                    {{ country.name }} ({{ country.code }})
                  </label>
                </div>
              </div>
              {% endfor %}
            </div>
            <small class="form-text text-muted">
              <i class="fas fa-info-circle"></i> ูุณุชุฎุฏู IP Geolocation API ููุชุญูู ูู ุงูุฏููุฉ
            </small>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12 text-center">
        <button type="submit" class="btn btn-primary btn-lg">
          <i class="fas fa-save"></i> ุญูุธ ุงูุฅุนุฏุงุฏุงุช
        </button>
      </div>
    </div>
  </form>

  <div class="row mt-5">
    <div class="col-md-12">
      <div class="card border-0 shadow-sm border-info">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-flask"></i> ุงุฎุชุจุงุฑ IP</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">ุฃุฏุฎู IP ููุงุฎุชุจุงุฑ:</label>
              <div class="input-group">
                <input type="text" id="testIpInput" class="form-control" placeholder="192.168.1.1">
                <button type="button" class="btn btn-info" onclick="testIP()">
                  <i class="fas fa-search"></i> ุงุฎุชุจุงุฑ
                </button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">ุงููุชูุฌุฉ:</label>
              <div id="testResult" class="alert alert-secondary">
                <i class="fas fa-info-circle"></i> ุฃุฏุฎู IP ูุงุถุบุท "ุงุฎุชุจุงุฑ"
              </div>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-12">
              <p class="mb-0"><strong>IP ุงูุญุงูู:</strong> <code>{{ request.remote_addr }}</code></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="alert alert-warning">
        <h6><i class="fas fa-exclamation-triangle"></i> ุชุญุฐูุฑุงุช ูุงูุฉ:</h6>
        <ul class="mb-0">
          <li><strong>ุงููุงุฆูุฉ ุงูุจูุถุงุก:</strong> ุนูุฏ ุงูุชูุนููุ ุณูุชู ุฑูุถ ุฌููุน ุงูุทูุจุงุช ูู IPs ุบูุฑ ูุฏุฑุฌุฉ</li>
          <li><strong>ุงููุงุฆูุฉ ุงูุณูุฏุงุก:</strong> ุชุญุธุฑ IPs ูุญุฏุฏุฉ ููุท</li>
          <li><strong>ุญุธุฑ ุงูุฏูู:</strong> ูุนุชูุฏ ุนูู ุฎุฏูุฉ ุฎุงุฑุฌูุฉ (ip-api.com)</li>
          <li><strong>ุงูุฃููููุฉ:</strong> ุงููุงุฆูุฉ ุงูุณูุฏุงุก โ ุงููุงุฆูุฉ ุงูุจูุถุงุก โ ุญุธุฑ ุงูุฏูู</li>
          <li><strong>ุชูุจูู:</strong> ุชุฃูุฏ ูู ุฅุถุงูุฉ IP ุงูุฎุงุต ุจู ูุจู ุชูุนูู ุงููุงุฆูุฉ ุงูุจูุถุงุก!</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<script>
function testIP() {
    const ip = document.getElementById('testIpInput').value.trim();
    if (!ip) {
        alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู IP');
        return;
    }
    
    fetch('{{ url_for("security_control.api_check_ip", ip="0.0.0.0") }}'.replace('0.0.0.0', ip))
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('testResult');
            if (data.allowed) {
                resultDiv.className = 'alert alert-success';
                resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> <strong>ูุณููุญ:</strong> ' + data.reason;
            } else {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> <strong>ูุญุธูุฑ:</strong> ' + data.reason;
            }
        })
        .catch(error => {
            const resultDiv = document.getElementById('testResult');
            resultDiv.className = 'alert alert-danger';
            resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ';
        });
}
</script>
{% endblock %}

