{% extends 'base.html' %}

{% block title %}Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
.backup-action-form {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.35rem;
}
.backup-action-form input {
  max-width: 160px;
}
.backup-status-card small {
  display: block;
}
</style>
{% endblock %}

{% block page_title %}ğŸ’¾ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…{% endblock %}

{% block content %}
<div class="container-fluid">
  
  {% include 'advanced/_navigation.html' %}
  
  <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø³Ø±ÙŠØ¹Ø© -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-primary text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø®</h6>
              <h3 class="mb-0 fw-bold">{{ backups|length }}</h3>
              <small class="opacity-75">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</small>
            </div>
            <i class="fas fa-database fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-success text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</h6>
              <h3 class="mb-0 fw-bold">{{ current_db_type|upper }}</h3>
              <small class="opacity-75">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
            </div>
            <i class="fas fa-server fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-{{ schedule_status.color }} text-white h-100 backup-status-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h6>
              <h3 class="mb-0 fw-bold">{{ schedule_status.text }}</h3>
              <small class="opacity-75">Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ: {{ schedule_status.next_run or '---' }}</small>
            </div>
            <i class="fas fa-clock fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card border-0 shadow-sm bg-{{ backup_summary.color }} text-white h-100 backup-status-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">Ø¢Ø®Ø± Ù†Ø³Ø®Ø©</h6>
              <h3 class="mb-0 fw-bold">
                {% if backup_summary.last_backup %}
                  {{ backup_summary.last_backup.date }}
                {% else %}
                  Ù„Ø§ ÙŠÙˆØ¬Ø¯
                {% endif %}
              </h3>
              <small class="opacity-75">{{ backup_summary.last_backup.name if backup_summary.last_backup else '-' }}</small>
            </div>
            <i class="fas fa-history fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <span><i class="fas fa-history"></i> Ø£Ø­Ø¯Ø« Ø§Ù„Ù†Ø³Ø®</span>
          <span class="badge bg-secondary">{{ recent_backups|length }}</span>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for backup in recent_backups %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ backup.name }}</strong>
                <div class="small text-muted">{{ backup.date }}</div>
              </div>
              <span class="badge bg-info">{{ backup.size }}</span>
            </li>
            {% else %}
            <li class="list-group-item text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø¨Ø¹Ø¯</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
          <span><i class="fas fa-exclamation-circle"></i> ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ÙØ´Ù„</span>
          <span class="badge bg-light text-dark">{{ backup_failures|length }}</span>
        </div>
        <div class="card-body">
          {% if backup_failures %}
            {% for failure in backup_failures %}
            <div class="alert alert-warning">
              <strong>{{ failure.timestamp[:16] }}</strong><br>
              {{ failure.message }}
            </div>
            {% endfor %}
          {% else %}
          <div class="alert alert-success mb-0">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ÙØ§Ø´Ù„Ø© Ù…Ø¤Ø®Ø±Ø§Ù‹
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <div class="alert alert-{{ backup_summary.color }} border-0 shadow-sm mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1"><i class="fas fa-database"></i> Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h5>
        <p class="mb-0">{{ backup_summary.message }}</p>
      </div>
      <span class="fw-bold">{{ backup_summary.recommendation }}</span>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs mb-4" id="backupTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="backups-tab" data-toggle="tab" href="#backups" role="tab">
        <i class="fas fa-save"></i> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="schedule-tab" data-toggle="tab" href="#schedule" role="tab">
        <i class="fas fa-clock"></i> Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="convert-tab" data-toggle="tab" href="#convert" role="tab">
        <i class="fas fa-exchange-alt"></i> ØªØ­ÙˆÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      </a>
    </li>
  </ul>

  <!-- Tabs Content -->
  <div class="tab-content" id="backupTabsContent">
    
    <!-- ============================================ -->
    <!-- TAB 1: Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
    <!-- ============================================ -->
    <div class="tab-pane fade in active show" id="backups" role="tabpanel">
      <div class="row">
        <!-- Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0"><i class="fas fa-plus"></i> Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h5>
            </div>
            <div class="card-body">
              <form method="POST" action="{{ url_for('advanced.backup_manager') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="create_backup">
                
                <div class="mb-3">
                  <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„Ù†Ø³Ø®Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input type="text" name="backup_name" class="form-control" placeholder="backup_custom_name">
                  <small class="text-muted">Ø¥Ø°Ø§ ØªØ±ÙƒØªÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø³ÙŠØªÙ… Ø§Ù„ØªØ³Ù…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
                </div>
                
                <div class="alert alert-info small">
                  <strong>Ù†ÙˆØ¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong><br>
                  <span class="badge bg-primary">{{ current_db_type }}</span>
                </div>
                
                <button type="submit" class="btn btn-success w-100 btn-lg">
                  <i class="fas fa-save"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ù„Ø¢Ù†
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="fas fa-history"></i> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© ({{ backups|length }})</h5>
            </div>
            <div class="card-body">
              {% if backups %}
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</th>
                      <th>Ø§Ù„Ø­Ø¬Ù…</th>
                      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                      <th>Ø§Ù„Ø¹Ù…Ø± (Ø³Ø§Ø¹Ø©)</th>
                      <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for backup in backups %}
                    <tr>
                      <td><code>{{ backup.name }}</code></td>
                      <td><span class="badge bg-info">{{ backup.size }}</span></td>
                      <td>{{ backup.date }}</td>
                      <td>{{ backup.age_hours }}</td>
                      <td>
                        <div>
                          <form method="POST" action="{{ url_for('advanced.restore_backup', filename=backup.name) }}" class="backup-action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="text" name="confirm_token" class="form-control form-control-sm" placeholder="Ø§ÙƒØªØ¨ {{ backup.name }}" required>
                            <button type="submit" class="btn btn-success btn-sm">
                              <i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                            </button>
                          </form>
                          <div class="d-flex" style="gap:0.5rem;">
                            <a href="{{ url_for('advanced.download_backup', filename=backup.name) }}" class="btn btn-primary btn-sm flex-fill">
                            <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                          </div>
                          <form method="POST" action="{{ url_for('advanced.delete_backup', filename=backup.name) }}" class="backup-action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="text" name="confirm_token" class="form-control form-control-sm" placeholder="Ø§ÙƒØªØ¨ {{ backup.name }}" required>
                            <button type="submit" class="btn btn-danger btn-sm">
                              <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB 2: Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© -->
    <!-- ============================================ -->
    <div class="tab-pane fade" id="schedule" role="tabpanel">
      <div class="row">
        <div class="col-md-6 mx-auto">
          <div class="card shadow-lg">
            <div class="card-header bg-gradient-primary text-white">
              <h5 class="mb-0"><i class="fas fa-clock"></i> Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h5>
            </div>
            <div class="card-body">
              
              <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ -->
              <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                <div>
                  {% if auto_backup_enabled %}
                  <div class="text-success">
                    <i class="fas fa-check-circle fa-2x"></i>
                    <h6 class="mt-2 mb-0">Ù…ÙØ¹Ù‘Ù„</h6>
                    <small>Ø§Ù„Ù†ÙˆØ¹: {{ schedule_info.type or 'daily' }} - Ø§Ù„ÙˆÙ‚Øª: {{ schedule_info.time or '03:00' }}</small>
                    <small>Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ: {{ schedule_status.next_run or '---' }}</small>
                  </div>
                  {% else %}
                  <div class="text-warning">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <h6 class="mt-2 mb-0">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</h6>
                  </div>
                  {% endif %}
                </div>
                
                <form method="POST" action="{{ url_for('advanced.toggle_auto_backup') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-{% if auto_backup_enabled %}warning{% else %}success{% endif %} btn-lg">
                    <i class="fas fa-power-off"></i> {% if auto_backup_enabled %}ØªØ¹Ø·ÙŠÙ„{% else %}ØªÙØ¹ÙŠÙ„{% endif %}
                  </button>
                </form>
              </div>
              
              <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© -->
              <form method="POST" action="{{ url_for('advanced.backup_manager') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="schedule_backup">
                
                <div class="mb-4">
                  <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©</label>
                  <select name="schedule_type" class="custom-select custom-select-lg" required>
                    <option value="hourly" {% if schedule_info.type == 'hourly' %}selected{% endif %}>ÙƒÙ„ Ø³Ø§Ø¹Ø©</option>
                    <option value="daily" {% if schedule_info.type == 'daily' or not schedule_info.type %}selected{% endif %}>ÙŠÙˆÙ…ÙŠØ§Ù‹</option>
                    <option value="weekly" {% if schedule_info.type == 'weekly' %}selected{% endif %}>Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹</option>
                    <option value="monthly" {% if schedule_info.type == 'monthly' %}selected{% endif %}>Ø´Ù‡Ø±ÙŠØ§Ù‹</option>
                  </select>
                </div>
                
                <div class="mb-4">
                  <label class="form-label fw-bold">Ø§Ù„ÙˆÙ‚Øª</label>
                  <input type="time" name="schedule_time" class="form-control form-control-lg" value="{{ schedule_info.time or '03:00' }}" required>
                  <small class="text-muted">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</small>
                </div>
                
                <div class="alert alert-info">
                  <i class="fas fa-lightbulb"></i> <strong>Ù†ØµÙŠØ­Ø©:</strong> ÙŠÙÙØ¶Ù„ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® ÙÙŠ ÙˆÙ‚Øª Ù‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ù…Ø«Ù„ Ø§Ù„Ø³Ø§Ø¹Ø© 3 ØµØ¨Ø§Ø­Ø§Ù‹)
                </div>
                
                <button type="submit" class="btn btn-primary w-100 btn-lg">
                  <i class="fas fa-check"></i> Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB 3: ØªØ­ÙˆÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <!-- ============================================ -->
    <div class="tab-pane fade" id="convert" role="tabpanel">
      
      <div class="alert alert-danger border-0 shadow-sm">
        <i class="fas fa-exclamation-triangle"></i> <strong>ØªØ­Ø°ÙŠØ±:</strong> ØªØ­ÙˆÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„ÙŠØ© Ø­Ø³Ø§Ø³Ø©! Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„.
      </div>

      <!-- Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card bg-light shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-3">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h6>
              <div class="d-flex align-items-center gap-3">
                <div class="p-3 rounded bg-success bg-opacity-10">
                  <i class="fas fa-database fa-3x text-success"></i>
                </div>
                <div>
                  <h4 class="mb-0">{{ current_db_type }}</h4>
                  <small class="text-muted">Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card h-100 text-center db-card" onclick="selectDB('sqlite')">
            <div class="card-body">
              <i class="fas fa-database fa-3x text-primary mb-3"></i>
              <h6>SQLite</h6>
              <small class="text-muted">Ù…Ù„Ù Ù…Ø­Ù„ÙŠ - Ø³Ø±ÙŠØ¹</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100 text-center db-card" onclick="selectDB('postgresql')">
            <div class="card-body">
              <i class="fas fa-server fa-3x text-info mb-3"></i>
              <h6>PostgreSQL</h6>
              <small class="text-muted">Ù‚ÙˆÙŠ - Ø§Ø­ØªØ±Ø§ÙÙŠ</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100 text-center db-card" onclick="selectDB('mysql')">
            <div class="card-body">
              <i class="fas fa-database fa-3x text-warning mb-3"></i>
              <h6>MySQL</h6>
              <small class="text-muted">Ø´Ø§Ø¦Ø¹ - Ù…ÙˆØ«ÙˆÙ‚</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100 text-center db-card" onclick="selectDB('mssql')">
            <div class="card-body">
              <i class="fas fa-server fa-3x text-danger mb-3"></i>
              <h6>SQL Server</h6>
              <small class="text-muted">Microsoft</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ­ÙˆÙŠÙ„ -->
      <div class="row">
        <div class="col-md-10 mx-auto">
          <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> ØªØ­ÙˆÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
            </div>
            <div class="card-body">
              <form method="POST" action="{{ url_for('advanced.backup_manager') }}" id="convertForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="convert_database">
                <input type="hidden" name="target_db" id="target_db" value="">
                
                <div class="mb-4">
                  <label class="form-label fw-bold">Ù†ÙˆØ¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
                  <select class="custom-select custom-select-lg" id="db_type_select" onchange="updateConnectionString()" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ --</option>
                    <option value="sqlite">SQLite</option>
                    <option value="postgresql">PostgreSQL</option>
                    <option value="mysql">MySQL</option>
                    <option value="mssql">SQL Server</option>
                  </select>
                </div>
                
                <div class="mb-4">
                  <label class="form-label fw-bold">Connection String</label>
                  <textarea name="connection_string" id="connection_string" class="form-control" rows="3" placeholder="Ù…Ø«Ø§Ù„: postgresql://user:password@localhost/dbname" required></textarea>
                  <small class="text-muted" id="connection_hint"></small>
                  
                  <div class="mt-2">
                    <button type="button" class="btn btn-info" onclick="testConnection()">
                      <i class="fas fa-plug"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                    <span id="connection_status" class="ms-2"></span>
                  </div>
                </div>
                
                <div id="connection_examples" class="alert alert-light" style="display:none;">
                  <strong>Ø£Ù…Ø«Ù„Ø©:</strong>
                  <div id="example_text"></div>
                </div>
                
                <div class="alert alert-warning">
                  <strong>ØªØ£ÙƒÙŠØ¯:</strong>
                  <ul class="mb-0 mt-2">
                    <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©</li>
                    <li>ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</li>
                    <li>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                    <li>Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹</li>
                  </ul>
                </div>
                
                <button type="submit" class="btn btn-danger w-100 btn-lg">
                  <i class="fas fa-exchange-alt"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    
  </div>

</div>

<style>
/* Tab Panes - Bootstrap 4 Fix */
.tab-content > .tab-pane {
  display: none;
}
.tab-content > .active {
  display: block !important;
}
.tab-pane.fade {
  opacity: 0;
  transition: opacity 0.15s linear;
}
.tab-pane.fade.in,
.tab-pane.fade.show {
  opacity: 1;
}

/* DB Cards */
.db-card {
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}
.db-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.db-card.active {
  border: 3px solid #28a745;
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
}
</style>

<script>
// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Bootstrap 4
$(document).ready(function() {
  // ØªÙØ¹ÙŠÙ„ tabs
  $('#backupTabs a[data-toggle="tab"]').on('click', function (e) {
    e.preventDefault();
    $(this).tab('show');
  });
  
  // Ø­ÙØ¸ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
  $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    localStorage.setItem('activeTab', $(e.target).attr('href'));
  });
  
  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
  var activeTab = localStorage.getItem('activeTab');
  if (activeTab) {
    $('#backupTabs a[href="' + activeTab + '"]').tab('show');
  }
});

function selectDB(type) {
  document.querySelectorAll('.db-card').forEach(c => c.classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.getElementById('db_type_select').value = type;
  document.getElementById('target_db').value = type;
  updateConnectionString();
}

function updateConnectionString() {
  const type = document.getElementById('db_type_select').value;
  const connString = document.getElementById('connection_string');
  const hint = document.getElementById('connection_hint');
  const examples = document.getElementById('connection_examples');
  const exampleText = document.getElementById('example_text');
  
  document.getElementById('target_db').value = type;
  
  if (type === 'sqlite') {
    connString.value = 'sqlite:///instance/app_new.db';
    hint.textContent = 'Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ';
    exampleText.innerHTML = '<code>sqlite:///instance/app_new.db</code>';
    examples.style.display = 'block';
  } else if (type === 'postgresql') {
    connString.value = 'postgresql://user:password@localhost:5432/dbname';
    hint.textContent = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±@Ø§Ù„Ø³ÙŠØ±ÙØ±:Ø§Ù„Ù…Ù†ÙØ°/Ø§Ø³Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    exampleText.innerHTML = '<code>postgresql://azad:123456@localhost:5432/garage_db</code>';
    examples.style.display = 'block';
  } else if (type === 'mysql') {
    connString.value = 'mysql+pymysql://user:password@localhost:3306/dbname';
    hint.textContent = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±@Ø§Ù„Ø³ÙŠØ±ÙØ±:Ø§Ù„Ù…Ù†ÙØ°/Ø§Ø³Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    exampleText.innerHTML = '<code>mysql+pymysql://root:123456@localhost:3306/garage_db</code>';
    examples.style.display = 'block';
  } else if (type === 'mssql') {
    connString.value = 'mssql+pyodbc://user:password@localhost/dbname?driver=ODBC+Driver+17+for+SQL+Server';
    hint.textContent = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±@Ø§Ù„Ø³ÙŠØ±ÙØ±/Ø§Ø³Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    exampleText.innerHTML = '<code>mssql+pyodbc://sa:Pass123@localhost/garage_db?driver=ODBC+Driver+17+for+SQL+Server</code>';
    examples.style.display = 'block';
  } else {
    connString.value = '';
    hint.textContent = '';
    examples.style.display = 'none';
  }
}

function testConnection() {
  const connString = document.getElementById('connection_string').value;
  const statusSpan = document.getElementById('connection_status');
  
  if (!connString) {
    statusSpan.innerHTML = '<span class="badge bg-danger">Ø£Ø¯Ø®Ù„ Connection String Ø£ÙˆÙ„Ø§Ù‹</span>';
    return;
  }
  
  statusSpan.innerHTML = '<span class="badge bg-warning"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</span>';
  
  fetch('{{ url_for("advanced.test_db_connection") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: 'csrf_token={{ csrf_token() }}&connection_string=' + encodeURIComponent(connString)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      statusSpan.innerHTML = '<span class="badge bg-success"><i class="fas fa-check"></i> ' + data.message + '</span>';
    } else {
      statusSpan.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times"></i> ' + data.message + '</span>';
    }
  })
  .catch(error => {
    statusSpan.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times"></i> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</span>';
  });
}
</script>

{% endblock %}
