# ุฅุตูุงุญ ุฎุทุฃ ุญุณุงุจ ุฑุตูุฏ ุงูุดุฑูุงุก

**ุงูุชุงุฑูุฎ:** 2025-10-17  
**ุงูุญุงูุฉ:** โ **ุชู ุงูุฅุตูุงุญ**

---

## โ ุงููุดููุฉ

```
Error calculating partner 1 balance: type object 'Sale' has no attribute 'partner_id'
```

### ุงูุณุจุจ:
ุงูููุฏ ูู `routes/vendors.py` ูุงู ูุญุงูู ุงููุตูู ุฅูู:
```python
sales = Sale.query.filter(Sale.partner_id == partner.id).all()
```

ููู ุฌุฏูู `Sale` **ูุง ูุญุชูู ุนูู ุญูู `partner_id`**!

---

## ๐ ุงูุชุญููู

### ุฌุฏูู Sale ูุญุชูู ุนูู:
- `customer_id` โ ููุนููุงุก
- `seller_id` โ ููููุธู ุงูุจุงุฆุน
- โ **ูุง ููุฌุฏ `partner_id`**

### ุงูุดุฑูุงุก (Partners) ูุฑุชุจุทูู ุจู:
- โ `ServiceTask` โ **ููุงู ุงูุตูุงูุฉ**
- โ `ServicePart` โ ูุทุน ุงูุบูุงุฑ ูู ุงูุฎุฏูุฉ
- โ `Warehouse` โ ุงููุณุชูุฏุนุงุช
- โ `Payment` โ ุงููุฏููุนุงุช
- โ `ExchangeTransaction` โ ูุนุงููุงุช ุงูุชุจุงุฏู

---

## โ ุงูุญู ุงููุทุจู

ุชู ุชุนุฏูู ุงูููุฏ ููุจุญุซ ุนู `ServiceTask` ุจุฏูุงู ูู `Sale`:

### ูุจู:
```python
# ุฎุทุฃ: Sale ููุณ ูู partner_id
sales = Sale.query.filter(Sale.partner_id == partner.id).all()
```

### ุจุนุฏ:
```python
# ุตุญูุญ: ServiceTask ูู partner_id
from models import ServiceTask
service_tasks = ServiceTask.query.filter(ServiceTask.partner_id == partner.id).all()

for task in service_tasks:
    if task.service and task.service.total_amount:
        amount = float(task.service.total_amount or 0)
        # ุงุญุณุจ ุญุตุฉ ุงูุดุฑูู
        if task.share_percentage:
            amount = amount * (float(task.share_percentage) / 100.0)
        sales_total += amount
```

---

## ๐ฏ ูุง ูุญุณุจู ุงูููุฏ ุงูุขู:

### 1. **ุฅูุฑุงุฏุงุช ุงูุดุฑูู** (ูู ServiceTask):
- ุฎุฏูุงุช ุงูุตูุงูุฉ ุงูุชู ุนูู ุนูููุง ุงูุดุฑูู
- ูุญุณุจ ุญุตุชู ุจูุงุกู ุนูู `share_percentage`
- ูุญููู ุงูุนููุงุช ุฅูู ุดููู ุฅุฐุง ูุฒู ุงูุฃูุฑ

### 2. **ุงููุฏููุนุงุช ููุดุฑูู** (ูู Payment):
- ุงูุฏูุนุงุช ุงููุงุฑุฏุฉ ูู ุงูุดุฑูู
- `Payment.partner_id == partner.id`
- `Payment.direction == 'IN'`

### 3. **ุงูุฑุตูุฏ ุงูููุงุฆู**:
```
ุงูุฑุตูุฏ = ุงูุฅูุฑุงุฏุงุช - ุงููุฏููุนุงุช
```

- **ููุฌุจ** โ ูุณุชุญู ุฏูุน ููุดุฑูู
- **ุณุงูุจ** โ ุงูุดุฑูู ูุฏูู ููุง

---

## ๐ ุงููุชูุฌุฉ

### ูุจู:
```
โ Error calculating partner 1 balance: type object 'Sale' has no attribute 'partner_id'
โ Error calculating partner 2 balance: ...
โ Error calculating partner 3 balance: ...
```

### ุจุนุฏ:
```
โ ุญุณุงุจ ุฑุตูุฏ ุงูุดุฑูู 1 ุจูุฌุงุญ
โ ุญุณุงุจ ุฑุตูุฏ ุงูุดุฑูู 2 ุจูุฌุงุญ
โ ุญุณุงุจ ุฑุตูุฏ ุงูุดุฑูู 3 ุจูุฌุงุญ
```

---

## ๐ ููุงุญุธุงุช

1. **ServiceTask** ูู ุงูุฑุงุจุท ุงูุตุญูุญ ุจูู ุงูุดุฑูุงุก ูุงูุฎุฏูุงุช
2. `share_percentage` ูุญุฏุฏ ุญุตุฉ ุงูุดุฑูู ูู ูู ุฎุฏูุฉ
3. ูุชู ุชุญููู ุฌููุน ุงููุจุงูุบ ุฅูู ุดููู ููุญุณุงุจ ุงูููุญุฏ
4. ุงูููุฏ ุงูุขู ูุชุนุงูู ูุน ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ

---

## ๐ ููุชุทุจูู

ุงูููุฏ ุชู ุชุนุฏููู ูู:
- โ `routes/vendors.py` (ุงูุณุทุฑ ~472)

**ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุชุดุบูู** - ุงูุชุนุฏูู ุณูุนูู ูู ุงูุทูุจ ุงููุงุฏู.

---

## โ ุงูุฎูุงุตุฉ

- โ ุชู ุฅุตูุงุญ ุงูุฎุทุฃ
- โ ุญุณุงุจ ุฑุตูุฏ ุงูุดุฑูุงุก ูุนูู ุงูุขู ุจุดูู ุตุญูุญ
- โ ูุญุณุจ ูู ServiceTask ูููุณ Sale
- โ ูุฑุงุนู ูุณุจุฉ ุญุตุฉ ุงูุดุฑูู

**ุงูุดุฑูุงุก ุงูุขู ููุนุฑุถูู ุจุฃุฑุตุฏุชูู ุงูุตุญูุญุฉ!** ๐

