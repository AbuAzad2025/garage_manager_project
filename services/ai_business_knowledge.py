"""
AI Business Knowledge - معرفة متخصصة في المحاسبة والإدارة المالية والكراجات
معرفة شاملة ومتقدمة في جميع جوانب العمل
"""

# ====================================================================
# المحاسبة والإدارة المالية
# ====================================================================

ACCOUNTING_KNOWLEDGE = {
    'general_concepts': {
        'name': 'المفاهيم المحاسبية الأساسية',
        'concepts': {
            'accounts_receivable': {
                'name': 'الذمم المدينة (AR - Accounts Receivable)',
                'definition': 'المبالغ المستحقة للشركة من العملاء مقابل بضائع أو خدمات تم تقديمها',
                'importance': 'تمثل سيولة مستقبلية للشركة',
                'management': [
                    'متابعة دورية لأعمار الذمم',
                    'تحصيل المستحقات في الوقت المناسب',
                    'وضع حد ائتماني لكل عميل',
                    'إعداد تقرير AR Aging شهرياً'
                ],
                'formula': 'AR = إجمالي الفواتير - المدفوعات المحصلة'
            },
            'accounts_payable': {
                'name': 'الذمم الدائنة (AP - Accounts Payable)',
                'definition': 'المبالغ المستحقة على الشركة للموردين مقابل بضائع أو خدمات تم استلامها',
                'importance': 'التزام مالي يجب إدارته بحكمة',
                'management': [
                    'الدفع في المواعيد المتفق عليها',
                    'الاستفادة من خصومات الدفع المبكر',
                    'تجنب التأخير الذي يضر بالسمعة',
                    'إعداد تقرير AP Aging شهرياً'
                ],
                'formula': 'AP = إجمالي المشتريات - المدفوعات المسددة'
            },
            'cash_flow': {
                'name': 'التدفق النقدي (Cash Flow)',
                'definition': 'حركة الأموال الداخلة والخارجة من الشركة',
                'types': {
                    'operating': 'التشغيلي - من النشاط الرئيسي',
                    'investing': 'الاستثماري - شراء/بيع أصول',
                    'financing': 'التمويلي - قروض ورأس مال'
                },
                'importance': 'السيولة أهم من الربحية قصيرة الأمد',
                'formula': 'Net Cash Flow = التدفقات الداخلة - التدفقات الخارجة'
            },
            'profit_margin': {
                'name': 'هامش الربح (Profit Margin)',
                'definition': 'نسبة الربح من المبيعات',
                'types': {
                    'gross': 'الإجمالي = (الإيرادات - تكلفة البضاعة) / الإيرادات',
                    'operating': 'التشغيلي = (الربح التشغيلي / الإيرادات) × 100',
                    'net': 'الصافي = (صافي الربح / الإيرادات) × 100'
                },
                'benchmarks': {
                    'excellent': 'أكثر من 20%',
                    'good': '15-20%',
                    'average': '10-15%',
                    'poor': 'أقل من 10%'
                }
            },
            'inventory_turnover': {
                'name': 'معدل دوران المخزون',
                'definition': 'عدد المرات التي يتم فيها بيع وتجديد المخزون خلال فترة',
                'formula': 'معدل الدوران = تكلفة البضاعة المباعة / متوسط المخزون',
                'interpretation': {
                    'high': 'دوران سريع - جيد (لكن احذر نفاد المخزون)',
                    'low': 'دوران بطيء - سيء (رأس مال معطل)'
                },
                'ideal_range': '6-12 مرة سنوياً للكراجات'
            }
        }
    },
    
    'financial_reports': {
        'name': 'التقارير المالية',
        'reports': {
            'income_statement': {
                'name': 'قائمة الدخل (P&L)',
                'purpose': 'قياس الأداء المالي خلال فترة',
                'components': [
                    'الإيرادات (المبيعات)',
                    '- تكلفة البضاعة المباعة',
                    '= إجمالي الربح',
                    '- المصروفات التشغيلية',
                    '= الربح التشغيلي',
                    '- الضرائب',
                    '= صافي الربح'
                ],
                'frequency': 'شهرياً على الأقل',
                'importance': 'يوضح هل الشركة رابحة أم خاسرة'
            },
            'balance_sheet': {
                'name': 'الميزانية العمومية',
                'purpose': 'صورة للوضع المالي في لحظة معينة',
                'equation': 'الأصول = الخصوم + حقوق الملكية',
                'components': {
                    'assets': [
                        'أصول متداولة (نقد، مخزون، ذمم مدينة)',
                        'أصول ثابتة (معدات، سيارات، مباني)'
                    ],
                    'liabilities': [
                        'خصوم متداولة (ذمم دائنة، قروض قصيرة)',
                        'خصوم طويلة الأجل (قروض طويلة)'
                    ],
                    'equity': [
                        'رأس المال',
                        'الأرباح المحتجزة'
                    ]
                }
            },
            'cash_flow_statement': {
                'name': 'قائمة التدفقات النقدية',
                'purpose': 'تتبع حركة النقد الفعلية',
                'importance': 'شركة رابحة على الورق قد تفلس بسبب السيولة',
                'sections': [
                    'التدفقات التشغيلية',
                    'التدفقات الاستثمارية',
                    'التدفقات التمويلية'
                ]
            }
        }
    },
    
    'cost_accounting': {
        'name': 'محاسبة التكاليف',
        'concepts': {
            'fixed_costs': {
                'name': 'التكاليف الثابتة',
                'definition': 'تكاليف لا تتغير بتغير حجم النشاط',
                'examples': [
                    'الإيجار',
                    'رواتب الإداريين الثابتة',
                    'التأمين',
                    'الإهلاك'
                ]
            },
            'variable_costs': {
                'name': 'التكاليف المتغيرة',
                'definition': 'تكاليف تتغير مع حجم النشاط',
                'examples': [
                    'تكلفة قطع الغيار المباعة',
                    'عمولات المبيعات',
                    'الكهرباء (جزء منها)',
                    'مواد التعبئة'
                ]
            },
            'break_even': {
                'name': 'نقطة التعادل',
                'definition': 'النقطة التي تتساوى فيها الإيرادات مع التكاليف',
                'formula': 'نقطة التعادل = التكاليف الثابتة / (السعر - التكلفة المتغيرة للوحدة)',
                'importance': 'تحدد الحد الأدنى للمبيعات المطلوبة'
            }
        }
    }
}


# ====================================================================
# إدارة الكراجات - معرفة متخصصة
# ====================================================================

GARAGE_MANAGEMENT_KNOWLEDGE = {
    'operations': {
        'name': 'العمليات اليومية',
        'best_practices': {
            'appointment_scheduling': {
                'name': 'جدولة المواعيد',
                'tips': [
                    'حجز مسبق لتجنب الازدحام',
                    'تخصيص وقت كافٍ لكل نوع صيانة',
                    'buffer time بين المواعيد (15-30 دقيقة)',
                    'تذكير العملاء قبل الموعد (24 ساعة)'
                ],
                'time_allocation': {
                    'oil_change': '30-45 دقيقة',
                    'brake_service': '1-2 ساعة',
                    'major_repair': '4-8 ساعات أو أكثر',
                    'inspection': '1 ساعة'
                }
            },
            'quality_control': {
                'name': 'ضبط الجودة',
                'checklist': [
                    'فحص نهائي بعد كل صيانة',
                    'test drive قبل التسليم',
                    'تصوير قبل/بعد للأعمال الكبيرة',
                    'توثيق جميع الأعمال',
                    'ضمان على القطع والعمالة'
                ]
            },
            'parts_management': {
                'name': 'إدارة قطع الغيار',
                'strategies': [
                    'تخزين القطع الأكثر طلباً (Fast-Moving)',
                    'طلب القطع النادرة عند الحاجة',
                    'علاقات قوية مع موردين متعددين',
                    'نظام FIFO (First In, First Out)',
                    'مراجعة دورية للقطع الراكدة'
                ],
                'categorization': {
                    'A': 'قطع سريعة الحركة (20% من الأصناف، 80% من المبيعات)',
                    'B': 'قطع متوسطة الحركة (30% من الأصناف، 15% من المبيعات)',
                    'C': 'قطع بطيئة الحركة (50% من الأصناف، 5% من المبيعات)'
                }
            }
        }
    },
    
    'pricing_strategy': {
        'name': 'استراتيجية التسعير',
        'methods': {
            'cost_plus': {
                'name': 'التكلفة + هامش الربح',
                'formula': 'سعر البيع = التكلفة × (1 + نسبة الربح)',
                'example': 'قطعة تكلف 100₪ + هامش 40% = 140₪',
                'pros': 'بسيط وسهل',
                'cons': 'لا يراعي السوق'
            },
            'market_based': {
                'name': 'السعر السوقي',
                'method': 'دراسة أسعار المنافسين',
                'strategy': 'تسعير مماثل أو أقل بقليل',
                'differentiation': 'تميز بالجودة أو الخدمة'
            },
            'value_based': {
                'name': 'التسعير حسب القيمة',
                'definition': 'تسعير حسب القيمة المدركة للعميل',
                'example': 'صيانة سيارات فاخرة → أسعار أعلى',
                'advantage': 'أعلى ربحية'
            }
        },
        'labor_rates': {
            'name': 'أسعار العمالة',
            'calculation': 'ساعة عمل = (التكاليف الثابتة + الربح المستهدف) / ساعات العمل السنوية',
            'typical_range': '50-150₪ للساعة حسب التخصص',
            'factors': [
                'خبرة الميكانيكي',
                'نوع السيارة',
                'موقع الكراج',
                'السوق المحلي'
            ]
        }
    },
    
    'customer_retention': {
        'name': 'الاحتفاظ بالعملاء',
        'strategies': [
            'برنامج ولاء (نقاط، خصومات)',
            'تذكير بالصيانة الدورية',
            'خدمة عملاء ممتازة',
            'شفافية في الأسعار',
            'ضمان على الأعمال',
            'متابعة بعد الخدمة'
        ],
        'metrics': {
            'retention_rate': {
                'formula': '((العملاء في نهاية الفترة - عملاء جدد) / عملاء في بداية الفترة) × 100',
                'target': 'أكثر من 80%'
            },
            'customer_lifetime_value': {
                'formula': 'متوسط قيمة المعاملة × عدد المعاملات سنوياً × متوسط سنوات العلاقة',
                'importance': 'يحدد كم تستثمر في اكتساب عميل جديد'
            }
        }
    }
}


# ====================================================================
# خدمة العملاء المتميزة
# ====================================================================

CUSTOMER_SERVICE_KNOWLEDGE = {
    'communication': {
        'name': 'مهارات التواصل',
        'principles': {
            'active_listening': {
                'name': 'الاستماع الفعال',
                'tips': [
                    'دع العميل يكمل حديثه',
                    'لا تقاطع',
                    'اطرح أسئلة توضيحية',
                    'كرر ما فهمته للتأكيد',
                    'لغة جسد إيجابية'
                ]
            },
            'clear_explanation': {
                'name': 'الشرح الواضح',
                'guidelines': [
                    'استخدم لغة بسيطة (ليس كل العملاء ميكانيكيين)',
                    'اشرح المشكلة والحل',
                    'وضح التكلفة والوقت المتوقع',
                    'استخدم صور أو فيديو إن أمكن',
                    'أعط خيارات إذا كان ممكناً'
                ]
            },
            'managing_expectations': {
                'name': 'إدارة التوقعات',
                'rules': [
                    'لا تعد بما لا تستطيع',
                    'أضف buffer في التوقيت (وعد بـ 3 أيام، سلم في يومين)',
                    'إذا تأخرت، أخبر العميل فوراً',
                    'كن صادقاً عن حالة السيارة',
                    'اشرح المخاطر المحتملة'
                ]
            }
        }
    },
    
    'complaint_handling': {
        'name': 'التعامل مع الشكاوى',
        'steps': [
            '1. استمع بهدوء - لا تقاطع',
            '2. اعتذر (حتى لو لم يكن خطأك)',
            '3. تعاطف - "أفهم إحباطك"',
            '4. اسأل أسئلة للفهم الكامل',
            '5. قدم حلاً فورياً إن أمكن',
            '6. متابعة للتأكد من الرضا'
        ],
        'never_do': [
            'لا تتجاهل الشكوى',
            'لا تدافع بعنف',
            'لا تلوم العميل',
            'لا تعد بما لا تستطيع',
            'لا تتأخر في الرد'
        ],
        'recovery_opportunities': 'عميل تم حل مشكلته بشكل ممتاز قد يصبح أكثر ولاءً من عميل لم يواجه مشكلة'
    },
    
    'service_excellence': {
        'name': 'التميز في الخدمة',
        'touchpoints': {
            'first_contact': 'الانطباع الأول (تحية، ابتسامة، اهتمام)',
            'during_service': 'تحديثات منتظمة، شفافية',
            'delivery': 'شرح الأعمال، نصائح صيانة',
            'follow_up': 'اتصال بعد أسبوع للتأكد'
        },
        'extras': [
            'غسيل السيارة مجاناً',
            'قهوة/شاي في منطقة الانتظار',
            'Wi-Fi مجاني',
            'توصيل واستلام من/إلى المنزل',
            'سيارة بديلة للأعمال الكبيرة'
        ]
    }
}


# ====================================================================
# الجمارك والتخليص
# ====================================================================

CUSTOMS_KNOWLEDGE = {
    'basics': {
        'name': 'أساسيات الجمارك',
        'definition': 'الرسوم المفروضة على البضائع المستوردة أو المصدرة',
        'purposes': [
            'حماية الصناعة المحلية',
            'زيادة الإيرادات الحكومية',
            'تنظيم التجارة',
            'الأمن القومي'
        ],
        'entities': {
            'customs_authority': 'سلطة الجمارك - الجهة الحكومية المسؤولة',
            'customs_broker': 'مخلص جمركي - وسيط متخصص',
            'importer': 'المستورد - صاحب البضاعة'
        }
    },
    
    'import_process': {
        'name': 'عملية الاستيراد',
        'steps': [
            '1. التأكد من السلعة المسموح استيرادها',
            '2. الحصول على فاتورة (Invoice) من المورد',
            '3. شحن البضاعة (بحري/جوي/بري)',
            '4. وصول البضاعة للميناء/المعبر',
            '5. تقديم المستندات للجمارك',
            '6. الفحص الجمركي (قد يكون عشوائي)',
            '7. تقييم البضاعة وحساب الرسوم',
            '8. دفع الرسوم',
            '9. الإفراج عن البضاعة',
            '10. النقل للمخزن'
        ],
        'documents_required': [
            'فاتورة تجارية (Commercial Invoice)',
            'بوليصة الشحن (Bill of Lading)',
            'قائمة التعبئة (Packing List)',
            'شهادة المنشأ (Certificate of Origin)',
            'تصريح استيراد (إن لزم)',
            'رخصة الاستيراد'
        ]
    },
    
    'customs_duties': {
        'name': 'الرسوم الجمركية',
        'types': {
            'ad_valorem': {
                'name': 'نسبة من القيمة',
                'calculation': 'نسبة مئوية من قيمة البضاعة',
                'example': 'سيارة قيمتها $20,000 × رسوم 85% = $17,000 رسوم'
            },
            'specific': {
                'name': 'رسم محدد',
                'calculation': 'مبلغ ثابت لكل وحدة',
                'example': '10₪ لكل كيلو'
            },
            'compound': {
                'name': 'مركب',
                'calculation': 'نسبة + مبلغ ثابت'
            }
        },
        'calculation_base': {
            'cif_value': {
                'name': 'قيمة CIF',
                'definition': 'Cost + Insurance + Freight',
                'components': [
                    'تكلفة البضاعة',
                    'تكلفة الشحن',
                    'تكلفة التأمين'
                ],
                'note': 'أساس حساب الرسوم الجمركية'
            }
        }
    },
    
    'hs_codes': {
        'name': 'نظام HS Code',
        'definition': 'نظام منسق لتصنيف السلع (Harmonized System)',
        'structure': '6 أرقام على الأقل (قد يصل لـ 10)',
        'importance': 'يحدد نسبة الرسوم الجمركية',
        'examples': {
            '8708': 'قطع غيار سيارات',
            '8536': 'معدات كهربائية',
            '4011': 'إطارات مطاطية جديدة'
        },
        'how_to_find': [
            'استشر مخلص جمركي',
            'ابحث في جداول الجمارك',
            'اسأل المورد',
            'موقع الجمارك الرسمي'
        ]
    },
    
    'palestine_israel_specifics': {
        'name': 'خصوصيات فلسطين/إسرائيل',
        'note': 'الوضع معقد - استشر مختص دائماً',
        'considerations': [
            'بروتوكول باريس الاقتصادي',
            'الاتحاد الجمركي',
            'التصاريح الإسرائيلية قد تكون مطلوبة',
            'رسوم الشحن والتخزين في الموانئ الإسرائيلية',
            'VAT 16% في فلسطين، 17% في إسرائيل'
        ]
    }
}


# ====================================================================
# الضرائب
# ====================================================================

TAX_KNOWLEDGE = {
    'vat': {
        'name': 'ضريبة القيمة المضافة (VAT)',
        'definition': 'ضريبة على الاستهلاك تفرض في كل مرحلة من مراحل الإنتاج والتوزيع',
        'rates': {
            'palestine': '16%',
            'israel': '17%',
            'jordan': '16%'
        },
        'mechanism': {
            'input_vat': 'ضريبة على المشتريات (قابلة للخصم)',
            'output_vat': 'ضريبة على المبيعات (مستحقة للحكومة)',
            'net_vat': 'ضريبة المبيعات - ضريبة المشتريات = المستحق/المسترد'
        },
        'calculation': {
            'add_vat': 'السعر × (1 + نسبة VAT)',
            'extract_vat': 'السعر الشامل / (1 + نسبة VAT)',
            'vat_amount': 'السعر × نسبة VAT / (1 + نسبة VAT)'
        },
        'exemptions': [
            'السلع الأساسية (خبز، حليب)',
            'الأدوية',
            'الخدمات الصحية',
            'التعليم',
            'قد تختلف حسب الدولة'
        ],
        'filing': {
            'frequency': 'شهرياً أو ربع سنوي',
            'deadline': 'عادة 15 من الشهر التالي',
            'penalties': 'غرامات على التأخير أو عدم الدقة'
        }
    },
    
    'income_tax': {
        'name': 'ضريبة الدخل',
        'palestine': {
            'rates': {
                'individuals': [
                    '0% حتى 75,000₪',
                    '5% من 75,001 - 150,000₪',
                    '10% من 150,001 - 250,000₪',
                    '15% فوق 250,000₪'
                ],
                'companies': '15% على صافي الربح'
            },
            'deductions': [
                'المصاريف التشغيلية',
                'الإهلاك',
                'الفوائد المدفوعة',
                'الرواتب والأجور',
                'التأمينات'
            ]
        },
        'israel': {
            'corporate_rate': '23%',
            'note': 'نظام معقد - استشر محاسب'
        },
        'filing': {
            'annual_return': 'إقرار سنوي',
            'deadline': 'عادة نهاية أبريل للسنة السابقة',
            'advance_payments': 'دفعات مقدمة ربع سنوية'
        }
    },
    
    'withholding_tax': {
        'name': 'ضريبة الاستقطاع',
        'definition': 'خصم ضريبة من المنبع عند الدفع',
        'common_cases': [
            'رواتب الموظفين',
            'أتعاب المهنيين',
            'الإيجارات',
            'أرباح الأسهم'
        ],
        'rates': {
            'salaries': 'حسب الشرائح',
            'professionals': '5-10%',
            'rent': '5%'
        },
        'responsibility': 'الدافع مسؤول عن الخصم والتوريد للحكومة'
    },
    
    'compliance': {
        'name': 'الامتثال الضريبي',
        'requirements': [
            'مسك دفاتر منتظمة',
            'إصدار فواتير رسمية',
            'حفظ المستندات لمدة 7 سنوات',
            'تقديم الإقرارات في المواعيد',
            'دفع المستحقات'
        ],
        'penalties': [
            'غرامات مالية',
            'فوائد تأخير',
            'إغلاق المنشأة في الحالات الخطيرة',
            'عقوبات جنائية في حالات التهرب'
        ],
        'tips': [
            'استعن بمحاسب قانوني مرخص',
            'احتفظ بجميع الإيصالات والفواتير',
            'افصل الحسابات الشخصية عن التجارية',
            'راجع الإقرارات قبل التقديم',
            'تعاون مع مفتش الضرائب إذا زار'
        ]
    }
}


# ====================================================================
# دوال البحث والاستعلام
# ====================================================================

def search_business_knowledge(query: str) -> dict:
    """البحث في المعرفة المتخصصة"""
    query_lower = query.lower()
    results = []
    
    # كلمات مفتاحية للبحث
    accounting_keywords = ['محاسبة', 'ذمم', 'ميزانية', 'قائمة الدخل', 'تدفق نقدي', 'ربح', 'accounting', 'ar', 'ap']
    garage_keywords = ['كراج', 'صيانة', 'قطع غيار', 'عملاء', 'تسعير', 'garage', 'pricing']
    customer_keywords = ['خدمة عملاء', 'شكوى', 'تواصل', 'customer service', 'complaint']
    customs_keywords = ['جمارك', 'استيراد', 'تخليص', 'hs code', 'customs', 'import']
    tax_keywords = ['ضريبة', 'vat', 'ضريبة دخل', 'استقطاع', 'tax', 'income tax']
    
    # البحث في المحاسبة
    if any(kw in query_lower for kw in accounting_keywords):
        for concept_key, concept_data in ACCOUNTING_KNOWLEDGE['general_concepts']['concepts'].items():
            if concept_key in query_lower or any(word in concept_data.get('name', '').lower() for word in query_lower.split()):
                results.append({
                    'type': 'accounting',
                    'topic': concept_data['name'],
                    'data': concept_data,
                    'score': 10
                })
    
    # البحث في إدارة الكراجات
    if any(kw in query_lower for kw in garage_keywords):
        results.append({
            'type': 'garage',
            'topic': 'إدارة الكراجات',
            'data': GARAGE_MANAGEMENT_KNOWLEDGE,
            'score': 9
        })
    
    # البحث في خدمة العملاء
    if any(kw in query_lower for kw in customer_keywords):
        results.append({
            'type': 'customer_service',
            'topic': 'خدمة العملاء',
            'data': CUSTOMER_SERVICE_KNOWLEDGE,
            'score': 9
        })
    
    # البحث في الجمارك
    if any(kw in query_lower for kw in customs_keywords):
        results.append({
            'type': 'customs',
            'topic': 'الجمارك والتخليص',
            'data': CUSTOMS_KNOWLEDGE,
            'score': 10
        })
    
    # البحث في الضرائب
    if any(kw in query_lower for kw in tax_keywords):
        results.append({
            'type': 'tax',
            'topic': 'الضرائب',
            'data': TAX_KNOWLEDGE,
            'score': 10
        })
    
    # ترتيب حسب الصلة
    results.sort(key=lambda x: x.get('score', 0), reverse=True)
    
    return {
        'query': query,
        'results': results[:3],
        'total': len(results)
    }


def get_accounting_concept(concept_name: str) -> dict:
    """الحصول على مفهوم محاسبي محدد"""
    return ACCOUNTING_KNOWLEDGE['general_concepts']['concepts'].get(concept_name)


def get_tax_info(tax_type: str) -> dict:
    """الحصول على معلومات ضريبية"""
    return TAX_KNOWLEDGE.get(tax_type)

