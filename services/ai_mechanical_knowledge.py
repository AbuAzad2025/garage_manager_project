"""
AI Mechanical Knowledge - معرفة ميكانيكية متخصصة
خبرة في السيارات والمعدات الثقيلة - تشخيص وإصلاح
"""

# ====================================================================
# الأعطال الشائعة والحلول
# ====================================================================

COMMON_PROBLEMS = {
    # مشاكل المحرك
    'engine_overheating': {
        'name_ar': 'ارتفاع حرارة المحرك',
        'name_en': 'Engine Overheating',
        'symptoms': [
            'مؤشر الحرارة في المنطقة الحمراء',
            'بخار من غطاء المحرك',
            'رائحة سائل تبريد محترق',
            'ضعف في الأداء'
        ],
        'possible_causes': [
            'نقص سائل التبريد (Coolant)',
            'تلف الثرموستات (Thermostat)',
            'تلف مضخة الماء (Water Pump)',
            'انسداد الراديتر',
            'تلف مروحة التبريد',
            'تلف غطاء الراديتر (Radiator Cap)',
            'تلف جوان الرأس (Head Gasket) - خطير!'
        ],
        'diagnosis_steps': [
            '1. افحص مستوى سائل التبريد (بارد!)',
            '2. افحص وجود تسريبات',
            '3. افحص عمل المروحة',
            '4. افحص ضغط النظام',
            '5. افحص لون الزيت (أبيض = تلف جوان الرأس)',
            '6. فحص الثرموستات (يفتح في 80-90 درجة)'
        ],
        'solutions': [
            'أضف سائل تبريد إذا ناقص',
            'بدل الثرموستات (رخيص - 30-80₪)',
            'بدل مضخة الماء (300-600₪)',
            'نظّف أو بدل الراديتر',
            'صلّح المروحة أو الحساس',
            'بدل غطاء الراديتر (20-50₪)',
            'جوان الرأس: إصلاح مكلف (1,500-3,000₪+)'
        ],
        'emergency': 'أوقف السيارة فوراً! القيادة بحرارة مرتفعة تتلف المحرك كاملاً!',
        'parts_needed': [
            'سائل تبريد',
            'ثرموستات',
            'مضخة ماء (إن لزم)',
            'غطاء راديتر'
        ]
    },
    
    'engine_misfire': {
        'name_ar': 'تقطيع في المحرك',
        'name_en': 'Engine Misfire',
        'symptoms': [
            'اهتزاز غير طبيعي',
            'ضعف في العزم',
            'زيادة استهلاك الوقود',
            'لمبة Check Engine تولع',
            'صوت فرقعة من العادم'
        ],
        'possible_causes': [
            'بواجي تالفة أو قديمة',
            'كويلات الاشتعال (Ignition Coils)',
            'فلتر هواء مسدود',
            'بخاخات وقود متسخة (Injectors)',
            'ضغط منخفض في السلندر (Compression)',
            'سير التوقيت غير مضبوط'
        ],
        'diagnosis_steps': [
            '1. قراءة كود العطل (OBD Scanner)',
            '2. فحص البواجي (لون الطرف، الفجوة)',
            '3. فحص الكويلات (مقاومة، شرارة)',
            '4. فحص ضغط السلندرات (Compression Test)',
            '5. فحص البخاخات (نمط الرش)',
            '6. فحص توقيت الاشتعال (Timing)'
        ],
        'solutions': [
            'بدل البواجي (أرخص حل - 10-40₪ للبوجية)',
            'بدل الكويل التالف (150-400₪)',
            'نظّف البخاخات (100-200₪)',
            'بدل فلتر الهواء (20-60₪)',
            'ضبط التوقيت (50-150₪ عمالة)',
            'إصلاح ضغط منخفض (مكلف - قد يحتاج Overhaul)'
        ],
        'parts_needed': [
            'بواجي (Spark Plugs)',
            'كويلات (Ignition Coils)',
            'فلتر هواء'
        ]
    },
    
    # مشاكل المعدات الثقيلة
    'hydraulic_slow': {
        'name_ar': 'بطء في الأذرع الهيدروليك',
        'name_en': 'Slow Hydraulic Operation',
        'symptoms': [
            'بطء في حركة الذراع',
            'ضعف في رفع الأحمال',
            'صوت غير طبيعي من المضخة',
            'ارتفاع حرارة الزيت'
        ],
        'possible_causes': [
            'نقص زيت هيدروليك',
            'فلتر هيدروليك مسدود',
            'تآكل المضخة الهيدروليكية',
            'تسريب داخلي في السلندرات',
            'صمامات (Valves) متسخة أو تالفة',
            'خراطيم مسدودة أو ضيقة'
        ],
        'diagnosis_steps': [
            '1. فحص مستوى الزيت الهيدروليكي',
            '2. فحص ضغط النظام (Pressure Gauge)',
            '3. فحص الفلتر (مسدود؟)',
            '4. فحص التسريبات الخارجية',
            '5. فحص حرارة الزيت',
            '6. فحص الصمامات'
        ],
        'solutions': [
            'أضف زيت إن ناقص',
            'بدل الفلتر (50-200₪)',
            'نظّف الصمامات',
            'بدل المضخة إن متآكلة (3,000-15,000₪)',
            'صلّح السلندرات (حسب الحجم)',
            'بدل الخراطيم التالفة'
        ],
        'parts_needed': [
            'زيت هيدروليك (حسب النوع)',
            'فلتر هيدروليك',
            'سيلات (Seals)',
            'مضخة (إن لزم)'
        ]
    }
}


# ====================================================================
# أنظمة السيارات - شرح مفصل
# ====================================================================

VEHICLE_SYSTEMS = {
    'fuel_system': {
        'name': 'نظام الوقود',
        'components': [
            'خزان الوقود (Fuel Tank)',
            'مضخة الوقود (Fuel Pump)',
            'فلتر الوقود (Fuel Filter)',
            'بخاخات الوقود (Injectors)',
            'منظم الضغط (Pressure Regulator)',
            'خراطيم الوقود'
        ],
        'how_it_works': """**آلية عمل نظام الوقود:**

1. المضخة تسحب الوقود من الخزان
2. الفلتر ينظف الوقود من الشوائب
3. منظم الضغط يضبط الضغط (2.5-4 bar)
4. البخاخات ترش الوقود في المحرك
5. ECU تتحكم في كمية الرش حسب الحاجة

💡 نظام دقيق جداً - أي خلل يؤثر على الأداء!
""",
        'common_problems': [
            'صعوبة التشغيل → فلتر وقود أو مضخة',
            'تقطيع → بخاخات متسخة',
            'استهلاك عالي → بخاخات تسرب أو حساس أكسجين'
        ]
    },
    
    'cooling_system': {
        'name': 'نظام التبريد',
        'components': [
            'راديتر (Radiator)',
            'مضخة الماء (Water Pump)',
            'ثرموستات (Thermostat)',
            'مروحة التبريد (Cooling Fan)',
            'خراطيم (Hoses)',
            'غطاء الراديتر (Radiator Cap)',
            'سائل التبريد (Coolant)'
        ],
        'how_it_works': """**آلية عمل نظام التبريد:**

1. المحرك يسخن أثناء العمل
2. الماء يدور حول السلندرات لامتصاص الحرارة
3. المضخة تدفع الماء للراديتر
4. الثرموستات يفتح عند 80-90 درجة
5. الراديتر يبرد الماء (الهواء + المروحة)
6. الماء البارد يعود للمحرك

⚠️ الحرارة المثالية: 85-95 درجة مئوية
""",
        'maintenance': [
            'فحص مستوى السائل أسبوعياً',
            'بدل السائل كل سنتين',
            'بدل الثرموستات كل 80,000 كم',
            'افحص الخراطيم (شقوق، تصلّب)'
        ]
    },
    
    'electrical_system': {
        'name': 'النظام الكهربائي',
        'components': [
            'بطارية (Battery) - 12V',
            'دينمو/مولد (Alternator)',
            'سلف/مارش (Starter Motor)',
            'كويلات الاشتعال (Ignition Coils)',
            'حساسات (Sensors)',
            'ECU - كمبيوتر السيارة',
            'أسلاك وفيوزات'
        ],
        'voltage_checks': {
            'battery_rest': '12.6V (مشحونة)',
            'battery_cranking': '9.5V+ (جيد)',
            'alternator_running': '13.8-14.4V (يشحن)',
        },
        'common_problems': [
            'السيارة لا تدور → بطارية فارغة أو سلف تالف',
            'لمبات خافتة → دينمو ضعيف',
            'تفريغ سريع للبطارية → استهلاك خفي أو دينمو لا يشحن'
        ]
    }
}


# ====================================================================
# المعدات الثقيلة - معرفة متخصصة
# ====================================================================

HEAVY_EQUIPMENT_KNOWLEDGE = {
    'excavator': {
        'name_ar': 'حفارة',
        'name_en': 'Excavator',
        'types': [
            'Mini (1-6 طن)',
            'Midi (6-10 طن)',
            'Standard (10-45 طن)',
            'Large (45+ طن)'
        ],
        'main_systems': {
            'hydraulic': {
                'name': 'النظام الهيدروليكي',
                'components': [
                    'مضخة رئيسية (Main Pump)',
                    'صمامات تحكم (Control Valves)',
                    'سلندرات (Cylinders)',
                    'خزان زيت',
                    'فلاتر',
                    'خراطيم عالية الضغط'
                ],
                'pressure_range': '250-350 bar',
                'oil_capacity': '100-500 لتر حسب الحجم',
                'maintenance': [
                    'فحص مستوى الزيت يومياً',
                    'بدل الفلتر كل 250 ساعة',
                    'بدل الزيت كل 1,000-2,000 ساعة',
                    'افحص التسريبات'
                ]
            },
            'undercarriage': {
                'name': 'الجنزير (Undercarriage)',
                'components': [
                    'جنزير (Tracks)',
                    'رولات علوية (Top Rollers)',
                    'رولات سفلية (Bottom Rollers)',
                    'عجلة قيادة (Sprocket)',
                    'عجلة توجيه (Idler)',
                    'محرك دوران (Travel Motor)'
                ],
                'wear_points': [
                    'أسنان الجنزير',
                    'رولمانات الرولات',
                    'سيلات محرك الدوران'
                ],
                'maintenance': 'فحص التوتر (Tension) والتآكل كل 100 ساعة'
            }
        },
        'common_problems': {
            'slow_movement': 'بطء حركة → فحص الهيدروليك والفلاتر',
            'weak_digging': 'ضعف حفر → ضغط منخفض أو مضخة ضعيفة',
            'deviation': 'انحراف أثناء السير → جنزير مرتخي أو محرك دوران'
        }
    },
    
    'loader': {
        'name_ar': 'لودر / محمّلة',
        'name_en': 'Wheel Loader',
        'types': ['صغير (1-3 ياردة³)', 'متوسط (3-5 ياردة³)', 'كبير (5+ ياردة³)'],
        'main_systems': {
            'transmission': {
                'name': 'ناقل الحركة',
                'types': [
                    'Powershift - تلقائي هيدروليكي',
                    'Torque Converter - محول عزم'
                ],
                'maintenance': [
                    'فحص مستوى الزيت أسبوعياً',
                    'بدل الزيت كل 1,000 ساعة',
                    'بدل الفلتر مع الزيت'
                ],
                'problems': [
                    'تأخر في التعشيق → زيت قديم أو قابض تالف',
                    'انزلاق → قابض بحاجة لتعديل أو تبديل'
                ]
            }
        }
    }
}


# ====================================================================
# التشخيص - خبرة الميكانيكي
# ====================================================================

DIAGNOSTIC_EXPERTISE = {
    'listening_to_sounds': {
        'name': 'التشخيص بالصوت - خبرة الميكانيكي',
        'sounds': {
            'squealing': {
                'sound': 'صوت صرير / صفير',
                'possible_causes': [
                    'سير المكيف أو الدينمو مرتخي',
                    'فرامل تحتاج تبديل',
                    'رولمان بلي تالف'
                ]
            },
            'knocking': {
                'sound': 'صوت طقطقة / طرق',
                'possible_causes': [
                    'نقص زيت المحرك',
                    'رولمانات المحرك تالفة',
                    'وقود منخفض الأوكتان (Detonation)',
                    'صمامات غير مضبوطة (Valve Clearance)'
                ]
            },
            'grinding': {
                'sound': 'صوت احتكاك معدني',
                'possible_causes': [
                    'فرامل تآكلت تماماً (معدن على معدن)',
                    'قير يحتاج زيت أو تالف',
                    'رولمان عجلة تالف'
                ]
            },
            'hissing': {
                'sound': 'صوت فحيح / سَس',
                'possible_causes': [
                    'تسرب في نظام التبريد',
                    'تسرب في العادم',
                    'تسرب فاكوم'
                ]
            }
        }
    },
    
    'visual_inspection': {
        'name': 'التشخيص البصري',
        'checks': {
            'fluid_colors': {
                'engine_oil': {
                    'normal': 'ذهبي أو بني فاتح',
                    'bad': 'أسود جداً → بحاجة تبديل',
                    'critical': 'أبيض حليبي → تسرب ماء (جوان رأس)'
                },
                'coolant': {
                    'normal': 'أخضر أو أحمر أو برتقالي (حسب النوع)',
                    'bad': 'بني غامق → صدأ في النظام',
                    'critical': 'زيتي → تسرب زيت للتبريد'
                },
                'brake_fluid': {
                    'normal': 'شفاف أو أصفر فاتح',
                    'bad': 'بني غامق → بحاجة تبديل',
                    'note': 'يمتص الرطوبة - بدله كل سنتين'
                }
            },
            'smoke_colors': {
                'white': 'أبيض كثيف → احتراق سائل تبريد (جوان رأس)',
                'blue': 'أزرق → احتراق زيت (حلقات مكابس أو صمامات)',
                'black': 'أسود → خليط غني (بخاخات أو حساس أكسجين)'
            }
        }
    }
}


# ====================================================================
# دوال التشخيص الذكي
# ====================================================================

def diagnose_problem(symptoms_list: list) -> dict:
    """تشخيص ذكي بناءً على الأعراض"""
    possible_problems = []
    
    symptoms_lower = [s.lower() for s in symptoms_list]
    
    for problem_key, problem_data in COMMON_PROBLEMS.items():
        score = 0
        problem_symptoms = [s.lower() for s in problem_data.get('symptoms', [])]
        
        for symptom in symptoms_lower:
            for prob_symptom in problem_symptoms:
                if symptom in prob_symptom or prob_symptom in symptom:
                    score += 1
        
        if score > 0:
            possible_problems.append({
                'problem': problem_data['name_ar'],
                'score': score,
                'data': problem_data
            })
    
    possible_problems.sort(key=lambda x: x['score'], reverse=True)
    
    return {
        'diagnosis': possible_problems[:3] if possible_problems else [],
        'confidence': 'عالية' if possible_problems and possible_problems[0]['score'] >= 2 else 'متوسطة'
    }


def get_repair_guide(problem_name: str) -> str:
    """دليل إصلاح مفصل"""
    for problem_key, problem_data in COMMON_PROBLEMS.items():
        if problem_name.lower() in problem_data.get('name_ar', '').lower():
            guide = f"""🔧 **دليل إصلاح: {problem_data['name_ar']}**

⚠️ **الأعراض:**
"""
            for symptom in problem_data.get('symptoms', []):
                guide += f"  • {symptom}\n"
            
            guide += "\n🔍 **خطوات التشخيص:**\n"
            for step in problem_data.get('diagnosis_steps', []):
                guide += f"  {step}\n"
            
            guide += "\n✅ **الحلول الممكنة:**\n"
            for solution in problem_data.get('solutions', []):
                guide += f"  • {solution}\n"
            
            if problem_data.get('parts_needed'):
                guide += "\n📦 **القطع المطلوبة:**\n"
                for part in problem_data['parts_needed']:
                    guide += f"  • {part}\n"
            
            if problem_data.get('emergency'):
                guide += f"\n🚨 **تحذير:** {problem_data['emergency']}\n"
            
            return guide
    
    return f"❌ لم أجد دليل إصلاح لـ \"{problem_name}\""

